# 开播新报表实施方案

## 目标概述
- 在不影响现有「开播日报/周报/月报」的前提下，新增一套「开播新日报/新周报/新月报」。
- 新旧报表完全隔离：独立蓝图、模板、序列化与计算逻辑，不对旧报表文件进行修改。
- 底薪相关统计全部切换为「结算管理」模块中已确认发放的底薪申请金额，忽略开播记录自身的 `base_salary` 字段。

## 范围与约束
- 仅复制并调整开播报表相关代码；其他功能模块不改动。
- 不共用旧报表私有函数，但允许复用公共工具（时间转换、缓存装饰器、JWT 装饰器等）。
- 输出结构与旧报表保持一致，以便前端复用现有渲染逻辑，数据字段命名不做无谓调整。
- 新报表仍需提供传统视图页面与 REST API，页面 JavaScript 调用新的接口路径。

## 技术方案
### 后端结构
1. **新增蓝图**
   - `routes/new_report.py`：提供 `/new-reports/daily|weekly|monthly` 页面。
   - `routes/new_reports_api.py`：提供 `/new-reports/api/...` REST 接口。
2. **公共计算模块**
   - `services/new_report/calculations.py`（新建目录）：封装日报/周报/月报共通逻辑，避免三份复制。
   - 内部步骤：
     - 统一的开播记录查询包装（沿用旧规则：按主播最后一条记录筛选运营/开播方式）。
     - 底薪聚合改为：按 `battle_record_id` 查询 `BaseSalaryApplication`，只累计 `status=APPROVED` 的 `base_salary_amount`。
     - 其他维度（分成、返点、播时、流水）沿用旧计算方式。
3. **序列化工具**
   - `utils/new_report_serializers.py`：复制旧序列化结构，绑定到新 API。
4. **日志**
   - 为新蓝图分别创建 `new_reports`、`new_reports_api` 日志记录器，遵守模块化日志约定。

### 前端结构
- 在 `templates/new_reports/` 下复制旧模板，并替换：
  - API 访问路径。
  - 页面标题与文案（新增「新」字样以示区分）。
- 页面入口路由：`/new-reports/daily` 等。

### 注册与路由
- 在 `app.py` 中注册新蓝图，URL 前缀分别为 `/new-reports` 与 `/new-reports/api`。
- 不改动旧 `reports` 注册顺序，避免影响现有使用者。

## 研发步骤
1. **实现底薪计算辅助函数**
   - 提供按 BattleRecord 批量获取已确认底薪的工具函数，支持日报/周报/月报调用。
2. **完成服务层计算逻辑**
   - 日报：统计当日记录、明细与汇总。
   - 周报：按周二至次周一汇总。
   - 月报：按自然月汇总（含返点逻辑）。
3. **编写蓝图与序列化**
   - API 返回统一响应格式。
   - 记录必要的 INFO / DEBUG 日志。
4. **复制前端模板并调整指向**
5. **自测与格式化**
   - 对新增 Python 文件执行 `yapf` 与必要的 `pylint` 片段检查。
6. **更新文档**
   - `docs/CHANGELOG.md` 记录变更。

## 风险与应对
- **底薪聚合性能**：大量申请时可能触发 N+1 查询。计划通过一次性批量查询 `BaseSalaryApplication` 并构建字典映射降低压力。
- **逻辑偏差**：新旧报表在分成、返点等逻辑应保持一致。将在实现中用单元方法抽取公共计算，减少差异点。
- **模板资源引用**：确保新模板引用的静态资源路径依旧有效；如需额外资源，将复用现有文件，避免重复拷贝。

## 验收要点
- 新增路由 `/new-reports/*` 与 `/new-reports/api/*` 可独立访问，旧报表不受影响。
- 新报表展示的底薪金额与确认发放申请一致，即便 BattleRecord `base_salary` 不同。
- 日报/周报/月报数据结构与旧接口兼容，可直接通过浏览器或 API 客户端验证。
