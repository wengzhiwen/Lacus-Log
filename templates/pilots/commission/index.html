{% extends "base.html" %}

{% block title %}ä¸»æ’­åˆ†æˆç®¡ç† - {{ pilot.nickname }}{% endblock %}

{% block content %}
<section class="commission-management">
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">ä¸»æ’­åˆ†æˆç®¡ç† - {{ pilot.nickname }}</h1>
      <a href="{{ url_for('pilot.pilot_detail', pilot_id=pilot.id) }}" class="btn btn-secondary">
        <span class="btn-icon">â†</span>
        è¿”å›ä¸»æ’­è¯¦æƒ…
      </a>
    </div>
  </div>

  <div class="commission-info-card">
    <div class="card-header">
      <h3 class="card-title">å½“å‰åˆ†æˆä¿¡æ¯</h3>
    </div>
    <div class="commission-summary">
      <div class="summary-item">
        <div id="current-rate-value" class="summary-value">--</div>
        <div class="summary-label">å½“å‰åˆ†æˆæ¯”ä¾‹</div>
      </div>
      <div class="summary-item">
        <div id="pilot-income-value" class="summary-value pilot-income">--</div>
        <div class="summary-label">ä¸»æ’­æ”¶å…¥</div>
      </div>
      <div class="summary-item">
        <div id="company-income-value" class="summary-value company-income">--</div>
        <div class="summary-label">å…¬å¸æ”¶å…¥</div>
      </div>
    </div>
    <div class="commission-details">
      <div class="detail-item">
        <span class="detail-label">è®¡ç®—å…¬å¼ï¼š</span>
        <span id="calculation-formula-value" class="detail-value">åŠ è½½ä¸­...</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">ç”Ÿæ•ˆæ—¶é—´ï¼š</span>
        <span id="effective-date-value" class="detail-value">--</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">å¤‡æ³¨ï¼š</span>
        <span id="remark-value" class="detail-value">--</span>
      </div>
    </div>
  </div>

  <div class="action-section">
    <div class="action-header">
      <h3 class="section-title">åˆ†æˆè°ƒæ•´è®°å½•</h3>
      <a href="{{ url_for('pilot.pilot_commission_new', pilot_id=pilot.id) }}" id="createRecordBtn" class="btn btn-primary">
        <span class="btn-icon">+</span>
        æ–°å¢è°ƒæ•´è®°å½•
      </a>
    </div>
  </div>

  <div class="records-section">
    <div id="records-list" class="records-list"></div>
    <div id="records-empty" class="empty-state" style="display:none;">
      <div class="empty-icon">ğŸ’°</div>
      <div class="empty-title">æš‚æ— åˆ†æˆè°ƒæ•´è®°å½•</div>
      <div class="empty-description">ç‚¹å‡»ä¸Šæ–¹"æ–°å¢è°ƒæ•´è®°å½•"æŒ‰é’®åˆ›å»ºç¬¬ä¸€æ¡è®°å½•</div>
    </div>
  </div>
</section>

<div id="changesModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å˜æ›´è®°å½•</h3>
      <button class="modal-close" onclick="hideChangesModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="changesContent">
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="hideChangesModal()">å…³é—­</button>
    </div>
  </div>
</div>

<style>

.commission-management {
  max-width: 800px;
  margin: 0 auto;
}

.page-header {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid #A9A9A9;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.page-title {
  font-size: 24px;
  font-weight: 700;
  margin: 0;
  color: #111111;
}

.commission-info-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid #A9A9A9;
}

.card-header {
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #A9A9A9;
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
  color: #8B0000;
}

.commission-summary {
  display: flex;
  justify-content: space-around;
  margin-bottom: 16px;
  padding: 16px 0;
  background: #F2F2F2;
  border-radius: 6px;
}

.summary-item {
  text-align: center;
}

.summary-value {
  display: block;
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 4px;
  color: #8B0000;
}

.summary-value.pilot-income {
  color: #00B37A;
}

.summary-value.company-income {
  color: #3A5F3D;
}

.summary-label {
  font-size: 12px;
  color: #666666;
}

.commission-details {
  border-top: 1px solid #A9A9A9;
  padding-top: 12px;
}

.detail-item {
  margin-bottom: 6px;
  font-size: 14px;
}

.detail-label {
  color: #666666;
  font-weight: 500;
}

.detail-value {
  color: #111111;
  font-family: monospace;
}

.action-section {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid #A9A9A9;
}

.action-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
  color: #8B0000;
}

.records-section {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid #A9A9A9;
}

.records-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.record-card {
  background: #fff;
  border-radius: 6px;
  padding: 16px;
  border: 1px solid #A9A9A9;
  transition: all 0.2s ease;
}

.record-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  border-color: #8B0000;
}

.record-card.inactive {
  background: #F2F2F2;
  opacity: 0.7;
}

.record-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.record-date {
  font-size: 16px;
  font-weight: 600;
  color: #111111;
}

.record-rate {
  font-size: 18px;
  font-weight: 700;
  color: #8B0000;
}

.status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}

.status-badge.active {
  background: #00B37A;
  color: #fff;
}

.status-badge.inactive {
  background: #A9A9A9;
  color: #fff;
}

.record-content {
  margin-bottom: 12px;
}

.record-remark {
  font-size: 14px;
  color: #666666;
  margin-bottom: 6px;
}

.record-meta {
  font-size: 12px;
  color: #666666;
}

.meta-item {
  margin-right: 16px;
}

.record-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-title {
  font-size: 18px;
  font-weight: 600;
  color: #666666;
  margin-bottom: 8px;
}

.empty-description {
  font-size: 14px;
  color: #666666;
}


.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: #fff;
  border-radius: 8px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid #A9A9A9;
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666666;
}

.modal-close:hover {
  color: #111111;
}

.modal-body {
  padding: 20px;
  max-height: 60vh;
  overflow-y: auto;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 16px 20px;
  border-top: 1px solid #A9A9A9;
}

.loading {
  text-align: center;
  color: #666666;
  padding: 20px;
}


@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
  }
  
  .commission-summary {
    flex-direction: column;
    gap: 12px;
  }
  
  .action-header {
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
  }
  
  .record-header {
    flex-direction: column;
    gap: 8px;
    align-items: flex-start;
  }
  
  .record-actions {
    justify-content: flex-start;
  }
  
  .modal-content {
    width: 95%;
    margin: 0 10px;
  }
}
</style>

<script>
function getPilotIdFromUrl() {
  const match = window.location.pathname.match(/\/pilots\/(.+?)\/commission\//);
  return match ? match[1] : '{{ pilot.id }}';
}

function getCommissionEditUrl(commissionId) {
  const pilotId = getPilotIdFromUrl();
  return `/pilots/${pilotId}/commission/${commissionId}/edit`;
}

async function loadCurrentCommission() {
  const pilotId = getPilotIdFromUrl();
  try {
    const resp = await fetch(`/api/pilots/${pilotId}/commission/current`);
    const result = await resp.json();
    if (result && result.success) {
      const data = result.data || {};
      document.getElementById('current-rate-value').textContent = (data.current_rate ?? '--') + '%';
      const calc = data.calculation_info || {};
      document.getElementById('pilot-income-value').textContent = (calc.pilot_income ?? '--') + '%';
      document.getElementById('company-income-value').textContent = (calc.company_income ?? '--') + '%';
      document.getElementById('calculation-formula-value').textContent = calc.calculation_formula || '--';
      document.getElementById('effective-date-value').textContent = data.effective_date ? data.effective_date.slice(0, 10) : 'é»˜è®¤åˆ†æˆæ¯”ä¾‹';
      document.getElementById('remark-value').textContent = data.remark || '--';
    }
  } catch (e) {
    // é™é»˜å¤±è´¥ï¼Œä¿ç•™å ä½
  }
}

function renderRecordItem(item) {
  const inactiveClass = item.is_active ? '' : 'inactive';
  const statusBadge = item.is_active ? '<span class="status-badge active">æœ‰æ•ˆ</span>' : '<span class="status-badge inactive">æ— æ•ˆ</span>';
  const remarkHtml = item.remark ? `<div class="record-remark">${item.remark}</div>` : '';
  const createdAt = item.created_at ? item.created_at.replace('T', ' ').slice(0, 16) : '';
  return `
    <div class="record-card ${inactiveClass}">
      <div class="record-header">
        <div class="record-date">${(item.adjustment_date || '').slice(0,10)}</div>
        <div class="record-rate">${item.commission_rate}%</div>
        <div class="record-status">${statusBadge}</div>
      </div>
      <div class="record-content">
        ${remarkHtml}
        <div class="record-meta">
          <span class="meta-item">åˆ›å»ºï¼š${createdAt}</span>
        </div>
      </div>
      <div class="record-actions">
        <a href="${getCommissionEditUrl(item.id)}" class="btn btn-sm btn-secondary" title="ç¼–è¾‘">
          <span class="btn-icon">âœï¸</span>
        </a>
        ${item.is_active 
          ? `<button type="button" class="btn btn-sm btn-secondary" onclick="deactivateRecord('${item.id}')" title="åœç”¨">åœç”¨</button>` 
          : `<button type="button" class="btn btn-sm btn-primary" onclick="activateRecord('${item.id}')" title="æ¢å¤">æ¢å¤</button>`}
        <button type="button" class="btn btn-sm btn-secondary" onclick="showChanges('${item.id}')" title="å˜æ›´è®°å½•">
          <span class="btn-icon">ğŸ“œ</span>
        </button>
      </div>
    </div>
  `;
}

async function loadCommissionRecords() {
  const pilotId = getPilotIdFromUrl();
  try {
    const resp = await fetch(`/api/pilots/${pilotId}/commission/records?page=1&page_size=50`);
    const result = await resp.json();
    const listEl = document.getElementById('records-list');
    const emptyEl = document.getElementById('records-empty');
    if (result && result.success) {
      const items = (result.data && result.data.items) || [];
      if (items.length === 0) {
        listEl.innerHTML = '';
        emptyEl.style.display = '';
      } else {
        emptyEl.style.display = 'none';
        listEl.innerHTML = items.map(renderRecordItem).join('');
      }
    } else {
      listEl.innerHTML = '';
      emptyEl.style.display = '';
    }
  } catch (e) {
    const listEl = document.getElementById('records-list');
    const emptyEl = document.getElementById('records-empty');
    listEl.innerHTML = '';
    emptyEl.style.display = '';
  }
}

document.addEventListener('DOMContentLoaded', function() {
  loadCurrentCommission();
  loadCommissionRecords();
});
function showChanges(commissionId) {
  document.getElementById('changesModal').style.display = 'flex';
  
  fetch(`/api/pilots/${getPilotIdFromUrl()}/commission/records/${commissionId}/changes`)
    .then(response => response.json())
    .then(data => {
      const content = document.getElementById('changesContent');
      if (data && data.success) {
        const items = (data.data && data.data.items) || [];
        if (items.length > 0) {
          let html = '<div class="changes-list">';
          items.forEach(change => {
            html += `<div class="change-item">
              <div class="change-header">
                <span class="change-field">${change.field_name}</span>
                <span class="change-time">${change.change_time}</span>
              </div>
              <div class="change-content">
                <span class="old-value">${change.old_value || 'ç©º'}</span>
                â†’
                <span class="new-value">${change.new_value || 'ç©º'}</span>
              </div>
              <div class="change-meta">
                <span>æ“ä½œè€…ï¼š${(change.user && (change.user.nickname || change.user.username)) || ''}</span>
                <span>IPï¼š${change.ip_address}</span>
              </div>
            </div>`;
          });
          html += '</div>';
          content.innerHTML = html;
        } else {
          content.innerHTML = '<div class="empty-state"><div class="empty-title">æš‚æ— å˜æ›´è®°å½•</div></div>';
        }
      } else {
        content.innerHTML = '<div class="text-center text-danger">åŠ è½½å¤±è´¥ï¼š' + data.error + '</div>';
      }
    })
    .catch(error => {
      document.getElementById('changesContent').innerHTML = '<div class="text-center text-danger">åŠ è½½å¤±è´¥</div>';
    });
}

function hideChangesModal() {
  document.getElementById('changesModal').style.display = 'none';
}

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.style.display = 'none';
  }
});
</script>

<script>
function getCSRFToken() {
  return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

function promptDate(defaultValue) {
  const v = prompt('è°ƒæ•´æ—¥æœŸ (YYYY-MM-DD):', defaultValue || '');
  if (v === null) return null;
  if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) {
    alert('è¯·è¾“å…¥YYYY-MM-DDæ ¼å¼');
    return null;
  }
  return v;
}

function promptRate(defaultValue) {
  const v = prompt('åˆ†æˆæ¯”ä¾‹ (0-50):', defaultValue != null ? String(defaultValue) : '');
  if (v === null) return null;
  const num = parseFloat(v);
  if (Number.isNaN(num) || num < 0 || num > 50) {
    alert('åˆ†æˆæ¯”ä¾‹å¿…é¡»åœ¨0-50ä¹‹é—´');
    return null;
  }
  return num;
}

async function createRecordPrompt() {
  const pilotId = getPilotIdFromUrl();
  const dateStr = promptDate('');
  if (dateStr === null) return;
  const rate = promptRate('');
  if (rate === null) return;
  const remark = prompt('å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:', '') || '';
  
  try {
    const resp = await fetch(`/api/pilots/${pilotId}/commission/records`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json', 
        'X-CSRFToken': getCSRFToken() 
      },
      body: JSON.stringify({ 
        adjustment_date: dateStr, 
        commission_rate: rate, 
        remark: remark 
      })
    });
    const result = await resp.json();
    if (!result.success) {
      showMessage(result.error?.message || 'åˆ›å»ºå¤±è´¥', 'error');
      return;
    }
    showMessage('åˆ›å»ºæˆåŠŸ', 'success');
    loadCurrentCommission();
    loadCommissionRecords();
  } catch (e) {
    showMessage('åˆ›å»ºå¤±è´¥', 'error');
  }
}


async function deactivateRecord(recordId) {
  if (!confirm('ç¡®å®šåœç”¨è¯¥è®°å½•å—ï¼Ÿ')) return;
  const pilotId = getPilotIdFromUrl();
  
  try {
    const resp = await fetch(`/api/pilots/${pilotId}/commission/records/${recordId}/deactivate`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    const result = await resp.json();
    if (!result.success) {
      showMessage(result.error?.message || 'åœç”¨å¤±è´¥', 'error');
      return;
    }
    showMessage('å·²åœç”¨', 'success');
    loadCurrentCommission();
    loadCommissionRecords();
  } catch (e) {
    showMessage('åœç”¨å¤±è´¥', 'error');
  }
}

async function activateRecord(recordId) {
  const pilotId = getPilotIdFromUrl();
  
  try {
    const resp = await fetch(`/api/pilots/${pilotId}/commission/records/${recordId}/activate`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() }
    });
    const result = await resp.json();
    if (!result.success) {
      showMessage(result.error?.message || 'æ¢å¤å¤±è´¥', 'error');
      return;
    }
    showMessage('å·²æ¢å¤', 'success');
    loadCurrentCommission();
    loadCommissionRecords();
  } catch (e) {
    showMessage('æ¢å¤å¤±è´¥', 'error');
  }
}
</script>
{% endblock %}
