# 底薪月报功能设计文档

## 功能概述

底薪月报功能用于按月统计和导出当月所有开播记录及其关联的底薪申请情况，支持多维度筛选和排序，便于财务部门统一处理月结底薪。

## 功能需求

### 1. 核心功能
- 按月显示当月所有开播记录（以开始时间为准）
- 关联显示对应的底薪申请记录
- 支持CSV导出功能
- 支持前端排序和筛选

### 2. 数据字段

#### 开播记录信息
- **主播昵称**: 主播的昵称
- **真实姓名**: 主播的真实姓名
- **开播时间**: 开播记录的开始时间（GMT+8）
- **时长**: 开播时长（小时）
- **流水**: 开播流水金额
- **开播方式**: 线上/线下

#### 底薪申请信息
- **申请时间**: 底薪申请的提交时间（GMT+8）
- **申请金额**: 底薪申请金额
- **结算方式**: 月结底薪/日结底薪/无底薪
- **状态**: 未处理/已发放/拒绝发放

### 3. 特殊处理规则

#### 关联关系处理
1. **无申请记录**: 开播记录没有关联的底薪申请，仍保留显示，底薪申请字段为空
2. **多个申请记录**: 一个开播记录对应多个底薪申请，显示多行，申请时间字段用红色标注
3. **时间基准**: 所有统计以开播记录的开始时间为准

### 4. 筛选条件

#### 开播方式筛选
- **线下**: 默认选项，只显示线下开播记录
- **线上**: 只显示线上开播记录
- **全部**: 显示所有开播记录

#### 结算方式筛选
- **月结底薪**: 默认选项，只显示月结底薪的申请记录
- **日结底薪**: 只显示日结底薪的申请记录
- **无底薪**: 只显示无底薪的开播记录
- **全部**: 显示所有结算方式

### 5. 排序功能

#### 默认排序顺序
1. **结算方式顺序**: 月结底薪 → 日结底薪 → 无底薪
2. **主播昵称顺序**: 按昵称拼音排序
3. **开始时间顺序**: 按开播时间升序

#### 前端排序支持
- 支持所有字段的升序/降序排序
- 排序在客户端完成，提升响应速度

## 技术设计

### 1. 数据模型关系

```python
# 开播记录模型
BattleRecord {
    - pilot: ReferenceField(Pilot)           # 主播
    - start_time: DateTimeField             # 开播时间（UTC）
    - end_time: DateTimeField               # 结束时间（UTC）
    - revenue_amount: DecimalField          # 流水金额
    - work_mode: EnumField(WorkMode)        # 开播方式（online/offline）
    - owner_snapshot: ReferenceField(User)  # 直属运营快照
}

# 底薪申请模型
BaseSalaryApplication {
    - battle_record_id: ReferenceField(BattleRecord)  # 关联开播记录
    - pilot_id: ReferenceField(Pilot)                # 主播
    - settlement_type: StringField                    # 结算方式快照
    - base_salary_amount: DecimalField               # 申请金额
    - status: EnumField(BaseSalaryApplicationStatus) # 申请状态
    - created_at: DateTimeField                      # 申请时间（UTC）
}
```

### 2. 核心查询逻辑

#### 数据获取流程
1. 根据年月参数查询当月开播记录
2. 预取关联的主播、用户信息
3. 左连接查询底薪申请记录
4. 应用筛选条件
5. 在内存中进行数据组装和排序

#### 时区处理
- 数据库存储：UTC时间
- 界面显示：GMT+8时间
- 查询范围：按GMT+8月份计算

### 3. API设计

#### REST API接口

**获取底薪月报数据**
```
GET /api/base-salary-monthly
Query Parameters:
- month: YYYY-MM (必需，月份)
- mode: online|offline|all (可选，开播方式，默认offline)
- settlement: daily_base|monthly_base|none|all (可选，结算方式，默认monthly_base)
- page: 页码 (可选，默认1)
- per_page: 每页数量 (可选，默认20)
```

**导出CSV**
```
GET /api/base-salary-monthly/export.csv
Query Parameters: 同上
```

#### 响应格式

```json
{
  "success": true,
  "data": {
    "month": "2024-01",
    "summary": {
      "total_records": 100,
      "total_revenue": 50000.00,
      "total_base_salary": 15000.00,
      "application_count": 80,
      "approved_amount": 12000.00
    },
    "details": [
      {
        "record_id": "xxx",
        "pilot_nickname": "主播昵称",
        "pilot_real_name": "真实姓名",
        "start_time": "2024-01-15 14:00:00",
        "duration_hours": 2.5,
        "revenue_amount": 1000.00,
        "work_mode": "offline",
        "applications": [
          {
            "application_id": "yyy",
            "application_time": "2024-01-15 16:30:00",
            "amount": 150.00,
            "settlement_type": "monthly_base",
            "status": "approved",
            "is_duplicate": false
          }
        ]
      }
    ],
    "pagination": {
      "page": 1,
      "per_page": 20,
      "total": 100,
      "pages": 5
    }
  },
  "error": null,
  "meta": {
    "filters": {
      "mode": "offline",
      "settlement": "monthly_base"
    }
  }
}
```

### 4. 文件结构

```
routes/
├── base_salary_monthly.py              # 传统页面路由
└── base_salary_monthly_api.py          # REST API路由

utils/
├── base_salary_monthly_calculations.py # 数据计算逻辑
└── base_salary_monthly_serializers.py  # 数据序列化工具

templates/
└── base_salary_monthly/
    └── monthly.html                     # 前端页面模板

tests/integration/
└── test_suite_s4_pilot_broadcast_salary.py # 集成测试
```

### 5. 前端设计

#### 页面布局
1. **页面标题**: 底薪月报
2. **日期导航**: 上个月/下个月切换
3. **筛选控件**: 开播方式、结算方式选择
4. **汇总卡片**: 显示当月统计数据
5. **数据表格**: 显示明细数据
6. **导出按钮**: CSV导出功能

#### 交互特性
- 响应式设计，适配移动端
- 实时筛选，无需刷新页面
- 前端排序，提升用户体验
- 加载状态指示器

### 6. 性能优化

#### 数据查询优化
1. **索引设计**: 在相关字段建立复合索引
2. **预取关联**: 避免N+1查询问题
3. **分页加载**: 支持大数据量处理
4. **缓存机制**: 缓存常用查询结果

#### 前端优化
1. **虚拟滚动**: 处理大量数据展示
2. **延迟加载**: 按需加载数据
3. **缓存机制**: 减少重复请求

## 开发计划

### Phase 1: 后端开发
1. 创建数据计算逻辑模块
2. 实现REST API接口
3. 添加CSV导出功能
4. 编写单元测试

### Phase 2: 前端开发
1. 创建页面模板
2. 实现筛选和排序功能
3. 添加导出功能
4. 优化用户体验

### Phase 3: 集成测试
1. 编写集成测试用例
2. 性能测试和优化
3. 用户验收测试
4. 文档更新

## 注意事项

1. **时区处理**: 确保所有时间显示使用GMT+8
2. **数据一致性**: 处理一对多关系时的数据展示
3. **权限控制**: 限制只有gicho和kancho角色可访问
4. **性能考虑**: 大数据量时的查询和展示优化
5. **兼容性**: 与现有快速月报功能保持一致的交互模式

## 测试用例

### 功能测试
1. 基本数据展示测试
2. 筛选功能测试
3. 排序功能测试
4. CSV导出测试
5. 边界情况测试

### 异常测试
1. 无效月份参数
2. 无数据月份
3. 网络异常处理
4. 权限验证

### 性能测试
1. 大数据量查询
2. 并发访问测试
3. 内存使用监控