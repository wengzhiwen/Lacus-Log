{% extends "base.html" %}

{% block title %}底薪月报 - {{ pagination.month }}{% endblock %}

{% block content %}
<div id="baseSalaryMonthlyApp" data-report-month="{{ pagination.month }}" data-selected-mode="{{ selected_mode }}" data-selected-settlement="{{ selected_settlement }}">
  <div class="page-header">
    <h1 class="page-title">💰 底薪月报</h1>
  </div>

  <div class="date-navigation">
    <div class="date-controls">
      <a href="{{ url_for('base_salary_monthly.base_salary_monthly_report', month=pagination.prev_month, mode=selected_mode, settlement=selected_settlement) }}" class="btn btn-secondary btn-sm">← 上个月</a>
      <input type="month" id="monthSelector" value="{{ pagination.month }}" class="date-input">
      <a href="{{ url_for('base_salary_monthly.base_salary_monthly_report', month=pagination.next_month, mode=selected_mode, settlement=selected_settlement) }}" class="btn btn-secondary btn-sm">下个月 →</a>
    </div>
    <div class="export-actions">
      <a href="#" id="exportCsvBtn" class="btn btn-warning btn-sm">📥 导出CSV</a>
    </div>
  </div>

  <div class="filter-section">
    <div class="filter-controls">
      <label for="modeSelector" class="filter-label">开播方式：</label>
      <select id="modeSelector" class="filter-select">
        <option value="all" {% if selected_mode == 'all' %}selected{% endif %}>全部</option>
        <option value="online" {% if selected_mode == 'online' %}selected{% endif %}>线上</option>
        <option value="offline" {% if selected_mode == 'offline' %}selected{% endif %}>线下</option>
      </select>

      <label for="settlementSelector" class="filter-label">结算方式：</label>
      <select id="settlementSelector" class="filter-select">
        <option value="all" {% if selected_settlement == 'all' %}selected{% endif %}>全部</option>
        <option value="monthly_base" {% if selected_settlement == 'monthly_base' %}selected{% endif %}>月结底薪</option>
        <option value="daily_base" {% if selected_settlement == 'daily_base' %}selected{% endif %}>日结底薪</option>
        <option value="none" {% if selected_settlement == 'none' %}selected{% endif %}>无底薪</option>
      </select>
    </div>
  </div>

  <div class="summary-section">
    <div id="monthly-loading-state" class="empty-state">
      <div>加载中...</div>
    </div>
    <div style="display: none;" id="monthly-content">
      <h2 class="section-title" id="monthly-summary-title"></h2>
      <div class="summary-cards blast-intro" data-animate-group="month" id="monthly-summary-cards"></div>
    </div>
  </div>

  <div class="details-section">
    <h2 class="section-title">月报明细</h2>
    <div class="table-container" id="monthly-table-container" style="display: none;">
      <table class="report-table">
        <thead>
          <tr>
            <th class="fixed-col sortable-header" data-sort-key="pilot_nickname" data-sort-type="string" tabindex="0" aria-sort="none">主播昵称
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="pilot_real_name" data-sort-type="string" tabindex="0" aria-sort="none">真实姓名
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="start_time" data-sort-type="datetime" tabindex="0" aria-sort="none">开播时间
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="duration_hours" data-sort-type="number" tabindex="0" aria-sort="none">时长(小时)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="revenue_amount" data-sort-type="number" tabindex="0" aria-sort="none">流水(元)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="work_mode" data-sort-type="string" tabindex="0" aria-sort="none">开播方式
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="owner_name" data-sort-type="string" tabindex="0" aria-sort="none">直属运营
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="application_time" data-sort-type="datetime" tabindex="0" aria-sort="none">申请时间
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="application_amount" data-sort-type="number" tabindex="0" aria-sort="none">申请金额(元)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="settlement_type" data-sort-type="string" tabindex="0" aria-sort="none">结算方式
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="application_status" data-sort-type="string" tabindex="0" aria-sort="none">申请状态
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="applicant_name" data-sort-type="string" tabindex="0" aria-sort="none">申请人
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
          </tr>
        </thead>
        <tbody id="monthly-details-body"></tbody>
      </table>
    </div>
    <div class="empty-state" id="monthly-empty-state" style="display: none;">
      <p>本月暂无数据</p>
    </div>
  </div>
</div>

<style>

.date-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0;
  padding: 16px;
  background: var(--table-header);
  border-radius: 8px;
}

.date-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.date-input {
  padding: 8px 12px;
  border: 1px solid var(--gray);
  border-radius: 6px;
  font-size: 14px;
}

.export-actions {
  display: flex;
  gap: 8px;
}

.filter-section {
  margin: 16px 0;
  padding: 12px 16px;
  background: #f8f9fa;
  border-radius: 6px;
  border: 1px solid #e9ecef;
}

.filter-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  margin: 0;
  white-space: nowrap;
  flex-shrink: 0;
}

.filter-select {
  padding: 6px 12px;
  border: 1px solid var(--gray);
  border-radius: 4px;
  font-size: 14px;
  background: #fff;
  min-width: 120px;
}

.summary-section {
  margin: 24px 0;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.blast-intro {
  perspective: 800px;
  perspective-origin: 50% 35%;
}

.blast-intro .summary-card {
  transform: translateY(40px) translateZ(-120px) rotateZ(-8deg) rotateX(8deg) scale(0.6);
  opacity: 0;
  filter: blur(8px) saturate(0.9);
  will-change: transform, opacity, filter, box-shadow;
}

.blast-intro.play .summary-card {
  animation: blastIn 900ms cubic-bezier(0.2, 0.8, 0.2, 1.1) forwards;
}

.blast-intro.play .summary-card:nth-child(1) { animation-delay: 0ms; }
.blast-intro.play .summary-card:nth-child(2) { animation-delay: 80ms; }
.blast-intro.play .summary-card:nth-child(3) { animation-delay: 160ms; }
.blast-intro.play .summary-card:nth-child(4) { animation-delay: 240ms; }
.blast-intro.play .summary-card:nth-child(5) { animation-delay: 320ms; }
.blast-intro.play .summary-card:nth-child(6) { animation-delay: 400ms; }
.blast-intro.play .summary-card:nth-child(7) { animation-delay: 480ms; }

@keyframes blastIn {
  0%   { transform: translateY(40px) translateZ(-120px) rotateZ(-8deg) rotateX(8deg) scale(0.6); opacity: 0; filter: blur(8px) saturate(0.9); }
  60%  { transform: translateY(-6px) translateZ(20px) rotateZ(2deg) rotateX(-3deg) scale(1.04); opacity: 1; filter: blur(0) saturate(1); }
  85%  { transform: translateY(3px) translateZ(-10px) rotateZ(-1deg) rotateX(1deg) scale(0.99); opacity: 1; filter: blur(0) saturate(1); }
  100% { transform: translateY(0) translateZ(0) rotateZ(0) rotateX(0) scale(1); opacity: 1; filter: blur(0) saturate(1); }
}

.summary-card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  transition: box-shadow 0.2s ease;
}

.summary-card-clickable {
  cursor: pointer;
  position: relative;
}

.summary-card-clickable::after {
  content: '📈';
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 16px;
}

.summary-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.summary-card.danger-outline {
  border-color: #dc3545;
}

.card-label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}

.card-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--brand);
}

.details-section {
  margin: 24px 0;
}

.table-container {
  overflow-x: auto;
  border: 1px solid var(--gray);
  border-radius: 8px;
  background: #fff;
}

.report-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1600px;
}

.report-table th,
.report-table td {
  padding: 12px 8px;
  text-align: left;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

.report-table th {
  background: var(--table-header);
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 2;
}

.report-table th.fixed-col,
.report-table td.fixed-col {
  position: sticky;
  left: 0;
  background: #fff;
  background-clip: padding-box;
  min-width: 120px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.report-table td.fixed-col { z-index: 4; }
.report-table th.fixed-col { z-index: 5; }

.report-table td.fixed-col { box-shadow: 2px 0 0 #eee; }
.report-table th.fixed-col { box-shadow: 2px 0 0 #ddd; }

.report-table tbody tr:hover {
  background: #f8f9fa;
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

.pilot-link {
  color: var(--brand);
  text-decoration: none;
  font-weight: 600;
}

.pilot-link:hover {
  color: var(--brand-dark);
  text-decoration: underline;
}

.pilot-link-fallen {
  color: #6c757d;
  text-decoration: none;
  font-weight: 600;
}

.pilot-link-fallen:hover {
  color: #545b62;
  text-decoration: underline;
}

.text-danger {
  color: #dc3545 !important;
  font-weight: 600;
}

.sortable-header {
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
  position: relative;
}

.sortable-header:focus-visible {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

.sort-indicator {
  display: inline-flex;
  margin-left: 4px;
  font-size: 12px;
  opacity: 0.45;
}

.sortable-header.is-sorted .sort-indicator {
  opacity: 0.9;
}

.sortable-header.is-sorted-asc .sort-indicator::before {
  content: '▲';
}

.sortable-header.is-sorted-desc .sort-indicator::before {
  content: '▼';
}

.sortable-header:not(.is-sorted) .sort-indicator::before {
  content: '↕';
}

.status-approved {
  color: #28a745;
  font-weight: bold;
}

.status-pending {
  color: #ffc107;
  font-weight: bold;
}

.status-rejected {
  color: #dc3545;
  font-weight: bold;
}

@media (max-width: 768px) {
  .date-navigation {
    flex-direction: column;
    gap: 12px;
  }

  .filter-controls {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .filter-select {
    width: 100%;
    min-width: auto;
  }

  .summary-cards {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }

  .summary-card {
    padding: 12px;
  }

  .card-value {
    font-size: 20px;
  }

  .report-table {
    font-size: 12px;
  }

  .report-table th,
  .report-table td {
    padding: 8px 4px;
  }
}

</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const app = document.getElementById('baseSalaryMonthlyApp');
    const reportMonth = app.dataset.reportMonth;
    const selectedMode = app.dataset.selectedMode;
    const selectedSettlement = app.dataset.selectedSettlement;

    let currentData = null;
    let currentSort = {
        key: null, // 表示应用默认排序
        direction: 'asc'
    };

    // 获取月报数据
    async function fetchMonthlyData(month = null, mode = null, settlement = null) {
        const params = new URLSearchParams();
        if (month) params.append('month', month);
        if (mode) params.append('mode', mode);
        if (settlement) params.append('settlement', settlement);

        try {
            const response = await fetch(`/api/base-salary-monthly?${params}`);
            if (!response.ok) throw new Error('网络请求失败');
            const result = await response.json();
            if (!result.success) throw new Error(result.error?.message || '获取数据失败');
            return result;
        } catch (error) {
            console.error('获取月报数据失败:', error);
            showError('获取数据失败，请稍后重试');
            return null;
        }
    }

    // 显示错误信息
    function showError(message) {
        const loadingState = document.getElementById('monthly-loading-state');
        loadingState.innerHTML = `<div class="error-text">${message}</div>`;
    }

    // 渲染汇总数据
    function renderSummary(summary, month) {
        const summaryTitle = document.getElementById('monthly-summary-title');
        summaryTitle.textContent = `${month} 底薪月报汇总`;

        const summaryCards = document.getElementById('monthly-summary-cards');
        summaryCards.innerHTML = `
            <div class="summary-card">
                <div class="card-label">开播记录总数</div>
                <div class="card-value">${summary.total_records.toLocaleString()}</div>
            </div>
            <div class="summary-card">
                <div class="card-label">总流水金额</div>
                <div class="card-value">¥${summary.total_revenue.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</div>
            </div>
            <div class="summary-card">
                <div class="card-label">底薪申请数量</div>
                <div class="card-value">${summary.application_count.toLocaleString()}</div>
            </div>
            <div class="summary-card">
                <div class="card-label">总申请金额</div>
                <div class="card-value">¥${summary.total_base_salary.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</div>
            </div>
            <div class="summary-card">
                <div class="card-label">已发放数量</div>
                <div class="card-value">${summary.approved_count.toLocaleString()}</div>
            </div>
            <div class="summary-card">
                <div class="card-label">已发放金额</div>
                <div class="card-value">¥${summary.approved_amount.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</div>
            </div>
            <div class="summary-card">
                <div class="card-label">待处理数量</div>
                <div class="card-value">${summary.pending_count.toLocaleString()}</div>
            </div>
            <div class="summary-card">
                <div class="card-label">拒绝发放数量</div>
                <div class="card-value">${summary.rejected_count.toLocaleString()}</div>
            </div>
        `;
    }

    // 渲染明细表格
    function renderTable(details) {
        const tableBody = document.getElementById('monthly-details-body');
        tableBody.innerHTML = '';

        if (details.length === 0) {
            document.getElementById('monthly-table-container').style.display = 'none';
            document.getElementById('monthly-empty-state').style.display = 'block';
            return;
        }

        document.getElementById('monthly-table-container').style.display = 'block';
        document.getElementById('monthly-empty-state').style.display = 'none';

        details.forEach(detail => {
            const row = document.createElement('tr');

            // 重复申请的申请时间用红色标注
            const applicationTimeClass = detail.is_duplicate ? 'style="color: red; font-weight: bold;"' : '';

            // 状态样式
            let statusClass = '';
            if (detail.application_status_code === 'approved') statusClass = 'status-approved';
            else if (detail.application_status_code === 'pending') statusClass = 'status-pending';
            else if (detail.application_status_code === 'rejected') statusClass = 'status-rejected';

            row.innerHTML = `
                <td class="fixed-col">${detail.pilot_nickname}</td>
                <td>${detail.pilot_real_name}</td>
                <td>${detail.start_time}</td>
                <td>${detail.duration_hours}</td>
                <td>¥${detail.revenue_amount.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                <td>${detail.work_mode}</td>
                <td>${detail.owner_name}</td>
                <td ${applicationTimeClass}>${detail.application_time}</td>
                <td>¥${detail.application_amount.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                <td>${detail.settlement_type}</td>
                <td><span class="${statusClass}">${detail.application_status}</span></td>
                <td>${detail.applicant_name}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    // 加载并渲染数据
    async function loadAndRenderData(month = null, mode = null, settlement = null) {
        // 显示加载状态
        document.getElementById('monthly-loading-state').style.display = 'block';
        document.getElementById('monthly-content').style.display = 'none';

        const result = await fetchMonthlyData(month, mode, settlement);
        if (result) {
            currentData = result.data;

            // 隐藏加载状态
            document.getElementById('monthly-loading-state').style.display = 'none';
            document.getElementById('monthly-content').style.display = 'block';

            // 渲染数据
            renderSummary(result.data.summary, result.data.month);

            // 应用默认排序
            applyDefaultSort(result.data.details);
            renderTable(result.data.details);

            // 触发动画
            setTimeout(() => {
                document.querySelector('.blast-intro').classList.add('play');
            }, 100);
        }
    }

    // 应用默认排序
    function applyDefaultSort(details) {
        // 定义结算方式的排序顺序
        const settlementOrder = {
            'monthly_base': 1,  // 月结底薪
            'daily_base': 2,     // 日结底薪
            'none': 3             // 无底薪
        };

        details.sort((a, b) => {
            // 1. 按结算方式顺序排序
            const aOrder = settlementOrder[a.settlement_type_code] || 999;
            const bOrder = settlementOrder[b.settlement_type_code] || 999;

            if (aOrder !== bOrder) {
                return aOrder - bOrder;
            }

            // 2. 按主播昵称拼音排序（使用 localeCompare 支持中文拼音）
            const aNickname = a.pilot_nickname || '';
            const bNickname = b.pilot_nickname || '';
            const nicknameCompare = aNickname.localeCompare(bNickname, 'zh-CN');

            if (nicknameCompare !== 0) {
                return nicknameCompare;
            }

            // 3. 按开始时间升序排序
            const aTime = new Date(a.start_time).getTime() || 0;
            const bTime = new Date(b.start_time).getTime() || 0;

            return aTime - bTime;
        });
    }

    // 排序功能
    function setupSorting() {
        const sortableHeaders = document.querySelectorAll('.sortable-header');
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const sortKey = this.dataset.sortKey;
                const sortType = this.dataset.sortType;

                // 更新排序方向
                if (currentSort.key === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = sortKey;
                    currentSort.direction = 'asc';
                }

                // 更新排序指示器
                document.querySelectorAll('.sortable-header').forEach(h => {
                    h.classList.remove('is-sorted', 'is-sorted-asc', 'is-sorted-desc');
                });
                this.classList.add('is-sorted');
                this.classList.add(currentSort.direction === 'asc' ? 'is-sorted-asc' : 'is-sorted-desc');

                // 执行排序
                if (currentData && currentData.details) {
                    sortData(sortKey, sortType, currentSort.direction);
                    renderTable(currentData.details);
                }
            });
        });
    }

    // 数据排序
    function sortData(key, type, direction) {
        currentData.details.sort((a, b) => {
            // 对于特殊排序键，使用自定义逻辑
            if (key === 'settlement_type_code') {
                const settlementOrder = {
                    'monthly_base': 1,
                    'daily_base': 2,
                    'none': 3
                };
                const aOrder = settlementOrder[a.settlement_type_code] || 999;
                const bOrder = settlementOrder[b.settlement_type_code] || 999;
                return direction === 'asc' ? aOrder - bOrder : bOrder - aOrder;
            }

            let aVal = a[key];
            let bVal = b[key];

            if (type === 'number') {
                aVal = parseFloat(aVal) || 0;
                bVal = parseFloat(bVal) || 0;
            } else if (type === 'datetime') {
                aVal = new Date(aVal).getTime() || 0;
                bVal = new Date(bVal).getTime() || 0;
            } else if (type === 'string') {
                // 对于字符串，支持中文拼音排序
                aVal = aVal || '';
                bVal = bVal || '';
                const compareResult = aVal.localeCompare(bVal, 'zh-CN');
                return direction === 'asc' ? compareResult : -compareResult;
            }

            if (aVal < bVal) return direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return direction === 'asc' ? 1 : -1;
            return 0;
        });
    }

    // 月份选择器
    document.getElementById('monthSelector').addEventListener('change', function() {
        const newMonth = this.value;
        const mode = document.getElementById('modeSelector').value;
        const settlement = document.getElementById('settlementSelector').value;

        // 更新URL
        const url = new URL(window.location);
        url.searchParams.set('month', newMonth);
        url.searchParams.set('mode', mode);
        url.searchParams.set('settlement', settlement);
        window.history.pushState({}, '', url);

        loadAndRenderData(newMonth, mode, settlement);
    });

    // 筛选器事件
    document.getElementById('modeSelector').addEventListener('change', function() {
        const mode = this.value;
        const settlement = document.getElementById('settlementSelector').value;
        const month = document.getElementById('monthSelector').value;
        loadAndRenderData(month, mode, settlement);
    });

    document.getElementById('settlementSelector').addEventListener('change', function() {
        const settlement = this.value;
        const mode = document.getElementById('modeSelector').value;
        const month = document.getElementById('monthSelector').value;
        loadAndRenderData(month, mode, settlement);
    });

    // CSV导出
    document.getElementById('exportCsvBtn').addEventListener('click', function(e) {
        e.preventDefault();
        const month = document.getElementById('monthSelector').value;
        const mode = document.getElementById('modeSelector').value;
        const settlement = document.getElementById('settlementSelector').value;

        const params = new URLSearchParams();
        params.append('month', month);
        params.append('mode', mode);
        params.append('settlement', settlement);

        const exportUrl = `/api/base-salary-monthly/export.csv?${params}`;
        window.open(exportUrl, '_blank');
    });

    // 初始化
    setupSorting();
    loadAndRenderData(reportMonth, selectedMode, selectedSettlement);
});
</script>
{% endblock %}