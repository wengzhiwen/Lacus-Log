{% extends "base.html" %}

{% block title %}åº•è–ªç”³è¯·åˆ—è¡¨ - Lacus-Log{% endblock %}

{% block content %}
<section class="applications-list-page">
  <div class="page-header">
    <h1 class="page-title">åº•è–ªç”³è¯·åˆ—è¡¨</h1>
  </div>

  <!-- æ—¥æœŸé€‰æ‹©å™¨å’Œæ“ä½œæ  -->
  <div class="toolbar">
    <div class="date-picker-section">
      <button class="btn btn-small" onclick="prevDay()">&larr; å‰ä¸€å¤©</button>
      <input type="date" id="applicationDate" class="date-input">
      <button class="btn btn-small" onclick="nextDay()">åä¸€å¤© &rarr;</button>
    </div>
    <div class="actions">
      <button class="btn btn-primary" onclick="exportCSV()">ğŸ“¥ å¯¼å‡ºCSV</button>
    </div>
  </div>

  <!-- ç»Ÿè®¡æ•°æ®å¡ç‰‡ -->
  <div class="stats-section">
    <div id="statsLoadingState" class="loading-state" style="display:none;">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ç»Ÿè®¡æ•°æ®...</div>
    </div>
    <div id="statsCards" class="summary-cards" style="display:none;">
      <!-- ç»Ÿè®¡æ•°æ®å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <!-- åˆ—è¡¨å®¹å™¨ -->
  <div class="applications-section">
    <div id="loadingState" class="loading-state" style="display:none;">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>

    <div id="applicationsList" class="applications-list"></div>

    <div id="emptyState" class="empty-state" style="display:none;">
      <div class="empty-icon">ğŸ“‹</div>
      <div class="empty-title">æš‚æ— åº•è–ªç”³è¯·</div>
      <div class="empty-description">è¯¥æ—¥æœŸæ²¡æœ‰åº•è–ªç”³è¯·è®°å½•</div>
    </div>

    <div id="errorMessage" class="error-message" style="display:none;"></div>
  </div>
</section>
<br /><span class="date-display" id="dateDisplay"></span>

<!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="detailModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ç”³è¯·è¯¦æƒ…</h3>
      <button class="modal-close" onclick="closeDetail()">&times;</button>
    </div>
    <div class="modal-body" id="detailContent">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <div class="loading-text">åŠ è½½ä¸­...</div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeDetail()">å…³é—­</button>
    </div>
  </div>
</div>

<style>

.applications-list-page {
  padding: 16px;
  max-width: 1200px;
  margin: 0 auto;
}

.page-header {
  margin-bottom: 24px;
}

.page-title {
  font-size: 24px;
  font-weight: 600;
  color: #333;
  margin: 0;
}

.toolbar {
  background: #fff;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.date-picker-section {
  display: flex;
  align-items: center;
  gap: 8px;
}

.date-input {
  padding: 8px 12px;
  border: 1px solid #d9d9d9;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
}

.date-display {
  font-size: 14px;
  color: #666;
  min-width: 100px;
}

.actions {
  display: flex;
  gap: 8px;
}

.btn {
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  border: none;
  transition: all 0.2s;
}

.btn-small {
  background: #f0f0f0;
  color: #333;
  border: 1px solid #ddd;
}

.btn-small:hover {
  background: #e8e8e8;
}

.btn-primary {
  background: #1890ff;
  color: white;
}

.btn-primary:hover {
  background: #1570cc;
}

.applications-section {
  background: #fff;
  border-radius: 8px;
  padding: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.applications-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.application-card {
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.application-card:hover {
  background: #f5f5f5;
  border-color: #1890ff;
  box-shadow: 0 2px 4px rgba(24, 144, 255, 0.15);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.pilot-info {
  font-weight: 500;
  color: #333;
}

.status-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 3px;
  font-size: 12px;
  font-weight: 500;
}

.status-pending {
  background: #f5f5f5;
  color: #999;
}

.status-approved {
  background: #f6ffed;
  color: #52c41a;
}

.status-rejected {
  background: #fff2e6;
  color: #fa541c;
}

.card-content {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  font-size: 12px;
}

.card-field {
  display: flex;
  flex-direction: column;
}

.field-label {
  color: #999;
  font-size: 11px;
  margin-bottom: 2px;
}

.field-value {
  color: #333;
  font-weight: 500;
}

.field-value.amount {
  color: #8B0000;
  font-size: 13px;
}

.loading-state {
  text-align: center;
  padding: 40px 20px;
}

.loading-spinner {
  border: 2px solid #f3f3f3;
  border-top: 2px solid #1890ff;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
  margin: 0 auto 12px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  color: #666;
  font-size: 14px;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.empty-title {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin-bottom: 4px;
}

.empty-description {
  font-size: 12px;
  color: #999;
}

.error-message {
  background: #fff2e6;
  border: 1px solid #ffbb96;
  border-radius: 4px;
  padding: 12px;
  color: #c6001a;
  font-size: 14px;
  margin-bottom: 16px;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  overflow: auto;
}

.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 0;
  border: 1px solid #888;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  flex-direction: column;
}

.modal-header {
  padding: 16px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
}

.modal-body {
  padding: 16px;
  flex: 1;
  overflow-y: auto;
  font-size: 12px;
  color: #333;
}

.modal-footer {
  padding: 16px;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

.btn-secondary {
  background: #f0f0f0;
  color: #333;
  border: 1px solid #ddd;
}

.btn-secondary:hover {
  background: #e8e8e8;
}

@media (max-width: 768px) {
  .toolbar {
    flex-direction: column;
    align-items: stretch;
  }

  .date-picker-section {
    width: 100%;
    justify-content: center;
  }

  .actions {
    width: 100%;
    justify-content: center;
  }

  .card-content {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* ç»Ÿè®¡æ•°æ®å¡ç‰‡æ ·å¼ */
.stats-section {
  margin: 24px 0;
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.summary-card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  transition: box-shadow 0.2s ease;
}

.summary-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.card-label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
  font-weight: 500;
}

.card-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--brand);
  margin-bottom: 4px;
  line-height: 1;
}

.card-value.approved {
  color: var(--hud-green);
}

.card-value.rejected {
  color: var(--hud-red);
}

.card-value.pending {
  color: var(--muted);
}

.card-sub {
  font-size: 12px;
  color: var(--muted);
}

/* åˆ†ç»„æ˜¾ç¤ºæ ·å¼ */
.settlement-section {
  margin-bottom: 32px;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  color: #333;
  margin: 0 0 16px 0;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--brand);
}

.monthly-title {
  color: #d32f2f;
  border-bottom-color: #d32f2f;
}

.settlement-group {
  margin-bottom: 32px;
}

.group-title {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin: 0 0 16px 0;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--table-header);
}

.monthly-title {
  color: #d32f2f;
  border-bottom-color: #d32f2f;
}

.monthly-settlement {
  color: #d32f2f !important;
  font-weight: 600;
}

</style>

<script>
const applicationDate = document.getElementById('applicationDate');
const dateDisplay = document.getElementById('dateDisplay');

// åˆå§‹åŒ–æ—¥æœŸ
function initDate() {
  // ä»URLå‚æ•°è·å–æ—¥æœŸï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ä»Šå¤©
  const urlParams = new URLSearchParams(window.location.search);
  const dateParam = urlParams.get('date');
  
  if (dateParam) {
    applicationDate.value = dateParam;
  } else {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    applicationDate.value = `${year}-${month}-${day}`;
  }
  
  updateDateDisplay();
  loadDataSequentially();
}

// é¡ºåºåŠ è½½æ•°æ®ï¼šå…ˆåŠ è½½ç»Ÿè®¡ï¼Œå†åŠ è½½åˆ—è¡¨ï¼Œç¡®ä¿window.currentStatså·²æ›´æ–°
async function loadDataSequentially() {
  try {
    await loadStats();
    await loadApplications();
  } catch (error) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
  }
}

// æ›´æ–°æ—¥æœŸæ˜¾ç¤º
function updateDateDisplay() {
  const date = new Date(applicationDate.value);
  dateDisplay.textContent = date.toLocaleDateString('zh-CN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

// å‰ä¸€å¤©
function prevDay() {
  const date = new Date(applicationDate.value);
  date.setDate(date.getDate() - 1);
  applicationDate.value = date.toISOString().split('T')[0];
  updateDateDisplay();
  loadDataSequentially();
}

// åä¸€å¤©
function nextDay() {
  const date = new Date(applicationDate.value);
  date.setDate(date.getDate() + 1);
  applicationDate.value = date.toISOString().split('T')[0];
  updateDateDisplay();
  loadDataSequentially();
}

// æ—¥æœŸå˜æ›´
applicationDate.addEventListener('change', () => {
  updateDateDisplay();
  loadDataSequentially();
});

// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStats() {
  const date = applicationDate.value;
  const statsLoadingState = document.getElementById('statsLoadingState');
  const statsCards = document.getElementById('statsCards');

  statsLoadingState.style.display = 'block';
  statsCards.style.display = 'none';

  try {
    const response = await fetch(`/api/base-salary-applications/stats?date=${date}`, {
      credentials: 'include'
    });

    if (!response.ok) {
      throw new Error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥');
    }

    const result = await response.json();
    if (result.success) {
      // ä¿å­˜ç»Ÿè®¡æ•°æ®åˆ°å…¨å±€å˜é‡
      window.currentStats = result.data;
      renderStatsCards(result.data);
    } else {
      throw new Error(result.error?.message || 'åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥');
    }
  } catch (error) {
    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    // å³ä½¿ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥ï¼Œä¹Ÿä¸å½±å“ä¸»è¦åŠŸèƒ½
  } finally {
    statsLoadingState.style.display = 'none';
  }
}

// æ¸²æŸ“ç»Ÿè®¡æ•°æ®å¡ç‰‡
function renderStatsCards(stats) {
  const statsCards = document.getElementById('statsCards');

  // æ¸²æŸ“æ—¥ç»“åº•è–ªç»Ÿè®¡
  const dailyStats = stats.daily_base || {};
  const dailyCards = [
    {
      label: 'æ€»ç”³è¯·é‡‘é¢',
      value: formatMoney(dailyStats.total_amount),
      class: ''
    },
    {
      label: 'å·²å‘æ”¾é‡‘é¢',
      value: formatMoney(dailyStats.approved_amount),
      class: 'approved'
    },
    {
      label: 'å·²æ‹’ç»é‡‘é¢',
      value: formatMoney(dailyStats.rejected_amount),
      class: 'rejected'
    },
    {
      label: 'æœªå¤„ç†é‡‘é¢',
      value: formatMoney(dailyStats.pending_amount),
      class: 'pending'
    }
  ];

  // æ¸²æŸ“æœˆç»“åº•è–ªç»Ÿè®¡
  const monthlyStats = stats.monthly_base || {};
  const monthlyCards = [
    {
      label: 'æ€»ç”³è¯·é‡‘é¢',
      value: formatMoney(monthlyStats.total_amount),
      class: ''
    },
    {
      label: 'å·²å‘æ”¾é‡‘é¢',
      value: formatMoney(monthlyStats.approved_amount),
      class: 'approved'
    },
    {
      label: 'å·²æ‹’ç»é‡‘é¢',
      value: formatMoney(monthlyStats.rejected_amount),
      class: 'rejected'
    },
    {
      label: 'æœªå¤„ç†é‡‘é¢',
      value: formatMoney(monthlyStats.pending_amount),
      class: 'pending'
    }
  ];

  statsCards.innerHTML = `
    <!-- æ—¥ç»“åº•è–ªç»Ÿè®¡ -->
    <div class="settlement-section">
      <h3 class="section-title">æ—¥ç»“åº•è–ª</h3>
      <div class="summary-cards">
        ${dailyCards.map(card => `
          <div class="summary-card">
            <div class="card-label">${card.label}</div>
            <div class="card-value ${card.class}">${card.value}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  statsCards.style.display = 'block';
}


// æ ¼å¼åŒ–é‡‘é¢
function formatMoney(amount) {
  if (amount === null || amount === undefined) {
    return 'Â¥0.00';
  }
  return 'Â¥' + parseFloat(amount).toLocaleString('zh-CN', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

// åŠ è½½ç”³è¯·åˆ—è¡¨
async function loadApplications() {
  const date = applicationDate.value;
  const loadingState = document.getElementById('loadingState');
  const applicationsList = document.getElementById('applicationsList');
  const emptyState = document.getElementById('emptyState');
  const errorMessage = document.getElementById('errorMessage');

  loadingState.style.display = 'block';
  applicationsList.innerHTML = '';
  emptyState.style.display = 'none';
  errorMessage.style.display = 'none';

  try {
    const response = await fetch(`/api/base-salary-applications?date=${date}&page_size=100`, {
      credentials: 'include'
    });

    if (!response.ok) {
      throw new Error('åŠ è½½æ•°æ®å¤±è´¥');
    }

    const result = await response.json();
    if (result.success) {
      const groupedData = result.data || {};
      // æ€»æ˜¯æ¸²æŸ“ç”³è¯·åˆ—è¡¨ï¼ˆåŒ…å«å ä½ç¬¦ç©ºçŠ¶æ€ï¼‰
      renderApplications(groupedData);
    } else {
      throw new Error(result.error?.message || 'åŠ è½½å¤±è´¥');
    }
  } catch (error) {
    showError(error.message);
  } finally {
    loadingState.style.display = 'none';
  }
}

// æ¸²æŸ“ç”³è¯·å¡ç‰‡
function renderApplications(groupedData) {
  const list = document.getElementById('applicationsList');

  const dailyApps = groupedData.daily_base || [];
  const monthlyApps = groupedData.monthly_base || [];
  const noneApps = groupedData.none || [];

  let html = '';

  // æ¸²æŸ“æ—¥ç»“åº•è–ªç”³è¯·ï¼ˆæ€»æ˜¯æ˜¾ç¤ºï¼‰
  html += `
    <div class="settlement-group">
      <h3 class="group-title">æ—¥ç»“åº•è–ªæ˜ç»†</h3>
      <div class="applications-list">
        ${dailyApps.length > 0 ? dailyApps.map(app => renderApplicationCard(app)).join('') : '<div class="empty-state"><div class="empty-title">æš‚æ— æ—¥ç»“åº•è–ªç”³è¯·</div></div>'}
      </div>
    </div>
  `;

  // ä½¿ç”¨window.currentStatsä¸­æœ€æ–°çš„æœˆç»“ç»Ÿè®¡æ•°æ®
  const monthlyStats = (window.currentStats && window.currentStats.monthly_base) || {
    total_amount: 0,
    approved_amount: 0,
    rejected_amount: 0,
    pending_amount: 0
  };

  const monthlyCards = [
    {
      label: 'æ€»ç”³è¯·é‡‘é¢',
      value: formatMoney(monthlyStats.total_amount),
      class: ''
    },
    {
      label: 'å·²å‘æ”¾é‡‘é¢',
      value: formatMoney(monthlyStats.approved_amount),
      class: 'approved'
    },
    {
      label: 'å·²æ‹’ç»é‡‘é¢',
      value: formatMoney(monthlyStats.rejected_amount),
      class: 'rejected'
    },
    {
      label: 'æœªå¤„ç†é‡‘é¢',
      value: formatMoney(monthlyStats.pending_amount),
      class: 'pending'
    }
  ];

  html += `
    <!-- æœˆç»“åº•è–ªç»Ÿè®¡ -->
    <div class="settlement-section">
      <h3 class="section-title monthly-title">æœˆç»“åº•è–ª</h3>
      <div class="summary-cards">
        ${monthlyCards.map(card => `
          <div class="summary-card">
            <div class="card-label">${card.label}</div>
            <div class="card-value ${card.class}">${card.value}</div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  // æ¸²æŸ“æœˆç»“åº•è–ªç”³è¯·ï¼ˆæ€»æ˜¯æ˜¾ç¤ºï¼‰
  html += `
    <div class="settlement-group">
      <h3 class="group-title monthly-title">æœˆç»“åº•è–ªæ˜ç»†</h3>
      <div class="applications-list">
        ${monthlyApps.length > 0 ? monthlyApps.map(app => renderApplicationCard(app)).join('') : '<div class="empty-state"><div class="empty-title">æš‚æ— æœˆç»“åº•è–ªç”³è¯·</div></div>'}
      </div>
    </div>
  `;

  // æ¸²æŸ“æ— åº•è–ªç”³è¯·
  if (noneApps.length > 0) {
    html += `
      <div class="settlement-group">
        <h3 class="group-title">æ— åº•è–ªæ˜ç»†</h3>
        <div class="applications-list">
          ${noneApps.map(app => renderApplicationCard(app)).join('')}
        </div>
      </div>
    `;
  }

  list.innerHTML = html;
}

// æ¸²æŸ“å•ä¸ªç”³è¯·å¡ç‰‡
function renderApplicationCard(app) {
  const isMonthlyBase = app.settlement_type === 'monthly_base';

  return `
    <div class="application-card" onclick="goToDetail('${app.id}')">
      <div class="card-header">
        <div class="pilot-info">${app.pilot?.nickname || 'æœªçŸ¥'}ï¼ˆ${app.pilot?.real_name || 'æœªçŸ¥'}ï¼‰</div>
        <span class="status-badge status-${app.status}">${app.status_display}</span>
      </div>
      <div class="card-content">
        <div class="card-field">
          <div class="field-label">ç›´å±è¿è¥</div>
          <div class="field-value">${app.pilot?.owner?.nickname || 'æœªçŸ¥'}</div>
        </div>
        <div class="card-field">
          <div class="field-label">ç”³è¯·äºº</div>
          <div class="field-value">${app.applicant?.nickname || 'æœªçŸ¥'}</div>
        </div>
        <div class="card-field">
          <div class="field-label">å¼€æ’­æ—¶é—´</div>
          <div class="field-value">${formatDateTime(app.battle_record?.start_time) || 'æœªçŸ¥'}</div>
        </div>
        <div class="card-field">
          <div class="field-label">ç»“ç®—æ–¹å¼</div>
          <div class="field-value ${isMonthlyBase ? 'monthly-settlement' : ''}">${app.settlement_type_display || 'æœªçŸ¥'}</div>
        </div>
        <div class="card-field">
          <div class="field-label">æµæ°´é‡‘é¢</div>
          <div class="field-value amount">Â¥${parseFloat(app.battle_record?.revenue_amount || 0).toFixed(2)}</div>
        </div>
        <div class="card-field">
          <div class="field-label">ç”³è¯·åº•è–ª</div>
          <div class="field-value amount">Â¥${parseFloat(app.base_salary_amount || 0).toFixed(2)}</div>
        </div>
      </div>
    </div>
  `;
}

// è·³è½¬åˆ°è¯¦æƒ…é¡µé¢
function goToDetail(appId) {
  const currentDate = applicationDate.value;
  window.location.href = `/reports/base-salary-applications/detail?id=${appId}&date=${currentDate}`;
}

// æ˜¾ç¤ºè¯¦æƒ…
async function showDetail(appId) {
  const modal = document.getElementById('detailModal');
  const detailContent = document.getElementById('detailContent');
  modal.style.display = 'block';

  try {
    const response = await fetch(`/api/base-salary-applications/${appId}`, {
      credentials: 'include'
    });

    if (!response.ok) {
      throw new Error('åŠ è½½è¯¦æƒ…å¤±è´¥');
    }

    const result = await response.json();
    if (result.success) {
      const app = result.data;
      detailContent.innerHTML = `
        <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 13px;">
          <div><strong>ä¸»æ’­æ˜µç§°</strong><br>${app.pilot?.nickname || '--'}</div>
          <div><strong>çœŸå®å§“å</strong><br>${app.pilot?.real_name || '--'}</div>
          <div><strong>ç›´å±è¿è¥</strong><br>${app.pilot?.owner?.nickname || '--'}</div>
          <div><strong>å¼€æ’­æ—¶é—´</strong><br>${formatDateTime(app.battle_record?.start_time) || '--'}</div>
          <div><strong>æ—¶é•¿</strong><br>${app.battle_record?.duration_hours || 0} å°æ—¶</div>
          <div><strong>æµæ°´é‡‘é¢</strong><br>Â¥${parseFloat(app.battle_record?.revenue_amount || 0).toFixed(2)}</div>
          <div><strong>ç»“ç®—æ–¹å¼</strong><br>${app.settlement_type_display}</div>
          <div><strong>åº•è–ªé‡‘é¢</strong><br>Â¥${parseFloat(app.base_salary_amount || 0).toFixed(2)}</div>
          <div><strong>ç”³è¯·äºº</strong><br>${app.applicant?.nickname || '--'}</div>
          <div><strong>çŠ¶æ€</strong><br>${app.status_display}</div>
          <div><strong>åˆ›å»ºæ—¶é—´</strong><br>${formatDateTime(app.created_at) || '--'}</div>
          <div><strong>æ›´æ–°æ—¶é—´</strong><br>${formatDateTime(app.updated_at) || '--'}</div>
        </div>
      `;
    } else {
      throw new Error(result.error?.message || 'åŠ è½½å¤±è´¥');
    }
  } catch (error) {
    detailContent.innerHTML = `<div style="color: #c6001a;">åŠ è½½å¤±è´¥ï¼š${error.message}</div>`;
  }
}

// å…³é—­è¯¦æƒ…
function closeDetail() {
  document.getElementById('detailModal').style.display = 'none';
}

// å¯¼å‡ºCSV
async function exportCSV() {
  const date = applicationDate.value;
  window.location.href = `/api/base-salary-applications/export?date=${date}`;
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(isoString) {
  if (!isoString) return '--';
  try {
    const date = new Date(isoString);
    return date.toLocaleString('zh-CN');
  } catch {
    return '--';
  }
}

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
  const errorMessage = document.getElementById('errorMessage');
  errorMessage.textContent = message;
  errorMessage.style.display = 'block';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨æ—¶å…³é—­
window.onclick = function(event) {
  const modal = document.getElementById('detailModal');
  if (event.target === modal) {
    modal.style.display = 'none';
  }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initDate);

// ç›‘å¬é¡µé¢å¯è§æ€§ï¼Œä»å…¶ä»–é¡µé¢è¿”å›æ—¶åˆ·æ–°æ•°æ®
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œåˆ·æ–°ç»Ÿè®¡æ•°æ®å’Œåˆ—è¡¨
    loadDataSequentially();
  }
});
</script>
{% endblock %}
