# 主播-开播记录（原“机师-作战记录”）

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；征召→招募；参战形式→开播方式；战斗区域→开播地点；战区→开播地点；阶级→主播分类；所属→直属运营；X坐标→基地；Y坐标→场地；Z坐标→坐席；作战计划→通告；作战记录→开播记录。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。
主播-开播记录用于登记主播（历史称“机师”）一次实际参与直播的结果数据。其结构与《主播-通告》高度相似：有列表页与详情页，支持新建、编辑、删除，但不支持批量（循环）操作。

本模块内部统一使用“主播”“通告”两词，避免与“通告”混淆。

## 重要约定

数据库中存放的所有日期时间都是UTC，界面上的输入和显示都是GMT+8，必须严格遵守。

## 元数据

| 字段 | 说明 | 参考类型 | 设定 |
|---------|------|------|------|
| ID | 系统内部唯一编码，用户不可见 | 由技术设计 | 必须 唯一 |
| 主播 | 本次参战的主播 | 关联到主播唯一ID | 必须 |
| 关联通告 | 若从通告生成或挂接的通告 | 关联到通告唯一ID | 非必须 |
| 开始时间 | 本次开播的开始时间 | 时间戳UTC | 必须 |
| 结束时间 | 本次开播的结束时间 | 时间戳UTC | 必须，结束≥开始 |
| 流水金额 | 人民币元，两位小数 | 数值 | 必须，默认=0 |
| 基地 | 开播地点基地快照 | 字符串 | 线下必填，线上留空 |
| 场地 | 开播地点场地快照 | 字符串 | 线下必填，线上留空 |
| 坐席 | 开播地点坐席快照 | 字符串 | 线下必填，线上留空 |
| 开播方式 | 线上 / 线下 | 枚举 | 必须，默认从主播复制 |
| 底薪金额 | 人民币元，两位小数 | 数值 | 必须，默认=0 |
| 直属运营 | 从主播复制的直属运营（运营）快照 | 关联到用户唯一ID | 必须，仅显示不可编辑 |
| 登记人 | 首次登记的操作人 | 关联到用户唯一ID | 必须，仅显示不可编辑 |
| 备注 | 补充描述 | 字符串 | 非必须，≤200字 |
| 变更记录 | 字段修改日志（时间、操作者、字段、前值、后值、IP） | JSON或技术自定 | 非必须 |
| 创建时间 | 创建本记录的时间 | 时间戳 | 必须，默认=当前UTC |
| 最后修改 | 最近一次修改时间 | 时间戳 | 必须，默认=当前UTC |

### 外部关联与快照
- X/Y/坐席为快照，用于回溯展示；开播地点后续修改不会反向影响已登记记录。
- 直属运营为登记时从主播复制的快照，展示但不可编辑。
- 开播方式默认从主播复制，但允许修改为与主播元数据不同的值。

## 新建与编辑

### 入口
- 模块入口页底部 footbar：按钮“登记开播记录”。
- 通告详情页底部 footbar：按钮“登记开播记录”。点击后应自动带入通告信息以预填。

### 默认值与时间规则
- 开始时间默认：当前时间向前6小时，再“向前取最近的整点或半点”。
- 结束时间默认：当前时间“向前取最近的整点或半点”。
- 所有时间在数据库中以UTC存储；UI显示和输入采用GMT+8（同项目既有约定）。

“向前取最近的整点或半点”定义：给定本地时间 t，若分钟∈(30,59]，则取到 hh:30；若分钟∈[0,30]，则取到 hh:00；若恰为hh:30或hh:00，直接取该时间点。

### 表单要素（最新）
- 主播：编辑页为只读展示，格式为“昵称(年龄)[状态]性别符号”，性别=男♂/女♀/?。
- 直属运营：只读展示，优先显示运营/管理员的昵称，无昵称时回退到用户名。
- 登记人：只读展示，优先显示昵称，无昵称时回退用户名。
- 开播地点：三联选择 X→Y→Z；“开播方式”移动到“开播地点”分组的首位，并与坐标联动：
  - 开播方式=线上：X/Y/Z不可编辑且必须为空；
  - 开播方式=线下：X/Y/Z为必填。
- 关联通告：编辑页为只读文本，不可修改；显示格式“YYYY-MM-DD 星期M N小时 @X-Y-Z”，无则显示“无关联通告”。
- 金额：流水金额、底薪金额（人民币元，保留两位小数），UI默认值为0。
- 备注：非必须（≤200字）。

### 校验
- 主播不可为空。
- 开播方式为线下时，X/Y/坐席不可为空；开播方式为线上时，X/Y/Z应为空且不可编辑。
- 开始时间与结束时间不可为空，且结束时间≥开始时间。
- 金额类字段若填写需为有效数值并保留两位小数。

### 保存逻辑（最新）
- 首次保存写入“登记人”。
- 写入“直属运营”“开播方式”的快照。
- 写入变更记录（字段、时间、操作者、前后值、IP）。
- 关联通告字段的更新规则：仅当表单中显式提交 `related_announcement` 时才更新；未提交则保持不变；提交空字符串表示清空关联。

## 从不同入口登记的行为

### 1）直接从本模块入口新建
- 页面底部 footbar 点“登记开播记录”。
- 通过三联选择主播，随后可选关联通告；若选了关联通告，则预填绝大部分字段，用户可调整后保存；若不选通告则手动填写所有字段。

  说明：上述交互由前端调用多个API组合实现，并非单一路由在后端串行处理。

### 2）从通告详情页进入
- 点击“登记开播记录”，自动预填：主播、开始/结束时间、X/Y/坐席、开播方式、直属运营。
- 用户可编辑金额、备注及必要修正后保存。

## 列表

### 展示
- 每次取100条，滚动加载更多。
- 开始时间-开播时长（同一行显示，开播时长通过计算获得 格式=0.0小时）、主播昵称[直属运营]、开播方式、流水金额。
- 点击进入开播记录详情。

### 筛选器
- 直属运营
- 主播分类
- 主播（格式=主播昵称(年龄)[状态]性别icon，与直属运营、主播分类联动；“已招募/已签约”排前，其他状态排后）
- 时间：这两天、近7天（默认=这两天）

筛选器可复合使用，取交集；写入Cookie保存。

### 排序
- 第一排序：开始时间逆序。
- 第二排序：流水金额逆序。

## 详情（最新）
- 展示全部字段；底部 footbar：编辑、删除、变更记录。
- **主播信息**：
  - 主播昵称为超链接，点击可跳转到主播详情页面
  - 跳转时携带来源参数 `from='battle_record_detail'`、`record_id`，确保从主播详情页返回时能正确回到开播记录详情页
  - 右侧提供"业绩查看"超链接，跳转到主播业绩页面，携带来源参数 `from='battle_record_detail'`、`record_id`
- 主播/直属运营/登记人显示规则与编辑页一致。
- 开播方式显示在"开播地点"分组中；当开播方式为线上时，坐标显示为空。
- 关联通告：按"YYYY-MM-DD 星期M N小时 @X-Y-Z"格式显示，并提供跳转到通告详情的超链接；无则显示"无关联通告"。
- 变更记录弹窗展示最近100条，按时间逆序：变更时间、操作用户、字段、前值、后值、IP。

## 权限
- 管理员、运营：可见与可写（按系统全局权限约定）。
- 其他角色：遵循项目统一的权限策略（由技术实现）。

## 技术实现要点
- 参考《主播-通告》的三联选择组件与接口：
  - 在本模块中我对筛选器组件做了一些设计调整，未来可能会应用回《主播-通告》等其他模块
  - 开播地点X/Y/Z三联选择及排序逻辑保持一致。
- 时间处理：使用 `utils/timezone_helper.py` 的统一转换方法，确保“数据库UTC，UI GMT+8”。
- 模板与UI：沿用项目移动优先与卡片式布局；footbar 按钮与既有模块一致。
- 日志：按模块分文件输出到 `./log` 目录；必要时使用INFO，复杂流程留足DEBUG日志（中文）。

## 接口（后端）

- 获取主播筛选器选项：GET `/battle-records/api/pilot-filters`
  - 返回：`owners`（直属运营列表）、`ranks`（主播分类枚举）
- 按筛选获取主播列表：GET `/battle-records/api/pilots-filtered?owner=<id>&rank=<枚举>`
  - 返回：`pilots` 列表，含展示名、昵称、状态、主播分类、直属运营
- 获取开播地点三联数据：GET `/battle-records/api/battle-areas`
  - 返回：按 `X -> Y -> Z` 的映射结构，Z按数值优先排序
- 获取通告详情用于预填：GET `/battle-records/api/announcements/<announcement_id>`
  - 返回：关联主播、开始/结束时间（本地时区）、X/Y/Z、开播方式（线下）、直属运营等
- 获取某主播的关联通告：GET `/battle-records/api/related-announcements?pilot_id=<id>`
  - 返回：昨天/今天/明天范围内的通告列表，带“YYYY-MM-DD 星期M N小时 @X-Y-Z”标签
- 获取开播记录变更记录：GET `/battle-records/<record_id>/changes`
  - 返回：最近100条变更记录（时间、操作者、字段、前后值、IP）

## 与通告的联动
- 选中“关联通告”时：
  - 预填开始/结束时间（按通告时间转换到UI时区显示）。
  - 开播方式设定为线下。
  - 预填X/Y/Z快照（从通告当时数据复制，而非当前实时开播地点）。
  - 允许用户在保存前进行必要调整。
- 不建立强绑定的级联更新：通告后续变动不回写已登记开播记录。

## 非目标
- 不支持批量（循环）登记。
- 不提供日历视图（如需，另行设计）。

## 空状态与错误
- 空列表时展示友好的空状态提示与“登记开播记录”快速入口。
- 数据加载失败时提供清晰的错误信息与重试入口。
