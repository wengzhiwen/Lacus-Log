{% extends "base.html" %}

{% block title %}主播业绩 - Lacus-Log{% endblock %}

{% block content %}
<div class="page-header">
  <div class="header-content">
    <div class="back-nav" id="back-nav">
      <!-- 返回按钮将通过JavaScript动态生成 -->
    </div>
    <h1 class="page-title">🎤 <span id="pilot-nickname">加载中...</span> 业绩</h1>
  </div>
</div>

<div class="pilot-header">
  <div class="pilot-basic-info">
    <div class="pilot-name">
      <a href="#" id="pilot-detail-link"><span id="pilot-nickname-link">-</span></a>
      <span id="pilot-real-name" style="display: none;">（<span id="pilot-real-name-value"></span>）</span>
    </div>
    <div class="pilot-details">
      <span class="age-gender"><span id="pilot-age">-</span>岁<span id="pilot-gender-icon">-</span></span>
      <span class="hometown" id="pilot-hometown" style="display: none;"><span id="pilot-hometown-value"></span></span>
      <span class="owner-rank">直属运营：<span id="pilot-owner">-</span> <br />
        主播分类：<span id="pilot-rank">-</span> <br />
        主播状态：<span id="pilot-status">-</span></span>
    </div>
  </div>
</div>

<div class="loading-state" id="loading-state">
  <div class="loading-spinner"></div>
  <div class="loading-text">正在加载业绩数据...</div>
</div>

<div class="error-state" id="error-state" style="display: none;">
  <div class="error-icon">❌</div>
  <div class="error-text">加载业绩数据失败</div>
  <button class="btn btn-primary" onclick="loadPerformanceData()">重试</button>
</div>

<div class="stats-section" id="stats-section" style="display: none;">
  <div class="summary-section">
    <h2 class="section-title">本月统计（全月 / 月初至报表日）</h2>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-label">开播记录数</div>
        <div class="card-value" id="month-record-count">-</div>
      </div>
      <div class="summary-card" id="month-hours-card">
        <div class="card-label">开播时数</div>
        <div class="card-value" id="month-total-hours">-h</div>
        <div class="card-sub" id="month-avg-hours">-h/记录</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计流水</div>
        <div class="card-value" id="month-total-revenue">¥-</div>
        <div class="card-sub" id="month-daily-avg-revenue">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计底薪</div>
        <div class="card-value" id="month-total-basepay">¥-</div>
        <div class="card-sub" id="month-daily-avg-basepay">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计返点</div>
        <div class="card-value" id="month-total-rebate">¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计公司分成</div>
        <div class="card-value" id="month-total-company-share">¥-</div>
      </div>
      <div class="summary-card" id="month-operating-profit-card">
        <div class="card-label">运营利润估算</div>
        <div class="card-value" id="month-operating-profit">¥-</div>
        <div class="card-sub" id="month-daily-avg-operating-profit">日均¥-</div>
      </div>
    </div>
  </div>

  <div class="stats-notice">
    <div class="notice-content">
      <div class="notice-icon">ℹ️</div>
      <div class="notice-text">
        所有日均数据的分母为开播记录数（并非进行分日计算）。<br />近n日为最近的n条开播记录（并非自然日）。
      </div>
    </div>
  </div>

  <div class="summary-section">
    <h2 class="section-title">近7日统计</h2>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-label">开播记录数</div>
        <div class="card-value" id="week-record-count">-</div>
      </div>
      <div class="summary-card" id="week-hours-card">
        <div class="card-label">开播时数</div>
        <div class="card-value" id="week-total-hours">-h</div>
        <div class="card-sub" id="week-avg-hours">-h/记录</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计流水</div>
        <div class="card-value" id="week-total-revenue">¥-</div>
        <div class="card-sub" id="week-daily-avg-revenue">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计底薪</div>
        <div class="card-value" id="week-total-basepay">¥-</div>
        <div class="card-sub" id="week-daily-avg-basepay">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计返点</div>
        <div class="card-value" id="week-total-rebate">¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计公司分成</div>
        <div class="card-value" id="week-total-company-share">¥-</div>
      </div>
      <div class="summary-card" id="week-operating-profit-card">
        <div class="card-label">近日盈亏（不计返点）</div>
        <div class="card-value" id="week-operating-profit">¥-</div>
        <div class="card-sub" id="week-daily-avg-operating-profit">日均¥-</div>
      </div>
    </div>
  </div>

  <div class="summary-section">
    <h2 class="section-title">近3日统计</h2>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-label">开播记录数</div>
        <div class="card-value" id="three-day-record-count">-</div>
      </div>
      <div class="summary-card" id="three-day-hours-card">
        <div class="card-label">开播时数</div>
        <div class="card-value" id="three-day-total-hours">-h</div>
        <div class="card-sub" id="three-day-avg-hours">-h/记录</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计流水</div>
        <div class="card-value" id="three-day-total-revenue">¥-</div>
        <div class="card-sub" id="three-day-daily-avg-revenue">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计底薪</div>
        <div class="card-value" id="three-day-total-basepay">¥-</div>
        <div class="card-sub" id="three-day-daily-avg-basepay">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计返点</div>
        <div class="card-value" id="three-day-total-rebate">¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计公司分成</div>
        <div class="card-value" id="three-day-total-company-share">¥-</div>
      </div>
      <div class="summary-card" id="three-day-operating-profit-card">
        <div class="card-label">近日盈亏（不计返点）</div>
        <div class="card-value" id="three-day-operating-profit">¥-</div>
        <div class="card-sub" id="three-day-daily-avg-operating-profit">日均¥-</div>
      </div>
    </div>
  </div>
</div>

<div class="summary-section" id="recent-records-section" style="display: none;">
  <h2 class="section-title">最近开播记录</h2>
  <div class="record-cards" id="recent-records-container">
    <!-- 记录将通过JavaScript动态加载 -->
  </div>
</div>

<style>

.page-header {
  margin-bottom: 20px;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 16px;
}


.back-nav {
  flex-shrink: 0;
}

.back-nav .btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  color: #495057;
  text-decoration: none;
  font-size: 14px;
  transition: all 0.2s ease;
}

.back-nav .btn:hover {
  background: #e9ecef;
  border-color: #adb5bd;
  color: #343a40;
}

.back-nav .btn span {
  font-size: 16px;
  font-weight: bold;
}


.page-title {
  margin: 0;
  flex: 1;
}


.pilot-header {
  background: #fff;
  border-radius: 8px;
  padding: 16px 20px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
}

.pilot-basic-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.pilot-name {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.pilot-name a {
  color: var(--brand);
  text-decoration: underline;
}

.pilot-name a:hover {
  text-decoration: underline;
}

.pilot-details {
  display: flex;
  gap: 12px;
  font-size: 14px;
  color: var(--muted);
}

.age-gender {
  font-weight: 600;
}

.hometown::before {
  content: "· ";
}

.owner-rank::before {
  content: " ";
}


.stats-section {
  margin-bottom: 30px;
}


.stats-notice {
  background: #e3f2fd;
  border: 1px solid #bbdefb;
  border-radius: 8px;
  padding: 12px 16px;
  margin: 20px 0;
}

.notice-content {
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.notice-icon {
  font-size: 16px;
  flex-shrink: 0;
  margin-top: 1px;
}

.notice-text {
  font-size: 14px;
  color: #1976d2;
  line-height: 1.4;
  font-weight: 500;
}

.summary-section {
  margin: 24px 0;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.summary-card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  transition: box-shadow 0.2s ease;
}

.summary-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.summary-card.negative-value {
  border-color: #f44336;
}

.summary-card.negative-value:hover {
  box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);
}

.card-label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}

.card-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--brand);
}

.card-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}


.record-cards {
  padding: 0;
}

.record-card {
  display: block;
  background: #fff;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
  text-decoration: none;
  color: inherit;
  transition: all 0.2s ease;
  cursor: pointer;
}

.record-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transform: translateY(-2px);
  border-color: var(--brand);
}

.record-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.record-time {
  flex: 0 0 auto;
}

.start-time {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 2px;
}

.duration {
  font-size: 12px;
  color: var(--muted);
}

.record-info {
  flex: 1;
  text-align: right;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}

.pilot-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  line-height: 1.2;
  margin-bottom: 2px;
}

.meta-line {
  font-size: 12px;
  color: var(--muted);
  line-height: 1.1;
}

.record-card .card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-top: 1px solid var(--table-header);
  padding-top: 12px;
}

.revenue {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.amount {
  font-size: 16px;
  font-weight: 600;
  color: var(--hud-green);
}

.base-salary {
  font-size: 12px;
  color: var(--muted);
}

.card-arrow {
  font-size: 18px;
  color: var(--muted);
  transition: color 0.2s ease;
}

.record-card:hover .card-arrow {
  color: var(--brand);
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.empty-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
}


@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .page-title {
    font-size: 20px;
  }
  
  .pilot-details {
    flex-direction: column;
    gap: 4px;
  }
  
  .stats-notice {
    padding: 10px 12px;
    margin: 16px 0;
  }
  
  .notice-text {
    font-size: 13px;
  }
  
  .summary-cards {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }
  
  .summary-card {
    padding: 12px;
  }
  
  .card-value {
    font-size: 20px;
  }
  
  .record-cards {
    padding: 0;
  }
  
  .record-card .card-header {
    flex-direction: row;
    align-items: flex-start;
    gap: 8px;
  }
  
  .record-info {
    text-align: right;
    align-items: flex-end;
  }
}

.error-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.error-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.error-text {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
}

.error-state .btn {
  margin-top: 16px;
}
</style>

<script>
// 主播业绩页面JavaScript - 完全REST化版本
// 从URL中获取pilot_id
const urlParts = window.location.pathname.split('/');
const pilotId = urlParts[urlParts.indexOf('pilots') + 1];

// 从URL参数获取来源信息
const urlParams = new URLSearchParams(window.location.search);
const fromParam = urlParams.get('from');
const dateParam = urlParams.get('date');
const ownerParam = urlParams.get('owner');
const monthParam = urlParams.get('month');
const recordIdParam = urlParams.get('record_id');

// 格式化金额
function formatCurrency(amount) {
  if (amount === null || amount === undefined || Number.isNaN(Number(amount))) {
    return '¥0.00';
  }
  const numeric = Number(amount);
  return '¥' + numeric.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// 格式化时间
function formatDateTime(dateTimeStr) {
  if (!dateTimeStr) return '未知';
  const date = new Date(dateTimeStr);
  if (Number.isNaN(date.getTime())) {
    return '未知';
  }
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${month}月${day}日 ${hours}:${minutes}`;
}

// 规范化主播分类显示
function normalizeRank(value) {
  const mapping = {
    '候补机师': '候选人',
    '训练机师': '试播主播',
    '实习机师': '实习主播',
    '正式机师': '正式主播'
  };
  return mapping[value] || value;
}

// 规范化主播状态显示
function normalizeStatus(value) {
  const mapping = {
    '未征召': '未招募',
    '不征召': '不招募',
    '已征召': '已招募',
    '已签约': '已签约',
    '已阵亡': '流失'
  };
  return mapping[value] || value;
}

// 生成返回按钮
function generateBackButton() {
  const backNav = document.getElementById('back-nav');
  let backHtml = '';
  
  if (fromParam === 'daily_report' && dateParam && ownerParam) {
    backHtml = `<a class="btn btn-secondary" href="/reports/daily?date=${dateParam}&owner=${ownerParam}">
      <span>←</span> 返回
    </a>`;
  } else if (fromParam === 'monthly_report' && monthParam) {
    backHtml = `<a class="btn btn-secondary" href="/reports/monthly?month=${monthParam}">
      <span>←</span> 返回
    </a>`;
  } else if (fromParam === 'pilot_detail') {
    backHtml = `<a class="btn btn-secondary" href="/pilots/${pilotId}">
      <span>←</span> 返回
    </a>`;
  } else if (fromParam === 'battle_record_detail' && recordIdParam) {
    backHtml = `<a class="btn btn-secondary" href="/battle-records/${recordIdParam}">
      <span>←</span> 返回
    </a>`;
  } else {
    backHtml = `<a class="btn btn-secondary" href="/pilots/">
      <span>←</span> 返回
    </a>`;
  }
  
  backNav.innerHTML = backHtml;
}

// 更新主播基本信息
function updatePilotInfo(pilotInfo) {
  // 更新所有昵称显示
  const nicknameElements = document.querySelectorAll('#pilot-nickname, #pilot-nickname-link');
  nicknameElements.forEach(el => el.textContent = pilotInfo.nickname);
  
  // 更新详情页链接
  const detailLink = document.getElementById('pilot-detail-link');
  detailLink.href = `/pilots/${pilotId}?from=performance`;
  
  // 更新真实姓名
  if (pilotInfo.real_name) {
    document.getElementById('pilot-real-name-value').textContent = pilotInfo.real_name;
    document.getElementById('pilot-real-name').style.display = 'inline';
  }
  
  // 更新年龄和性别图标
  document.getElementById('pilot-age').textContent = pilotInfo.age || '-';
  document.getElementById('pilot-gender-icon').textContent = pilotInfo.gender_icon || '?';
  
  // 更新籍贯
  if (pilotInfo.hometown) {
    document.getElementById('pilot-hometown-value').textContent = pilotInfo.hometown;
    document.getElementById('pilot-hometown').style.display = 'inline';
  }
  
  // 更新直属运营
  document.getElementById('pilot-owner').textContent = pilotInfo.owner || '未知';
  
  // 更新主播分类和状态（应用规范化）
  document.getElementById('pilot-rank').textContent = normalizeRank(pilotInfo.rank || '-');
  document.getElementById('pilot-status').textContent = normalizeStatus(pilotInfo.status || '-');
}

// 更新统计卡片
function updateStatsCard(prefix, stats) {
  if (!stats) {
    console.error(`统计数据缺失: ${prefix}`);
    return;
  }
  try {
    document.getElementById(`${prefix}-record-count`).textContent = stats.record_count;
    document.getElementById(`${prefix}-total-hours`).textContent = Number(stats.total_hours).toFixed(1) + 'h';
    document.getElementById(`${prefix}-avg-hours`).textContent = Number(stats.avg_hours).toFixed(1) + 'h/记录';
    document.getElementById(`${prefix}-total-revenue`).textContent = formatCurrency(stats.total_revenue);
    document.getElementById(`${prefix}-daily-avg-revenue`).textContent = '日均' + formatCurrency(stats.daily_avg_revenue);
    document.getElementById(`${prefix}-total-basepay`).textContent = formatCurrency(stats.total_basepay);
    document.getElementById(`${prefix}-daily-avg-basepay`).textContent = '日均' + formatCurrency(stats.daily_avg_basepay);
    document.getElementById(`${prefix}-total-rebate`).textContent = formatCurrency(stats.total_rebate);
    document.getElementById(`${prefix}-total-company-share`).textContent = formatCurrency(stats.total_company_share);
    document.getElementById(`${prefix}-operating-profit`).textContent = formatCurrency(stats.operating_profit);
    document.getElementById(`${prefix}-daily-avg-operating-profit`).textContent = '日均' + formatCurrency(stats.daily_avg_operating_profit);
    
    // 设置负值样式
    const hoursCard = document.getElementById(`${prefix}-hours-card`);
    const profitCard = document.getElementById(`${prefix}-operating-profit-card`);
    
    if (hoursCard && stats.avg_hours < 7 && stats.operating_profit < 0) {
      hoursCard.classList.add('negative-value');
    }
    if (profitCard && stats.operating_profit < 0) {
      profitCard.classList.add('negative-value');
    }
  } catch (error) {
    console.error(`更新统计卡片失败 (${prefix}):`, error);
    console.error('stats:', stats);
  }
}

// 渲染最近开播记录
function renderRecentRecords(records, pilotInfo) {
  const container = document.getElementById('recent-records-container');
  
  if (!records || records.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">📊</div>
        <div class="empty-title">暂无开播记录</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = records.map(record => `
    <a href="/battle-records/${record.id}" class="record-card">
      <div class="card-header">
        <div class="record-time">
          <div class="start-time">${formatDateTime(record.start_time)}</div>
          <div class="duration">${Number(record.duration_hours).toFixed(1)}小时</div>
        </div>
        <div class="record-info">
          <div class="pilot-name">${pilotInfo.nickname}${pilotInfo.real_name ? '（' + pilotInfo.real_name + '）' : ''}</div>
          <div class="meta-line">[${pilotInfo.owner || '未知'}][${pilotInfo.rank || '未知'}]</div>
        </div>
      </div>
      <div class="card-footer">
        <div class="revenue">
          <span class="amount">${formatCurrency(record.revenue_amount)}</span>
          ${record.base_salary > 0 ? `<span class="base-salary">底薪${formatCurrency(record.base_salary)}</span>` : ''}
        </div>
        <div class="card-arrow">→</div>
      </div>
    </a>
  `).join('');
}

// 加载业绩数据
async function loadPerformanceData() {
  try {
    // 显示加载状态
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('error-state').style.display = 'none';
    document.getElementById('stats-section').style.display = 'none';
    document.getElementById('recent-records-section').style.display = 'none';
    
    const response = await fetch(`/api/pilots/${pilotId}/performance`);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || '获取数据失败');
    }
    
    const data = result.data;
    
    // 更新主播基本信息
    updatePilotInfo(data.pilot_info);
    
    // 先显示内容区域，再更新数据
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('stats-section').style.display = 'block';
    document.getElementById('recent-records-section').style.display = 'block';
    
    // 更新统计数据
    console.log('开始更新统计数据...');
    console.log('month_stats:', data.month_stats);
    console.log('week_stats:', data.week_stats);
    console.log('three_day_stats:', data.three_day_stats);
    
    updateStatsCard('month', data.month_stats);
    updateStatsCard('week', data.week_stats);
    updateStatsCard('three-day', data.three_day_stats);
    
    // 渲染最近开播记录
    renderRecentRecords(data.recent_records, data.pilot_info);
    
  } catch (error) {
    console.error('加载业绩数据失败:', error);
    
    // 显示错误状态
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'block';
    document.getElementById('stats-section').style.display = 'none';
    document.getElementById('recent-records-section').style.display = 'none';
  }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
  // 生成返回按钮
  generateBackButton();
  
  // 加载业绩数据
  loadPerformanceData();
});
</script>
{% endblock %}
