# 主播-招募日报（原“机师-征召日报”）

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；征召→招募；训练→试播；正式机师→正式主播；实习机师→实习主播；作战计划→通告；作战记录→开播记录；作战日报→开播日报；预约训练→预约试播；待训练→待试播；训练征召→试播招募；训练决策→试播决策。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。
主播招募日报是一个独立的日报表功能，用于统计和分析主播招募流程的各项指标。该功能提供日视图报表，帮助管理者了解招募工作的进展情况和效率。

## 重要约定

- 数据库存储的所有日期时间均为UTC；界面显示与输入均为GMT+8，必须严格遵守。
- 报表数据基于数据库中距报表日14天（含报表日）的数据，确保每天的报表都不同。
- 不使用缓存机制，确保数据的实时性，但可以在数据库中追加比较的索引。
- 时间口径：所有时间计算均基于GMT+8本地时间进行日期归属。

## 功能概述

### 入口与导航
- 在主菜单中新增"主播招募日报"入口，位置在"主播招募"的后面（文件名与路由可保留历史命名）。
- 默认进入日视图，显示当前日期的报表数据。
- 支持前后翻页查看不同日期的报表。
- 支持按招募负责人筛选，默认显示全部数据。

### 视图设计
- **日视图**：参考《主播-通告日历》的日视图设计风格，保持UI一致性。
- **默认日期**：进入时默认显示当前日期（GMT+8）。
- **日期导航**：支持前一日/后一日翻页，可直接选择日期。
- **负责人筛选**：支持按招募负责人筛选，可选择全部、管理员或特定运营。

## 报表内容

### 统计指标
报表包含以下四个核心指标：

| 指标 | 说明 |
|------|------|
| 约面 | 当天创建的招募数量 |
| 到面 | 当天发生的面试决策数量（完成面试决策的数量，不论决策结果） |
| 试播 | 当天发生的开播决策数量（完成试播决策的数量，不论决策结果） |
| 新开播 | 当天在开播决策中决定招募（招募为正式或实习主播）的数量（不招募不算） |

### 报表结构
报表采用三层统计结构：

```
统计范围，约面，到面，试播，新开播
报表日，0，0，0，0
近7日，0，0，0，0
近14日，0，0，0，0
```

- **报表日**：仅统计选定日期的数据
- **近7日**：统计选定日期前7天（含选定日期）的累计数据
- **近14日**：统计选定日期前14天（含选定日期）的累计数据

### 日均数据显示
- **报表日行**：不显示日均数据（仅显示单日数据）
- **近7日行**：每个数据下方显示灰色小字日均数据，表示近7日总数除以7的平均值，并显示趋势指示器
  - 7日均 > 14日均：显示红色上升箭头 ↑
  - 7日均 ≤ 14日均：显示绿色下降箭头 ↓（带绿色泛光呼吸效果）
- **近14日行**：每个数据下方显示灰色小字日均数据，表示近14日总数除以14的平均值
- **日均计算**：保留1位小数，便于用户直观对比不同时期的日均表现

## 数据计算规则

### 约面（当天创建的招募数量）
- 数据来源：`Recruit` 模型的 `created_at` 字段
- 计算规则：统计 `created_at` 转换为GMT+8后日期等于报表日的招募记录数量
- 包含所有状态的招募记录

### 到面（当天发生的面试决策数量）
- 数据来源：`Recruit` 模型的 `interview_decision_time` 字段（新六步制）或 `training_decision_time_old` 字段（历史兼容）
- 计算规则：统计 `interview_decision_time` 转换为GMT+8后日期等于报表日的招募记录数量
- 包含所有面试决策（预约试播/不招募）
- 历史数据兼容：对于历史数据，使用 `training_decision_time_old` 字段进行统计

### 试播（当天发生的试播决策数量）
- 数据来源：`Recruit` 模型的 `training_decision_time` 字段（新六步制）或 `training_decision_time_old` 字段（历史兼容）
- 计算规则：统计 `training_decision_time` 转换为GMT+8后日期等于报表日的招募记录数量
- 包含所有试播决策（预约开播/不招募）
- 历史数据兼容：对于历史数据，使用 `training_decision_time_old` 字段进行统计

### 新开播（当天在开播决策中决定招募的数量）
- 数据来源：`Recruit` 模型的 `broadcast_decision_time` 和 `broadcast_decision` 字段（新六步制）或 `final_decision_time` 和 `final_decision` 字段（历史兼容）
- 计算规则：统计 `broadcast_decision_time` 转换为GMT+8后日期等于报表日且 `broadcast_decision` 为"正式主播"或"实习主播"的招募记录数量
- 不包含"不招募"的决策
- 历史数据兼容：对于历史数据，使用 `final_decision_time` 和 `final_decision` 字段进行统计

### 时间范围计算
- **近7日**：将最近7天的数据累加
- **近14日**：将最近14天的数据累加
- 所有时间计算均基于GMT+8本地时间进行日期归属

## 接口设计（后端）

### 主要接口
- **GET** `/recruit-reports/daily?date=YYYY-MM-DD&recruiter=all|user_id`
  - 入参：
    - `date`（可选），本地日期（GMT+8）；不传则取今日
    - `recruiter`（可选），招募负责人筛选；不传或为"all"则显示全部数据
  - 出参：
    ```json
    {
      "report_date": "2025-01-13",
      "prev_date": "2025-01-12", 
      "next_date": "2025-01-14",
      "statistics": {
        "report_day": {
          "appointments": 0,
          "interviews": 0, 
          "trials": 0,
          "new_recruits": 0
        },
        "last_7_days": {
          "appointments": 0,
          "interviews": 0,
          "trials": 0, 
          "new_recruits": 0
        },
        "last_14_days": {
          "appointments": 0,
          "interviews": 0,
          "trials": 0,
          "new_recruits": 0
        }
      }
    }
    ```

### 实现要点
- 使用 `utils/timezone_helper.py` 进行UTC↔本地的统一转换
- 查询范围一律以"时间字段换算到本地日"的归属进行聚合与过滤
- 确保数据计算的准确性和一致性
- **招募负责人筛选**：根据 `recruiter` 参数筛选招募记录，支持全部、管理员或特定运营
- **历史数据兼容性**：系统需要同时支持新六步制字段和历史废弃字段的查询
  - 到面统计：优先使用 `interview_decision_time`，降级使用 `training_decision_time_old`
  - 试播统计：优先使用 `broadcast_decision_time`，降级使用 `final_decision_time`
  - 新开播统计：优先使用 `broadcast_decision_time` 和 `broadcast_decision`，降级使用 `final_decision_time` 和 `final_decision`
- **字段映射策略**：使用 `Recruit` 模型的 `get_effective_*` 方法进行字段降级读取

## 模板与交互（前端）

### 页面结构
- **模板文件**：`templates/recruit_reports/daily.html`
- **页面标题**：主播招募日报
- **日期导航**：顶部日期选择器，左右切换按钮（前一日/后一日）
- **负责人筛选**：顶部负责人选择器，支持全部、管理员或特定运营

### UI设计
- **设计风格**：参考《主播-通告日历》的日视图设计，保持UI一致性
- **布局结构**：
  - 顶部：日期导航区域和负责人筛选区域
  - 中部：统计表格区域
  - 底部：操作按钮区域（如需要）

### 统计表格
- **表格格式**：采用清晰的表格布局展示统计数据
- **列标题**：统计范围、约面、到面、试播、新开播
- **行数据**：报表日、近7日、近14日
- **数据展示**：数字格式，右对齐显示

### 交互功能
- **日期切换**：支持前一日/后一日翻页
- **日期选择**：支持直接选择特定日期
- **负责人筛选**：支持按招募负责人筛选数据
- **响应式设计**：移动端优化，支持触摸操作

## 权限控制

- **管理员**：拥有完整权限，可以查看所有招募日报数据
- **运营**：拥有完整权限，可以查看所有招募日报数据
- **其他角色**：遵循项目统一的权限策略

## 技术实现要点

### 数据查询优化
- **索引建议**：为 `Recruit` 模型添加以下复合索引：
  - `-created_at` 降序索引（用于约面统计）
  - `interview_decision` 索引（用于面试决策查询）
  - `training_decision` 索引（用于试播决策查询）
  - `broadcast_decision` 索引（用于开播决策查询）
  - `-scheduled_training_time` 降序索引（用于试播预约时间查询）
  - `-scheduled_broadcast_time` 降序索引（用于开播预约时间查询）
  - **缺失的重要索引**：
    - `-interview_decision_time` 降序索引（用于到面统计，新六步制）
    - `-broadcast_decision_time` 降序索引（用于试播和新开播统计，新六步制）
    - `-training_decision_time` 降序索引（用于试播决策时间查询）
    - `-scheduled_training_decision_time` 降序索引（用于预约试播决策时间查询）
    - `-scheduled_broadcast_decision_time` 降序索引（用于预约开播决策时间查询）
  - `training_decision_old` 索引（用于到面统计，历史兼容）
  - `final_decision` 索引（用于试播和新开播统计，历史兼容）
  - `-training_time` 降序索引（用于历史试播时间查询）
  - `-training_decision_time_old` 降序索引（用于历史试播招募决策时间查询）
  - `-final_decision_time` 降序索引（用于历史结束招募决策时间查询）
- **查询优化**：使用聚合查询减少数据库访问次数
- **时间处理**：统一使用 `utils/timezone_helper.py` 的转换方法
- **历史数据兼容**：实现字段降级读取机制，确保新旧数据都能正确统计

### 性能考虑
- **实时数据**：不使用缓存，确保数据的实时性
- **索引优化**：在数据库中追加必要的索引以提升查询性能
- **查询范围**：合理控制查询范围，避免全表扫描

### 历史数据兼容性处理
- **字段降级读取**：使用 `Recruit` 模型的 `get_effective_*` 方法进行字段降级读取
  - `get_effective_interview_decision_time()`：优先使用 `interview_decision_time`，降级使用 `training_decision_time_old`
  - `get_effective_broadcast_decision_time()`：优先使用 `broadcast_decision_time`，降级使用 `final_decision_time`
  - `get_effective_broadcast_decision()`：优先使用 `broadcast_decision`，降级使用 `final_decision`
- **查询策略**：在统计查询中使用降级读取方法，确保历史数据和新数据都能正确统计
- **数据迁移**：建议在系统升级时运行数据迁移脚本，将废弃字段数据迁移到新字段
- **兼容性保证**：确保新旧数据在同一报表中的一致显示和统计

### 错误处理
- **空状态**：无数据时显示友好的空状态提示
- **错误提示**：数据加载失败时提供清晰的错误信息
- **降级处理**：在部分功能不可用时提供降级方案

## 用户体验设计

### 视觉一致性
- **配色方案**：遵循项目统一的ZAFT红配色方案
- **字体规范**：使用项目统一的字体和字号
- **图标系统**：使用一致的图标和视觉元素

### 交互反馈
- **悬停效果**：提供清晰的悬停状态反馈
- **点击反馈**：点击操作提供即时的视觉反馈
- **加载状态**：数据加载时显示适当的加载指示器

### 移动端优化
- **触摸优化**：所有交互都针对触摸操作优化
- **响应式布局**：适配不同屏幕尺寸
- **卡片式设计**：与现有模块保持一致的卡片式设计风格

## 日报详情页面

### 功能概述

招募日报详情页面提供对报表中每个数据单元格的详细查看功能。用户点击报表中的任意数据单元格后，可以进入对应的详情页面，查看该数据所包含的具体招募记录列表。

### 入口与导航

- **入口**：在招募日报的统计表格中，每个数据单元格都支持点击
- **跳转**：点击单元格后跳转到对应的详情页面
- **返回**：详情页面提供返回按钮，返回到招募日报页面

### 页面设计

#### 页面头部
- **标题格式**：`{日期} {统计范围} {指标名称}：{数值}`（全部时）或 `{日期} {统计范围} {指标名称}（{招募负责人}）：{数值}`（筛选时）
- **示例**：`2025年9月27日 近7日 约面：4` 或 `2025年9月27日 近7日 约面（张三）：4`
- **信息展示**：
  - 日期：报表统计的日期（GMT+8格式）
  - 统计范围：报表日 / 近7日 / 近14日
  - 指标名称：约面 / 到面 / 试播 / 新开播
  - 招募负责人：筛选时显示负责人信息
  - 数值：对应的统计数据

#### 内容区域
- **列表格式**：采用与招募模块招募列表完全相同的格式和样式
- **数据展示**：显示该统计指标对应的具体招募记录
- **状态显示**：每条招募信息的状态等数据以招募信息在展示时的实际情况呈现
- **主播信息显示**：同时显示主播昵称和真实姓名（如有），与招募列表保持一致
- **交互功能**：点击任意招募记录可跳转到该招募的详情页面

### 数据反推规则

#### 约面详情
- **数据来源**：`Recruit` 模型的 `created_at` 字段
- **反推规则**：
  - 报表日：`created_at` 转换为GMT+8后日期等于报表日的记录
  - 近7日：`created_at` 转换为GMT+8后日期在报表日前7天（含报表日）的记录
  - 近14日：`created_at` 转换为GMT+8后日期在报表日前14天（含报表日）的记录
- **排序**：按 `created_at` 降序排列（最新的在前）

#### 到面详情
- **数据来源**：`Recruit` 模型的 `interview_decision_time` 字段（新六步制）或 `training_decision_time_old` 字段（历史兼容）
- **反推规则**：
  - 报表日：`interview_decision_time` 转换为GMT+8后日期等于报表日的记录
  - 近7日：`interview_decision_time` 转换为GMT+8后日期在报表日前7天（含报表日）的记录
  - 近14日：`interview_decision_time` 转换为GMT+8后日期在报表日前14天（含报表日）的记录
- **排序**：按 `interview_decision_time` 降序排列（最新的在前）
- **历史兼容**：对于历史数据，使用 `training_decision_time_old` 字段进行统计

#### 试播详情
- **数据来源**：`Recruit` 模型的 `training_decision_time` 字段（新六步制）或 `training_decision_time_old` 字段（历史兼容）
- **反推规则**：
  - 报表日：`training_decision_time` 转换为GMT+8后日期等于报表日的记录
  - 近7日：`training_decision_time` 转换为GMT+8后日期在报表日前7天（含报表日）的记录
  - 近14日：`training_decision_time` 转换为GMT+8后日期在报表日前14天（含报表日）的记录
- **排序**：按 `training_decision_time` 降序排列（最新的在前）
- **历史兼容**：对于历史数据，使用 `training_decision_time_old` 字段进行统计

#### 新开播详情
- **数据来源**：`Recruit` 模型的 `broadcast_decision_time` 和 `broadcast_decision` 字段（新六步制）或 `final_decision_time` 和 `final_decision` 字段（历史兼容）
- **反推规则**：
  - 报表日：`broadcast_decision_time` 转换为GMT+8后日期等于报表日且 `broadcast_decision` 为"正式主播"或"实习主播"的记录
  - 近7日：`broadcast_decision_time` 转换为GMT+8后日期在报表日前7天（含报表日）且 `broadcast_decision` 为"正式主播"或"实习主播"的记录
  - 近14日：`broadcast_decision_time` 转换为GMT+8后日期在报表日前14天（含报表日）且 `broadcast_decision` 为"正式主播"或"实习主播"的记录
- **排序**：按 `broadcast_decision_time` 降序排列（最新的在前）
- **历史兼容**：对于历史数据，使用 `final_decision_time` 和 `final_decision` 字段进行统计

### 接口设计

#### 详情页面接口
- **GET** `/recruit-reports/daily/detail?date=YYYY-MM-DD&range={report_day|last_7_days|last_14_days}&metric={appointments|interviews|trials|new_recruits}&recruiter=all|user_id`
  - 入参：
    - `date`：报表日期（GMT+8格式）
    - `range`：统计范围（report_day / last_7_days / last_14_days）
    - `metric`：指标类型（appointments / interviews / trials / new_recruits）
    - `recruiter`：招募负责人筛选（all / user_id）
  - 出参：
    ```json
    {
      "page_title": "2025年9月27日 近7日 约面：4",
      "report_date": "2025-09-27",
      "range": "last_7_days",
      "metric": "appointments",
      "count": 4,
      "recruits": [
        {
          "id": "recruit_id_1",
          "pilot": {
            "id": "pilot_id_1",
            "nickname": "主播昵称",
            "real_name": "真实姓名"
          },
          "recruiter": {
            "id": "user_id_1",
            "nickname": "运营昵称"
          },
          "created_at": "2025-09-27T08:00:00Z",
          "status": "待面试",
          "appointment_time": "2025-09-28T08:00:00Z",
          "channel": "BOSS",
          "introduction_fee": 1000.00,
          "remark": "备注信息"
        }
      ]
    }
    ```

### 技术实现要点

#### 数据查询优化
- **索引利用**：充分利用现有的复合索引进行高效查询
- **时间转换**：统一使用 `utils/timezone_helper.py` 进行UTC↔本地的转换
- **历史兼容**：使用 `Recruit` 模型的 `get_effective_*` 方法进行字段降级读取
- **查询范围**：根据统计范围动态调整查询的时间范围

#### 性能考虑
- **实时数据**：不使用缓存，确保数据的实时性
- **分页处理**：不分页，数据量不会大
- **查询优化**：使用聚合查询减少数据库访问次数，需要时追加必要的索引

#### 错误处理
- **空状态**：无数据时显示友好的空状态提示
- **错误提示**：数据加载失败时提供清晰的错误信息
- **参数验证**：对入参进行严格验证，确保查询的准确性

### 用户体验设计

#### 视觉一致性
- **设计风格**：与招募列表页面保持完全一致的设计风格
- **卡片样式**：使用相同的卡片布局和交互效果
- **状态显示**：招募状态的颜色和样式与招募列表保持一致

#### 交互反馈
- **点击反馈**：点击招募记录提供即时的视觉反馈
- **加载状态**：数据加载时显示适当的加载指示器
- **返回导航**：提供清晰的返回路径和导航提示


## 总结

主播招募日报功能通过提供直观的日视图报表，帮助管理者了解招募工作的进展情况和效率。该功能严格遵循项目的时间处理规范和权限控制机制，确保与现有系统的良好集成。

通过统计约面、到面、试播、新开播四个核心指标，并提供报表日、近7日、近14日三个时间维度的数据，为招募工作的管理和优化提供了有力的数据支持。

新增的日报详情页面功能进一步增强了报表的可用性，用户可以通过点击任意数据单元格查看对应的具体招募记录，实现了从宏观统计到微观详情的无缝衔接，为招募工作的精细化管理提供了强有力的工具支持。
