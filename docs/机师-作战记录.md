# 机师-作战记录

机师-作战记录用于登记机师（主播）一次实际参与作战（直播）的结果数据。其结构与《机师-作战计划》高度相似：有列表页与详情页，支持新建、编辑、删除，但不支持批量（循环）操作。

本模块内部统一使用“主播”“通告”两词，避免与“作战计划”混淆。

## 重要约定

数据库中存放的所有日期时间都是UTC，界面上的输入和显示都是GMT+8，必须严格遵守。

## 元数据

| 字段 | 说明 | 参考类型 | 设定 |
|---------|------|------|------|
| ID | 系统内部唯一编码，用户不可见 | 由技术设计 | 必须 唯一 |
| 主播 | 本次参战的机师 | 关联到机师唯一ID | 必须 |
| 关联通告 | 若从通告生成或挂接的通告 | 关联到通告唯一ID | 非必须 |
| 开始时间 | 本次开播的开始时间 | 时间戳UTC | 必须 |
| 结束时间 | 本次开播的结束时间 | 时间戳UTC | 必须，结束≥开始 |
| 流水金额 | 人民币元，两位小数 | 数值 | 必须，默认=0 |
| X坐标 | 作战区域X坐标快照 | 字符串 | 线下必填，线上留空 |
| Y坐标 | 作战区域Y坐标快照 | 字符串 | 线下必填，线上留空 |
| Z坐标 | 作战区域Z坐标快照 | 字符串 | 线下必填，线上留空 |
| 参战形式 | 线上 / 线下 | 枚举 | 必须，默认从主播复制 |
| 底薪金额 | 人民币元，两位小数 | 数值 | 必须，默认=0 |
| 所属 | 从主播复制的所属（舰长）快照 | 关联到用户唯一ID | 必须，仅显示不可编辑 |
| 登记人 | 首次登记的操作人 | 关联到用户唯一ID | 必须，仅显示不可编辑 |
| 备注 | 补充描述 | 字符串 | 非必须，≤200字 |
| 变更记录 | 字段修改日志（时间、操作者、字段、前值、后值、IP） | JSON或技术自定 | 非必须 |
| 创建时间 | 创建本记录的时间 | 时间戳 | 必须，默认=当前UTC |
| 最后修改 | 最近一次修改时间 | 时间戳 | 必须，默认=当前UTC |

### 外部关联与快照
- X/Y/Z坐标为快照，用于回溯展示；作战区域后续修改不会反向影响已登记记录。
- 所属为登记时从主播复制的快照，展示但不可编辑。
- 参战形式默认从主播复制，但允许修改为与主播元数据不同的值。

## 新建与编辑

### 入口
- 模块入口页底部 footbar：按钮“登记作战记录”。
- 通告详情页底部 footbar：按钮“登记作战记录”。点击后应自动带入通告信息以预填。

### 默认值与时间规则
- 开始时间默认：当前时间向前6小时，再“向前取最近的整点或半点”。
- 结束时间默认：当前时间“向前取最近的整点或半点”。
- 所有时间在数据库中以UTC存储；UI显示和输入采用GMT+8（同项目既有约定）。

“向前取最近的整点或半点”定义：给定本地时间 t，若分钟∈(30,59]，则取到 hh:30；若分钟∈[0,30]，则取到 hh:00；若恰为hh:30或hh:00，直接取该时间点。

### 表单要素（最新）
- 主播：编辑页为只读展示，格式为“昵称(年龄)[状态]性别符号”，性别=男♂/女♀/?。
- 所属：只读展示，优先显示舰长/议长的昵称，无昵称时回退到用户名。
- 登记人：只读展示，优先显示昵称，无昵称时回退用户名。
- 作战区域：三联选择 X→Y→Z；“参战形式”移动到“作战区域”分组的首位，并与坐标联动：
  - 参战形式=线上：X/Y/Z不可编辑且必须为空；
  - 参战形式=线下：X/Y/Z为必填。
- 关联通告：编辑页为只读文本，不可修改；显示格式“YYYY-MM-DD 星期M N小时 @X-Y-Z”，无则显示“无关联通告”。
- 金额：流水金额、底薪金额（人民币元，保留两位小数），UI默认值为0。
- 备注：非必须（≤200字）。

### 校验
- 主播不可为空。
- 参战形式为线下时，X/Y/Z坐标不可为空；参战形式为线上时，X/Y/Z应为空且不可编辑。
- 开始时间与结束时间不可为空，且结束时间≥开始时间。
- 金额类字段若填写需为有效数值并保留两位小数。

### 保存逻辑（最新）
- 首次保存写入“登记人”。
- 写入“所属”“参战形式”的快照。
- 写入变更记录（字段、时间、操作者、前后值、IP）。
- 关联通告字段的更新规则：仅当表单中显式提交 `related_announcement` 时才更新；未提交则保持不变；提交空字符串表示清空关联。

## 从不同入口登记的行为

### 1）直接从本模块入口新建
- 页面底部 footbar 点“登记作战记录”。
- 通过三联选择主播，随后可选关联通告；若选了关联通告，则预填绝大部分字段，用户可调整后保存；若不选通告则手动填写所有字段。

### 2）从通告详情页进入
- 点击“登记作战记录”，自动预填：主播、开始/结束时间、X/Y/Z坐标、参战形式、所属。
- 用户可编辑金额、备注及必要修正后保存。

## 列表

### 展示
- 每次取100条，滚动加载更多。
- 开始时间-开播时长（同一行显示，开播时长通过计算获得 格式=0.0小时）、主播昵称[所属]、参战形式、流水金额。
- 点击进入作战记录详情。

### 筛选器
- 所属（默认=自己）
- 阶级
- 主播（格式=主播昵称(年龄)[状态]性别icon，与所属、阶级联动；“已征召/已签约”排前，其他状态排后）
- 时间：今天、近7天（默认=近7天）

筛选器可复合使用，取交集；写入Cookie保存。

### 排序
- 第一排序：开始时间逆序。
- 第二排序：流水金额逆序。

## 详情（最新）
- 展示全部字段；底部 footbar：编辑、删除、变更记录。
- 主播/所属/登记人显示规则与编辑页一致。
- 参战形式显示在“作战区域”分组中；当参战形式为线上时，坐标显示为空。
- 关联通告：按“YYYY-MM-DD 星期M N小时 @X-Y-Z”格式显示，并提供跳转到通告详情的超链接；无则显示“无关联通告”。
- 变更记录弹窗展示最近100条，按时间逆序：变更时间、操作用户、字段、前值、后值、IP。

## 权限
- 议长、舰长：可见与可写（按系统全局权限约定）。
- 其他角色：遵循项目统一的权限策略（由技术实现）。

## 技术实现要点
- 参考《机师-作战计划》的三联选择组件与接口：
  - 在本模块中我对筛选器组件做了一些设计调整，未来可能会应用回《机师-作战计划》等其他模块
  - 作战区域X/Y/Z三联选择及排序逻辑保持一致。
- 时间处理：使用 `utils/timezone_helper.py` 的统一转换方法，确保“数据库UTC，UI GMT+8”。
- 模板与UI：沿用项目移动优先与卡片式布局；footbar 按钮与既有模块一致。
- 日志：按模块分文件输出到 `./log` 目录；必要时使用INFO，复杂流程留足DEBUG日志（中文）。

## 与通告的联动
- 选中“关联通告”时：
  - 预填开始/结束时间（按通告时间转换到UI时区显示）。
  - 参战形式设定为线下。
  - 预填X/Y/Z快照（从通告当时数据复制，而非当前实时作战区域）。
  - 允许用户在保存前进行必要调整。
- 不建立强绑定的级联更新：通告后续变动不回写已登记作战记录。

## 非目标
- 不支持批量（循环）登记。
- 不提供日历视图（如需，另行设计）。

## 空状态与错误
- 空列表时展示友好的空状态提示与“登记作战记录”快速入口。
- 数据加载失败时提供清晰的错误信息与重试入口。


