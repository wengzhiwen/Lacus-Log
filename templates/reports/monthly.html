{% extends "base.html" %}

{% block title %}å¼€æ’­æœˆæŠ¥ - {{ pagination.month }}{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">ğŸ“Š å¼€æ’­æœˆæŠ¥</h1>
  <p class="text-muted">{{ report_month.strftime('%Yå¹´%mæœˆ') }}</p>
</div>

<!-- æœˆä»½å¯¼èˆª -->
<div class="date-navigation">
  <div class="date-controls">
    <a href="{{ url_for('report.monthly_report', month=pagination.prev_month) }}" class="btn btn-secondary btn-sm">â† ä¸Šä¸ªæœˆ</a>
    <input type="month" id="monthSelector" value="{{ pagination.month }}" class="date-input">
    <a href="{{ url_for('report.monthly_report', month=pagination.next_month) }}" class="btn btn-secondary btn-sm">ä¸‹ä¸ªæœˆ â†’</a>
  </div>
  <div class="export-actions">
    <a href="{{ url_for('report.export_monthly_csv', month=pagination.month) }}" class="btn btn-warning btn-sm">ğŸ“¥ å¯¼å‡ºCSV</a>
  </div>
</div>

<!-- æœˆåº¦æ±‡æ€»æ•°æ® -->
<div class="summary-section">
  <h2 class="section-title">{{ report_month.strftime('%Yå¹´%mæœˆ') }} æœˆåº¦æ±‡æ€»</h2>
  <div class="summary-cards">
    <div class="summary-card">
      <div class="card-label">æ€»ä¸»æ’­æ•°é‡</div>
      <div class="card-value">{{ month_summary.pilot_count }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡æµæ°´</div>
      <div class="card-value {% if month_summary.revenue_sum < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(month_summary.revenue_sum) }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡åº•è–ªæ”¯å‡º</div>
      <div class="card-value {% if month_summary.basepay_sum < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(month_summary.basepay_sum) }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡è¿”ç‚¹</div>
      <div class="card-value {% if month_summary.rebate_sum < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(month_summary.rebate_sum) }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡ä¸»æ’­åˆ†æˆ</div>
      <div class="card-value {% if month_summary.pilot_share_sum < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(month_summary.pilot_share_sum) }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡å…¬å¸åˆ†æˆ</div>
      <div class="card-value {% if month_summary.company_share_sum < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(month_summary.company_share_sum) }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">è¿è¥åˆ©æ¶¦ä¼°ç®—</div>
      <div class="card-value {% if month_summary.operating_profit < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(month_summary.operating_profit) }}</div>
    </div>
  </div>
</div>

<!-- æœˆæŠ¥æ˜ç»† -->
<div class="details-section">
  <h2 class="section-title">æœˆæŠ¥æ˜ç»†</h2>
  {% if details %}
  <div class="table-container">
    <table class="report-table">
      <thead>
        <tr>
          <th class="fixed-col">ä¸»æ’­</th>
          <th>æ€§åˆ«å¹´é¾„</th>
          <th>ç›´å±è¿è¥</th>
          <th>ä¸»æ’­åˆ†ç±»</th>
          <th>æœˆç´¯è®¡å¼€æ’­è®°å½•æ•°</th>
          <th>æœˆå‡æ’­æ—¶(å°æ—¶)</th>
          <th>æœˆç´¯è®¡æµæ°´(å…ƒ)</th>
          <th>æœˆç´¯è®¡ä¸»æ’­åˆ†æˆ(å…ƒ)</th>
          <th>æœˆç´¯è®¡å…¬å¸åˆ†æˆ(å…ƒ)</th>
          <th>æœˆæœ€æ–°è¿”ç‚¹æ¯”ä¾‹(%)</th>
          <th>æœˆç´¯è®¡è¿”ç‚¹(å…ƒ)</th>
          <th>æœˆç´¯è®¡åº•è–ª(å…ƒ)</th>
          <th>æœˆç´¯è®¡æ¯›åˆ©(å…ƒ)</th>
        </tr>
      </thead>
      <tbody>
        {% for detail in details %}
        <tr>
          <td class="fixed-col">
            <a href="{{ url_for('pilot.pilot_performance', pilot_id=detail.pilot_id) }}" class="pilot-link">
              {{ detail.pilot_display }}
            </a>
          </td>
          <td>{{ detail.gender_age }}</td>
          <td>{{ detail.owner }}</td>
          <td>{{ detail.rank | normalize_rank }}</td>
          <td>{{ detail.records_count }}</td>
          <td>{{ "{:.1f}".format(detail.avg_duration) }}å°æ—¶</td>
          <td class="{% if detail.total_revenue < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(detail.total_revenue) }}</td>
          <td class="{% if detail.total_pilot_share < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(detail.total_pilot_share) }}</td>
          <td class="{% if detail.total_company_share < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(detail.total_company_share) }}</td>
          <td>{{ "{:.0f}".format(detail.rebate_rate * 100) }}%</td>
          <td class="{% if detail.rebate_amount < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(detail.rebate_amount) }}</td>
          <td class="{% if detail.total_base_salary < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(detail.total_base_salary) }}</td>
          <td class="{% if detail.total_profit < 0 %}negative-value{% endif %}">Â¥{{ "{:,.2f}".format(detail.total_profit) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <p>æœ¬æœˆæš‚æ— å¼€æ’­è®°å½•</p>
  </div>
  {% endif %}
</div>

<style>
/* æœˆä»½å¯¼èˆªæ ·å¼ */
.date-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0;
  padding: 16px;
  background: var(--table-header);
  border-radius: 8px;
}

.date-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.date-input {
  padding: 8px 12px;
  border: 1px solid var(--gray);
  border-radius: 6px;
  font-size: 14px;
}

.export-actions {
  display: flex;
  gap: 8px;
}

/* æ±‡æ€»å¡ç‰‡æ ·å¼ */
.summary-section {
  margin: 24px 0;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.summary-card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  transition: box-shadow 0.2s ease;
}

.summary-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.card-label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}

.card-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--brand);
}

/* æ˜ç»†è¡¨æ ¼æ ·å¼ */
.details-section {
  margin: 24px 0;
}

.table-container {
  overflow-x: auto;
  border: 1px solid var(--gray);
  border-radius: 8px;
  background: #fff;
}

.report-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1500px;
}

.report-table th,
.report-table td {
  padding: 12px 8px;
  text-align: left;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

.report-table th {
  background: var(--table-header);
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 2;
}

.report-table th.fixed-col,
.report-table td.fixed-col {
  position: sticky;
  left: 0;
  background: #fff; /* ä¸é€æ˜åº•è‰²ï¼Œé¿å…è¢«é®æŒ¡æ—¶é€å‡º */
  background-clip: padding-box;
  min-width: 120px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* æå‡å±‚å é¡ºåºï¼Œç¡®ä¿é¦–åˆ—åœ¨æ¨ªå‘æ»šåŠ¨æ—¶ä¸è¢«å†…å®¹é®æŒ¡ */
.report-table td.fixed-col { z-index: 4; }
.report-table th.fixed-col { z-index: 5; }

/* åˆ†éš”è§†è§‰ï¼Œæ¨ªå‘æ»šåŠ¨æ—¶æ›´æ¸…æ™° */
.report-table td.fixed-col { box-shadow: 2px 0 0 #eee; }
.report-table th.fixed-col { box-shadow: 2px 0 0 #ddd; }

.report-table tbody tr:hover {
  background: #f8f9fa;
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

/* ä¸»æ’­é“¾æ¥æ ·å¼ */
.pilot-link {
  color: var(--brand);
  text-decoration: none;
  font-weight: 600;
}

.pilot-link:hover {
  color: var(--brand-dark);
  text-decoration: underline;
}

/* è´Ÿæ•°æ ·å¼ */
.negative-value {
  color: #dc3545 !important;
  font-weight: 600;
}

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 768px) {
  .date-navigation {
    flex-direction: column;
    gap: 12px;
  }

  .summary-cards {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }

  .summary-card {
    padding: 12px;
  }

  .card-value {
    font-size: 20px;
  }

  .report-table {
    font-size: 12px;
  }

  .report-table th,
  .report-table td {
    padding: 8px 6px;
  }
}
</style>

<script>
// æœˆä»½é€‰æ‹©å™¨äº‹ä»¶
document.getElementById('monthSelector').addEventListener('change', function() {
  const selectedMonth = this.value;
  if (selectedMonth) {
    window.location.href = '{{ url_for("report.monthly_report") }}?month=' + selectedMonth;
  }
});
</script>
{% endblock %}
