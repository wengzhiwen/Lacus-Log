# 主播-结算管理

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；作战记录→开播记录。
> - 本次复核（2025-09-26）：全文沿用统一用语，数据库字段沿用既有命名，以字段标注说明。

主播结算管理用于记录与追踪主播的底薪结算方式与底薪申请流程，保证底薪支出有据可查，并为财务核算提供统一入口。该模块与《主播-分成管理》并列，遵守相同的时间与历史记录管理规范。

## 模块定位

- 主播管理的子模块，入口与分成管理相邻。
- 负责维护主播结算方式的历史记录，并支持按日期查询当前生效的结算方式。
- 提供底薪申请与财务发放流程所需的数据与界面。

## 基本约定

- 所有日期时间字段数据库以UTC存储，界面输入输出与排序全部按GMT+8处理。
- 结算方式记录按"生效日期"判断当前生效状态，与创建时间无关。
- 没有任何结算方式记录的主播默认结算方式为"无底薪"。
- 结算方式一经生效，影响该日期及之后的结算查询，直到出现下一条生效记录。
- 所有新接口遵循统一响应格式，返回数据需使用对应 `utils` 序列化工具。

## 结算方式定义

| 结算方式 | 说明 | 备注 |
|----------|------|------|
| 日结底薪 | 以自然日为周期核算底薪，可申请每日底薪支出 | 触发"申请底薪"入口 |
| 月结底薪 | 以自然月为周期核算底薪，仅在月末统一发放 | 不在开播记录详情展示申请按钮 |
| 无底薪 | 无底薪保障，仅保留流水与分成 | 默认值 |

## 数据结构

### 结算方式记录

| 字段 | 说明 | 参考类型 | 设定 |
|------|------|----------|------|
| ID | 记录唯一标识 | 由技术设计 | 必须 唯一 |
| 主播ID | 对应主播（`pilot_id`） | 关联到主播 | 必须 |
| 生效日期 | 结算方式生效的自然日（UTC存储，UI显示GMT+8） | 日期 | 必须 |
| 结算方式 | 枚举：`daily_base` / `monthly_base` / `none` | 字符串 | 必须 |
| 备注 | 结算调整说明 | 字符串 | 非必须 |
| 是否有效 | 软删除标记 | 布尔 | 必须，默认=true |
| 创建时间 | 记录创建时间 | 时间戳 | 必须，默认=当前UTC |
| 创建人 | 操作人快照 | 关联用户 | 必须 |
| 变更记录 | 字段修改日志 | JSON或独立模型 | 非必须 |

#### 业务规则

- 同一主播同一生效日期仅允许一条有效记录。
- 新增记录只能追加未来或当日生效日期；已生效记录不可修改生效日期。
- 结算方式可编辑（修改类型/备注/状态），编辑时需保留历史版本。
- 软删除后的记录不参与生效判断，但保留在变更记录中。
- 查询当前结算方式时，选取生效日期≤目标日期的最新有效记录；若不存在，返回"无底薪"。

### 底薪申请记录

| 字段 | 说明 | 参考类型 | 设定 |
|------|------|----------|------|
| ID | 申请记录唯一标识 | 由技术设计 | 必须 唯一 |
| 主播ID | 关联主播 | 关联到主播 | 必须 |
| 开播记录ID | 关联开播记录（`battle_record_id`） | 关联到开播记录 | 必须 |
| 结算方式 | 申请时生效的结算方式快照 | 枚举 | 必须 |
| 底薪金额 | 申请的底薪金额 | 数值 | 必须 |
| 申请人 | 发起申请的用户 | 关联到用户 | 必须 |
| 发放状态 | 枚举：`pending` / `approved` / `rejected` | 字符串 | 必须，默认=pending |
| 发放节点 | 审批人、审批时间、审批备注 | 结构化字段 | 非必须 |
| 创建时间 | 申请提交时间 | 时间戳 | 必须 |
| 更新时间 | 最近状态更新时间 | 时间戳 | 必须 |
| 变更记录 | 状态变更历史 | 独立模型 | 非必须 |

> 说明：底薪申请展示的流水金额直接读取关联的开播记录，不在申请记录中单独持久化。

## 页面与交互

### 主播详情页

- 在分成管理卡片下方新增"结算方式"卡片，展示：
  - 当前生效结算方式（名称）。
- 空状态（无记录）展示"当前结算方式：无底薪（默认）"。

### 结算管理页面

参考《主播-分成管理》的布局：

- 标题："主播结算管理 - [主播昵称]"。
- 面包屑：主播管理 > 主播详情 > 结算管理。
- 当前结算信息卡片：
  - 当前生效结算方式。
  - 生效起始日期。
  - 结算说明（例如：日结底薪需每日申报）。
- 结算方式记录列表：
  - 按生效日期倒序展示，字段包括：生效日期、结算方式、备注、状态、创建时间、创建人。
  - 操作：编辑、查看变更记录、软删除/恢复。
- Footbar 按钮："新增结算方式"。

#### 新增/编辑结算方式

- 表单字段：生效日期、结算方式（下拉枚举）、备注、状态开关。
- 验证：
  - 生效日期必填。
  - 同一生效日期重复需阻止保存。
  - 结算方式必选。
- 保存后返回列表，并刷新当前结算信息卡片。

### 开播记录详情页

- 在收益信息卡片下方新增"结算方式"卡片：
  - 读取开播记录开始时间（换算GMT+8）的对应生效结算方式。
  - 展示结算方式名称、生效日期、判定逻辑说明（hover 或辅助文本）。
- 当结算方式为"日结底薪"时，在页面底部 footbar 追加"申请底薪"按钮。


### 底薪申请页面

- 入口：开播记录详情页的"申请底薪"按钮。
- 页面信息：
  - 若关联的该条开播记录已存在底薪申请记录，显示醒目警告信息：该开播记录已存在1条底薪申请。（只是警告不阻止本次申请）
  - 主播信息卡：昵称（真实姓名）、直属运营、当前结算方式。
  - 开播记录概要：开始时间（GMT+8）、时长、流水金额（实时读取开播记录，不做快照）。
  - 申请信息表单：结算方式（只读快照）、流水金额（只读）、底薪金额（可编辑、默认0，需两位小数）、备注（选填）。
  - 底部按钮：提交申请、取消。
- 提交后创建一条底薪申请记录，状态=未处理。

### 财务-底薪管理菜单

- 导航：在侧边菜单"财务"分组下，位于"开播月报"之后。
- 点击进入"底薪申请列表"页面。

#### 底薪申请列表

- 顶部：日期选择器（默认为当天），支持前后翻页按钮，遵循GMT+8。
- 行动栏：CSV导出按钮（导出当前日期筛选结果）。
- 统计数据卡片：在筛选器和数据明细之间展示当日统计信息，包含：
  - 总申请金额：当日所有底薪申请的总金额。
  - 已发放金额：状态为"已发放"的申请金额总和。
  - 已拒绝金额：状态为"拒绝发放"的申请金额总和。
  - 未处理金额：状态为"未处理"的申请金额总和。
- 列表：按申请时间顺序（最早在上）展示所有申请记录。卡片字段：
  - 主播昵称（真实姓名）。
  - 开播开始时间 + 时长。
  - 直属运营昵称。
  - 底薪申请人昵称。
  - 流水金额、底薪金额。
  - 发放状态徽标（颜色区分：未处理=灰，已发放=绿色，拒绝发放=红色）。
- 点击卡片进入申请详情。
- 空状态提供"暂无底薪申请"提示与返回链接。

### 底薪申请详情

- 布局复用申请页面，读取申请记录快照。
- 新增"发放状态"展示，包含状态文案、最近操作人和时间。
- 页面底部按钮：
  - "确认发放"：状态变为已发放（仅未处理、拒绝时显示）。
  - "拒绝发放"：状态变为拒绝发放（仅未处理、已发放时隐藏）。
  - "回到未处理"：状态回退到未处理（仅已发放、拒绝时显示）。
  - "变更记录"：打开状态变更历史弹窗。
- 状态切换需校验并记录操作人和备注（简短理由）。

## 权限控制

| 功能 | 管理员 | 运营 |
|------|--------|------|
| 查看结算方式 | ✅ | ✅ |
| 新增/编辑结算方式 | ✅ | ✅ |
| 软删除结算方式 | ✅ | ✅ |
| 创建底薪申请 | ✅ | ✅ |
| 查看底薪申请列表 | ✅ | ✅ |
| 修改底薪申请状态 | ✅ | ✅ |

- 底薪申请状态流转限管理员与运营角色，操作需写入变更日志。
- 申请人只能查看与其相关的申请详情。

## 接口设计（REST）

| 功能 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取主播结算方式列表 | GET | `/api/settlements/<pilot_id>` | 返回历史记录与当前生效信息 |
| 创建结算方式记录 | POST | `/api/settlements/<pilot_id>` | 新增记录，验证生效日期唯一 |
| 更新结算方式记录 | PUT | `/api/settlements/<record_id>` | 修改结算方式、备注、状态 |
| 软删除结算方式记录 | DELETE | `/api/settlements/<record_id>` | 标记为无效 |
| 查询指定日期生效结算方式 | GET | `/api/settlements/<pilot_id>/effective?date=YYYY-MM-DD` | 提供开播记录调用 |
| 创建底薪申请 | POST | `/api/base-salary-applications` | 从开播记录详情发起 |
| 获取底薪申请列表 | GET | `/api/base-salary-applications?date=YYYY-MM-DD` | 管理员/运营列表 |
| 获取底薪申请统计 | GET | `/api/base-salary-applications/stats?date=YYYY-MM-DD` | 返回当日统计数据 |
| 获取底薪申请详情 | GET | `/api/base-salary-applications/<application_id>` | 包含状态与快照 |
| 更新底薪申请状态 | PATCH | `/api/base-salary-applications/<application_id>/status` | 切换状态并记录备注 |
| 导出底薪申请CSV | GET | `/api/base-salary-applications/export?date=YYYY-MM-DD` | 返回CSV文件 |

- 所有修改类接口需要 `@jwt_required()` 与 CSRF 校验。
- 底薪申请状态更新接口需管理员或运营角色（例如 `@roles_required('admin', 'operator')`）。

## 日志与审计

- 结算方式增删改需记录操作人、旧值/新值，日志级别INFO，内容使用简体中文。
- 底薪申请状态变化需写入独立的变更记录表，并输出DEBUG日志辅助追踪。
- 重要错误（如重复申请、状态冲突）需记录ERROR日志。

## 与其他模块的协同

- 开播记录在渲染详情页时通过"指定日期生效结算方式接口"加载结算信息。
- 分成管理与结算管理卡片挨序放置，保持视觉一致性（参见《基础-UI风格》）。
- 底薪申请列表在导航层级与开播日报、开播月报保持一致，避免信息孤岛。

## 变更记录

- 2025-09-26：首版文档，定义结算管理与底薪申请流程。
- 2025-01-27：新增底薪申请列表统计数据卡片功能，包含总申请金额、已发放金额、已拒绝金额、未处理金额统计。