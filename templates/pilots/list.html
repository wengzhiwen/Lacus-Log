{% extends 'base.html' %}
{% block title %}ä¸»æ’­ç®¡ç† - Lacus-Log{% endblock %}
{% block content %}
<section class="pilot-management">
  <div class="page-header">
    <h1 class="page-title">ä¸»æ’­ç®¡ç†</h1>
  </div>

  <div class="filter-bar">
    <button type="button" class="filter-toggle" onclick="toggleFilters()">
      <span id="filter-summary">å…¨éƒ¨æ˜¾ç¤º</span>
      <span class="toggle-icon" id="filter-toggle-icon">â–¼</span>
    </button>
    <div class="filter-form is-collapsed" id="filter-form">
      <div class="filter-group">
        <label class="filter-label">ä¸»æ’­åˆ†ç±»ç­›é€‰</label>
        <select class="filter-select" id="rank-filter">
          <option value="">å…¨éƒ¨ä¸»æ’­åˆ†ç±»</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label class="filter-label">çŠ¶æ€ç­›é€‰</label>
        <select class="filter-select" id="status-filter">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
        </select>
      </div>
      
      {% if current_user.has_role('gicho') %}
      <div class="filter-group">
        <label class="filter-label">ç›´å±è¿è¥ç­›é€‰</label>
        <select class="filter-select" id="owner-filter">
          <option value="">å…¨éƒ¨ç›´å±è¿è¥</option>
          <option value="none">æ— ç›´å±è¿è¥</option>
        </select>
      </div>
      {% endif %}
      
      <div class="filter-group">
        <label class="filter-label">æ—¶é—´ç­›é€‰</label>
        <select class="filter-select" id="days-filter">
          <option value="">å…¨éƒ¨æ—¶é—´</option>
          <option value="7">æœ€è¿‘7å¤©</option>
          <option value="14">æœ€è¿‘14å¤©</option>
          <option value="30">æœ€è¿‘30å¤©</option>
        </select>
      </div>
    </div>
  </div>

  <div class="search-bar">
    <div class="search-input-group">
      <input type="text" id="pilot-search" class="search-input" placeholder="æœç´¢ä¸»æ’­æ˜µç§°æˆ–çœŸå®å§“å..." />
      <button type="button" class="search-button" onclick="performSearch()">
        <span class="search-icon">ğŸ”</span>
      </button>
    </div>
  </div>

  <div class="pilot-list">
    <div id="loading-state" class="loading-state">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­...</div>
            </div>
    <div id="pilot-cards-container" class="pilot-cards" style="display: none;"></div>
    <div id="empty-state" class="empty-state" style="display: none;">
        <div class="empty-icon">ğŸ‘©â€âœˆï¸</div>
      <div class="empty-title">æš‚æ— ä¸»æ’­</div>
      <div class="empty-description">ç‚¹å‡»ä¸‹æ–¹"æ–°ä¸»æ’­"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªä¸»æ’­</div>
      </div>
  </div>
</section>

<div class="footbar">
  <div class="inner">
    <a class="btn btn-primary" href="{{ url_for('pilot.new_pilot') }}">
      <span class="btn-icon">+</span>
      æ–°ä¸»æ’­
    </a>
    <button class="btn btn-secondary" onclick="exportPilots()">
      <span class="btn-icon">ğŸ“Š</span>
      å¯¼å‡ºï¼ˆCSVï¼‰
    </button>
  </div>
</div>

<style>

.loading-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.loading-spinner {
  width: 40px;
  height: 40px;
  margin: 0 auto 16px;
  border: 4px solid var(--table-header);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  font-size: 14px;
}

.pilot-cards {
  display: block;
}


.filter-toggle {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--brand);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 12px 14px;
  margin-bottom: 10px;
  font-size: 14px;
  cursor: pointer;
}


.search-bar {
  margin-bottom: 16px;
}

.search-input-group {
  display: flex;
  align-items: center;
  background: #fff;
  border: 1px solid var(--table-header);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.search-input {
  flex: 1;
  border: none;
  padding: 12px 14px;
  font-size: 14px;
  outline: none;
  background: transparent;
}

.search-input::placeholder {
  color: var(--muted);
}

.search-button {
  background: var(--brand);
  border: none;
  padding: 12px 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.2s ease;
}

.search-button:hover {
  background: #d32f2f;
}

.search-icon {
  font-size: 16px;
  color: #fff;
}

.filter-form.is-collapsed { display: none; }
.filter-form { margin-bottom: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }

.pilot-card {
  display: block;
  background: #fff;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
  text-decoration: none;
  color: inherit;
  transition: all 0.2s ease;
  cursor: pointer;
}

.pilot-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transform: translateY(-2px);
  border-color: var(--brand);
}

.pilot-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 6px;
}

.pilot-info {
  flex: 1;
}

.pilot-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.pilot-real-name {
  font-size: 12px;
  color: var(--muted);
}

.pilot-meta { display: flex; align-items: center; }
.meta-inline { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); flex-wrap: wrap; justify-content: flex-end; text-align: right; }
.meta-break { flex-basis: 100%; height: 0; }

.gender-icon {
  font-size: 16px;
  font-weight: bold;
}

.pilot-card .card-footer { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid var(--table-header); padding-top: 8px; }
.badges { display: flex; gap: 10px; font-size: 12px; }


.rank-å€™è¡¥æœºå¸ˆ { color: var(--muted); }
.rank-è®­ç»ƒæœºå¸ˆ { color: #FFA500; }
.rank-å®ä¹ æœºå¸ˆ { color: var(--green); }
.rank-æ­£å¼æœºå¸ˆ { color: var(--brand); }

.rank-å€™é€‰äºº { color: var(--muted); }
.rank-è¯•æ’­ä¸»æ’­ { color: #FFA500; }
.rank-å®ä¹ ä¸»æ’­ { color: var(--green); }
.rank-æ­£å¼ä¸»æ’­ { color: var(--brand); }


.status-æœªå¾å¬ { color: var(--muted); }
.status-ä¸å¾å¬ { color: var(--error); }
.status-å·²å¾å¬ { color: var(--warn); }
.status-å·²ç­¾çº¦ { color: var(--hud-green); }
.status-å·²é˜µäº¡ { color: var(--error); }

.status-æœªæ‹›å‹Ÿ { color: var(--muted); }
.status-ä¸æ‹›å‹Ÿ { color: var(--error); }
.status-å·²æ‹›å‹Ÿ { color: var(--warn); }
.status-æµå¤± { color: var(--error); }

.pilot-card:hover .card-arrow {
  color: var(--brand);
}


@media (max-width: 768px) {
  .filter-form {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  
  .pilot-card .card-header { flex-direction: row; align-items: flex-start; gap: 8px; }
  .pilot-meta { justify-content: flex-end; }
}
</style>
<style>

.footbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid var(--table-header);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
  padding: 10px 12px calc(env(safe-area-inset-bottom, 0) + 10px) 12px;
  z-index: 1;
}
.footbar .inner { display: flex; justify-content: center; gap: 12px; }
.container { padding-bottom: 88px; }
</style>
<script>
let allPilots = [];
let pilotsOptions = null;
const currentFilters = {
  rank: '',
  status: '',
  owner: '',
  days: ''
};

// è§„èŒƒåŒ–æšä¸¾å€¼æ˜¾ç¤º
function normalizeRank(value) {
  const mapping = {
    'å€™è¡¥æœºå¸ˆ': 'å€™é€‰äºº',
    'è®­ç»ƒæœºå¸ˆ': 'è¯•æ’­ä¸»æ’­',
    'å®ä¹ æœºå¸ˆ': 'å®ä¹ ä¸»æ’­',
    'æ­£å¼æœºå¸ˆ': 'æ­£å¼ä¸»æ’­'
  };
  return mapping[value] || value;
}

function normalizeStatus(value) {
  const mapping = {
    'æœªå¾å¬': 'æœªæ‹›å‹Ÿ',
    'ä¸å¾å¬': 'ä¸æ‹›å‹Ÿ',
    'å·²å¾å¬': 'å·²æ‹›å‹Ÿ',
    'å·²é˜µäº¡': 'æµå¤±'
  };
  return mapping[value] || value;
}

// è·å–æ€§åˆ«å›¾æ ‡
function getGenderIcon(gender) {
  if (gender === 0) return 'â™‚';
  if (gender === 1) return 'â™€';
  return '?';
}

// åŠ è½½ç­›é€‰å™¨é€‰é¡¹
async function loadOptions() {
  try {
    // å¹¶è¡ŒåŠ è½½æšä¸¾é€‰é¡¹å’Œè¿è¥åˆ—è¡¨
    const [enumResponse, operatorsResponse] = await Promise.all([
      fetch('/api/pilots/options'),
      fetch('/api/users/operators')
    ]);
    
    const enumResult = await enumResponse.json();
    const operatorsResult = await operatorsResponse.json();
    
    console.log('æšä¸¾é€‰é¡¹ç»“æœ:', enumResult);
    console.log('è¿è¥åˆ—è¡¨ç»“æœ:', operatorsResult);
    
    if (!enumResult.success) {
      throw new Error(enumResult.error?.message || 'è·å–æšä¸¾é€‰é¡¹å¤±è´¥');
    }
    
    if (!operatorsResult.success) {
      throw new Error(operatorsResult.error?.message || 'è·å–è¿è¥åˆ—è¡¨å¤±è´¥');
    }
    
    pilotsOptions = {
      enums: enumResult.data.enums,
      owners: operatorsResult.data
    };
    
    console.log('pilotsOptions:', pilotsOptions);
    console.log('ownersæ•°é‡:', pilotsOptions.owners ? pilotsOptions.owners.length : 0);
    
    populateFilters();
  } catch (error) {
    console.error('åŠ è½½é€‰é¡¹å¤±è´¥:', error);
    showMessage('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥', 'error');
  }
}

// å¡«å……ç­›é€‰å™¨
function populateFilters() {
  if (!pilotsOptions) return;
  
  // å¡«å……ä¸»æ’­åˆ†ç±»
  const rankFilter = document.getElementById('rank-filter');
  Object.keys(pilotsOptions.enums.rank).forEach(key => {
    const value = pilotsOptions.enums.rank[key];
    // åªæ˜¾ç¤ºæ–°å€¼ï¼Œè¿‡æ»¤æ—§å€¼
    if (!value.includes('æœºå¸ˆ') && !value.includes('å¾å¬') && !value.includes('é˜µäº¡')) {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value;
      rankFilter.appendChild(option);
    }
  });
  
  // å¡«å……çŠ¶æ€
  const statusFilter = document.getElementById('status-filter');
  Object.keys(pilotsOptions.enums.status).forEach(key => {
    const value = pilotsOptions.enums.status[key];
    // åªæ˜¾ç¤ºæ–°å€¼
    if (!value.includes('å¾å¬') && !value.includes('é˜µäº¡')) {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value;
      statusFilter.appendChild(option);
    }
  });
  
  // å¡«å……ç›´å±è¿è¥
  const ownerFilter = document.getElementById('owner-filter');
  if (ownerFilter) {
    console.log('å¼€å§‹å¡«å……ç›´å±è¿è¥ç­›é€‰å™¨ï¼Œæ•°æ®:', pilotsOptions.owners);
    if (pilotsOptions.owners && pilotsOptions.owners.length > 0) {
      pilotsOptions.owners.forEach(owner => {
        const option = document.createElement('option');
        option.value = owner.id;
        option.textContent = owner.nickname;
        ownerFilter.appendChild(option);
        console.log('æ·»åŠ è¿è¥é€‰é¡¹:', owner.nickname, owner.id);
      });
    } else {
      console.warn('ç›´å±è¿è¥æ•°æ®ä¸ºç©ºæˆ–ä¸å­˜åœ¨');
    }
  } else {
    console.warn('æ‰¾ä¸åˆ°owner-filterå…ƒç´ ');
  }
}

// åŠ è½½ä¸»æ’­åˆ—è¡¨
async function loadPilots() {
  const loadingState = document.getElementById('loading-state');
  const pilotsContainer = document.getElementById('pilot-cards-container');
  const emptyState = document.getElementById('empty-state');
  
  loadingState.style.display = 'block';
  pilotsContainer.style.display = 'none';
  emptyState.style.display = 'none';
  
  try {
    const params = new URLSearchParams();
    if (currentFilters.rank) params.append('rank', currentFilters.rank);
    if (currentFilters.status) params.append('status', currentFilters.status);
    if (currentFilters.owner) {
      if (currentFilters.owner === 'none') {
        // æ— ç›´å±è¿è¥çš„ç­›é€‰ç”±åç«¯å¤„ç†
      } else {
        params.append('owner_id', currentFilters.owner);
      }
    }
    if (currentFilters.days) {
      const daysAgo = new Date();
      daysAgo.setDate(daysAgo.getDate() - parseInt(currentFilters.days));
      params.append('created_from', daysAgo.toISOString());
    }
    
    const response = await fetch(`/api/pilots?${params.toString()}`);
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || 'åŠ è½½ä¸»æ’­åˆ—è¡¨å¤±è´¥');
    }
    
    allPilots = result.data.items || [];
    renderPilots(allPilots);
    updateFilterSummary();
  } catch (error) {
    console.error('åŠ è½½ä¸»æ’­åˆ—è¡¨å¤±è´¥:', error);
    showMessage('åŠ è½½ä¸»æ’­åˆ—è¡¨å¤±è´¥', 'error');
    loadingState.style.display = 'none';
    emptyState.style.display = 'block';
  }
}

// æ¸²æŸ“ä¸»æ’­åˆ—è¡¨
function renderPilots(pilots) {
  const loadingState = document.getElementById('loading-state');
  const pilotsContainer = document.getElementById('pilot-cards-container');
  const emptyState = document.getElementById('empty-state');
  
  loadingState.style.display = 'none';
  
  if (pilots.length === 0) {
    pilotsContainer.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }
  
  pilotsContainer.innerHTML = '';
  pilotsContainer.style.display = 'block';
  emptyState.style.display = 'none';
  
  pilots.forEach(pilot => {
    const card = createPilotCard(pilot);
    pilotsContainer.appendChild(card);
  });
}

// åˆ›å»ºä¸»æ’­å¡ç‰‡
function createPilotCard(pilot) {
  const card = document.createElement('a');
  card.href = `/pilots/${pilot.id}`;
  card.className = 'pilot-card';
  
  const normalizedRank = normalizeRank(pilot.rank || '');
  const normalizedStatus = normalizeStatus(pilot.status || '');
  
  card.innerHTML = `
    <div class="card-header">
      <div class="pilot-info">
        <div class="pilot-name">${pilot.nickname || ''}</div>
        <div class="pilot-real-name">${pilot.real_name || 'æœªå¡«å†™å§“å'}</div>
      </div>
      <div class="pilot-meta">
        <div class="meta-inline">
          <span class="gender-icon">${getGenderIcon(pilot.gender)}</span>
          <span class="age">${pilot.age || 'æœªçŸ¥'}å²</span>
          <span class="meta-break"></span>
          <span class="owner">${pilot.owner ? (pilot.owner.nickname || 'æ— ') : 'æ— '}</span>
        </div>
      </div>
    </div>
    <div class="card-footer">
      <div class="badges">
        <span class="rank-badge rank-${normalizedRank.replace(/ /g, '')}">${normalizedRank}</span>
        <span class="status-badge status-${normalizedStatus.replace(/ /g, '')}">${normalizedStatus}</span>
      </div>
      <div class="card-arrow">â†’</div>
    </div>
  `;
  
  return card;
}

// æ›´æ–°ç­›é€‰æ‘˜è¦
function updateFilterSummary() {
  const summary = document.getElementById('filter-summary');
  const selectedItems = [];
  
  if (currentFilters.rank) selectedItems.push(currentFilters.rank);
  if (currentFilters.status) selectedItems.push(currentFilters.status);
  if (currentFilters.owner) {
    if (currentFilters.owner === 'none') {
      selectedItems.push('æ— ç›´å±è¿è¥');
    } else if (pilotsOptions) {
      const owner = pilotsOptions.owners.find(o => o.id === currentFilters.owner);
      if (owner) selectedItems.push(owner.nickname || owner.username);
    }
  }
  if (currentFilters.days) {
    selectedItems.push(`æœ€è¿‘${currentFilters.days}å¤©`);
  }
  
  summary.textContent = selectedItems.length > 0 ? selectedItems.join(' + ') : 'å…¨éƒ¨æ˜¾ç¤º';
}

// åˆ‡æ¢ç­›é€‰å™¨æ˜¾ç¤º
function toggleFilters() {
  const form = document.getElementById('filter-form');
  const icon = document.getElementById('filter-toggle-icon');
  const collapsed = form.classList.toggle('is-collapsed');
  icon.textContent = collapsed ? 'â–¼' : 'â–²';
}

// æœç´¢åŠŸèƒ½
function performSearch() {
  const searchInput = document.getElementById('pilot-search');
  const searchTerm = searchInput.value.trim().toLowerCase();
  
  if (!searchTerm) {
    showAllPilots();
    return;
  }
  
  const filteredPilots = allPilots.filter(pilot => {
    const nickname = (pilot.nickname || '').toLowerCase();
    const realName = (pilot.real_name || '').toLowerCase();
    return nickname.includes(searchTerm) || realName.includes(searchTerm);
  });
  
  renderPilots(filteredPilots);
}

function showAllPilots() {
  renderPilots(allPilots);
}

// å¯¼å‡ºä¸»æ’­æ•°æ®
function exportPilots() {
  try {
    showMessage('æ­£åœ¨å¯¼å‡ºæ•°æ®...', 'info');
    
    // æ„å»ºå¯¼å‡ºURLï¼ŒåŒ…å«å½“å‰ç­›é€‰å‚æ•°
    const params = new URLSearchParams();
    
    if (currentFilters.rank) {
      params.append('rank', currentFilters.rank);
    }
    if (currentFilters.status) {
      params.append('status', currentFilters.status);
    }
    if (currentFilters.owner) {
      params.append('owner_id', currentFilters.owner);
    }
    if (currentFilters.platform) {
      params.append('platform', currentFilters.platform);
    }
    if (currentFilters.work_mode) {
      params.append('work_mode', currentFilters.work_mode);
    }
    
    const exportUrl = `/api/pilots/export?${params.toString()}`;
    console.log('å¯¼å‡ºURL:', exportUrl);
    
    // ç›´æ¥é€šè¿‡window.locationè§¦å‘ä¸‹è½½
    // æµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†CSVæ–‡ä»¶çš„ä¸‹è½½
    window.location.href = exportUrl;
    
    // å»¶è¿Ÿæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œç»™æµè§ˆå™¨æ—¶é—´å¼€å§‹ä¸‹è½½
    setTimeout(() => {
      showMessage('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
    }, 500);
    
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error);
    showMessage('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
  }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async function() {
  await loadOptions();
  await loadPilots();
  
  // ç»‘å®šç­›é€‰å™¨äº‹ä»¶
  document.getElementById('rank-filter').addEventListener('change', function(e) {
    currentFilters.rank = e.target.value;
    loadPilots();
  });
  
  document.getElementById('status-filter').addEventListener('change', function(e) {
    currentFilters.status = e.target.value;
    loadPilots();
  });
  
  const ownerFilter = document.getElementById('owner-filter');
  if (ownerFilter) {
    ownerFilter.addEventListener('change', function(e) {
      currentFilters.owner = e.target.value;
      loadPilots();
    });
  }
  
  document.getElementById('days-filter').addEventListener('change', function(e) {
    currentFilters.days = e.target.value;
    loadPilots();
  });
  
  // ç»‘å®šæœç´¢äº‹ä»¶
  const searchInput = document.getElementById('pilot-search');
  searchInput.addEventListener('input', performSearch);
  searchInput.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      performSearch();
    }
  });
});
</script>
{% endblock %}
