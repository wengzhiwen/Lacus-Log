{% extends "base.html" %}

{% block title %}ä¸»æ’­ä¸šç»© - Lacus-Log{% endblock %}

{% block content %}
<div class="page-header">
  <div class="header-content">
    <div class="back-nav" id="back-nav">
      <!-- è¿”å›æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <h1 class="page-title">ğŸ¤ <span id="pilot-nickname">åŠ è½½ä¸­...</span> ä¸šç»©</h1>
  </div>
</div>

<div class="pilot-header">
  <div class="pilot-basic-info">
    <div class="pilot-name">
      <a href="#" id="pilot-detail-link"><span id="pilot-nickname-link">-</span></a>
      <span id="pilot-real-name" style="display: none;">ï¼ˆ<span id="pilot-real-name-value"></span>ï¼‰</span>
    </div>
    <div class="pilot-details">
      <span class="age-gender"><span id="pilot-age">-</span>å²<span id="pilot-gender-icon">-</span></span>
      <span class="hometown" id="pilot-hometown" style="display: none;"><span id="pilot-hometown-value"></span></span>
      <span class="owner-rank">ç›´å±è¿è¥ï¼š<span id="pilot-owner">-</span> <br />
        ä¸»æ’­åˆ†ç±»ï¼š<span id="pilot-rank">-</span> <br />
        ä¸»æ’­çŠ¶æ€ï¼š<span id="pilot-status">-</span></span>
    </div>
  </div>
</div>

<div class="loading-state" id="loading-state">
  <div class="loading-spinner"></div>
  <div class="loading-text">æ­£åœ¨åŠ è½½ä¸šç»©æ•°æ®...</div>
</div>

<div class="error-state" id="error-state" style="display: none;">
  <div class="error-icon">âŒ</div>
  <div class="error-text">åŠ è½½ä¸šç»©æ•°æ®å¤±è´¥</div>
  <button class="btn btn-primary" onclick="loadPerformanceData()">é‡è¯•</button>
</div>

<div class="stats-section" id="stats-section" style="display: none;">
  <div class="summary-section">
    <h2 class="section-title">æœ¬æœˆç»Ÿè®¡ï¼ˆå…¨æœˆ / æœˆåˆè‡³æŠ¥è¡¨æ—¥ï¼‰</h2>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-label">å¼€æ’­è®°å½•æ•°</div>
        <div class="card-value" id="month-record-count">-</div>
      </div>
      <div class="summary-card" id="month-hours-card">
        <div class="card-label">å¼€æ’­æ—¶æ•°</div>
        <div class="card-value" id="month-total-hours">-h</div>
        <div class="card-sub" id="month-avg-hours">-h/è®°å½•</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡æµæ°´</div>
        <div class="card-value" id="month-total-revenue">Â¥-</div>
        <div class="card-sub" id="month-daily-avg-revenue">æ—¥å‡Â¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡åº•è–ª</div>
        <div class="card-value" id="month-total-basepay">Â¥-</div>
        <div class="card-sub" id="month-daily-avg-basepay">æ—¥å‡Â¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡è¿”ç‚¹</div>
        <div class="card-value" id="month-total-rebate">Â¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡å…¬å¸åˆ†æˆ</div>
        <div class="card-value" id="month-total-company-share">Â¥-</div>
      </div>
      <div class="summary-card" id="month-operating-profit-card">
        <div class="card-label">è¿è¥åˆ©æ¶¦ä¼°ç®—</div>
        <div class="card-value" id="month-operating-profit">Â¥-</div>
        <div class="card-sub" id="month-daily-avg-operating-profit">æ—¥å‡Â¥-</div>
      </div>
    </div>
  </div>

  <div class="stats-notice">
    <div class="notice-content">
      <div class="notice-icon">â„¹ï¸</div>
      <div class="notice-text">
        æ‰€æœ‰æ—¥å‡æ•°æ®çš„åˆ†æ¯ä¸ºå¼€æ’­è®°å½•æ•°ï¼ˆå¹¶éè¿›è¡Œåˆ†æ—¥è®¡ç®—ï¼‰ã€‚<br />è¿‘næ—¥ä¸ºæœ€è¿‘çš„næ¡å¼€æ’­è®°å½•ï¼ˆå¹¶éè‡ªç„¶æ—¥ï¼‰ã€‚
      </div>
    </div>
  </div>

  <div class="summary-section">
    <h2 class="section-title">è¿‘7æ—¥ç»Ÿè®¡</h2>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-label">å¼€æ’­è®°å½•æ•°</div>
        <div class="card-value" id="week-record-count">-</div>
      </div>
      <div class="summary-card" id="week-hours-card">
        <div class="card-label">å¼€æ’­æ—¶æ•°</div>
        <div class="card-value" id="week-total-hours">-h</div>
        <div class="card-sub" id="week-avg-hours">-h/è®°å½•</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡æµæ°´</div>
        <div class="card-value" id="week-total-revenue">Â¥-</div>
        <div class="card-sub" id="week-daily-avg-revenue">æ—¥å‡Â¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡åº•è–ª</div>
        <div class="card-value" id="week-total-basepay">Â¥-</div>
        <div class="card-sub" id="week-daily-avg-basepay">æ—¥å‡Â¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡è¿”ç‚¹</div>
        <div class="card-value" id="week-total-rebate">Â¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡å…¬å¸åˆ†æˆ</div>
        <div class="card-value" id="week-total-company-share">Â¥-</div>
      </div>
      <div class="summary-card" id="week-operating-profit-card">
        <div class="card-label">è¿‘æ—¥ç›ˆäºï¼ˆä¸è®¡è¿”ç‚¹ï¼‰</div>
        <div class="card-value" id="week-operating-profit">Â¥-</div>
        <div class="card-sub" id="week-daily-avg-operating-profit">æ—¥å‡Â¥-</div>
      </div>
    </div>
  </div>

  <div class="summary-section">
    <h2 class="section-title">è¿‘3æ—¥ç»Ÿè®¡</h2>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-label">å¼€æ’­è®°å½•æ•°</div>
        <div class="card-value" id="three-day-record-count">-</div>
      </div>
      <div class="summary-card" id="three-day-hours-card">
        <div class="card-label">å¼€æ’­æ—¶æ•°</div>
        <div class="card-value" id="three-day-total-hours">-h</div>
        <div class="card-sub" id="three-day-avg-hours">-h/è®°å½•</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡æµæ°´</div>
        <div class="card-value" id="three-day-total-revenue">Â¥-</div>
        <div class="card-sub" id="three-day-daily-avg-revenue">æ—¥å‡Â¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡åº•è–ª</div>
        <div class="card-value" id="three-day-total-basepay">Â¥-</div>
        <div class="card-sub" id="three-day-daily-avg-basepay">æ—¥å‡Â¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡è¿”ç‚¹</div>
        <div class="card-value" id="three-day-total-rebate">Â¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">ç´¯è®¡å…¬å¸åˆ†æˆ</div>
        <div class="card-value" id="three-day-total-company-share">Â¥-</div>
      </div>
      <div class="summary-card" id="three-day-operating-profit-card">
        <div class="card-label">è¿‘æ—¥ç›ˆäºï¼ˆä¸è®¡è¿”ç‚¹ï¼‰</div>
        <div class="card-value" id="three-day-operating-profit">Â¥-</div>
        <div class="card-sub" id="three-day-daily-avg-operating-profit">æ—¥å‡Â¥-</div>
      </div>
    </div>
  </div>
</div>

<div class="summary-section" id="recent-records-section" style="display: none;">
  <h2 class="section-title">æœ€è¿‘å¼€æ’­è®°å½•</h2>
  <div class="record-cards" id="recent-records-container">
    <!-- è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
  </div>
</div>

<style>

.page-header {
  margin-bottom: 20px;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 16px;
}


.back-nav {
  flex-shrink: 0;
}

.back-nav .btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  color: #495057;
  text-decoration: none;
  font-size: 14px;
  transition: all 0.2s ease;
}

.back-nav .btn:hover {
  background: #e9ecef;
  border-color: #adb5bd;
  color: #343a40;
}

.back-nav .btn span {
  font-size: 16px;
  font-weight: bold;
}


.page-title {
  margin: 0;
  flex: 1;
}


.pilot-header {
  background: #fff;
  border-radius: 8px;
  padding: 16px 20px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
}

.pilot-basic-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.pilot-name {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.pilot-name a {
  color: var(--brand);
  text-decoration: underline;
}

.pilot-name a:hover {
  text-decoration: underline;
}

.pilot-details {
  display: flex;
  gap: 12px;
  font-size: 14px;
  color: var(--muted);
}

.age-gender {
  font-weight: 600;
}

.hometown::before {
  content: "Â· ";
}

.owner-rank::before {
  content: " ";
}


.stats-section {
  margin-bottom: 30px;
}


.stats-notice {
  background: #e3f2fd;
  border: 1px solid #bbdefb;
  border-radius: 8px;
  padding: 12px 16px;
  margin: 20px 0;
}

.notice-content {
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.notice-icon {
  font-size: 16px;
  flex-shrink: 0;
  margin-top: 1px;
}

.notice-text {
  font-size: 14px;
  color: #1976d2;
  line-height: 1.4;
  font-weight: 500;
}

.summary-section {
  margin: 24px 0;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.summary-card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  transition: box-shadow 0.2s ease;
}

.summary-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.summary-card.negative-value {
  border-color: #f44336;
}

.summary-card.negative-value:hover {
  box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);
}

.card-label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}

.card-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--brand);
}

.card-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}


.record-cards {
  padding: 0;
}

.record-card {
  display: block;
  background: #fff;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
  text-decoration: none;
  color: inherit;
  transition: all 0.2s ease;
  cursor: pointer;
}

.record-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transform: translateY(-2px);
  border-color: var(--brand);
}

.record-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.record-time {
  flex: 0 0 auto;
}

.start-time {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 2px;
}

.duration {
  font-size: 12px;
  color: var(--muted);
}

.record-info {
  flex: 1;
  text-align: right;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}

.pilot-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  line-height: 1.2;
  margin-bottom: 2px;
}

.meta-line {
  font-size: 12px;
  color: var(--muted);
  line-height: 1.1;
}

.record-card .card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-top: 1px solid var(--table-header);
  padding-top: 12px;
}

.revenue {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.amount {
  font-size: 16px;
  font-weight: 600;
  color: var(--hud-green);
}

.base-salary {
  font-size: 12px;
  color: var(--muted);
}

.card-arrow {
  font-size: 18px;
  color: var(--muted);
  transition: color 0.2s ease;
}

.record-card:hover .card-arrow {
  color: var(--brand);
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.empty-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
}


@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .page-title {
    font-size: 20px;
  }
  
  .pilot-details {
    flex-direction: column;
    gap: 4px;
  }
  
  .stats-notice {
    padding: 10px 12px;
    margin: 16px 0;
  }
  
  .notice-text {
    font-size: 13px;
  }
  
  .summary-cards {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }
  
  .summary-card {
    padding: 12px;
  }
  
  .card-value {
    font-size: 20px;
  }
  
  .record-cards {
    padding: 0;
  }
  
  .record-card .card-header {
    flex-direction: row;
    align-items: flex-start;
    gap: 8px;
  }
  
  .record-info {
    text-align: right;
    align-items: flex-end;
  }
}

.error-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.error-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.error-text {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
}

.error-state .btn {
  margin-top: 16px;
}
</style>

<script>
// ä¸»æ’­ä¸šç»©é¡µé¢JavaScript - å®Œå…¨RESTåŒ–ç‰ˆæœ¬
// ä»URLä¸­è·å–pilot_id
const urlParts = window.location.pathname.split('/');
const pilotId = urlParts[urlParts.indexOf('pilots') + 1];

// ä»URLå‚æ•°è·å–æ¥æºä¿¡æ¯
const urlParams = new URLSearchParams(window.location.search);
const fromParam = urlParams.get('from');
const dateParam = urlParams.get('date');
const ownerParam = urlParams.get('owner');
const monthParam = urlParams.get('month');
const recordIdParam = urlParams.get('record_id');

// æ ¼å¼åŒ–é‡‘é¢
function formatCurrency(amount) {
  if (amount === null || amount === undefined || Number.isNaN(Number(amount))) {
    return 'Â¥0.00';
  }
  const numeric = Number(amount);
  return 'Â¥' + numeric.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// æ ¼å¼åŒ–æ—¶é—´
function formatDateTime(dateTimeStr) {
  if (!dateTimeStr) return 'æœªçŸ¥';
  const date = new Date(dateTimeStr);
  if (Number.isNaN(date.getTime())) {
    return 'æœªçŸ¥';
  }
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
}

// è§„èŒƒåŒ–ä¸»æ’­åˆ†ç±»æ˜¾ç¤º
function normalizeRank(value) {
  const mapping = {
    'å€™è¡¥æœºå¸ˆ': 'å€™é€‰äºº',
    'è®­ç»ƒæœºå¸ˆ': 'è¯•æ’­ä¸»æ’­',
    'å®ä¹ æœºå¸ˆ': 'å®ä¹ ä¸»æ’­',
    'æ­£å¼æœºå¸ˆ': 'æ­£å¼ä¸»æ’­'
  };
  return mapping[value] || value;
}

// è§„èŒƒåŒ–ä¸»æ’­çŠ¶æ€æ˜¾ç¤º
function normalizeStatus(value) {
  const mapping = {
    'æœªå¾å¬': 'æœªæ‹›å‹Ÿ',
    'ä¸å¾å¬': 'ä¸æ‹›å‹Ÿ',
    'å·²å¾å¬': 'å·²æ‹›å‹Ÿ',
    'å·²ç­¾çº¦': 'å·²ç­¾çº¦',
    'å·²é˜µäº¡': 'æµå¤±'
  };
  return mapping[value] || value;
}

// ç”Ÿæˆè¿”å›æŒ‰é’®
function generateBackButton() {
  const backNav = document.getElementById('back-nav');
  let backHtml = '';
  
  if (fromParam === 'daily_report' && dateParam && ownerParam) {
    backHtml = `<a class="btn btn-secondary" href="/reports/daily?date=${dateParam}&owner=${ownerParam}">
      <span>â†</span> è¿”å›
    </a>`;
  } else if (fromParam === 'monthly_report' && monthParam) {
    backHtml = `<a class="btn btn-secondary" href="/reports/monthly?month=${monthParam}">
      <span>â†</span> è¿”å›
    </a>`;
  } else if (fromParam === 'pilot_detail') {
    backHtml = `<a class="btn btn-secondary" href="/pilots/${pilotId}">
      <span>â†</span> è¿”å›
    </a>`;
  } else if (fromParam === 'battle_record_detail' && recordIdParam) {
    backHtml = `<a class="btn btn-secondary" href="/battle-records/${recordIdParam}">
      <span>â†</span> è¿”å›
    </a>`;
  } else {
    backHtml = `<a class="btn btn-secondary" href="/pilots/">
      <span>â†</span> è¿”å›
    </a>`;
  }
  
  backNav.innerHTML = backHtml;
}

// æ›´æ–°ä¸»æ’­åŸºæœ¬ä¿¡æ¯
function updatePilotInfo(pilotInfo) {
  // æ›´æ–°æ‰€æœ‰æ˜µç§°æ˜¾ç¤º
  const nicknameElements = document.querySelectorAll('#pilot-nickname, #pilot-nickname-link');
  nicknameElements.forEach(el => el.textContent = pilotInfo.nickname);
  
  // æ›´æ–°è¯¦æƒ…é¡µé“¾æ¥
  const detailLink = document.getElementById('pilot-detail-link');
  detailLink.href = `/pilots/${pilotId}?from=performance`;
  
  // æ›´æ–°çœŸå®å§“å
  if (pilotInfo.real_name) {
    document.getElementById('pilot-real-name-value').textContent = pilotInfo.real_name;
    document.getElementById('pilot-real-name').style.display = 'inline';
  }
  
  // æ›´æ–°å¹´é¾„å’Œæ€§åˆ«å›¾æ ‡
  document.getElementById('pilot-age').textContent = pilotInfo.age || '-';
  document.getElementById('pilot-gender-icon').textContent = pilotInfo.gender_icon || '?';
  
  // æ›´æ–°ç±è´¯
  if (pilotInfo.hometown) {
    document.getElementById('pilot-hometown-value').textContent = pilotInfo.hometown;
    document.getElementById('pilot-hometown').style.display = 'inline';
  }
  
  // æ›´æ–°ç›´å±è¿è¥
  document.getElementById('pilot-owner').textContent = pilotInfo.owner || 'æœªçŸ¥';
  
  // æ›´æ–°ä¸»æ’­åˆ†ç±»å’ŒçŠ¶æ€ï¼ˆåº”ç”¨è§„èŒƒåŒ–ï¼‰
  document.getElementById('pilot-rank').textContent = normalizeRank(pilotInfo.rank || '-');
  document.getElementById('pilot-status').textContent = normalizeStatus(pilotInfo.status || '-');
}

// æ›´æ–°ç»Ÿè®¡å¡ç‰‡
function updateStatsCard(prefix, stats) {
  if (!stats) {
    console.error(`ç»Ÿè®¡æ•°æ®ç¼ºå¤±: ${prefix}`);
    return;
  }
  try {
    document.getElementById(`${prefix}-record-count`).textContent = stats.record_count;
    document.getElementById(`${prefix}-total-hours`).textContent = Number(stats.total_hours).toFixed(1) + 'h';
    document.getElementById(`${prefix}-avg-hours`).textContent = Number(stats.avg_hours).toFixed(1) + 'h/è®°å½•';
    document.getElementById(`${prefix}-total-revenue`).textContent = formatCurrency(stats.total_revenue);
    document.getElementById(`${prefix}-daily-avg-revenue`).textContent = 'æ—¥å‡' + formatCurrency(stats.daily_avg_revenue);
    document.getElementById(`${prefix}-total-basepay`).textContent = formatCurrency(stats.total_basepay);
    document.getElementById(`${prefix}-daily-avg-basepay`).textContent = 'æ—¥å‡' + formatCurrency(stats.daily_avg_basepay);
    document.getElementById(`${prefix}-total-rebate`).textContent = formatCurrency(stats.total_rebate);
    document.getElementById(`${prefix}-total-company-share`).textContent = formatCurrency(stats.total_company_share);
    document.getElementById(`${prefix}-operating-profit`).textContent = formatCurrency(stats.operating_profit);
    document.getElementById(`${prefix}-daily-avg-operating-profit`).textContent = 'æ—¥å‡' + formatCurrency(stats.daily_avg_operating_profit);
    
    // è®¾ç½®è´Ÿå€¼æ ·å¼
    const hoursCard = document.getElementById(`${prefix}-hours-card`);
    const profitCard = document.getElementById(`${prefix}-operating-profit-card`);
    
    if (hoursCard && stats.avg_hours < 7 && stats.operating_profit < 0) {
      hoursCard.classList.add('negative-value');
    }
    if (profitCard && stats.operating_profit < 0) {
      profitCard.classList.add('negative-value');
    }
  } catch (error) {
    console.error(`æ›´æ–°ç»Ÿè®¡å¡ç‰‡å¤±è´¥ (${prefix}):`, error);
    console.error('stats:', stats);
  }
}

// æ¸²æŸ“æœ€è¿‘å¼€æ’­è®°å½•
function renderRecentRecords(records, pilotInfo) {
  const container = document.getElementById('recent-records-container');
  
  if (!records || records.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“Š</div>
        <div class="empty-title">æš‚æ— å¼€æ’­è®°å½•</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = records.map(record => `
    <a href="/battle-records/${record.id}" class="record-card">
      <div class="card-header">
        <div class="record-time">
          <div class="start-time">${formatDateTime(record.start_time)}</div>
          <div class="duration">${Number(record.duration_hours).toFixed(1)}å°æ—¶</div>
        </div>
        <div class="record-info">
          <div class="pilot-name">${pilotInfo.nickname}${pilotInfo.real_name ? 'ï¼ˆ' + pilotInfo.real_name + 'ï¼‰' : ''}</div>
          <div class="meta-line">[${pilotInfo.owner || 'æœªçŸ¥'}][${pilotInfo.rank || 'æœªçŸ¥'}]</div>
        </div>
      </div>
      <div class="card-footer">
        <div class="revenue">
          <span class="amount">${formatCurrency(record.revenue_amount)}</span>
          ${record.base_salary > 0 ? `<span class="base-salary">åº•è–ª${formatCurrency(record.base_salary)}</span>` : ''}
        </div>
        <div class="card-arrow">â†’</div>
      </div>
    </a>
  `).join('');
}

// åŠ è½½ä¸šç»©æ•°æ®
async function loadPerformanceData() {
  try {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('error-state').style.display = 'none';
    document.getElementById('stats-section').style.display = 'none';
    document.getElementById('recent-records-section').style.display = 'none';
    
    const response = await fetch(`/api/pilots/${pilotId}/performance`);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || 'è·å–æ•°æ®å¤±è´¥');
    }
    
    const data = result.data;
    
    // æ›´æ–°ä¸»æ’­åŸºæœ¬ä¿¡æ¯
    updatePilotInfo(data.pilot_info);
    
    // å…ˆæ˜¾ç¤ºå†…å®¹åŒºåŸŸï¼Œå†æ›´æ–°æ•°æ®
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('stats-section').style.display = 'block';
    document.getElementById('recent-records-section').style.display = 'block';
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    console.log('å¼€å§‹æ›´æ–°ç»Ÿè®¡æ•°æ®...');
    console.log('month_stats:', data.month_stats);
    console.log('week_stats:', data.week_stats);
    console.log('three_day_stats:', data.three_day_stats);
    
    updateStatsCard('month', data.month_stats);
    updateStatsCard('week', data.week_stats);
    updateStatsCard('three-day', data.three_day_stats);
    
    // æ¸²æŸ“æœ€è¿‘å¼€æ’­è®°å½•
    renderRecentRecords(data.recent_records, data.pilot_info);
    
  } catch (error) {
    console.error('åŠ è½½ä¸šç»©æ•°æ®å¤±è´¥:', error);
    
    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'block';
    document.getElementById('stats-section').style.display = 'none';
    document.getElementById('recent-records-section').style.display = 'none';
  }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  // ç”Ÿæˆè¿”å›æŒ‰é’®
  generateBackButton();
  
  // åŠ è½½ä¸šç»©æ•°æ®
  loadPerformanceData();
});
</script>
{% endblock %}
