{% extends "base.html" %}

{% block title %}通告清理{% endblock %}

{% block content %}
<section class="announcement-cleanup">
    <div class="page-header">
        <h1 class="page-title">通告清理</h1>
    </div>

    <div class="alert alert-warning" style="margin-bottom:12px;">
        <div><strong>注意:</strong></div>
        <div>1、只会清理明天开始（GMT+8）的通告</div>
        <div>2、不论通告是否已经关联了开播记录都会被清理</div>
        <div>3、该操作无法恢复</div>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>主播</th>
                <th>直属运营</th>
                <th>剩余通告数</th>
                <th style="width:160px;">操作</th>
            </tr>
        </thead>
        <tbody id="cleanup-table-body">
            <!-- 内容将由JS动态加载 -->
        </tbody>
    </table>
    <div id="empty-state" class="empty-state" style="text-align:center; color: var(--muted); padding:40px 10px; display:none;">
        暂无需要清理的通告。
    </div>

    <div class="footbar" style="position:static; box-shadow:none; border-top:none; padding:0; margin-top:16px;">
        <div class="inner" style="justify-content:flex-start;">
            <a class="btn btn-outline" href="{{ url_for('announcement.list_announcements') }}">返回通告管理</a>
        </div>
    </div>
</section>

<style>
.table { width: 100%; background:#fff; border:1px solid var(--table-header); border-radius:8px; overflow:hidden; }
.table th, .table td { padding:10px 12px; border-bottom:1px solid var(--table-header); font-size:14px; }
.table thead th { background: var(--table-header); text-align:left; }
.alert { background:#fff3cd; color:#856404; border:1px solid #ffeeba; padding:10px 12px; border-radius:6px; }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('cleanup-table-body');
    const emptyState = document.getElementById('empty-state');

    function renderTable(items) {
        tableBody.innerHTML = '';
        if (items.length === 0) {
            emptyState.style.display = 'block';
            return;
        }
        emptyState.style.display = 'none';

        items.forEach(item => {
            const row = document.createElement('tr');
            row.setAttribute('data-pilot-id', item.id);
            row.innerHTML = `
                <td>${item.nickname}${item.real_name ? '（' + item.real_name + '）' : ''}</td>
                <td>[${item.owner_name}]</td>
                <td>${item.future_count}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-delete" data-pilot-id="${item.id}">删除所有通告</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    function handleDelete(pilotId) {
        if (!confirm('确定删除该主播明天开始的所有通告吗？此操作不可恢复。')) {
            return;
        }

        fetch(`/announcements/api/cleanup/by-pilot/${pilotId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.meta.message || '删除成功', 'success');
                const row = document.querySelector(`tr[data-pilot-id="${pilotId}"]`);
                if (row) {
                    row.remove();
                }
                if (tableBody.rows.length === 0) {
                    emptyState.style.display = 'block';
                }
            } else {
                const errorMsg = data.error?.message || '删除失败';
                showMessage(errorMsg, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('请求失败，请查看控制台', 'error');
        });
    }

    tableBody.addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-delete')) {
            const pilotId = event.target.getAttribute('data-pilot-id');
            handleDelete(pilotId);
        }
    });

    fetch('/announcements/api/cleanup/fallen-pilots')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderTable(data.data.items);
            } else {
                const errorMsg = data.error?.message || '加载数据失败';
                showMessage(errorMsg, 'error');
                emptyState.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('加载数据时出错，请查看控制台', 'error');
            emptyState.style.display = 'block';
        });
});
</script>
{% endblock %}