# 机师-分成管理

机师分成管理是机师管理模块的子模块，用于管理机师的分成比例调整记录，确保机师收入分配的准确性和可追溯性。

## 基本约定

- 分成管理是机师管理的子模块，入口在机师详情页面
- 机师分成比例影响机师流水的收入分配
- 所有分成调整记录都需要完整的历史追踪
- 分成调整记录支持软删除，不直接删除数据

## 分成计算规则

### 默认分成比例
- 当机师没有任何分成调整记录时，默认分成为 **20%**
- 机师流水分配计算：
  - 机师收入：`(20%/50%) * 42% = 16.8%`
  - 公司收入：`42% - 16.8% = 25.2%`
  - 其中 50% 和 42% 为系统固定参数

### 分成调整规则
- 分成调整记录按调整日期排序（非创建时间）
- 分成比例在调整日期当天生效
- 调整日期之前的分成比例保持不变
- 同一机师同一日期只能有一条有效调整记录
- **当前分成比例判断**：根据当前日期，找到调整日≤当前日期的最后一条记录作为生效记录
- **未来日期处理**：如果所有调整记录的调整日都是未来日期，则使用默认20%分成比例

### 分成计算示例
假设机师有以下调整记录：
- 2024-01-01：调整为 30%
- 2024-06-01：调整为 25%

则分成时间线为：
- 机师创建 - 2023-12-31：20%（默认）
- 2024-01-01 - 2024-05-31：30%
- 2024-06-01 - 现在：25%

## 分成调整记录

### 记录字段

| 字段 | 说明 | 参考类型 | 设定 |
|------|------|----------|------|
| ID | 系统中内部使用的唯一编码 | 由技术设计 | 必须 唯一 |
| 机师ID | 关联的机师ID | 关联到机师 | 必须 |
| 调整日 | 分成调整生效的日期（数据库存储UTC，UI显示GMT+8） | 日期 | 必须 |
| 调整值 | 新的分成比例（0-50，不需要%符号） | 数值型 | 必须 |
| 备注 | 调整原因或说明 | 字符串 | 非必须 |
| 是否有效 | 记录是否有效（无效=软删除） | 布尔值 | 必须，默认=true |
| 创建时间 | 创建本条记录的时间（数据库存储UTC，UI显示GMT+8） | 时间戳 | 必须，默认=当前时间UTC |
| 变更记录 | 记录所有修改日志 | 由独立模型持久化 | 非必须 |

### 业务规则

- 调整值范围：0-50（表示0%-50%）
- 同一机师同一调整日只能有一条有效记录
- 调整记录按调整日排序，与创建时间无关
- 软删除的记录不参与分成计算
- 调整记录创建后，调整日和调整值不可修改（只能软删除后重新创建）
- 调整日支持选择未来日期，用于提前安排分成调整

## 界面设计

### 机师详情页集成

在机师详情页面增加分成管理卡片：
- 显示当前有效分成比例
- 显示分成计算说明（机师收入、公司收入）
- 提供"调整分成"按钮进入分成管理页面

### 分成管理页面

#### 页面布局
- 页面标题：机师分成管理 - [机师昵称]
- 面包屑导航：机师管理 > 机师详情 > 分成管理
- 返回按钮：返回机师详情页面

#### 当前分成信息卡片
- 当前有效分成比例
- 分成计算说明
- 生效时间范围

#### 调整记录列表
- 按调整日降序排列（最新的在前）
- 显示字段：
  - 调整日
  - 调整值（带%符号）
  - 备注
  - 状态（有效/无效）
  - 创建时间
  - 操作按钮（编辑、软删除/恢复）

#### 操作按钮
- 新增调整记录
- 批量操作（如有需要）

### 新增/编辑调整记录

#### 表单字段
- 调整日：日期选择器
- 调整值：数字输入框（0-50）
- 备注：文本输入框

#### 验证规则
- 调整日必填
- 调整值必填，范围0-50
- 同一机师同一调整日不能有重复的有效记录
- 调整日支持选择未来日期

#### 操作按钮
- 保存
- 取消

## 权限控制

### 权限矩阵

| 功能 | 议长 | 舰长 |
|------|------|------|
| 查看机师分成信息 | ✅ | ✅ |
| 查看分成调整记录 | ✅ | ✅ |
| 新增分成调整记录 | ✅ | ✅ |
| 编辑分成调整记录 | ✅ | ✅ |
| 软删除分成调整记录 | ✅ | ✅ |

### 权限说明
- 议长和舰长权限一致
- 可以管理所有机师的分成调整记录
- 分成调整记录的操作需要记录操作用户和IP地址

## 数据验证

### 前端验证
- 调整值范围验证（0-50）
- 调整日格式验证
- 重复调整日验证
- 必填字段验证

### 后端验证
- 调整值范围验证
- 调整日有效性验证
- 同一机师同一调整日唯一性验证
- 业务规则验证

## 变更记录

### 记录内容
- 字段名
- 旧值
- 新值
- 变更时间
- 操作用户
- IP地址

### 记录范围
- 新增调整记录
- 修改调整记录
- 软删除/恢复调整记录

## 日志记录

### 关键操作日志
- 分成调整记录创建
- 分成调整记录修改
- 分成调整记录软删除/恢复
- 权限验证失败

### 日志级别
- INFO：正常操作记录
- ERROR：操作失败记录
- DEBUG：详细操作过程

### 接口预留
- 为其他模块提供机师某一日期的生效的分成比例查询接口
