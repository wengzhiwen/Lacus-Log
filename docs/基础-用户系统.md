# 基础-用户系统

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。
这是关于本系统中用户系统的设计说明。

## 技术选型

基于 **Flask-Security-Too** 实现用户认证和授权系统，提供完整的用户管理功能。

## 用户基础信息

### 用户模型字段

- **用户名** (`username`): 唯一标识，用于登录
- **密码** (`password`): 加密存储的登录密码（pbkdf2_sha512哈希）
- **昵称** (`nickname`): 用户显示名称
- **邮箱** (`email`): 可选字段，用于邮件报表收件。
- **角色** (`roles`): 用户权限角色列表（支持多角色）
- **激活状态** (`active`): 用户账户是否激活
- **创建时间** (`created_at`): 账户创建时间
- **唯一标识符** (`fs_uniquifier`): Flask-Security-Too要求的全局唯一标识
- **登录跟踪字段**:
  - `last_login_at`: 最后登录时间
  - `current_login_at`: 当前登录时间
  - `last_login_ip`: 最后登录IP
  - `current_login_ip`: 当前登录IP
  - `login_count`: 登录次数统计

## 按角色获取邮箱

提供 `User.get_emails_by_role(role_name: str|None = None, only_active: bool=True) -> list[str]` 方法：
- 当 `role_name` 为空或未提供时，返回所有用户的邮箱（可选仅激活）。
- 当提供 `role_name`（如`gicho`/`kancho`/`gunsou`）时，仅返回该角色用户的邮箱。
均会去重且忽略空值。

## 角色权限设计

### 角色定义

1. **管理员** (`gicho`)
   - 超级管理员角色
   - 拥有所有系统权限
   - 可以管理运营账户（增改查，不支持删除）
   - 可以重置运营密码
   - 可以切换用户激活状态
   - 系统自动创建首位管理员，只要数据库中一名管理员都没有就会创建
   - 默认用户名：zala，密码：plant4ever

2. **运营** (`kancho`)
   - 管理员角色
   - 拥有除用户管理外的所有模块权限
   - 可以查看系统状态和数据
   - 可以执行业务操作
   - 可以访问所有报表功能（周报、月报、底薪管理等）
   - 可以修改自己的密码

3. **助理运营** (`gunsou`)
   - 运营支持角色
   - 拥有日常运营功能的访问权限
   - 权限为运营角色的真子集
   - 可以访问：仪表盘、招募管理、通告管理、开播记录、日报等日常功能
   - 不能访问：周报、月报、底薪管理、底薪月报、招募月报等高级功能
   - 可以修改自己的密码

4. **主播** (`pilot`)
   - 第一期暂不实现
   - 预留角色，用于未来扩展

### 权限矩阵

| 功能模块 | 管理员 | 运营 | 助理运营 | 主播 |
|---------|------|------|----------|------|
| 用户管理 | ✅ | ❌ | ❌ | ❌ |
| 首页仪表盘 | ✅ | ✅ | ✅ | ❌ |
| 运营-BBS | ✅ | ✅ | ✅ | ❌ |
| 主播管理 | ✅ | ✅ | ✅ | ❌ |
| 主播招募 | ✅ | ✅ | ✅ | ❌ |
| 通告管理 | ✅ | ✅ | ✅ | ❌ |
| 开播记录 | ✅ | ✅ | ✅ | ❌ |
| 日报功能 | ✅ | ✅ | ✅ | ❌ |
| 周报功能 | ✅ | ✅ | ❌ | ❌ |
| 月报功能 | ✅ | ✅ | ❌ | ❌ |
| 底薪管理 | ✅ | ✅ | ❌ | ❌ |
| 底薪月报 | ✅ | ✅ | ❌ | ❌ |
| 招募月报 | ✅ | ✅ | ❌ | ❌ |
| 修改密码 | ✅ | ✅ | ✅ | ❌ |

注意！主播管理中的主播并不具有本系统的登录功能，严格意义上并不是本系统的用户

### 角色创建和管理

- 系统启动时自动创建所有角色：gicho、kancho、gunsou
- 管理员可以在用户管理界面创建kancho和gunsou角色用户
- 支持角色切换：管理员可以更改现有用户的角色
- 角色权限继承：gunsou权限是kancho权限的真子集

## 用户认证流程

### 登录流程

1. 用户访问登录页面（运营都由管理员在运营管理创建，所以不存在用户注册）
2. 输入用户名和密码
3. 系统验证凭据
4. 验证成功后创建会话
5. 重定向到用户主页

### 会话管理

- 使用 Flask-Security-Too 的会话管理
- 支持"记住我"功能
- 会话超时自动登出
- 支持强制登出
- 使用 `fs_uniquifier` 作为稳定的会话标识

## 用户管理功能

### 用户列表页面

**访问权限**: 仅管理员

**功能特性**:
- 显示管理员、运营和助理运营列表
- 支持按角色筛选（全部用户/管理员/运营/助理运营）
- 显示用户基本信息（用户名、昵称、角色、状态）
- 提供用户操作按钮（查看详情、切换激活状态、重置密码）
- 支持用户角色编辑
- 不允许停用最后一个管理员

### 用户详情页面

**访问权限**: 仅管理员

**功能特性**:
- 显示用户完整信息（用户名、昵称、角色、状态、创建时间、最后登录）
- 显示用户登录历史（最后登录时间、IP、登录次数）
- 提供用户操作按钮（切换激活状态、重置密码）

### 用户创建功能

**访问权限**: 仅管理员

**功能特性**:
- 创建新运营账户（可选择运营或助理运营角色）
- 输入验证：用户名长度3-20字符，密码至少6字符
- 用户名唯一性检查
- 用户名只能包含字母、数字、下划线和连字符
- 角色选择：可选择分配kancho（运营）或gunsou（助理运营）角色

### 不支持删除用户

- 当前系统不提供“删除用户”功能；因此其他文档中涉及“删除用户前的关联检查”等描述已失效，并已同步移除或更正。

### 密码管理

**用户自修改密码**:
- 访问权限：所有已登录用户
- 需要验证当前密码
- 新密码长度至少6字符
- 确认密码匹配验证

**管理员重置密码**:
- 访问权限：仅管理员
- 重置为临时密码 123456
- 需要通知用户尽快修改

## 安全考虑

### 密码安全

- 使用 Flask-Security-Too 的 pbkdf2_sha512 密码哈希算法
- 密码长度至少6个字符
- 用户修改密码需要验证当前密码

### 会话安全

- CSRF 保护
- 安全的会话 cookie 设置
- 会话超时机制
- 使用 fs_uniquifier 作为稳定的会话标识

### 访问控制

- 基于角色的访问控制 (RBAC)
- 路由级别的权限验证（@roles_required, @login_required）
- 用户激活状态检查

## 配置要求

### 环境变量

```bash
# Flask-Security-Too 配置
SECRET_KEY=your_secret_key_here
SECURITY_PASSWORD_SALT=your_password_salt_here

# 会话配置
SECURITY_REMEMBER_SALT=your_remember_salt_here
SECURITY_DEFAULT_REMEMBER_ME=True

# 会话超时（秒）
PERMANENT_SESSION_LIFETIME=36000

# MongoDB 连接
MONGODB_URI=mongodb://127.0.0.1:27017/lacus
```

### Flask-Security-Too 配置

- `SECURITY_REGISTERABLE=False`: 禁止用户自注册
- `SECURITY_RECOVERABLE=False`: 不启用邮件找回
- `SECURITY_CHANGEABLE=True`: 允许修改密码
- `SECURITY_TRACKABLE=True`: 启用登录跟踪
- `SECURITY_CONFIRMABLE=False`: 不启用邮箱确认
- `SECURITY_USERNAME_ENABLE=True`: 启用用户名登录
- `SECURITY_EMAIL_REQUIRED=False`: 不要求邮箱
