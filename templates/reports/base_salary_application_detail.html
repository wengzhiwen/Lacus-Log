{% extends "base.html" %}

{% block title %}åº•è–ªç”³è¯·è¯¦æƒ… - Lacus-Log{% endblock %}

{% block content %}
<section class="detail-page">
  <div class="page-container">
    <div class="page-header">
      <h1 class="page-title">åº•è–ªç”³è¯·è¯¦æƒ…</h1>
      <a href="javascript:history.back()" class="btn btn-secondary">
        <span class="btn-icon">â†</span>
        è¿”å›
      </a>
    </div>

    <!-- ä¸»æ’­ä¿¡æ¯å¡ç‰‡ -->
    <div class="info-card">
      <h3 class="card-title">ä¸»æ’­ä¿¡æ¯</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">æ˜µç§°</span>
          <span id="pilotNickname" class="info-value">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
          <span class="info-label">çœŸå®å§“å</span>
          <span id="pilotRealName" class="info-value">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
          <span class="info-label">ç›´å±è¿è¥</span>
          <span id="pilotOwner" class="info-value">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
          <span class="info-label">å½“å‰ç»“ç®—æ–¹å¼</span>
          <span id="currentSettlement" class="info-value">åŠ è½½ä¸­...</span>
        </div>
      </div>
    </div>

    <!-- å¼€æ’­è®°å½•å¡ç‰‡ -->
    <div class="info-card">
      <h3 class="card-title">å¼€æ’­è®°å½•ä¿¡æ¯</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">å¼€å§‹æ—¶é—´</span>
          <span id="battleStartTime" class="info-value">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
          <span class="info-label">æ—¶é•¿</span>
          <span id="battleDuration" class="info-value">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item full-width">
          <span class="info-label">æµæ°´é‡‘é¢</span>
          <span id="battleRevenue" class="info-value amount">åŠ è½½ä¸­...</span>
        </div>
      </div>
    </div>

    <!-- ç”³è¯·ä¿¡æ¯å¡ç‰‡ -->
    <div class="info-card">
      <h3 class="card-title">ç”³è¯·ä¿¡æ¯</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">ç»“ç®—æ–¹å¼ï¼ˆå¿«ç…§ï¼‰</span>
          <span id="settlementType" class="info-value">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
          <span class="info-label">ç”³è¯·åº•è–ªé‡‘é¢</span>
          <span id="baseSalaryAmount" class="info-value amount">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
          <span class="info-label">ç”³è¯·äºº</span>
          <span id="applicant" class="info-value">åŠ è½½ä¸­...</span>
        </div>
        <div class="info-item">
          <span class="info-label">ç”³è¯·æ—¶é—´</span>
          <span id="createdAt" class="info-value">åŠ è½½ä¸­...</span>
        </div>
      </div>
    </div>

    <!-- å‘æ”¾çŠ¶æ€å¡ç‰‡ -->
    <div class="info-card status-card">
      <h3 class="card-title">å‘æ”¾çŠ¶æ€</h3>
      <div class="status-display">
        <div class="status-value" id="statusDisplay">åŠ è½½ä¸­...</div>
        <div id="statusDetails" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e8e8e8;">
          <div class="status-detail">
            <span class="detail-label">æœ€è¿‘æ“ä½œäºº:</span>
            <span id="lastOperator" class="detail-value">æœªæ“ä½œ</span>
          </div>
          <div class="status-detail">
            <span class="detail-label">æ“ä½œæ—¶é—´:</span>
            <span id="lastOperatedAt" class="detail-value">--</span>
          </div>
        </div>
      </div>
    </div>

    <!-- çŠ¶æ€å˜æ›´æ“ä½œ -->
    <div class="info-card action-card">
      <h3 class="card-title">çŠ¶æ€ç®¡ç†</h3>
      <div class="action-buttons" id="actionButtons"></div>
    </div>

    <!-- å˜æ›´è®°å½• -->
    <div class="info-card">
      <h3 class="card-title">å˜æ›´è®°å½•</h3>
      <div id="changeLogList"></div>
      <div id="noChanges" class="empty-message">æš‚æ— å˜æ›´è®°å½•</div>
    </div>

    <div id="errorMessage" class="error-message" style="display:none;"></div>
  </div>
</section>

<!-- çŠ¶æ€å˜æ›´æ¨¡æ€æ¡† -->
<div id="statusChangeModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å˜æ›´ç”³è¯·çŠ¶æ€</h3>
      <button class="modal-close" onclick="closeStatusChangeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">æ–°çŠ¶æ€</label>
        <div id="newStatusDisplay" class="status-preview"></div>
      </div>
      <div class="form-group">
        <label for="remarkInput" class="form-label">æ“ä½œå¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label>
        <textarea id="remarkInput" class="form-input" rows="3" maxlength="200" placeholder="è¾“å…¥æ“ä½œè¯´æ˜"></textarea>
        <small style="color: #999;">
          <span id="charCount">0</span>/200
        </small>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeStatusChangeModal()">å–æ¶ˆ</button>
      <button type="button" class="btn btn-primary" id="confirmStatusChangeBtn" onclick="confirmStatusChange()">ç¡®è®¤å˜æ›´</button>
    </div>
  </div>
</div>

<style>

.detail-page {
  padding: 16px;
  max-width: 1000px;
  margin: 0 auto;
}

.page-container {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e0e0e0;
}

.page-title {
  font-size: 22px;
  font-weight: 600;
  color: #333;
  margin: 0;
}

.info-card {
  background: #f9f9f9;
  border: 1px solid #e8e8e8;
  border-radius: 6px;
  padding: 16px;
  margin-bottom: 16px;
}

.card-title {
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin: 0 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid #e8e8e8;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.info-item {
  display: flex;
  flex-direction: column;
}

.info-item.full-width {
  grid-column: 1 / -1;
}

.info-label {
  font-size: 12px;
  color: #999;
  margin-bottom: 4px;
  font-weight: 500;
}

.info-value {
  font-size: 14px;
  color: #333;
  font-weight: 500;
}

.info-value.amount {
  color: #8B0000;
  font-size: 16px;
}

.status-card {
  background: #f0fafe;
  border-color: #b3e5fc;
}

.status-display {
  padding: 8px 0;
}

.status-value {
  font-size: 16px;
  font-weight: 600;
  padding: 8px 12px;
  border-radius: 4px;
  display: inline-block;
}

.status-value.pending {
  background: #f5f5f5;
  color: #999;
}

.status-value.approved {
  background: #f6ffed;
  color: #52c41a;
}

.status-value.rejected {
  background: #fff2e6;
  color: #fa541c;
}

.status-detail {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
}

.detail-label {
  font-size: 12px;
  color: #666;
}

.detail-value {
  font-size: 12px;
  color: #333;
  font-weight: 500;
}

.action-card {
  background: #fafafa;
}

.action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn {
  padding: 10px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  border: none;
  transition: all 0.2s;
  font-weight: 500;
}

.btn-secondary {
  background: #f0f0f0;
  color: #333;
  border: 1px solid #ddd;
  text-decoration: none;
}

.btn-secondary:hover {
  background: #e8e8e8;
}

.btn-primary {
  background: #1890ff;
  color: white;
}

.btn-primary:hover {
  background: #1570cc;
}

.btn-success {
  background: #52c41a;
  color: white;
}

.btn-success:hover {
  background: #45a513;
}

.btn-danger {
  background: #fa541c;
  color: white;
}

.btn-danger:hover {
  background: #d4380d;
}

.btn:disabled {
  background: #bfbfbf;
  cursor: not-allowed;
  opacity: 0.6;
}

.btn-icon {
  margin-right: 4px;
}

#changeLogList {
  max-height: 300px;
  overflow-y: auto;
}

.change-log-item {
  background: #fff;
  border: 1px solid #e8e8e8;
  border-radius: 4px;
  padding: 10px;
  margin-bottom: 8px;
  font-size: 12px;
}

.change-field {
  font-weight: 500;
  margin-bottom: 4px;
}

.change-detail {
  color: #666;
  margin-left: 12px;
}

.empty-message {
  text-align: center;
  padding: 20px;
  color: #999;
  font-size: 12px;
}

.error-message {
  background: #fff2e6;
  border: 1px solid #ffbb96;
  border-radius: 4px;
  padding: 12px;
  color: #c6001a;
  font-size: 14px;
  margin-bottom: 16px;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  overflow: auto;
}

.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 0;
  border: 1px solid #888;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  flex-direction: column;
}

.modal-header {
  padding: 16px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
}

.modal-body {
  padding: 16px;
  flex: 1;
  overflow-y: auto;
}

.modal-footer {
  padding: 16px;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: #333;
  margin-bottom: 8px;
}

.form-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d9d9d9;
  border-radius: 4px;
  font-size: 14px;
  color: #333;
  box-sizing: border-box;
  font-family: inherit;
}

.status-preview {
  font-size: 14px;
  padding: 8px 12px;
  background: #f5f5f5;
  border-radius: 4px;
  color: #333;
}

@media (max-width: 600px) {
  .detail-page {
    padding: 12px;
  }

  .info-grid {
    grid-template-columns: 1fr;
  }

  .info-item.full-width {
    grid-column: 1;
  }

  .action-buttons {
    flex-direction: column;
  }

  .btn {
    width: 100%;
  }
}

</style>

<script>
const APPLICATION_ID = new URLSearchParams(window.location.search).get('id');
let applicationData = null;

async function initPage() {
  if (!APPLICATION_ID) {
    showError('ç¼ºå°‘ç”³è¯·IDå‚æ•°');
    return;
  }

  try {
    await loadApplicationDetail();
  } catch (error) {
    showError(error.message);
  }
}

async function loadApplicationDetail() {
  try {
    const response = await fetch(`/api/base-salary-applications/${APPLICATION_ID}`, {
      credentials: 'include'
    });

    if (!response.ok) {
      throw new Error('åŠ è½½ç”³è¯·è¯¦æƒ…å¤±è´¥');
    }

    const result = await response.json();
    if (!result.success) {
      throw new Error(result.error?.message || 'ç”³è¯·ä¸å­˜åœ¨');
    }

    applicationData = result.data;
    renderDetail();
    renderChangeLog();
  } catch (error) {
    showError(error.message);
  }
}

function renderDetail() {
  document.getElementById('pilotNickname').textContent = applicationData.pilot?.nickname || '--';
  document.getElementById('pilotRealName').textContent = applicationData.pilot?.real_name || '--';
  document.getElementById('pilotOwner').textContent = applicationData.pilot?.owner?.nickname || '--';
  document.getElementById('currentSettlement').textContent = applicationData.settlement_type;

  document.getElementById('battleStartTime').textContent = formatDateTime(applicationData.battle_record?.start_time) || '--';
  document.getElementById('battleDuration').textContent = (applicationData.battle_record?.duration_hours || 0) + ' å°æ—¶';
  document.getElementById('battleRevenue').textContent = 'Â¥' + (parseFloat(applicationData.battle_record?.revenue_amount || 0).toFixed(2));

  document.getElementById('settlementType').textContent = applicationData.settlement_type;
  document.getElementById('baseSalaryAmount').textContent = 'Â¥' + (parseFloat(applicationData.base_salary_amount || 0).toFixed(2));
  document.getElementById('applicant').textContent = applicationData.applicant?.nickname || '--';
  document.getElementById('createdAt').textContent = formatDateTime(applicationData.created_at) || '--';

  // çŠ¶æ€æ˜¾ç¤º
  const statusDisplay = document.getElementById('statusDisplay');
  statusDisplay.textContent = applicationData.status_display;
  statusDisplay.className = `status-value ${applicationData.status}`;

  // æ¸²æŸ“æ“ä½œæŒ‰é’®
  renderActionButtons();
}

function renderActionButtons() {
  const actionsDiv = document.getElementById('actionButtons');
  const status = applicationData.status;

  let buttons = [];

  if (status === 'pending' || status === 'rejected') {
    buttons.push(`<button class="btn btn-success" onclick="prepareStatusChange('approved')">âœ“ ç¡®è®¤å‘æ”¾</button>`);
  }

  if (status === 'pending' || status === 'approved') {
    buttons.push(`<button class="btn btn-danger" onclick="prepareStatusChange('rejected')">âœ— æ‹’ç»å‘æ”¾</button>`);
  }

  if (status === 'approved' || status === 'rejected') {
    buttons.push(`<button class="btn btn-secondary" onclick="prepareStatusChange('pending')">â†º å›åˆ°æœªå¤„ç†</button>`);
  }

  buttons.push(`<button class="btn btn-secondary" onclick="loadChangeLog()">ğŸ“‹ å˜æ›´è®°å½•è¯¦æƒ…</button>`);

  if (buttons.length === 0) {
    actionsDiv.innerHTML = '<p style="color: #999;">æ— å¯ç”¨æ“ä½œ</p>';
  } else {
    actionsDiv.innerHTML = buttons.join('');
  }
}

function prepareStatusChange(newStatus) {
  const statusMap = {
    'pending': 'æœªå¤„ç†',
    'approved': 'å·²å‘æ”¾',
    'rejected': 'æ‹’ç»å‘æ”¾'
  };

  document.getElementById('newStatusDisplay').textContent = statusMap[newStatus] || 'æœªçŸ¥';
  document.getElementById('remarkInput').value = '';
  document.getElementById('charCount').textContent = '0';
  document.getElementById('confirmStatusChangeBtn').setAttribute('data-new-status', newStatus);
  document.getElementById('statusChangeModal').style.display = 'block';
}

document.getElementById('remarkInput').addEventListener('input', (e) => {
  document.getElementById('charCount').textContent = e.target.value.length;
});

async function confirmStatusChange() {
  const newStatus = document.getElementById('confirmStatusChangeBtn').getAttribute('data-new-status');
  const remark = document.getElementById('remarkInput').value.trim();
  const btn = document.getElementById('confirmStatusChangeBtn');

  btn.disabled = true;

  try {
    const response = await fetch(`/api/base-salary-applications/${APPLICATION_ID}/status`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        status: newStatus,
        remark: remark || null
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error?.message || 'çŠ¶æ€å˜æ›´å¤±è´¥');
    }

    closeStatusChangeModal();
    await loadApplicationDetail();
    alert('âœ… çŠ¶æ€å˜æ›´æˆåŠŸ');
  } catch (error) {
    alert('âŒ ' + error.message);
    btn.disabled = false;
  }
}

function closeStatusChangeModal() {
  document.getElementById('statusChangeModal').style.display = 'none';
}

async function renderChangeLog() {
  try {
    const response = await fetch(`/api/base-salary-applications/${APPLICATION_ID}/changes`, {
      credentials: 'include'
    });

    if (!response.ok) {
      return;
    }

    const result = await response.json();
    if (result.success && result.data.items && result.data.items.length > 0) {
      const logs = result.data.items;
      const listDiv = document.getElementById('changeLogList');
      const noChanges = document.getElementById('noChanges');

      listDiv.innerHTML = logs.map(log => `
        <div class="change-log-item">
          <div class="change-field">${log.field_display_name}</div>
          <div class="change-detail">æ—§å€¼: ${log.old_value || '(æ— )'}</div>
          <div class="change-detail">æ–°å€¼: ${log.new_value || '(æ— )'}</div>
          ${log.remark ? `<div class="change-detail">å¤‡æ³¨: ${log.remark}</div>` : ''}
          <div class="change-detail" style="color: #999; margin-top: 4px;">
            ${log.user?.nickname || 'æœªçŸ¥'} - ${formatDateTime(log.change_time) || '--'}
          </div>
        </div>
      `).join('');

      noChanges.style.display = 'none';
    }
  } catch (error) {
    console.error('åŠ è½½å˜æ›´è®°å½•å¤±è´¥:', error);
  }
}

function loadChangeLog() {
  alert('å˜æ›´è®°å½•å·²åœ¨ä¸‹æ–¹å±•ç¤º');
}

function formatDateTime(isoString) {
  if (!isoString) return '--';
  try {
    const date = new Date(isoString);
    return date.toLocaleString('zh-CN');
  } catch {
    return '--';
  }
}

function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
}

window.onclick = function(event) {
  const modal = document.getElementById('statusChangeModal');
  if (event.target === modal) {
    modal.style.display = 'none';
  }
}

document.addEventListener('DOMContentLoaded', initPage);
</script>
{% endblock %}
