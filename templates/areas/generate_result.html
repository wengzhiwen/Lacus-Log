{% extends 'base.html' %}
{% block title %}生成结果 - Lacus-Log{% endblock %}
{% block content %}
<section class="area-generate-result">
  <div class="page-header"><h1 class="page-title">生成结果</h1></div>

  <div class="info-card">
    <div class="row"><span class="label">源基地</span><span class="value" id="result-source-x">-</span></div>
    <div class="row"><span class="label">源场地</span><span class="value" id="result-source-y">-</span></div>
    <div class="row"><span class="label">生成数量</span><span class="value" id="result-count">0</span></div>
  </div>

  <ul class="result-list" id="result-list"></ul>
</section>

<div class="footbar">
  <div class="inner">
    <a class="btn btn-primary" href="{{ url_for('battle_area.list_areas') }}">确认</a>
  </div>
</div>

<style>
.info-card { background: #fff; border: 1px solid var(--table-header); border-radius: 8px; padding: 14px; }
.info-card .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--table-header); }
.info-card .row:last-child { border-bottom: none; }
.result-list { margin-top: 12px; background: #fff; border: 1px solid var(--table-header); border-radius: 8px; padding: 12px; }
.result-item { padding: 8px 0; border-bottom: 1px solid var(--table-header); }
.result-item:last-child { border-bottom: none; }
.footbar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid var(--table-header); box-shadow: 0 -2px 8px rgba(0,0,0,0.06); padding: 10px 12px calc(env(safe-area-inset-bottom, 0) + 10px) 12px; z-index: 100; }
.footbar .inner { display: flex; justify-content: center; }
.container { padding-bottom: 88px; }
</style>
<script>
const resultAreaId = '{{ area_id }}';
const storageKey = `battle-area-generate-result:${resultAreaId}`;

function renderResults(data) {
  document.getElementById('result-source-x').textContent = data.source?.x_coord || '-';
  document.getElementById('result-source-y').textContent = data.source?.y_coord || '-';
  const created = data.created || [];
  document.getElementById('result-count').textContent = created.length;

  const list = document.getElementById('result-list');
  list.innerHTML = '';
  if (created.length === 0) {
    const placeholder = document.createElement('li');
    placeholder.className = 'result-item';
    placeholder.textContent = '未生成任何开播地点';
    list.appendChild(placeholder);
    return;
  }

  created.forEach(item => {
    const li = document.createElement('li');
    li.className = 'result-item';
    li.textContent = `${item.x_coord} - ${item.y_coord} - ${item.z_coord}`;
    list.appendChild(li);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const cached = sessionStorage.getItem(storageKey);
  if (!cached) {
    showMessage('缺少生成结果，请重新操作', 'error');
    setTimeout(() => {
      window.location.href = `/areas/${resultAreaId}/generate`;
    }, 1200);
    return;
  }

  try {
    const data = JSON.parse(cached);
    renderResults(data);
  } catch (error) {
    console.error('解析生成结果失败:', error);
    showMessage('解析生成结果失败，请重试', 'error');
    setTimeout(() => {
      window.location.href = `/areas/${resultAreaId}/generate`;
    }, 1200);
    return;
  } finally {
    sessionStorage.removeItem(storageKey);
  }
});
</script>
{% endblock %}
