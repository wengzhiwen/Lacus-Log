# 主播-通告（技术设计，原文件名“机师-作战计划（技术设计）”）

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；参战形式→开播方式；战斗区域→开播地点；阶级→主播分类；所属→直属运营；X坐标→基地；Y坐标→场地；Z坐标→坐席；作战计划→通告。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。
## 概述

本文档基于业务需求文档《主播-通告.md》，设计通告管理功能的技术实现方案。通告管理是系统的核心排程模块，需要提供类似日历应用的重复事件管理、时间冲突检查、资源占用验证等功能。

## 技术架构

### 技术栈
- **后端**: Flask + MongoEngine
- **前端**: Jinja2模板 + 自定义CSS + JavaScript
- **数据库**: MongoDB
- **权限控制**: Flask-Security-Too
- **日志系统**: Python logging模块
- **时间处理**: Python datetime + pytz

### 设计原则
- 遵循现有项目的代码风格和技术模式
- 保持与主播管理、开播地点管理模块的一致性
- 实现类似日历应用的重复事件管理机制
- 确保时间冲突检查和资源占用验证的准确性
- 提供良好的用户体验和错误处理

## 数据模型设计

### Announcement（通告）模型

#### 字段设计
- **关联信息字段**：
  - `pilot`: 关联主播（关联到Pilot模型的ObjectId，使用ReferenceField）
  - `battle_area`: 关联开播地点（关联到BattleArea模型的ObjectId，使用ReferenceField）

- **坐标快照字段**（初次登记通告时从开播地点复制过来，用于显示，避免关联数据变更影响历史记录）：
  - `x_coord`: 基地快照（字符串）
  - `y_coord`: 场地快照（字符串）
  - `z_coord`: 坐席快照（字符串）

- **时间信息字段**：
  - `start_time`: 开始时间（UTC时间戳）
  - `duration_hours`: 计划时长（小时数，支持0.5步进）
  - `end_time`: 结束时间（计算字段，start_time + duration_hours）

- **重复规则字段**：
  - `recurrence_type`: 重复类型（枚举：无重复/每日/每周/每月/自定义）
  - `recurrence_pattern`: 重复模式（JSON格式，存储具体的重复规则）
  - `recurrence_end`: 重复结束时间（UTC时间戳，可选）
  - `parent_announcement`: 父通告ID（用于关联重复事件组）

- **系统字段**：
  - `created_at`: 创建时间（自动设置）
  - `updated_at`: 最后修改时间（自动更新）
  - `created_by`: 创建用户（关联到User模型的ObjectId）

#### 枚举类型定义
- **RecurrenceType**: 重复类型枚举（NONE=无重复, DAILY=每日, WEEKLY=每周, CUSTOM=自定义）

#### 重复模式JSON结构

**无重复 (NONE)**：
```json
null
```

**每日重复 (DAILY)**：
```json
{
  "type": "daily",
  "interval": 1,  // 每隔几天重复，1=每天，2=每两天
  "end_date": "2024-12-31T23:59:59Z"
}
```

**每周重复 (WEEKLY)**：
```json
{
  "type": "weekly",
  "interval": 1,  // 每隔几周重复
  "days_of_week": [1, 3, 5],  // 1=周一, 3=周三, 5=周五
  "end_date": "2024-12-31T23:59:59Z"
}
```

**自定义重复 (CUSTOM)**：
```json
{
  "type": "custom",
  "specific_dates": [
    "2024-09-09T14:00:00Z",
    "2024-09-12T14:00:00Z",
    "2024-09-15T14:00:00Z"
  ]  // 具体指定的N个日期时间
}
```

### 冲突记录持久化策略（与实现对齐）

当前实现未引入独立的 `AnnouncementConflict` 持久化模型。冲突检查逻辑由 `Announcement.check_conflicts(...)` 方法在运行时动态计算并返回结构化结果（区分区域冲突与主播冲突）。如未来需要对冲突进行长期留存与分析，可在此基础上扩展独立模型。

### AnnouncementChangeLog（变更记录）模型

#### 字段设计
- `announcement_id`: 关联的通告ID（关联到Announcement模型的ObjectId，使用ReferenceField）
- `user_id`: 操作用户ID（关联到User模型的ObjectId，使用ReferenceField）
- `field_name`: 变更的字段名
- `old_value`: 变更前的值
- `new_value`: 变更后的值
- `change_time`: 变更时间
- `ip_address`: 操作IP地址

#### 字段显示名称映射
- `pilot`: 关联主播
- `battle_area`: 关联开播地点
- `x_coord`: 基地
- `y_coord`: 场地
- `z_coord`: 坐席
- `start_time`: 开始时间
- `duration_hours`: 计划时长
- `recurrence_type`: 重复类型
- `recurrence_pattern`: 重复模式
- `recurrence_end`: 重复结束时间

### 数据库索引设计

#### Announcement集合索引
- `pilot + start_time` 复合索引（用于查询主播的通告）
- `battle_area + start_time` 复合索引（用于查询开播地点的占用）
- `start_time` 索引（用于按时间排序）
- `parent_announcement` 索引（用于查询重复事件组）
- `created_by` 索引（用于权限控制）
- `-start_time` 降序索引（用于列表页排序）

#### AnnouncementConflict集合索引
- `announcement_id` 索引（用于查询特定通告的冲突）
- `conflict_time` 索引（用于按时间查询冲突）

#### AnnouncementChangeLog集合索引
- `announcement_id + change_time` 复合索引（用于查询通告变更历史）
- `user_id` 索引（用于查询用户操作记录）
- `change_time` 索引（用于按时间范围查询）

## 路由设计

### 路由结构
- 创建独立的 `routes/announcement.py` 模块
- 使用蓝图 `announcement_bp` 管理所有通告相关路由
- 路由前缀：`/announcements`

### 路由列表

#### 1. 通告列表页面 (`/announcements/`)
- **功能**: 显示通告列表，支持筛选和排序
- **权限**: 管理员和运营
- **筛选条件**: 直属运营、主播分类、基地、场地
- **权限控制**: 管理员和运营都可以看到所有通告
- **排序**: 按通告“本地通告日”升序、同日按主播昵称字典顺序排列（在应用层排序）
- **分页**: 一次显示100条，支持滚动加载更多

#### 2. 通告详情页面 (`/announcements/<announcement_id>`)
- **功能**: 显示单个通告的详细信息
- **权限**: 管理员和运营
- **权限控制**: 管理员和运营都可以查看所有通告
- **操作按钮**: 编辑、删除

#### 3. 通告新建页面 (`/announcements/new`)
- **功能**: 创建新通告
- **权限**: 管理员和运营
- **表单验证**: 时间冲突检查、资源占用验证
- **重复规则**: 支持最大跨度60天的循环设置
- **检查机制**: 必须先通过检查才能提交

#### 4. 通告编辑页面 (`/announcements/<announcement_id>/edit`)
- **功能**: 编辑通告信息
- **权限**: 管理员和运营
- **权限控制**: 管理员和运营都可以编辑所有通告
- **重复处理**: 支持只修改当前事件或修改整个循环组

#### 5. 冲突检查API (`/announcements/check-conflicts`)
- **功能**: 检查时间冲突和资源占用
- **方法**: POST
- **权限**: 管理员和运营
- **返回**: JSON格式的冲突检查结果

#### 6. 重复事件生成API (`/announcements/generate-recurrence`)
- **功能**: 根据重复规则生成具体的事件实例
- **方法**: POST
- **权限**: 管理员和运营
- **返回**: JSON格式的生成结果

#### 7. 变更记录API (`/announcements/<announcement_id>/changes`)
- **功能**: 获取通告的变更历史记录
- **方法**: GET
- **权限**: 管理员和运营
- **权限控制**: 管理员和运营都可以查看所有通告的变更记录
- **返回**: JSON格式的变更记录列表
- **限制**: 最多返回100条变更记录

#### 8. 导出页面 (`/announcements/export`)
- **功能**: 生成指定主播在指定月份的通告预定表
- **方法**: GET/POST
- **权限**: 管理员和运营
- **说明**: 该功能的业务说明详见《主播-通告导出.md》，此处统一列出路由以便检索

## 前端模板设计

### 模板结构
```
templates/announcements/
├── list.html              # 通告列表页面
├── detail.html            # 通告详情页面
├── new.html               # 新建通告页面
├── edit.html              # 编辑通告页面
└── conflict_check.html    # 冲突检查结果组件
```

### 列表页面设计
- **布局**: 卡片式布局，与现有模块保持一致
- **筛选器**: 可折叠的筛选条件，支持直属运营、主播分类、基地、场地筛选
- **卡片内容**: 主播信息、开播地点坐标、时间信息、重复标识
- **交互**: 整个卡片可点击，悬停效果
- **空状态**: 无数据时的友好提示
- **滚动加载**: 支持无限滚动加载更多数据

### 详情页面设计
- **布局**: 信息卡片分组显示（基础信息、时间信息、重复信息）
- **操作按钮**: 编辑、删除、变更记录按钮
- **信息展示**: 清晰的标签-值对布局
- **重复信息**: 显示重复规则和关联事件
- **变更记录**: 模态框弹窗显示变更历史

### 新建/编辑页面设计
- **表单布局**: 分组表单，清晰的字段组织
- **坐标选择**: 三联动下拉选择（X、Y、坐席）
- **主播选择**: 三联选择（直属运营、主播分类、主播昵称）
- **时间选择**: 日期时间选择器，支持时长设置（0.5小时步进）
- **重复设置**: 类似日历应用的重复规则设置
- **冲突检查**: 实时冲突检查和结果展示
- **验证提示**: 实时验证和错误提示

### 冲突检查组件设计
- **显示方式**: 在检查按钮和提交按钮之间显示
- **检查结果**: 列出所有可能的开播计划
- **冲突标识**: 清晰标识冲突类型和原因
- **交互反馈**: 检查通过后启用提交按钮

### 变更记录组件设计
- **显示方式**: 模态框弹窗
- **记录格式**: 时间、操作用户、字段名、旧值、新值
- **排序**: 按变更时间降序
- **限制**: 最多显示100条记录
- **异步加载**: 使用AJAX异步获取变更记录

## 权限控制设计

### 权限矩阵

| 功能 | 管理员 | 运营 |
|------|------|------|
| 查看所有通告 | ✅ | ✅ |
| 查看自己主播的通告 | ✅ | ✅ |
| 创建通告 | ✅ | ✅ |
| 编辑通告 | ✅ | ✅ |
| 删除通告 | ✅ | ✅ |
| 查看冲突信息 | ✅ | ✅ |
| 查看变更记录 | ✅ | ✅ |

### 权限检查机制
- **角色验证**: 使用 `@roles_accepted` 装饰器进行路由级权限控制
- **数据级权限**: 在业务逻辑中检查用户对特定主播的操作权限
- **运营权限**: 运营权限与管理员相同，可以操作所有通告
- **管理员特权**: 管理员拥有所有通告的管理权限

## 数据验证和业务规则

### 前端验证
- **实时验证**: 表单提交前的客户端验证
- **时间验证**: 开始时间不能早于当前时间
- **时长验证**: 时长必须在1-16小时之间，支持0.5小时步进
- **重复规则**: 重复结束时间不能超过60天跨度
- **必填字段**: 主播、开播地点、开始时间、时长的必填验证
- **坐标验证**: Y、坐席不可为空的验证

### 后端验证
- **数据完整性**: 使用MongoEngine的clean()方法进行模型级验证
- **业务规则**: 时间冲突检查、资源占用验证
- **重复规则**: 重复模式的JSON格式验证
- **枚举验证**: 确保枚举字段值的有效性

### 业务规则验证
- **时间规则**: 开始时间不能早于当前时间
- **时长规则**: 时长必须在1-16小时之间
- **重复规则**: 重复跨度不能超过60天
- **坐标规则**: Y、坐席不可为空
- **冲突检查**: 同一开播地点在同一时间段不能有多个通告
- **主播冲突**: 同一主播在同一时间段不能有多个通告

## 重复事件管理

### 重复规则设计
- **无重复**: 单次事件
- **每日重复**: 每天同一时间
- **每周重复**: 每周特定几天的同一时间
- **自定义重复**: 直接选具体的N个日期，这几个日期的同一时间

### 重复事件生成
- **规则解析**: 解析重复规则JSON，生成具体的时间点
- **冲突检查**: 对每个生成的时间点进行冲突检查
- **批量创建**: 一次性创建所有重复事件
- **关联管理**: 使用parent_announcement字段关联重复事件组

### 重复事件编辑
- **编辑选项**: 只编辑当前事件、编辑整个循环组、编辑未来事件；一旦使用了编辑未来通告的功能，就要对循环组进行断开重组
- **影响范围**: 根据用户选择确定影响的事件范围
- **冲突处理**: 编辑时重新进行冲突检查
- **时间限制**: 编辑未来所有循环时，开始时间的日期部分不可修改，只能修改时间部分，确保循环事件的日期规律不被破坏

## 变更记录系统

### 变更记录机制
- **自动记录**: 编辑通告时自动记录所有字段变更
- **记录内容**: 字段名、旧值、新值、操作时间、操作用户、IP地址
- **批量保存**: 一次编辑的多个字段变更批量记录
- **查询优化**: 按通告ID和时间排序的复合索引

### 变更记录查询
- **历史查询**: 按通告查询变更历史
- **用户查询**: 按操作用户查询操作记录
- **时间范围**: 支持按时间范围查询变更记录
- **记录限制**: 最多显示100条变更记录

### 变更记录字段映射
- **关联字段**: 关联主播、关联开播地点
- **坐标字段**: 基地、场地、坐席（快照值）
- **时间字段**: 开始时间、计划时长
- **重复字段**: 重复类型、重复模式、重复结束时间

## 冲突检查系统

### 冲突类型
- **区域冲突**: 同一开播地点在同一时间段被多个通告占用
- **主播冲突**: 同一主播在同一时间段有多个通告

### 冲突检查算法
- **时间范围计算**: 根据开始时间和时长计算占用时间段
- **数据库查询**: 查询同一时间段内的其他通告
- **冲突检测**: 比较时间范围，检测重叠
- **结果汇总**: 汇总所有冲突信息

### 冲突检查API
- **输入参数**: 主播ID、开播地点ID、开始时间、时长、重复规则
- **检查逻辑**: 生成所有可能的时间点，逐一检查冲突
- **返回结果**: JSON格式的冲突检查结果

## 辅助性API（前端交互支持）

- 获取场地：GET `/announcements/api/areas/<x_coord>` → 返回 `y_coords`
- 获取坐席：GET `/announcements/api/areas/<x_coord>/<y_coord>` → 返回可选Z及对应区域ID
- 获取主播（按直属运营）：GET `/announcements/api/pilots/by-owner/<owner_id>`
- 获取主播筛选器：GET `/announcements/api/pilot-filters`
- 获取筛选后的主播：GET `/announcements/api/pilots-filtered?owner=<id>&rank=<枚举>`

## 日志记录

### 日志配置
- **独立日志**: 通告管理模块使用独立的日志文件
- **日志轮转**: 按自然日切分日志文件
- **日志级别**: INFO级别记录关键操作，ERROR级别记录异常

### 关键操作日志
- **创建操作**: 记录通告创建和操作用户
- **更新操作**: 记录通告更新和操作用户
- **删除操作**: 记录通告删除和操作用户
- **冲突检查**: 记录冲突检查的结果
- **变更记录**: 记录变更记录的创建和查询
- **错误记录**: 记录操作失败和错误信息

## 性能优化

### 数据库查询优化
- **索引策略**: 为常用查询字段创建合适的索引
- **查询优化**: 避免N+1查询问题
- **分页支持**: 为大量数据提供分页查询
- **缓存策略**: 对不经常变化的数据进行缓存

### 前端优化
- **异步加载**: 冲突检查使用AJAX异步加载
- **变更记录**: 变更记录使用AJAX异步加载
- **表单优化**: 前端实时验证减少服务器请求
- **响应式设计**: 确保在移动设备上的良好体验
- **资源优化**: 合理使用CSS和JavaScript资源

## 安全考虑

### 数据安全
- **输入验证**: 严格验证所有用户输入数据
- **权限控制**: 确保用户只能访问有权限的数据
- **时间验证**: 防止时间相关的安全漏洞
- **JSON注入防护**: 安全处理重复规则的JSON数据

### 业务安全
- **业务规则**: 严格执行业务规则验证
- **数据完整性**: 确保关联数据的一致性
- **错误处理**: 优雅处理各种异常情况
- **敏感信息**: 合理处理敏感信息的显示和存储

## 扩展性设计

### 未来扩展点
- **日历视图**: 添加日历视图显示通告
- **批量操作**: 支持批量编辑、导入导出功能
- **统计分析**: 添加通告数据统计分析功能
- **通知系统**: 添加通告提醒和通知功能
- **API接口**: 为其他模块提供通告数据API

### 接口预留
- **内部API**: 为系统内部模块提供通告数据接口
- **数据格式**: 支持JSON格式的数据交换
- **权限继承**: API接口继承现有的权限控制机制

## 测试策略

### 单元测试（pytest）
- **模型测试**: 测试通告模型的创建、验证、保存
- **业务规则**: 测试各种业务规则验证
- **重复规则**: 测试重复规则的解析和生成
- **冲突检查**: 测试冲突检查算法的正确性
- **变更记录**: 测试变更记录的正确性


## 部署和配置

### 环境变量
- **可选配置**: 通告相关参数可通过环境变量配置
- **默认值**: 提供合理的默认配置值
- **向后兼容**: 不破坏现有配置结构

### 数据库初始化
- **索引创建**: 应用启动时自动创建必要的数据库索引
- **错误处理**: 索引创建失败时的错误处理和日志记录
- **性能优化**: 为常用查询创建复合索引

## 总结

本技术设计文档详细规划了通告管理功能的实现方案

该设计遵循项目现有的技术架构和代码风格，确保与现有系统的良好集成，同时为通告管理功能提供了完整、安全、可扩展的实现方案。特别注重了类似日历应用的用户体验，包括重复事件管理、时间冲突检查、变更记录等核心功能。
