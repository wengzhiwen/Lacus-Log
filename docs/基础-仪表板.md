# 基础-仪表板设计

## 概述

仪表板是用户首页的核心组件，用于展示关键业务数据的统计信息。采用卡片式设计，支持响应式布局，确保在移动端和桌面端都有良好的用户体验。

## 设计原则

- **数据层次化**：主要数据突出显示，副数据作为补充信息
- **响应式设计**：移动端优先，桌面端优化
- **视觉一致性**：与整体UI风格保持一致
- **信息密度适中**：避免信息过载，保持清晰可读

## 卡片设计规范

### 基本结构

每个卡片包含以下基本元素：
- **卡片头部**：标题 + 图标
- **卡片主体**：主要数据 + 副数据（可选）

### 三种卡片布局模式

#### 1. 单主要数据卡片
适用于只需要展示一个核心指标的场景。

**HTML结构：**
```html
<div class="card">
  <div class="card-header">
    <div class="card-title">数据标题</div>
    <div class="card-icon">📊</div>
  </div>
  <div class="card-body">
    <div class="main-data">
      <div class="main-value">123</div>
      <div class="main-label">数据说明</div>
    </div>
  </div>
</div>
```

**CSS样式：**
```css
.card-body {
  padding: 0;
}

.main-data {
  text-align: center;
  padding: 20px 0;
}

.main-value {
  font-size: 36px;
  font-weight: 700;
  color: var(--brand);
  margin-bottom: 8px;
  line-height: 1;
}

.main-label {
  font-size: 16px;
  color: var(--text);
  font-weight: 600;
}
```

#### 2. 1个主要数据 + 1个副数据卡片
适用于需要展示核心指标和1个相关补充信息的场景。

**HTML结构：**
```html
<div class="card">
  <div class="card-header">
    <div class="card-title">数据标题</div>
    <div class="card-icon">📊</div>
  </div>
  <div class="card-body">
    <div class="main-data">
      <div class="main-value">123</div>
      <div class="main-label">主要数据说明</div>
    </div>
    <div class="sub-data">
      <div class="sub-item">
        <div class="sub-value">+15.2%</div>
        <div class="sub-label">副数据说明</div>
      </div>
    </div>
  </div>
</div>
```

**CSS样式：**
```css
.main-data {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--table-header);
}

.sub-data {
  display: flex;
  justify-content: center;
  gap: 20px;
}

.sub-item {
  text-align: center;
}

.sub-value {
  font-size: 20px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
  line-height: 1;
}

.sub-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}
```

#### 3. 1个主要数据 + 2个副数据卡片（当前实现）
适用于需要展示核心指标和2个相关补充信息的场景。

**HTML结构：**
```html
<div class="card">
  <div class="card-header">
    <div class="card-title">数据标题</div>
    <div class="card-icon">📊</div>
  </div>
  <div class="card-body">
    <div class="main-data">
      <div class="main-value">123</div>
      <div class="main-label">主要数据说明</div>
    </div>
    <div class="sub-data">
      <div class="sub-item">
        <div class="sub-value positive">+15.2%</div>
        <div class="sub-label">副数据1</div>
      </div>
      <div class="sub-item">
        <div class="sub-value">8.5</div>
        <div class="sub-label">副数据2</div>
      </div>
    </div>
  </div>
</div>
```

**CSS样式：**
```css
.main-data {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--table-header);
}

.sub-data {
  display: flex;
  justify-content: space-around;
  gap: 20px;
}

.sub-item {
  text-align: center;
  flex: 1;
}

.sub-value {
  font-size: 20px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
  line-height: 1;
}

.sub-value.positive {
  color: var(--hud-green);
}

.sub-value.negative {
  color: var(--error);
}

.sub-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}
```

## 通用样式规范

### 卡片基础样式
```css
.card { 
  border: 1px solid var(--gray); 
  border-radius: 12px; 
  padding: 20px; 
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: all 0.2s ease;
}

.card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  transform: translateY(-2px);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.card-title { 
  font-weight: 600; 
  font-size: 16px;
  color: var(--text); 
  margin: 0;
}

.card-icon {
  font-size: 24px;
  opacity: 0.7;
}
```

### 颜色规范
- **主要数据**：使用品牌色 `var(--brand)` (#8B0000)
- **正数变化**：使用绿色 `var(--hud-green)` (#00B37A)
- **负数变化**：使用红色 `var(--error)` (#FF4500)
- **普通副数据**：使用文本色 `var(--text)` (#111111)
- **标签文字**：使用灰色 `var(--muted)` (#666666)

### 字体规范
- **主要数据数值**：36px，粗体，行高1
- **主要数据标签**：16px，中等粗细
- **副数据数值**：20px（移动端）/ 24px（桌面端），中等粗细
- **副数据标签**：12px（移动端）/ 14px（桌面端），中等粗细

## 响应式设计

### 移动端（默认）
- 卡片宽度自适应屏幕宽度
- 副数据间距：20px
- 副数据字体：20px

### 桌面端（768px+）
- 卡片最大宽度：600px，居中显示
- 副数据间距：40px
- 副数据字体：24px

```css
@media (min-width: 768px) {
  .dashboard .cards {
    max-width: 600px;
    margin: 0 auto;
  }
  
  .sub-data {
    gap: 40px;
  }
  
  .sub-value {
    font-size: 24px;
  }
  
  .sub-label {
    font-size: 14px;
  }
}
```

## 布局容器

### 卡片容器
```css
.dashboard .cards { 
  display: grid; 
  grid-template-columns: 1fr; 
  gap: 16px; 
}
```

### 页面结构
```html
<section class="dashboard">
  <h1 class="title">仪表盘</h1>
  <div class="cards">
    <!-- 卡片内容 -->
  </div>
</section>
```

## 使用指南

### 创建新卡片步骤

1. **确定数据类型**：根据业务需求选择1种、2种或3种数据布局
2. **选择图标**：使用合适的emoji图标，建议使用📊📈📅📋等
3. **编写HTML**：按照对应的HTML结构模板编写
4. **应用样式**：确保使用正确的CSS类名
5. **测试响应式**：在不同屏幕尺寸下测试显示效果

### 数据计算建议

- **主要数据**：选择最核心的业务指标
- **副数据**：选择与主要数据相关的补充信息
- **数值格式**：百分比保留1位小数，其他数值根据精度需求确定
- **颜色应用**：正负变化使用颜色区分，普通数值使用默认颜色

## 示例实现

### 征召统计卡片

征召统计卡片展示征召流程的关键指标，采用1个主要数据 + 2个副数据的布局模式：

**后端数据计算：**
```python
def _calculate_dashboard_data():
    """计算仪表板数据"""
    now = get_current_utc_time()
    
    # 征召统计（使用本地时间进行日期归属，与征召日报保持一致）
    # 获取今日的本地时间范围
    current_local = utc_to_local(now)
    today_local_start = current_local.replace(hour=0, minute=0, second=0, microsecond=0)
    today_local_end = today_local_start + timedelta(days=1)
    
    # 转换为UTC时间范围
    today_start_utc = local_to_utc(today_local_start)
    today_end_utc = local_to_utc(today_local_end)
    
    # 今日约面：今日创建的征召数量
    recruit_today_appointments = Recruit.objects(created_at__gte=today_start_utc, created_at__lt=today_end_utc).count()
    
    # 今日到面：今日发生的面试决策数量（新六步制 + 历史兼容）
    from mongoengine import Q
    interviews_query = (
        Q(interview_decision_time__gte=today_start_utc, interview_decision_time__lt=today_end_utc) |
        Q(training_decision_time_old__gte=today_start_utc, training_decision_time_old__lt=today_end_utc)
    )
    recruit_today_interviews = Recruit.objects.filter(interviews_query).count()
    
    # 今日新开播：今日在开播决策中决定征召的数量（不征召不算）
    from models.recruit import BroadcastDecision
    new_recruits_query = (
        Q(broadcast_decision_time__gte=today_start_utc, broadcast_decision_time__lt=today_end_utc,
          broadcast_decision__in=[BroadcastDecision.OFFICIAL, BroadcastDecision.INTERN]) |
        Q(final_decision_time__gte=today_start_utc, final_decision_time__lt=today_end_utc,
          final_decision__in=[FinalDecision.OFFICIAL, FinalDecision.INTERN])
    )
    recruit_today_new_recruits = Recruit.objects.filter(new_recruits_query).count()
    
    return {
        # 征召统计
        'recruit_today_appointments': recruit_today_appointments,
        'recruit_today_interviews': recruit_today_interviews,
        'recruit_today_new_recruits': recruit_today_new_recruits,
    }
```

**前端模板：**
```html
<div class="card" id="recruitCard" style="cursor: pointer;">
  <div class="card-header">
    <div class="card-title">征召统计</div>
    <div class="card-icon">📋</div>
  </div>
  <div class="card-body">
    <div class="main-data">
      <div class="main-value">{{ dashboard_data.recruit_today_appointments }}</div>
      <div class="main-label">今日约面</div>
    </div>
    <div class="sub-data">
      <div class="sub-item">
        <div class="sub-value">{{ dashboard_data.recruit_today_interviews }}</div>
        <div class="sub-label">今日到面</div>
      </div>
      <div class="sub-item">
        <div class="sub-value">{{ dashboard_data.recruit_today_new_recruits }}</div>
        <div class="sub-label">今日新开播</div>
      </div>
    </div>
  </div>
</div>
```

**交互功能：**
```javascript
// 设置征召统计卡片的点击事件
const recruitCard = document.getElementById('recruitCard');
if (recruitCard) {
  recruitCard.addEventListener('click', function() {
    window.location.href = '{{ url_for('recruit.recruit_daily_report') }}';
  });
}
```

**数据说明：**
- **今日约面**：基于Recruit模型的created_at字段，统计今日创建的征召记录数量
- **今日到面**：基于interview_decision_time字段（新六步制）或training_decision_time_old字段（历史兼容），统计今日完成面试决策的数量
- **今日新开播**：基于broadcast_decision_time和broadcast_decision字段（新六步制）或final_decision_time和final_decision字段（历史兼容），统计今日在开播决策中决定征召的数量
- **跳转功能**：点击卡片跳转到征召日报页面，提供更详细的征召数据分析
- **时间处理**：使用本地时间进行日期归属，然后转换为UTC时间进行数据库查询，确保与征召日报数据一致
- **历史数据兼容**：支持新六步制字段和历史废弃字段的查询，确保新旧数据都能正确统计

### 作战计划统计卡片

当前作战计划统计卡片的完整实现：

**后端数据计算：**
```python
def _calculate_dashboard_data():
    """计算仪表板数据"""
    now = get_current_utc_time()
    today_start = now.replace(hour=0, minute=0, second=0, microsecond=0)
    today_end = today_start + timedelta(days=1)
    yesterday_start = today_start - timedelta(days=1)
    yesterday_end = today_start
    week_start = today_start - timedelta(days=7)
    
    # 今日作战计划数量
    today_count = Announcement.objects(
        start_time__gte=today_start,
        start_time__lt=today_end
    ).count()
    
    # 昨日作战计划数量
    yesterday_count = Announcement.objects(
        start_time__gte=yesterday_start,
        start_time__lt=yesterday_end
    ).count()
    
    # 计算环比
    if yesterday_count > 0:
        change_rate = round(((today_count - yesterday_count) / yesterday_count) * 100, 1)
    else:
        change_rate = 100.0 if today_count > 0 else 0.0
    
    # 最近7天的日均作战计划数量
    week_count = Announcement.objects(
        start_time__gte=week_start,
        start_time__lt=today_end
    ).count()
    week_avg = round(week_count / 7, 1)
    
    return {
        'today_count': today_count,
        'change_rate': change_rate,
        'week_avg': week_avg
    }
```

**前端模板：**
```html
<div class="card">
  <div class="card-header">
    <div class="card-title">作战计划统计</div>
    <div class="card-icon">📊</div>
  </div>
  <div class="card-body">
    <div class="main-data">
      <div class="main-value">{{ dashboard_data.today_count }}</div>
      <div class="main-label">今日作战计划</div>
    </div>
    <div class="sub-data">
      <div class="sub-item">
        <div class="sub-value {% if dashboard_data.change_rate >= 0 %}positive{% else %}negative{% endif %}">
          {% if dashboard_data.change_rate >= 0 %}+{% endif %}{{ dashboard_data.change_rate }}%
        </div>
        <div class="sub-label">环比</div>
      </div>
      <div class="sub-item">
        <div class="sub-value">{{ dashboard_data.week_avg }}</div>
        <div class="sub-label">7日平均</div>
      </div>
    </div>
  </div>
</div>
```

## 注意事项

1. **数据更新**：确保后端数据计算逻辑正确，特别是时间范围的计算
2. **性能考虑**：避免在仪表板中进行复杂的数据库查询
3. **错误处理**：当数据为空或异常时，提供合理的默认值
4. **可访问性**：确保颜色不是唯一的区分方式，配合文字说明
5. **国际化**：如果支持多语言，确保所有文字都可以本地化

### 作战记录统计卡片

作战记录统计卡片展示流水金额数据，采用1个主要数据 + 2个副数据的布局模式：

**后端数据计算：**
```python
def _calculate_dashboard_data():
    """计算仪表板数据"""
    now = get_current_utc_time()
    
    # 使用GMT+8本地时间进行日期归属，与征召日报保持一致
    current_local = utc_to_local(now)
    today_local_start = current_local.replace(hour=0, minute=0, second=0, microsecond=0)
    today_local_end = today_local_start + timedelta(days=1)
    yesterday_local_start = today_local_start - timedelta(days=1)
    yesterday_local_end = today_local_start
    week_local_start = today_local_start - timedelta(days=7)
    
    # 转换为UTC时间范围进行数据库查询
    today_start_utc = local_to_utc(today_local_start)
    today_end_utc = local_to_utc(today_local_end)
    yesterday_start_utc = local_to_utc(yesterday_local_start)
    yesterday_end_utc = local_to_utc(yesterday_local_end)
    week_start_utc = local_to_utc(week_local_start)
    
    # 作战记录统计（流水金额统计）
    # 今日流水（所有作战记录中的开始日期为今天的作战记录的流水总和）
    br_today_records = BattleRecord.objects(start_time__gte=today_start_utc, start_time__lt=today_end_utc)
    br_today_revenue = sum(record.revenue_amount for record in br_today_records)
    
    # 昨日流水
    br_yesterday_records = BattleRecord.objects(start_time__gte=yesterday_start_utc, start_time__lt=yesterday_end_utc)
    br_yesterday_revenue = sum(record.revenue_amount for record in br_yesterday_records)
    
    # 7日平均流水
    br_week_records = BattleRecord.objects(start_time__gte=week_start_utc, start_time__lt=today_end_utc)
    br_week_revenue = sum(record.revenue_amount for record in br_week_records)
    br_week_avg_revenue = br_week_revenue / 7
    
    return {
        # 作战记录统计
        'battle_today_revenue': br_today_revenue,
        'battle_yesterday_revenue': br_yesterday_revenue,
        'battle_week_avg_revenue': br_week_avg_revenue,
    }
```

**前端模板：**
```html
<div class="card" id="battleRecordCard" style="cursor: pointer;">
  <div class="card-header">
    <div class="card-title">作战记录统计</div>
    <div class="card-icon">📈</div>
  </div>
  <div class="card-body">
    <div class="main-data">
      <div class="main-value">{{ "{:,.0f}".format(dashboard_data.battle_today_revenue) }}</div>
      <div class="main-label">今日流水（元）</div>
    </div>
    <div class="sub-data">
      <div class="sub-item">
        <div class="sub-value">{{ "{:,.0f}".format(dashboard_data.battle_yesterday_revenue) }}</div>
        <div class="sub-label">昨日流水</div>
      </div>
      <div class="sub-item">
        <div class="sub-value">{{ "{:,.0f}".format(dashboard_data.battle_week_avg_revenue) }}</div>
        <div class="sub-label">7日平均流水</div>
      </div>
    </div>
  </div>
</div>
```

**交互功能：**
```javascript
// 设置作战记录统计卡片的点击事件
const battleRecordCard = document.getElementById('battleRecordCard');
if (battleRecordCard) {
  battleRecordCard.addEventListener('click', function() {
    window.location.href = '{{ url_for('report.daily_report') }}';
  });
}
```

**数据格式说明：**
- **金额显示**：使用千分位格式化 `"{:,.0f}".format()` 显示金额
- **单位标识**：主数据标签包含"（元）"单位说明
- **精度控制**：不保留小数，显示整数金额
- **数据来源**：基于BattleRecord模型的revenue_amount字段计算
- **时间处理**：使用GMT+8本地时间进行日期归属，确保与征召日报等模块的时间基准一致
- **交互功能**：点击卡片跳转到作战日报页面，提供更详细的作战数据分析

## 时间处理规范

### 统一时间处理原则

仪表板中的所有统计数据都遵循统一的时间处理规范：

1. **日期归属**：使用GMT+8本地时间进行日期归属
2. **数据库查询**：将本地时间转换为UTC时间进行数据库查询
3. **时间转换**：使用 `utils/timezone_helper.py` 中的 `utc_to_local()` 和 `local_to_utc()` 函数
4. **一致性保证**：与征召日报、作战日报等模块保持时间基准一致

### 时间处理流程

```python
# 1. 获取当前UTC时间
now = get_current_utc_time()

# 2. 转换为GMT+8本地时间
current_local = utc_to_local(now)

# 3. 计算本地时间的日期范围
today_local_start = current_local.replace(hour=0, minute=0, second=0, microsecond=0)
today_local_end = today_local_start + timedelta(days=1)

# 4. 转换为UTC时间范围进行数据库查询
today_start_utc = local_to_utc(today_local_start)
today_end_utc = local_to_utc(today_local_end)

# 5. 执行数据库查询
records = Model.objects(start_time__gte=today_start_utc, start_time__lt=today_end_utc)
```

### 时间处理的重要性

- **数据一致性**：确保不同模块的统计数据基于相同的时间基准
- **用户体验**：用户看到的"今日"、"昨日"等概念与实际业务时间一致
- **业务逻辑**：符合业务运营的时间概念，避免时区混乱
