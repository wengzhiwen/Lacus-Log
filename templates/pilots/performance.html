{% extends "base.html" %}

{% block title %}主播业绩 - Lacus-Log{% endblock %}

{% block content %}
<div class="page-header">
  <div class="header-content">
    <div class="back-nav" id="back-nav">
      <!-- 返回按钮将通过JavaScript动态生成 -->
    </div>
    <h1 class="page-title">🎤 <span id="pilot-nickname">加载中...</span> 业绩</h1>
  </div>
</div>

<div class="pilot-header">
  <div class="pilot-basic-info">
    <div class="pilot-name">
      <a href="#" id="pilot-detail-link"><span id="pilot-nickname-link">-</span></a>
      <span id="pilot-real-name" style="display: none;">（<span id="pilot-real-name-value"></span>）</span>
    </div>
    <div class="pilot-details">
      <span class="age-gender"><span id="pilot-age">-</span>岁<span id="pilot-gender-icon">-</span></span>
      <span class="hometown" id="pilot-hometown" style="display: none;"><span id="pilot-hometown-value"></span></span>
      <span class="owner-rank">直属运营：<span id="pilot-owner">-</span> <br />
        主播分类：<span id="pilot-rank">-</span> <br />
        主播状态：<span id="pilot-status">-</span></span>
    </div>
  </div>
</div>

<div class="summary-section" id="bbs-related-section" style="display: none;">
  <h2 class="section-title">相关讨论</h2>
  <div class="bbs-related-list" id="bbs-related-list">
    <!-- BBS帖子动态加载 -->
  </div>
  <div class="bbs-related-footer">
    <button class="btn btn-secondary" id="bbs-view-more">前往内部BBS</button>
  </div>
</div>

{% include 'bbs/post_detail_modal.html' %}

<div class="loading-state" id="loading-state">
  <div class="loading-spinner"></div>
  <div class="loading-text">正在加载业绩数据...</div>
</div>

<div class="error-state" id="error-state" style="display: none;">
  <div class="error-icon">❌</div>
  <div class="error-text">加载业绩数据失败</div>
  <button class="btn btn-primary" onclick="loadPerformanceData()">重试</button>
</div>

<div class="stats-section" id="stats-section" style="display: none;">
  <div class="summary-section">
    <h2 class="section-title">本月统计（全月 / 月初至报表日）</h2>
    <div class="summary-cards" id="month-summary-cards">
      <div class="summary-card">
        <div class="card-label">开播记录数</div>
        <div class="card-value" id="month-record-count">-</div>
      </div>
      <div class="summary-card summary-card-clickable" id="month-hours-card" data-metric="hours" data-label="累计开播时数">
        <div class="card-label">开播时数</div>
        <div class="card-value" id="month-total-hours">-h</div>
        <div class="card-sub" id="month-avg-hours">-h/记录</div>
      </div>
      <div class="summary-card summary-card-clickable" data-metric="revenue" data-label="累计流水">
        <div class="card-label">累计流水</div>
        <div class="card-value" id="month-total-revenue">¥-</div>
        <div class="card-sub" id="month-daily-avg-revenue">日均¥-</div>
      </div>
      <div class="summary-card summary-card-clickable" data-metric="basepay" data-label="累计底薪">
        <div class="card-label">累计底薪</div>
        <div class="card-value" id="month-total-basepay">¥-</div>
        <div class="card-sub" id="month-daily-avg-basepay">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计返点</div>
        <div class="card-value" id="month-total-rebate">¥-</div>
      </div>
      <div class="summary-card summary-card-clickable" data-metric="company_share" data-label="累计公司分成">
        <div class="card-label">累计公司分成</div>
        <div class="card-value" id="month-total-company-share">¥-</div>
      </div>
      <div class="summary-card summary-card-clickable" data-metric="operating_profit" data-label="运营利润估算" id="month-operating-profit-card">
        <div class="card-label">运营利润估算</div>
        <div class="card-value" id="month-operating-profit">¥-</div>
        <div class="card-sub" id="month-daily-avg-operating-profit">日均¥-</div>
      </div>
    </div>
  </div>

  <div class="stats-notice">
    <div class="notice-content">
      <div class="notice-icon">ℹ️</div>
      <div class="notice-text">
        所有日均数据的分母为开播记录数（并非进行分日计算）。<br />近n日为最近的n条开播记录（并非自然日）。
      </div>
    </div>
  </div>

  <div class="summary-section">
    <h2 class="section-title">近7次开播统计</h2>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-label">开播记录数</div>
        <div class="card-value" id="week-record-count">-</div>
      </div>
      <div class="summary-card" id="week-hours-card">
        <div class="card-label">开播时数</div>
        <div class="card-value" id="week-total-hours">-h</div>
        <div class="card-sub" id="week-avg-hours">-h/记录</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计流水</div>
        <div class="card-value" id="week-total-revenue">¥-</div>
        <div class="card-sub" id="week-daily-avg-revenue">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计底薪</div>
        <div class="card-value" id="week-total-basepay">¥-</div>
        <div class="card-sub" id="week-daily-avg-basepay">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计返点</div>
        <div class="card-value" id="week-total-rebate">¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计公司分成</div>
        <div class="card-value" id="week-total-company-share">¥-</div>
      </div>
      <div class="summary-card" id="week-operating-profit-card">
        <div class="card-label">近日盈亏（不计返点）</div>
        <div class="card-value" id="week-operating-profit">¥-</div>
        <div class="card-sub" id="week-daily-avg-operating-profit">日均¥-</div>
      </div>
    </div>
  </div>

  <div class="summary-section">
    <h2 class="section-title">近3次开播统计</h2>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-label">开播记录数</div>
        <div class="card-value" id="three-day-record-count">-</div>
      </div>
      <div class="summary-card" id="three-day-hours-card">
        <div class="card-label">开播时数</div>
        <div class="card-value" id="three-day-total-hours">-h</div>
        <div class="card-sub" id="three-day-avg-hours">-h/记录</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计流水</div>
        <div class="card-value" id="three-day-total-revenue">¥-</div>
        <div class="card-sub" id="three-day-daily-avg-revenue">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计底薪</div>
        <div class="card-value" id="three-day-total-basepay">¥-</div>
        <div class="card-sub" id="three-day-daily-avg-basepay">日均¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计返点</div>
        <div class="card-value" id="three-day-total-rebate">¥-</div>
      </div>
      <div class="summary-card">
        <div class="card-label">累计公司分成</div>
        <div class="card-value" id="three-day-total-company-share">¥-</div>
      </div>
      <div class="summary-card" id="three-day-operating-profit-card">
        <div class="card-label">近日盈亏（不计返点）</div>
        <div class="card-value" id="three-day-operating-profit">¥-</div>
        <div class="card-sub" id="three-day-daily-avg-operating-profit">日均¥-</div>
      </div>
    </div>
  </div>
</div>

<div class="summary-section" id="recent-records-section" style="display: none;">
  <h2 class="section-title">最近开播记录</h2>
  <div class="record-cards" id="recent-records-container">
    <!-- 记录将通过JavaScript动态加载 -->
  </div>
</div>

<div class="chart-modal" id="metricChartModal" aria-hidden="true">
  <div class="chart-modal__dialog">
    <button type="button" class="chart-modal__close" id="metricChartClose" aria-label="关闭图表">×</button>
    <h3 class="chart-modal__title" id="chartModalTitle"></h3>
    <div class="chart-modal__canvas">
      <canvas id="metricChartCanvas"></canvas>
    </div>
    <div class="chart-modal__switcher" id="chartMetricSwitcher"></div>
    <p class="chart-modal__hint">注：曲线为按自然日累计值，柱状为当日新增。</p>
  </div>
</div>

<style>

.page-header {
  margin-bottom: 20px;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 16px;
}


.back-nav {
  flex-shrink: 0;
}

.back-nav .btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  color: #495057;
  text-decoration: none;
  font-size: 14px;
  transition: all 0.2s ease;
}

.back-nav .btn:hover {
  background: #e9ecef;
  border-color: #adb5bd;
  color: #343a40;
}

.back-nav .btn span {
  font-size: 16px;
  font-weight: bold;
}


.page-title {
  margin: 0;
  flex: 1;
}


.pilot-header {
  background: #fff;
  border-radius: 8px;
  padding: 16px 20px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
}

.pilot-basic-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.pilot-name {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
}

.pilot-name a {
  color: var(--brand);
  text-decoration: underline;
}

.pilot-name a:hover {
  text-decoration: underline;
}

.pilot-details {
  display: flex;
  gap: 12px;
  font-size: 14px;
  color: var(--muted);
}

.age-gender {
  font-weight: 600;
}

.hometown::before {
  content: "· ";
}

.owner-rank::before {
  content: " ";
}


.stats-section {
  margin-bottom: 30px;
}


.stats-notice {
  background: #e3f2fd;
  border: 1px solid #bbdefb;
  border-radius: 8px;
  padding: 12px 16px;
  margin: 20px 0;
}

.notice-content {
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.notice-icon {
  font-size: 16px;
  flex-shrink: 0;
  margin-top: 1px;
}

.notice-text {
  font-size: 14px;
  color: #1976d2;
  line-height: 1.4;
  font-weight: 500;
}

.summary-section {
  margin: 24px 0;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.summary-card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  transition: box-shadow 0.2s ease;
}

.summary-card-clickable {
  cursor: pointer;
  position: relative;
}

.summary-card-clickable::after {
  content: '📈';
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 16px;
}

.summary-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.summary-card.negative-value {
  border-color: #f44336;
}

.summary-card.negative-value:hover {
  box-shadow: 0 2px 8px rgba(244, 67, 54, 0.2);
}

.card-label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}

.card-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--brand);
}

.card-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}


.record-cards {
  padding: 0;
}

.record-card {
  display: block;
  background: #fff;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
  text-decoration: none;
  color: inherit;
  transition: all 0.2s ease;
  cursor: pointer;
}

.record-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transform: translateY(-2px);
  border-color: var(--brand);
}

.bbs-related-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.bbs-related-empty {
  padding: 12px;
  background: #f8f9fa;
  border: 1px dashed #ced4da;
  border-radius: 8px;
  color: #868e96;
  text-align: center;
  font-size: 14px;
}

.bbs-related-footer {
  margin-top: 12px;
}

.record-card .card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.record-time {
  flex: 0 0 auto;
}

.start-time {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 2px;
}

.duration {
  font-size: 12px;
  color: var(--muted);
}

.record-info {
  flex: 1;
  text-align: right;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}

.pilot-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  line-height: 1.2;
  margin-bottom: 2px;
}

.meta-line {
  font-size: 12px;
  color: var(--muted);
  line-height: 1.1;
}

.record-card .card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-top: 1px solid var(--table-header);
  padding-top: 12px;
}

.revenue {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.amount {
  font-size: 16px;
  font-weight: 600;
  color: var(--hud-green);
}

.base-salary {
  font-size: 12px;
  color: var(--muted);
}

.card-arrow {
  font-size: 18px;
  color: var(--muted);
  transition: color 0.2s ease;
}

.record-card:hover .card-arrow {
  color: var(--brand);
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

.chart-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  z-index: 2000;
}

.chart-modal.is-visible {
  display: flex;
}

.chart-modal__dialog {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  width: 100%;
  max-width: 720px;
  box-shadow: 0 12px 32px rgba(15, 23, 42, 0.25);
  position: relative;
}

.chart-modal__close {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}

.chart-modal__title {
  margin: 0 0 12px;
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
}

.chart-modal__canvas {
  width: 100%;
  height: 320px;
}

.chart-modal__canvas canvas {
  width: 100% !important;
  height: 100% !important;
}

.chart-modal__hint {
  margin-top: 12px;
  font-size: 13px;
  color: var(--muted);
  text-align: right;
}

.chart-modal__switcher {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 12px;
}

.chart-switcher__btn {
  border: 1px solid var(--gray);
  background: #fff;
  border-radius: 20px;
  padding: 6px 14px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.chart-switcher__btn.is-active {
  border-color: var(--brand);
  background: rgba(54, 79, 199, 0.1);
  color: var(--brand);
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.empty-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 8px;
}


@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .page-title {
    font-size: 20px;
  }
  
  .pilot-details {
    flex-direction: column;
    gap: 4px;
  }
  
  .stats-notice {
    padding: 10px 12px;
    margin: 16px 0;
  }
  
  .notice-text {
    font-size: 13px;
  }
  
  .summary-cards {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }
  
  .summary-card {
    padding: 12px;
  }
  
  .card-value {
    font-size: 20px;
  }
  
  .record-cards {
    padding: 0;
  }
  
  .record-card .card-header {
    flex-direction: row;
    align-items: flex-start;
    gap: 8px;
  }
  
  .record-info {
    text-align: right;
    align-items: flex-end;
  }
}

.error-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.error-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.error-text {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
}

.error-state .btn {
  margin-top: 16px;
}

.live-indicator {
  color: #ff4757;
  font-size: 12px;
  font-weight: 600;
  margin-left: 6px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}
</style>

{% set role_names = current_user.roles | map(attribute='name') | list %}
<script>
  window.BBS_CONFIG = Object.assign(window.BBS_CONFIG || {}, {
    csrfToken: {{ csrf_token|tojson }},
    currentUser: {
      id: {{ (current_user.id|string)|tojson }},
      displayName: {{ (current_user.nickname or current_user.username)|tojson }},
      roles: {{ role_names|tojson }}
    }
  });
</script>
<script src="{{ url_for('static', filename='js/bbs_post_detail.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
// 主播业绩页面JavaScript - 完全REST化版本
// 从URL中获取pilot_id
const urlParts = window.location.pathname.split('/');
const pilotId = urlParts[urlParts.indexOf('pilots') + 1];

// 从URL参数获取来源信息
const urlParams = new URLSearchParams(window.location.search);
const fromParam = urlParams.get('from');
const dateParam = urlParams.get('date');
const ownerParam = urlParams.get('owner');
const monthParam = urlParams.get('month');
const recordIdParam = urlParams.get('record_id');
const chartModal = document.getElementById('metricChartModal');
const chartModalTitle = document.getElementById('chartModalTitle');
const chartModalClose = document.getElementById('metricChartClose');
const chartCanvas = document.getElementById('metricChartCanvas');
const chartMetricSwitcher = document.getElementById('chartMetricSwitcher');
const monthSummaryCards = document.getElementById('month-summary-cards');

const metricConfigs = {
  hours: {
    field: 'hours_cumulative',
    label: '累计开播时数',
    color: '#4f46e5',
    background: 'rgba(79, 70, 229, 0.15)',
    barColor: 'rgba(79, 70, 229, 0.25)',
    showDaily: true,
    format: 'hours',
  },
  revenue: {
    field: 'revenue_cumulative',
    label: '累计流水',
    color: '#2563eb',
    background: 'rgba(37, 99, 235, 0.15)',
    barColor: 'rgba(37, 99, 235, 0.25)',
    showDaily: true,
  },
  basepay: {
    field: 'basepay_cumulative',
    label: '累计底薪',
    color: '#f97316',
    background: 'rgba(249, 115, 22, 0.15)',
    barColor: 'rgba(249, 115, 22, 0.25)',
    showDaily: true,
  },
  company_share: {
    field: 'company_share_cumulative',
    label: '累计公司分成',
    color: '#059669',
    background: 'rgba(5, 150, 105, 0.15)',
    barColor: 'rgba(5, 150, 105, 0.25)',
    showDaily: true,
  },
  operating_profit: {
    field: 'operating_profit_cumulative',
    label: '运营利润估算',
    color: '#b91c1c',
    background: 'rgba(185, 28, 28, 0.15)',
    showDaily: false,
  }
};

let monthDailySeries = [];
let metricChartInstance = null;
let currentMetricKey = null;

// 格式化金额
function formatCurrency(amount) {
  if (amount === null || amount === undefined || Number.isNaN(Number(amount))) {
    return '¥0.00';
  }
  const numeric = Number(amount);
  return '¥' + numeric.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function setMonthDailySeries(series) {
  monthDailySeries = Array.isArray(series) ? series : [];
}

function formatMetricValue(metricKey, value) {
  const config = metricConfigs[metricKey];
  if (config && config.format === 'hours') {
    return `${Number(value || 0).toFixed(1)}小时`;
  }
  return formatCurrency(value);
}

function buildDailyValues(field) {
  const values = [];
  let previous = 0;
  monthDailySeries.forEach(item => {
    const current = Number(item[field] || 0);
    const delta = current - previous;
    values.push(delta < 0 ? 0 : delta);
    previous = current;
  });
  return values;
}

function handleMetricCardClick(event) {
  const card = event.target.closest('.summary-card[data-metric]');
  if (!card) {
    return;
  }
  if (!monthDailySeries.length) {
    alert('当前月份暂无可绘制的数据');
    return;
  }
  const metricKey = card.dataset.metric;
  const metricConfig = metricConfigs[metricKey];
  if (!metricConfig) {
    return;
  }
  const label = card.dataset.label || metricConfig.label;
  openMetricModal(metricKey, label);
}

function openMetricModal(metricKey, label) {
  if (!chartModal || !chartModalTitle) {
    return;
  }
  currentMetricKey = metricKey;
  chartModalTitle.textContent = `${label} - 日累计趋势`;
  chartModal.classList.add('is-visible');
  chartModal.setAttribute('aria-hidden', 'false');
  renderMetricChart(metricKey);
}

function closeMetricModal() {
  if (!chartModal) {
    return;
  }
  chartModal.classList.remove('is-visible');
  chartModal.setAttribute('aria-hidden', 'true');
  destroyMetricChart();
}

function destroyMetricChart() {
  if (metricChartInstance) {
    metricChartInstance.destroy();
    metricChartInstance = null;
  }
}

function renderChartMetricSwitcher(activeKey) {
  if (!chartMetricSwitcher) {
    return;
  }
  const metricKeys = ['hours', 'revenue', 'basepay', 'company_share', 'operating_profit'].filter((key) => metricConfigs[key]);
  chartMetricSwitcher.innerHTML = metricKeys
    .map(key => `<button type="button" class="chart-switcher__btn${key === activeKey ? ' is-active' : ''}" data-metric="${key}">${metricConfigs[key].label}</button>`)
    .join('');
}

function renderMetricChart(metricKey) {
  if (!chartCanvas || typeof Chart === 'undefined') {
    return;
  }
  const config = metricConfigs[metricKey];
  if (!config) {
    return;
  }
  const labels = monthDailySeries.map(item => item.date);
  const cumulativeValues = monthDailySeries.map(item => Number(item[config.field] || 0));
  const dailyValues = config.showDaily === false ? [] : buildDailyValues(config.field);
  if (!labels.length) {
    return;
  }

  destroyMetricChart();
  currentMetricKey = metricKey;
  renderChartMetricSwitcher(metricKey);
  const datasets = [];
  if (config.showDaily !== false) {
    datasets.push({
      type: 'bar',
      label: `${config.label}（当日）`,
      data: dailyValues,
      backgroundColor: config.barColor,
      borderColor: config.color,
      borderWidth: 1,
      borderRadius: 4,
      barPercentage: 0.8,
      categoryPercentage: 0.7,
      order: 1,
    });
  }
  datasets.push({
    type: 'line',
    label: `${config.label}（累计）`,
    data: cumulativeValues,
    fill: true,
    borderColor: config.color,
    backgroundColor: config.background,
    borderWidth: 2,
    pointRadius: 2.5,
    tension: 0.25,
    order: 2,
  });

  const combinedValues = [...cumulativeValues];
  if (config.showDaily !== false) {
    combinedValues.push(...dailyValues);
  }
  const minValue = combinedValues.length ? Math.min(...combinedValues) : 0;
  const maxValue = combinedValues.length ? Math.max(...combinedValues) : 0;
  const formatValue = (value) => formatMetricValue(metricKey, value);

  const ctx = chartCanvas.getContext('2d');
  metricChartInstance = new Chart(ctx, {
    data: {
      labels,
      datasets,
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label(context) {
              const value = context.parsed.y ?? context.parsed;
              const dsLabel = context.dataset && context.dataset.label ? context.dataset.label : config.label;
              return `${dsLabel}: ${formatValue(value)}`;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            autoSkip: true,
            maxRotation: 0,
            minRotation: 0
          }
        },
        y: {
          ticks: {
            callback(value) {
              return formatValue(value);
            }
          },
          suggestedMin: Math.min(0, minValue * 1.05),
          suggestedMax: Math.max(0, maxValue * 1.05)
        }
      }
    }
  });
}

// 格式化时间
function formatDateTime(dateTimeStr) {
  if (!dateTimeStr) return '未知';
  const date = new Date(dateTimeStr);
  if (Number.isNaN(date.getTime())) {
    return '未知';
  }
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${month}月${day}日 ${hours}:${minutes}`;
}

// 规范化主播分类显示
function normalizeRank(value) {
  const mapping = {
    '候补机师': '候选人',
    '训练机师': '试播主播',
    '实习机师': '实习主播',
    '正式机师': '正式主播'
  };
  return mapping[value] || value;
}

// 规范化主播状态显示
function normalizeStatus(value) {
  const mapping = {
    '未征召': '未招募',
    '不征召': '不招募',
    '已征召': '已招募',
    '已签约': '已签约',
    '已阵亡': '流失'
  };
  return mapping[value] || value;
}

// 生成返回按钮
function generateBackButton() {
  const backNav = document.getElementById('back-nav');
  let backHtml = '';
  
  if (fromParam === 'daily_report' && dateParam && ownerParam) {
    backHtml = `<a class="btn btn-secondary" href="/reports/daily?date=${dateParam}&owner=${ownerParam}">
      <span>←</span> 返回
    </a>`;
  } else if (fromParam === 'monthly_report' && monthParam) {
    backHtml = `<a class="btn btn-secondary" href="/reports/monthly?month=${monthParam}">
      <span>←</span> 返回
    </a>`;
  } else if (fromParam === 'pilot_detail') {
    backHtml = `<a class="btn btn-secondary" href="/pilots/${pilotId}">
      <span>←</span> 返回
    </a>`;
  } else if (fromParam === 'battle_record_detail' && recordIdParam) {
    backHtml = `<a class="btn btn-secondary" href="/battle-records/${recordIdParam}">
      <span>←</span> 返回
    </a>`;
  } else {
    backHtml = `<a class="btn btn-secondary" href="/pilots/">
      <span>←</span> 返回
    </a>`;
  }
  
  backNav.innerHTML = backHtml;
}

// 更新主播基本信息
function updatePilotInfo(pilotInfo) {
  // 更新所有昵称显示
  const nicknameElements = document.querySelectorAll('#pilot-nickname, #pilot-nickname-link');
  nicknameElements.forEach(el => el.textContent = pilotInfo.nickname);
  
  // 更新详情页链接
  const detailLink = document.getElementById('pilot-detail-link');
  detailLink.href = `/pilots/${pilotId}?from=performance`;
  
  // 更新真实姓名
  if (pilotInfo.real_name) {
    document.getElementById('pilot-real-name-value').textContent = pilotInfo.real_name;
    document.getElementById('pilot-real-name').style.display = 'inline';
  }
  
  // 更新年龄和性别图标
  document.getElementById('pilot-age').textContent = pilotInfo.age || '-';
  document.getElementById('pilot-gender-icon').textContent = pilotInfo.gender_icon || '?';
  
  // 更新籍贯
  if (pilotInfo.hometown) {
    document.getElementById('pilot-hometown-value').textContent = pilotInfo.hometown;
    document.getElementById('pilot-hometown').style.display = 'inline';
  }
  
  // 更新直属运营
  document.getElementById('pilot-owner').textContent = pilotInfo.owner || '未知';
  
  // 更新主播分类和状态（应用规范化）
  document.getElementById('pilot-rank').textContent = normalizeRank(pilotInfo.rank || '-');
  document.getElementById('pilot-status').textContent = normalizeStatus(pilotInfo.status || '-');
}

// 更新统计卡片
function updateStatsCard(prefix, stats) {
  if (!stats) {
    console.error(`统计数据缺失: ${prefix}`);
    return;
  }
  try {
    document.getElementById(`${prefix}-record-count`).textContent = stats.record_count;
    document.getElementById(`${prefix}-total-hours`).textContent = Number(stats.total_hours).toFixed(1) + 'h';
    document.getElementById(`${prefix}-avg-hours`).textContent = Number(stats.avg_hours).toFixed(1) + 'h/记录';
    document.getElementById(`${prefix}-total-revenue`).textContent = formatCurrency(stats.total_revenue);
    document.getElementById(`${prefix}-daily-avg-revenue`).textContent = '日均' + formatCurrency(stats.daily_avg_revenue);
    document.getElementById(`${prefix}-total-basepay`).textContent = formatCurrency(stats.total_basepay);
    document.getElementById(`${prefix}-daily-avg-basepay`).textContent = '日均' + formatCurrency(stats.daily_avg_basepay);
    document.getElementById(`${prefix}-total-rebate`).textContent = formatCurrency(stats.total_rebate);
    document.getElementById(`${prefix}-total-company-share`).textContent = formatCurrency(stats.total_company_share);
    document.getElementById(`${prefix}-operating-profit`).textContent = formatCurrency(stats.operating_profit);
    document.getElementById(`${prefix}-daily-avg-operating-profit`).textContent = '日均' + formatCurrency(stats.daily_avg_operating_profit);
    
    // 设置负值样式
    const hoursCard = document.getElementById(`${prefix}-hours-card`);
    const profitCard = document.getElementById(`${prefix}-operating-profit-card`);
    
    if (hoursCard && stats.avg_hours < 7 && stats.operating_profit < 0) {
      hoursCard.classList.add('negative-value');
    }
    if (profitCard && stats.operating_profit < 0) {
      profitCard.classList.add('negative-value');
    }
  } catch (error) {
    console.error(`更新统计卡片失败 (${prefix}):`, error);
    console.error('stats:', stats);
  }
}

// 渲染最近开播记录
function renderRecentRecords(records, pilotInfo) {
  const container = document.getElementById('recent-records-container');
  
  if (!records || records.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">📊</div>
        <div class="empty-title">暂无开播记录</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = records.map(record => `
    <a href="/battle-records/${record.id}" class="record-card">
      <div class="card-header">
        <div class="record-time">
          <div class="start-time">
            ${formatDateTime(record.start_time)}
            ${record.status === 'live' ? '<span class="live-indicator">开播中</span>' : ''}
          </div>
          <div class="duration">${Number(record.duration_hours).toFixed(1)}小时</div>
        </div>
        <div class="record-info">
          <div class="pilot-name">${pilotInfo.nickname}${pilotInfo.real_name ? '（' + pilotInfo.real_name + '）' : ''}</div>
          <div class="meta-line">[${pilotInfo.owner || '未知'}][${pilotInfo.rank || '未知'}]</div>
        </div>
      </div>
      <div class="card-footer">
        <div class="revenue">
          <span class="amount">${formatCurrency(record.revenue_amount)}</span>
          ${buildBaseSalaryBadge(record)}
        </div>
        <div class="card-arrow">→</div>
      </div>
    </a>
  `).join('');
}

function buildBaseSalaryBadge(record) {
  const application = record.base_salary_application;
  if (application && application.status === 'approved') {
    const amount = application.amount !== undefined ? application.amount : 0;
    return `<span class="base-salary">底薪${formatCurrency(amount)}</span>`;
  }
  if (application && application.status) {
    const statusText = application.status_display || '';
    return `<span class="base-salary">底薪${statusText}</span>`;
  }
  return `<span class="base-salary">未申请</span>`;
}

function renderBBSRelatedPosts(items) {
  const section = document.getElementById('bbs-related-section');
  const list = document.getElementById('bbs-related-list');
  const viewMoreBtn = document.getElementById('bbs-view-more');
  if (!section || !list) return;

  list.innerHTML = '';
  if (!items || items.length === 0) {
    list.innerHTML = '<div class="bbs-related-empty">暂无相关讨论</div>';
  } else {
    items.forEach((item) => {
      const card = document.createElement('div');
      card.className = 'bbs-post-card';
      const tags = [];
      if (item.is_pinned) tags.push('<span class="tag tag-info">置顶</span>');
      if (item.status === 'hidden') tags.push('<span class="tag tag-warning">隐藏</span>');
      const lastReplyText = item.last_reply ? `${item.last_reply.author?.display_name || '-'} · ${item.last_reply.time?.display || '-'}` : '暂无回复';

      card.innerHTML = `
        <div class="card-header">
          <div class="title">${item.title}</div>
          <div class="tags">${tags.join(' ')}</div>
        </div>
        <div class="card-meta">
          <span>板块：${item.board?.name || '-'}</span>
          <span>作者：${item.author?.display_name || '-'}</span>
        </div>
        <div class="card-meta">
          <span>最后活跃：${item.last_active_at?.display || '-'}</span>
          <span>${lastReplyText}</span>
        </div>
      `;
      card.addEventListener('click', () => {
        if (window.BBSModal) {
          window.BBSModal.open(item.id);
        }
      });
      list.appendChild(card);
    });
  }

  section.style.display = 'block';
  if (viewMoreBtn) {
    viewMoreBtn.style.display = 'inline-flex';
  }
}

async function loadRecentBBSPosts() {
  const section = document.getElementById('bbs-related-section');
  if (!section) return;
  try {
    const response = await fetch(`/api/bbs/pilots/${pilotId}/recent`, { credentials: 'include' });
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    const result = await response.json();
    if (!result.success) {
      throw new Error(result.error?.message || '加载帖子失败');
    }
    renderBBSRelatedPosts(result.data.items || []);
  } catch (error) {
    console.error('加载相关BBS帖子失败:', error);
    const list = document.getElementById('bbs-related-list');
    if (list) {
      list.innerHTML = '<div class="bbs-related-empty">加载相关讨论失败</div>';
    }
    section.style.display = 'block';
  }
}

// 加载业绩数据
async function loadPerformanceData() {
  try {
    // 显示加载状态
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('error-state').style.display = 'none';
    document.getElementById('stats-section').style.display = 'none';
    document.getElementById('recent-records-section').style.display = 'none';
    document.getElementById('bbs-related-section').style.display = 'none';
    
    const response = await fetch(`/api/pilots/${pilotId}/performance`);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || '获取数据失败');
    }
    
    const data = result.data;
    
    // 更新主播基本信息
    updatePilotInfo(data.pilot_info);
    
    // 先显示内容区域，再更新数据
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('stats-section').style.display = 'block';
    document.getElementById('recent-records-section').style.display = 'block';
    
    // 更新统计数据
    console.log('开始更新统计数据...');
    console.log('month_stats:', data.month_stats);
    console.log('week_stats:', data.week_stats);
    console.log('three_day_stats:', data.three_day_stats);
    
    setMonthDailySeries(data.daily_series || []);
    updateStatsCard('month', data.month_stats);
    updateStatsCard('week', data.week_stats);
    updateStatsCard('three-day', data.three_day_stats);
    
    // 渲染最近开播记录
    renderRecentRecords(data.recent_records, data.pilot_info);
    loadRecentBBSPosts();
    
  } catch (error) {
    console.error('加载业绩数据失败:', error);
    
    // 显示错误状态
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'block';
    document.getElementById('stats-section').style.display = 'none';
    document.getElementById('recent-records-section').style.display = 'none';
    document.getElementById('bbs-related-section').style.display = 'none';
  }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
  // 生成返回按钮
  generateBackButton();

  if (monthSummaryCards) {
    monthSummaryCards.addEventListener('click', handleMetricCardClick);
  }
  if (chartModalClose) {
    chartModalClose.addEventListener('click', closeMetricModal);
  }
  if (chartModal) {
    chartModal.addEventListener('click', (event) => {
      if (event.target === chartModal) {
        closeMetricModal();
      }
    });
  }
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      closeMetricModal();
    }
  });
  if (chartMetricSwitcher) {
    chartMetricSwitcher.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-metric]');
      if (!button) {
        return;
      }
      const metric = button.dataset.metric;
      if (metric && metric !== currentMetricKey) {
        renderMetricChart(metric);
      }
    });
  }

  // 加载业绩数据
  loadPerformanceData();

  const viewMoreBtn = document.getElementById('bbs-view-more');
  if (viewMoreBtn) {
    viewMoreBtn.addEventListener('click', () => {
      window.open('/bbs/', '_blank');
    });
  }
});
</script>
{% endblock %}
.bbs-related-footer .btn {
  padding: 8px 16px;
}
