### 报告-邮件报告模块

本模块专供议长使用，在议长的菜单中较靠后位置提供独立入口。进入页面后展示一排“报告发送”按钮。当前版本仅实现第一个按钮：未开播提醒。

---

### 功能概览
- **定位**：面向议长的离线通知型报表，通过邮件触达。
- **触发方式**：用户点击页面按钮触发后台异步计算与发送；前端不等待结果，仅提示“报表已开始运算”。
- **收件人**：由后端按报表类型动态计算。
  - 未开播提醒：从用户模块获取所有激活用户的邮箱（不区分角色），去重后发送。
  - 未来扩展：可按报表类型配置不同角色或小组策略。
- **日志**：当无可发送内容时，仅记录一条 `INFO` 日志，不发送邮件。
- **扩展性**：预留多个报表按钮位，后续可持续扩充。

---

### 入口与权限
- **菜单入口**：议长菜单末端区域新增“邮件报告”入口。
- **访问权限**：仅议长可见与可用；遵循现有权限体系与装饰器实现。

---

### 报表一：未开播提醒
- **报表目标**：在过去 48 小时内，找出所有“作战计划”，其“计划的接受时间”已过去超过 4 小时但仍未产生对应“作战记录”的计划，并以列表形式邮件通知。
- **判定窗口**：以当前时间为基准，回溯 48 小时内的作战计划。
- **逾时时间**：当 `当前时间 - 计划接受时间 > 4 小时` 且未发现与之关联的“作战记录”则视为“未开播”。
- **关联关系**：”作战记录“可以（非必需）关联到某一“作战计划”。以此作为是否“已开播”的主要判断依据。
- **邮件发送**：若命中记录>0，则发送邮件；否则不发邮件，仅记 `INFO` 日志。

### 报表二：征召日报（本期新增）
- **报表目标**：发送前一个自然日（GMT+8）的征召日报统计数据给所有舰长和议长。
- **定时发送**：每天0:05（GMT+8）自动发送前一天的征召日报邮件。
- **手动触发**：支持在邮件报告页面手动触发，可指定报表日期。
- **邮件内容**：包含报表日、近7日、近14日的约面、到面、试播、新开播统计数据。
- **数据计算**：复用征召日报的计算逻辑，确保数据一致性。
- **收件人**：自动获取所有激活的舰长和议长邮箱，支持去重。

---

### 时间口径与时区
- 系统规则：数据库存储 UTC；UI 输入与展示按 GMT+8。
- 本报表计算：统一先将 UI/业务相关时间换算为 UTC 后在数据库侧查询与聚合；列表中用于提示的时间与超时小时数以用户可读格式呈现（建议 GMT+8 展示）。

---

### 数据与字段（建议）
邮件正文建议以表格呈现以下字段：
- **作战计划ID**：可用于定位问题计划。
- **主播昵称**：来自计划关联机师。
- **计划接受时间（GMT+8）**：计划的“接受时间”。
- **应结束时间/应开播截止**：与“接受时间+4小时”的业务时间点，用于判断是否超时。
- **当前超时（小时）**：`max(0, floor((当前时间 - 应结束时间)/1小时))`。
- **备注/链接**：可附系统内跳转链接，便于处理。

---

### 发送对象与邮件格式
- **收件人**：从用户模块动态获取（当前为所有激活用户邮箱）。
- **主题**：`[Lacus-Log] 未开播提醒（近48小时）`，建议加上生成时间。
- **正文**：
  - 当有数据：以 Markdown 表格形式列出明细，系统内联样式保证邮件客户端可读。
  - 当无数据：不发送邮件；日志记录“无未开播计划，已跳过发送”。
- **底层发送**：复用 `utils/mail_utils.py` 的 `send_email_md()`。

---

### 交互与异步策略
- **点击即触发**：按钮点击后立即返回提示“报表已开始运算”，不进行同步等待。
- **后台执行**：由后端触发报表计算逻辑与邮件发送。若后续引入任务队列（如 Celery/RQ）可将其放入队列执行；本期按最小实现可以采用短事务内计算+发送，但务必控制超时与日志。

---

### 日志规范
- **日志位置**：`log/` 目录按自然日切分，模块名建议 `report_mail`。
- **日志语言**：简体中文。
- **级别建议**：
  - `INFO`：无数据时的跳过发送；发送成功摘要（条目数、收件人）。
  - `DEBUG`：查询条件、时间窗口、示例数据条目（注意脱敏）。
  - `ERROR`：邮件发送失败、数据查询异常。
- **第三方日志**：若引入额外依赖，需将其日志级别显式设为 `INFO`。

---

### 失败与重试（建议）
- 邮件发送失败时记录 `ERROR`，并输出关键信息（主题、收件人、失败原因）。
- 若采用任务队列，可配置有限次重试与退避策略；本期先不实现自动重试。

---

### 接口与页面（概要）
- **页面**：`templates/reports/mail_reports.html`（建议），展示一排按钮；当前仅“未开播提醒”。
- **路由**：`routes/report_mail.py`（建议），POST 触发型端点，返回 JSON：`{"status":"started"}`。
- **权限**：在路由层使用现有装饰器限制为议长角色。

---

### 边界与约束
- 计划被取消或作废的不纳入统计（以计划状态字段过滤）。
- 多条“作战记录”关联同一计划视为已开播，无需重复提示。
- 若计划未明确“接受时间”，可：
  - 要么跳过；
  - 要么以计划“开始时间”作为替代（需在实现中显式说明）。
  本期建议“跳过无接受时间”的计划并在 `DEBUG` 日志统计数量。

---

### 未来扩展方向
- 更多报表按钮：如“低开播率提醒”“高流水异常提醒”“长时未征召回访提醒”等。
- 收件人策略：支持按角色、按小组动态计算收件人；或允许页面内临时追加收件人。
- 报表订阅：支持每日/每周定时触发与历史报表归档。

---

### 验收要点
- 仅议长可见入口，点击后立即返回“开始运算”。
- 有命中数据时发送邮件（Markdown 表格呈现）；无数据仅记 `INFO`。
- 计算时间口径与现有模块一致（UTC 存储、GMT+8 展示）。



