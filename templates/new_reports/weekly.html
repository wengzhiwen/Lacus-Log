{% extends "base.html" %}

{% block title %}å¼€æ’­æ–°å‘¨æŠ¥ - {{ pagination.week_start }}{% endblock %}

{% block content %}
<div id="weeklyReportApp" data-week-start="{{ pagination.week_start }}" data-selected-owner="{{ selected_owner }}" data-selected-mode="{{ selected_mode }}">
  <div class="page-header">
    <h1 class="page-title">ğŸ“’ å¼€æ’­æ–°å‘¨æŠ¥</h1>
    <div class="page-subtitle">å‘¨å®šä¹‰ï¼šå‘¨äºŒè‡³æ¬¡å‘¨ä¸€ï¼ˆ7å¤©ï¼‰</div>
  </div>

  <div class="date-navigation">
    <div class="date-controls">
      <a href="{{ url_for('new_report.weekly_report', week_start=pagination.prev_week_start, owner=selected_owner, mode=selected_mode) }}" class="btn btn-secondary btn-sm">â† ä¸Šä¸€å‘¨</a>
      <span class="date-display" id="weekly-date-display">{{ pagination.week_start }}ï¼ˆå‘¨äºŒèµ·ï¼‰</span>
      <a href="{{ url_for('new_report.weekly_report', week_start=pagination.next_week_start, owner=selected_owner, mode=selected_mode) }}" class="btn btn-secondary btn-sm">ä¸‹ä¸€å‘¨ â†’</a>
    </div>
    <div class="export-actions">
      <a href="{{ url_for('new_report.export_weekly_csv', week_start=pagination.week_start, owner=selected_owner, mode=selected_mode) }}" class="btn btn-warning btn-sm">ğŸ“¥ å¯¼å‡ºCSV</a>
    </div>
  </div>

  <div class="filter-section">
    <div class="filter-controls">
      <label for="ownerSelector" class="filter-label">ç›´å±è¿è¥ï¼š</label>
      <select id="ownerSelector" class="filter-select" data-selected-owner="{{ selected_owner }}">
        <option value="all">å…¨éƒ¨</option>
      </select>

      <label for="modeSelector" class="filter-label">å¼€æ’­æ–¹å¼ï¼š</label>
      <select id="modeSelector" class="filter-select">
        <option value="all" {% if selected_mode == 'all' %}selected{% endif %}>å…¨éƒ¨</option>
        <option value="online" {% if selected_mode == 'online' %}selected{% endif %}>çº¿ä¸Š</option>
        <option value="offline" {% if selected_mode == 'offline' %}selected{% endif %}>çº¿ä¸‹</option>
      </select>
    </div>
  </div>

  <div class="summary-section">
    <div id="weekly-loading-state" class="loading-state">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>
    <div style="display: none;" id="weekly-content">
      <h2 class="section-title">å‘¨åº¦æ±‡æ€»ï¼ˆå‘¨äºŒ-æ¬¡å‘¨ä¸€ï¼‰</h2>
      <div class="summary-cards" id="weekly-summary-cards"></div>
      <div class="summary-hint">æ³¨ï¼šå‘¨å®šä¹‰ä¸ºå‘¨äºŒè‡³æ¬¡å‘¨ä¸€ï¼›ç›ˆåˆ©å£å¾„ä¸è®¡è¿”ç‚¹</div>
    </div>
  </div>

  <div class="details-section">
    <h2 class="section-title">å‘¨æŠ¥æ˜ç»†</h2>
    <div class="table-container" id="weekly-table-container" style="display: none;">
      <table class="report-table">
        <thead>
          <tr>
            <th class="fixed-col">ä¸»æ’­</th>
            <th>æ€§åˆ«å¹´é¾„</th>
            <th>ç›´å±è¿è¥</th>
            <th>ä¸»æ’­åˆ†ç±»</th>
            <th>å‘¨ç´¯è®¡å¼€æ’­è®°å½•æ•°</th>
            <th>å‘¨å‡æ’­æ—¶(å°æ—¶)</th>
            <th>å‘¨ç´¯è®¡æµæ°´(å…ƒ)</th>
            <th>å‘¨ç´¯è®¡ä¸»æ’­åˆ†æˆ(å…ƒ)</th>
            <th>å‘¨ç´¯è®¡å…¬å¸åˆ†æˆ(å…ƒ)</th>
            <th>å‘¨ç´¯è®¡åº•è–ª(å…ƒ)</th>
            <th>å‘¨ç´¯è®¡æ¯›åˆ©(å…ƒ)</th>
          </tr>
        </thead>
        <tbody id="weekly-details-body"></tbody>
      </table>
    </div>
    <div class="empty-state" id="weekly-empty-state" style="display: none;">
      <p>æœ¬å‘¨æš‚æ— å¼€æ’­è®°å½•</p>
    </div>
  </div>
</div>

<style>

.date-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0;
  padding: 16px;
  background: var(--table-header);
  border-radius: 8px;
}

.date-controls { display: flex; align-items: center; gap: 12px; }
.date-display { font-weight: 600; }
.export-actions { display: flex; gap: 8px; }

.filter-section { margin: 16px 0; padding: 12px 16px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; }
.filter-controls { display: flex; align-items: center; gap: 8px; }
.filter-label { font-size: 14px; font-weight: 500; color: var(--text); margin: 0; }
.filter-select { padding: 6px 12px; border: 1px solid var(--gray); border-radius: 4px; font-size: 14px; background: #fff; min-width: 120px; }

.summary-section { margin: 24px 0; }
.section-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: var(--text); }
.summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 8px; }
.summary-card { background: #fff; border: 1px solid var(--gray); border-radius: 8px; padding: 16px; text-align: center; transition: box-shadow 0.2s ease; }
.summary-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.summary-card.danger-outline { border-color: #dc3545; }
.card-label { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
.card-value { font-size: 24px; font-weight: 700; color: var(--brand); }
.card-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
.summary-hint { font-size: 12px; color: var(--muted); margin-top: 4px; }

.details-section { margin: 24px 0; }
.table-container { overflow-x: auto; border: 1px solid var(--gray); border-radius: 8px; background: #fff; }
.report-table { width: 100%; border-collapse: collapse; min-width: 1500px; }
.report-table th, .report-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
.report-table th { background: var(--table-header); font-weight: 600; position: sticky; top: 0; z-index: 2; }
.report-table th.fixed-col, .report-table td.fixed-col { position: sticky; left: 0; background: #fff; background-clip: padding-box; min-width: 120px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.report-table td.fixed-col { z-index: 4; box-shadow: 2px 0 0 #eee; }
.report-table th.fixed-col { z-index: 5; box-shadow: 2px 0 0 #ddd; }
.report-table tbody tr:hover { background: #f8f9fa; }
.empty-state { text-align: center; padding: 40px; color: var(--muted); }
.pilot-link { color: var(--brand); text-decoration: none; font-weight: 600; }
.pilot-link:hover { color: var(--brand-dark); text-decoration: underline; }
.text-danger { color: #dc3545 !important; font-weight: 600; }

@media (max-width: 768px) {
  .date-navigation { flex-direction: column; gap: 12px; }
  .filter-controls { flex-direction: column; align-items: flex-start; gap: 6px; }
  .filter-select { width: 100%; min-width: auto; }
  .summary-cards { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
  .summary-card { padding: 12px; }
  .card-value { font-size: 20px; }
  .report-table { font-size: 12px; }
  .report-table th, .report-table td { padding: 8px 6px; }
}
</style>

<script>
(function() {
  const app = document.getElementById('weeklyReportApp');
  if (!app) {
    return;
  }

  const ownerSelector = document.getElementById('ownerSelector');
  const modeSelector = document.getElementById('modeSelector');
  const weekDisplay = document.getElementById('weekly-date-display');
  const summaryCards = document.getElementById('weekly-summary-cards');
  const tableContainer = document.getElementById('weekly-table-container');
  const detailsBody = document.getElementById('weekly-details-body');
  const emptyState = document.getElementById('weekly-empty-state');
  const emptyStateText = emptyState.querySelector('p');
  const operatorsApi = "{{ url_for('users_api.get_operators') }}";
  const weeklyApi = "{{ url_for('new_reports_api.weekly_report_data') }}";
  const reportPageUrl = "{{ url_for('new_report.weekly_report') }}";
  const pilotPerformanceTemplate = "{{ url_for('pilot.pilot_performance', pilot_id='__PID__') }}";

  const rankMapping = {
    'å€™è¡¥æœºå¸ˆ': 'å€™é€‰äºº',
    'è®­ç»ƒæœºå¸ˆ': 'è¯•æ’­ä¸»æ’­',
    'å®ä¹ æœºå¸ˆ': 'å®ä¹ ä¸»æ’­',
    'æ­£å¼æœºå¸ˆ': 'æ­£å¼ä¸»æ’­'
  };

  let currentWeekStart = app.dataset.weekStart;
  let currentOwner = app.dataset.selectedOwner || 'all';
  let currentMode = app.dataset.selectedMode || 'all';
  const emptyFallbackText = emptyStateText ? emptyStateText.textContent : '';

  function formatMoney(value) {
    if (value === null || value === undefined) {
      return 'Â¥0.00';
    }
    return 'Â¥' + Number(value).toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function formatHours(value) {
    if (value === null || value === undefined) {
      return '0.0å°æ—¶';
    }
    return Number(value).toFixed(1) + 'å°æ—¶';
  }

  function normalizeRank(value) {
    if (!value) {
      return '';
    }
    return rankMapping[value] || value;
  }

  function renderSummary(summary) {
    const revenueSum = summary.revenue_sum || 0;
    const basepaySum = summary.basepay_sum || 0;
    const pilotShare = summary.pilot_share_sum || 0;
    const companyShare = summary.company_share_sum || 0;
    const profit = summary.profit_7d || (companyShare - basepaySum);

    const items = [
      { label: 'æ€»ä¸»æ’­æ•°é‡', value: (summary.pilot_count || 0).toLocaleString('zh-CN') },
      { label: 'ç´¯è®¡æµæ°´', value: formatMoney(revenueSum) },
      {
        label: 'ç´¯è®¡åº•è–ªæ”¯å‡º',
        value: formatMoney(basepaySum),
        sub: summary.conversion_rate !== null && summary.conversion_rate !== undefined ? `è½¬æ¢ç‡${summary.conversion_rate}%` : ''
      },
      { label: 'ç´¯è®¡ä¸»æ’­åˆ†æˆ', value: formatMoney(pilotShare) },
      { label: 'ç´¯è®¡å…¬å¸åˆ†æˆ', value: formatMoney(companyShare) },
      { label: '7å¤©ç›ˆåˆ©ï¼ˆä¸è®¡è¿”ç‚¹ï¼‰', value: formatMoney(profit), danger: profit < 0 }
    ];

    summaryCards.innerHTML = items.map(item => {
      const dangerClass = item.danger ? ' danger-outline' : '';
      const subHtml = item.sub ? `<div class="card-sub">${item.sub}</div>` : '';
      return `<div class="summary-card${dangerClass}">
        <div class="card-label">${item.label}</div>
        <div class="card-value">${item.value}</div>
        ${subHtml}
      </div>`;
    }).join('');
  }

  function renderDetails(details, dateStr) {
    if (!details || details.length === 0) {
      detailsBody.innerHTML = '';
      tableContainer.style.display = 'none';
      if (emptyStateText) {
        emptyStateText.textContent = emptyFallbackText;
      }
      emptyState.style.display = 'block';
      return;
    }

    const rows = details.map(detail => {
      const profitClass = detail.total_profit !== null && detail.total_profit < 0 ? 'text-danger' : '';
      const pilotUrl = pilotPerformanceTemplate.replace('__PID__', detail.pilot_id) + `?from=weekly_report&week_start=${encodeURIComponent(dateStr)}`;
      return `<tr>
        <td class="fixed-col"><a href="${pilotUrl}" class="pilot-link">${detail.pilot_display || ''}</a></td>
        <td>${detail.gender_age || ''}</td>
        <td>${detail.owner || ''}</td>
        <td>${normalizeRank(detail.rank)}</td>
        <td>${detail.records_count || 0}</td>
        <td>${formatHours(detail.avg_duration)}</td>
        <td>${formatMoney(detail.total_revenue)}</td>
        <td>${formatMoney(detail.total_pilot_share)}</td>
        <td>${formatMoney(detail.total_company_share)}</td>
        <td>${formatMoney(detail.total_base_salary)}</td>
        <td class="${profitClass}">${formatMoney(detail.total_profit)}</td>
      </tr>`;
    }).join('');

    detailsBody.innerHTML = rows;
    emptyState.style.display = 'none';
    tableContainer.style.display = 'block';
  }

  function showLoading() {
    const loadingState = document.getElementById('weekly-loading-state');
    const content = document.getElementById('weekly-content');
    const tableContainer = document.getElementById('weekly-table-container');
    const emptyState = document.getElementById('weekly-empty-state');

    loadingState.style.display = 'block';
    content.style.display = 'none';
    tableContainer.style.display = 'none';
    emptyState.style.display = 'none';
  }

  function showError(message) {
    const loadingState = document.getElementById('weekly-loading-state');
    const content = document.getElementById('weekly-content');
    const tableContainer = document.getElementById('weekly-table-container');
    const emptyState = document.getElementById('weekly-empty-state');
    const emptyStateText = emptyState.querySelector('p');

    loadingState.style.display = 'none';
    content.style.display = 'block';
    summaryCards.innerHTML = '';
    detailsBody.innerHTML = '';
    tableContainer.style.display = 'none';
    if (emptyStateText) {
      emptyStateText.textContent = message;
    }
    emptyState.style.display = 'block';
  }

  async function loadOwnerOptions() {
    try {
      const response = await fetch(operatorsApi);
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error ? payload.error.message : 'åŠ è½½è¿è¥å¤±è´¥');
      }
      const operators = payload.data || [];
      operators.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.nickname || user.username || user.id;
        ownerSelector.appendChild(option);
      });
      ownerSelector.value = currentOwner;
    } catch (error) {
      console.error('åŠ è½½ç›´å±è¿è¥åˆ—è¡¨å¤±è´¥ï¼š', error);
      ownerSelector.value = currentOwner;
    }
  }

  function buildWeeklyApiUrl() {
    const params = new URLSearchParams();
    if (currentWeekStart) {
      params.set('week_start', currentWeekStart);
    }
    if (currentOwner && currentOwner !== 'all') {
      params.set('owner', currentOwner);
    }
    if (currentMode && currentMode !== 'all') {
      params.set('mode', currentMode);
    }
    return `${weeklyApi}?${params.toString()}`;
  }

  async function loadWeeklyReport() {
    showLoading();
    try {
      const response = await fetch(buildWeeklyApiUrl());
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error ? payload.error.message : 'åŠ è½½å¤±è´¥');
      }
      const data = payload.data;
      const filters = payload.meta ? payload.meta.filters : null;
      currentWeekStart = data.week_start;
      if (filters) {
        currentOwner = filters.owner || 'all';
        currentMode = filters.mode || 'all';
      }
      if (weekDisplay) {
        weekDisplay.textContent = `${data.week_start}ï¼ˆå‘¨äºŒèµ·ï¼‰`;
      }
      ownerSelector.value = currentOwner;
      modeSelector.value = currentMode;
      // éšè—loadingçŠ¶æ€ï¼Œæ˜¾ç¤ºå†…å®¹
      const loadingState = document.getElementById('weekly-loading-state');
      const content = document.getElementById('weekly-content');
      loadingState.style.display = 'none';
      content.style.display = 'block';

      renderSummary(data.summary || {});
      renderDetails(data.details || [], data.week_start);
    } catch (error) {
      console.error('åŠ è½½å¼€æ’­æ–°å‘¨æŠ¥å¤±è´¥ï¼š', error);
      showError('æŠ¥è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
  }

  function navigate(params) {
    const url = new URL(reportPageUrl, window.location.origin);
    const targetWeek = params.week_start || currentWeekStart;
    const targetOwner = params.owner !== undefined ? params.owner : currentOwner;
    const targetMode = params.mode !== undefined ? params.mode : currentMode;
    if (targetWeek) {
      url.searchParams.set('week_start', targetWeek);
    }
    url.searchParams.set('owner', targetOwner || 'all');
    url.searchParams.set('mode', targetMode || 'all');
    window.location.href = url.toString();
  }

  ownerSelector.addEventListener('change', function() {
    navigate({ owner: this.value || 'all' });
  });

  modeSelector.addEventListener('change', function() {
    navigate({ mode: this.value || 'all' });
  });

  (async function init() {
    await loadOwnerOptions();
    await loadWeeklyReport();
  })();
})();
</script>
{% endblock %}
