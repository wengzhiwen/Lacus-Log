# 机师-作战日报

本设计文档定义“作战日报”的业务规则、计算口径、接口与页面交互。默认实现日视图；月视图先预留导航，不落地实现。

## 重要约定

- 所有数据库时间字段均为UTC存储，界面显示与日期分组一律按GMT+8处理。
- 日视图的“报表日”= 用户选择的本地日期（GMT+8）；未选择时取当前本地日期。
- 记录归属日期口径：按“作战记录的开始时间”换算为GMT+8后的自然日。
- 明细表排序：按“流水金额”逆序；金额相同时按“开始时间”逆序。

## 视图与导航

- 默认进入“日视图”。支持前一日、后一日翻页。
- 预留“月视图”入口（显示为不可用或“即将推出”）。
- 参考《机师-作战计划日历》的移动端交互，明细表支持左右滑动（横向滚动）。

## 数据层次与口径

日报由三层数据构成：

### 1）月度数据（截至报表日，含当日）
- 总机师数量：在当月从1号起至报表日（含）期间，存在至少一条作战记录的机师去重数。
- 总有效机师数量：同上范围内，累计"播时总和 ≥ 6小时"的机师去重数。
- 累计流水：同上范围内，作战记录"流水金额"的合计。
- 累计底薪支出：同上范围内，作战记录"底薪金额"的合计。
- 累计返点：当月截止到报表日为止，所有有资格获得返点的主播获得的返点的总和。
- 累计机师分成：同上范围内，所有作战记录按当日机师分成比例计算的机师分成金额合计。
- 累计公司分成：同上范围内，所有作战记录按当日公司分成比例计算的公司分成金额合计。
- 运营利润估算：累计公司分成 + 累计返点 - 累计底薪支出。

范围定义：将每条作战记录的“开始时间(UTC)→本地(GMT+8)”后得到本地日期 d，若 d 所属月份为报表日所在月份，且 d ≤ 报表日，则计入；d > 报表日或跨月均不计。

### 2）日报汇总（仅报表日）
- 总机师数量：报表日内存在至少一条作战记录的机师去重数。
- 总有效机师数量：报表日内累计"播时总和 ≥ 6小时"的机师去重数。
- 累计流水：报表日内作战记录"流水金额"的合计。
- 累计底薪支出：报表日内作战记录"底薪金额"的合计。
- 累计机师分成：报表日内所有作战记录按当日机师分成比例计算的机师分成金额合计。
- 累计公司分成：报表日内所有作战记录按当日公司分成比例计算的公司分成金额合计。

日期判断同“重要约定”的记录归属日期口径。

### 3）日报明细（不聚合，逐条记录）
每条明细对应一条作战记录，展示字段：
- 机师：`昵称（真实姓名）`
- 性别年龄：`年龄-性别icon`（性别icon：男♂/女♀/?）
- 所属：（若有快照显示快照，没有快照降级显示计时当前所属）
- 阶级：（若有快照显示快照，没有快照降级显示计时当前阶级）
- 作战区域：`参战形式@X-Y-Z`，不论参战形式为线上/线下，X/Y/Z都按作战记录中实际存储的快照显示
- 播时：按结束-开始计算，单位小时，保留1位小数
- 流水：记录中的流水金额
- 当前分成比例：从分成管理中按报表日取得的机师分成比例（显示百分比，如20%）
- 机师分成：该作战记录的流水金额 × 当日的机师分成比例
- 公司分成：该作战记录的流水金额 × 当日的公司分成比例
- 返点比例：根据返点计算逻辑，该主播在报表日符合的返点比例（0% / 5% / etc）
- 产生返点：该作战记录的流水金额 x 返点比例
- 底薪：作战记录中记录的底薪金额
- 当日毛利：公司分成 + 产生返点 - 底薪
- 3日平均流水：该机师最近3个"有作战记录的自然日"的总流水/3；若最近7日内开播不足3天则为空
- 月累计天数：该机师当月（至报表日）有作战记录的天数（去重自然日）
- 月日均播时：该机师当月（至报表日）总播时 / 月累计天数
- 月累计流水：该机师当月（至报表日）流水合计
- 月累计机师分成：该机师当月（至报表日）按每日机师分成比例计算的机师分成金额合计
- 月累计公司分成：该机师当月（至报表日）按每日公司分成比例计算的公司分成金额合计
- 月累计返点：当月截止到报表日为止，该主播获得的返点的总和
- 月累计底薪：该机师当月（至报表日）底薪合计
- 月累计毛利：月累计公司分成 + 月累计返点 - 月累计底薪

明细排序：按“流水金额”降序，其次“开始时间”降序。

## 指标定义与计算细则

### 时间口径
- 自然日：以GMT+8为界的 00:00:00 ~ 23:59:59。
- 播时计算：`max(结束, 开始) 且 结束 ≥ 开始`；单位小时，建议按秒差/3600并四舍五入到1位小数。
- 月范围：报表日所在自然月的1号00:00:00 至 报表日23:59:59（均按GMT+8）。

### 3日平均流水
步骤：
1. 以报表日为基准，向前滚动自然日；
2. 找到该机师最近的3个“至少有一条作战记录”的自然日 D1、D2、D3（均按开始时间换算到本地日归属）；
3. 若在滚动7个自然日内未能凑齐3天，则结果为空；
4. 否则，`(sum(流水 at D1) + sum(流水 at D2) + sum(流水 at D3)) / 3`。

### 有效机师
- 当日有效机师：报表日内该机师的"播时总和 ≥ 6小时"。
- 月度有效机师：月范围内该机师"播时总和 ≥ 6小时"。

### 分成计算规则
分成计算基于机师分成管理模块的调整记录，按以下规则执行：

- 从 机师-分成管理模块 获取，不要重写逻辑
- 参考 docs/机师-分成管理.md 文档

### 返点计算规则
返点基于月度任务完成情况计算，任务分为5个阶段，每个阶段有不同的条件：

**阶段一**：直播有效天≥12天，直播有效时长≥42小时，视频直播流水≥1000元，返点比例5%
**阶段二**：直播有效天≥18天，直播有效时长≥100小时，视频直播流水≥5000元，返点比例7%
**阶段三**：直播有效天≥18天，直播有效时长≥100小时，视频直播流水≥10000元，返点比例11%
**阶段四**：直播有效天≥22天，直播有效时长≥130小时，视频直播流水≥30000元，返点比例14%
**阶段五**：直播有效天≥22天，直播有效时长≥130小时，视频直播流水≥80000元，返点比例18%

**计算规则**：
1. 统计范围：当月1号至报表日（含）的所有作战记录
2. 计算指标：
   - 直播有效天数：有作战记录且单次播时≥60分钟的自然日去重数
   - 直播有效时长：所有作战记录的播时总和（小时）
   - 视频直播流水：所有作战记录的流水金额总和（元）
3. 返点确定：主播可能同时符合多个阶段条件，取最高档次的返点比例
4. 返点金额：该主播当月（截止至报表日）累计流水 × 返点比例
5. 每个主播只能获得一档返点（取最高档，不可重复获得）

**重要说明**：
- 流水条件为"达到"而非"区间"，例如阶段一要求流水≥1000元，达到1000元即符合条件
- 主播可能同时符合多个阶段，系统自动取最高档次的返点比例
- 开闭区间表达方式仅为行业习惯，不设置流水上限

## 数据来源与模型映射

- 基础表：`作战记录（BattleRecord）`，字段参考《机师-作战记录》设计文档：
  - 主播（机师ID）
  - 开始时间、结束时间（UTC时间戳）
  - 流水金额、底薪金额
  - 参战形式、X/Y/Z坐标快照、所属快照

- 辅助表：`pilots`（性别、出生年、阶级、昵称/真实姓名、所属等）

- 分成管理表：`机师分成调整记录`，字段参考《机师-分成管理》设计文档：
  - 机师ID
  - 调整日（UTC时间戳）
  - 调整值（0-50，表示0%-50%）
  - 是否有效（软删除标记）

## 接口设计（后端）

建议新增以下只读接口，返回JSON供模板渲染：

- GET `/reports/daily?date=YYYY-MM-DD`
  - 入参：`date`（可选），本地日期（GMT+8）；不传则取今日。
  - 出参：
    - `month_summary`: { `pilot_count`, `effective_pilot_count`, `revenue_sum`, `basepay_sum`, `rebate_sum`, `pilot_share_sum`, `company_share_sum`, `operating_profit` }
    - `day_summary`: { `pilot_count`, `effective_pilot_count`, `revenue_sum`, `basepay_sum`, `pilot_share_sum`, `company_share_sum` }
    - `details`: 数组，包含上述"日报明细"字段
    - `pagination`: { `date`, `prev_date`, `next_date` }

- GET `/reports/daily/export.csv?date=YYYY-MM-DD`
  - 返回CSV（UTF-8带BOM，分隔符逗号，换行CRLF），字段同明细表，用于直接被Microsoft Excel打开无乱码。

实现要点：
- 使用 `utils/timezone_helper.py` 做UTC↔本地的统一转换。
- 查询范围一律以"开始时间换算到本地日"的归属进行聚合与过滤，避免跨日记录被错误计入。
- 对机师信息读`pilots`，需容错（昵称或真实姓名缺失时的展示降级）。
- 分成计算需要调用机师分成管理模块的接口，根据作战记录日期获取对应的机师分成比例。
- 分成金额计算：机师分成 = 流水金额 × 机师分成比例，公司分成 = 流水金额 × 公司分成比例。
- 月累计分成需要按日期逐日计算，不能简单使用当前分成比例乘以月累计流水。
- 返点比例计算：根据返点计算规则，确定该主播在报表日符合的返点比例（0% / 5% / 7% / 11% / 14% / 18%）。
- 产生返点计算：该作战记录的流水金额 × 返点比例。
- 毛利计算：当日毛利 = 公司分成 + 产生返点 - 底薪；月累计毛利 = 月累计公司分成 + 月累计返点 - 月累计底薪。
- 运营利润估算：累计公司分成 + 累计返点 - 累计底薪支出。

## 模板与交互（前端）

- 新增模板：`templates/reports/daily.html`
  - 顶部日期选择器，左右切换按钮（前一日/后一日）。
  - 展示"月度数据卡片八项""日报汇总六项"。
  - 下方"日报明细"表格，支持横向滚动；表头固定，列顺序与字段对齐。
  - 表格右上角提供"导出CSV"按钮（链接到导出接口）。

列建议（供实现时参考）：
`机师 | 性别年龄 | 所属 | 阶级 | 作战区域 | 播时 | 流水 | 当前分成比例 | 机师分成 | 公司分成 | 返点比例 | 产生返点 | 底薪 | 当日毛利 | 3日平均流水 | 月累计天数 | 月日均播时 | 月累计流水 | 月累计机师分成 | 月累计公司分成 | 月累计返点 | 月累计底薪 | 月累计毛利`

## CSV导出规范

- 编码：UTF-8 with BOM。
- 分隔符：逗号`,`；文本字段使用双引号包裹，内部双引号需转义为两个双引号。
- 数值：不使用千分位，保留两位小数的金额字段：流水、机师分成、公司分成、产生返点、底薪、当日毛利、月累计流水、月累计机师分成、月累计公司分成、月累计返点、月累计底薪、月累计毛利；播时保留1位小数；当前分成比例和返点比例显示为百分比格式（如20%、5%）。
- 日期时间字段若输出，统一为本地时间`YYYY-MM-DD HH:MM`。
- 首行作为表头，列顺序与页面明细一致。

## 性能与索引建议

- 为 `BattleRecord(pilot, start_time)` 建立复合索引，如有必要还可以建立更多索引；
- 为 `机师分成调整记录(pilot_id, adjustment_date, is_valid)` 建立复合索引，优化分成比例查询性能；
- 常用聚合可按"归属本地日"进行分组聚合；
- 分成计算涉及多表关联，建议在应用层缓存机师分成比例，避免重复查询；
- 返点计算需要按月统计机师数据，建议建立 `BattleRecord(pilot, start_time)` 的月分区索引；
- 毛利计算涉及多个字段的实时计算，建议在应用层缓存计算结果，避免重复计算；

## 权限与审计

- 权限沿用既有：议长、舰长可访问。

## 非目标

- 暂不实现月视图；
- 暂不实现筛选器（所属/阶级等），后续迭代再评估。


