# 主播-主播业绩

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；参战形式→开播方式；战斗区域→开播地点；阶级→主播分类；所属→直属运营；Z坐标→坐席；作战计划→通告；作战记录→开播记录；作战日报→开播日报。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。

本设计文档定义"主播业绩页"的业务规则、计算口径、接口与页面交互。该页面专门展示单个主播的业绩数据，参考开播日报的设计风格和计算方法。

## 重要约定

- 所有数据库时间字段均为UTC存储，界面显示与日期分组一律按GMT+8处理。
- 记录归属日期口径：按"开播记录的开始时间"换算为GMT+8后的自然日。
- 计算方法参考开播日报，但只计算指定主播的数据。
- 页面风格和布局参考开播日报，但不需要日期选择功能。

## 页面结构

### 页头显示主播基本信息（尽量压缩高度）
- **昵称**：超链接，点击可跳转到主播详情页面
- 真实姓名（括号内显示）
- 年龄（性别icon）籍贯
- 直属运营[主播分类]
- 主播状态

### 本月统计（月初至今日）
- 开播记录数：以开播记录中的开播时间为准
- 开播时数[平均时数，时数/记录数，单位小时保留1位小数]
- 累计流水[日均流水]
- 累计底薪[日均底薪]
- 累计返点
- 累计公司分成
- 运营利润估算[日均运营利润]

### 近7日统计（最近的7条开播记录，不足7条就是所有）
- 开播记录数：以开播记录中的开播时间为准
- 开播时数[平均时数，时数/记录数，单位小时保留1位小数]
- 累计流水[日均流水]
- 累计底薪[日均底薪]
- 累计返点
- 累计公司分成
- 近日盈亏（不计返点）[日均盈亏]

### 近3日统计（雷同上述7日，不赘述）
- 开播记录数：以开播记录中的开播时间为准
- 开播时数[平均时数，时数/记录数，单位小时保留1位小数]
- 累计流水[日均流水]
- 累计底薪[日均底薪]
- 累计返点
- 累计公司分成
- 近日盈亏（不计返点）[日均盈亏]

### 最近开播记录
- 以开播记录模块的列表的格式显示，该主播最近的30条开播记录，按开播时间逆序排列
- 格式、style与开播记录模块的列表项目完全相同
- 点击可以跳转开播记录详情页

## 数据层次与口径

### 1）本月统计（截至今日，含当日）
- 开播记录数：当月1号起至今日（含）期间，该主播的开播记录总数
- 开播时数：同上范围内，开播记录"播时"的合计
- 平均时数：开播时数 / 开播记录数，保留1位小数
- 累计流水：同上范围内，开播记录"流水金额"的合计
- 日均流水：累计流水 / 当月天数（截至今日）
- 累计底薪：同上范围内，开播记录"底薪金额"的合计
- 日均底薪：累计底薪 / 开播记录数，保留2位小数
- 累计返点：当月截止到今日为止，该主播获得的返点总和
- 累计公司分成：同上范围内，所有开播记录按当日公司分成比例计算的公司分成金额合计
- 运营利润估算：累计公司分成 + 累计返点 - 累计底薪
- 日均运营利润：运营利润估算 / 开播记录数，保留2位小数

范围定义：将每条开播记录的"开始时间(UTC)→本地(GMT+8)"后得到本地日期 d，若 d 属于当月且 d ≤ 今日，则计入。

### 2）近7日统计（最近的7条开播记录）
- 开播记录数：该主播最近7条开播记录的数量（不足7条就是所有）
- 开播时数：最近7条开播记录的播时合计
- 平均时数：开播时数 / 开播记录数，保留1位小数
- 累计流水：最近7条开播记录的流水金额合计
- 日均流水：累计流水 / 7（或实际记录数）
- 累计底薪：最近7条开播记录的底薪金额合计
- 日均底薪：累计底薪 / 开播记录数，保留2位小数
- 累计返点：最近7条开播记录的返点金额合计
- 累计公司分成：最近7条开播记录按当日公司分成比例计算的公司分成金额合计
- 近日盈亏（不计返点）：累计公司分成 - 累计底薪
- 日均盈亏：近日盈亏 / 开播记录数，保留2位小数

### 3）近3日统计（最近的3条开播记录）
- 开播记录数：该主播最近3条开播记录的数量（不足3条就是所有）
- 开播时数：最近3条开播记录的播时合计
- 平均时数：开播时数 / 开播记录数，保留1位小数
- 累计流水：最近3条开播记录的流水金额合计
- 日均流水：累计流水 / 3（或实际记录数）
- 累计底薪：最近3条开播记录的底薪金额合计
- 日均底薪：累计底薪 / 开播记录数，保留2位小数
- 累计返点：最近3条开播记录的返点金额合计
- 累计公司分成：最近3条开播记录按当日公司分成比例计算的公司分成金额合计
- 近日盈亏（不计返点）：累计公司分成 - 累计底薪
- 日均盈亏：近日盈亏 / 开播记录数，保留2位小数

### 4）最近开播记录列表
- 显示该主播最近的30条开播记录
- 按开播时间逆序排列
- 格式与开播记录模块的列表项目完全相同
- 支持点击跳转到开播记录详情页

## 指标定义与计算细则

### 时间口径
- 自然日：以GMT+8为界的 00:00:00 ~ 23:59:59
- 播时计算：`max(结束, 开始) 且 结束 ≥ 开始`；单位小时，按秒差/3600并四舍五入到1位小数
- 月范围：当前自然月的1号00:00:00 至 今日23:59:59（均按GMT+8）

### 分成计算规则
分成计算基于主播分成管理模块的调整记录，按以下规则执行：
- 从主播分成管理模块获取，不要重写逻辑
- 参考 docs/主播-分成管理.md 文档

### 返点计算规则
返点基于月度任务完成情况计算，任务分为5个阶段，每个阶段有不同的条件：
- **阶段一**：直播有效天≥12天，直播有效时长≥42小时，视频直播流水≥1000元，返点比例5%
- **阶段二**：直播有效天≥18天，直播有效时长≥100小时，视频直播流水≥5000元，返点比例7%
- **阶段三**：直播有效天≥18天，直播有效时长≥100小时，视频直播流水≥10000元，返点比例11%
- **阶段四**：直播有效天≥22天，直播有效时长≥130小时，视频直播流水≥30000元，返点比例14%
- **阶段五**：直播有效天≥22天，直播有效时长≥130小时，视频直播流水≥80000元，返点比例18%

**计算规则**：
1. 统计范围：当月1号至今日（含）的所有开播记录
2. 计算指标：
   - 直播有效天数：有开播记录且单次播时≥60分钟的自然日去重数
   - 直播有效时长：所有开播记录的播时总和（小时）
   - 视频直播流水：所有开播记录的流水金额总和（元）
3. 返点确定：主播可能同时符合多个阶段条件，取最高档次的返点比例
4. 返点金额：该主播当月（截止至今日）累计流水 × 返点比例
5. 每个主播只能获得一档返点（取最高档，不可重复获得）

## 数据来源与模型映射

- 基础表：`开播记录（BattleRecord）`，字段参考《主播-开播记录》设计文档
- 辅助表：`pilots`（性别、出生年、主播分类、昵称/真实姓名、直属运营等）
- 分成管理表：`主播分成调整记录`，字段参考《主播-分成管理》设计文档

## 缓存机制

主播业绩页的计算结果采用内存缓存机制：

- **缓存时间**：5分钟（300秒）
- **缓存范围**：返点计算（`_calculate_pilot_rebate`）和业绩统计（`_calculate_pilot_performance_stats`）
- **缓存键**：基于函数名和参数生成MD5哈希值
- **缓存失效**：5分钟后自动过期，或服务重启时清空
- **实现方式**：使用`cachetools`库的`TTLCache`实现
- **性能提升**：相同主播5分钟内不会重新计算，显著提升业绩页面响应速度

## 接口设计（后端）

建议新增以下只读接口，返回JSON供模板渲染：

- GET `/pilots/<pilot_id>/performance`
  - 入参：`pilot_id`，主播ID
  - 出参：
    - `pilot_info`: { `nickname`, `real_name`, `age`, `gender_icon`, `hometown`, `owner`, `rank` }
    - `month_stats`: { `record_count`, `total_hours`, `avg_hours`, `total_revenue`, `daily_avg_revenue`, `total_basepay`, `daily_avg_basepay`, `total_rebate`, `total_company_share`, `operating_profit`, `daily_avg_operating_profit` }
    - `week_stats`: { `record_count`, `total_hours`, `avg_hours`, `total_revenue`, `daily_avg_revenue`, `total_basepay`, `daily_avg_basepay`, `total_rebate`, `total_company_share`, `operating_profit`, `daily_avg_operating_profit` }
    - `three_day_stats`: { `record_count`, `total_hours`, `avg_hours`, `total_revenue`, `daily_avg_revenue`, `total_basepay`, `daily_avg_basepay`, `total_rebate`, `total_company_share`, `operating_profit`, `daily_avg_operating_profit` }
    - `recent_records`: 数组，包含最近30条开播记录的基本信息

实现要点：
- 使用 `utils/timezone_helper.py` 做UTC↔本地的统一转换
- 查询范围一律以"开始时间换算到本地日"的归属进行聚合与过滤
- 分成计算需要调用主播分成管理模块的接口，根据开播记录日期获取对应的主播分成比例
- 分成金额计算：主播分成 = 流水金额 × 主播分成比例，公司分成 = 流水金额 × 公司分成比例
- 返点比例计算：根据返点计算规则，确定该主播符合的返点比例
- 毛利计算：运营利润估算 = 累计公司分成 + 累计返点 - 累计底薪
- 日均计算：日均底薪 = 累计底薪 / 开播记录数，日均运营利润 = 运营利润 / 开播记录数，日均盈亏 = 盈亏 / 开播记录数

## 模板与交互（前端）

- 新增模板：`templates/pilots/performance.html`
  - 页头显示主播基本信息（压缩高度）
  - 展示"本月统计""近7日统计""近3日统计"三个统计卡片
  - 统计卡片中显示累计数值和对应的日均数值（底薪、运营利润、盈亏）
  - 下方"最近开播记录"表格，支持横向滚动
  - 表格项目格式与开播记录模块的列表项目完全相同
  - 支持点击跳转到开播记录详情页

## 页面入口

本主播业绩页有多个入口，已实现完整的返回导航功能：

### 1、开播日报-日报明细表中
- 每一行第一列的主播列可点击
- 点击后跳转到本主播业绩页，携带来源参数 `from='daily_report'`、`date`、`owner`
- 返回按钮显示"返回开播日报"，能正确回到原开播日报页面并保持筛选条件

### 2、开播月报-月报明细表中
- 每一行第一列的主播列可点击
- 点击后跳转到本主播业绩页，携带来源参数 `from='monthly_report'`、`month`
- 返回按钮显示"返回开播月报"，能正确回到原开播月报页面

### 3、主播管理-主播详情页
- 右上角添加业绩查看按钮
- 点击后跳转到本主播业绩页，携带来源参数 `from='pilot_detail'`
- 返回按钮显示"返回主播详情"，能正确回到主播详情页

### 4、开播记录-开播记录详情页-基本信息-主播行
- 右侧增加业绩查看超链接
- 点击后跳转到本主播业绩页，携带来源参数 `from='battle_record_detail'`、`record_id`
- 返回按钮显示"返回开播记录详情"，能正确回到开播记录详情页

### 5、主播业绩页内部导航
- 页头主播昵称为超链接，点击可跳转到主播详情页面
- 跳转时携带来源参数 `from='performance'`，确保从主播详情页返回时能正确回到主播业绩页

### 6、返回按钮功能
- 页面顶部提供返回按钮，统一显示"返回"文字
- 根据来源参数自动跳转到对应的返回目标
- 支持保留原页面的筛选条件和参数
- 无来源参数时默认返回主播管理列表页面

## 权限与审计

- 权限沿用既有：管理员、运营可访问
- 访问日志记录到app.log文件中

## 性能与索引建议

- 为 `BattleRecord(pilot, start_time)` 建立复合索引
- 为 `主播分成调整记录(pilot_id, adjustment_date, is_valid)` 建立复合索引
- 常用聚合可按"归属本地日"进行分组聚合
- 分成计算涉及多表关联，建议在应用层缓存主播分成比例
- 返点计算需要按月统计主播数据，建议建立相关索引

## 非目标

- 暂不实现日期选择功能（固定为当前时间）
- 暂不实现数据导出功能
- 暂不实现筛选器功能
