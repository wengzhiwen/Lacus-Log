# 基础技术设计

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；征召→招募；参战形式→开播方式；战斗区域→开播地点；作战计划→通告；作战记录→开播记录。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。
## 动态网页技术实现

python3.12 + flask

生产环境计划使用 gunicorn 服务器

### 基础结构

- 网页模板（Jinjia2）：传统服务端渲染页面
- Python实现业务逻辑
    - **REST API 优先**：所有新功能必须提供 REST API 接口（`routes/*_api.py`）
    - 传统页面视图（`routes/*.py`）：用于页面渲染，可选择性保留或迁移到前端
    - 不提供任何对外的 API，仅供域内使用
- 所有数据持久到MongoDB
- 缓存根据实际需要
    - 部分TTL较长的缓存使用MongoDB
    - 部分数据量极小的缓存采用cachetools.TTLCache

### 基础安全

系统采用双轨认证方案：

1. **传统页面认证**：基于 Flask-Security-Too 的表单会话登录（Session Cookie）
   - 用户名+密码登录
   - Flask-WTF/CSRFProtect 提供 CSRF 保护
   - 适用于传统服务端渲染页面

2. **REST API 认证**：基于 Flask-JWT-Extended 的 JWT 认证
   - 支持 Cookie 和 Header 双模式（优先使用 Cookie）
   - Access Token（24小时有效期）+ Refresh Token（30天有效期）
   - CSRF 保护：已完全移除CSRF机制，采用JWT认证统一管理安全
   - 认证接口：`/api/auth/login`、`/api/auth/logout`、`/api/auth/refresh`
   - 角色权限控制：`@jwt_required()` + `@roles_required('role_name')`

3. **SSE 实时通知**：基于 Server-Sent Events 的单向推送通道
   - 复用 REST API 的 JWT Cookie 认证，无需额外依赖
   - `EventSource` 自动重连，支持指数退避策略
   - 适用于招募操作实时记录、轻量系统通知等场景

## 数据库

MongoDB，数据库名： lacus，必要时主动创建

`database_design.md` 文件中记录最新的数据结构设计和INDEX结构设计。

因为总体数据量级不大，倾向于创建更多的INDEX来提升系统性能。
- INDEX应在每次系统启动时进行检查，缺少时进行创建

## 日志系统指南

本项目使用 Python 内置的 `logging` 模块来统一记录应用日志。合理的日志配置对于开发、调试和生产环境的监控至关重要。

### 日志文件结构

所有日志文件都存储在 `log/` 目录下，每个不同的LoggerName具有独立的文件命名，并按自然日自动切分。

```
log/
├── app_YYYYMMDD.log           # 主应用日志（按日命名）
├── <LoggerName1>_YYYYMMDD.log     # 各功能模块独立日志（按日命名）
└── <LoggerName2>_YYYYMMDD.log   # 各功能模块独立日志（按日命名）
```

## 配置管理

不论生产环境还是开发环境，都使用 ./.env 文件来进行配置管理，使用 python-dotenv 来读取。

当需要在 ./.env 文件中新增配置时，应更新 `./env.sample` 文件。 
>AI AGENT可能没有权限读取./.env文件，这是正常的，该文件将完全由用户管理

系统启动时通过 python-dotenv 读取 `.env` 文件；大部分配置（如 `SECRET_KEY`、`SECURITY_*`、`MONGODB_URI` 等）若未显式设置将回退到代码内的默认值。
只有在 MongoDB 连接失败时会记录 ERROR 并终止启动。

## 基础用户模块

本系统只要最基本的用户密码登录、登出、角色管理，因而选用 Flask-Security-Too 。

## 招募实时通知（SSE）

系统采用 Server-Sent Events（SSE）为前端提供单向实时推送，主要用于招募操作记录面板。

### 技术架构

- **服务端**：Flask `Response` + 自定义 `RecruitEventStreamManager`，以 JSON 格式输出 `text/event-stream`；
- **认证**：复用 JWT Cookie 认证链路；
- **连接策略**：浏览器原生自动重试，配合前端指数退避；
- **心跳机制**：30 秒无事件时发送 `: keep-alive` 保持连接。

### 连接管理

- 页面加载时创建 `new EventSource('/api/recruits/operations/stream', { withCredentials: true })`；
- 前端监听 `onopen/onerror/onmessage`，根据状态更新 UI 并处理错误；
- 可见性变化时（Tab 切回）自动检查连接状态并按需重建。

### 事件推送

- 后端在 `record_recruit_operation` 保存日志后调用 `publish_recruit_operation_event` 广播；
- 事件负载为 JSON，包含操作人、时间、类型、主播等信息；
- 队列满时记录告警但不阻塞主业务逻辑。

### 前端集成

- 无需额外依赖，基于浏览器原生 `EventSource`；
- 断线后展示「连接中...」状态并自动重试；
- 仍保留 REST 接口 `/api/recruits/operations` 作为页面初次加载和手动刷新兜底。

## 时间戳处理

本系统在数据库中存放的时间戳数据一律为UTC时间，但在UI上显示时一律显示为GMT+8时间。

用户在UI上输入的时间也一律时GMT+8时间，存储到数据库时影转换为UTC时间。

所有业务逻辑中，如果涉及与时间相关的比较或计算的，一律统一转化成GMT+8后再进行后续逻辑，以减少出错的可能性。
