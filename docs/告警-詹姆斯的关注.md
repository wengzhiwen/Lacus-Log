# 告警-詹姆斯的关注

> 术语统一记录（2025-09-28）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；作战记录→开播记录；作战计划→通告；征召→招募；所属→直属运营；阶级→主播分类。

本设计文档定义"詹姆斯的关注"警告邮件功能的业务规则、触发条件、计算口径与邮件内容格式。该功能专门用于监控低业绩不努力的主播，为管理决策提供数据支持。

## 重要约定

- 所有数据库时间字段均为UTC存储，界面显示与日期分组一律按GMT+8处理。
- 触发机制：仅在底薪申请被确认发放（状态切换为`approved`）时触发，不依赖定时任务。
- 运算过程：**绝对不能**阻塞底薪申请的状态更新，对前端用户完全无感。
- 日志记录：使用INFO级别记录跳过原因，使用DEBUG级别记录详细计算过程。

## 功能概览

### 定位
面向管理员的主播业绩预警机制，通过邮件及时通知需要关注的低业绩主播。

### 触发方式
- 仅在底薪申请执行“确认发放”操作、状态从非`approved`更新为`approved`时触发
- 不在邮件报表页面提供手动触发入口
- 完全异步执行，不影响底薪申请状态更新操作

### 收件人
- 从用户模块获取所有激活的运营和管理员邮箱
- 去重后发送，确保不重复通知

## 触发条件

当底薪申请被确认发放时，首先读取该申请关联的开播记录，并检查以下所有条件是否同时满足：

1. **流水不为0**：关联开播记录的 `revenue_amount > 0`
2. **流水小于250元**：`revenue_amount < 250`
3. **播时小于7小时**：`duration_hours < 7`
4. **底薪大于等于100元**：申请的 `base_salary_amount >= 100`

如果任一条件不满足，则记录INFO日志说明跳过原因，不进行后续运算。

## 运算逻辑

当触发条件满足时，对该主播进行一次主播业绩的完整计算（调用现有的 `_calculate_pilot_performance_stats` 方法，底薪统计统一按已发放的底薪申请金额计算），检查以下条件是否全部满足：

1. **近3日平均时数小于7小时**：`three_day_stats['avg_hours'] < 7`
2. **近3日盈亏小于100元**：`three_day_stats['operating_profit'] < 100`
3. **近7日盈亏小于250元**：`week_stats['operating_profit'] < 250`
4. **本月运营利润估算小于0**：`month_stats['operating_profit'] < 0`

如果任一条件不满足，则记录INFO日志说明跳过原因，不发送告警邮件。

## 告警邮件

### 邮件配置
- **发送工具**：使用 `utils/mail_utils.py` 的 `send_email_md()` 方法
- **邮件格式**：Markdown格式，自动转换为HTML邮件
- **主题**：`拉科斯警告 詹姆斯正在关注这个主播`

### 邮件内容结构

#### H1标题
```
{主播昵称}（{真实姓名}）正在受到詹姆斯的关注
```

#### H2标题：基本信息
- **年龄（性别icon）籍贯**：`{年龄}岁{性别icon} {籍贯}`
- **主播分类**：当前主播分类
- **分成比例**：`{当前分成比例}%`（基于分成模块，使用邮件发出时刻的分成比例）
- **直属运营**：主播当前的直属运营
- **招募负责人**：与该主播关联的创建日期最新的一条招募记录中的关联负责人的昵称
- **主播状态**：主播当前的状态

#### 业绩数据板块
邮件内容与主播业绩页完全相同，分为4个部分，且所有底薪数值均依据关联开播记录的“已发放”底薪申请金额统计（忽略开播记录自身的 `base_salary` 字段）：

1. **本月统计**：月初至今日的统计数据
2. **近7日统计**：最近7条开播记录的统计数据
3. **近3日统计**：最近3条开播记录的统计数据
4. **最近开播记录列表**：最近10条开播记录的表格（按时间倒序）

### 邮件格式化要求
- 使用Markdown表格格式展示数据
- 金额字段使用千分位分隔符
- 时间字段使用GMT+8本地时间显示
- 负数以文本方式标注（如：-123.45元）
- 适应邮件阅读环境，保持良好的可读性

## 数据来源与计算

### 基础数据
- **开播记录**：`BattleRecord` 模型
- **主播信息**：`Pilot` 模型
- **招募记录**：`Recruit` 模型
- **分成管理**：通过 `utils/commission_helper.py` 获取当前分成比例
- **底薪申请**：`BaseSalaryApplication` 模型，用于获取已发放的底薪金额

### 计算方法
- **主播业绩计算**：调用现有的 `_calculate_pilot_performance_stats()` 方法
- **分成比例获取**：调用 `get_pilot_commission_rate_for_date()` 方法
- **招募负责人获取**：查询该主播最新的招募记录
- **底薪金额聚合**：查询关联的 `BaseSalaryApplication`，仅累计状态为 `approved` 的申请金额

### 时间处理
- 严格遵循UTC存储、GMT+8显示的时间规范
- 使用 `utils/timezone_helper.py` 进行时间转换
- 日期归属按开播记录的开始时间换算为GMT+8后的自然日

## 实现要点

### 触发时机
- 在 `routes/base_salary_applications_api.py` 的状态更新（确认发放）逻辑中添加异步触发处理
- 使用 `threading.Thread` 或类似机制确保不阻塞主流程

### 错误处理
- 捕获所有异常，记录ERROR日志，但不影响底薪申请状态更新
- 邮件发送失败时记录ERROR日志，包含失败原因和主播信息

### 性能考虑
- 异步执行，不影响用户体验
- 合理使用数据库索引，避免大量查询影响系统性能
- 计算结果不缓存，确保数据实时性

### 日志规范
- **模块名**：`james_alert`
- **INFO级别**：触发条件不满足的跳过原因、邮件发送成功通知
- **DEBUG级别**：详细的计算过程和中间结果
- **ERROR级别**：异常错误和邮件发送失败
- **日志语言**：简体中文

## 邮件模板示例

```markdown
# 张三（李四）正在受到詹姆斯的关注

## 基本信息

- **年龄（性别icon）籍贯**：25岁♀ 北京
- **主播分类**：正式主播
- **分成比例**：20%
- **直属运营**：王五
- **招募负责人**：赵六

## 本月统计

| 指标 | 数值 |
|------|------|
| 开播记录数 | 15条 |
| 开播时数 | 45.5小时 [平均3.0小时] |
| 累计流水 | 1,234.56元 [日均44.09元] |
| 累计底薪 | 1,500.00元 [日均53.57元] |
| 累计返点 | 61.73元 |
| 累计公司分成 | 246.91元 |
| 运营利润估算 | -1,191.36元 [日均-42.55元] |

## 近7日统计

| 指标 | 数值 |
|------|------|
| 开播记录数 | 7条 |
| 开播时数 | 21.0小时 [平均3.0小时] |
| 累计流水 | 567.89元 [日均81.13元] |
| 累计底薪 | 700.00元 [日均100.00元] |
| 累计返点 | 28.39元 |
| 累计公司分成 | 113.58元 |
| 近日盈亏（不计返点） | -586.42元 [日均-83.77元] |

## 近3日统计

| 指标 | 数值 |
|------|------|
| 开播记录数 | 3条 |
| 开播时数 | 9.0小时 [平均3.0小时] |
| 累计流水 | 234.56元 [日均78.19元] |
| 累计底薪 | 300.00元 [日均100.00元] |
| 累计返点 | 11.73元 |
| 累计公司分成 | 46.91元 |
| 近日盈亏（不计返点） | -253.09元 [日均-84.36元] |

## 最近开播记录

| 开播时间 | 结束时间 | 播时 | 流水 | 底薪 | 备注 |
|----------|----------|------|------|------|------|
| 2025-09-28 14:00 | 2025-09-28 17:00 | 3.0小时 | 78.90元 | 100.00元 | - |
| 2025-09-27 14:00 | 2025-09-27 17:00 | 3.0小时 | 67.89元 | 100.00元 | - |
| 2025-09-26 14:00 | 2025-09-26 17:00 | 3.0小时 | 87.77元 | 100.00元 | - |
```

## 权限与审计

- **权限要求**：无特定权限要求，系统内部自动触发
- **审计日志**：记录所有告警邮件的发送情况和跳过原因
- **数据安全**：邮件内容包含敏感的业绩数据，确保收件人范围合理

## 非目标

- 暂不支持告警频率限制（如同一主播24小时内只告警一次）
- 暂不支持告警条件的动态配置
- 暂不支持告警邮件的模板自定义
- 暂不支持邮件退订功能

## 新主播第5/6笔底薪提醒

为强化詹姆斯关注链路，新增“新主播生存警告”邮件报表，仅在主播生涯早期的第5笔与第6笔底薪确认发放时提醒运营关注。

### 触发规则

1. 触发时机仍与詹姆斯关注保持一致：底薪申请状态从非`approved`变更为`approved`，并且处理过程必须异步执行。
2. 统计该主播所有状态为`approved`的底薪申请数量，若当前确认发放的申请使累计笔数等于5或6，则进入报表逻辑，否则记录INFO日志（例如“主播A当前第3笔底薪，非第5/6笔，跳过新主播警告”）并结束。
3. 该提醒只面向“活到第5/6天的新主播”，无需再次校验流水、播时等詹姆斯基础触发条件。

### 邮件内容

- **主题**：`拉科斯警告 这是一个活到了第{n}天的新主播`，其中`n`为当前累计已发放底薪笔数（5或6）。
- **正文结构**：
  - H1沿用 `{主播昵称}（{真实姓名}）正在接受新主播生存警告`，下方列出年龄/性别/籍贯、主播分类、分成比例、直属运营、招募负责人、主播状态等基础信息，格式与原詹姆斯邮件一致。
  - “近7日统计”板块：直接复用 `_calculate_pilot_performance_stats()` 的 `week_stats` 结果，展示记录数、总播时、总流水、总底薪、公司分成、运营利润/日均等数据，遵循原有的千分位与小数格式化。
  - “近7日明细”板块：列出最近7条开播记录（按时间倒序，若不足7条则全部列出），包含开始/结束时间（GMT+8）、播时、流水、底薪（基于已发放底薪申请）、备注等字段，采用Markdown表格并通过 `_apply_inline_table_styles()` 增强可读性。

### 收件人与日志

- 收件人复用 `get_alert_recipients()`，与詹姆斯常规警告完全一致。
- 日志模块仍为 `james_alert`：
  - DEBUG：记录触发计数和近7日统计的关键指标。
  - INFO：输出触发/跳过原因及发送结果，例如“主播B第5笔底薪触发新主播警告邮件已发送”。
  - ERROR：捕获异常或发送失败，记录详细堆栈。
