# 机师-机师征召

机师-机师征召用于管理对"未征召"机师发起的面试/招募流程工单。该模块仅支持从"机师详情页"的"启动征召"按钮进入创建流程，不支持独立新建空白征召。

征召流程采用三步制：启动征召 -> 训练征召 -> 结束征召，确保征召决策的严谨性和数据完整性。

## 重要约定

- 数据库存储的所有日期时间均为UTC；界面显示与输入均为GMT+8，必须严格遵守。
- 仅当机师当前状态为“未征召”时，机师详情页底部操作区显示并启用“启动征召”按钮。
- 征召对象唯一，且从机师详情页携带机师ID跳转；禁止无对象创建。
- CSRF：所有表单必须包含隐藏字段提交CSRF Token，严格参考现有模块写法。
- 日志：本模块的日志按自然日滚动，写入 `./log` 目录，必要时使用INFO，复杂流程留足DEBUG（中文）。

## 元数据

| 字段 | 说明 | 参考类型 | 设定 |
|---------|------|------|------|
| ID | 系统内部唯一编码，用户不可见 | 由技术设计 | 必须 唯一 |
| 机师 | 被征召的机师 | 关联到机师唯一ID | 必须，仅展示不可编辑 |
| 征召负责人 | 负责该征召的舰长 | 关联到用户唯一ID | 必须，默认=当前用户 |
| 预约时间 | 与机师约定的面试时间 | 时间戳UTC | 必须，默认=次日16:00（按GMT+8取值，入库UTC） |
| 渠道 | BOSS / 51 / 介绍 / 其他 | 枚举 | 必须 |
| 介绍费 | 人民币元，两位小数 | 数值 | 必须，默认=0 |
| 备注 | 补充信息 | 字符串 | 可选，≤200字 |
| 征召状态 | 已启动 / 训练征召中 / 已结束 | 枚举 | 必须，默认=已启动 |
| 训练征召决策 | 征召为训练机师 / 不征召 | 枚举 | 可选，训练征召步骤填写 |
| 训练征召决策人 | 做出训练征召决策的舰长 | 关联到用户唯一ID | 可选，训练征召步骤填写 |
| 训练征召决策时间 | 训练征召决策的时间 | 时间戳UTC | 可选，训练征召步骤填写 |
| 训练时间 | 与机师约定的试播时间 | 时间戳UTC | 可选，训练征召步骤填写 |
| 结束征召决策 | 正式机师 / 实习机师 / 不征召 | 枚举 | 可选，结束征召步骤填写 |
| 结束征召决策人 | 做出结束征召决策的舰长 | 关联到用户唯一ID | 可选，结束征召步骤填写 |
| 结束征召决策时间 | 结束征召决策的时间 | 时间戳UTC | 可选，结束征召步骤填写 |
| 变更记录 | 记录上述字段的所有修改日志（哪个用户什么时间把什么字段的值从什么改成了什么，修改时使用的IP地址是什么） | 由独立模型持久化（非嵌入JSON） | 非必须 |
| 创建时间 | 创建记录的时间 | 时间戳 | 必须，默认=当前UTC |
| 最后修改 | 最近一次修改时间 | 时间戳 | 必须，默认=当前UTC |

### 状态流转

- 创建：状态=已启动。
- 训练征召（征召为训练机师）：状态→训练征召中，同时对机师执行：阶级→训练机师；状态→已征召。
- 训练征召（不征召）：状态→已结束，同时对机师执行：状态→不征召。
- 结束征召（正式机师）：状态→已结束，同时对机师执行：阶级→正式机师；状态→已征召。
- 结束征召（实习机师）：状态→已结束，同时对机师执行：阶级→实习机师；状态→已征召。
- 结束征召（不征召）：状态→已结束，同时对机师执行：状态→不征召。
- 编辑页允许手动将状态改为"已结束"，但界面提示"不建议手动修改，推荐使用相应的征召决策"。

## 入口与导航

- 在主菜单新增“机师征召”入口，进入征召列表页。
- 机师详情页（状态=未征召）底部footbar显示“启动征召”按钮；点击跳转到“启动征召”页面（唯一入口）。

## 创建与编辑

### 启动征召（创建）
- 页面上部以卡片展示机师关键信息（昵称、性别/年龄、所属、当前阶级与状态）。
- 表单字段：
  - 征召负责人（选择舰长；默认=当前用户）
  - 预约时间（日期时间；默认=次日16:00，显示为GMT+8，入库UTC）
  - 渠道（枚举：BOSS / 51 / 介绍 / 其他；按该顺序显示）
  - 介绍费（人民币元；默认=0；两位小数）
  - 备注（可选）
  - 征召状态（默认=已启动，不在创建页中暴露为可编辑项）
- 校验：
  - 征召负责人不可为空且必须是舰长或以上权限。
  - 预约时间必填；入库前将GMT+8转换为UTC。
  - 渠道为枚举值；介绍费需为有效的非负金额（两位小数）。
  - CSRF Token 必须通过隐藏字段提交。
- footbar：
  - 左：返回
  - 右：创建（btn-primary）

### 编辑征召
- 展示内容与创建类似；与创建不同的是：
  - "征召状态"在编辑页可见且可编辑，取值=已启动/训练征召中/已结束。
  - 顶部保留机师信息卡片。
- 提示：采用文案提示"建议使用相应的征召决策来推进流程，不建议手动修改状态"。
- 校验与保存：同创建；更新时间戳；记录变更（时间、操作者、字段、前值、后值、IP）。

## 列表

- 菜单入口进入列表，默认筛选"征召状态=进行中"（包含已启动和训练征召中）。
- 筛选器：
  - 征召状态（进行中（默认）/ 已结束）
  - 征召负责人（选择舰长）
  - 渠道（BOSS / 51 / 介绍 / 其他）
- 排序：按预约时间升序。
- 列表项字段：机师昵称、预约时间（GMT+8显示）、训练时间（GMT+8显示）、渠道、征召负责人昵称、征召状态、当前决策状态。
- 交互：点击卡片进入征召详情。
- 空状态：显示友好提示与返回入口按钮。

## 详情

- 展示全部字段与机师信息卡片。
- 底部footbar按钮：编辑 / 训练征召 / 结束征召 / 变更记录。
- 按钮可用性：
  - 当"征召状态=已启动"时，"训练征召"可点击，"结束征召"置灰禁用。
  - 当"征召状态=训练征召中"时，"结束征召"可点击，"训练征召"置灰禁用。
  - 当"征召状态=已结束"时，所有征召操作按钮置灰禁用。
- 变更记录：弹窗展示最近100条变更记录，按变更发生的时间逆序排列。

  注：前端通过调用 GET `/recruits/<recruit_id>/changes` 获取JSON数据并渲染弹窗。

## 训练征召

- 页面顶部展示机师信息卡片。
- 表单：
  - 训练征召决策人（当前用户，只读展示，不可编辑）
  - 训练征召决策（征召为训练机师 / 不征召）
  - 训练时间（日期时间；当选择"征召为训练机师"时必填，显示为GMT+8，入库UTC）
  - 介绍费（允许再次编辑）
  - 备注（允许再次编辑）
- 当选择"征召为训练机师"时，需要填写机师基本信息：
  - 真实姓名（必填，最大20字符）
  - 出生年（必填，距今60年前-距今10年前）
  - 参战形式（必填，线下 / 线上 / 未知）
- 提示文案：
  - "该机师的阶级将自动变更为训练机师"
  - "该机师的状态将自动变更为已征召"
- 用户点击"确认"后：
  - 将该征召状态改为"训练征召中"。
  - 更新机师：阶级→训练机师；状态→已征召；同时更新机师的基本信息（真实姓名、出生年、参战形式）。
  - 写入相应变更记录与操作日志。
- CSRF：本页表单同样必须通过隐藏字段提交CSRF Token。

## 结束征召

- 页面顶部展示机师信息卡片。
- 表单：
  - 结束征召决策人（当前用户，只读展示，不可编辑）
  - 结束征召决策（正式机师 / 实习机师 / 不征召）
  - 介绍费（允许再次编辑）
  - 备注（允许再次编辑）
- 当选择"正式机师"或"实习机师"时，需要填写机师分配信息：
  - 所属（必填，从所有舰长/议长中选择）
  - 战区（必填，快手 / 抖音 / 其他 / 未知）
  - 阶级将根据征召决策自动设置（正式机师决策→正式机师阶级，实习机师决策→实习机师阶级）
- 提示文案：
  - "该机师的阶级将自动变更为选择的阶级"
  - "该机师的状态将自动变更为已征召"
- 用户点击"确认"后：
  - 将该征召状态改为"已结束"。
  - 更新机师：阶级→根据决策自动设置；状态→已征召；所属→选择的舰长；战区→选择的战区。
  - 写入相应变更记录与操作日志。
- CSRF：本页表单同样必须通过隐藏字段提交CSRF Token。

## 权限

- 议长、舰长：权限一致，均可见且可写（不限制所属）。
- 其他角色：遵循项目统一的权限策略（由技术实现）。

## UI与交互规范

- 参考《基础-UI风格》与《机师-作战记录》：
  - 移动优先、卡片列表、footbar吸附式操作按钮。
  - 主要按钮使用ZAFT红；禁用态灰色描边。
  - 表单组间距与输入框样式与既有模块保持一致。
- 时间显示统一使用Jinja2过滤器（如已有：local_datetime、local_date）。
- 列表卡片整体可点击，悬停/触摸有上浮与阴影反馈。

## 技术实现要点

- 时间处理：统一使用 `utils/timezone_helper.py` 的转换方法，确保"数据库UTC，UI GMT+8"。
- 模板：复用现有表单分组与footbar组件；CSRF Token 使用隐藏字段，遵循既有模板写法（如 `{{ csrf_token() }}`）。
- 日志：按模块输出到 `./log/recruit_YYYYMMDD.log`（命名示例），INFO用于关键节点，复杂流程用DEBUG。
- 排序与筛选：后端按筛选条件查询，默认状态=进行中（包含已启动+训练征召中）；按预约时间升序返回，分页按需实现（与既有模块一致）。
- 变更记录：记录字段级变更（时间、操作者、前值、后值、IP）。
- 变更记录API：提供 GET `/recruits/<recruit_id>/changes` 接口返回JSON格式的变更记录数据。
- 变更记录模型：RecruitChangeLog独立模型，支持字段级变更追踪和显示名称映射。
- 机师数据更新：通过机师管理模块提供的API方法更新机师信息，确保操作的原子性：
  - 训练征召时调用机师管理模块的更新方法，设置阶级、状态、基本信息。
  - 结束征召时调用机师管理模块的更新方法，设置阶级（根据决策自动设置）、状态、所属、战区。
- 数据校验：在征召模块中完成必要的数据收集和校验，避免跨模块的复杂依赖。

