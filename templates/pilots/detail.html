{% extends 'base.html' %}
{% block title %}ä¸»æ’­è¯¦æƒ… - Lacus-Log{% endblock %}
{% block content %}
<section class="pilot-detail" id="pilotDetail" style="display: none;">
  <div class="back-nav" id="backNav"></div>

  <div class="pilot-info-card" id="pilotInfoCard"></div>

  <div class="action-section" id="actionSection"></div>
</section>

<div id="loadingState" class="loading-state">
  <div class="loading-spinner"></div>
  <div class="loading-text">åŠ è½½ä¸­...</div>
</div>

<div id="changesModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å˜æ›´è®°å½•</h3>
      <button class="modal-close" onclick="hideChanges()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="changesLoading" class="loading">åŠ è½½ä¸­...</div>
      <div id="changesList" style="display: none;"></div>
    </div>
  </div>
</div>

<style>

.commission-card {
  background: #fff;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid #A9A9A9;
}

.commission-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.commission-rate {
  text-align: center;
}

.rate-value {
  display: block;
  font-size: 24px;
  font-weight: 700;
  color: #8B0000;
  margin-bottom: 4px;
}

.rate-label {
  font-size: 12px;
  color: #666666;
}

.commission-calculation {
  display: flex;
  gap: 16px;
}

.calc-item {
  text-align: center;
}

.calc-value {
  display: block;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 2px;
}

.calc-item:first-child .calc-value {
  color: #00B37A;
}

.calc-item:last-child .calc-value {
  color: #3A5F3D;
}

.calc-label {
  font-size: 11px;
  color: #666666;
}

.commission-footer {
  border-top: 1px solid #A9A9A9;
  padding-top: 12px;
}

.commission-formula {
  font-size: 12px;
  color: #666666;
  margin-bottom: 4px;
  font-family: monospace;
}

.commission-date {
  font-size: 12px;
  color: #666666;
  margin-bottom: 4px;
}

.commission-remark {
  font-size: 12px;
  color: #666666;
}


@media (max-width: 768px) {
  .commission-header {
    flex-direction: column;
    gap: 12px;
  }
  
  .commission-calculation {
    justify-content: center;
  }
}


.pilot-detail {
  max-width: 800px;
  margin: 0 auto;
}

.pilot-info-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
}

.pilot-info-card .card-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--table-header);
}

.pilot-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--table-header);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: bold;
}

.pilot-main-info {
  flex: 1;
}

.pilot-main-info .pilot-name {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
  color: var(--text);
}

.pilot-main-info .pilot-real-name {
  color: var(--muted);
  margin-bottom: 8px;
  font-size: 14px;
}

.pilot-badges {
  display: flex;
  gap: 8px;
}

.rank-badge, .status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}


.rank-å€™é€‰äºº { background: var(--table-header); color: var(--muted); }
.rank-è¯•æ’­ä¸»æ’­ { background: #FFF3CD; color: #856404; }
.rank-å®ä¹ ä¸»æ’­ { background: #D4EDDA; color: #155724; }
.rank-æ­£å¼ä¸»æ’­ { background: var(--brand); color: #fff; }


.status-æœªæ‹›å‹Ÿ { background: var(--table-header); color: var(--muted); }
.status-ä¸æ‹›å‹Ÿ { background: #F8D7DA; color: #721C24; }
.status-å·²æ‹›å‹Ÿ { background: #FFF3CD; color: #856404; }
.status-å·²ç­¾çº¦ { background: #D1ECF1; color: #0C5460; }
.status-æµå¤± { background: #F8D7DA; color: #721C24; }

.info-section {
  margin-bottom: 24px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--brand);
  border-bottom: 1px solid var(--table-header);
  padding-bottom: 8px;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.info-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.info-value {
  font-size: 14px;
  color: var(--text);
}

.action-section {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
}

.action-buttons {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}


.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: #fff;
  border-radius: 8px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--table-header);
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}

.modal-close:hover {
  color: var(--text);
}

.modal-body {
  padding: 20px;
  max-height: 60vh;
  overflow-y: auto;
}

.loading {
  text-align: center;
  color: var(--muted);
  padding: 20px;
}

.change-item {
  background: var(--table-header);
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 8px;
}

.change-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 12px;
  color: var(--muted);
}

.change-content {
  font-size: 14px;
}

.change-field {
  font-weight: 600;
  color: var(--brand);
}

.change-values {
  margin-top: 4px;
}

.old-value, .new-value {
  font-family: monospace;
  background: #fff;
  padding: 2px 4px;
  border-radius: 3px;
  margin: 0 2px;
}

.old-value {
  text-decoration: line-through;
  color: var(--error);
}

.new-value {
  color: var(--hud-green);
}


@media (max-width: 768px) {
  .pilot-info-card .card-header {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .pilot-badges {
    justify-content: center;
  }

  .info-grid {
    grid-template-columns: 1fr;
  }

  .action-buttons {
    flex-direction: column;
  }

  .action-buttons .btn {
    width: 100%;
  }

  .modal-content {
    width: 95%;
    margin: 0 10px;
  }
}
</style>

<script>
let currentPilot = null;

// è·å–URLä¸­çš„pilot_id
function getPilotIdFromUrl() {
  const pathParts = window.location.pathname.split('/');
  return pathParts[pathParts.length - 1];
}

// è·å–URLå‚æ•°
function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    from: params.get('from'),
    recruit_id: params.get('recruit_id'),
    announcement_id: params.get('announcement_id'),
    record_id: params.get('record_id')
  };
}

// è§„èŒƒåŒ–æšä¸¾å€¼
function normalizeRank(value) {
  const mapping = {
    'å€™è¡¥æœºå¸ˆ': 'å€™é€‰äºº',
    'è®­ç»ƒæœºå¸ˆ': 'è¯•æ’­ä¸»æ’­',
    'å®ä¹ æœºå¸ˆ': 'å®ä¹ ä¸»æ’­',
    'æ­£å¼æœºå¸ˆ': 'æ­£å¼ä¸»æ’­'
  };
  return mapping[value] || value;
}

function normalizeStatus(value) {
  const mapping = {
    'æœªå¾å¬': 'æœªæ‹›å‹Ÿ',
    'ä¸å¾å¬': 'ä¸æ‹›å‹Ÿ',
    'å·²å¾å¬': 'å·²æ‹›å‹Ÿ',
    'å·²é˜µäº¡': 'æµå¤±'
  };
  return mapping[value] || value;
}

// è·å–æ€§åˆ«æ˜¾ç¤º
function getGenderDisplay(gender) {
  if (gender === 0) return 'ç”·';
  if (gender === 1) return 'å¥³';
  return 'ä¸æ˜ç¡®';
}

// è·å–æ€§åˆ«å›¾æ ‡
function getGenderIcon(gender) {
  if (gender === 0) return 'â™‚';
  if (gender === 1) return 'â™€';
  return '?';
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(isoString) {
  if (!isoString) return '';
  const date = new Date(isoString);
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  }).replace(/\//g, '-');
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(isoString) {
  if (!isoString) return '';
  const date = new Date(isoString);
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).replace(/\//g, '-');
}

// æ¸²æŸ“è¿”å›æŒ‰é’®
function renderBackNav(params) {
  const backNav = document.getElementById('backNav');
  let backUrl = '/pilots';
  let backText = 'è¿”å›';
  
  if (params.from === 'recruit_detail' && params.recruit_id) {
    backUrl = `/recruit/${params.recruit_id}`;
  } else if (params.from === 'announcement_detail' && params.announcement_id) {
    backUrl = `/announcement/${params.announcement_id}`;
  } else if (params.from === 'battle_record_detail' && params.record_id) {
    backUrl = `/battle_record/${params.record_id}`;
  } else if (params.from === 'performance') {
    backUrl = `/pilots/${currentPilot.id}/performance`;
  }
  
  backNav.innerHTML = `
    <a class="btn btn-secondary" href="${backUrl}">
      <span>â†</span>
      ${backText}
    </a>
  `;
}

// æ¸²æŸ“ä¸»æ’­ä¿¡æ¯å¡ç‰‡
function renderPilotInfo(pilot) {
  const infoCard = document.getElementById('pilotInfoCard');
  const normalizedRank = normalizeRank(pilot.rank || '');
  const normalizedStatus = normalizeStatus(pilot.status || '');
  
  infoCard.innerHTML = `
    <div class="card-header">
      <div class="pilot-main-info">
        <div class="pilot-name">${pilot.nickname || ''}</div>
        <div class="pilot-real-name">${pilot.real_name || 'æœªå¡«å†™å§“å'}</div>
        <div class="pilot-badges">
          <span class="rank-badge rank-${normalizedRank.replace(/ /g, '')}">${normalizedRank}</span>
          <span class="status-badge status-${normalizedStatus.replace(/ /g, '')}">${normalizedStatus}</span>
        </div>
      </div>
    </div>

    <div class="info-section">
      <h3 class="section-title">åŸºç¡€ä¿¡æ¯</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">æ€§åˆ«</div>
          <div class="info-value">${getGenderDisplay(pilot.gender)}</div>
        </div>
        <div class="info-item">
          <div class="info-label">ç±è´¯</div>
          <div class="info-value">${pilot.hometown || 'æœªå¡«å†™'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å¹´é¾„</div>
          <div class="info-value">
            ${pilot.age ? pilot.age + 'å²' : 'æœªçŸ¥'}
            ${pilot.birth_year ? '(' + pilot.birth_year + 'å¹´)' : ''}
          </div>
        </div>
      </div>
    </div>

    <div class="info-section">
      <h3 class="section-title">ä¸šåŠ¡ä¿¡æ¯</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">ç›´å±è¿è¥</div>
          <div class="info-value">${pilot.owner ? (pilot.owner.nickname || 'æ— ') : 'æ— '}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å¼€æ’­å¹³å°</div>
          <div class="info-value">${pilot.platform || ''}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å¼€æ’­æ–¹å¼</div>
          <div class="info-value">${pilot.work_mode || ''}</div>
        </div>
        <div class="info-item">
          <div class="info-label">ä¸»æ’­åˆ†ç±»</div>
          <div class="info-value rank-${normalizedRank.replace(/ /g, '')}">${normalizedRank}</div>
        </div>
        <div class="info-item">
          <div class="info-label">çŠ¶æ€</div>
          <div class="info-value status-${normalizedStatus.replace(/ /g, '')}">${normalizedStatus}</div>
        </div>
      </div>
    </div>

    <div class="info-section">
      <h3 class="section-title">åˆ†æˆä¿¡æ¯</h3>
      <div class="commission-card">
        <div class="commission-header">
          <div class="commission-rate">
            <span class="rate-value">${pilot.commission.current_rate}%</span>
            <span class="rate-label">å½“å‰åˆ†æˆæ¯”ä¾‹</span>
          </div>
          <div class="commission-calculation">
            <div class="calc-item">
              <span class="calc-value">${pilot.commission.calculation_info.pilot_income.toFixed(1)}%</span>
              <span class="calc-label">ä¸»æ’­æ”¶å…¥</span>
            </div>
            <div class="calc-item">
              <span class="calc-value">${pilot.commission.calculation_info.company_income.toFixed(1)}%</span>
              <span class="calc-label">å…¬å¸æ”¶å…¥</span>
            </div>
          </div>
        </div>
        <div class="commission-footer">
          <div class="commission-formula">${pilot.commission.calculation_info.calculation_formula}</div>
          <div class="commission-date">
            ${pilot.commission.effective_date ? 'ç”Ÿæ•ˆæ—¶é—´ï¼š' + formatDate(pilot.commission.effective_date) : 'é»˜è®¤åˆ†æˆæ¯”ä¾‹'}
          </div>
          ${pilot.commission.remark ? '<div class="commission-remark">å¤‡æ³¨ï¼š' + pilot.commission.remark + '</div>' : ''}
        </div>
      </div>
    </div>

    <div class="info-section">
      <h3 class="section-title">ç³»ç»Ÿä¿¡æ¯</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">åˆ›å»ºæ—¶é—´</div>
          <div class="info-value">${formatDateTime(pilot.created_at)}</div>
        </div>
        <div class="info-item">
          <div class="info-label">æœ€åä¿®æ”¹</div>
          <div class="info-value">${formatDateTime(pilot.updated_at)}</div>
        </div>
      </div>
    </div>
  `;
}

// æ¸²æŸ“æ“ä½œæŒ‰é’®
function renderActionButtons(pilot) {
  const actionSection = document.getElementById('actionSection');
  const normalizedStatus = normalizeStatus(pilot.status || '');
  
  actionSection.innerHTML = `
    <h3 class="section-title">æ“ä½œ</h3>
    <div class="action-buttons">
      <a class="btn btn-primary" href="/pilots/${pilot.id}/edit">
        <span class="btn-icon">âœï¸</span>
        ç¼–è¾‘
      </a>
      ${normalizedStatus === 'æœªæ‹›å‹Ÿ' ? `
      <a class="btn btn-primary" href="/recruit/start?pilot_id=${pilot.id}">
        <span class="btn-icon">ğŸ¯</span>
        å¯åŠ¨æ‹›å‹Ÿ
      </a>
      ` : ''}
      <a class="btn btn-secondary" href="/pilots/${pilot.id}/commission/">
        <span class="btn-icon">ğŸ’°</span>
        åˆ†æˆç®¡ç†
      </a>
      <a class="btn btn-primary" href="/pilots/${pilot.id}/performance?from=pilot_detail">
        <span class="btn-icon">ğŸ“Š</span>
        ä¸šç»©æŸ¥çœ‹
      </a>
      <button class="btn btn-secondary" onclick="showChanges()">
        <span class="btn-icon">ğŸ“œ</span>
        å˜æ›´è®°å½•
      </button>
    </div>
  `;
}

// åŠ è½½ä¸»æ’­è¯¦æƒ…
async function loadPilotDetail() {
  const loadingState = document.getElementById('loadingState');
  const pilotDetail = document.getElementById('pilotDetail');
  
  loadingState.style.display = 'block';
  pilotDetail.style.display = 'none';
  
  try {
    const pilotId = getPilotIdFromUrl();
    const response = await fetch(`/api/pilots/${pilotId}`);
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || 'åŠ è½½ä¸»æ’­è¯¦æƒ…å¤±è´¥');
    }
    
    currentPilot = result.data;
    document.title = `ä¸»æ’­è¯¦æƒ… - ${currentPilot.nickname} - Lacus-Log`;
    
    const params = getUrlParams();
    renderBackNav(params);
    renderPilotInfo(currentPilot);
    renderActionButtons(currentPilot);
    
    loadingState.style.display = 'none';
    pilotDetail.style.display = 'block';
  } catch (error) {
    console.error('åŠ è½½ä¸»æ’­è¯¦æƒ…å¤±è´¥:', error);
    showMessage('åŠ è½½ä¸»æ’­è¯¦æƒ…å¤±è´¥', 'error');
    loadingState.style.display = 'none';
  }
}

// æ˜¾ç¤ºå˜æ›´è®°å½•
async function showChanges() {
  const modal = document.getElementById('changesModal');
  const loading = document.getElementById('changesLoading');
  const changesList = document.getElementById('changesList');
  
  modal.style.display = 'flex';
  loading.style.display = 'block';
  changesList.style.display = 'none';
  changesList.innerHTML = '';
  
  try {
    const pilotId = getPilotIdFromUrl();
    const response = await fetch(`/api/pilots/${pilotId}/changes`);
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || 'åŠ è½½å˜æ›´è®°å½•å¤±è´¥');
    }
    
    const changes = result.data || [];
    
    if (changes.length === 0) {
      changesList.innerHTML = '<div class="empty-state"><div class="empty-title">æš‚æ— å˜æ›´è®°å½•</div></div>';
    } else {
      const changesHtml = changes.map(change => `
        <div class="change-item">
          <div class="change-header">
            <span>æ“ä½œäººï¼š${change.user ? (change.user.nickname || change.user.username) : 'æœªçŸ¥'}</span>
            <span>${formatDateTime(change.created_at)}</span>
          </div>
          <div class="change-content">
            <span class="change-field">${change.field_name}</span>
            <div class="change-values">
              <span class="old-value">${change.old_value || 'ç©º'}</span>
              â†’
              <span class="new-value">${change.new_value || 'ç©º'}</span>
            </div>
          </div>
        </div>
      `).join('');
      changesList.innerHTML = changesHtml;
    }
  } catch (error) {
    console.error('åŠ è½½å˜æ›´è®°å½•å¤±è´¥:', error);
    changesList.innerHTML = '<div class="empty-state"><div class="empty-title">åŠ è½½å¤±è´¥</div></div>';
  }
  
  loading.style.display = 'none';
  changesList.style.display = 'block';
}

function hideChanges() {
  const modal = document.getElementById('changesModal');
  modal.style.display = 'none';
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  loadPilotDetail();
  
  const modal = document.getElementById('changesModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        hideChanges();
      }
    });
  }
});
</script>
{% endblock %}
