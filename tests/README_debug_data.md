# 调试数据生成脚本使用说明

## 概述

`tests/generate_debug_data_business_logic.py` 是一个用于生成测试数据的pytest脚本，它会创建一个包含完整测试数据的独立MongoDB数据库，供调试和测试使用。

**重要特性**：此脚本使用项目中的业务逻辑函数来创建数据，而不是直接操作数据库模型，确保生成的数据完全符合项目的业务规则和验证逻辑。

## 生成的数据

### 用户数据
- **2名舰长**：随机昵称，具有kancho角色权限
- **10名机师**：随机昵称和真实姓名
  - 5名训练机师（TRAINEE）
  - 5名正式机师（OFFICIAL）
  - 全部为已征召状态（RECRUITED）
  - 随机分属2名舰长

### 作战区域
- **10个作战区域**：X=测试宙域，Y=测试房，Z=1-10

### 作战计划（2025年9月）
- **217个作战计划**，包含以下模式：
  1. 1名机师：每周一二三四五，下午16点开始6小时
  2. 1名机师：每天中午12点开始6小时
  3. 1名机师：每周二四五六日，下午14点开始6小时
  4. 1名机师：9月1-15日随机7天，上午10点开始6小时
  5. 1名机师：9月10-20日随机7天，上午11点开始6小时
  6. 剩余5名机师：9月1-30日随机26天，8-22点随机时间，6小时

### 作战记录
- **194个作战记录**
  - 188个基于作战计划生成（85%概率）
  - 6个无计划的随机记录
- **播时规则**：
  - 90%概率达成6小时播时
  - 10%概率只有5小时播时
- **底薪规则**：
  - 6小时播时：150元
  - 5小时播时：0元
- **流水规则**：
  - 每小时10-200元随机
  - 总流水 = 每小时流水 × 播时

## 使用方法

### 运行脚本
```bash
./venv/bin/python -m pytest tests/generate_debug_data_business_logic.py::test_generate_debug_data -v -s
```

### 数据库信息
脚本会输出类似以下信息：
```
=== 调试数据生成完成 ===
数据库名: test_lacus_debug_u5d0s7vx
舰长数量: 2
机师数量: 10
作战区域数量: 10
作战计划数量: 217
作战记录数量: 194

数据库连接信息:
mongodb://localhost:27017/test_lacus_debug_u5d0s7vx
```

### 连接数据库
使用MongoDB客户端连接：
```bash
mongosh mongodb://localhost:27017/test_lacus_debug_u5d0s7vx
```

或使用Python连接：
```python
from mongoengine import connect
connect('test_lacus_debug_u5d0s7vx', host='mongodb://localhost:27017/test_lacus_debug_u5d0s7vx')
```

## 业务逻辑使用

此脚本使用了以下项目中的业务逻辑函数：

1. **用户创建**：使用 `utils.security.create_user_datastore()` 和 `utils.bootstrap.ensure_initial_roles_and_admin()`
2. **角色管理**：使用项目中的角色创建逻辑
3. **机师创建**：参考 `routes/pilot.py` 中的 `new_pilot()` 函数逻辑
4. **作战区域创建**：参考 `routes/battle_area.py` 中的 `new_area()` 函数逻辑
5. **作战记录创建**：参考 `routes/battle_record.py` 中的 `create_battle_record()` 函数逻辑
6. **时间处理**：使用 `utils.timezone_helper.local_to_utc()` 进行时间转换

## 注意事项

1. **数据保留**：生成的数据库不会被自动删除，需要手动清理
2. **随机性**：每次运行都会生成不同的随机数据
3. **数据库名**：每次运行都会生成随机的数据库名
4. **时间范围**：所有数据都基于2025年9月
5. **依赖**：需要MongoDB服务运行在localhost:27017
6. **业务逻辑**：使用项目中的业务逻辑函数，确保数据符合业务规则

## 数据结构

### 舰长信息
- 用户名：captain_1, captain_2
- 昵称：随机生成
- 角色：kancho（舰长）

### 机师信息
- 昵称：随机生成
- 真实姓名：真实姓名+随机字符
- 所属：随机分配到2名舰长
- 阶级：训练机师或正式机师
- 状态：已征召

### 作战区域
- X坐标：测试宙域
- Y坐标：测试房
- Z坐标：1-10
- 可用性：可用

### 作战计划
- 关联机师：随机分配
- 作战区域：随机选择
- 时间：2025年9月1-30日
- 时长：6小时
- 创建人：captain_1

### 作战记录
- 关联机师：基于作战计划
- 播时：5或6小时
- 底薪：0或150元
- 流水：每小时10-200元随机
- 登记人：captain_1
