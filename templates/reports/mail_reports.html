{% extends 'base.html' %}
{% block title %}邮件报告 - Lacus-Log{% endblock %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">📧 邮件报告</h1>
  <div class="text-muted">以下报表为异步触发型，点击按钮后将开始计算并尝试发送邮件，页面不会等待计算完成。</div>
    <div id="result" class="text-muted" style="margin-top:8px;"></div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">未开播提醒（近48小时）</h2>
    <div class="card-icon">⏰</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.unstarted %}
    <div class="text-muted" style="margin-bottom:8px;">下次触发（GMT+8）：{{ next_times.unstarted }}</div>
    {% endif %}
    <button id="btnUnstarted" class="btn btn-primary" style="width:100%" type="button" aria-label="触发未开播提醒报表">开始发送</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">未下播提醒</h2>
    <div class="card-icon">📡</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.live_overtime %}
    <div class="text-muted" style="margin-bottom:8px;">下次触发（GMT+8）：{{ next_times.live_overtime }}</div>
    {% endif %}
    <div class="text-muted" style="margin-bottom:8px; font-size: 12px;">
      说明：每日检查开播中且已持续超过8小时的记录，提醒确认是否已下播
    </div>
    <button id="btnLiveOvertime" class="btn btn-primary" style="width:100%" type="button" aria-label="触发未下播提醒邮件发送">开始发送</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">线上主播未开播提醒</h2>
    <div class="card-icon">🌐</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.online_pilot_unstarted %}
    <div class="text-muted" style="margin-bottom:8px;">下次触发（GMT+8）：{{ next_times.online_pilot_unstarted }}</div>
    {% endif %}
    <div class="text-muted" style="margin-bottom:8px; font-size: 12px;">
      说明：检查前4日至前2日有线上开播记录的主播，如果在前1日无开播记录则提醒
    </div>
    <button id="btnOnlinePilotUnstarted" class="btn btn-primary" style="width:100%" type="button" aria-label="触发线上主播未开播提醒邮件发送">开始发送</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">底薪发放提醒</h2>
    <div class="card-icon">💰</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.base_salary_reminder %}
    <div class="text-muted" style="margin-bottom:8px;">下次触发（GMT+8）：{{ next_times.base_salary_reminder }}</div>
    {% endif %}
    <div class="text-muted" style="margin-bottom:8px; font-size: 12px;">
      说明：筛选状态为"未处理"且申请时间已超过12小时的底薪申请，提醒管理员及时审核
    </div>
    <button id="btnBaseSalaryReminder" class="btn btn-primary" style="width:100%" type="button" aria-label="触发底薪发放提醒邮件发送">开始发送</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">主播招募日报</h2>
    <div class="card-icon">📊</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.recruit_daily %}
    <div class="text-muted" style="margin-bottom:8px;">下次触发（GMT+8）：{{ next_times.recruit_daily }}</div>
    {% endif %}
    <div class="form-group">
      <label for="reportDate">报表日期：</label>
      <input type="date" id="reportDate" class="form-control" style="margin-bottom: 10px;">
      <small class="text-muted">留空则发送昨天的报表</small>
    </div>
    <button id="btnRecruitDaily" class="btn btn-primary" style="width:100%" type="button" aria-label="触发招募日报邮件发送">开始发送</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">开播日报</h2>
    <div class="card-icon">📈</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.daily_report %}
    <div class="text-muted" style="margin-bottom:8px;">下次触发（GMT+8）：{{ next_times.daily_report }}</div>
    {% endif %}
    <div class="form-group">
      <label for="dailyReportDate">报表日期：</label>
      <input type="date" id="dailyReportDate" class="form-control" style="margin-bottom: 10px;">
      <small class="text-muted">留空则发送昨天的报表</small>
    </div>
    <button id="btnDailyReport" class="btn btn-primary" style="width:100%" type="button" aria-label="触发开播日报邮件发送">开始发送</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">开播月报（邮件）</h2>
    <div class="card-icon">📅</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.monthly_mail_report %}
    <div class="text-muted" style="margin-bottom:8px;">下次触发（GMT+8）：{{ next_times.monthly_mail_report }}</div>
    {% endif %}
    <div class="form-group">
      <label for="monthlyReportMonth">报表月份：</label>
      <input type="month" id="monthlyReportMonth" class="form-control" style="margin-bottom: 10px;">
      <small class="text-muted">留空则发送“前一自然日所在月”的月报</small>
    </div>
    <button id="btnMonthlyMailReport" class="btn btn-primary" style="width:100%" type="button" aria-label="触发开播月报邮件发送">开始发送</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const btnUnstarted = document.getElementById('btnUnstarted');
  const btnLiveOvertime = document.getElementById('btnLiveOvertime');
  const btnOnlinePilotUnstarted = document.getElementById('btnOnlinePilotUnstarted');
  const btnBaseSalaryReminder = document.getElementById('btnBaseSalaryReminder');
  const btnRecruitDaily = document.getElementById('btnRecruitDaily');
  const btnDailyReport = document.getElementById('btnDailyReport');
  const btnMonthlyMailReport = document.getElementById('btnMonthlyMailReport');
  const result = document.getElementById('result');

  async function postUnstarted() {
    result.textContent = '未开播提醒报表已开始运算...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_unstarted_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `未开播提醒已触发发送，共 ${data.count} 条。`;
        } else {
          result.textContent = `未开播提醒无可发送内容（或未配置收件人）。`;
        }
      } else {
        result.textContent = `未开播提醒触发失败：${data && data.error ? data.error : '未知错误'}`;
      }
    } catch (e) {
      result.textContent = '网络异常或服务器错误。';
    }
  }

  async function postLiveOvertime() {
    result.textContent = '未下播提醒已开始运算...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_live_overtime_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `未下播提醒已触发发送，共 ${data.count} 条。`;
        } else {
          result.textContent = `未下播提醒无可发送内容（或未配置收件人）。`;
        }
      } else {
        result.textContent = `未下播提醒触发失败：${data && data.error ? data.error : '未知错误'}`;
      }
    } catch (e) {
      result.textContent = '网络异常或服务器错误。';
    }
  }

  async function postOnlinePilotUnstarted() {
    result.textContent = '线上主播未开播提醒已开始运算...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_online_pilot_unstarted_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `线上主播未开播提醒已触发发送，共 ${data.count} 位主播。`;
        } else {
          result.textContent = `线上主播未开播提醒无可发送内容（或未配置收件人）。`;
        }
      } else {
        result.textContent = `线上主播未开播提醒触发失败：${data && data.error ? data.error : '未知错误'}`;
      }
    } catch (e) {
      result.textContent = '网络异常或服务器错误。';
    }
  }

  async function postBaseSalaryReminder() {
    result.textContent = '底薪发放提醒已开始运算...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_base_salary_reminder_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `底薪发放提醒已触发发送，共 ${data.count} 条申请。`;
        } else {
          result.textContent = `底薪发放提醒无可发送内容（或未配置收件人）。`;
        }
      } else {
        result.textContent = `底薪发放提醒触发失败：${data && data.error ? data.error : '未知错误'}`;
      }
    } catch (e) {
      result.textContent = '网络异常或服务器错误。';
    }
  }

  async function postRecruitDaily() {
    const reportDate = document.getElementById('reportDate').value;
    result.textContent = '招募日报已开始运算...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_recruit_daily_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          report_date: reportDate || null
        })
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `招募日报已触发发送，收件人 ${data.count} 人。`;
        } else {
          result.textContent = `招募日报发送失败（或未配置收件人）。`;
        }
      } else {
        result.textContent = `招募日报触发失败：${data && data.error ? data.error : '未知错误'}`;
      }
    } catch (e) {
      result.textContent = '网络异常或服务器错误。';
    }
  }

  async function postDailyReport() {
    const reportDate = document.getElementById('dailyReportDate').value;
    result.textContent = '开播日报已开始运算...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_daily_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          report_date: reportDate || null
        })
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `开播日报已触发发送，收件人 ${data.count} 人。`;
        } else {
          result.textContent = `开播日报发送失败（或未配置收件人）。`;
        }
      } else {
        result.textContent = `开播日报触发失败：${data && data.error ? data.error : '未知错误'}`;
      }
    } catch (e) {
      result.textContent = '网络异常或服务器错误。';
    }
  }

  async function postMonthlyMailReport() {
    const reportMonth = document.getElementById('monthlyReportMonth').value;
    result.textContent = '开播月报（邮件）已开始运算...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_monthly_mail_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          report_month: reportMonth || null
        })
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `开播月报（邮件）已触发发送，收件人 ${data.count} 人。`;
        } else {
          result.textContent = `开播月报（邮件）发送失败（或未配置收件人）。`;
        }
      } else {
        result.textContent = `开播月报（邮件）触发失败：${data && data.error ? data.error : '未知错误'}`;
      }
    } catch (e) {
      result.textContent = '网络异常或服务器错误。';
    }
  }

  if (btnUnstarted) {
    btnUnstarted.addEventListener('click', postUnstarted);
  }

  if (btnLiveOvertime) {
    btnLiveOvertime.addEventListener('click', postLiveOvertime);
  }

  if (btnOnlinePilotUnstarted) {
    btnOnlinePilotUnstarted.addEventListener('click', postOnlinePilotUnstarted);
  }

  if (btnBaseSalaryReminder) {
    btnBaseSalaryReminder.addEventListener('click', postBaseSalaryReminder);
  }

  if (btnRecruitDaily) {
    btnRecruitDaily.addEventListener('click', postRecruitDaily);
  }

  if (btnDailyReport) {
    btnDailyReport.addEventListener('click', postDailyReport);
  }

  if (btnMonthlyMailReport) {
    btnMonthlyMailReport.addEventListener('click', postMonthlyMailReport);
  }
});
</script>
{% endblock %}
