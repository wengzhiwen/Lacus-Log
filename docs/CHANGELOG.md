## 最新的更新内容
> 以下所有日期为更新发生时的系统GMT+8时间

## 2025-09-28 新增：
- 开播月报缓存功能：为开播月报的运算结果添加15分钟缓存机制，使用cachetools库的TTLCache实现，相同条件下15分钟内不会重新计算，提升页面响应速度，服务重启时缓存自动清空
- 开播日报缓存功能：为开播日报的运算结果添加15分钟缓存机制，包括月度数据、日报汇总和日报明细计算，与开播月报使用相同的缓存策略，显著提升日报页面响应速度
- 主播业绩缓存功能：为主播业绩页的计算结果添加5分钟缓存机制，包括返点计算和业绩统计计算，相同主播5分钟内不会重新计算，提升业绩页面响应速度

## 2025-09-28 优化：
- 主播业绩页：为底薪数值、运营利润估算和盈亏数据添加日均计算显示，算法为数值本身除以开播记录数量
- 数据库索引优化：为BattleRecord模型新增多个复合索引，显著提升开播日报查询性能，包括时间范围查询、主播相关查询、直属运营筛选等核心查询场景
- 索引管理机制：建立统一的索引管理机制，确保所有模型索引在应用启动时自动创建，符合项目研发约定
- 开播日报排序优化：开播日报明细数据改为按月累计毛利升序排序（亏损主播排在最前面），便于快速识别需要关注的主播
- 开播日报负数显示：明细表格中所有负数（当日毛利、月累计毛利）以红色字体显示，提升数据可读性
- 主播业绩页面：新增返回按钮功能，支持从开播日报、开播月报、主播详情、开播记录详情等不同来源正确返回，按钮统一显示"返回"文字
- 招募详情页面：将主播昵称改为超链接，点击可跳转到主播详情页面，提升用户体验和操作便利性
- 通告详情页面：将主播昵称改为超链接，与招募详情页面保持一致的用户体验
- 开播记录详情页面：将主播昵称改为超链接，与其他详情页面保持一致的用户体验
- 主播业绩页面：将主播昵称改为超链接，与其他页面保持一致的用户体验
- 主播详情页面：简化返回按钮标签为"返回"，并准确处理各种来源的正确返回路径

## 2025-09-28 新增：
- 詹姆斯的关注警告邮件功能：新增低业绩不努力主播自动告警机制，当开播记录保存时自动检查主播业绩情况，满足特定条件时发送警告邮件给全体运营和管理员，邮件包含主播基本信息和完整业绩数据，运算过程完全异步不阻塞用户操作
- 主播业绩页和詹姆斯关注告警邮件：新增主播状态显示，在主播基本信息中显示当前主播状态，便于快速了解主播当前状态
- 开播日报筛选功能：新增按直属运营筛选功能，支持全部或特定直属运营筛选，筛选逻辑优先使用开播记录中的直属运营快照，无快照时使用主播当前直属运营

## 历史的更新内容

## 2025-09-27 新增：
- 开播月报功能：基于开播日报功能实现的平级月度统计报告

## 2025-09-27 优化：
- 开播记录模块：从通告新建开播记录时底薪默认值设置为150元，用户仍可修改

2025-09-27  修复
- 主播管理筛选器：修复新旧用语混合显示问题，筛选器选项只显示新用语（候选人、试播主播、实习主播、正式主播），同时确保选择新选项时能正确筛选出包含旧用语的数据
- 作战记录筛选器：同步修复主播分类筛选的兼容性问题，确保新旧数据都能正确筛选
- 通告管理筛选器：同步修复主播分类筛选的兼容性问题，确保新旧数据都能正确筛选
- 主播显示层用语转换：新增Jinja2过滤器normalize_rank和normalize_status，实现在所有模板中将旧用语自动转换为新用语显示，确保UI界面统一使用新用语
- 开播日报和主播业绩页：应用用语转换过滤器，确保报表页面也统一显示新用语
- 招募流程所有页面：全面应用用语转换过滤器，确保招募相关页面统一显示新用语

2025-09-27  界面优化
- 通告详情页：整体布局和样式向招募详情页面看齐，采用统一的卡片式设计
- 招募详情页：去掉左上角的性别icon，简化页面布局
- 招募详情页：去掉重复的主播分类和当前状态信息，避免信息冗余
- 招募详情页：调整性别/年龄和直属运营的布局样式，与其他信息项保持左对齐
- 通告日历：优化从日历日视图点击通告进入详情页的返回逻辑，现在可以正确返回到之前的日历页面而非通告列表
- 通告编辑页：将主播字段改为只读显示，移除所属和阶级筛选器，简化编辑界面

2025-09-27  新增
- 主播管理：新增主播数据导出功能，支持导出所有主播数据为CSV文件

2025-09-27  新增
- 主播管理：为主播增加籍贯字段，支持0-20字符的文本输入，非必填字段

2025-09-27  新增
- 主播招募日报筛选功能：新增按招募负责人筛选功能，支持全部、管理员或特定运营筛选

2025-09-27  新增
- 主播招募日报详情页面功能：新增日报详情页面，支持点击统计表格中的任意数据单元格查看对应的具体招募记录

2025-09-27  重构
- 创建统一的招募统计工具模块 utils/recruit_stats.py
- 消除routes/report.py、routes/report_mail.py、routes/main.py中的代码重复
- 抽取共同逻辑，提高代码复用性和维护性

2025-09-27  文档重命名
- 按照统一用语规范重命名docs文件夹下的所有文档文件

2025-09-27  全面更新
- 应用统一用语规范
- 完成主播模块 招募模块的初步验证
- 完成所有模块的验证

2025-09-25  变更
- 作战记录新建页：移除“所属/阶级”筛选器，新增“昵称/真实姓名”本地搜索输入，纯前端过滤下方机师下拉，不影响提交内容；后端机师列表API补充返回real_name以支持搜索。
 - 作战计划新建页：同样接入“昵称/真实姓名”本地搜索，移除所属/阶级筛选；机师下拉显示文本优化为“昵称(年龄)真实姓名[阶级]性别icon”，不影响表单提交。

2025-09-25  新增
- 征召编辑页：按状态机逐步开放可编辑字段（预约训练/预约开播时间）；已结束状态仅查看
- 后端支持保存上述字段并记录变更日志，保持UTC入库/GMT+8显示

2025-09-25  变更
- 全站表单交互：禁用回车键触发表单提交，必须点击提交按钮；允许 textarea 与可编辑区域正常换行。

## 2025-09-23 修复
- 作战记录编辑页“所属”显示用户名问题，改为优先显示昵称。
- 统一详情页与编辑页“所属”来源，编辑页不再用接口覆盖快照。

2025-09-23 增强
- 作战计划管理列表：新增与机师管理一致的“机师昵称/姓名”前端搜索
- 纯前端实现，不影响后端筛选器；实时模糊匹配昵称与真实姓名
- UI与交互保持与机师管理一致（输入、回车、退格、按钮触发）

2025-09-23 修复
- 作战记录详情页在关联通告被删除时崩溃（DoesNotExist），改为显示“关联作战计划已被删除”。
- 作战记录编辑页在关联通告被删除时500，统一与详情页的安全处理；保存时若检测到关联通告已不存在则自动清空字段。
2025-09-23 异常处理
- 增加全局异常处理，所有500错误记录ERROR级堆栈与请求信息到日志文件。

2025-09-22 增强
- 日志：将 Flask/Werkzeug 的 ERROR 输出重定向到独立日志文件，按自然日切分（`log/flask_error_YYYYMMDD.log`、`log/werkzeug_error_YYYYMMDD.log`）；保持原有应用日志不变。
2025-09-22 修复
- 征召列表“鸽”筛选报错：修复排序时比较RecruitStatus枚举导致的TypeError；统一将排序键中的枚举转为其value，并完善二级时间降序逻辑；增加DEBUG日志输出鸽分组状态分布。

2025-09-22 重构
- 定时任务重构，结合mongoDB保证定时任务的可靠性

2025-09-21 新增
- 征召日报邮件报表功能：新增征召日报的邮件发送功能
  - 定时发送：每天0:05（GMT+8）自动发送前一天的征召日报邮件给所有舰长和议长
  - 手动触发：在议长邮件报告页面新增征召日报手动发送按钮，支持指定日期发送

2025-09-21 匹配
- 仪表板征召统计更新：修改征召统计卡片的数据显示，与征召日报保持一致
  - 副数据1更新：从"新增正式机师"改为"今日到面"，统计今日发生的面试决策数量
  - 副数据2更新：从"新增实习机师"改为"今日新开播"，统计今日在开播决策中决定征召的数量
  - 数据计算优化：使用MongoDB的Q对象实现复杂查询，支持新六步制字段和历史兼容字段
  - 历史数据兼容：确保新旧征召流程的数据都能正确统计和显示

2025-09-20 匹配
- 机师征召日报适配新六步制流程：完成征召日报功能对新六步制征召流程的适配
  - 数据统计更新
  - 查询优化

2025-09-19 重构
- 机师征召列表界面重构：优化征召列表的用户体验和操作效率
  - 筛选器简化：只保留状态筛选（进行中/鸽/已结束），移除负责人和渠道筛选
  - 分组显示：按征召状态和时间条件动态分组，包括待面试、待预约训练、待训练、待预约开播、待开播、鸽、已结束
  - 快速跳转：新增分组快速跳转按钮，根据数据动态显示，提供平滑滚动体验
  - 排序优化：每个分组独立排序，优先显示紧急和重要的征召记录
  - 浮动按钮：页面滚动时显示回到顶部按钮，提升长列表操作体验
  - 超时检测：自动识别超时征召记录，单独分组显示，便于及时处理
  - 响应式设计：优化移动端显示效果，快速跳转按钮和浮动按钮适配小屏幕

2025-09-20 重构
- 机师征召流程六步制实现：完成征召流程从三步制到六步制的全面重构
  - 数据模型扩展：新增InterviewDecision、TrainingDecision、BroadcastDecision枚举，扩展Recruit模型字段
  - 状态流转：待面试 -> 待预约训练 -> 待训练 -> 待预约开播 -> 待开播 -> 已结束
  - 历史数据兼容：实现完整的状态映射和字段降级读取机制，确保历史数据正确显示

2025-09-20 新增
- 机师管理列表搜索功能：在机师列表头部新增文本搜索框，支持按机师昵称或真实姓名进行前端模糊匹配搜索
  - 搜索触发：支持输入框实时搜索、退格键、删除键、回车键和搜索按钮触发
  - 搜索范围：同时匹配机师昵称和真实姓名，不区分大小写
  - 前端实现：纯前端JavaScript实现，不影响后端筛选器功能

2025-09-19 变更
- 作战计划列表默认筛选：移除“所属=自己”的默认条件，保留“时间=现在开始”。
- 更新时间筛选：将作战计划的 “现在开始（默认）”调整为“这两天（默认）”，并保留“现在开始/全部”可选
  - 作战记录：时间筛选新增“这两天（昨天+今天+明天）”，设为默认；原“今天”仍可选

2025-09-19 增强
- 列表筛选持久化：为机师列表、作战计划、作战记录、战斗区域、机师征召四个列表页接入筛选条件会话持久化，返回列表页时自动回填上次筛选。

2025-09-18 修复
- 机师-作战记录（后端）：作战记录列表路由默认所属筛选改为“全部”，不再默认按当前用户过滤；默认时间筛选仍为近7天。
- 作战记录：在“作战记录详情”页面顶部新增面包屑导航按钮，便于从详情快速回到列表。
- 机师征召：当征召状态为“训练征召中”时，列表卡片不再显示“预约”时间，仅显示“训练：YYYY年MM月DD日”。
  - 同步调整：训练征召时间与预约时间的“先后检查”已移除，允许自由填写，修复“先填晚后改早时报错”的问题。
  - 编辑页：当状态为“训练征召中”时支持在编辑页修改/清空“训练时间”。

2025-09-15 新增
- 自动化任务模块：新增 `utils/scheduler.py` 应用内置定时调度（APScheduler）
  - 集成：在 `app.py` 初始化完成后启动后台调度器
  - 每日任务：每日 GMT+8 20:00 自动执行未开播提醒报表（等效 UTC 12:00）

2025-09-15 变更
- 报告-邮件报告模块：未开播提醒收件人改为从用户模块动态获取（激活用户邮箱）
  - 规则：统计近48小时内，计划“接受时间”已过且超过4小时仍无关联“作战记录”的作战计划
  - 行为：有数据则以列表（Markdown表格）发送邮件；无数据仅记录INFO日志
  - 交互：按钮点击后立即返回“报表已开始运算”，不做同步等待

2025-09-15 新增
- 用户系统：为舰长/议长增加可选邮箱字段；提供按角色取邮箱列表（支持不传角色名获取全部邮箱）
- 路由/模板：新增用户编辑（昵称/邮箱），新增页支持填写邮箱，详情页展示邮箱
- 报告-邮件报告模块：新增议长页面入口与未开播提醒报表（近48小时）
  - 仅议长可见入口，点击触发计算并邮件发送（无数据仅记日志）
  - 邮件使用Markdown表格并自动内联样式，复用`utils.mail_utils.send_email_md`

2025-09-15 新增
- 邮件发送功能支持Markdown：新增 `utils/mail_utils.py:send_email_md()`
  - Markdown渲染：使用`markdown`将md渲染为HTML
  - 纯文本生成：优先用`html2text`从HTML提取纯文本，缺失时降级为简单去标签
  - 复用发送：调用既有`send_email()`完成实际发送
  - 依赖更新：`requirements.txt` 增加 `html2text`
  - 新增测试方法：`__send_test_email_by_md(recipient)` 发送Markdown测试邮件
  - 测试内容增强：在Markdown测试邮件中加入表格验证渲染效果

2025-09-15 新增
- 邮件发送工具模块：在utils中创建mail_utils.py统一邮件发送功能
  - 影响：为系统其他模块提供统一的邮件发送能力，简化邮件功能集成

2025-09-15 功能新增
- 作战日报分成计算功能：集成机师分成管理模块，实现完整的分成计算和毛利分析
  - 新增字段：当前分成比例、机师分成、公司分成、返点比例、产生返点、底薪、当日毛利
  - 月累计字段：月累计机师分成、月累计公司分成、月累计毛利
  - 汇总数据：月度数据新增累计机师分成、累计公司分成、运营利润估算
  - 日报数据：新增累计机师分成、累计公司分成
  - 技术实现：创建commission_helper工具模块，提供分成比例查询和计算功能
  - 接口调用：通过机师分成管理模块获取特定日期的生效分成比例
  - 计算逻辑：机师分成 = 流水金额 × 机师分成比例，公司分成 = 流水金额 × 公司分成比例
  - 毛利计算：当日毛利 = 公司分成 + 产生返点 - 底薪
  - 运营利润：累计公司分成 + 累计返点 - 累计底薪支出
  - 日志记录：详细记录分成计算过程，便于调试和验证
  - 模板更新：更新日报模板显示所有新增字段，调整表格布局
  - CSV导出：更新CSV导出功能，包含所有新增字段
  - 影响：提供完整的收入分配分析，支持运营决策和利润分析

2025-09-15 修复
- 机师作战日报返点计算代码：修正返点条件实现逻辑
  - 问题：代码中仍使用区间限制逻辑，如[1000,5000)的区间检查
  - 修正：将返点阶段条件改为"达到"条件，移除max_revenue字段和区间检查
  - 日志优化：更新调试日志格式，移除区间显示，改为"达到"条件显示
  - 影响：确保返点计算代码与修正后的业务规则保持一致

2025-09-15 功能改进
- 分成管理编辑功能优化：支持分成比例修改和状态切换
  - 新增功能：实时预览分成计算，状态切换时动态更新提示文字
  - 后端支持：编辑路由支持分成比例和状态的同时修改
  - 用户体验：统一编辑界面，减少操作步骤，提升操作便利性

2025-09-15 修复
- 分成管理变更记录URL和错误页面路由：修复URL生成和路由引用错误
  - 问题1：分成管理变更记录URL生成错误，导致双斜杠`/commission//changes`
  - 修复1：使用占位符替换方式生成正确的URL，避免字符串拼接问题
  - 问题2：错误页面中`url_for('main.index')`找不到对应路由
  - 修复2：将错误页面的首页链接改为`url_for('calendar.index')`
  - 影响：确保分成管理变更记录功能正常，错误页面能正确跳转

2025-09-15 修复
- 机师分成比例计算逻辑：修复根据当前日期判断生效分成记录
  - 问题：当前分成比例直接读取最后一条记录，不考虑调整日期是否已生效
  - 业务需求：分成比例应该根据当前日期判断，只使用调整日小于等于当前日期的记录
  - 修复：实现基于时间的生效记录查找逻辑
  - 逻辑：从最新记录开始查找，找到调整日≤当前日期的第一条记录作为生效记录
  - 边界处理：如果所有记录的调整日都是未来日期，返回默认20%分成比例
  - 影响：确保分成比例计算符合业务规则，支持未来日期的分成调整安排

2025-09-15 修复
- 机师分成管理QuerySet索引问题：彻底修复MongoEngine QuerySet索引错误
  - 问题：MongoEngine QuerySet不支持负索引，导致`commissions[-1]`报错
  - 原因：QuerySet对象即使为空也不是空列表，`commissions.count()`检查可能不够可靠
  - 修复：将QuerySet转换为列表`list(commissions)`，然后使用列表索引
  - 优势：更安全、更可靠，避免了MongoEngine QuerySet的特殊行为
  - 影响：确保分成管理功能在任何情况下都能正常工作

2025-09-15 修复
- 机师分成管理空记录IndexError：修复无分成记录时的页面错误
  - 问题：当机师没有任何分成调整记录时，访问分成管理页面出现IndexError
  - 原因：MongoEngine QuerySet为空时仍为QuerySet对象，使用`commissions[-1]`会报错
  - 修复：将`if not commissions:`改为`if not commissions.count():`正确检查空记录
  - 影响：确保新机师或未设置分成的机师能正常访问分成管理页面
  - 测试：验证空记录情况下返回默认20%分成比例

2025-09-15 修复
- 机师分成管理CSRF token缺失：修复所有表单的CSRF保护
  - 问题：分成管理相关表单缺少CSRF token，可能导致CSRF攻击风险
  - 修复：为所有POST表单添加CSRF token隐藏字段
  - 影响范围：新增调整记录表单、编辑调整记录表单、删除确认表单、恢复确认表单
  - 安全提升：确保所有表单提交都经过CSRF验证，符合Flask-Security-Too的安全要求

2025-09-15 修复
- 机师分成管理时间处理和日期限制优化
  - 明确时间处理规则：UI上所有日期显示和输入都是GMT+8时间，数据库存储UTC时间
  - 移除未来日期限制：调整日支持选择未来日期，用于提前安排分成调整
  - 更新表单提示：明确说明支持未来日期选择
  - 移除前端验证：删除JavaScript中的未来日期检查逻辑
  - 移除后端验证：删除模型中的未来日期验证规则
  - 文档更新：同步更新业务需求文档和技术设计文档中的相关规则
  - 影响：提升用户体验，支持更灵活的分成调整安排

2025-09-15 修复
- 机师分成管理计算公式错误：修复公司收入计算逻辑
  - 问题：公司收入计算使用了错误的公式"50% - 机师收入"，导致计算结果不正确
  - 修复：将公司收入计算公式改为"42% - 机师收入"，符合业务需求文档规范
  - 影响范围：后端计算逻辑、前端实时预览、编辑页面显示、相关文档
  - 示例：20%分成时，机师收入16.8%，公司收入从33.2%修正为25.2%
  - 文档更新：同步更新业务需求文档和技术设计文档中的计算公式

2025-09-15 新增
- 机师分成管理功能：完整实现机师分成调整记录管理模块
  - 数据模型：新增PilotCommission和PilotCommissionChangeLog模型，支持分成调整记录和变更追踪
  - 路由实现：在routes/pilot.py中新增分成管理相关路由，包括CRUD操作和API接口
  - 模板设计：创建分成管理页面、新增/编辑页面模板，支持实时分成计算预览
  - 机师详情页集成：在机师详情页操作区域添加"分成管理"入口按钮
  - 业务逻辑：实现默认20%分成、历史调整记录、按调整日生效的分成计算规则
  - 权限控制：议长和舰长均可管理所有机师的分成调整记录
  - 变更记录：完整记录所有字段修改的操作日志，支持软删除和恢复
  - 数据验证：前端和后端双重验证，确保分成比例范围0-50%、调整日唯一性等业务规则
  - 影响：为机师收入分配管理提供完整的技术方案，确保分成调整的可追溯性和准确性

2025-09-15 增强
- 作战日报金额显示：为所有人民币单位数字添加千分位分隔符
  - 前端模板：月度数据卡片、日报汇总卡片、明细表格中的所有金额字段
  - CSV导出：所有人民币金额字段都使用千分位分隔符格式
  - 格式：使用Python的"{:,.2f}"格式，例如1234.56显示为1,234.56
  - 影响：提升金额数据的可读性，便于快速识别大数值

2025-09-15 修复
- Flask全局错误处理器：添加500/404/403错误处理器，确保所有错误都被记录到日志
  - 问题：500错误等服务器错误没有被记录到日志文件，生产环境无法调试
  - 修复：添加全局错误处理器，记录详细的错误堆栈、请求信息、用户信息
  - 功能：创建了错误页面模板（500.html、404.html、403.html），提供友好的错误提示
  - 日志：错误信息会记录到app.log文件中，包含完整的堆栈跟踪和请求上下文
  - 影响：大幅提升生产环境的错误调试能力，确保所有错误都有迹可循

2025-09-15 文档
- 机师-分成管理：新增机师分成管理子模块设计文档
  - 业务需求文档：定义分成调整记录的数据结构和业务规则
  - 技术设计文档：详细规划分成管理功能的技术实现方案
  - 功能特性：分成调整记录CRUD、软删除、变更记录、权限控制
  - 计算规则：默认20%分成，支持历史调整记录，按调整日生效
  - 界面设计：机师详情页集成、分成管理页面、调整记录列表
  - 影响：为机师收入分配管理提供完整的技术方案

2025-09-15 文档
- 机师-作战日报：增加返点任务统计功能设计
  - 月度数据增加：累计返点统计，汇总所有有资格获得返点的主播返点总和
  - 日报明细增加：月累计返点字段，显示该主播当月获得的返点金额
  - 返点计算规则：基于5个阶段的任务条件（直播有效天数、时长、流水），取最高档返点比例
  - 直播有效天数定义：有作战记录且单次播时≥60分钟的自然日去重数
  - 接口设计：month_summary增加rebate_sum字段，details增加月累计返点字段
  - CSV导出：增加月累计返点列，保留两位小数格式
- 计算逻辑看起来还有问题，正在确认中，因为没有bug所以先提交

2025-09-15 修复
- 征召统计仪表板数据计算：修复时间计算逻辑，与征召日报保持一致
  - 问题：仪表板使用UTC时间直接计算，征召日报使用本地时间进行日期归属后转换为UTC
  - 修复：仪表板改为使用本地时间进行日期归属，然后转换为UTC时间进行数据库查询
  - 影响：确保仪表板显示的征召统计数据与征召日报页面数据一致
  - 技术细节：使用utc_to_local和local_to_utc函数进行时间转换

2025-09-15 新增
- 征召统计仪表板：新增征召统计卡片，排在仪表板第一位
  - 后端实现：在_calculate_dashboard_data函数中添加征召统计数据计算
  - 前端实现：在仪表板模板中添加征召统计卡片，使用1个主要数据+2个副数据的布局模式
  - 文档更新：在基础仪表板文档中记录征召统计卡片的实现

2025-09-15 增强
- 作战记录统计卡片交互：添加单击跳转到作战日报功能
  - 功能实现：为作战记录统计卡片添加ID和点击事件监听器
  - 跳转目标：点击卡片跳转到作战日报页面（report.daily_report路由）
  - 用户体验：鼠标悬停显示指针样式，提供清晰的交互反馈
  - 一致性：与征召统计卡片和作战计划统计卡片的交互方式保持一致
  - 实现方式：使用JavaScript事件监听器，跳转到作战日报的默认日期页面

2025-09-15 修复
  - 问题：之前使用UTC时间直接计算日期范围，与征召日报的GMT+8本地时间处理不一致
  - 修复：统一使用GMT+8本地时间进行日期归属，然后转换为UTC时间进行数据库查询
  - 影响：确保所有仪表板统计数据的时间基准一致，与征召日报保持同步
  - 实现：使用utc_to_local()和local_to_utc()函数进行时间转换
  - 文档更新：在基础仪表板文档中明确说明时间处理方式

2025-09-15 修改
- 作战记录统计仪表板：将统计指标从记录数量改为流水金额
  - 后端实现：修改_calculate_dashboard_data函数，使用revenue_amount字段计算流水总和
  - 前端实现：更新模板显示格式，使用千分位格式化显示金额
  - 文档更新：在基础仪表板文档中更新作战记录统计的实现说明

2025-09-15 优化
  - 筛选逻辑：创建时间、预约时间、训练时间任意一个在7天内即显示
  - 时间计算：基于GMT+8本地时间计算7天前的时间点，转换为UTC进行数据库查询
  - 用户体验：减少列表数据量，聚焦近期活跃的征召流程
  - 文档更新：在机师征召文档中明确说明7天限制规则
  - 代码实现：使用MongoEngine的Q对象实现OR条件查询

2025-09-15 增强
- 机师征召日报百分比显示：在统计表格中添加百分比显示功能
  - 功能实现：报表日行显示相对于近7日的百分比，近7日行显示相对于近14日的百分比
  - 界面优化：百分比以灰色小字显示在数据下方，提升数据可读性
  - 安全计算：实现除零保护，当分母为0时显示0%
  - 文档更新：在征召日报文档中详细说明百分比显示规则
  - 代码优化：新增_calculate_percentages函数，使用yapf和isort格式化代码

2025-09-15 新增
- 机师征召日报功能实现：完整实现征召日报的统计和展示功能
  - 路由实现：在recruit.py中新增recruit_daily_report路由，支持日期参数和分页导航
  - 数据统计：实现约面、到面、试播、新开播四个核心指标的统计计算
  - 时间维度：支持报表日、近7日、近14日三个时间范围的统计
  - 模板设计：创建recruit_reports/daily.html模板，参考作战日报的UI设计风格
  - 菜单集成：在主菜单中添加"📊机师征召日报"入口，位于"机师征召"后面
  - 权限控制：仅议长和舰长可访问，遵循现有权限体系
  - 代码优化：修复linting错误，使用yapf和isort进行代码格式化

2025-09-15 文档
- 机师征召日报功能文档：新增独立的征召日报功能设计文档
  - 功能定位：独立的日报表功能，提供征召流程的统计分析
  - 菜单入口：在主菜单中新增"机师征召日报"入口，位于"机师征召"后面
  - 报表内容：统计约面、到面、试播、新开播四个核心指标
  - 时间维度：提供报表日、近7日、近14日三个统计范围
  - UI设计：参考作战计划日历的日视图设计，保持界面一致性
  - 数据规则：基于14天数据范围，不使用缓存确保实时性
  - 权限控制：仅议长和舰长可访问，遵循现有权限体系
  - 技术实现：提供完整的接口设计和实现要点说明

2025-09-15 优化
- 机师征召列表筛选器优化：简化筛选选项，提升用户体验
  - 筛选逻辑：将三个状态选项合并为两个更符合使用场景的选项
  - 默认筛选：改为"进行中"（包含已启动+训练征召中），更符合实际工作流程
  - 选项设计：进行中/已结束，减少用户选择负担
  - 模板更新：调整空状态提示文案，保持界面一致性
  - 文档更新：明确新的筛选器设计和使用说明

2025-09-15 优化
- 机师征召结束征召阶级自动设置：简化结束征召流程，移除冗余的阶级选择
  - 逻辑优化：结束征召决策直接决定机师阶级，无需额外选择
  - 表单简化：移除阶级下拉选框，减少用户操作步骤
  - 服务层更新：final_recruit_atomic方法根据决策自动设置阶级
  - 文档更新：明确说明阶级自动设置逻辑，提升用户体验
  - 代码清理：移除未使用的Rank导入和相关验证逻辑

2025-09-15 新增
- 机师征召结束征召战区选择：在结束征召步骤中增加战区选择功能
  - 文档更新：在机师征召文档中明确结束征召时需要选择战区
  - 表单扩展：结束征召页面新增战区选择字段，支持快手/抖音/其他/未知选项
  - 验证逻辑：征召成功时战区为必填项，确保机师信息完整性
  - 服务层更新：final_recruit_atomic方法支持战区更新，确保数据一致性
  - 模板优化：JavaScript动态控制战区字段必填状态，提升用户体验

2025-09-15 重构
- 机师征召三步制流程实现：完成征召流程从两步制到三步制的全面重构
  - 数据模型扩展：新增TrainingDecision、FinalDecision枚举，扩展Recruit模型字段
  - 服务层重构：实现training_recruit_atomic、final_recruit_atomic原子性操作
  - 路由实现：新增训练征召和结束征召页面及处理逻辑
  - 模板更新：创建training.html、final.html模板，更新detail.html、list.html
  - 状态流转：已启动 -> 训练征召中 -> 已结束，严格按步骤执行
  - 业务规则：训练时间验证、机师信息收集、分配信息收集
  - 单元测试：完整的三步制流程测试，覆盖所有状态流转和验证规则
  - 兼容性：保留原有confirm_recruit_atomic、abandon_recruit_atomic方法用于兼容

2025-09-15 新增
- 机师征召训练时间字段：在训练征召步骤中增加试播时间安排
  - 元数据表格：新增训练时间字段，用于记录与机师约定的试播时间
  - 训练征召表单：当选择"征召为训练机师"时，训练时间字段为必填项
  - 列表显示：在征召列表中添加训练时间列，按GMT+8格式显示
  - 时间处理：遵循UTC存储、GMT+8显示的时间规范

2025-09-15 重构
- 机师征召流程优化：将征召流程从两步制改为三步制，提升征召决策的严谨性
  - 流程调整：启动征召 -> 训练征召 -> 结束征召，确保征召决策的层次化
  - 状态流转：已启动 -> 训练征召中 -> 已结束，增加中间状态管理
  - 训练征召决策：征召为训练机师/不征召，同时收集机师基本信息（真实姓名、出生年、参战形式）
  - 结束征召决策：正式机师/实习机师/不征召，同时收集机师分配信息（所属、阶级）
  - 筛选器增强：新增训练征召决策、结束征召决策、征召负责人、渠道等筛选条件
  - 数据收集优化：在征召模块中完成必要的数据收集和校验，避免跨模块复杂依赖
  - 原子性保证：通过机师管理模块API方法更新机师信息，确保操作的原子性

2025-09-12 修复
- 文档与代码差异修复：
  - 作战区域管理：修复列表页默认筛选条件，未提供筛选参数时默认只显示"可用"状态的区域
  - 机师征召：在确认征召功能中添加后端验证，确保机师真实姓名不为空时才允许确认征召

2025-09-12 重构
- 系统性能与可靠性优化：基于测试发现文档的建议实施全面优化
  - 时间处理统一：移除硬编码时区偏移，统一使用 `utils/timezone_helper.py` 函数
  - 作战记录时间验证：修复时间验证逻辑，结束时间必须大于（而非大于等于）开始时间
  - 所属快照机制：修复无所属机师时不再使用当前用户作为快照，允许owner_snapshot为空
  - 征召状态流转原子性：新增 `utils/recruit_service.py` 提供原子性状态更新，包含回滚机制
  - 通告性能优化：添加复合索引优化冲突检查性能，限制重复事件生成最多60个实例
  - 报表性能优化：新增 `utils/report_optimizer.py` 批量计算减少数据库查询次数
 - 日历聚合重构：新增 `utils/calendar_aggregator.py` 统一处理月/周/日视图数据聚合
  - 单元测试补充：为所有优化添加对应单元测试，确保修改质量和回归防护

2025-09-12 文档
- 同步文档以匹配现有实现：
  - 机师管理：
    - 将“变更记录”数据存储描述调整为“独立模型持久化（非嵌入JSON）”（docs/机师-机师管理.md）
    - 明确变更记录通过 GET `/pilots/<id>/changes` 获取JSON并由前端弹窗渲染（docs/机师-机师管理.md、docs/机师-机师管理（技术设计）.md）
    - 移除“用户删除前检查下属机师”的描述（当前不支持删除用户）（上述两文档）
  - 用户系统：
    - 明确不支持“删除用户”，议长对舰长的管理为“增改查”（docs/基础-用户系统.md）
  - 作战记录：
    - 新增“接口（后端）”章节，补全 `/battle-records/api/*` 系列API与返回要点；在“从入口新建”处标注流程由多API组合实现（docs/机师-作战记录.md）
  - 作战计划（技术）：
    - 移除 `AnnouncementConflict` 持久化模型设计，改为运行时动态冲突检查说明
    - 将列表排序明确为“应用层按本地通告日+昵称排序”
    - 补充辅助性API清单与导出路由 `/announcements/export`（docs/机师-作战计划（技术设计）.md）

2025-01-11 文档更新
- 测试发现文档调整：根据业务需求调整 `docs/测试发现与设计建议.md`
  - 移除重复征召检查问题：根据用户反馈，重复征召在业务上可以接受
  - 问题编号重新整理：从11个问题调整为10个问题
  - 优先级建议更新：移除重复征召检查相关的高优先级建议
  - 文档结构优化：保持文档的完整性和逻辑性

2025-01-11 新增
- 全面补充单元测试覆盖：新增6个测试模块，覆盖核心业务逻辑
  - 测试基建：新增 `tests/fixtures/factory.py` 提供测试数据工厂方法
  - 通告管理测试：重复事件生成、冲突检查算法、边界条件处理
  - 作战记录测试：时间计算、金额验证、参战形式规则、业务规则验证
  - 征召流程测试：状态流转、机师联动、权限验证、业务规则检查
  - 报表统计测试：3日平均流水计算、月度统计聚合、数据准确性验证
  - 日历API测试：月/周/日视图数据聚合、区域占用统计、时间轴计算
  - 设计建议文档：新增 `docs/测试发现与设计建议.md` 记录测试过程中发现的设计问题
  - 测试覆盖：业务逻辑单元测试覆盖率显著提升，为系统健壮性提供保障

2025-09-11 新增
  - 日报数据层次：月度数据（截至报表日）、日报汇总（仅报表日）、日报明细（逐条记录）
  - 指标计算：机师数量、有效机师数量（播时≥6小时）、累计流水、累计底薪支出
  - 明细字段：机师信息、性别年龄、所属、阶级、作战区域、播时、流水、3日平均流水、月累计统计等
  - 3日平均流水：最近3个"有作战记录的自然日"的总流水平均值，若7日内不足3天则显示为空
  - 日期导航：支持前一日/后一日翻页，可直接选择日期
  - CSV导出：UTF-8 with BOM编码，支持Excel直接打开，包含完整明细数据
  - 时间口径：严格按GMT+8本地日期归属，基于作战记录开始时间换算
  - 权限控制：仅议长和舰长可访问
  - 主菜单集成：新增"📊作战日报"导航入口，位于作战记录下方
  - 响应式设计：移动端优化，表格支持横向滚动，固定首列便于查看


2025-09-11 新增
- 机师征召管理模块：完整实现机师征召流程管理功能
  - 征召数据模型：Recruit和RecruitChangeLog，支持征召状态跟踪和变更记录
  - 征召渠道：BOSS、51、介绍、其他四种渠道选择
  - 完整征召流程：启动征召→编辑征召→确认征召/放弃征召
  - 状态流转：已启动→已结束，同步更新机师状态（已征召/不征召）和阶级（训练机师）
  - 权限控制：仅议长和舰长可操作，舰长只能操作自己所属的机师征召
  - 机师详情页集成：未征召状态机师显示"启动征召"按钮
  - 主菜单集成：新增"机师征召"导航入口，默认显示已启动状态的征召
  - 移动端优化：卡片式列表设计，footbar操作按钮，响应式布局
  - 时间处理：严格遵循UTC存储，GMT+8显示的时间规范
  - 变更追踪：详细记录所有字段修改的操作日志（时间、操作者、前后值、IP）
  - 确认征召交互限制：当机师真实姓名为空时，确认征召按钮禁用，并提示前往机师管理补全资料
- 首页仪表板新增三张卡片：作战记录统计、机师统计、候补机师统计；完成后端数据统计与模板渲染。
- 战斗区域管理模块（模型、路由、模板、批量生成）并补充单元测试

2025-09-11 修复
- 通告详情 footbar 按钮顺序与样式统一为：编辑、登录作战记录、删除、变更记录，颜色遵循基础-UI风格。
- 作战记录登记（从通告进入）时：主播/所属改为只读展示，并以编辑页格式展示关联通告；修复脚本在无筛选器场景下的空元素访问。
 - 通告详情按钮细化：删除按钮文本居中；“登录作战记录”改为HUD绿背景白字且移除图标；“变更记录”恢复灰色描边样式。

2025-09-11 优化
- 全站统一 favicon：将 `static/zaft.svg` 重命名为 `static/favicon.svg` 并在 `templates/base.html` 全局引用；在页头品牌标题左侧显示图标。
- 机师征召列表 UI 统一：对齐作战记录列表的风格（折叠筛选器、卡片布局、配色与间距）。

2025-09-11 新增
- 实装机师-作战记录功能：完整的作战记录管理模块
- 作战记录元数据：主播、关联通告、开始结束时间、流水金额、底薪金额、X/Y/Z坐标快照、参战形式、所属快照、登记人、备注等字段
- 支持两种登记模式：从模块入口新建和从通告详情页预填
- 列表筛选功能：按所属、阶级、主播、时间筛选，默认显示自己的近7天记录
- 排序规则：开始时间逆序、流水金额次序，每次加载100条记录支持滚动加载
- 三联选择器：支持主播筛选（所属、阶级、昵称）和作战区域选择（X/Y/Z坐标）
- 时间默认值：开始时间为当前时间向前6小时取整点半点，结束时间为当前时间取整点半点
- 变更记录追踪：记录所有字段修改的详细日志（时间、操作者、字段、前后值、IP）
- 权限控制：仅议长和舰长可访问，完整的CRUD操作和变更记录查看
- 响应式设计：移动端优化的界面布局和footbar操作按钮

2025-09-11 修复/变更
- 作战记录参战形式与作战区域的业务规则：当参战形式为“线上”时，X/Y/Z不填写且不可编辑；当参战形式为“线下”时，X/Y/Z为必填项。
- 更新`BattleRecord`模型与路由校验逻辑；调整新建/编辑页面将“参战形式”移动至“作战区域”分组首位并联动禁用作战区域选择。
 - 从通告预填时：默认将参战形式设为“线下”，按通告时间预填开始/结束时间与X/Y/Z快照；API返回的通告详情也固定提供“线下”作为预填参战形式。
 - 编辑页UI精简：主播改为只读显示，移除用于筛选主播的“所属/阶级”筛选器，保持与创建页一致的“参战形式在作战区域首位”的布局。
 - 修复：编辑作战记录时，如前端未提交“关联通告”字段，后端不再将其置空；只有该字段被显式提交时才更新（空字符串表示清空）。
- 统一作战计划页面机师展示格式：
  - 新建/编辑页机师下拉项改为“昵称(年龄)[状态]性别符号”，与作战记录一致
  - 通告详情页机师信息展示对齐作战记录格式
  - /announcements/api/pilots-filtered 返回字段新增 name，用于上述统一展示

2025-01-11 新增
- 实装机师-作战计划日历功能：提供月视图、周视图、日视图三种日历界面
- 月视图：仿照手机月历APP设计，显示每日作战计划数量，点击日期跳转日视图
- 周视图：显示一周作战计划和可用区域统计，支持周次切换
- 日视图：类似会议室预订系统，按战斗区域和时间轴展示详细安排
- 实现完整的权限控制：仅舰长和议长可访问日历功能
- 添加导航菜单入口和首页仪表板快捷访问
- 支持响应式设计和移动端优化

2025-01-10 新增
- 实装首页仪表板功能：显示今日作战计划数量、环比变化和7日平均数据
- 实现响应式卡片布局：移动端单列显示，桌面端支持2-3列并排
- 添加数据可视化元素：使用图标和颜色区分正负变化
- 优化用户体验：卡片悬停效果和现代化设计风格

2025-01-10 修复
- 修复编辑通告界面中时间显示问题：编辑"未来所有"循环时，时间选择器（小时和分钟）现在正确显示GMT+8时间而非UTC时间
- 新增Jinja2过滤器`utc_to_local`用于模板中的时间转换
- 确保编辑界面与冲突检查结果中的时间显示统一为GMT+8格式
- 修复编辑"未来所有"循环时的冲突检查逻辑：现在会排除所有可能被编辑的未来通告，避免未来通告之间的相互冲突检查
- 优化`check_conflicts`方法支持排除多个通告ID，提升编辑循环事件的用户体验

2025-09-10 优化
- 优化机师-作战计划导出打印样式：专为A4纸张一页打印设计
- 打印时隐藏网站标题（Lacus-Log），去除不必要的页面元素
- 大幅压缩头部间距和字体大小：标题14px、机师信息10px、表格9px
- 减少页边距至10mm，最大化打印内容区域
- 调整表格行高和内边距，确保31天完整月份能在一页内显示
- 优化注意事项字体至8px，减少占用空间

2025-09-10 修复
- 修复机师-作战计划导出表格布局：按需求文档调整表格结构
- 场地信息（X坐标）移至表格上方单独显示，不再在表格中显示
- 表格中添加设备列，显示Y坐标-Z坐标组合
- 调整表格列宽比例：日期25%、通告时间20%、设备20%、通告时长15%、工作内容20%
- 优化场地信息显示样式，支持多个场地用逗号分隔

2025-09-10 修复
- 修复机师-作战计划导出功能选择逻辑：完全复用创建作战计划页面的机师筛选API
- 阶级选框现在显示所有阶级枚举选项（候补机师、训练机师、实习机师、正式机师）
- 机师选框默认列出所有状态为"已征召"或"已签约"的机师，与作战计划创建页面保持一致
- 使用现有的 /api/pilot-filters 和 /api/pilots-filtered API，确保行为统一
- 删除重复的导出专用API，减少代码冗余

2025-09-10 修复
- 修复机师-作战计划导出功能UI风格问题：统一与现有模块的界面风格
- 修复CSRF token显示问题：改为hidden input字段
- 优化三联选择逻辑：所属和阶级作为筛选器，机师选择支持多级筛选
- 改进表单布局：采用与新建通告页面一致的form-section和form-row结构
- 优化JavaScript交互：支持所属和阶级的独立筛选，提升用户体验

2025-09-10 新增
- 机师-作战计划导出功能：支持生成指定机师在指定月份的通告预定表
- 实现三联选择机师功能（所属、阶级、昵称）
- 支持年月选择，默认当前年月
- 生成完整月份表格，包含日期、场地、通告时间、设备、通告时长、工作内容等字段
- 专为打印设计的PDF样式，适合A4纸张输出
- 包含开播注意事项说明
- 权限控制：议长和舰长可使用

2025-01-10 修复
- 修复编辑页面和新建页面冲突检查结果标题重复显示的问题：移除HTML模板中的固定标题，统一由JavaScript动态生成标题
- 确保冲突检查结果显示的一致性和用户体验

2025-01-10 修复
- 修复编辑通告时"修改未来所有循环"的冲突检查问题：现在会检查所有可能被修改的通告实例，而不是只检查当前这一个通告
- 更新冲突检查API，新增edit_scope参数支持区分"仅这一次"和"未来所有"的编辑范围
- 优化前端JavaScript，在编辑未来所有循环时传递正确的编辑范围参数
- 确保用户能够清楚看到所有相关通告的检查结果，提升用户体验
- 修复编辑未来所有循环时第一个通告时间未正确更新的问题：现在第一个通告也会使用新的完整时间，而不是保持原时间

2025-01-10 改进
- 编辑通告时，若修改未来所有循环，开始时间中的日期不能修改，只能修改时间
- 添加时间格式化函数：get_local_date_for_input、get_local_time_for_input
- 更新编辑模板，当编辑范围为"未来所有循环"时，日期输入框设为只读，时间改为下拉选择器（小时和分钟）
- 更新后端逻辑，确保编辑未来所有循环时只更新时间部分，保持日期不变
- 添加前端JavaScript验证，防止用户修改日期部分
- 优化时间选择体验：小时选择器（00-23），分钟选择器（00-45，15分钟间隔）

2025-09-10 修复
- 修复编辑通告时"请填写所有必填项"错误：添加隐藏的battle_area字段，修复前端JavaScript与后端验证字段不匹配的问题
- 添加debug日志帮助定位表单数据问题

2025-09-10 改进
- 改进通告编辑和删除功能，支持"编辑/删除这一次"和"编辑/删除未来所有"选项
- 对循环组内的通告提供两个编辑按钮选项，不再要求必须修改父通告
- 实现循环组分割功能，当用户选择"编辑/删除未来所有"时，自动创建新的循环组
- 隐藏父通告概念，优化用户界面体验
- 新增通告模型方法：split_recurrence_group_from_current、get_future_announcements_in_group、is_in_recurrence_group

2025-09-10 修复
- 通告编辑页补齐机师三联动筛选与初始化逻辑，修复机师下拉无选项问题，并与新建页保持一致的填充顺序。

2025-09-10 修复
- 通告编辑页“检查冲突”结果展示对齐新建页：当无冲突时显示 planned_instances 计划详情（含单事件与多事件汇总），提升一致性与可读性。

# 变更日志

2025-09-10 文档
- 将作战计划相关界面与文档中的“重复组”统一更名为“循环组”。

2025-09-10 修复
- 修正通告列表“默认筛选器：所属=自己”未生效的问题，缺省时默认按当前用户过滤。

2025-09-10 修复
- 通告列表排序从“开始时间倒序”改为“按本地通告日升序、同日按机师昵称”。

## 2025-09-10 新增：
- 通告列表新增“时间”筛选：支持“现在开始”（默认）与“全部”
- 默认仅显示开始时间大于等于当前时间（按GMT+8转换后比较）的通告

## 2025-09-10 界面优化：
- 通告详情页面界面改进：将操作按钮（编辑、删除、变更记录）移动到页面底部，采用footbar吸附式设计
- 优化移动端用户体验，按钮在底部更便于触控操作
- 保持与现有设计风格的一致性，支持安全区域适配
- 调整冲突检查结果显示位置：在新建和编辑通告页面中，冲突检查结果现在显示在"检查冲突"按钮和"创建通告/保存修改"按钮之间，提升用户体验

## 2025-09-10 修复和优化：
- 时间戳处理规则的完整实现和修复
- 新增 `utils/timezone_helper.py` 时间转换工具模块
- 修复所有模型中的UTC时间戳默认值设定
- 修复路由中用户输入时间的GMT+8到UTC转换
- 修复模板中时间显示的UTC到GMT+8转换
- 新增时间处理相关的Jinja2过滤器（local_datetime、local_date、local_time、local_datetime_for_input）
- 优化新建通告页面时间输入体验：
  - 开始时间默认为当天13:00（便于用户输入）
  - 循环结束时间改为只选择日期，时间自动设为23:59
  - 循环结束日期默认为当前月最后一天
- 移除开始时间不能早于当前时间的验证限制，允许创建历史记录和补录数据
- 确保系统严格遵循"数据库存储UTC时间，UI显示和输入GMT+8时间"的设计规则
- 通过验证脚本确认所有时间转换函数工作正常

2025-09-10 修复
- 冲突检查API返回的计划详情与冲突项时间统一转换为GMT+8显示，修复新建与编辑页检查结果时间显示为UTC的问题。

## 2025-09-10 新增：
- 作战计划管理模块，包括通告的创建、编辑、删除、查看功能
- 支持重复事件管理（每日、每周、自定义重复）
- 时间冲突检查和资源占用验证
- 通告变更记录追踪
- 类似日历应用的用户体验设计

2025-09-11 文档
- 新增《机师-作战记录》设计文档：
  - 定义作战记录元数据（主播、时间、金额、X/Y/Z快照、参战形式、所属快照、登记人等）
  - 提供两种登记模式（从模块入口、从通告详情），支持从通告预填
  - 列表筛选（所属、阶级、主播、时间：今天/近7天），默认所属=自己、时间=近7天
  - 排序规则（开始时间逆序、流水金额次序）与UI/权限/日志规范

## 2025-09-09 新增：
2025-09-11 变更
- 机师管理权限调整：舰长与议长权限一致，不再限制舰长仅查看/编辑自己所属机师；相应更新 `routes/pilot.py`、技术/业务文档与变更日志。
 - 征召模块权限调整：舰长与议长权限一致，移除“仅能操作所属机师”的限制；更新 `routes/recruit.py` 与征召文档。
- 完整实现机师管理功能模块，包括数据模型、路由控制、前端界面

