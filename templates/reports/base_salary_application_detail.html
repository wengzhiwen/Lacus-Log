{% extends "base.html" %}

{% block title %}底薪申请详情 - Lacus-Log{% endblock %}

{% block content %}
<div class="container">
  <div class="back-nav">
    <a class="btn btn-secondary" id="backButton" href="/reports/base-salary-applications">
      <span>←</span>
      返回
    </a>
  </div>

<section class="battle-record-detail">
  <div class="page-header">
    <h1 class="page-title">底薪申请详情</h1>
  </div>

  <div class="detail-card">
    <!-- 主播信息卡片 -->
    <div class="card-section">
      <h3 class="section-title">主播信息</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>昵称</label>
          <div class="value" id="pilotNickname">加载中...</div>
        </div>
        <div class="detail-item">
          <label>真实姓名</label>
          <div class="value" id="pilotRealName">加载中...</div>
        </div>
        <div class="detail-item">
          <label>直属运营</label>
          <div class="value" id="pilotOwner">加载中...</div>
        </div>
        <div class="detail-item">
          <label>当前结算方式</label>
          <div class="value" id="currentSettlement">加载中...</div>
        </div>
      </div>
    </div>

    <!-- 开播记录卡片 -->
    <div class="card-section">
      <h3 class="section-title">开播记录信息</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>开始时间</label>
          <div class="value" id="battleStartTime">加载中...</div>
        </div>
        <div class="detail-item">
          <label>时长</label>
          <div class="value" id="battleDuration">加载中...</div>
        </div>
        <div class="detail-item full-width">
          <label>流水金额</label>
          <div class="value amount" id="battleRevenue">加载中...</div>
        </div>
      </div>
    </div>

    <!-- 申请信息卡片 -->
    <div class="card-section">
      <h3 class="section-title">申请信息</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>结算方式（快照）</label>
          <div class="value" id="settlementType">加载中...</div>
        </div>
        <div class="detail-item">
          <label>申请底薪金额</label>
          <div class="value amount" id="baseSalaryAmount">加载中...</div>
        </div>
        <div class="detail-item">
          <label>申请人</label>
          <div class="value" id="applicant">加载中...</div>
        </div>
        <div class="detail-item">
          <label>申请时间</label>
          <div class="value" id="createdAt">加载中...</div>
        </div>
      </div>
    </div>

    <!-- 发放状态卡片 -->
    <div class="card-section">
      <h3 class="section-title">发放状态</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>状态</label>
          <div class="value" id="statusDisplay">加载中...</div>
        </div>
        <div class="detail-item">
          <label>最近操作人</label>
          <div class="value" id="lastOperator">未操作</div>
        </div>
        <div class="detail-item">
          <label>操作时间</label>
          <div class="value" id="lastOperatedAt">--</div>
        </div>
      </div>
    </div>
  </div>

  <div id="errorMessage" class="error-message" style="display:none;"></div>
</section>
</div>

<!-- 状态变更模态框 -->
<div id="statusChangeModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>变更申请状态</h3>
      <button class="modal-close" onclick="closeStatusChangeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">新状态</label>
        <div id="newStatusDisplay" class="status-preview"></div>
      </div>
      <div class="form-group">
        <label for="remarkInput" class="form-label">操作备注（选填）</label>
        <textarea id="remarkInput" class="form-input" rows="3" maxlength="200" placeholder="输入操作说明"></textarea>
        <small style="color: #999;">
          <span id="charCount">0</span>/200
        </small>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeStatusChangeModal()">取消</button>
      <button type="button" class="btn btn-primary" id="confirmStatusChangeBtn" onclick="confirmStatusChange()">确认变更</button>
    </div>
  </div>
</div>

<!-- 变更记录模态框 -->
<div id="changeLogModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>变更记录</h3>
      <button class="modal-close" onclick="hideChangeLog()">&times;</button>
    </div>
    <div class="modal-body" id="changeLogContent">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <div class="loading-text">加载中...</div>
      </div>
    </div>
  </div>
</div>

<!-- 底部操作栏 -->
<div class="footbar" id="footbarContainer">
  <div class="inner" id="actionButtons">
    <!-- 操作按钮将通过JavaScript动态生成 -->
  </div>
</div>

<style>
/* 复用开播记录详情页面的样式 */
.container {
  padding-bottom: 88px;
}

.back-nav {
  margin-bottom: 16px;
}

.battle-record-detail {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.page-header {
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e0e0e0;
}

.page-title {
  font-size: 22px;
  font-weight: 600;
  color: #333;
  margin: 0;
}

.detail-card {
  background: #f9f9f9;
  border: 1px solid #e8e8e8;
  border-radius: 6px;
  padding: 16px;
  margin-bottom: 16px;
}

.card-section {
  margin-bottom: 20px;
}

.card-section:last-child {
  margin-bottom: 0;
}

.section-title {
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin: 0 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid #e8e8e8;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.detail-item {
  display: flex;
  flex-direction: column;
}

.detail-item.full-width {
  grid-column: 1 / -1;
}

.detail-item label {
  font-size: 12px;
  color: #999;
  margin-bottom: 4px;
  font-weight: 500;
}

.detail-item .value {
  font-size: 14px;
  color: #333;
  font-weight: 500;
}

.detail-item .value.amount {
  color: #8B0000;
  font-size: 16px;
}

.footbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid #e0e0e0;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
  padding: 10px 12px calc(env(safe-area-inset-bottom, 0) + 10px) 12px;
  z-index: 1;
}

.footbar .inner {
  display: flex;
  justify-content: center;
  gap: 12px;
}

.btn {
  padding: 10px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  border: none;
  transition: all 0.2s;
  font-weight: 500;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.btn-secondary {
  background: #fff;
  color: #111111;
  border: 1px solid #A9A9A9;
}

.btn-secondary:hover {
  background: #F2F2F2;
}

.btn-primary {
  background: #8B0000;
  color: white;
  border: 1px solid #8B0000;
}

.btn-primary:hover {
  background: #B22222;
}

.btn-success {
  background: #00B37A;
  color: white;
  border: 1px solid #00B37A;
}

.btn-success:hover {
  background: #00a16e;
}

.btn-danger {
  background: #FF4500;
  color: white;
  border: 1px solid #FF4500;
}

.btn-danger:hover {
  background: #e03e00;
}

.btn:disabled {
  background: #bfbfbf;
  cursor: not-allowed;
  opacity: 0.6;
}

.error-message {
  background: #fff2e6;
  border: 1px solid #ffbb96;
  border-radius: 4px;
  padding: 12px;
  color: #c6001a;
  font-size: 14px;
  margin-bottom: 16px;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-content {
  background: #fff;
  border-radius: 8px;
  max-width: 500px;
  width: 100%;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
}

.modal-header {
  padding: 16px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #333;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
}

.modal-body {
  padding: 16px;
  flex: 1;
  overflow-y: auto;
}

.modal-footer {
  padding: 16px;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: #333;
  margin-bottom: 8px;
}

.form-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d9d9d9;
  border-radius: 4px;
  font-size: 14px;
  color: #333;
  box-sizing: border-box;
  font-family: inherit;
}

.status-preview {
  font-size: 14px;
  padding: 8px 12px;
  background: #f5f5f5;
  border-radius: 4px;
  color: #333;
}

.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  color: #999;
}

.loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #1890ff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  font-size: 12px;
}

.change-log-item {
  background: #fff;
  border: 1px solid #e8e8e8;
  border-radius: 4px;
  padding: 10px;
  margin-bottom: 8px;
  font-size: 12px;
}

.change-field {
  font-weight: 500;
  margin-bottom: 4px;
}

.change-detail {
  color: #666;
  margin-left: 12px;
}

.link {
  color: #8B0000;
  text-decoration: none;
}

.link:hover {
  text-decoration: underline;
}

@media (max-width: 600px) {
  .container {
    padding: 12px;
  }

  .detail-grid {
    grid-template-columns: 1fr;
  }

  .detail-item.full-width {
    grid-column: 1;
  }

  .footbar .inner {
    flex-direction: column;
  }

  .btn {
    width: 100%;
  }
}
</style>

<script>
const APPLICATION_ID = new URLSearchParams(window.location.search).get('id');
let applicationData = null;

async function initPage() {
  if (!APPLICATION_ID) {
    showError('缺少申请ID参数');
    return;
  }

  // 设置返回链接，保持日期参数
  setupBackButton();

  try {
    await loadApplicationDetail();
  } catch (error) {
    showError(error.message);
  }
}

function setupBackButton() {
  const backButton = document.getElementById('backButton');
  const urlParams = new URLSearchParams(window.location.search);
  const dateParam = urlParams.get('date');
  
  let backUrl = '/reports/base-salary-applications';
  if (dateParam) {
    backUrl += `?date=${dateParam}`;
  }
  
  backButton.href = backUrl;
}

async function loadApplicationDetail() {
  try {
    console.log('开始加载申请详情，ID:', APPLICATION_ID);
    const response = await fetch(`/api/base-salary-applications/${APPLICATION_ID}`, {
      credentials: 'include'
    });

    console.log('API响应状态:', response.status);
    if (!response.ok) {
      throw new Error('加载申请详情失败');
    }

    const result = await response.json();
    console.log('API响应数据:', result);
    if (!result.success) {
      throw new Error(result.error?.message || '申请不存在');
    }

    applicationData = result.data;
    console.log('设置applicationData:', applicationData);
    renderDetail();
  } catch (error) {
    console.error('加载申请详情失败:', error);
    showError(error.message);
  }
}

function renderDetail() {
  // 主播昵称 - 添加超链接
  const pilotNickname = document.getElementById('pilotNickname');
  if (applicationData.pilot?.nickname && applicationData.pilot?.id) {
    pilotNickname.innerHTML = `<a href="/pilots/${applicationData.pilot.id}?from=base_salary_detail&application_id=${APPLICATION_ID}" class="link">${applicationData.pilot.nickname}</a>`;
  } else {
    pilotNickname.textContent = '--';
  }
  
  document.getElementById('pilotRealName').textContent = applicationData.pilot?.real_name || '--';
  document.getElementById('pilotOwner').textContent = applicationData.pilot?.owner?.nickname || '--';
  
  // 当前结算方式 - 添加超链接
  const currentSettlement = document.getElementById('currentSettlement');
  const settlementTypeDisplay = getSettlementTypeDisplay(applicationData.settlement_type);
  if (applicationData.pilot?.id) {
    currentSettlement.innerHTML = `<a href="/pilots/${applicationData.pilot.id}/settlement/?from=base_salary_detail&application_id=${APPLICATION_ID}" class="link">${settlementTypeDisplay}</a>`;
  } else {
    currentSettlement.textContent = settlementTypeDisplay;
  }
  
  document.getElementById('settlementType').textContent = settlementTypeDisplay;

  // 开始时间 - 添加超链接
  const battleStartTime = document.getElementById('battleStartTime');
  const formattedTime = formatDateTime(applicationData.battle_record?.start_time);
  if (formattedTime && applicationData.battle_record?.id) {
    battleStartTime.innerHTML = `<a href="/battle-records/${applicationData.battle_record.id}?from=base_salary_detail&application_id=${APPLICATION_ID}" class="link">${formattedTime}</a>`;
  } else {
    battleStartTime.textContent = formattedTime || '--';
  }
  
  document.getElementById('battleDuration').textContent = (applicationData.battle_record?.duration_hours || 0) + ' 小时';
  document.getElementById('battleRevenue').textContent = '¥' + (parseFloat(applicationData.battle_record?.revenue_amount || 0).toFixed(2));

  document.getElementById('baseSalaryAmount').textContent = '¥' + (parseFloat(applicationData.base_salary_amount || 0).toFixed(2));
  document.getElementById('applicant').textContent = applicationData.applicant?.nickname || '--';
  document.getElementById('createdAt').textContent = formatDateTime(applicationData.created_at) || '--';

  // 状态显示
  const statusDisplay = document.getElementById('statusDisplay');
  statusDisplay.textContent = applicationData.status_display;
  statusDisplay.className = `status-value ${applicationData.status}`;

  // 操作时间显示
  document.getElementById('lastOperatedAt').textContent = formatDateTime(applicationData.updated_at) || '--';

  // 渲染操作按钮到footbar
  renderActionButtons();
}

// 结算方式枚举值转显示值的映射
function getSettlementTypeDisplay(settlementType) {
  const mapping = {
    'daily_base': '日结底薪',
    'monthly_base': '月结底薪',
    'none': '无底薪'
  };
  return mapping[settlementType] || settlementType || '未知';
}

function renderActionButtons() {
  const actionsDiv = document.getElementById('actionButtons');
  const status = applicationData.status;
  
  console.log('渲染操作按钮 - 状态:', status, '数据:', applicationData);

  let buttons = [];

  if (status === 'pending' || status === 'rejected') {
    buttons.push(`<button class="btn btn-success" onclick="prepareStatusChange('approved')">
      <span class="btn-icon">✓</span>
      确认发放
    </button>`);
  }

  if (status === 'pending' || status === 'approved') {
    buttons.push(`<button class="btn btn-danger" onclick="prepareStatusChange('rejected')">
      <span class="btn-icon">✗</span>
      拒绝发放
    </button>`);
  }

  if (status === 'approved' || status === 'rejected') {
    buttons.push(`<button class="btn btn-secondary" onclick="prepareStatusChange('pending')">
      <span class="btn-icon">↺</span>
      回到未处理
    </button>`);
  }

  buttons.push(`<button class="btn btn-secondary" onclick="showChangeLog()">
    <span class="btn-icon">📋</span>
    变更记录
  </button>`);

  console.log('生成的按钮:', buttons);

  if (buttons.length === 0) {
    actionsDiv.innerHTML = '<span style="color: #666;">无可用操作</span>';
  } else {
    actionsDiv.innerHTML = buttons.join('');
  }
}

function prepareStatusChange(newStatus) {
  const statusMap = {
    'pending': '未处理',
    'approved': '已发放',
    'rejected': '拒绝发放'
  };

  document.getElementById('newStatusDisplay').textContent = statusMap[newStatus] || '未知';
  document.getElementById('remarkInput').value = '';
  document.getElementById('charCount').textContent = '0';
  document.getElementById('confirmStatusChangeBtn').setAttribute('data-new-status', newStatus);
  document.getElementById('statusChangeModal').style.display = 'block';
}

document.getElementById('remarkInput').addEventListener('input', (e) => {
  document.getElementById('charCount').textContent = e.target.value.length;
});

async function confirmStatusChange() {
  const newStatus = document.getElementById('confirmStatusChangeBtn').getAttribute('data-new-status');
  const remark = document.getElementById('remarkInput').value.trim();
  const btn = document.getElementById('confirmStatusChangeBtn');

  btn.disabled = true;

  try {
    const response = await fetch(`/api/base-salary-applications/${APPLICATION_ID}/status`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        status: newStatus,
        remark: remark || null
      })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error?.message || '状态变更失败');
    }

    closeStatusChangeModal();
    await loadApplicationDetail();
  } catch (error) {
    alert('❌ ' + error.message);
    btn.disabled = false;
  }
}

function closeStatusChangeModal() {
  document.getElementById('statusChangeModal').style.display = 'none';
}


function showChangeLog() {
  const modal = document.getElementById('changeLogModal');
  const content = document.getElementById('changeLogContent');
  
  modal.style.display = 'flex';
  content.innerHTML = `
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <div class="loading-text">加载中...</div>
    </div>
  `;
  
  loadChangeLogData();
}

function hideChangeLog() {
  document.getElementById('changeLogModal').style.display = 'none';
}

async function loadChangeLogData() {
  try {
    const response = await fetch(`/api/base-salary-applications/${APPLICATION_ID}/changes`, {
      credentials: 'include'
    });

    if (!response.ok) {
      throw new Error('加载变更记录失败');
    }

    const result = await response.json();
    const content = document.getElementById('changeLogContent');
    
    if (result.success && result.data.items && result.data.items.length > 0) {
      const logs = result.data.items;
      content.innerHTML = logs.map(log => `
        <div class="change-log-item">
          <div class="change-field">${log.field_display_name}</div>
          <div class="change-detail">旧值: ${log.old_value || '(无)'}</div>
          <div class="change-detail">新值: ${log.new_value || '(无)'}</div>
          ${log.remark ? `<div class="change-detail">备注: ${log.remark}</div>` : ''}
          <div class="change-detail" style="color: #999; margin-top: 4px;">
            ${log.user?.nickname || '未知'} - ${formatDateTime(log.change_time) || '--'}
          </div>
        </div>
      `).join('');
    } else {
      content.innerHTML = '<div class="loading-state"><div class="loading-text">暂无变更记录</div></div>';
    }
  } catch (error) {
    console.error('加载变更记录失败:', error);
    document.getElementById('changeLogContent').innerHTML = `
      <div class="loading-state">
        <div class="loading-text" style="color: #c6001a;">加载失败：${error.message}</div>
      </div>
    `;
  }
}

function formatDateTime(isoString) {
  if (!isoString) return '--';
  try {
    // 处理没有时区信息的ISO格式字符串
    let dateStr = isoString;
    if (dateStr.includes('T') && !dateStr.includes('Z') && !dateStr.includes('+') && !dateStr.includes('-', 10)) {
      // 如果没有时区信息，假设为本地时间
      dateStr = dateStr + '+08:00';
    }
    const date = new Date(dateStr);
    
    // 检查日期是否有效
    if (isNaN(date.getTime())) {
      return '--';
    }
    
    return date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  } catch {
    return '--';
  }
}

function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
}

window.onclick = function(event) {
  const statusModal = document.getElementById('statusChangeModal');
  const changeLogModal = document.getElementById('changeLogModal');
  
  if (event.target === statusModal) {
    statusModal.style.display = 'none';
  }
  
  if (event.target === changeLogModal) {
    changeLogModal.style.display = 'none';
  }
}

document.addEventListener('DOMContentLoaded', initPage);
</script>
{% endblock %}

