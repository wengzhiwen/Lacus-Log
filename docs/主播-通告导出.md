# 主播-通告导出（原“机师-作战计划导出”）

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；战斗区域→开播地点；阶级→主播分类；所属→直属运营；X坐标→基地；Y坐标→场地；Z坐标→坐席；作战计划→通告。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。

## 概述

主播-通告导出功能用于生成指定主播在指定月份的通告预定表，以PDF格式输出供打印使用。该功能基于现有的通告数据（模型：Announcement），生成格式化的通告预定表。

## 功能描述

### 主要功能
- 选择主播（使用与创建通告相同的三联选择方式）
- 选择年月（默认当前年月）
- 生成指定主播在指定月份的通告预定表
- 支持浏览器打印功能输出PDF文件

### 数据来源
- 基于现有的 `Announcement` 模型数据（存储通告）
- 关联 `Pilot` 模型获取主播信息（字段历史称“机师”）
- 关联 `BattleArea`（开播地点）模型获取坐标信息

## 用户界面设计

### 功能入口
- 与"主播-通告"平行的独立菜单项目
- 菜单名称：**主播-通告导出**
- 权限：管理员和运营

### 页面布局
- **选择区域**：
  - 主播选择：使用三联选择（直属运营、主播分类、昵称）
  - 年月选择：年月选择器，默认当前年月
  - 生成按钮：点击生成通告预定表

- **表格展示区域**：
  - 标题：`{昵称} 通告预定表（{X}月）`
  - 表格内容：按日期顺序展示整月的通告信息
  - 打印按钮：调用浏览器打印功能

### UI风格要求
- 专为打印输出设计的PDF表格样式
- 不使用移动设备UI风格
- 去除不必要的装饰元素，确保打印效果良好
- 表格布局清晰，适合A4纸张打印

## 数据映射规则

### 表格字段映射
| 表格字段 | 数据来源 | 格式要求 | 备注 |
|---------|---------|---------|------|
| 昵称 | `pilot.nickname` | 直接显示 | 对应原图的"艺名" |
| 姓名 | `pilot.real_name` | 直接显示 | 对应原图的"姓名" |
| 运营 | `pilot.owner.nickname` 或 `pilot.owner.username` | 直接显示 | 对应原图的"运营" |
| 场地 | `announcement.x_coord` | 多个用逗号分隔 | 对应原图的"场地" |
| 日期 | `announcement.start_time` | `mm/dd 星期N` | 对应原图的"日期" |
| 通告时间 | `announcement.start_time` | `hh:mm` (24小时制 GMT+8) | 对应原图的"通告时间" |
| 设备 | `announcement.y_coord` + `-` + `announcement.z_coord` | `场地-坐席` | 对应原图的"设备" |
| 通告时长 | `announcement.duration_hours` | `N小时` | 对应原图的"通告时长" |
| 工作内容 | 固定值 | `弹幕游戏直播` | 固定内容 |

### 时间处理
- 所有时间显示均使用GMT+8时区
- 日期格式：`mm/dd 星期N`（如：09/01 星期一）
- 时间格式：`hh:mm`（24小时制，如：08:00）

### 数据排序
- 按日期顺序排列，从所选月的第一天到最后一天
- 每天一行，即使当天没有通告也要显示空行
- 确保表格的完整性和连续性

## 技术实现

### 路由设计
- **主页面路由**：`/announcements/export`
- **生成API路由**：`/announcements/export/generate`
- **权限控制**：管理员和运营

### 数据查询逻辑
1. **主播选择**：复用现有的三联选择逻辑
2. **年月筛选**：根据选择的年月筛选通告数据
3. **数据聚合**：按日期聚合通告信息
4. **表格生成**：生成完整的月度表格数据

### 模板设计
- **主页面模板**：`templates/announcements/export.html`
- **表格模板**：`templates/announcements/export_table.html`
- **打印样式**：专门的CSS打印样式

### 核心功能函数
```python
def get_pilot_choices():
    """获取主播选择列表（复用现有逻辑）"""

def get_monthly_announcements(pilot_id, year, month):
    """获取指定主播在指定月份的通告数据"""

def generate_export_table(pilot, year, month):
    """生成导出表格数据"""

def format_announcement_data(announcements):
    """格式化通告数据为表格格式"""
```

## 业务规则

### 数据展示规则
1. **完整月份**：显示所选月份的所有日期（1号到最后一天）
2. **空日期处理**：没有通告的日期显示空行
3. **多通告处理**：同一天多个通告时，合并显示或分行显示
4. **坐标处理**：多个基地用逗号分隔

### 权限控制
- 管理员：可以查看所有主播的通告预定表
- 运营：可以查看所有主播的通告预定表（与管理员权限相同）

### 数据验证
- 主播选择必填
- 年月选择必填
- 确保选择的主播存在且有效

## 开播注意事项

### 固定内容
在表格底部显示以下固定注意事项：

1. **提前到达**：请每日合理提前到达通告指定场地，通告开始时间为正式工作的开始时间。

2. **签到沟通**：到达通告场地后请先到值班运营处签到，与运营沟通本次通告的计划与准备情况，以及非通告期间个人社交账号的维护情况。

3. **完成确认**：通告规定任务结束后请到值班运营处确认通告完成情况后再离开通告场地。

## 扩展性考虑

### 未来扩展
- 支持多主播批量导出
- 支持自定义时间段导出
- 支持不同格式的导出（Excel、CSV等）
- 支持邮件发送功能

### 性能优化
- 大量数据时的分页处理
- 缓存机制优化
- 异步生成处理

## 测试策略

### 功能测试
- 主播选择功能测试
- 年月选择功能测试
- 表格生成功能测试
- 打印功能测试

### 数据测试
- 不同月份的数据展示
- 空数据情况处理
- 多通告情况处理
- 边界日期处理

### 权限测试
- 管理员权限测试
- 运营权限测试
- 未授权访问测试

## 部署说明

### 依赖要求
- 复用现有的数据模型和权限系统

### 配置要求
- 使用现有的时区设置

### 数据库影响
- 无需修改数据库结构
- 仅读取现有数据

## 总结

主播-通告导出功能是一个相对独立的功能模块，主要目的是将现有的通告数据以表格形式输出，便于打印和查看。该功能设计简洁，实现相对简单，但需要特别注意打印样式的优化和数据的完整性展示。

通过该功能，用户可以方便地生成指定主播的月度通告预定表，满足日常管理和打印需求。
