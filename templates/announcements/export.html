{% extends "base.html" %}
{% block title %}主播-通告计划导出 - Lacus-Log{% endblock %}

{% block content %}
<section class="pilot-detail">
  <div class="back-nav">
    <a class="btn btn-secondary" href="{{ url_for('announcement.list_announcements') }}">
      <span>←</span>
      返回
    </a>
  </div>

  <div class="pilot-info-card">
    <form method="POST" id="exportForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

      <div class="info-section">
        <h3 class="section-title">主播选择</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="pilot_search">昵称 / 真实姓名 搜索：</label>
            <input type="text" id="pilot_search" placeholder="输入主播昵称或真实姓名进行筛选">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="pilot_id" class="required">主播：</label>
            <select name="pilot_id" id="pilot_id" required>
              <option value="">请选择主播</option>
            </select>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3 class="section-title">时间选择</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="year" class="required">年份：</label>
            <select name="year" id="year" required></select>
          </div>
          <div class="form-group">
            <label for="month" class="required">月份：</label>
            <select name="month" id="month" required></select>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button type="submit" class="btn btn-primary">导出通告预定表</button>
      </div>
    </form>
  </div>
</section>

<style>
.pilot-detail { max-width: 800px; margin: 0 auto; }
.back-nav { margin-bottom: 10px; }
.pilot-info-card { background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--table-header); }
.info-section { margin-bottom: 24px; }
.section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--brand); border-bottom: 1px solid var(--table-header); padding-bottom: 8px; }

.form-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.form-row:last-child {
    margin-bottom: 0;
}

.form-group {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 5px;
    font-weight: 500;
    color: #555;
}

.form-group label.required::after {
    content: ' *';
    color: #dc3545;
}

.form-group input,
.form-group select {
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.form-group input:disabled,
.form-group select:disabled {
    background-color: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
}

.action-buttons { display: flex; gap: 12px; flex-wrap: wrap; }

.btn {
    display: inline-block;
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-outline {
    background: transparent;
    color: #6c757d;
    border: 1px solid #6c757d;
}

.btn-outline:hover {
    background: #6c757d;
    color: white;
}

@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
        gap: 20px;
    }
    
    .form-actions {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pilotSelect = document.getElementById('pilot_id');
    const yearSelect = document.getElementById('year');
    const monthSelect = document.getElementById('month');

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth() + 1;

    for (let year = currentYear - 1; year <= currentYear + 1; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        if (year === currentYear) option.selected = true;
        yearSelect.appendChild(option);
    }

    for (let month = 1; month <= 12; month++) {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month + '月';
        if (month === currentMonth) option.selected = true;
        monthSelect.appendChild(option);
    }

    function buildPilotDisplay(p) {
        const nickname = p.nickname || '';
        const agePart = p.age ? `(${p.age})` : '';
        const realName = p.real_name ? p.real_name : '';
        const rank = p.rank ? p.rank : '';
        const genderVal = (p.gender === 0 || p.gender === 1) ? p.gender : null;
        const genderIcon = genderVal === 0 ? '♂' : (genderVal === 1 ? '♀' : '?');
        const nameWithReal = realName ? `${nickname}${agePart}${realName}` : `${nickname}${agePart}`;
        const rankPart = rank ? `[${rank}]` : '';
        return `${nameWithReal}${rankPart}${genderIcon}`;
    }

    function loadExportPilots(callback) {
        pilotSelect.innerHTML = '<option value="">请选择主播</option>';
        fetch('/announcements/api/pilots-filtered')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.__exportAllPilots = data.pilots || [];
                    window.__exportAllPilots.forEach(pilot => {
                        const option = document.createElement('option');
                        option.value = pilot.id;
                        option.textContent = buildPilotDisplay(pilot);
                        option.setAttribute('data-nickname', pilot.nickname || '');
                        option.setAttribute('data-real-name', pilot.real_name || '');
                        pilotSelect.appendChild(option);
                    });
                    if (callback) callback();
                }
            })
            .catch(error => console.error('加载主播失败:', error));
    }

    function initExportPilotLocalSearch() {
        const input = document.getElementById('pilot_search');
        if (!input || !pilotSelect) return;
        function applyFilter() {
            const keyword = (input.value || '').trim().toLowerCase();
            pilotSelect.innerHTML = '<option value="">请选择主播</option>';
            const source = (window.__exportAllPilots || []);
            const filtered = keyword
                ? source.filter(p => (p.nickname || '').toLowerCase().includes(keyword) || (p.real_name || '').toLowerCase().includes(keyword))
                : source;
            filtered.forEach(pilot => {
                const option = document.createElement('option');
                option.value = pilot.id;
                option.textContent = buildPilotDisplay(pilot);
                option.setAttribute('data-nickname', pilot.nickname || '');
                option.setAttribute('data-real-name', pilot.real_name || '');
                pilotSelect.appendChild(option);
            });
        }
        input.addEventListener('input', applyFilter);
    }

    loadExportPilots();
    initExportPilotLocalSearch();
});
</script>
{% endblock %}
