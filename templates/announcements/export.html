{% extends "base.html" %}

{% block title %}导出通告{% endblock %}

{% block content %}
<section class="announcement-export">
    <div class="page-header">
        <h1 class="page-title">导出通告</h1>
    </div>

    <form id="export-form" 
          class="form-card"
          data-pilots-url="{{ url_for('announcements_api.get_export_pilot_options_api') }}"
          data-view-url-base="{{ url_for('announcement.export_view_page') }}"
          data-csv-url-base="{{ url_for('announcements_api.export_announcements_api') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <div class="form-group">
            <label for="pilot_search">昵称 / 真实姓名 搜索：</label>
            <input type="text" id="pilot_search" class="form-control" placeholder="输入主播昵称或真实姓名进行筛选">
        </div>

        <div class="form-group">
            <label for="pilot_id">选择主播</label>
            <select id="pilot_id" name="pilot_id" class="form-control" required>
                <option value="">正在加载...</option>
            </select>
        </div>

        <div class="form-group">
            <label for="year">选择年月</label>
            <div style="display: flex; gap: 10px;">
                <select id="year" name="year" class="form-control" required>
                    <!-- 年份将由JS填充 -->
                </select>
                <select id="month" name="month" class="form-control" required>
                    <!-- 月份将由JS填充 -->
                </select>
            </div>
        </div>

        <div class="footbar" style="position:static; box-shadow:none; border-top:none; padding:0; margin-top:16px;">
            <div class="inner" style="justify-content:flex-start; gap: 10px;">
                <button type="button" id="export-csv-btn" class="btn btn-primary">导出 CSV</button>
                <button type="button" id="export-view-btn" class="btn btn-info">生成打印视图</button>
                <a class="btn btn-outline" href="{{ url_for('announcement.list_announcements') }}">返回</a>
            </div>
        </div>
    </form>

</section>

<style>
.form-card { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--table-header); }
.form-group { margin-bottom: 16px; }
.form-group label { display: block; margin-bottom: 6px; font-weight: 600; }
.form-control { width: 100%; padding: 8px 10px; border-radius: 4px; border: 1px solid #ccc; }
.btn-info { color: #fff; background-color: #17a2b8; border-color: #17a2b8; }
</style>
{% endblock %}

{% block scripts %}
<script>
console.log('[导出页面] 脚本开始加载');

document.addEventListener('DOMContentLoaded', function() {
    console.log('[导出页面] DOMContentLoaded 事件触发');
    
    const exportForm = document.getElementById('export-form');
    console.log('[导出页面] exportForm:', exportForm);
    
    if (!exportForm) {
        console.error('[导出页面] 找不到 export-form 元素！');
        return;
    }
    
    const pilotsUrl = exportForm.dataset.pilotsUrl;
    const viewUrlBase = exportForm.dataset.viewUrlBase;
    const csvUrlBase = exportForm.dataset.csvUrlBase;
    console.log('[导出页面] API URLs:', { pilotsUrl, viewUrlBase, csvUrlBase });

    const pilotSelect = document.getElementById('pilot_id');
    const pilotSearchInput = document.getElementById('pilot_search');
    const yearSelect = document.getElementById('year');
    const monthSelect = document.getElementById('month');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const exportViewBtn = document.getElementById('export-view-btn');
    
    let allPilots = [];
    
    console.log('[导出页面] DOM元素获取结果:', {
        pilotSelect: pilotSelect ? '✓' : '✗',
        pilotSearchInput: pilotSearchInput ? '✓' : '✗',
        yearSelect: yearSelect ? '✓' : '✗',
        monthSelect: monthSelect ? '✓' : '✗',
        exportCsvBtn: exportCsvBtn ? '✓' : '✗',
        exportViewBtn: exportViewBtn ? '✓' : '✗'
    });

    // 填充年份选项
    console.log('[导出页面] 开始填充年份选项');
    const currentYear = new Date().getFullYear();
    const startYear = 2025;
    const endYear = currentYear + 1;
    for (let i = startYear; i <= endYear; i++) {
        const option = new Option(i + '年', i);
        yearSelect.add(option);
    }
    yearSelect.value = currentYear;
    console.log('[导出页面] 年份选项填充完成，从', startYear, '到', endYear, '，默认选中:', currentYear);

    // 填充月份选项
    console.log('[导出页面] 开始填充月份选项');
    const currentMonth = new Date().getMonth() + 1;
    for (let i = 1; i <= 12; i++) {
        const option = new Option(i + '月', i);
        monthSelect.add(option);
    }
    monthSelect.value = currentMonth;
    console.log('[导出页面] 月份选项填充完成，共', monthSelect.options.length, '项，当前选中:', currentMonth);

    // 构建主播显示名称
    function buildPilotDisplay(pilot) {
        const nickname = pilot.nickname || '';
        const realName = pilot.real_name ? ` (${pilot.real_name})` : '';
        const owner = pilot.owner ? ` [${pilot.owner}]` : '';
        return `${nickname}${realName}${owner}`;
    }

    // 填充主播下拉框
    function populatePilotSelect(pilots) {
        pilotSelect.innerHTML = '<option value="">请选择主播</option>';
        pilots.forEach(pilot => {
            const option = document.createElement('option');
            option.value = pilot.id;
            option.textContent = buildPilotDisplay(pilot);
            pilotSelect.appendChild(option);
        });
    }

    // 初始化主播搜索功能
    function initPilotSearch() {
        if (!pilotSearchInput) return;
        
        pilotSearchInput.addEventListener('input', () => {
            const keyword = (pilotSearchInput.value || '').trim().toLowerCase();
            const filtered = keyword ? allPilots.filter(p => {
                return (p.nickname || '').toLowerCase().includes(keyword) || 
                       (p.real_name || '').toLowerCase().includes(keyword);
            }) : allPilots;
            
            populatePilotSelect(filtered);
        });
    }

    // 获取并填充主播选项
    console.log('[导出页面] 开始获取主播列表，URL:', pilotsUrl);
    fetch(pilotsUrl)
        .then(response => {
            console.log('[导出页面] API响应状态:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('[导出页面] API返回数据:', data);
            if (data.success) {
                allPilots = data.data.pilots || [];
                console.log('[导出页面] 主播数量:', allPilots.length);
                
                populatePilotSelect(allPilots);
                initPilotSearch();
                
                console.log('[导出页面] 主播列表填充完成，总选项数:', pilotSelect.options.length);

            } else {
                console.error('[导出页面] API返回错误状态:', data);
                pilotSelect.innerHTML = '<option value="">加载失败</option>';
                const errorMsg = data.error?.message || '加载主播列表失败';
                showMessage(errorMsg, 'error');
            }
        })
        .catch(error => {
            console.error('[导出页面] 获取主播列表出错:', error);
            pilotSelect.innerHTML = '<option value="">加载出错</option>';
            showMessage('加载主播列表时出错', 'error');
        });

    function getSelectedValues() {
        const pilotId = pilotSelect.value;
        const year = yearSelect.value;
        const month = monthSelect.value;

        if (!pilotId) {
            showMessage('请选择一个主播', 'warning');
            return null;
        }
        return { pilotId, year, month };
    }

    // 处理CSV导出
    exportCsvBtn.addEventListener('click', function() {
        console.log('[导出页面] CSV导出按钮被点击');
        const values = getSelectedValues();
        if (!values) return;

        const exportUrl = `${csvUrlBase}?pilot_id=${values.pilotId}&year=${values.year}&month=${values.month}`;
        console.log('[导出页面] CSV导出URL:', exportUrl);
        window.location.href = exportUrl;
    });

    // 处理打印视图
    exportViewBtn.addEventListener('click', function() {
        console.log('[导出页面] 打印视图按钮被点击');
        const values = getSelectedValues();
        if (!values) return;

        const viewUrl = `${viewUrlBase}?pilot_id=${values.pilotId}&year=${values.year}&month=${values.month}`;
        console.log('[导出页面] 打印视图URL:', viewUrl);
        window.open(viewUrl, '_blank');
    });
    
    console.log('[导出页面] 所有事件监听器已注册');
});

console.log('[导出页面] 脚本加载完成');
</script>
{% endblock %}