{% extends 'base.html' %}
{% block title %}å¼€æ’­åœ°ç‚¹ç®¡ç† - Lacus-Log{% endblock %}
{% block content %}
<section class="area-management">
  <div class="page-header">
    <h1 class="page-title">å¼€æ’­åœ°ç‚¹ç®¡ç†</h1>
  </div>

  <div class="filter-bar">
    <button type="button" class="filter-toggle" onclick="toggleFilters()">
      <span id="filter-summary">å…¨éƒ¨æ˜¾ç¤º</span>
      <span class="toggle-icon" id="filter-toggle-icon">â–¼</span>
    </button>

    <div class="filter-form is-collapsed" id="filter-form">
      <div class="filter-group">
        <label class="filter-label">åŸºåœ°</label>
        <select class="filter-select" id="filter-x">
          <option value="">å…¨éƒ¨åŸºåœ°</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">åœºåœ°</label>
        <select class="filter-select" id="filter-y">
          <option value="">å…¨éƒ¨åœºåœ°</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">å¯ç”¨æ€§</label>
        <select class="filter-select" id="filter-availability">
          <option value="">å…¨éƒ¨å¯ç”¨æ€§</option>
        </select>
      </div>
    </div>
  </div>

  <div class="area-list">
    <div id="loading-state" class="loading-state">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>
    <div id="area-cards-container" class="area-cards" style="display: none;"></div>
    <div id="empty-state" class="empty-state" style="display: none;">
      <div class="empty-icon">ğŸ›°ï¸</div>
      <div class="empty-title">æš‚æ— æˆ˜æ–—åŒºåŸŸ</div>
      <div class="empty-description">ç‚¹å‡»ä¸‹æ–¹â€œæ–°å»ºå¼€æ’­åœ°ç‚¹â€åˆ›å»ºç¬¬ä¸€ä¸ªåŒºåŸŸ</div>
    </div>
  </div>
</section>

<div class="footbar">
  <div class="inner">
    <a class="btn btn-primary" href="{{ url_for('battle_area.new_area') }}">
      <span class="btn-icon">+</span>
      æ–°å»ºå¼€æ’­åœ°ç‚¹
    </a>
  </div>
</div>

<style>

.area-cards { display: block; }
.area-card {
  display: block;
  background: #fff;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
  text-decoration: none;
  color: inherit;
  transition: all 0.2s ease;
  cursor: pointer;
}
.area-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); border-color: var(--brand); }
.area-card .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
.area-info { flex: 1; }
.area-name { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.area-sub { font-size: 12px; color: var(--muted); }
.area-card .card-footer { display: flex; align-items: center; justify-content: space-between; border-top: 1px solid var(--table-header); padding-top: 8px; }
.meta-inline { display: flex; gap: 10px; font-size: 12px; color: var(--muted); }
.availability-å¯ç”¨ { color: var(--green); }
.availability-ç¦ç”¨ { color: var(--error); }


.filter-toggle {
  width: 100%; display: flex; align-items: center; justify-content: space-between;
  background: var(--brand); color: #fff; border: none; border-radius: 8px;
  padding: 12px 14px; margin-bottom: 10px; font-size: 14px;
}
.filter-form.is-collapsed { display: none; }
.filter-form { margin-bottom: 12px; }

.footbar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid var(--table-header); box-shadow: 0 -2px 8px rgba(0,0,0,0.06); padding: 10px 12px calc(env(safe-area-inset-bottom, 0) + 10px) 12px; z-index: 1; }
.footbar .inner { display: flex; justify-content: center; }
.container { padding-bottom: 88px; }

@media (max-width: 768px) {
  .filter-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
}
</style>
<script>
let filterOptions = { x_choices: [], y_choices: [], availability_choices: [] };
let currentFilters = { x: '', y: '', availability: '' };
let suppressFilterChange = false;

function toggleFilters() {
  const form = document.getElementById('filter-form');
  const icon = document.getElementById('filter-toggle-icon');
  const collapsed = form.classList.toggle('is-collapsed');
  icon.textContent = collapsed ? 'â–¼' : 'â–²';
}

function showLoading(isLoading) {
  document.getElementById('loading-state').style.display = isLoading ? 'block' : 'none';
  document.getElementById('area-cards-container').style.display = isLoading ? 'none' : 'block';
  document.getElementById('empty-state').style.display = 'none';
}

function updateFilterSummary() {
  const summary = [];
  if (currentFilters.x) summary.push(currentFilters.x);
  if (currentFilters.y) summary.push(currentFilters.y);
  if (currentFilters.availability) summary.push(currentFilters.availability);
  document.getElementById('filter-summary').textContent = summary.length ? summary.join(' + ') : 'å…¨éƒ¨æ˜¾ç¤º';
}

function populateSelect(selectEl, choices, currentValue, placeholderText) {
  const previousValue = currentValue || '';
  const placeholderOption = document.createElement('option');
  placeholderOption.value = '';
  placeholderOption.textContent = placeholderText;

  selectEl.innerHTML = '';
  selectEl.appendChild(placeholderOption);

  choices.forEach(choice => {
    const option = document.createElement('option');
    option.value = choice;
    option.textContent = choice;
    selectEl.appendChild(option);
  });

  selectEl.value = previousValue;
}

function populateFilters() {
  suppressFilterChange = true;
  const xSelect = document.getElementById('filter-x');
  const ySelect = document.getElementById('filter-y');
  const availabilitySelect = document.getElementById('filter-availability');

  populateSelect(xSelect, filterOptions.x_choices, currentFilters.x, 'å…¨éƒ¨åŸºåœ°');
  populateSelect(ySelect, filterOptions.y_choices, currentFilters.y, 'å…¨éƒ¨åœºåœ°');
  populateSelect(availabilitySelect, filterOptions.availability_choices, currentFilters.availability, 'å…¨éƒ¨å¯ç”¨æ€§');

  suppressFilterChange = false;
}

function renderAreaList(items) {
  const container = document.getElementById('area-cards-container');
  container.innerHTML = '';

  if (!items || items.length === 0) {
    container.style.display = 'none';
    const empty = document.getElementById('empty-state');
    empty.style.display = 'block';
    return;
  }

  container.style.display = 'block';
  document.getElementById('empty-state').style.display = 'none';

  items.forEach(item => {
    const card = document.createElement('a');
    card.className = 'area-card';
    card.href = `/areas/${item.id}`;

    card.innerHTML = `
      <div class="card-header">
        <div class="area-info">
          <div class="area-name">${item.x_coord} - ${item.y_coord}</div>
          <div class="area-sub">åº§ä½ï¼š${item.z_coord}</div>
        </div>
        <div class="area-meta">
          <div class="badges">
            <span class="availability-badge availability-${item.availability}">${item.availability}</span>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <div class="meta-inline">
          <span class="muted">X: ${item.x_coord}</span>
          <span class="muted">Y: ${item.y_coord}</span>
          <span class="muted">Z: ${item.z_coord}</span>
        </div>
        <div class="card-arrow">â†’</div>
      </div>
    `;

    container.appendChild(card);
  });
}

async function loadAreas({ useCurrentFilters } = { useCurrentFilters: false }) {
  try {
    showLoading(true);
    let query = '';
    if (useCurrentFilters) {
      const params = new URLSearchParams();
      params.append('x', currentFilters.x || '');
      params.append('y', currentFilters.y || '');
      params.append('availability', currentFilters.availability || '');
      query = params.toString();
    }

    const response = await fetch(`/api/battle-areas${query ? `?${query}` : ''}`);
    const result = await response.json();

    if (!result.success) {
      throw new Error(result.error?.message || 'åŠ è½½å¼€æ’­åœ°ç‚¹åˆ—è¡¨å¤±è´¥');
    }

    filterOptions = result.meta?.options || filterOptions;
    currentFilters = {
      x: result.meta?.filters?.x || '',
      y: result.meta?.filters?.y || '',
      availability: result.meta?.filters?.availability || '',
    };

    populateFilters();
    updateFilterSummary();
    renderAreaList(result.data?.items || []);
  } catch (error) {
    console.error('åŠ è½½å¼€æ’­åœ°ç‚¹åˆ—è¡¨å¤±è´¥:', error);
    showMessage(error.message || 'åŠ è½½å¼€æ’­åœ°ç‚¹åˆ—è¡¨å¤±è´¥', 'error');
    document.getElementById('area-cards-container').style.display = 'none';
    const empty = document.getElementById('empty-state');
    empty.style.display = 'block';
    empty.querySelector('.empty-title').textContent = 'åŠ è½½å¤±è´¥';
    empty.querySelector('.empty-description').textContent = 'è¯·åˆ·æ–°é¡µé¢é‡è¯•';
  } finally {
    showLoading(false);
  }
}

function bindFilterEvents() {
  const xSelect = document.getElementById('filter-x');
  const ySelect = document.getElementById('filter-y');
  const availabilitySelect = document.getElementById('filter-availability');

  xSelect.addEventListener('change', () => {
    if (suppressFilterChange) return;
    currentFilters.x = xSelect.value;
    if (!currentFilters.x) {
      currentFilters.y = '';
    }
    loadAreas({ useCurrentFilters: true });
  });

  ySelect.addEventListener('change', () => {
    if (suppressFilterChange) return;
    currentFilters.y = ySelect.value;
    loadAreas({ useCurrentFilters: true });
  });

  availabilitySelect.addEventListener('change', () => {
    if (suppressFilterChange) return;
    currentFilters.availability = availabilitySelect.value;
    loadAreas({ useCurrentFilters: true });
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('filter-form');
  const icon = document.getElementById('filter-toggle-icon');
  if (!form.classList.contains('is-collapsed')) form.classList.add('is-collapsed');
  icon.textContent = 'â–¼';

  bindFilterEvents();
  loadAreas();
});
</script>
{% endblock %}
