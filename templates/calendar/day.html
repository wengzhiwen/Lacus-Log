{% extends 'base.html' %}
{% block title %}日视图 - 通告日历{% endblock %}
{% block content %}
<section class="calendar-container">
  <div class="calendar-header">
    <h1 class="page-title">通告日历</h1>
    <div class="view-controls">
      <a href="{{ url_for('calendar.month_view') }}" class="btn btn-sm">月视图</a>
      <a href="{{ url_for('calendar.week_view') }}" class="btn btn-sm">周视图</a>
      <a href="{{ url_for('calendar.day_view') }}" class="btn btn-sm btn-primary">日视图</a>
    </div>
  </div>

  <div class="day-navigation">
    <button id="prevDay" class="btn btn-sm">‹ 前一天</button>
    <h2 id="currentDay" class="day-title"></h2>
    <button id="nextDay" class="btn btn-sm">后一天 ›</button>
  </div>

  <div class="day-calendar">
    <div class="time-header-row">
      <div class="area-header">开播地点</div>
      <div class="time-header-scroll">
        <div class="time-slots">
          <div class="time-slot">0</div>
          <div class="time-slot">1</div>
          <div class="time-slot">2</div>
          <div class="time-slot">3</div>
          <div class="time-slot">4</div>
          <div class="time-slot">5</div>
          <div class="time-slot">6</div>
          <div class="time-slot">7</div>
          <div class="time-slot">8</div>
          <div class="time-slot">9</div>
          <div class="time-slot">10</div>
          <div class="time-slot">11</div>
          <div class="time-slot">12</div>
          <div class="time-slot">13</div>
          <div class="time-slot">14</div>
          <div class="time-slot">15</div>
          <div class="time-slot">16</div>
          <div class="time-slot">17</div>
          <div class="time-slot">18</div>
          <div class="time-slot">19</div>
          <div class="time-slot">20</div>
          <div class="time-slot">21</div>
          <div class="time-slot">22</div>
          <div class="time-slot">23</div>
        </div>
      </div>
    </div>
    
    <div id="dataRows" class="data-rows">
    </div>
  </div>

  <div class="loading" id="loading" style="display: none;">
    <div class="loading-spinner"></div>
    <span>加载中...</span>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  let currentDateStr = urlParams.get('date') || new Date().toISOString().split('T')[0];
  let currentDate = new Date(currentDateStr + 'T00:00:00');
  
  const dayTitleEl = document.getElementById('currentDay');
  const dataRowsEl = document.getElementById('dataRows');
  const loadingEl = document.getElementById('loading');

  function formatDate(date) {
    return date.getFullYear() + '-' + 
           String(date.getMonth() + 1).padStart(2, '0') + '-' + 
           String(date.getDate()).padStart(2, '0');
  }

  function formatDateDisplay(date) {
    const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
    const weekday = weekdays[date.getDay()];
    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 (周${weekday})`;
  }

  function updateDayTitle() {
    dayTitleEl.textContent = formatDateDisplay(currentDate);
  }

  function loadDayData() {
    loadingEl.style.display = 'flex';
    
    const dateStr = formatDate(currentDate);
    
    fetch(`{{ url_for('calendar_api.day_data') }}?date=${dateStr}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        renderDay(data);
      })
      .catch(error => {
        console.error('加载日视图数据失败:', error);
        alert('加载数据失败，请重试');
      })
      .finally(() => {
        loadingEl.style.display = 'none';
      });
  }

  function renderDay(data) {
    dataRowsEl.innerHTML = '';

    if (!data.area_timelines || Object.keys(data.area_timelines).length === 0) {
      dataRowsEl.innerHTML = '<div class="no-data">当日暂无通告安排</div>';
      return;
    }

    const sortedAreas = Object.keys(data.area_timelines).sort((a, b) => {
      const [x1, y1, z1] = a.split('-');
      const [x2, y2, z2] = b.split('-');
      
      if (x1 !== x2) return x1.localeCompare(x2);
      if (y1 !== y2) return y1.localeCompare(y2);
      
      const z1Num = parseFloat(z1);
      const z2Num = parseFloat(z2);
      
      if (!isNaN(z1Num) && !isNaN(z2Num)) {
        return z1Num - z2Num;
      }
      
      return z1.localeCompare(z2);
    });
    
    sortedAreas.forEach(areaKey => {
      const timeline = data.area_timelines[areaKey];
      
      const rowEl = document.createElement('div');
      rowEl.className = 'data-row';
      
      const areaLabelEl = document.createElement('div');
      areaLabelEl.className = 'area-cell';
      areaLabelEl.textContent = timeline.area_display;
      rowEl.appendChild(areaLabelEl);
      
      const contentScrollEl = document.createElement('div');
      contentScrollEl.className = 'content-scroll';
      
      const timelineEl = document.createElement('div');
      timelineEl.className = 'timeline-grid';
      
      timeline.slots.forEach(slotData => {
        const slotEl = document.createElement('div');
        slotEl.className = 'time-slot-item occupied';
        
        if (slotData.is_own) {
          slotEl.classList.add('own-slot');
        }
        
        slotEl.style.gridColumnStart = slotData.start_hour + 1;
        slotEl.style.gridColumnEnd = slotData.end_hour + 2;
        
        slotEl.innerHTML = `
          <div class="slot-content" data-announcement-id="${slotData.id}">
            <div class="time-info">${slotData.start_time}-${slotData.end_time}</div>
            <div class="pilot-info">${slotData.pilot_display}</div>
          </div>
        `;
        
        slotEl.addEventListener('click', function() {
          const currentDate = new URLSearchParams(window.location.search).get('date') || formatDate(new Date());
          window.location.href = `{{ url_for('announcement.announcement_detail', announcement_id='PLACEHOLDER') }}?from=calendar&date=${currentDate}`.replace('PLACEHOLDER', slotData.id);
        });
        
        timelineEl.appendChild(slotEl);
      });
      
      contentScrollEl.appendChild(timelineEl);
      rowEl.appendChild(contentScrollEl);
      dataRowsEl.appendChild(rowEl);
    });
    
    setupScrollSync();
  }

  function navigateDay(offset) {
    currentDate.setDate(currentDate.getDate() + offset);
    currentDateStr = formatDate(currentDate);
    
    const url = new URL(window.location);
    url.searchParams.set('date', currentDateStr);
    window.history.replaceState({}, '', url);
    
    updateDayTitle();
    loadDayData();
  }

  document.getElementById('prevDay').addEventListener('click', function() {
    navigateDay(-1);
  });

  document.getElementById('nextDay').addEventListener('click', function() {
    navigateDay(1);
  });

  function setupScrollSync() {
    const timeHeaderScroll = document.querySelector('.time-header-scroll');
    const contentScrolls = document.querySelectorAll('.content-scroll');
    
    if (!timeHeaderScroll || contentScrolls.length === 0) return;
    
    let isScrolling = false;
    
    timeHeaderScroll.addEventListener('scroll', function() {
      if (isScrolling) return;
      isScrolling = true;
      const scrollLeft = this.scrollLeft;
      contentScrolls.forEach(content => {
        content.scrollLeft = scrollLeft;
      });
      setTimeout(() => { isScrolling = false; }, 10);
    });
    
    contentScrolls.forEach(contentScroll => {
      contentScroll.addEventListener('scroll', function() {
        if (isScrolling) return;
        isScrolling = true;
        const scrollLeft = this.scrollLeft;
        timeHeaderScroll.scrollLeft = scrollLeft;
        contentScrolls.forEach(otherContent => {
          if (otherContent !== this) {
            otherContent.scrollLeft = scrollLeft;
          }
        });
        setTimeout(() => { isScrolling = false; }, 10);
      });
    });
  }

  updateDayTitle();
  loadDayData();
});
</script>
{% endblock %}
