{% extends "base.html" %}

{% block title %}å¼€æ’­æ—¥æŠ¥ - {{ pagination.date }}{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">ğŸ“’ å¼€æ’­æ—¥æŠ¥</h1>
</div>

<div class="date-navigation">
  <div class="date-controls">
    <a href="{{ url_for('report.daily_report', date=pagination.prev_date, owner=selected_owner, mode=selected_mode) }}" class="btn btn-secondary btn-sm">â† å‰ä¸€æ—¥</a>
    <input type="date" id="dateSelector" value="{{ pagination.date }}" class="date-input">
    <a href="{{ url_for('report.daily_report', date=pagination.next_date, owner=selected_owner, mode=selected_mode) }}" class="btn btn-secondary btn-sm">åä¸€æ—¥ â†’</a>
  </div>
  <div class="export-actions">
    <a href="{{ url_for('report.export_daily_csv', date=pagination.date, owner=selected_owner, mode=selected_mode) }}" class="btn btn-warning btn-sm">ğŸ“¥ å¯¼å‡ºCSV</a>
  </div>
</div>

<div class="filter-section">
  <div class="filter-controls">
    <label for="ownerSelector" class="filter-label">ç›´å±è¿è¥ï¼š</label>
    <select id="ownerSelector" class="filter-select">
      <option value="all" {% if selected_owner == 'all' %}selected{% endif %}>å…¨éƒ¨</option>
      {% for owner in owners %}
      <option value="{{ owner.id }}" {% if selected_owner == owner.id|string %}selected{% endif %}>
        {{ owner.nickname or owner.username }}
      </option>
      {% endfor %}
    </select>

    <label for="modeSelector" class="filter-label">å¼€æ’­æ–¹å¼ï¼š</label>
    <select id="modeSelector" class="filter-select">
      <option value="all" {% if selected_mode == 'all' %}selected{% endif %}>å…¨éƒ¨</option>
      <option value="online" {% if selected_mode == 'online' %}selected{% endif %}>çº¿ä¸Š</option>
      <option value="offline" {% if selected_mode == 'offline' %}selected{% endif %}>çº¿ä¸‹</option>
    </select>
  </div>
</div>

<!-- æœˆåº¦æ•°æ®å·²ä»æ—¥æŠ¥é¡µé¢ç§»é™¤ï¼Œèšç„¦æ—¥ç»´åº¦å±•ç¤º -->

<div class="summary-section">
  <h2 class="section-title">{{ pagination.date }} æ—¥æŠ¥æ±‡æ€»</h2>
  <div class="summary-cards epic-intro" data-animate-group="day">
    <div class="summary-card">
      <div class="card-label">æ€»ä¸»æ’­æ•°é‡</div>
      <div class="card-value">{{ day_summary.pilot_count }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">æœ‰æ•ˆä¸»æ’­æ•°é‡</div>
      <div class="card-value">{{ day_summary.effective_pilot_count }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡æµæ°´</div>
      <div class="card-value">Â¥{{ "{:,.2f}".format(day_summary.revenue_sum) }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡åº•è–ªæ”¯å‡º</div>
      <div class="card-value">Â¥{{ "{:,.2f}".format(day_summary.basepay_sum) }}</div>
      {% if day_summary.conversion_rate is not none %}
      <div class="card-sub">è½¬æ¢ç‡{{ day_summary.conversion_rate }}%</div>
      {% endif %}
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡ä¸»æ’­åˆ†æˆ</div>
      <div class="card-value">Â¥{{ "{:,.2f}".format(day_summary.pilot_share_sum) }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡å…¬å¸åˆ†æˆ</div>
      <div class="card-value">Â¥{{ "{:,.2f}".format(day_summary.company_share_sum) }}</div>
    </div>
    {% set today_profit_no_rebate = (day_summary.company_share_sum or 0) - (day_summary.basepay_sum or 0) %}
    <div class="summary-card {% if today_profit_no_rebate < 0 %}danger-outline{% endif %}">
      <div class="card-label">ä»Šæ—¥ç›ˆäºï¼ˆä¸è®¡è¿”ç‚¹ï¼‰</div>
      <div class="card-value">Â¥{{ "{:,.2f}".format(today_profit_no_rebate) }}</div>
    </div>
  </div>
</div>

<div class="details-section">
  <h2 class="section-title">æ—¥æŠ¥æ˜ç»†</h2>
  {% if details %}
  <div class="table-container">
    <table class="report-table">
      <thead>
        <tr>
          <th class="fixed-col">ä¸»æ’­</th>
          <th>æ€§åˆ«å¹´é¾„</th>
          <th>ç›´å±è¿è¥</th>
          <th>ä¸»æ’­åˆ†ç±»</th>
          <th>å¼€æ’­åœ°ç‚¹</th>
          <th>æ’­æ—¶</th>
          <th>æµæ°´</th>
          <th>å½“å‰åˆ†æˆæ¯”ä¾‹</th>
          <th>ä¸»æ’­åˆ†æˆ</th>
          <th>å…¬å¸åˆ†æˆ</th>
          <th>è¿”ç‚¹æ¯”ä¾‹</th>
          <th>äº§ç”Ÿè¿”ç‚¹</th>
          <th>åº•è–ª</th>
          <th>å½“æ—¥æ¯›åˆ©</th>
          <th>3æ—¥å¹³å‡æµæ°´</th>
        </tr>
      </thead>
      <tbody>
        {% for detail in details %}
        <tr>
          <td class="fixed-col">
            <a href="{{ url_for('pilot.pilot_performance', pilot_id=detail.pilot_id, from='daily_report', date=pagination.date, owner=selected_owner) }}" class="pilot-link">
              {{ detail.pilot_display }}
            </a>
          </td>
          <td>{{ detail.gender_age }}</td>
          <td>{{ detail.owner }}</td>
          <td>{{ detail.rank | normalize_rank }}</td>
          <td>{{ detail.battle_area }}</td>
          <td>{{ "%.1f"|format(detail.duration) if detail.duration else "0.0" }}å°æ—¶</td>
          <td>Â¥{{ "{:,.2f}".format(detail.revenue) }}</td>
          <td>{{ "%.0f"|format(detail.commission_rate) }}%</td>
          <td>Â¥{{ "{:,.2f}".format(detail.pilot_share) }}</td>
          <td>Â¥{{ "{:,.2f}".format(detail.company_share) }}</td>
          <td>{{ "%.0f"|format(detail.rebate_rate * 100) }}%</td>
          <td>Â¥{{ "{:,.2f}".format(detail.rebate_amount) }}</td>
          <td>Â¥{{ "{:,.2f}".format(detail.base_salary) }}</td>
          <td class="{% if detail.daily_profit < 0 %}text-danger{% endif %}">Â¥{{ "{:,.2f}".format(detail.daily_profit) }}</td>
          <td>{% if detail.three_day_avg_revenue %}Â¥{{ "{:,.2f}".format(detail.three_day_avg_revenue) }}{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <p>ä»Šæ—¥æš‚æ— å¼€æ’­è®°å½•</p>
  </div>
  {% endif %}
</div>

<style>

.date-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0;
  padding: 16px;
  background: var(--table-header);
  border-radius: 8px;
}

.date-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.date-input {
  padding: 8px 12px;
  border: 1px solid var(--gray);
  border-radius: 6px;
  font-size: 14px;
}

.export-actions {
  display: flex;
  gap: 8px;
}


.filter-section {
  margin: 16px 0;
  padding: 12px 16px;
  background: #f8f9fa;
  border-radius: 6px;
  border: 1px solid #e9ecef;
}

.filter-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  margin: 0;
}

.filter-select {
  padding: 6px 12px;
  border: 1px solid var(--gray);
  border-radius: 4px;
  font-size: 14px;
  background: #fff;
  min-width: 120px;
}


.summary-section {
  margin: 24px 0;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

/* â€”â€” æˆå‰§åŒ–â€œå‰æ–¹é£å…¥â€åŠ¨ç”» â€”â€” */
.epic-intro {
  perspective: 1000px;
  perspective-origin: 50% 40%;
}

.epic-intro .summary-card {
  transform: translateZ(240px) translateY(30px) scale(0.85) rotateX(-12deg);
  opacity: 0;
  will-change: transform, opacity;
}

.epic-intro.play .summary-card {
  animation: epicFlyIn 900ms cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

.epic-intro.play .summary-card:nth-child(1) { animation-delay: 0ms; }
.epic-intro.play .summary-card:nth-child(2) { animation-delay: 90ms; }
.epic-intro.play .summary-card:nth-child(3) { animation-delay: 180ms; }
.epic-intro.play .summary-card:nth-child(4) { animation-delay: 270ms; }
.epic-intro.play .summary-card:nth-child(5) { animation-delay: 360ms; }
.epic-intro.play .summary-card:nth-child(6) { animation-delay: 450ms; }
.epic-intro.play .summary-card:nth-child(7) { animation-delay: 540ms; }
.epic-intro.play .summary-card:nth-child(8) { animation-delay: 630ms; }

@keyframes epicFlyIn {
  0%   { transform: translateZ(240px) translateY(30px) scale(0.85) rotateX(-12deg); opacity: 0; }
  60%  { transform: translateZ(-20px) translateY(-6px) scale(1.02) rotateX(2deg); opacity: 1; }
  85%  { transform: translateZ(10px) translateY(0px) scale(0.995) rotateX(0deg); opacity: 1; }
  100% { transform: translateZ(0) translateY(0) scale(1) rotateX(0); opacity: 1; }
}

.summary-card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  transition: box-shadow 0.2s ease;
}

.summary-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* è´Ÿæ•°è­¦ç¤ºè¾¹æ¡† */
.summary-card.danger-outline {
  border-color: #dc3545;
}

.card-label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}

.card-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--brand);
}

.card-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}


.details-section {
  margin: 24px 0;
}

.table-container {
  overflow-x: auto;
  border: 1px solid var(--gray);
  border-radius: 8px;
  background: #fff;
}

.report-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 2000px;
}

.report-table th,
.report-table td {
  padding: 12px 8px;
  text-align: left;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

.report-table th {
  background: var(--table-header);
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 2;
}

.report-table th.fixed-col,
.report-table td.fixed-col {
  position: sticky;
  left: 0;
  background: #fff; 
  background-clip: padding-box;
  min-width: 120px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}


.report-table td.fixed-col { z-index: 4; }
.report-table th.fixed-col { z-index: 5; }


.report-table td.fixed-col { box-shadow: 2px 0 0 #eee; }
.report-table th.fixed-col { box-shadow: 2px 0 0 #ddd; }

.report-table tbody tr:hover {
  background: #f8f9fa;
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}


.pilot-link {
  color: var(--brand);
  text-decoration: none;
  font-weight: 600;
}

.pilot-link:hover {
  color: var(--brand-dark);
  text-decoration: underline;
}


.text-danger {
  color: #dc3545 !important;
  font-weight: 600;
}


@media (max-width: 768px) {
  .date-navigation {
    flex-direction: column;
    gap: 12px;
  }

  .filter-controls {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .filter-select {
    width: 100%;
    min-width: auto;
  }

  .summary-cards {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }

  .summary-card {
    padding: 12px;
  }

  .card-value {
    font-size: 20px;
  }

  .report-table {
    font-size: 12px;
  }

  .report-table th,
  .report-table td {
    padding: 8px 6px;
  }
}
</style>

<script>
document.getElementById('dateSelector').addEventListener('change', function() {
  const selectedDate = this.value;
  const selectedOwner = document.getElementById('ownerSelector').value;
  const selectedMode = document.getElementById('modeSelector').value;
  if (selectedDate) {
    let url = '{{ url_for("report.daily_report") }}?date=' + selectedDate;
    if (selectedOwner && selectedOwner !== 'all') {
      url += '&owner=' + selectedOwner;
    }
    if (selectedMode && selectedMode !== 'all') {
      url += '&mode=' + selectedMode;
    }
    window.location.href = url;
  }
});

document.getElementById('ownerSelector').addEventListener('change', function() {
  const selectedOwner = this.value;
  const selectedDate = document.getElementById('dateSelector').value;
  const selectedMode = document.getElementById('modeSelector').value;
  let url = '{{ url_for("report.daily_report") }}?date=' + selectedDate;
  if (selectedOwner && selectedOwner !== 'all') {
    url += '&owner=' + selectedOwner;
  }
  if (selectedMode && selectedMode !== 'all') {
    url += '&mode=' + selectedMode;
  }
  window.location.href = url;
});

document.getElementById('modeSelector').addEventListener('change', function() {
  const selectedMode = this.value;
  const selectedOwner = document.getElementById('ownerSelector').value;
  const selectedDate = document.getElementById('dateSelector').value;
  let url = '{{ url_for("report.daily_report") }}?date=' + selectedDate;
  if (selectedOwner && selectedOwner !== 'all') {
    url += '&owner=' + selectedOwner;
  }
  if (selectedMode && selectedMode !== 'all') {
    url += '&mode=' + selectedMode;
  }
  window.location.href = url;
});

// é¡µé¢åŠ è½½åè§¦å‘å²è¯—å…¥åœºåŠ¨ç”»
window.addEventListener('load', function() {
  var groups = document.querySelectorAll('.epic-intro');
  groups.forEach(function(g) {
    // ä½¿ç”¨å¾®å°å»¶æ—¶ä¿è¯æ¸²æŸ“å®Œæˆåå†åŠ classï¼Œé¿å…åˆå§‹çŠ¶æ€é—ªçƒ
    setTimeout(function(){ g.classList.add('play'); }, 50);
  });
});
</script>
{% endblock %}
