# 主播-结算管理 实现指南

> 本文档记录主播结算管理功能的实现进度和技术细节

## 📋 实现进度

### ✅ 已完成（第一阶段）

#### 数据模型
- **Settlement** (`models/pilot.py`)
  - 主播结算方式记录
  - 字段：pilot_id, effective_date (UTC), settlement_type (enum), remark, is_active, created_at, updated_at
  - 支持三种结算方式：daily_base (日结)、monthly_base (月结)、none (无底薪)
  - 包含验证逻辑：同一主播同一生效日期仅允许一条有效记录

- **SettlementChangeLog** (`models/pilot.py`)
  - 结算方式变更日志
  - 字段：settlement_id, user_id, field_name, old_value, new_value, change_time, ip_address

- **BaseSalaryApplication** (`models/battle_record.py`)
  - 底薪申请记录
  - 字段：pilot_id, battle_record_id, settlement_type (快照), base_salary_amount, applicant_id, status, created_at, updated_at
  - 支持三种状态：pending (未处理)、approved (已发放)、rejected (拒绝发放)

- **BaseSalaryApplicationChangeLog** (`models/battle_record.py`)
  - 底薪申请变更日志
  - 字段：application_id, user_id, field_name, old_value, new_value, remark, change_time, ip_address

#### REST API 接口
- **settlers_api.py** (`routes/settlements_api.py`)
  ```
  GET    /api/settlements/<pilot_id>                    - 获取主播结算方式列表及当前生效信息
  POST   /api/settlements/<pilot_id>                    - 创建新的结算方式记录
  PUT    /api/settlements/<record_id>                   - 更新结算方式记录
  DELETE /api/settlements/<record_id>                   - 软删除结算方式记录
  GET    /api/settlements/<pilot_id>/effective?date=    - 查询指定日期的生效结算方式
  GET    /api/settlements/<record_id>/changes           - 获取变更日志
  ```

- **base_salary_applications_api.py** (`routes/base_salary_applications_api.py`)
  ```
  GET    /api/base-salary-applications                  - 获取底薪申请列表（支持日期筛选）
  POST   /api/base-salary-applications                  - 创建新的底薪申请
  GET    /api/base-salary-applications/<app_id>        - 获取单个申请详情
  PATCH  /api/base-salary-applications/<app_id>/status - 更新申请状态
  GET    /api/base-salary-applications/<app_id>/changes - 获取变更日志
  GET    /api/base-salary-applications/export?date=    - 导出为CSV
  ```

#### 序列化工具
- **settlement_serializers.py** - 结算方式序列化
- **base_salary_application_serializers.py** - 底薪申请序列化
- 均包含统一的响应格式函数

#### 前端页面
- **pilots/settlement/index.html** - 结算管理首页
  - 显示当前生效结算方式信息
  - 列表展示结算方式记录（支持编辑、查看变更、删除/恢复）
  - 分页、模态框加载变更记录

- **pilots/settlement/new.html** - 新增结算方式表单
  - 生效日期自由选择
  - 结算方式选择（下拉）
  - 备注文本域（200字符限制）
  - 前端验证和后端错误处理

#### 路由处理
- **routes/pilot.py** 新增路由
  - `GET /pilots/<pilot_id>/settlement/` - 结算管理首页
  - `GET /pilots/<pilot_id>/settlement/new` - 新增页面
  - `GET /pilots/<pilot_id>/settlement/<record_id>/edit` - 编辑页面

#### 应用集成
- 在 `app.py` 中已注册两个蓝图：`settlements_api_bp` 和 `base_salary_applications_api_bp`

---

### ⏳ 待完成

#### 第二阶段

**编辑结算方式页面** (`pilots/settlement/edit.html`)
- 表单字段：结算方式（可编辑）、备注（可编辑）、状态开关（有效/无效）
- 前端逻辑：通过PUT请求更新API
- 验证：同生效日期不能重复

**开播记录详情页集成**
```html
<!-- 在收益信息卡片下方新增结算方式卡片 -->
<div class="settlement-info-card">
  <div class="settlement-type">{{settlement_type_display}}</div>
  <div class="effective-date">生效日期: {{effective_date}}</div>
  
  <!-- 当settlement_type为daily_base时显示 -->
  {% if settlement_type == 'daily_base' %}
    <button onclick="openBaseSalaryApplication()">申请底薪</button>
    {% if has_pending_application %}
      <div class="warning">已存在底薪申请</div>
    {% endif %}
  {% endif %}
</div>
```

**底薪申请表单页面** (`battle_records/base-salary-application.html`)
- 入口：开播记录详情页"申请底薪"按钮
- 显示主播信息、开播记录概要、申请表单
- 字段：结算方式（只读）、流水金额（只读）、底薪金额（可编辑）、备注（选填）
- API调用：POST /api/base-salary-applications

#### 第三阶段

**财务菜单集成**
- 在导航"财务"分组下添加"底薪管理"菜单
- 路由：`GET /reports/base-salary-applications`（或在现有报告菜单下）

**底薪申请列表页面** (`reports/base_salary_applications.html`)
```html
<!-- 顶部：日期选择器 -->
<div class="date-picker">
  <input type="date" id="applicationDate" default="today" />
  <button onclick="prevDay()">←</button>
  <button onclick="nextDay()">→</button>
</div>

<!-- 操作栏 -->
<button onclick="exportCSV()">导出CSV</button>

<!-- 列表卡片 -->
<!-- 字段：主播昵称(真实姓名)、开播时间+时长、直属运营、申请人、流水/底薪金额、状态 -->
<!-- 支持点击进入详情页 -->
```

**底薪申请详情页面** (`reports/base_salary_application_detail.html`)
- 页面布局参考申请页面
- 新增发放状态展示：状态、操作人、操作时间
- 页面底部按钮：
  - 确认发放（未处理、拒绝时显示）
  - 拒绝发放（未处理、已发放时显示）
  - 回到未处理（已发放、拒绝时显示）
  - 变更记录（模态框）
- 状态变更时需输入备注

**CSV导出实现**
- 已在base_salary_applications_api.py中实现
- 字段：主播昵称、真实姓名、直属运营、开播时间、时长、流水金额、申请人、底薪金额、申请时间、状态
- 关联记录丢失时返回"未知"，不崩溃

---

## 🔧 技术细节

### 时间处理
- 所有日期时间在数据库中存储为UTC
- 用户输入和显示均转换为GMT+8
- 生效日期按自然日界定，不包含时间部分

### 关联记录处理
按照用户要求，对关联记录丢失的情况进行降级处理：
```python
# 序列化函数中的示例
battle_record_data = None
if application.battle_record_id:
    try:
        br = application.battle_record_id
        battle_record_data = {
            'id': str(br.id),
            'start_time': utc_to_local(br.start_time).isoformat(),
            'revenue_amount': str(br.revenue_amount),
        }
    except Exception:  # 处理关联记录丢失等异常
        battle_record_data = {'id': str(application.battle_record_id.id)}
```

### 权限控制
- 所有接口使用 `@jwt_roles_accepted('gicho', 'kancho')` 保护
- 仅允许管理员和运营角色操作

### 日志记录
- 所有变更操作都记录IP地址和操作人
- 级别：INFO（正常操作）、ERROR（错误）、DEBUG（详细过程）
- 日志文件：`./log/settlement.log`、`./log/base_salary_application.log`

---

## 📝 API 响应示例

### 获取结算方式列表
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "...",
        "pilot_id": "...",
        "effective_date": "2025-10-20T00:00:00+08:00",
        "settlement_type": "daily_base",
        "settlement_type_display": "日结底薪",
        "remark": "调整为日结",
        "is_active": true,
        "created_at": "2025-10-16T10:00:00+08:00",
        "updated_at": "2025-10-16T10:00:00+08:00"
      }
    ],
    "current_settlement": {
      "settlement_type": "daily_base",
      "settlement_type_display": "日结底薪",
      "effective_date": "2025-10-20T00:00:00+08:00",
      "remark": "调整为日结"
    }
  },
  "error": null,
  "meta": {
    "page": 1,
    "page_size": 20,
    "total": 5
  }
}
```

### 创建底薪申请
```json
{
  "success": true,
  "data": {
    "id": "...",
    "pilot": {
      "id": "...",
      "nickname": "主播名",
      "real_name": "真实姓名",
      "owner": {"id": "...", "nickname": "运营名"}
    },
    "battle_record": {
      "id": "...",
      "start_time": "2025-10-16T10:00:00+08:00",
      "revenue_amount": "1000.00",
      "duration_hours": 2.5
    },
    "settlement_type": "daily_base",
    "base_salary_amount": "100.00",
    "applicant": {"id": "...", "nickname": "申请人"},
    "status": "pending",
    "status_display": "未处理",
    "created_at": "2025-10-16T14:30:00+08:00"
  },
  "error": null,
  "meta": {}
}
```

---

## 🚀 使用建议

### 立即可用
1. 所有API接口已准备就绪，可通过curl或Postman测试
2. 结算管理首页和新增页面可直接访问

### 下一步建议
1. 创建编辑页面模板（参考new.html，但字段可编辑性不同）
2. 在开播记录详情页集成结算方式显示
3. 实现财务菜单下的底薪申请列表和详情页
4. 编写前端单元测试

---

## 📚 相关文档
- 功能文档：`docs/主播-结算管理.md`
- API文档：见上述接口列表
- 数据库设计：见模型定义和索引配置
