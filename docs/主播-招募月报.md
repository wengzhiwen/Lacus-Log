# 主播-招募月报（基于“主播-招募日报”滚动口径）

> 术语统一记录（2025-10-09）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；征召→招募；训练→试播；作战记录→开播记录。
> - 本文档采用统一用语；数据库/接口字段保留历史命名，仅在括号中标注。

"招募月报"是围绕招募负责人（运营）展开的滚动60日聚合报表，补足《docs/主播-招募日报.md》的长期视角。报表上半区提供核心转化指标，下半区以卡片形式呈现关联招募明细，帮助运营快速定位招募链路瓶颈与高潜主播。

## 重要约定

- 数据库存储的所有日期时间字段均为UTC；所有聚合与界面展示一律按GMT+8换算后的日期与自然日进行。
- **统计窗口**：报表固定统计"当前日期（含当天）向前滚动60天内创建的招募"（`Recruit.created_at`）——该窗口不受用户手动调整。
- **明细窗口**：明细数据使用滚动60天窗口，确保包含更多历史招募记录用于分析。
- 报表以招募负责人（`Recruit.recruiter`）为唯一主线：筛选区、统计区与明细区都基于负责人分组。
- 页面不使用缓存；所有统计值来自实时查询或最新缓存层（如有），确保数据一致性。
- 术语、字段定义、历史数据兼容策略均继承《docs/主播-招募日报.md》中的约定。

## 入口与导航

- 主菜单新增“主播招募月报”入口，排序位于“主播招募日报”下方，保持同一菜单分组。
- 默认加载当前用户拥有权限的全部运营数据；若用户本身是运营，则默认选中其本人。
- 页面保留返回“招募日报”的面包屑导航，方便在日/月视角间切换。

## 筛选与搜索

### 负责人筛选
- 类型：下拉单选，列出全部运营（含管理员）。
- 数据源：`/api/users?role=operator` 的缓存列表（与招募日报复用），首项为“全部负责人”。
- 作用范围：更换负责人后，需要重新请求后端统计接口与明细接口。

### 主播昵称/真实姓名筛选（前端，位于下半区的上方）
- 类型：输入框 + 前端实时过滤，仅作用于当前已加载的明细卡片，不触发后端请求。
- 匹配规则：对主播昵称（`pilot.nickname`）和真实姓名（`pilot.real_name`）进行不区分大小写的模糊匹配。
- 参考实现：沿用《主播-主播招募》列表页的`filterCards()`逻辑。

## 页面结构

### 上半区：统计看板
- 布局：五张横向排列的指标卡（在窄屏下折行），结构与《docs/主播-开播日报.md》的统计卡保持一致。
- 指标列表（均针对60日窗口内属于当前筛选负责人的招募，统计口径见"指标定义"）：
  1. **约面数**。
  2. **到面数**（含约面-到面转化率）。
  3. **试播数**（含到面-试播转化率）。
  4. **新开播数**（含到面-新开播转化率）。
  5. **满7天数**（含到面-满7天转化率）。
- 转化率展示：
  - 到面转化率 = 到面数 ÷ 约面数。
  - 试播转化率 = 试播数 ÷ 到面数。
  - 新开播转化率 = 新开播数 ÷ 到面数。
  - 满7天转化率 = 满7天数 ÷ 到面数。
  - 所有转化率保留1位小数（百分比），分母为0时显示`0.0%`。
- 趋势比较：每张卡右上角展示与上一滚动窗口（第61-120天）对比的箭头 ↑/↓/—，沿用招募日报的颜色规范；上一窗口数据需后端额外计算。
- 满7天 = 某被决定招募的主播，在滚动60天窗口内，有7条或以上超过6小时的开播记录

### 下半区：招募明细卡片
- 数据范围：限定在滚动60日窗口内的招募记录，按负责人筛选。
- 排序：默认按"开播天数"降序（数值较大者靠前；为空视为0）。
- 卡片内容（在《主播-主播招募》卡片基础上补充）：
  - 主播昵称（真实姓名）性别图标（♂/♀）。
  - 招募状态、渠道、介绍费。
  - 招募负责人、直属运营（当前实现中显示相同信息）。
  - **开播天数**（加粗显示，计算逻辑见下文）。
  - 关键日期：启动招募、面试决策、开播决策、最近开播时间。
- 空状态：当没有符合条件的招募时，展示"近60日无招募记录"提示及返回日报入口按钮。

## 指标定义与计算

### 时间窗口
- 统计窗口：`window = [today-59 00:00:00, today 23:59:59] (GMT+8)`。
- 对比窗口：`previous_window = [today-119 00:00:00, today-60 23:59:59] (GMT+8)`。
- 明细窗口：`detail_window = [today-59 00:00:00, today 23:59:59] (GMT+8)`。
- 所有时间字段在计算前需通过 `utils/timezone_helper.py` 换算至GMT+8后再取日期。

### 约面数
- 数据来源：`Recruit.created_at`。
- 计算：窗口内创建的招募数量，包含所有最终结果。

### 到面数
- 数据来源：`Recruit.interview_decision_time`（优先）或 `training_decision_time_old`。
- 计算：窗口内发生面试决策（无论结果）的招募数量。

### 试播数
- 数据来源：`Recruit.training_decision_time`（优先）或 `training_decision_time_old`。
- 计算：窗口内发生试播决策（无论结果）的招募数量。

### 新开播数
- 数据来源：`Recruit.broadcast_decision_time` / `final_decision_time` + `broadcast_decision` / `final_decision`。
- 计算：窗口内决定“正式主播”或“实习主播”的招募数量。

### 满7天数
- 数据来源：
  - 在统计窗口内被决定招募的主播（`broadcast_decision_time` 或 `final_decision_time` 在窗口内）。
  - 《docs/主播-开播记录.md》中定义的 `BattleRecord` 表。
- 计算：对每个被决定招募的主播，检查其在统计窗口内的开播记录，计算超过6小时的开播记录数 ≥ 7 计入。

### 开播天数（明细卡字段）
- 范围：滚动60日窗口内主播的开播记录。
- 计算：`len(unique(local_date(start_time)))`，若无开播记录则为0。
- 加粗显示，并作为明细排序字段。
- 同时计算 `long_sessions_count`（超过6小时的开播记录数）用于满7天判断。

## API接口

### 汇总数据接口
- **路径**：`GET /api/recruit-reports/monthly`
- **参数**：`recruiter`（可选，默认'all'）
- **响应**：包含窗口信息、统计数据、转化率、趋势、指标卡片
- **权限**：`gicho`、`kancho` 角色

### 明细数据接口
- **路径**：`GET /api/recruit-reports/monthly/detail`
- **参数**：`recruiter`（可选，默认'all'）
- **响应**：包含招募记录列表，按开播天数降序排列
- **权限**：`gicho`、`kancho` 角色

## 前端实现要点

- 完全REST化，使用统一的响应格式
- 模板路径：`templates/recruit_reports/monthly.html`
- 使用统一的loading图标和动画效果
- 统计卡与招募日报共享组件，避免重复实现
- 主播搜索输入框节流处理（300ms），避免频繁DOM操作
- 不分页，一次性加载所有数据
- 空状态、加载中状态沿用招募日报样式，保持一致的UI体验
- 日期格式化使用GMT+8时区，统一显示为"月-日"格式

## 权限与日志

- 权限：管理员（`gicho`）、运营（`kancho`）角色可访问
- 日志：使用 `recruit_monthly_reports_api` 日志器，记录筛选条件与请求耗时
- 错误处理：统一的异常捕获和错误响应格式

## 与既有模块的关系

- 指标计算与字段降级策略共享《docs/主播-招募日报.md》中的帮助函数
- 明细卡展示参考《docs/主播-主播招募.md》的卡片组件，外观大致统一
- 序列化工具：`utils/recruit_monthly_report_serializers.py` 提供统一的数据格式化
- 统计工具：`utils/recruit_stats.py` 扩展了月报相关的统计函数

## 实现细节

### 核心函数
- `calculate_recruit_monthly_stats()`: 计算月报统计数据
- `calculate_full_7_days_recruits()`: 计算满7天主播数量
- `calculate_conversion_rates()`: 计算各项转化率
- `calculate_trends()`: 计算趋势比较
- `get_recruit_monthly_detail_records()`: 获取明细记录

### 数据序列化
- `build_monthly_summary_payload()`: 构建汇总响应数据
- `build_monthly_detail_payload()`: 构建明细响应数据
- `serialize_monthly_detail_record()`: 序列化单条明细记录

## 待办与风险提示

- 历史数据：若滚动窗口命中大量历史字段（`*_old`），需确保降级读取逻辑覆盖所有阶段
- 趋势比较：上一窗口数据在过滤条件改变时需立即重新计算，注意接口性能，创建足够多的index
- 性能优化：明细查询可能存在N+1问题，建议使用 `select_related` 预加载关联数据
- 缓存策略：可考虑为统计结果添加短期缓存，减少重复计算

