{% extends "base.html" %}

{% block title %}å¼€æ’­å‘¨æŠ¥ - {{ pagination.week_start }}{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">ğŸ“’ å¼€æ’­å‘¨æŠ¥</h1>
  <div class="page-subtitle">å‘¨å®šä¹‰ï¼šå‘¨äºŒè‡³æ¬¡å‘¨ä¸€ï¼ˆ7å¤©ï¼‰</div>
</div>

<div class="date-navigation">
  <div class="date-controls">
    <a href="{{ url_for('report.weekly_report', week_start=pagination.prev_week_start, owner=selected_owner, mode=selected_mode) }}" class="btn btn-secondary btn-sm">â† ä¸Šä¸€å‘¨</a>
    <span class="date-display">{{ pagination.week_start }}ï¼ˆå‘¨äºŒèµ·ï¼‰</span>
    <a href="{{ url_for('report.weekly_report', week_start=pagination.next_week_start, owner=selected_owner, mode=selected_mode) }}" class="btn btn-secondary btn-sm">ä¸‹ä¸€å‘¨ â†’</a>
  </div>
  <div class="export-actions">
    <a href="{{ url_for('report.export_weekly_csv', week_start=pagination.week_start, owner=selected_owner, mode=selected_mode) }}" class="btn btn-warning btn-sm">ğŸ“¥ å¯¼å‡ºCSV</a>
  </div>
</div>

<div class="filter-section">
  <div class="filter-controls">
    <label for="ownerSelector" class="filter-label">ç›´å±è¿è¥ï¼š</label>
    <select id="ownerSelector" class="filter-select">
      <option value="all" {% if selected_owner == 'all' %}selected{% endif %}>å…¨éƒ¨</option>
      {% for owner in owners %}
      <option value="{{ owner.id }}" {% if selected_owner == owner.id|string %}selected{% endif %}>
        {{ owner.nickname or owner.username }}
      </option>
      {% endfor %}
    </select>

    <label for="modeSelector" class="filter-label">å¼€æ’­æ–¹å¼ï¼š</label>
    <select id="modeSelector" class="filter-select">
      <option value="all" {% if selected_mode == 'all' %}selected{% endif %}>å…¨éƒ¨</option>
      <option value="online" {% if selected_mode == 'online' %}selected{% endif %}>çº¿ä¸Š</option>
      <option value="offline" {% if selected_mode == 'offline' %}selected{% endif %}>çº¿ä¸‹</option>
    </select>
  </div>
</div>

<div class="summary-section">
  <h2 class="section-title">å‘¨åº¦æ±‡æ€»ï¼ˆå‘¨äºŒ-æ¬¡å‘¨ä¸€ï¼‰</h2>
  <div class="summary-cards">
    <div class="summary-card">
      <div class="card-label">æ€»ä¸»æ’­æ•°é‡</div>
      <div class="card-value">{{ week_summary.pilot_count }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡æµæ°´</div>
      <div class="card-value">Â¥{{ "{:,.2f}".format(week_summary.revenue_sum) }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡åº•è–ªæ”¯å‡º</div>
      <div class="card-value">Â¥{{ "{:,.2f}".format(week_summary.basepay_sum) }}</div>
      {% if week_summary.conversion_rate is not none %}
      <div class="card-sub">è½¬æ¢ç‡{{ week_summary.conversion_rate }}%</div>
      {% endif %}
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡ä¸»æ’­åˆ†æˆ</div>
      <div class="card-value">Â¥{{ "{:,.2f}".format(week_summary.pilot_share_sum) }}</div>
    </div>
    <div class="summary-card">
      <div class="card-label">ç´¯è®¡å…¬å¸åˆ†æˆ</div>
      <div class="card-value">Â¥{{ "{:,.2f}".format(week_summary.company_share_sum) }}</div>
    </div>
    <div class="summary-card {% if (week_summary.profit_7d or 0) < 0 %}danger-outline{% endif %}">
      <div class="card-label">7å¤©ç›ˆåˆ©ï¼ˆä¸è®¡è¿”ç‚¹ï¼‰</div>
      <div class="card-value">Â¥{{ "{:,.2f}".format(week_summary.profit_7d) }}</div>
    </div>
  </div>
  <div class="summary-hint">æ³¨ï¼šå‘¨å®šä¹‰ä¸ºå‘¨äºŒè‡³æ¬¡å‘¨ä¸€ï¼›ç›ˆåˆ©å£å¾„ä¸è®¡è¿”ç‚¹</div>
  
</div>

<div class="details-section">
  <h2 class="section-title">å‘¨æŠ¥æ˜ç»†</h2>
  {% if details %}
  <div class="table-container">
    <table class="report-table">
      <thead>
        <tr>
          <th class="fixed-col">ä¸»æ’­</th>
          <th>æ€§åˆ«å¹´é¾„</th>
          <th>ç›´å±è¿è¥</th>
          <th>ä¸»æ’­åˆ†ç±»</th>
          <th>å‘¨ç´¯è®¡å¼€æ’­è®°å½•æ•°</th>
          <th>å‘¨å‡æ’­æ—¶(å°æ—¶)</th>
          <th>å‘¨ç´¯è®¡æµæ°´(å…ƒ)</th>
          <th>å‘¨ç´¯è®¡ä¸»æ’­åˆ†æˆ(å…ƒ)</th>
          <th>å‘¨ç´¯è®¡å…¬å¸åˆ†æˆ(å…ƒ)</th>
          <th>å‘¨ç´¯è®¡åº•è–ª(å…ƒ)</th>
          <th>å‘¨ç´¯è®¡æ¯›åˆ©(å…ƒ)</th>
        </tr>
      </thead>
      <tbody>
        {% for detail in details %}
        <tr>
          <td class="fixed-col">
            <a href="{{ url_for('pilot.pilot_performance', pilot_id=detail.pilot_id, from='weekly_report', week_start=pagination.week_start) }}" class="pilot-link">
              {{ detail.pilot_display }}
            </a>
          </td>
          <td>{{ detail.gender_age }}</td>
          <td>{{ detail.owner }}</td>
          <td>{{ detail.rank | normalize_rank }}</td>
          <td>{{ detail.records_count }}</td>
          <td>{{ "{:.1f}".format(detail.avg_duration) }}å°æ—¶</td>
          <td>Â¥{{ "{:,.2f}".format(detail.total_revenue) }}</td>
          <td>Â¥{{ "{:,.2f}".format(detail.total_pilot_share) }}</td>
          <td>Â¥{{ "{:,.2f}".format(detail.total_company_share) }}</td>
          <td>Â¥{{ "{:,.2f}".format(detail.total_base_salary) }}</td>
          <td class="{% if detail.total_profit < 0 %}text-danger{% endif %}">Â¥{{ "{:,.2f}".format(detail.total_profit) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <p>æœ¬å‘¨æš‚æ— å¼€æ’­è®°å½•</p>
  </div>
  {% endif %}
</div>

<style>
.date-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0;
  padding: 16px;
  background: var(--table-header);
  border-radius: 8px;
}

.date-controls { display: flex; align-items: center; gap: 12px; }
.date-display { font-weight: 600; }
.export-actions { display: flex; gap: 8px; }

.filter-section { margin: 16px 0; padding: 12px 16px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; }
.filter-controls { display: flex; align-items: center; gap: 8px; }
.filter-label { font-size: 14px; font-weight: 500; color: var(--text); margin: 0; }
.filter-select { padding: 6px 12px; border: 1px solid var(--gray); border-radius: 4px; font-size: 14px; background: #fff; min-width: 120px; }

.summary-section { margin: 24px 0; }
.section-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: var(--text); }
.summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 8px; }
.summary-card { background: #fff; border: 1px solid var(--gray); border-radius: 8px; padding: 16px; text-align: center; transition: box-shadow 0.2s ease; }
.summary-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.summary-card.danger-outline { border-color: #dc3545; }
.card-label { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
.card-value { font-size: 24px; font-weight: 700; color: var(--brand); }
.card-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }

.details-section { margin: 24px 0; }
.table-container { overflow-x: auto; border: 1px solid var(--gray); border-radius: 8px; background: #fff; }
.report-table { width: 100%; border-collapse: collapse; min-width: 1500px; }
.report-table th, .report-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
.report-table th { background: var(--table-header); font-weight: 600; position: sticky; top: 0; z-index: 2; }
.report-table th.fixed-col, .report-table td.fixed-col { position: sticky; left: 0; background: #fff; background-clip: padding-box; min-width: 120px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.report-table td.fixed-col { z-index: 4; box-shadow: 2px 0 0 #eee; }
.report-table th.fixed-col { z-index: 5; box-shadow: 2px 0 0 #ddd; }
.report-table tbody tr:hover { background: #f8f9fa; }
.empty-state { text-align: center; padding: 40px; color: var(--muted); }
.pilot-link { color: var(--brand); text-decoration: none; font-weight: 600; }
.pilot-link:hover { color: var(--brand-dark); text-decoration: underline; }
.text-danger { color: #dc3545 !important; font-weight: 600; }

@media (max-width: 768px) {
  .date-navigation { flex-direction: column; gap: 12px; }
  .filter-controls { flex-direction: column; align-items: flex-start; gap: 6px; }
  .filter-select { width: 100%; min-width: auto; }
  .summary-cards { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
  .summary-card { padding: 12px; }
  .card-value { font-size: 20px; }
  .report-table { font-size: 12px; }
  .report-table th, .report-table td { padding: 8px 6px; }
}
</style>

<script>
document.getElementById('ownerSelector').addEventListener('change', function() {
  const selectedOwner = this.value;
  const selectedMode = document.getElementById('modeSelector').value;
  const weekStart = '{{ pagination.week_start }}';
  let url = '{{ url_for("report.weekly_report") }}?week_start=' + weekStart;
  if (selectedOwner && selectedOwner !== 'all') { url += '&owner=' + selectedOwner; }
  if (selectedMode && selectedMode !== 'all') { url += '&mode=' + selectedMode; }
  window.location.href = url;
});

document.getElementById('modeSelector').addEventListener('change', function() {
  const selectedMode = this.value;
  const selectedOwner = document.getElementById('ownerSelector').value;
  const weekStart = '{{ pagination.week_start }}';
  let url = '{{ url_for("report.weekly_report") }}?week_start=' + weekStart;
  if (selectedOwner && selectedOwner !== 'all') { url += '&owner=' + selectedOwner; }
  if (selectedMode && selectedMode !== 'all') { url += '&mode=' + selectedMode; }
  window.location.href = url;
});
</script>
{% endblock %}


