### 报告-邮件报告模块

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；征召→招募；作战计划→通告；作战记录→开播记录；训练→试播；战区→开播平台；战斗区域→开播地点；阶级→主播分类；所属→直属运营；X坐标→基地；Y坐标→场地；Z坐标→坐席。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。
本模块专供管理员使用，在管理员的菜单中较靠后位置提供独立入口。进入页面后展示一排“报告发送”按钮。当前版本仅实现第一个按钮：未开播提醒。

---

### 功能概览
- **定位**：面向管理员的离线通知型报表，通过邮件触达。
- **触发方式**：用户点击页面按钮触发后台异步计算与发送；前端不等待结果，仅提示“报表已开始运算”。
- **收件人**：由后端按报表类型动态计算。
  - 未开播提醒：从用户模块获取所有激活用户的邮箱（不区分角色），去重后发送。
  - 未来扩展：可按报表类型配置不同角色或小组策略。
- **日志**：当无可发送内容时，仅记录一条 `INFO` 日志，不发送邮件。
- **扩展性**：预留多个报表按钮位，后续可持续扩充。

---

### 入口与权限
- **菜单入口**：管理员菜单末端区域新增“邮件报告”入口。
- **访问权限**：仅管理员可见与可用；遵循现有权限体系与装饰器实现。

---

### 报表一：未开播提醒
- **报表目标**：在过去 48 小时内，找出所有“通告”，其“计划的接受时间”已过去超过 4 小时但仍未产生对应“开播记录”的计划，并以列表形式邮件通知。
- **判定窗口**：以当前时间为基准，回溯 48 小时内的通告。
- **逾时时间**：当 `当前时间 - 计划接受时间 > 4 小时` 且未发现与之关联的“开播记录”则视为“未开播”。
- **关联关系**：”开播记录“可以（非必需）关联到某一“通告”。以此作为是否“已开播”的主要判断依据。
- **邮件发送**：若命中记录>0，则发送邮件；否则不发邮件，仅记 `INFO` 日志。

### 报表二：招募日报（本期新增）
- **报表目标**：发送前一个自然日（GMT+8）的招募日报统计数据给所有运营和管理员。
- **定时发送**：每天0:05（GMT+8）自动发送前一天的招募日报邮件。
- **手动触发**：支持在邮件报告页面手动触发，可指定报表日期。
- **邮件内容**：包含报表日、近7日、近14日的约面、到面、试播、新开播统计数据。
- **数据计算**：复用招募日报的计算逻辑，确保数据一致性。
- **收件人**：自动获取所有激活的运营和管理员邮箱，支持去重。

---

### 时间口径与时区
- 系统规则：数据库存储 UTC；UI 输入与展示按 GMT+8。
- 本报表计算：统一先将 UI/业务相关时间换算为 UTC 后在数据库侧查询与聚合；列表中用于提示的时间与超时小时数以用户可读格式呈现（建议 GMT+8 展示）。

---

### 数据与字段（建议）
邮件正文建议以表格呈现以下字段：
- **通告ID**：可用于定位问题计划。
- **主播昵称**：来自计划关联主播。
- **计划接受时间（GMT+8）**：计划的“接受时间”。
- **应结束时间/应开播截止**：与“接受时间+4小时”的业务时间点，用于判断是否超时。
- **当前超时（小时）**：`max(0, floor((当前时间 - 应结束时间)/1小时))`。
- **备注/链接**：可附系统内跳转链接，便于处理。

---

### 发送对象与邮件格式
- **收件人**：从用户模块动态获取（当前为所有激活用户邮箱）。
- **主题**：`[Lacus-Log] 未开播提醒（近48小时）`，建议加上生成时间。
- **正文**：
  - 当有数据：以 Markdown 表格形式列出明细，系统内联样式保证邮件客户端可读。
  - 当无数据：不发送邮件；日志记录“无未开播计划，已跳过发送”。
- **底层发送**：复用 `utils/mail_utils.py` 的 `send_email_md()`。

---

### 交互与异步策略
- **点击即触发**：按钮点击后立即返回提示“报表已开始运算”，不进行同步等待。
- **后台执行**：由后端触发报表计算逻辑与邮件发送。若后续引入任务队列（如 Celery/RQ）可将其放入队列执行；本期按最小实现可以采用短事务内计算+发送，但务必控制超时与日志。

---

### 日志规范
- **日志位置**：`log/` 目录按自然日切分，模块名建议 `report_mail`。
- **日志语言**：简体中文。
- **级别建议**：
  - `INFO`：无数据时的跳过发送；发送成功摘要（条目数、收件人）。
  - `DEBUG`：查询条件、时间窗口、示例数据条目（注意脱敏）。
  - `ERROR`：邮件发送失败、数据查询异常。
- **第三方日志**：若引入额外依赖，需将其日志级别显式设为 `INFO`。

---

### 失败与重试（建议）
- 邮件发送失败时记录 `ERROR`，并输出关键信息（主题、收件人、失败原因）。
- 若采用任务队列，可配置有限次重试与退避策略；本期先不实现自动重试。

---

### 接口与页面（概要）
- **页面**：`templates/reports/mail_reports.html`（建议），展示一排按钮；当前仅“未开播提醒”。
- **路由**：`routes/report_mail.py`（建议），POST 触发型端点，返回 JSON：`{"status":"started"}`。
- **权限**：在路由层使用现有装饰器限制为管理员角色。

---

### 边界与约束
- 计划被取消或作废的不纳入统计（以计划状态字段过滤）。
- 多条“开播记录”关联同一计划视为已开播，无需重复提示。
- 若计划未明确“接受时间”，可：
  - 要么跳过；
  - 要么以计划“开始时间”作为替代（需在实现中显式说明）。
  本期建议“跳过无接受时间”的计划并在 `DEBUG` 日志统计数量。

---

### 未来扩展方向
- 更多报表按钮：如“低开播率提醒”“高流水异常提醒”“长时未招募回访提醒”等。
- 收件人策略：支持按角色、按小组动态计算收件人；或允许页面内临时追加收件人。
- 报表订阅：支持每日/每周定时触发与历史报表归档。

---

### 验收要点
- 仅管理员可见入口，点击后立即返回“开始运算”。
- 有命中数据时发送邮件（Markdown 表格呈现）；无数据仅记 `INFO`。
- 计算时间口径与现有模块一致（UTC 存储、GMT+8 展示）。

### 与调度器集成（APScheduler）

- 本模块包含两个可被调度的作业：
  - `daily_unstarted_report`（未开播提醒）：每日 GMT+8 20:00 触发（UTC 12:00）。
  - `daily_recruit_daily_report`（招募日报）：每日 GMT+8 00:05 触发（UTC 16:05，发送前一自然日数据）。
- 触发器：由 `utils/scheduler.py` 使用 `CronTrigger` 注册并运行，调度器时区为 UTC。
- 环境开关：需在环境变量中设置 `ENABLE_SCHEDULER=true` 才会随应用启动自动注册并运行定时作业；开发环境下仅在“重载主进程”启动，避免重复注册。

### 防重策略（JobPlan 令牌）

- 为保证在多进程/多实例环境下“同一计划时间点”仅执行一次，系统引入 JobPlan 令牌（见 `utils/job_token.py`）。
- 工作流程：
  1. 启动时为每个作业计算并写入“下一次触发分钟（UTC）”的计划令牌（幂等 upsert）。
  2. 作业触发时，以“当前分钟（UTC）”尝试原子消费计划：`consume_fire(job_code, fire_dt_utc)`；消费成功才继续执行。
  3. 执行完成后，写入下一次计划：`plan_fire(job_code, next_fire_dt_utc)`。
- 时间粒度：分钟；在包装器内将 `second/microsecond` 归零，以保证与计划键一致。
- 失败处理：若消费失败（令牌不存在），记录 `INFO` 日志并跳过执行。

### 日志

- 模块日志名建议：`report_mail`；调度器侧日志名为 `scheduler`。
- 当定时触发但无数据可发送时：只记录 `INFO` 日志，不发送邮件。
- 当消费令牌失败（被他处消费或未规划）时：记录 `INFO` 日志“跳过执行”。



