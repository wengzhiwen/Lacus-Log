# 机师-机师管理（技术设计）

## 概述

本文档基于业务需求文档《机师-机师管理.md》，设计机师管理功能的技术实现方案。机师管理是系统的核心模块之一，需要提供完整的CRUD操作、权限控制、数据验证和变更记录功能。

## 技术架构

### 技术栈
- **后端**: Flask + MongoEngine
- **前端**: Jinja2模板 + 自定义CSS
- **数据库**: MongoDB
- **权限控制**: Flask-Security-Too
- **日志系统**: Python logging模块

### 设计原则
- 遵循现有项目的代码风格和技术模式
- 保持与用户管理模块的一致性
- 确保数据完整性和业务规则验证
- 提供良好的用户体验和错误处理

## 数据模型设计

### Pilot（机师）模型

#### 字段设计
- **基础信息字段**：
  - `nickname`: 昵称（必填，唯一，最大20字符）
  - `real_name`: 真实姓名（可选，最大20字符）
  - `gender`: 性别（枚举：男/女/不明确，默认女）
  - `birth_year`: 出生年份（可选，用于计算年龄）

- **关联信息字段**：
  - `owner`: 所属舰长/议长（关联到User模型的ObjectId，使用ReferenceField）

- **业务信息字段**：
  - `platform`: 战区/平台（枚举：快手/抖音/其他/未知，默认未知）
  - `work_mode`: 参战形式（枚举：线下/线上/未知，默认未知）
  - `rank`: 阶级（枚举：候补机师/训练机师/实习机师/正式机师，默认候补机师）
  - `status`: 状态（枚举：未征召/不征召/已征召/已签约/已阵亡，默认未征召）

- **系统字段**：
  - `created_at`: 创建时间（自动设置）
  - `updated_at`: 最后修改时间（自动更新）

#### 枚举类型定义
- **Gender**: 性别枚举（0=男，1=女，2=不明确）
- **Platform**: 平台枚举（快手、抖音、其他、未知）
- **WorkMode**: 工作模式枚举（线下、线上、未知）
- **Rank**: 阶级枚举（候补机师、训练机师、实习机师、正式机师）
- **Status**: 状态枚举（未征召、不征召、已征召、已签约、已阵亡）

### PilotChangeLog（变更记录）模型

#### 字段设计
- `pilot_id`: 关联的机师ID（关联到Pilot模型的ObjectId，使用ReferenceField）
- `user_id`: 操作用户ID（关联到User模型的ObjectId，使用ReferenceField）
- `field_name`: 变更的字段名
- `old_value`: 变更前的值
- `new_value`: 变更后的值
- `change_time`: 变更时间
- `ip_address`: 操作IP地址

### User模型关联说明

#### 关联字段
- **Pilot.owner**: 关联到User模型的ObjectId字段
- **PilotChangeLog.user_id**: 关联到User模型的ObjectId字段

#### User模型可用字段
- `username`: 用户名（登录标识）
- `nickname`: 用户昵称（显示名称）
- `active`: 用户激活状态
- `roles`: 用户角色列表（包含gicho/kancho）
- `created_at`: 用户创建时间
- `fs_uniquifier`: 全局唯一标识符

### 数据库索引设计

#### Pilot集合索引
- `nickname` 唯一索引（用于昵称唯一性检查）
- `owner` 索引（用于按所属筛选）
- `rank` 索引（用于按阶级筛选）
- `status` 索引（用于按状态筛选）
- `platform` 索引（用于按平台筛选）
- `created_at` 降序索引（用于列表页排序）

#### PilotChangeLog集合索引
- `pilot_id + change_time` 复合索引（用于查询机师变更历史）
- `user_id` 索引（用于查询用户操作记录）
- `change_time` 索引（用于按时间范围查询）

## 路由设计

### 路由结构
- 创建独立的 `routes/pilot.py` 模块
- 使用蓝图 `pilot_bp` 管理所有机师相关路由
- 路由前缀：`/pilots`

### 路由列表

#### 1. 机师列表页面 (`/pilots/`)
- **功能**: 显示机师列表，支持筛选和排序
- **权限**: 议长和舰长
- **筛选条件**: 阶级、状态、所属、创建时间
- **权限控制**: 舰长只能看到自己的机师，议长可以看到所有机师
- **排序**: 按创建时间降序排列

#### 2. 机师详情页面 (`/pilots/<pilot_id>`)
- **功能**: 显示单个机师的详细信息
- **权限**: 议长和舰长
- **权限控制**: 舰长只能查看自己的机师
- **操作按钮**: 编辑、变更记录

#### 3. 机师新建页面 (`/pilots/new`)
- **功能**: 创建新机师
- **权限**: 议长和舰长
- **表单验证**: 昵称唯一性、字段长度、业务规则
- **默认值**: 舰长新建的机师默认属于自己

#### 4. 机师编辑页面 (`/pilots/<pilot_id>/edit`)
- **功能**: 编辑机师信息
- **权限**: 议长和舰长
- **权限控制**: 舰长只能编辑自己的机师
- **变更记录**: 自动记录所有字段变更

#### 5. 变更记录页面 (`/pilots/<pilot_id>/changes`)
- **功能**: 显示机师变更历史
- **权限**: 议长和舰长
- **权限控制**: 舰长只能查看自己机师的变更记录
- **显示内容**: 最近100条变更记录

## 前端模板设计

### 模板结构
```
templates/pilots/
├── list.html          # 机师列表页面
├── detail.html        # 机师详情页面
├── new.html           # 新建机师页面
├── edit.html          # 编辑机师页面
└── changes.html       # 变更记录弹窗
```

### 列表页面设计
- **布局**: 卡片式布局，与用户管理保持一致
- **筛选器**: 可折叠的筛选条件，支持阶级、状态、所属、时间筛选
- **卡片内容**: 昵称、姓名、性别图标、年龄、所属、阶级、状态
- **交互**: 整个卡片可点击，悬停效果
- **空状态**: 无数据时的友好提示

### 详情页面设计
- **布局**: 信息卡片分组显示（基础信息、业务信息、系统信息）
- **操作按钮**: 编辑、变更记录按钮
- **信息展示**: 清晰的标签-值对布局
- **变更记录**: 模态框弹窗显示

### 新建/编辑页面设计
- **表单布局**: 分组表单，清晰的字段组织
- **验证提示**: 实时验证和错误提示
- **枚举选择**: 下拉选择框，按业务顺序排列
- **所属选择**: 特殊排序规则（空值、当前用户、其他活跃用户、非活跃用户）

### 变更记录页面设计
- **显示方式**: 模态框弹窗
- **记录格式**: 时间、操作用户、字段名、旧值、新值
- **排序**: 按变更时间降序
- **限制**: 最多显示100条记录

## 权限控制设计

### 权限矩阵

| 功能 | 议长 | 舰长 |
|------|------|------|
| 查看所有机师 | ✅ | ❌ |
| 查看自己的机师 | ✅ | ✅ |
| 创建机师 | ✅ | ✅ |
| 编辑机师 | ✅ | 仅自己的机师 |
| 查看变更记录 | ✅ | 仅自己的机师 |

### 权限检查机制
- **角色验证**: 使用 `@roles_required` 装饰器进行路由级权限控制
- **数据级权限**: 在业务逻辑中检查用户对特定机师的操作权限
- **舰长限制**: 舰长只能操作属于自己的机师
- **议长特权**: 议长拥有所有机师的管理权限

## 数据验证和业务规则

### 前端验证
- **实时验证**: 表单提交前的客户端验证
- **字段长度**: 昵称和姓名最大20字符限制
- **出生年份**: 距今60年前到距今10年前的有效范围
- **必填字段**: 昵称的必填验证
- **唯一性**: 昵称唯一性检查

### 后端验证
- **数据完整性**: 使用MongoEngine的clean()方法进行模型级验证
- **业务规则**: 阶级与所属、战区、参战形式的关联验证
- **状态规则**: 已征召/已签约状态必须填写姓名和出生年
- **枚举验证**: 确保枚举字段值的有效性

### 业务规则验证
- **阶级规则**: 实习机师和正式机师必须有所属、战区不能是未知、参战形式不能是未知
- **状态规则**: 已征召和已签约状态必须填写姓名和出生年
- **关联规则**: 删除用户时检查是否有下属机师

## 变更记录系统

### 变更记录机制
- **自动记录**: 编辑机师时自动记录所有字段变更
- **记录内容**: 字段名、旧值、新值、操作时间、操作用户、IP地址
- **批量保存**: 一次编辑的多个字段变更批量记录
- **查询优化**: 按机师ID和时间排序的复合索引

### 变更记录查询
- **历史查询**: 按机师查询变更历史
- **用户查询**: 按操作用户查询操作记录
- **时间范围**: 支持按时间范围查询变更记录
- **记录限制**: 最多显示100条变更记录

## 日志记录

### 日志配置
- **独立日志**: 机师管理模块使用独立的日志文件
- **日志轮转**: 按自然日切分日志文件
- **日志级别**: INFO级别记录关键操作，ERROR级别记录异常

### 关键操作日志
- **创建操作**: 记录机师创建和操作用户
- **更新操作**: 记录机师更新和操作用户
- **错误记录**: 记录操作失败和错误信息
- **权限检查**: 记录权限验证失败的情况

## 部署和配置

### 环境变量
- **可选配置**: 机师相关参数可通过环境变量配置
- **默认值**: 提供合理的默认配置值
- **向后兼容**: 不破坏现有配置结构

### 数据库初始化
- **索引创建**: 应用启动时自动创建必要的数据库索引
- **错误处理**: 索引创建失败时的错误处理和日志记录
- **性能优化**: 为常用查询创建复合索引

## 测试策略

### 单元测试
- **模型测试**: 测试机师模型的创建、验证、保存
- **业务规则**: 测试各种业务规则验证
- **枚举测试**: 测试枚举字段的有效性
- **变更记录**: 测试变更记录的正确性

### 集成测试
- **路由测试**: 测试各个路由的访问权限和功能
- **权限测试**: 测试不同角色的权限控制
- **表单测试**: 测试表单提交和数据验证
- **API测试**: 测试变更记录API的功能

## 性能优化

### 数据库查询优化
- **索引策略**: 为常用查询字段创建合适的索引
- **查询优化**: 避免N+1查询问题
- **分页支持**: 为大量数据提供分页查询
- **缓存策略**: 对不经常变化的数据进行缓存

### 前端优化
- **异步加载**: 变更记录使用AJAX异步加载
- **表单优化**: 前端实时验证减少服务器请求
- **响应式设计**: 确保在移动设备上的良好体验
- **资源优化**: 合理使用CSS和JavaScript资源

## 安全考虑

### 数据安全
- **输入验证**: 严格验证所有用户输入数据
- **权限控制**: 确保用户只能访问有权限的数据
- **变更审计**: 完整记录所有数据变更操作
- **SQL注入防护**: 使用ORM防止注入攻击

### 业务安全
- **业务规则**: 严格执行业务规则验证
- **数据完整性**: 确保关联数据的一致性
- **错误处理**: 优雅处理各种异常情况
- **敏感信息**: 合理处理敏感信息的显示和存储

## 扩展性设计

### 未来扩展点
- **机师技能系统**: 为机师添加技能和等级管理
- **机师分组**: 支持机师分组和批量管理
- **批量操作**: 支持批量编辑、导入导出功能
- **统计分析**: 添加机师数据统计分析功能
- **API接口**: 为其他模块提供机师数据API

### 接口预留
- **内部API**: 为系统内部模块提供机师数据接口
- **数据格式**: 支持JSON格式的数据交换
- **权限继承**: API接口继承现有的权限控制机制

## 总结

本技术设计文档详细规划了机师管理功能的实现方案，包括：

1. **数据模型**: 完整的机师数据结构和变更记录系统
2. **路由设计**: RESTful风格的API设计
3. **前端界面**: 符合项目UI风格的模板设计
4. **权限控制**: 基于角色的访问控制
5. **数据验证**: 前后端双重验证机制
6. **日志记录**: 完整的操作审计日志
7. **性能优化**: 数据库和前端优化策略
8. **安全考虑**: 数据安全和业务安全措施
9. **扩展性**: 为未来功能扩展预留接口

该设计遵循项目现有的技术架构和代码风格，确保与现有系统的良好集成，同时为机师管理功能提供了完整、安全、可扩展的实现方案。
