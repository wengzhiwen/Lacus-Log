# 主播-主播管理（原“机师-机师管理”）

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；征召→招募；参战形式→开播方式；战区→开播平台；阶级→主播分类；所属→直属运营；正式机师→正式主播；实习机师→实习主播。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。
主播指代受公司运营的内容生产者，针对一些表词达意不够准确的文档描述，将使用针对主播的视角更为准确。

但在数据库/接口等技术实现中，仍保留历史字段与命名，不做破坏性修改。

## 基本约定

- 主播不是用户
    - 没有登录功能
    - 本系统暂时没有直接提供任何功能给到主播
    - 在系统设计中应该被视为资产
- 主播是几乎所有模块的核心
    - 大多数系统都会引用主播的基础数据结构
    - 因而需要维护良好的易扩展的数据结构和INDEX，由技术设计

## 主播的元数据

以下为业务视角的元数据清单，技术实现时可能需要补充更多的字段

| 字段 | 说明 | 参考类型 | 设定 |
|---------|------|------|------|
| ID | 系统中内部使用的唯一编码，用户不可见 | 由技术设计 | 必须 唯一 |
| 昵称 | 系统中主要用于显示的主播名，必须唯一。创建和编辑时会进行实时重名检查，防止混淆 | 字符串 | 必须 唯一 |
| 姓名 | 作为参考保存的主播的真实姓名，允许重复但会在UI中提醒用户注意重名情况 | 字符串 | 非必须 |
| 性别 | 男(0) / 女(1) / 不明确(2或其他数值) | 枚举 | 必须，默认值=不明确 |
| 籍贯 | 主播的籍贯信息 | 字符串 | 非必须，最大20字符 |
| 出生年 | 出生年份，用来计算年龄 | 数值型 | 非必须 |
| 直属运营 | 主播直属运营 | 关联到用户唯一ID | 非必须 |
| 开播平台 | 主播开播的平台：快手 / 抖音 / 其他 / 未知 | 枚举 | 必须，默认=未知 |
| 开播方式 | 线下 / 线上 / 未知 | 枚举 | 必须，默认=未知 |
| 主播分类 | 候选人 / 试播主播 / 实习主播 / 正式主播 | 枚举 | 必须，默认值=候选人 |
| 状态 | 未招募 / 不招募 / 已招募 / 已签约 / 已流失 | 枚举 | 必须，默认值=未招募 |
| 变更记录 | 记录上述字段的所有修改日志（哪个用户什么时间把什么字段的值从什么改成了什么，修改时使用的IP地址是什么） | 由独立模型持久化（非嵌入JSON） | 非必须 |
| 创建时间 | 创建本条记录的时间 | 时间戳 | 必须，默认=当前时间UTC |
| 最后修改 | 最后一次修改本条记录的时间 | 时间戳 | 必须，默认=当前时间UTC |


### 元数据之间的关联

在对主播的数值进行修改时，应符合以下条件：

- 主播分类为 实习主播 / 正式主播 的，必须有直属运营，开播地点不能是未知，开播方式不能是未知
- 状态为 已招募 / 已签约 的，必须有姓名、出生年

### 交叉关联

#### 基础-用户系统

- 当前系统不支持“删除用户”功能，无需在本模块执行相关拦截

## 主播管理界面

### 列表

- 按主播的创建时间逆序（最近在前）排列
- 展示字段
    - 昵称 姓名（换行，副文字）
    - 性别（用图标） 年龄（用now来计算周岁）
    - 直属运营 主播分类（换行，副文字） 状态（换行，副文字）
- 点击进入主播详情

新主播按钮：新建主播
主播导出按钮：导出所有主播数据为CSV文件

#### 导出功能

主播导出功能提供完整的主播数据导出，生成与Microsoft Excel完全兼容的CSV文件。

**导出字段**：
- 昵称：主播的显示名称
- 姓名：主播的真实姓名
- 性别：男/女/不明确
- 出生年：主播的出生年份
- 籍贯：主播的籍贯信息
- 开播平台：快手/抖音/其他/未知
- 直属运营昵称：主播的直属运营显示名称
- 开播方式：线下/线上/未知
- 主播分类：候选人/试播主播/实习主播/正式主播
- 状态：未招募/不招募/已招募/已签约/已流失
- 当前分成比例：从分成管理模块获取的当前有效分成比例

**技术实现**：
- 导出格式：UTF-8 with BOM编码的CSV文件，确保Excel正确显示中文
- 分成比例获取：复用分成管理模块的当前分成比例计算逻辑
- 权限控制：管理员和运营均可使用导出功能
- 文件命名：主播数据导出_YYYYMMDD_HHMMSS.csv

#### 筛选

支持筛选：

- 按主播分类筛选
- 按状态筛选
- 按直属运营筛选
- 按创建时间筛选（最近7天 14天 30天）

所有筛选条件可以组合成复合筛选（交集）；

筛选条件展示，点击筛选条件展开筛选器（否则筛选器太高了，默认折叠）；

筛选条件通过 `persist_and_restore_filters` 存入用户 session，便于后续访问保持一致。

#### 搜索

在筛选器下方提供文本搜索框，支持：

- 搜索范围：主播昵称和真实姓名
- 搜索方式：前端模糊匹配，不区分大小写
- 触发方式：实时输入搜索、退格键、删除键、回车键、搜索按钮点击
- 实现方式：纯前端JavaScript实现，不影响后端筛选器功能
- 交互设计：搜索框为空时显示所有主播，有搜索内容时实时过滤显示结果

#### 默认筛选器

- 管理员
    - 无（可选按直属运营/状态/主播分类/时间筛选）
- 运营
    - 无（默认不再强制“直属运营=自己”，但仍可作为筛选条件）

### 主播详情

展示一位主播的数据。

**返回按钮**：
- 标签统一为"返回"
- 根据来源参数自动跳转到正确页面：
  - 从招募详情页进入：返回招募详情页
  - 从通告详情页进入：返回通告详情页
  - 从开播记录详情页进入：返回开播记录详情页
  - 从主播业绩页进入：返回主播业绩页
  - 其他来源：返回主播列表页

**功能按钮**：

- 编辑： 跳转主播编辑
- 启动招募： 仅当主播状态为"未招募"时显示，跳转启动招募页面
- 分成管理： 跳转分成管理页面
- 业绩查看： 跳转主播业绩页面，携带来源参数 `from='pilot_detail'`，确保返回时能正确回到主播详情页
- 变更记录： 弹窗展示最近100条变更记录，按变更发生的时间逆序排列

  注：前端通过调用 GET `/pilots/<pilot_id>/changes` 获取JSON数据并渲染弹窗。

没有删除功能。

### 主播新建 / 编辑

#### 真实姓名重名检查功能

为防止主播信息混淆，系统在新建和编辑主播时提供实时真实姓名重名检查功能：

**检查范围**：
- 真实姓名重复检查（真实姓名允许重复，但会提醒用户注意重名情况）

**实时检查**：
- 用户输入真实姓名时，系统自动检查重名情况
- 采用防抖机制（500ms延迟），避免频繁请求
- 重名警告显示在输入框上方，包含以下信息：
  - 重名主播的昵称(真实姓名) 年龄 性别图标 直属运营 最后更新时间
  - 时间显示为GMT+8时区
  - 性别用图标显示（♂、♀、？）

**二次确认**：
- 提交表单时，如果存在相同真实姓名的主播，弹出确认对话框
- 对话框显示所有重名主播的详细信息
- 用户可选择继续提交或取消操作

**编辑时的特殊处理**：
- 编辑主播时，重名检查会排除当前正在编辑的主播
- 避免编辑同一主播时出现误报

**API接口**：
- `GET /api/pilots/check-duplicate?real_name=<真实姓名>&exclude_id=<排除ID>`
- 返回格式：
  ```json
  {
    "success": true,
    "data": {
      "has_duplicates": true,
      "duplicates": [
        {
          "id": "主播ID",
          "nickname": "昵称",
          "real_name": "真实姓名",
          "age": 25,
          "gender_icon": "♂",
          "owner": "直属运营昵称",
          "updated_at": "2025-11-01 14:30:00"
        }
      ],
      "message": "系统中有1个相同真实姓名的主播存在"
    }
  }
  ```

#### 表单验证

- 支持所有数据的修改，但部分字段的修改需要符合本文档中约定的条件
- 不支持编辑 ID 变更记录 创建时间 最后修改等由系统管理的字段
- 对于枚举字段只能在枚举中选择值，选项的显示顺序按上表中的顺序
    - 非必须的枚举字段，默认为空值
- 对于出生年字段需要进行有效验证（距今60年前-距今10年前）
- 对于昵称，最大长度限定20个字符
- 对于姓名，最大长度限定20个字符
- 对于籍贯，最大长度限定20个字符
- 直属运营的选择从所有的运营 / 管理员 （不论是否活跃）中选择，选项的显示顺序：
    - 第一顺位： 空值
    - 第二顺位： 当前 运营 / 管理员
    - 第三顺位： 其他活跃运营（昵称字典顺序）
    - 第四顺位： 其他运营（昵称字典顺序，昵称后接[阵亡]）

#### 业务规则

- **昵称唯一性**：系统中所有主播的昵称必须唯一，由数据库层面保证
- **真实姓名重复检查**：真实姓名允许重复，但会在UI中提示用户注意重名情况
- **编辑时排除自身**：编辑主播时检查重名会排除当前编辑的主播ID
- **确认机制**：存在相同真实姓名时需要用户二次确认才能完成操作

## API接口

### 主播真实姓名重名检查

**接口地址**：`GET /api/pilots/check-duplicate`

**功能说明**：检查主播真实姓名是否存在重复

**请求参数**：
- `real_name`（必需）：要检查的真实姓名
- `exclude_id`（可选）：排除的主播ID（编辑时使用）

**注意**：real_name参数为必需参数

**响应格式**：
```json
{
  "success": true,
  "data": {
    "has_duplicates": true,
    "duplicates": [
      {
        "id": "主播ID字符串",
        "nickname": "主播昵称",
        "real_name": "真实姓名或空字符串",
        "age": 25,
        "gender_icon": "♂",
        "owner": "直属运营昵称或null",
        "updated_at": "2025-11-01 14:30:00"
      }
    ],
    "message": "系统中有1个重名主播存在"
  }
}
```

**字段说明**：
- `has_duplicates`：是否存在相同真实姓名的主播
- `duplicates`：重名主播列表，每个主播包含：
  - `id`：主播唯一标识
  - `nickname`：主播昵称
  - `real_name`：真实姓名
  - `age`：年龄（基于出生年计算）
  - `gender_icon`：性别图标（♂、♀、？）
  - `owner`：直属运营昵称，无运营时为null
  - `updated_at`：最后更新时间（GMT+8格式）

**错误响应**：
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "INVALID_PARAMS",
    "message": "真实姓名参数不能为空"
  },
  "meta": {}
}
```

**使用场景**：
- 新建主播时的实时真实姓名重名检查
- 编辑主播时的真实姓名重名检查（排除当前主播）
- 表单提交前的最终验证

### 相关测试用例

- **S4-TC11**：主播真实姓名重名检查测试
- **S4-TC12**：主播真实姓名重名检查测试（编辑时排除）
- **S4-TC13**：真实姓名重名检查无效参数测试

测试覆盖了正常流程、边界情况和错误处理，确保重名检查功能的可靠性和准确性。


