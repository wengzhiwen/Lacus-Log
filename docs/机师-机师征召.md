# 机师-机师征召

机师-机师征召用于管理对“未征召”机师发起的面试/招募流程工单。该模块仅支持从“机师详情页”的“启动征召”按钮进入创建流程，不支持独立新建空白征召。

## 重要约定

- 数据库存储的所有日期时间均为UTC；界面显示与输入均为GMT+8，必须严格遵守。
- 仅当机师当前状态为“未征召”时，机师详情页底部操作区显示并启用“启动征召”按钮。
- 征召对象唯一，且从机师详情页携带机师ID跳转；禁止无对象创建。
- CSRF：所有表单必须包含隐藏字段提交CSRF Token，严格参考现有模块写法。
- 日志：本模块的日志按自然日滚动，写入 `./log` 目录，必要时使用INFO，复杂流程留足DEBUG（中文）。

## 元数据

| 字段 | 说明 | 参考类型 | 设定 |
|---------|------|------|------|
| ID | 系统内部唯一编码，用户不可见 | 由技术设计 | 必须 唯一 |
| 机师 | 被征召的机师 | 关联到机师唯一ID | 必须，仅展示不可编辑 |
| 征召负责人 | 负责该征召的舰长 | 关联到用户唯一ID | 必须，默认=当前用户 |
| 预约时间 | 与机师约定的面试时间 | 时间戳UTC | 必须，默认=次日16:00（按GMT+8取值，入库UTC） |
| 渠道 | BOSS / 51 / 介绍 / 其他 | 枚举 | 必须 |
| 介绍费 | 人民币元，两位小数 | 数值 | 必须，默认=0 |
| 备注 | 补充信息 | 字符串 | 可选，≤200字 |
| 征召状态 | 已启动 / 已结束 | 枚举 | 必须，默认=已启动 |
| 创建时间 | 创建记录的时间 | 时间戳 | 必须，默认=当前UTC |
| 最后修改 | 最近一次修改时间 | 时间戳 | 必须，默认=当前UTC |

### 状态流转

- 创建：状态=已启动。
- 确认征召：状态→已结束，同时对机师执行：阶级→训练机师；状态→已征召。
- 放弃征召：状态→已结束，同时对机师执行：状态→不征召。
- 编辑页允许手动将状态改为“已结束”，但界面提示“不建议手动修改，推荐使用‘放弃征召’”。

## 入口与导航

- 在主菜单新增“机师征召”入口，进入征召列表页。
- 机师详情页（状态=未征召）底部footbar显示“启动征召”按钮；点击跳转到“启动征召”页面（唯一入口）。

## 创建与编辑

### 启动征召（创建）
- 页面上部以卡片展示机师关键信息（昵称、性别/年龄、所属、当前阶级与状态）。
- 表单字段：
  - 征召负责人（选择舰长；默认=当前用户）
  - 预约时间（日期时间；默认=次日16:00，显示为GMT+8，入库UTC）
  - 渠道（枚举：BOSS / 51 / 介绍 / 其他；按该顺序显示）
  - 介绍费（人民币元；默认=0；两位小数）
  - 备注（可选）
  - 征召状态（默认=已启动，不在创建页中暴露为可编辑项）
- 校验：
  - 征召负责人不可为空且必须是舰长或以上权限。
  - 预约时间必填；入库前将GMT+8转换为UTC。
  - 渠道为枚举值；介绍费需为有效的非负金额（两位小数）。
  - CSRF Token 必须通过隐藏字段提交。
- footbar：
  - 左：返回
  - 右：创建（btn-primary）

### 编辑征召
- 展示内容与创建类似；与创建不同的是：
  - “征召状态”在编辑页可见且可编辑，取值=已启动/已结束。
  - 顶部保留机师信息卡片。
- 提示：采用文案提示“建议使用‘放弃征召’来结束征召，不建议手动修改状态”。
- 校验与保存：同创建；更新时间戳；记录变更（时间、操作者、字段、前值、后值、IP）。

## 列表

- 菜单入口进入列表，默认筛选“征召状态=已启动”。
- 筛选器：
  - 征召状态（已启动（默认）/ 已结束）
- 排序：按预约时间升序。
- 列表项字段：机师昵称、预约时间（GMT+8显示）、渠道、征召负责人昵称。
- 交互：点击卡片进入征召详情。
- 空状态：显示友好提示与返回入口按钮。

## 详情

- 展示全部字段与机师信息卡片。
- 底部footbar按钮：编辑 / 确认征召 / 放弃征召。
- 按钮可用性：当且仅当“征召状态=已启动”时，“确认征召”“放弃征召”可点击；否则置灰禁用。

## 确认征召

- 页面顶部展示机师信息卡片。
- 表单：
  - 征召确认人（当前用户，只读展示，不可编辑）
  - 介绍费（允许再次编辑）
  - 备注（允许再次编辑）
- 提示文案：
  - “该机师的阶级将自动变更为训练机师”
  - “该机师的状态将自动变更为已征召”
- 用户点击“确认”后：
  - 将该征召状态改为“已结束”。
  - 更新机师：阶级→训练机师；状态→已征召（不论原值）。
  - 写入相应变更记录与操作日志。
- CSRF：本页表单同样必须通过隐藏字段提交CSRF Token。

### 交互限制：姓名为空的前置校验

- 当且仅当被确认征召的机师“真实姓名”不为空时，页面底部的“确认征召”按钮才可点击。
- 若“真实姓名”为空：
  - “确认征召”按钮置灰禁用；
  - 页面底部显示提示文案：“该机师未填写真实姓名，请先在机师管理补全基本资料后再确认征召。”；
  - 同时提供跳转链接至机师编辑页以便快速补全资料。

## 放弃征召

- 点击“放弃征召”后弹出确认对话框：
  - 文案：“你确认要放弃这个鸽子王吗？也许他将来可以驾驶强袭自由。”
- 用户确认后：
  - 将该征召状态改为“已结束”。
  - 将该机师状态改为“不征召”（不论原值）。
  - 记录操作日志与变更记录。

## 权限

- 议长、舰长：权限一致，均可见且可写（不限制所属）。
- 其他角色：遵循项目统一的权限策略（由技术实现）。

## UI与交互规范

- 参考《基础-UI风格》与《机师-作战记录》：
  - 移动优先、卡片列表、footbar吸附式操作按钮。
  - 主要按钮使用ZAFT红；禁用态灰色描边。
  - 表单组间距与输入框样式与既有模块保持一致。
- 时间显示统一使用Jinja2过滤器（如已有：local_datetime、local_date）。
- 列表卡片整体可点击，悬停/触摸有上浮与阴影反馈。

## 技术实现要点

- 时间处理：统一使用 `utils/timezone_helper.py` 的转换方法，确保“数据库UTC，UI GMT+8”。
- 模板：复用现有表单分组与footbar组件；CSRF Token 使用隐藏字段，遵循既有模板写法（如 `{{ csrf_token() }}`）。
- 日志：按模块输出到 `./log/recruit_YYYYMMDD.log`（命名示例），INFO用于关键节点，复杂流程用DEBUG。
- 排序与筛选：后端按筛选条件查询，默认状态=已启动；按预约时间升序返回，分页按需实现（与既有模块一致）。
- 变更记录：记录字段级变更（时间、操作者、前值、后值、IP）。

