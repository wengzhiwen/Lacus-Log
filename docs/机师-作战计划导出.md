# 机师-作战计划导出

## 概述

机师-作战计划导出功能用于生成指定机师在指定月份的通告预定表，以PDF格式输出供打印使用。该功能基于现有的作战计划（通告）数据，生成格式化的通告预定表。

## 功能描述

### 主要功能
- 选择机师（使用与创建作战计划相同的三联选择方式）
- 选择年月（默认当前年月）
- 生成指定机师在指定月份的通告预定表
- 支持浏览器打印功能输出PDF文件

### 数据来源
- 基于现有的 `Announcement`（通告）模型数据
- 关联 `Pilot`（机师）模型获取机师信息
- 关联 `BattleArea`（战斗区域）模型获取坐标信息

## 用户界面设计

### 功能入口
- 与"机师-作战计划"平行的独立菜单项目
- 菜单名称：**机师-作战计划导出**
- 权限：议长和舰长

### 页面布局
- **选择区域**：
  - 机师选择：使用三联选择（所属、阶级、昵称）
  - 年月选择：年月选择器，默认当前年月
  - 生成按钮：点击生成通告预定表

- **表格展示区域**：
  - 标题：`{昵称} 通告预定表（{X}月）`
  - 表格内容：按日期顺序展示整月的通告信息
  - 打印按钮：调用浏览器打印功能

### UI风格要求
- 专为打印输出设计的PDF表格样式
- 不使用移动设备UI风格
- 去除不必要的装饰元素，确保打印效果良好
- 表格布局清晰，适合A4纸张打印

## 数据映射规则

### 表格字段映射
| 表格字段 | 数据来源 | 格式要求 | 备注 |
|---------|---------|---------|------|
| 昵称 | `pilot.nickname` | 直接显示 | 对应原图的"艺名" |
| 姓名 | `pilot.real_name` | 直接显示 | 对应原图的"姓名" |
| 运营 | `pilot.owner.nickname` 或 `pilot.owner.username` | 直接显示 | 对应原图的"运营" |
| 场地 | `announcement.x_coord` | 多个用逗号分隔 | 对应原图的"场地" |
| 日期 | `announcement.start_time` | `mm/dd 星期N` | 对应原图的"日期" |
| 通告时间 | `announcement.start_time` | `hh:mm` (24小时制 GMT+8) | 对应原图的"通告时间" |
| 设备 | `announcement.y_coord` + `-` + `announcement.z_coord` | `Y坐标-Z坐标` | 对应原图的"设备" |
| 通告时长 | `announcement.duration_hours` | `N小时` | 对应原图的"通告时长" |
| 工作内容 | 固定值 | `弹幕游戏直播` | 固定内容 |

### 时间处理
- 所有时间显示均使用GMT+8时区
- 日期格式：`mm/dd 星期N`（如：09/01 星期一）
- 时间格式：`hh:mm`（24小时制，如：08:00）

### 数据排序
- 按日期顺序排列，从所选月的第一天到最后一天
- 每天一行，即使当天没有通告也要显示空行
- 确保表格的完整性和连续性

## 技术实现

### 路由设计
- **主页面路由**：`/announcements/export`
- **生成API路由**：`/announcements/export/generate`
- **权限控制**：议长和舰长

### 数据查询逻辑
1. **机师选择**：复用现有的三联选择逻辑
2. **年月筛选**：根据选择的年月筛选通告数据
3. **数据聚合**：按日期聚合通告信息
4. **表格生成**：生成完整的月度表格数据

### 模板设计
- **主页面模板**：`templates/announcements/export.html`
- **表格模板**：`templates/announcements/export_table.html`
- **打印样式**：专门的CSS打印样式

### 核心功能函数
```python
def get_pilot_choices():
    """获取机师选择列表（复用现有逻辑）"""

def get_monthly_announcements(pilot_id, year, month):
    """获取指定机师在指定月份的通告数据"""

def generate_export_table(pilot, year, month):
    """生成导出表格数据"""

def format_announcement_data(announcements):
    """格式化通告数据为表格格式"""
```

## 业务规则

### 数据展示规则
1. **完整月份**：显示所选月份的所有日期（1号到最后一天）
2. **空日期处理**：没有通告的日期显示空行
3. **多通告处理**：同一天多个通告时，合并显示或分行显示
4. **坐标处理**：多个X坐标用逗号分隔

### 权限控制
- 议长：可以查看所有机师的通告预定表
- 舰长：可以查看所有机师的通告预定表（与议长权限相同）

### 数据验证
- 机师选择必填
- 年月选择必填
- 确保选择的机师存在且有效

## 开播注意事项

### 固定内容
在表格底部显示以下固定注意事项：

1. **提前到达**：请每日合理提前到达通告指定场地，通告开始时间为正式工作的开始时间。

2. **签到沟通**：到达通告场地后请先到值班运营处签到，与运营沟通本次通告的计划与准备情况，以及非通告期间个人社交账号的维护情况。

3. **完成确认**：通告规定任务结束后请到值班运营处确认通告完成情况后再离开通告场地。

## 扩展性考虑

### 未来扩展
- 支持多机师批量导出
- 支持自定义时间段导出
- 支持不同格式的导出（Excel、CSV等）
- 支持邮件发送功能

### 性能优化
- 大量数据时的分页处理
- 缓存机制优化
- 异步生成处理

## 测试策略

### 功能测试
- 机师选择功能测试
- 年月选择功能测试
- 表格生成功能测试
- 打印功能测试

### 数据测试
- 不同月份的数据展示
- 空数据情况处理
- 多通告情况处理
- 边界日期处理

### 权限测试
- 议长权限测试
- 舰长权限测试
- 未授权访问测试

## 部署说明

### 依赖要求
- 复用现有的数据模型和权限系统

### 配置要求
- 使用现有的时区设置

### 数据库影响
- 无需修改数据库结构
- 仅读取现有数据

## 总结

机师-作战计划导出功能是一个相对独立的功能模块，主要目的是将现有的通告数据以表格形式输出，便于打印和查看。该功能设计简洁，实现相对简单，但需要特别注意打印样式的优化和数据的完整性展示。

通过该功能，用户可以方便地生成指定机师的月度通告预定表，满足日常管理和打印需求。
