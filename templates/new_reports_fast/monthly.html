{% extends "base.html" %}

{% block title %}å¼€æ’­æ–°æœˆæŠ¥ - {{ pagination.month }}{% endblock %}

{% block content %}
<div id="monthlyReportApp" data-report-month="{{ pagination.month }}" data-selected-owner="{{ selected_owner }}" data-selected-mode="{{ selected_mode }}" data-selected-status="{{ selected_status }}">
  <div class="page-header">
    <h1 class="page-title">ğŸ“’ å¼€æ’­æ–°æœˆæŠ¥</h1>
  </div>

  <div class="date-navigation">
    <div class="date-controls">
      <a href="{{ url_for('new_report_fast.monthly_report_fast', month=pagination.prev_month, owner=selected_owner, mode=selected_mode, status=selected_status) }}" class="btn btn-secondary btn-sm">â† ä¸Šä¸ªæœˆ</a>
      <input type="month" id="monthSelector" value="{{ pagination.month }}" class="date-input">
      <a href="{{ url_for('new_report_fast.monthly_report_fast', month=pagination.next_month, owner=selected_owner, mode=selected_mode, status=selected_status) }}" class="btn btn-secondary btn-sm">ä¸‹ä¸ªæœˆ â†’</a>
    </div>
    <div class="export-actions">
      <a href="#" id="exportCsvBtn" class="btn btn-warning btn-sm">ğŸ“¥ å¯¼å‡ºCSV</a>
    </div>
  </div>

  <div class="filter-section">
    <div class="filter-controls">
      <label for="ownerSelector" class="filter-label">ç›´å±è¿è¥ï¼š</label>
      <select id="ownerSelector" class="filter-select" data-selected-owner="{{ selected_owner }}">
        <option value="all">å…¨éƒ¨</option>
      </select>

      <label for="modeSelector" class="filter-label">å¼€æ’­æ–¹å¼ï¼š</label>
      <select id="modeSelector" class="filter-select">
        <option value="all" {% if selected_mode == 'all' %}selected{% endif %}>å…¨éƒ¨</option>
        <option value="online" {% if selected_mode == 'online' %}selected{% endif %}>çº¿ä¸Š</option>
        <option value="offline" {% if selected_mode == 'offline' %}selected{% endif %}>çº¿ä¸‹</option>
      </select>

      <label for="statusSelector" class="filter-label">ä¸»æ’­çŠ¶æ€ï¼š</label>
      <select id="statusSelector" class="filter-select">
        <option value="all" {% if selected_status == 'all' %}selected{% endif %}>å…¨éƒ¨</option>
        <option value="not_recruited" {% if selected_status == 'not_recruited' %}selected{% endif %}>æœªæ‹›å‹Ÿ</option>
        <option value="not_recruiting" {% if selected_status == 'not_recruiting' %}selected{% endif %}>ä¸æ‹›å‹Ÿ</option>
        <option value="recruited" {% if selected_status == 'recruited' %}selected{% endif %}>å·²æ‹›å‹Ÿ</option>
        <option value="contracted" {% if selected_status == 'contracted' %}selected{% endif %}>å·²ç­¾çº¦</option>
        <option value="fallen" {% if selected_status == 'fallen' %}selected{% endif %}>æµå¤±</option>
      </select>
    </div>
  </div>

  <div class="summary-section">
    <div id="monthly-loading-state" class="loading-state">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>
    <div style="display: none;" id="monthly-content">
      <h2 class="section-title" id="monthly-summary-title"></h2>
      <div class="summary-cards blast-intro" data-animate-group="month" id="monthly-summary-cards"></div>
    </div>
  </div>

  <div class="details-section">
    <h2 class="section-title">æœˆæŠ¥æ˜ç»†</h2>
    <div class="table-container" id="monthly-table-container" style="display: none;">
      <table class="report-table">
        <thead>
          <tr>
            <th class="fixed-col sortable-header" data-sort-key="pilot_display" data-sort-type="string" tabindex="0" aria-sort="none">ä¸»æ’­
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="gender_age" data-sort-type="string" tabindex="0" aria-sort="none">æ€§åˆ«å¹´é¾„
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="owner" data-sort-type="string" tabindex="0" aria-sort="none">ç›´å±è¿è¥
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="rank" data-sort-type="string" tabindex="0" aria-sort="none">ä¸»æ’­åˆ†ç±»
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="records_count" data-sort-type="number" tabindex="0" aria-sort="none">æœˆç´¯è®¡å¼€æ’­è®°å½•æ•°
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="avg_duration" data-sort-type="number" tabindex="0" aria-sort="none">æœˆå‡æ’­æ—¶(å°æ—¶)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="total_revenue" data-sort-type="number" tabindex="0" aria-sort="none">æœˆç´¯è®¡æµæ°´(å…ƒ)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="daily_avg_profit" data-sort-type="number" tabindex="0" aria-sort="none">æ—¥å‡æ¯›åˆ©ï¼ˆå…ƒï¼‰
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="total_profit" data-sort-type="number" tabindex="0" aria-sort="none">æœˆç´¯è®¡æ¯›åˆ©(å…ƒ)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="total_pilot_share" data-sort-type="number" tabindex="0" aria-sort="none">æœˆç´¯è®¡ä¸»æ’­åˆ†æˆ(å…ƒ)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="total_company_share" data-sort-type="number" tabindex="0" aria-sort="none">æœˆç´¯è®¡å…¬å¸åˆ†æˆ(å…ƒ)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="rebate_rate" data-sort-type="number" tabindex="0" aria-sort="none">æœˆæœ€æ–°è¿”ç‚¹æ¯”ä¾‹(%)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="rebate_amount" data-sort-type="number" tabindex="0" aria-sort="none">æœˆç´¯è®¡è¿”ç‚¹(å…ƒ)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="total_base_salary" data-sort-type="number" tabindex="0" aria-sort="none">æœˆç´¯è®¡åº•è–ª(å…ƒ)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
          </tr>
        </thead>
        <tbody id="monthly-details-body"></tbody>
      </table>
    </div>
    <div class="empty-state" id="monthly-empty-state" style="display: none;">
      <p>æœ¬æœˆæš‚æ— å¼€æ’­è®°å½•</p>
    </div>
  </div>
</div>

<div class="chart-modal" id="metricChartModal" aria-hidden="true">
  <div class="chart-modal__dialog">
    <button type="button" class="chart-modal__close" id="metricChartClose" aria-label="å…³é—­å›¾è¡¨">Ã—</button>
    <h3 class="chart-modal__title" id="chartModalTitle"></h3>
    <div class="chart-modal__canvas">
      <canvas id="metricChartCanvas"></canvas>
    </div>
    <div class="chart-modal__switcher" id="chartMetricSwitcher"></div>
    <p class="chart-modal__hint">æ³¨ï¼šæ›²çº¿ä¸ºæŒ‰è‡ªç„¶æ—¥ç´¯è®¡å€¼ï¼Œå’Œå½“å‰è¿‡æ»¤æ¡ä»¶ä¿æŒä¸€è‡´</p>
  </div>
</div>

<style>

.date-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0;
  padding: 16px;
  background: var(--table-header);
  border-radius: 8px;
}

.date-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.date-input {
  padding: 8px 12px;
  border: 1px solid var(--gray);
  border-radius: 6px;
  font-size: 14px;
}

.export-actions {
  display: flex;
  gap: 8px;
}

.filter-section {
  margin: 16px 0;
  padding: 12px 16px;
  background: #f8f9fa;
  border-radius: 6px;
  border: 1px solid #e9ecef;
}

.filter-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  margin: 0;
  white-space: nowrap;
  flex-shrink: 0;
}

.filter-select {
  padding: 6px 12px;
  border: 1px solid var(--gray);
  border-radius: 4px;
  font-size: 14px;
  background: #fff;
  min-width: 120px;
}

.summary-section {
  margin: 24px 0;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.blast-intro {
  perspective: 800px;
  perspective-origin: 50% 35%;
}

.blast-intro .summary-card {
  transform: translateY(40px) translateZ(-120px) rotateZ(-8deg) rotateX(8deg) scale(0.6);
  opacity: 0;
  filter: blur(8px) saturate(0.9);
  will-change: transform, opacity, filter, box-shadow;
}

.blast-intro.play .summary-card {
  animation: blastIn 900ms cubic-bezier(0.2, 0.8, 0.2, 1.1) forwards;
}

.blast-intro.play .summary-card:nth-child(1) { animation-delay: 0ms; }
.blast-intro.play .summary-card:nth-child(2) { animation-delay: 80ms; }
.blast-intro.play .summary-card:nth-child(3) { animation-delay: 160ms; }
.blast-intro.play .summary-card:nth-child(4) { animation-delay: 240ms; }
.blast-intro.play .summary-card:nth-child(5) { animation-delay: 320ms; }
.blast-intro.play .summary-card:nth-child(6) { animation-delay: 400ms; }
.blast-intro.play .summary-card:nth-child(7) { animation-delay: 480ms; }

@keyframes blastIn {
  0%   { transform: translateY(40px) translateZ(-120px) rotateZ(-8deg) rotateX(8deg) scale(0.6); opacity: 0; filter: blur(8px) saturate(0.9); }
  60%  { transform: translateY(-6px) translateZ(20px) rotateZ(2deg) rotateX(-3deg) scale(1.04); opacity: 1; filter: blur(0) saturate(1); }
  85%  { transform: translateY(3px) translateZ(-10px) rotateZ(-1deg) rotateX(1deg) scale(0.99); opacity: 1; filter: blur(0) saturate(1); }
  100% { transform: translateY(0) translateZ(0) rotateZ(0) rotateX(0) scale(1); opacity: 1; filter: blur(0) saturate(1); }
}

.summary-card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  transition: box-shadow 0.2s ease;
}

.summary-card-clickable {
  cursor: pointer;
  position: relative;
}

.summary-card-clickable::after {
  content: 'ğŸ“ˆ';
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 16px;
}

.summary-card:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.summary-card.danger-outline {
  border-color: #dc3545;
}

.card-label {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}

.card-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--brand);
}


.details-section {
  margin: 24px 0;
}

.table-container {
  overflow-x: auto;
  border: 1px solid var(--gray);
  border-radius: 8px;
  background: #fff;
}

.report-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1600px;
}

.report-table th,
.report-table td {
  padding: 12px 8px;
  text-align: left;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

.report-table th {
  background: var(--table-header);
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 2;
}

.report-table th.fixed-col,
.report-table td.fixed-col {
  position: sticky;
  left: 0;
  background: #fff; 
  background-clip: padding-box;
  min-width: 120px;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.report-table td.fixed-col { z-index: 4; }
.report-table th.fixed-col { z-index: 5; }

.report-table td.fixed-col { box-shadow: 2px 0 0 #eee; }
.report-table th.fixed-col { box-shadow: 2px 0 0 #ddd; }

.report-table tbody tr:hover {
  background: #f8f9fa;
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

.chart-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  z-index: 2000;
}

.chart-modal.is-visible {
  display: flex;
}

.chart-modal__dialog {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  width: 100%;
  max-width: 720px;
  box-shadow: 0 12px 32px rgba(15, 23, 42, 0.25);
  position: relative;
}

.chart-modal__close {
  position: absolute;
  top: 12px;
  right: 12px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}

.chart-modal__title {
  margin: 0 0 12px;
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
}

.chart-modal__canvas {
  width: 100%;
  height: 320px;
}

.chart-modal__canvas canvas {
  width: 100% !important;
  height: 100% !important;
}

.chart-modal__hint {
  margin-top: 12px;
  font-size: 13px;
  color: var(--muted);
  text-align: right;
}

.chart-modal__switcher {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 12px;
}

.chart-switcher__btn {
  border: 1px solid var(--gray);
  background: #fff;
  border-radius: 20px;
  padding: 6px 14px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.chart-switcher__btn.is-active {
  border-color: var(--brand);
  background: rgba(54, 79, 199, 0.1);
  color: var(--brand);
}


.pilot-link {
  color: var(--brand);
  text-decoration: none;
  font-weight: 600;
}

.pilot-link:hover {
  color: var(--brand-dark);
  text-decoration: underline;
}

.pilot-link-fallen {
  color: #6c757d;
  text-decoration: none;
  font-weight: 600;
}

.pilot-link-fallen:hover {
  color: #545b62;
  text-decoration: underline;
}

.text-danger {
  color: #dc3545 !important;
  font-weight: 600;
}

.sortable-header {
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
  position: relative;
}

.sortable-header:focus-visible {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

.sort-indicator {
  display: inline-flex;
  margin-left: 4px;
  font-size: 12px;
  opacity: 0.45;
}

.sortable-header.is-sorted .sort-indicator {
  opacity: 0.9;
}

.sortable-header.is-sorted-asc .sort-indicator::before {
  content: 'â–²';
}

.sortable-header.is-sorted-desc .sort-indicator::before {
  content: 'â–¼';
}

.sortable-header:not(.is-sorted) .sort-indicator::before {
  content: 'â†•';
}


@media (max-width: 768px) {
  .date-navigation {
    flex-direction: column;
    gap: 12px;
  }

  .filter-controls {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .filter-select {
    width: 100%;
    min-width: auto;
  }

  .summary-cards {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }

  .summary-card {
    padding: 12px;
  }

  .card-value {
    font-size: 20px;
  }

  .report-table {
    font-size: 12px;
  }

  .report-table th,
  .report-table td {
    padding: 8px 6px;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
(function() {
  const app = document.getElementById('monthlyReportApp');
  if (!app) {
    return;
  }

  const ownerSelector = document.getElementById('ownerSelector');
  const modeSelector = document.getElementById('modeSelector');
  const statusSelector = document.getElementById('statusSelector');
  const monthSelector = document.getElementById('monthSelector');
  const summaryTitle = document.getElementById('monthly-summary-title');
  const summaryCards = document.getElementById('monthly-summary-cards');
  const tableContainer = document.getElementById('monthly-table-container');
  const detailsBody = document.getElementById('monthly-details-body');
  const emptyState = document.getElementById('monthly-empty-state');
  const emptyStateText = emptyState.querySelector('p');
  const operatorsApi = '{{ url_for('users_api.get_operators') }}';
  const monthlyApi = '{{ url_for('new_reports_fast_api.monthly_report_data_fast') }}';
  const reportPageUrl = '{{ url_for('new_report_fast.monthly_report_fast') }}';
  const pilotPerformanceTemplate = '{{ url_for('pilot.pilot_performance', pilot_id='__PID__') }}';
  const chartModal = document.getElementById('metricChartModal');
  const chartModalTitle = document.getElementById('chartModalTitle');
  const chartModalClose = document.getElementById('metricChartClose');
  const chartCanvas = document.getElementById('metricChartCanvas');
  const chartMetricSwitcher = document.getElementById('chartMetricSwitcher');
  const reportTable = document.querySelector('.report-table');
  const sortableHeaders = reportTable ? Array.from(reportTable.querySelectorAll('th[data-sort-key]')) : [];

  const rankMapping = {
    'å€™è¡¥æœºå¸ˆ': 'å€™é€‰äºº',
    'è®­ç»ƒæœºå¸ˆ': 'è¯•æ’­ä¸»æ’­',
    'å®ä¹ æœºå¸ˆ': 'å®ä¹ ä¸»æ’­',
    'æ­£å¼æœºå¸ˆ': 'æ­£å¼ä¸»æ’­'
  };

  const metricConfigs = {
    revenue: {
      field: 'revenue_cumulative',
      label: 'ç´¯è®¡æµæ°´',
      color: '#2563eb',
      background: 'rgba(37, 99, 235, 0.15)',
      barColor: 'rgba(37, 99, 235, 0.25)',
      showDaily: true,
    },
    basepay: {
      field: 'basepay_cumulative',
      label: 'ç´¯è®¡åº•è–ªæ”¯å‡º',
      color: '#f97316',
      background: 'rgba(249, 115, 22, 0.15)',
      barColor: 'rgba(249, 115, 22, 0.25)',
      showDaily: true,
    },
    pilot_share: {
      field: 'pilot_share_cumulative',
      label: 'ç´¯è®¡ä¸»æ’­åˆ†æˆ',
      color: '#7c3aed',
      background: 'rgba(124, 58, 237, 0.15)',
      barColor: 'rgba(124, 58, 237, 0.25)',
      showDaily: true,
    },
    company_share: {
      field: 'company_share_cumulative',
      label: 'ç´¯è®¡å…¬å¸åˆ†æˆ',
      color: '#059669',
      background: 'rgba(5, 150, 105, 0.15)',
      barColor: 'rgba(5, 150, 105, 0.25)',
      showDaily: true,
    },
    operating_profit: {
      field: 'operating_profit_cumulative',
      label: 'è¿è¥åˆ©æ¶¦ä¼°ç®—',
      color: '#b91c1c',
      background: 'rgba(185, 28, 28, 0.15)',
      showDaily: false,
    }
  };

  let metricChartInstance = null;
  let dailySeries = [];
  let currentMetricKey = null;

  let currentMonth = app.dataset.reportMonth;
  let currentDetails = [];
  let currentDetailsMonth = '';
  let currentSort = { key: null, direction: 'desc', type: null };
  let currentOwner = app.dataset.selectedOwner || 'all';
  let currentMode = app.dataset.selectedMode || 'all';
  let currentStatus = app.dataset.selectedStatus || 'all';
  const emptyFallbackText = emptyStateText ? emptyStateText.textContent : '';

  if (summaryCards) {
    summaryCards.addEventListener('click', handleSummaryCardClick);
  }
  if (chartModalClose) {
    chartModalClose.addEventListener('click', closeMetricModal);
  }
  if (chartModal) {
    chartModal.addEventListener('click', function(event) {
      if (event.target === chartModal) {
        closeMetricModal();
      }
    });
  }
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeMetricModal();
    }
  });
  if (chartMetricSwitcher) {
    chartMetricSwitcher.addEventListener('click', function(event) {
      const button = event.target.closest('button[data-metric]');
      if (!button) {
        return;
      }
      const metric = button.dataset.metric;
      if (metric && metric !== currentMetricKey) {
        renderMetricChart(metric);
      }
    });
  }

  function formatMoney(value) {
    if (value === null || value === undefined) {
      return 'Â¥0.00';
    }
    return 'Â¥' + Number(value).toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function formatHours(value) {
    if (value === null || value === undefined) {
      return '0.0å°æ—¶';
    }
    return Number(value).toFixed(1) + 'å°æ—¶';
  }

  function formatRate(value) {
    if (value === null || value === undefined) {
      return '0%';
    }
    return Math.round(Number(value) * 100) + '%';
  }

  function normalizeRank(value) {
    if (!value) {
      return '';
    }
    return rankMapping[value] || value;
  }

  function formatMonthDisplay(monthStr) {
    if (!monthStr) {
      return '';
    }
    const parts = monthStr.split('-');
    if (parts.length !== 2) {
      return monthStr;
    }
    return `${parts[0]}å¹´${parts[1]}æœˆ`;
  }

  function updateDailySeries(series) {
    dailySeries = Array.isArray(series) ? series : [];
  }

  function buildDailyValues(field) {
    const values = [];
    let previous = 0;
    dailySeries.forEach(item => {
      const current = Number(item[field] || 0);
      const delta = current - previous;
      values.push(delta < 0 ? 0 : delta);
      previous = current;
    });
    return values;
  }

  function initSorting() {
    if (!sortableHeaders.length) {
      return;
    }
    sortableHeaders.forEach(header => {
      header.addEventListener('click', () => handleHeaderSort(header));
      header.addEventListener('keydown', event => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          handleHeaderSort(header);
        }
      });
    });
    updateHeaderSortStates();
  }

  function handleHeaderSort(header) {
    if (!header || !currentDetails.length) {
      return;
    }
    const sortKey = header.dataset.sortKey;
    if (!sortKey) {
      return;
    }
    const sortType = header.dataset.sortType || 'string';
    let direction = 'asc';
    if (currentSort.key === sortKey) {
      direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else if (sortType === 'number') {
      direction = 'desc';
    }
    currentSort = { key: sortKey, direction, type: sortType };
    updateHeaderSortStates();
    renderSortedDetails();
  }

  function updateHeaderSortStates() {
    if (!sortableHeaders.length) {
      return;
    }
    sortableHeaders.forEach(header => {
      const isActive = currentSort.key && header.dataset.sortKey === currentSort.key;
      header.classList.toggle('is-sorted', Boolean(isActive));
      header.classList.toggle('is-sorted-asc', Boolean(isActive && currentSort.direction === 'asc'));
      header.classList.toggle('is-sorted-desc', Boolean(isActive && currentSort.direction === 'desc'));
      header.setAttribute('aria-sort', isActive ? (currentSort.direction === 'asc' ? 'ascending' : 'descending') : 'none');
    });
  }

  function extractSortValue(value, type) {
    if (type === 'number') {
      const numeric = Number(value);
      return Number.isNaN(numeric) ? 0 : numeric;
    }
    return (value || '').toString();
  }

  function sortDetailsData(dataset) {
    if (!currentSort.key) {
      return dataset;
    }
    const { key, direction, type } = currentSort;
    const multiplier = direction === 'asc' ? 1 : -1;
    dataset.sort((a, b) => {
      const valueA = extractSortValue(a[key], type);
      const valueB = extractSortValue(b[key], type);
      if (type === 'number') {
        if (valueA === valueB) {
          return 0;
        }
        return (valueA > valueB ? 1 : -1) * multiplier;
      }
      return valueA.localeCompare(valueB, 'zh-CN', { sensitivity: 'base' }) * multiplier;
    });
    return dataset;
  }

  function buildDetailRows(details, monthStr) {
    return details.map(detail => {
      const profitClass = detail.total_profit !== null && detail.total_profit < 0 ? 'text-danger' : '';
      const dailyProfitClass = detail.daily_avg_profit !== null && detail.daily_avg_profit < 0 ? 'text-danger' : '';
      const monthParam = monthStr ? encodeURIComponent(monthStr) : '';
      const pilotUrl = pilotPerformanceTemplate.replace('__PID__', detail.pilot_id) + `?from=monthly_report&month=${monthParam}`;

      // æ ¹æ®ä¸»æ’­çŠ¶æ€è®¾ç½®é“¾æ¥æ ·å¼ï¼šæµå¤±çŠ¶æ€çš„ä¸»æ’­ä½¿ç”¨ç°è‰²é“¾æ¥
      const isPilotFallen = detail.status === 'fallen' || detail.status === 'æµå¤±' || detail.status === 'å·²é˜µäº¡';
      const pilotLinkClass = isPilotFallen ? 'pilot-link-fallen' : 'pilot-link';

      return `<tr>
        <td class="fixed-col"><a href="${pilotUrl}" class="${pilotLinkClass}">${detail.pilot_display || ''}</a></td>
        <td>${detail.gender_age || ''}</td>
        <td>${detail.owner || ''}</td>
        <td>${normalizeRank(detail.rank)}</td>
        <td>${detail.records_count || 0}</td>
        <td>${formatHours(detail.avg_duration)}</td>
        <td>${formatMoney(detail.total_revenue)}</td>
        <td class="${dailyProfitClass}">${formatMoney(detail.daily_avg_profit)}</td>
        <td class="${profitClass}">${formatMoney(detail.total_profit)}</td>
        <td>${formatMoney(detail.total_pilot_share)}</td>
        <td>${formatMoney(detail.total_company_share)}</td>
        <td>${formatRate(detail.rebate_rate)}</td>
        <td>${formatMoney(detail.rebate_amount)}</td>
        <td>${formatMoney(detail.total_base_salary)}</td>
      </tr>`;
    }).join('');
  }

  function renderSortedDetails() {
    if (!currentDetails.length) {
      return;
    }
    const monthStr = currentDetailsMonth || currentMonth || '';
    const dataset = [...currentDetails];
    sortDetailsData(dataset);
    detailsBody.innerHTML = buildDetailRows(dataset, monthStr);
  }

  function handleSummaryCardClick(event) {
    const card = event.target.closest('.summary-card[data-metric]');
    if (!card) {
      return;
    }
    if (!dailySeries.length) {
      alert('å½“å‰ç­›é€‰æ¡ä»¶æš‚æ— å¯ç»˜åˆ¶æ•°æ®');
      return;
    }
    const metricKey = card.dataset.metric;
    const metricConfig = metricConfigs[metricKey];
    if (!metricConfig) {
      return;
    }
    const label = card.dataset.label || metricConfig.label;
    openMetricModal(metricKey, label);
  }

  function openMetricModal(metricKey, label) {
    if (!chartModal || !chartModalTitle) {
      return;
    }
    currentMetricKey = metricKey;
    chartModalTitle.textContent = `${label} - æŒ‰æ—¥ç´¯è®¡è¶‹åŠ¿`;
    chartModal.classList.add('is-visible');
    chartModal.setAttribute('aria-hidden', 'false');
    renderMetricChart(metricKey);
  }

  function closeMetricModal() {
    if (!chartModal) {
      return;
    }
    chartModal.classList.remove('is-visible');
    chartModal.setAttribute('aria-hidden', 'true');
    destroyMetricChart();
  }

  function destroyMetricChart() {
    if (metricChartInstance) {
      metricChartInstance.destroy();
      metricChartInstance = null;
    }
  }

  function renderChartMetricSwitcher(activeKey) {
    if (!chartMetricSwitcher) {
      return;
    }
    const metricOrder = ['revenue', 'basepay', 'pilot_share', 'company_share', 'operating_profit'];
    chartMetricSwitcher.innerHTML = metricOrder.filter(key => metricConfigs[key]).map(key => {
      const activeClass = key === activeKey ? ' is-active' : '';
      return `<button type="button" class="chart-switcher__btn${activeClass}" data-metric="${key}">${metricConfigs[key].label}</button>`;
    }).join('');
  }

  function renderMetricChart(metricKey) {
    if (!chartCanvas || typeof Chart === 'undefined') {
      return;
    }
    const config = metricConfigs[metricKey];
    if (!config) {
      return;
    }
    const labels = dailySeries.map(item => item.date);
    const cumulativeValues = dailySeries.map(item => Number(item[config.field] || 0));
    const dailyValues = config.showDaily === false ? [] : buildDailyValues(config.field);
    if (!labels.length) {
      return;
    }
    destroyMetricChart();
    currentMetricKey = metricKey;
    renderChartMetricSwitcher(metricKey);
    const ctx = chartCanvas.getContext('2d');
    const datasets = [];
    if (config.showDaily !== false) {
      datasets.push({
        type: 'bar',
        label: `${config.label}ï¼ˆå½“æ—¥ï¼‰`,
        data: dailyValues,
        backgroundColor: config.barColor,
        borderColor: config.color,
        borderWidth: 1,
        borderRadius: 4,
        barPercentage: 0.8,
        categoryPercentage: 0.7,
        order: 1,
      });
    }
    datasets.push({
      type: 'line',
      label: `${config.label}ï¼ˆç´¯è®¡ï¼‰`,
      data: cumulativeValues,
      fill: true,
      borderColor: config.color,
      backgroundColor: config.background,
      borderWidth: 2,
      pointRadius: 2.5,
      tension: 0.25,
      order: 2,
    });

    const combinedValues = [...cumulativeValues];
    if (config.showDaily !== false) {
      combinedValues.push(...dailyValues);
    }
    const minValue = combinedValues.length ? Math.min(...combinedValues) : 0;
    const maxValue = combinedValues.length ? Math.max(...combinedValues) : 0;

    metricChartInstance = new Chart(ctx, {
      data: {
        labels,
        datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label(context) {
                const value = context.parsed.y ?? context.parsed;
                const dsLabel = context.dataset && context.dataset.label ? context.dataset.label : config.label;
                return `${dsLabel}: ${formatMoney(value)}`;
              }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              autoSkip: true,
              maxRotation: 0,
              minRotation: 0
            }
          },
          y: {
            ticks: {
              callback(value) {
                return formatMoney(value);
              }
            },
            suggestedMin: Math.min(0, minValue * 1.05),
            suggestedMax: Math.max(0, maxValue * 1.05),
          }
        }
      }
    });
  }

  function buildSummaryCards(summary) {
    const rebateSum = summary.rebate_sum || 0;
    const operatingProfit = summary.operating_profit || 0;

    const items = [
      { label: 'æ€»ä¸»æ’­æ•°é‡', value: (summary.pilot_count || 0).toLocaleString('zh-CN') },
      { label: 'ç´¯è®¡æµæ°´', value: formatMoney(summary.revenue_sum || 0), chartMetric: 'revenue' },
      {
        label: 'ç´¯è®¡åº•è–ªæ”¯å‡º',
        value: formatMoney(summary.basepay_sum || 0),
        sub: summary.conversion_rate !== null && summary.conversion_rate !== undefined ? `è½¬æ¢ç‡${summary.conversion_rate}%` : '',
        chartMetric: 'basepay'
      },
      { label: 'ç´¯è®¡è¿”ç‚¹', value: formatMoney(rebateSum) },
      { label: 'ç´¯è®¡ä¸»æ’­åˆ†æˆ', value: formatMoney(summary.pilot_share_sum || 0), chartMetric: 'pilot_share' },
      { label: 'ç´¯è®¡å…¬å¸åˆ†æˆ', value: formatMoney(summary.company_share_sum || 0), chartMetric: 'company_share' },
      { label: 'è¿è¥åˆ©æ¶¦ä¼°ç®—', value: formatMoney(operatingProfit), danger: operatingProfit < 0, chartMetric: 'operating_profit' }
    ];

    summaryCards.innerHTML = items.map(item => {
      const dangerClass = item.danger ? ' danger-outline' : '';
      const clickableClass = item.chartMetric ? ' summary-card-clickable' : '';
      const metricAttr = item.chartMetric ? ` data-metric="${item.chartMetric}" data-label="${item.label}"` : '';
      const subHtml = item.sub ? `<div class="card-sub">${item.sub}</div>` : '';
      return `<div class="summary-card${dangerClass}${clickableClass}"${metricAttr}>
        <div class="card-label">${item.label}</div>
        <div class="card-value">${item.value}</div>
        ${subHtml}
      </div>`;
    }).join('');

    summaryCards.classList.remove('play');
    void summaryCards.offsetWidth;
    summaryCards.classList.add('play');
  }

  function renderDetails(details, monthStr) {
    currentDetailsMonth = monthStr || currentMonth || '';
    currentDetails = Array.isArray(details) ? details.slice() : [];
    if (!currentDetails.length) {
      detailsBody.innerHTML = '';
      tableContainer.style.display = 'none';
      if (emptyStateText) {
        emptyStateText.textContent = emptyFallbackText;
      }
      emptyState.style.display = 'block';
      updateHeaderSortStates();
      return;
    }
    emptyState.style.display = 'none';
    tableContainer.style.display = 'block';
    updateHeaderSortStates();
    renderSortedDetails();
  }

  function showLoading() {
    const loadingState = document.getElementById('monthly-loading-state');
    const content = document.getElementById('monthly-content');
    const tableContainer = document.getElementById('monthly-table-container');
    const emptyState = document.getElementById('monthly-empty-state');

    loadingState.style.display = 'block';
    content.style.display = 'none';
    tableContainer.style.display = 'none';
    emptyState.style.display = 'none';
  }

  function showError(message) {
    const loadingState = document.getElementById('monthly-loading-state');
    const content = document.getElementById('monthly-content');
    const tableContainer = document.getElementById('monthly-table-container');
    const emptyState = document.getElementById('monthly-empty-state');
    const emptyStateText = emptyState.querySelector('p');

    loadingState.style.display = 'none';
    content.style.display = 'block';
    summaryTitle.textContent = 'åŠ è½½å¤±è´¥';
    summaryCards.innerHTML = '';
    detailsBody.innerHTML = '';
    tableContainer.style.display = 'none';
    if (emptyStateText) {
      emptyStateText.textContent = message;
    }
    emptyState.style.display = 'block';
  }

  async function loadOwnerOptions() {
    try {
      const response = await fetch(operatorsApi);
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error ? payload.error.message : 'åŠ è½½è¿è¥å¤±è´¥');
      }
      const operators = payload.data || [];
      operators.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.nickname || user.username || user.id;
        ownerSelector.appendChild(option);
      });
      ownerSelector.value = currentOwner;
    } catch (error) {
      console.error('åŠ è½½ç›´å±è¿è¥åˆ—è¡¨å¤±è´¥ï¼š', error);
      ownerSelector.value = currentOwner;
    }
  }

  function buildMonthlyApiUrl() {
    const params = new URLSearchParams();
    if (currentMonth) {
      params.set('month', currentMonth);
    }
    if (currentOwner && currentOwner !== 'all') {
      params.set('owner', currentOwner);
    }
    if (currentMode && currentMode !== 'all') {
      params.set('mode', currentMode);
    }
    if (currentStatus && currentStatus !== 'all') {
      params.set('status', currentStatus);
    }
    return `${monthlyApi}?${params.toString()}`;
  }

  async function loadMonthlyReport() {
    showLoading();
    try {
      const response = await fetch(buildMonthlyApiUrl());
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error ? payload.error.message : 'åŠ è½½å¤±è´¥');
      }
      const data = payload.data;
      const filters = payload.meta ? payload.meta.filters : null;
      currentMonth = data.month;
      if (filters) {
        currentOwner = filters.owner || 'all';
        currentMode = filters.mode || 'all';
        currentStatus = filters.status || 'all';
      }
      monthSelector.value = currentMonth;
      ownerSelector.value = currentOwner;
      modeSelector.value = currentMode;
      statusSelector.value = currentStatus;
      // éšè—loadingçŠ¶æ€ï¼Œæ˜¾ç¤ºå†…å®¹
      const loadingState = document.getElementById('monthly-loading-state');
      const content = document.getElementById('monthly-content');
      loadingState.style.display = 'none';
      content.style.display = 'block';

      summaryTitle.textContent = `${formatMonthDisplay(currentMonth)} æœˆåº¦æ±‡æ€»`;
      updateDailySeries(data.daily_series || []);
      buildSummaryCards(data.summary || {});
      renderDetails(data.details || [], currentMonth);
    } catch (error) {
      console.error('åŠ è½½å¼€æ’­æ–°æœˆæŠ¥å¤±è´¥ï¼š', error);
      showError('æŠ¥è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
  }

  function navigate(params) {
    const url = new URL(reportPageUrl, window.location.origin);
    const targetMonth = params.month || currentMonth;
    const targetOwner = params.owner !== undefined ? params.owner : currentOwner;
    const targetMode = params.mode !== undefined ? params.mode : currentMode;
    const targetStatus = params.status !== undefined ? params.status : currentStatus;
    if (targetMonth) {
      url.searchParams.set('month', targetMonth);
    }
    url.searchParams.set('owner', targetOwner || 'all');
    url.searchParams.set('mode', targetMode || 'all');
    url.searchParams.set('status', targetStatus || 'all');
    window.location.href = url.toString();
  }

  monthSelector.addEventListener('change', function() {
    if (this.value) {
      navigate({ month: this.value });
    }
  });

  ownerSelector.addEventListener('change', function() {
    navigate({ owner: this.value || 'all' });
  });

  modeSelector.addEventListener('change', function() {
    navigate({ mode: this.value || 'all' });
  });

  statusSelector.addEventListener('change', function() {
    navigate({ status: this.value || 'all' });
  });

  // CSVå¯¼å‡ºæŒ‰é’®äº‹ä»¶å¤„ç†å™¨ - æ·»åŠ æ—¶é—´æˆ³é¿å…CDNç¼“å­˜
  const exportCsvBtn = document.getElementById('exportCsvBtn');
  if (exportCsvBtn) {
    exportCsvBtn.addEventListener('click', function(e) {
      e.preventDefault();

      // æ„å»ºåŸºç¡€å¯¼å‡ºURL
      const exportUrl = '{{ url_for("new_report_fast.export_monthly_fast_csv") }}';
      const url = new URL(exportUrl, window.location.origin);

      // æ·»åŠ å½“å‰ç­›é€‰å‚æ•°
      url.searchParams.set('month', currentMonth);
      url.searchParams.set('owner', currentOwner || 'all');
      url.searchParams.set('mode', currentMode || 'all');
      url.searchParams.set('status', currentStatus || 'all');

      // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…CDNç¼“å­˜
      const timestamp = Date.now();
      url.searchParams.set('_t', timestamp.toString());

      // åˆ›å»ºä¸´æ—¶ä¸‹è½½é“¾æ¥
      const tempLink = document.createElement('a');
      tempLink.href = url.toString();
      tempLink.style.display = 'none';
      document.body.appendChild(tempLink);
      tempLink.click();
      document.body.removeChild(tempLink);
    });
  }

  (async function init() {
    await loadOwnerOptions();
    initSorting();
    await loadMonthlyReport();
  })();
})();
</script>
{% endblock %}
