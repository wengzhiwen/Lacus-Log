{% extends "base.html" %}

{% block title %}通告详情 - Lacus-Log{% endblock %}

{% block content %}
<div id="loading-indicator" style="text-align: center; padding: 100px 20px;">
  <div style="display: inline-block; border: 4px solid rgba(59, 130, 246, 0.1); border-top: 4px solid var(--brand); border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite;"></div>
  <p style="margin-top: 20px; color: var(--muted);">加载中...</p>
</div>

<div id="error-indicator" style="display: none; text-align: center; padding: 100px 20px;">
  <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
  <h2 style="color: var(--error); margin-bottom: 10px;">加载失败</h2>
  <p id="error-message" style="color: var(--muted);"></p>
  <button class="btn btn-primary" onclick="location.href='/announcements'" style="margin-top: 20px;">返回通告列表</button>
</div>

<section class="announcement-detail" id="detail-content" style="display: none;">
  <div class="back-nav">
    <a class="btn btn-secondary" href="#" id="back-btn">
      <span>←</span>
      <span id="back-text">返回</span>
    </a>
  </div>

  <div class="pilot-info-card">
    <div class="card-header">
      <div class="pilot-main-info">
        <div class="pilot-name"><a href="#" id="pilot-link"></a></div>
        <div class="pilot-real-name" id="pilot-real-name"></div>
        <div class="pilot-badges" id="pilot-badges"></div>
      </div>
    </div>
    <div class="pilot-basic-info">
      <div class="info-item">
        <span class="info-label">性别/年龄：</span>
        <span class="info-value" id="pilot-gender-age"></span>
      </div>
      <div class="info-item">
        <span class="info-label">直属运营：</span>
        <span class="info-value" id="pilot-owner"></span>
      </div>
    </div>
  </div>

  <div class="announcement-info-card">
    <div class="info-section">
      <h3 class="section-title">基础信息</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">开播地点</div>
          <div class="info-value coords" id="coords"></div>
        </div>
        <div class="info-item">
          <div class="info-label">开播平台</div>
          <div class="info-value" id="platform"></div>
        </div>
      </div>
    </div>

    <div class="info-section">
      <h3 class="section-title">时间信息</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">开始时间</div>
          <div class="info-value" id="start-time"></div>
        </div>
        <div class="info-item">
          <div class="info-label">计划时长</div>
          <div class="info-value" id="duration"></div>
        </div>
        <div class="info-item">
          <div class="info-label">结束时间</div>
          <div class="info-value" id="end-time"></div>
        </div>
        <div class="info-item">
          <div class="info-label">循环规则</div>
          <div class="info-value" id="recurrence"></div>
        </div>
      </div>
    </div>

    <div class="info-section" id="recurrence-section" style="display: none;">
      <h3 class="section-title">循环信息</h3>
      <div class="info-grid" id="recurrence-end-grid" style="display: none;">
        <div class="info-item">
          <div class="info-label">循环结束</div>
          <div class="info-value" id="recurrence-end"></div>
        </div>
      </div>

      <div class="related-events" id="related-events" style="display: none;">
        <h4 id="related-events-title"></h4>
        <div class="events-list" id="events-list"></div>
      </div>
    </div>

    <div class="info-section">
      <h3 class="section-title">系统信息</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">创建时间</div>
          <div class="info-value" id="created-at"></div>
        </div>
        <div class="info-item">
          <div class="info-label">最后修改</div>
          <div class="info-value" id="updated-at"></div>
        </div>
        <div class="info-item">
          <div class="info-label">创建用户</div>
          <div class="info-value" id="created-by"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="footbar" id="footbar" style="display: none;">
    <div class="inner">
        <button type="button" class="btn btn-primary" id="edit-btn">编辑</button>
        
        <a href="#" class="btn btn-hud" id="record-btn">
            登录开播记录
        </a>

        <button type="button" class="btn btn-warning" onclick="showDeleteModal()">删除</button>

        <button type="button" class="btn btn-outline" onclick="showChangesModal()">变更记录</button>
    </div>
</div>

<div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h4>选择编辑范围</h4>
        <p>请选择要编辑的范围：</p>
        <div class="edit-options">
            <a href="#" id="edit-this-link" class="option-link">
                <div class="option-card">
                    <h5>仅编辑这一次</h5>
                    <p>只修改当前这个通告，不影响其他循环事件</p>
                </div>
            </a>
            <a href="#" id="edit-future-link" class="option-link">
                <div class="option-card">
                    <h5>编辑未来所有</h5>
                    <p>修改从当前开始的所有未来循环事件</p>
                </div>
            </a>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideEditModal()">取消</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h4>确认删除</h4>
        <div id="delete-recurrence-options" style="display: none;">
            <p>请选择删除范围：</p>
            <div class="delete-option-buttons">
                <button type="button" class="btn btn-warning" onclick="confirmDelete('this_only')">只删除这一次</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete('future_all')">删除未来所有</button>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="hideDeleteModal()">取消</button>
            </div>
        </div>
        <div id="delete-single-options">
            <p>确定要删除这个通告吗？此操作不可恢复。</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-danger" onclick="confirmDelete('this_only')">确认删除</button>
                <button type="button" class="btn btn-outline" onclick="hideDeleteModal()">取消</button>
            </div>
        </div>
    </div>
</div>

<div id="changesModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h4>变更记录</h4>
        <div id="changesContent">
            <div class="loading">加载中...</div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideChangesModal()">关闭</button>
        </div>
    </div>
</div>

<style>
@keyframes spin {
  to { transform: rotate(360deg); }
}

.announcement-detail {
  padding: 20px;
  padding-bottom: 100px;
}

.back-nav {
  margin-bottom: 20px;
}

.pilot-info-card, .announcement-info-card {
  background: white;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
}

.card-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--table-header);
}

.pilot-main-info {
  flex: 1;
}

.pilot-name {
  font-size: 20px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.pilot-name a {
  color: var(--brand);
  text-decoration: underline;
}

.pilot-name a:hover {
  text-decoration: underline;
}

.pilot-real-name {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}

.pilot-badges {
  display: flex;
  gap: 8px;
}

.rank-badge, .status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}

.rank-候补机师, .rank-候选人, .rank-trainee { background: var(--table-header); color: var(--text); }
.rank-训练机师, .rank-试播主播, .rank-实习主播, .rank-正式主播 { background: var(--brand); color: white; }

.status-未征召, .status-未招募 { background: var(--table-header); color: var(--text); }
.status-已征召, .status-已招募, .status-已签约 { background: var(--hud-green); color: white; }
.status-不征召, .status-不招募, .status-已阵亡, .status-流失 { background: var(--error); color: white; }

.pilot-basic-info {
  display: grid;
  gap: 8px;
}

.pilot-basic-info .info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 14px;
}

.pilot-basic-info .info-label {
  color: var(--muted);
  font-weight: 500;
}

.pilot-basic-info .info-value {
  color: var(--text);
}

.info-section {
  margin-bottom: 20px;
}

.info-section:last-child {
  margin-bottom: 0;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 12px;
}

.info-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.info-item.full-width {
  grid-column: 1 / -1;
}

.info-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.info-value {
  font-size: 14px;
  color: var(--text);
}

.info-value.coords {
  font-family: monospace;
  background: #f5f5f5;
  padding: 4px 8px;
  border-radius: 4px;
  display: inline-block;
}

.related-events {
  margin-top: 16px;
}

.related-events h4 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

.events-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.event-item {
  border: 1px solid var(--table-header);
  border-radius: 4px;
  overflow: hidden;
  transition: all 0.2s ease;
}

.event-item.current {
  background: var(--hud-green);
  border-color: var(--hud-green);
}

.event-item a {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  color: var(--text);
  text-decoration: none;
  transition: background 0.2s ease;
}

.event-item.current a {
  color: white;
}

.event-item:not(.current):hover {
  background: var(--table-header);
}

.event-time {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
}

.event-duration {
  font-size: 12px;
  color: var(--muted);
}

.event-item.current .event-duration {
  color: rgba(255, 255, 255, 0.8);
}

.current-indicator {
  background: white;
  color: var(--hud-green);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.footbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  border-top: 1px solid var(--table-header);
  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
  padding: 12px;
  z-index: 1;
}

.footbar .inner {
  display: flex;
  gap: 12px;
  justify-content: center;
  max-width: 1200px;
  margin: 0 auto;
}

.footbar .btn {
  flex: 1 1 auto;
  min-width: 100px;
  max-width: 200px;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.2s ease;
}

.modal-content {
  background: white;
  border-radius: 8px;
  padding: 24px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  animation: slideIn 0.3s ease;
}

.modal-content h4 {
  margin: 0 0 16px 0;
  color: var(--text);
  font-size: 18px;
}

.modal-content p {
  margin: 0 0 16px 0;
  color: var(--muted);
  line-height: 1.5;
}

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 20px;
}

.loading {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

.btn-warning {
  background: #ffc107;
  color: #212529;
}

.btn-warning:hover {
  background: #e0a800;
  color: #212529;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background: #545b62;
}

.edit-options {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin: 20px 0;
}

.option-link {
  text-decoration: none;
  color: inherit;
}

.option-card {
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 20px;
  transition: all 0.2s ease;
  cursor: pointer;
}

.option-card:hover {
  border-color: #007bff;
  background: #f8f9ff;
}

.option-card h5 {
  margin: 0 0 8px 0;
  color: #007bff;
  font-size: 16px;
}

.option-card p {
  margin: 0;
  color: #666;
  font-size: 14px;
}

.delete-option-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 20px 0;
}

.delete-option-buttons .btn {
  width: 100%;
}

.btn-hud {
  background: var(--hud-green);
  color: #fff;
}
.btn-hud:hover { background: #00a16e; }

.btn-outline {
  background: #fff;
  color: var(--text);
  border: 1px solid var(--gray);
}
.btn-outline:hover {
  background: var(--table-header);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { transform: translateY(-50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

@media (max-width: 768px) {
  .announcement-detail {
    padding: 16px;
    padding-bottom: 100px;
  }
  
  .info-grid {
    grid-template-columns: 1fr;
  }
  
  .modal-content {
    width: 95%;
    padding: 20px;
  }
  
  .footbar .inner {
    flex-direction: row;
    gap: 8px;
  }
  
  .footbar .btn {
    flex: 1 1 auto;
    min-width: 70px;
    max-width: none;
    font-size: 14px;
    padding: 12px 8px;
  }
}
</style>

<script>
const announcementId = '{{ announcement_id }}';
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
let announcementData = null;
let fromParam = new URLSearchParams(window.location.search).get('from') || '';
let dateParam = new URLSearchParams(window.location.search).get('date') || '';

async function fetchJson(url, options = {}) {
    const response = await fetch(url, options);
    const result = await response.json();
    if (!result.success) {
        const error = new Error(result.error?.message || '请求失败');
        error.response = result;
        error.status = response.status;
        throw error;
    }
    return result;
}

async function loadAnnouncementDetail() {
    try {
        const result = await fetchJson(`/announcements/api/announcements/${announcementId}`);
        announcementData = result.data;
        renderAnnouncementDetail(announcementData);
        
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('detail-content').style.display = 'block';
        document.getElementById('footbar').style.display = 'block';
    } catch (error) {
        console.error('加载通告详情失败:', error);
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('error-indicator').style.display = 'block';
        document.getElementById('error-message').textContent = error.message || '网络错误';
    }
}

function renderAnnouncementDetail(data) {
    const pilot = data.pilot;
    
    // 返回按钮
    const backBtn = document.getElementById('back-btn');
    const backText = document.getElementById('back-text');
    if (fromParam === 'calendar' && dateParam) {
        backBtn.href = `/calendar/day?date=${dateParam}`;
        backText.textContent = '返回日历';
    } else {
        backBtn.href = '/announcements';
        backText.textContent = '返回通告列表';
    }
    
    // 主播信息
    document.querySelector('#pilot-link').textContent = pilot.nickname || '';
    document.querySelector('#pilot-link').href = `/pilots/${pilot.id}?from=announcement_detail&announcement_id=${announcementId}`;
    document.getElementById('pilot-real-name').textContent = pilot.real_name || '未填写姓名';
    
    const badges = document.getElementById('pilot-badges');
    badges.innerHTML = `
        <span class="rank-badge rank-${(pilot.rank || '').replace(/\s/g, '')}">${pilot.rank || ''}</span>
        <span class="status-badge status-${(pilot.status || '').replace(/\s/g, '')}">${pilot.status || ''}</span>
    `;
    
    let genderAge = pilot.gender || '';
    if (pilot.age) {
        genderAge += genderAge ? `/${pilot.age}岁` : `${pilot.age}岁`;
    }
    document.getElementById('pilot-gender-age').textContent = genderAge || '未填写';
    
    const owner = pilot.owner;
    document.getElementById('pilot-owner').textContent = owner ? owner.display_name : '无';
    
    // 通告信息
    document.getElementById('coords').textContent = data.coordinates.display;
    document.getElementById('platform').textContent = pilot.platform || '';
    document.getElementById('start-time').textContent = data.time.start || '';
    document.getElementById('duration').textContent = data.time.duration || '';
    document.getElementById('end-time').textContent = data.time.end || '';
    document.getElementById('recurrence').textContent = data.recurrence.display || '';
    
    // 循环信息
    if (data.recurrence.is_in_group || data.related_announcements.length > 0) {
        document.getElementById('recurrence-section').style.display = 'block';
        
        if (data.recurrence.end) {
            document.getElementById('recurrence-end-grid').style.display = 'grid';
            document.getElementById('recurrence-end').textContent = data.recurrence.end;
        }
        
        if (data.related_announcements.length > 0) {
            document.getElementById('related-events').style.display = 'block';
            document.getElementById('related-events-title').textContent = `相关事件（${data.related_announcements.length}个）`;
            
            const eventsList = document.getElementById('events-list');
            eventsList.innerHTML = '';
            
            data.related_announcements.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'event-item' + (event.is_current ? ' current' : '');
                
                const link = document.createElement('a');
                const linkUrl = `/announcements/${event.id}`;
                link.href = fromParam === 'calendar' && dateParam ? `${linkUrl}?from=calendar&date=${dateParam}` : linkUrl;
                link.innerHTML = `
                    <span class="event-time">${event.start_time}</span>
                    <span class="event-duration">${event.duration}</span>
                    ${event.is_current ? '<span class="current-indicator">当前</span>' : ''}
                `;
                
                eventDiv.appendChild(link);
                eventsList.appendChild(eventDiv);
            });
        }
    }
    
    // 系统信息
    document.getElementById('created-at').textContent = data.audit.created_at || '';
    document.getElementById('updated-at').textContent = data.audit.updated_at || '';
    document.getElementById('created-by').textContent = data.audit.created_by ? data.audit.created_by.display_name : '';
    
    // 编辑按钮
    const editBtn = document.getElementById('edit-btn');
    if (data.recurrence.is_in_group) {
        editBtn.onclick = showEditModal;
        const baseUrl = `/announcements/${announcementId}/edit`;
        const urlParams = fromParam === 'calendar' && dateParam ? `&from=calendar&date=${dateParam}` : '';
        document.getElementById('edit-this-link').href = `${baseUrl}?edit_scope=this_only${urlParams}`;
        document.getElementById('edit-future-link').href = `${baseUrl}?edit_scope=future_all${urlParams}`;
    } else {
        editBtn.onclick = function() {
            const editUrl = `/announcements/${announcementId}/edit`;
            window.location.href = fromParam === 'calendar' && dateParam ? `${editUrl}?from=calendar&date=${dateParam}` : editUrl;
        };
    }
    
    // 登录开播记录按钮
    document.getElementById('record-btn').href = `/battle-records/new?announcement_id=${announcementId}`;
    
    // 删除模态框选项
    if (data.recurrence.is_in_group) {
        document.getElementById('delete-recurrence-options').style.display = 'block';
        document.getElementById('delete-single-options').style.display = 'none';
    } else {
        document.getElementById('delete-recurrence-options').style.display = 'none';
        document.getElementById('delete-single-options').style.display = 'block';
    }
}

function showEditModal() {
    document.getElementById('editModal').style.display = 'flex';
}

function hideEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

function showDeleteModal() {
    document.getElementById('deleteModal').style.display = 'flex';
}

function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

function confirmDelete(scope) {
    const message = scope === 'future_all'
        ? '确定删除从当前开始的所有未来循环通告吗？此操作不可恢复。'
        : '确定删除当前通告吗？此操作不可恢复。';
    if (!window.confirm(message)) {
        return;
    }
    deleteAnnouncement(scope);
}

async function deleteAnnouncement(scope) {
    try {
        const result = await fetchJson(`/announcements/api/announcements/${announcementId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ delete_scope: scope }),
        });
        const meta = result.meta || {};
        showMessage(meta.message || '删除通告成功', 'success');
        hideDeleteModal();
        if (fromParam === 'calendar' && dateParam) {
            window.location.href = `/calendar/day?date=${dateParam}`;
        } else {
            window.location.href = '/announcements';
        }
    } catch (error) {
        console.error('删除通告失败:', error);
        showMessage(error.message || '删除通告失败', 'error');
        hideDeleteModal();
    }
}

function showChangesModal() {
    const modal = document.getElementById('changesModal');
    const content = document.getElementById('changesContent');
    modal.style.display = 'flex';
    content.innerHTML = '<div class="loading">加载中...</div>';
    
    fetchJson(`/announcements/api/announcements/${announcementId}/changes`)
        .then(result => {
            if (result.data && result.data.length > 0) {
                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
                html += '<thead><tr style="background: var(--table-header);">';
                html += '<th style="padding: 8px; text-align: left; border: 1px solid var(--table-header);">变更时间</th>';
                html += '<th style="padding: 8px; text-align: left; border: 1px solid var(--table-header);">操作人</th>';
                html += '<th style="padding: 8px; text-align: left; border: 1px solid var(--table-header);">字段名</th>';
                html += '<th style="padding: 8px; text-align: left; border: 1px solid var(--table-header);">原值</th>';
                html += '<th style="padding: 8px; text-align: left; border: 1px solid var(--table-header);">新值</th>';
                html += '<th style="padding: 8px; text-align: left; border: 1px solid var(--table-header);">IP地址</th>';
                html += '</tr></thead><tbody>';
                
                result.data.forEach(change => {
                    html += '<tr>';
                    html += `<td style="padding: 8px; border: 1px solid var(--table-header);">${change.change_time}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid var(--table-header);">${change.user_name}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid var(--table-header);">${change.field_name}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid var(--table-header);">${change.old_value || '空'}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid var(--table-header);">${change.new_value || '空'}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid var(--table-header);">${change.ip_address}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                content.innerHTML = html;
            } else {
                content.innerHTML = '<div class="loading">暂无变更记录</div>';
            }
        })
        .catch(error => {
            content.innerHTML = '<div class="loading" style="color: var(--error);">加载失败：网络错误</div>';
        });
}

function hideChangesModal() {
    document.getElementById('changesModal').style.display = 'none';
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    if (!announcementId) {
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('error-indicator').style.display = 'block';
        document.getElementById('error-message').textContent = '缺少通告ID';
        return;
    }
    
    loadAnnouncementDetail();
});
</script>
{% endblock %}
