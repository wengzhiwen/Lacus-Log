{% extends 'base.html' %}
{% block title %}å¼€æ’­è®°å½•è¯¦æƒ… - Lacus-Log{% endblock %}
{% block content %}
<div class="container">
  <div class="back-nav">
    {% if from_param == 'base_salary_detail' and application_id %}
    <a class="btn btn-secondary" href="/reports/base-salary-applications/detail?id={{ application_id }}">
      <span>â†</span>
      è¿”å›åº•è–ªç”³è¯·è¯¦æƒ…
    </a>
    {% else %}
    <a class="btn btn-secondary" href="{{ url_for('battle_record.list_battle_records') }}">
      <span>â†</span>
      è¿”å›å¼€æ’­è®°å½•
    </a>
    {% endif %}
  </div>

<section class="battle-record-detail">
  <div class="page-header">
    <h1 class="page-title">å¼€æ’­è®°å½•è¯¦æƒ…</h1>
  </div>

  <div class="detail-card">
    <div class="card-section">
      <h3 class="section-title">åŸºæœ¬ä¿¡æ¯</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>ä¸»æ’­</label>
          <div class="value">
            {% set age_str = '(' ~ battle_record.pilot.age ~ ')' if battle_record.pilot.age else '' %}
            {% set gender_icon = 'â™‚' if battle_record.pilot.gender.value == 0 else ('â™€' if battle_record.pilot.gender.value == 1 else '?') %}
            <span><a href="{{ url_for('pilot.pilot_detail', pilot_id=battle_record.pilot.id, from='battle_record_detail', record_id=battle_record.id) }}">{{ battle_record.pilot.nickname }}</a>{{ age_str }}[{{ battle_record.pilot.status.value }}]{{ gender_icon }}</span>
            <a href="{{ url_for('pilot.pilot_performance', pilot_id=battle_record.pilot.id, from='battle_record_detail', record_id=battle_record.id) }}" class="performance-link">ä¸šç»©æŸ¥çœ‹</a>
          </div>
        </div>
        <div class="detail-item">
          <label>ç›´å±è¿è¥</label>
          <div class="value">{{ (battle_record.owner_snapshot.nickname or battle_record.owner_snapshot.username) if battle_record.owner_snapshot else 'æ— ' }}</div>
        </div>
        
        <div class="detail-item full-width">
          <label>å…³è”é€šå‘Š</label>
          <div class="value">
            {% if related_announcement_deleted %}
              å…³è”é€šå‘Šå·²è¢«åˆ é™¤
            {% elif related_announcement %}
              {% set weekday_map = {'0':'æ—¥','1':'ä¸€','2':'äºŒ','3':'ä¸‰','4':'å››','5':'äº”','6':'å…­'} %}
              {% set weekday_idx = related_announcement.start_time|local_datetime('%w') %}
              {% set date_str = related_announcement.start_time|local_datetime('%Y-%m-%d') %}
              {% set duration_str = related_announcement.duration_hours ~ 'å°æ—¶' %}
              <a href="{{ url_for('announcement.announcement_detail', announcement_id=related_announcement.id|string) }}" class="link">
                {{ date_str }} æ˜ŸæœŸ{{ weekday_map[weekday_idx] }} {{ duration_str }} @{{ related_announcement.x_coord }}-{{ related_announcement.y_coord }}-{{ related_announcement.z_coord }}
              </a>
            {% else %}
              æ— å…³è”é€šå‘Š
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="card-section">
      <h3 class="section-title">æ—¶é—´ä¿¡æ¯</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>å¼€å§‹æ—¶é—´</label>
          <div class="value">{{ battle_record.start_time|local_datetime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}</div>
        </div>
        <div class="detail-item">
          <label>ç»“æŸæ—¶é—´</label>
          <div class="value">{{ battle_record.end_time|local_datetime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}</div>
        </div>
        <div class="detail-item">
          <label>çŠ¶æ€</label>
          <div class="value {% if battle_record.current_status.value == 'live' %}live-status{% endif %}">
            {% if battle_record.current_status.value == 'live' %}å¼€æ’­ä¸­{% else %}å·²ä¸‹æ’­{% endif %}
          </div>
        </div>
        <div class="detail-item">
          <label>å¼€æ’­æ—¶é•¿</label>
          <div class="value">{{ "%.1f"|format(battle_record.duration_hours) }}å°æ—¶</div>
        </div>
      </div>
    </div>

    <div class="card-section">
      <h3 class="section-title">å¼€æ’­åœ°ç‚¹</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>å¼€æ’­æ–¹å¼</label>
          <div class="value">{{ battle_record.work_mode.value }}</div>
        </div>
        <div class="detail-item">
          <label>åŸºåœ°</label>
          <div class="value">{{ battle_record.x_coord }}</div>
        </div>
        <div class="detail-item">
          <label>åœºåœ°</label>
          <div class="value">{{ battle_record.y_coord }}</div>
        </div>
        <div class="detail-item">
          <label>åå¸­</label>
          <div class="value">{{ battle_record.z_coord }}</div>
        </div>
        <div class="detail-item full-width">
          <label>å®Œæ•´åæ ‡</label>
          <div class="value">{{ battle_record.battle_location }}</div>
        </div>
      </div>
    </div>

    <div class="card-section">
      <h3 class="section-title">æ”¶ç›Šä¿¡æ¯</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>æµæ°´é‡‘é¢</label>
          <div class="value revenue">Â¥{{ battle_record.revenue_amount }}</div>
        </div>
        <div class="detail-item">
          <label>åº•è–ªé‡‘é¢</label>
          <div class="value">Â¥{{ battle_record.base_salary }}</div>
        </div>
      </div>
    </div>

    <div class="card-section">
      <h3 class="section-title">ç»“ç®—æ–¹å¼</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>å½“å‰ç»“ç®—æ–¹å¼</label>
          <div class="value" id="settlement-type-display">åŠ è½½ä¸­...</div>
        </div>
        <div class="detail-item">
          <label>ç”Ÿæ•ˆæ—¥æœŸ</label>
          <div class="value" id="settlement-effective-date-display">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    {% if battle_record.notes %}
    <div class="card-section">
      <h3 class="section-title">å¤‡æ³¨ä¿¡æ¯</h3>
      <div class="notes-content">{{ battle_record.notes }}</div>
    </div>
    {% endif %}

    <div class="card-section">
      <h3 class="section-title">ç³»ç»Ÿä¿¡æ¯</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>ç™»è®°äºº</label>
          <div class="value">{{ (battle_record.registered_by.nickname or battle_record.registered_by.username) if battle_record.registered_by else 'æœªçŸ¥' }}</div>
        </div>
        <div class="detail-item">
          <label>åˆ›å»ºæ—¶é—´</label>
          <div class="value">{{ battle_record.created_at|local_datetime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}</div>
        </div>
        <div class="detail-item">
          <label>æœ€åä¿®æ”¹</label>
          <div class="value">{{ battle_record.updated_at|local_datetime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}</div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="footbar">
  <div class="inner">
    <a class="btn btn-secondary" href="{{ url_for('battle_record.edit_battle_record', record_id=battle_record.id|string) }}">
      <span class="btn-icon">âœï¸</span>
      ç¼–è¾‘
    </a>
    <button class="btn btn-secondary" onclick="showChangeLog()">
      <span class="btn-icon">ğŸ“‹</span>
      å˜æ›´è®°å½•
    </button>
    <a class="btn btn-primary" id="apply-base-salary-btn" href="/battle-records/{{ battle_record.id }}/base_salary_application" style="display: none;">
      <span class="btn-icon">ğŸ’°</span>
      ç”³è¯·åº•è–ª
    </a>
    <button class="btn btn-danger" onclick="confirmDelete()">
      <span class="btn-icon">ğŸ—‘ï¸</span>
      åˆ é™¤
    </button>
  </div>
</div>

<div id="changeLogModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å˜æ›´è®°å½•</h3>
      <button class="modal-close" onclick="hideChangeLog()">&times;</button>
    </div>
    <div class="modal-body" id="changeLogContent">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <div class="loading-text">åŠ è½½ä¸­...</div>
      </div>
    </div>
  </div>
</div>

<div id="deleteModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ç¡®è®¤åˆ é™¤</h3>
    </div>
    <div class="modal-body">
      <p>ç¡®å®šè¦åˆ é™¤è¿™æ¡å¼€æ’­è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="hideDeleteModal()">å–æ¶ˆ</button>
      <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ç¡®è®¤åˆ é™¤</button>
    </div>
  </div>
</div>

<style>

.back-nav {
  margin-bottom: 20px;
}

.back-nav .btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
}

.back-nav .btn span {
  font-size: 16px;
}

.detail-card {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
  margin-bottom: 20px;
}

.card-section {
  padding: 20px;
  border-bottom: 1px solid var(--table-header);
}

.card-section:last-child {
  border-bottom: none;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin: 0 0 16px 0;
  border-bottom: 2px solid var(--brand);
  padding-bottom: 8px;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.detail-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.detail-item.full-width {
  grid-column: 1 / -1;
}

.detail-item label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.detail-item .value {
  font-size: 14px;
  color: var(--text);
  word-break: break-all;
}

.value.revenue {
  font-size: 18px;
  font-weight: 600;
  color: var(--hud-green);
}

.value.live-status {
  font-size: 14px;
  font-weight: 600;
  color: #ff4757;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.link {
  color: var(--brand);
  text-decoration: underline;
}

.link:hover {
  color: var(--brand-dark);
}

.detail-item .value a {
  color: var(--brand);
  text-decoration: underline;
}

.detail-item .value a:hover {
  text-decoration: underline;
}

.performance-link {
  color: var(--brand);
  text-decoration: none;
  font-size: 12px;
  margin-left: 8px;
  padding: 2px 6px;
  border: 1px solid var(--brand);
  border-radius: 3px;
}

.performance-link:hover {
  color: var(--brand-dark);
  background: var(--brand);
  color: white;
}

.notes-content {
  font-size: 14px;
  color: var(--text);
  line-height: 1.5;
  white-space: pre-wrap;
  background: var(--bg-light);
  padding: 12px;
  border-radius: 4px;
  border: 1px solid var(--table-header);
}


.footbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid var(--table-header);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
  padding: 10px 12px calc(env(safe-area-inset-bottom, 0) + 10px) 12px;
  z-index: 1;
}

.footbar .inner {
  display: flex;
  justify-content: center;
  gap: 12px;
}

.container {
  padding-bottom: 88px;
}


.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-content {
  background: #fff;
  border-radius: 8px;
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid var(--table-header);
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}

.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.modal-footer {
  padding: 20px;
  border-top: 1px solid var(--table-header);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.change-log-item {
  padding: 12px 0;
  border-bottom: 1px solid var(--table-header);
}

.change-log-item:last-child {
  border-bottom: none;
}

.change-time {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
}

.change-user {
  font-size: 12px;
  color: var(--brand);
  margin-bottom: 4px;
}

.change-detail {
  font-size: 14px;
  color: var(--text);
}

.loading {
  text-align: center;
  color: var(--muted);
  padding: 20px;
}


@media (max-width: 768px) {
  .detail-grid {
    grid-template-columns: 1fr;
  }

  .back-nav {
    flex-wrap: wrap;
    gap: 8px;
  }

  .footbar .inner {
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .footbar .btn {
    flex: 1;
    min-width: 80px;
  }
}
</style>

<script src="{{ url_for('static', filename='js/settlement-utils.js') }}"></script>
<script>
const changesUrl = '{{ url_for('battle_records_api.record_changes', record_id=battle_record.id) }}';
const deleteUrl = '{{ url_for('battle_records_api.delete_record', record_id=battle_record.id) }}';
const listUrl = '{{ url_for('battle_record.list_battle_records') }}';

function showChangeLog() {
  const modal = document.getElementById('changeLogModal');
  const content = document.getElementById('changeLogContent');
  
  modal.style.display = 'flex';
  content.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div class="loading-text">åŠ è½½ä¸­...</div></div>';
  
  fetch(changesUrl)
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        const changes = (result.data && result.data.items) || [];
        if (changes.length === 0) {
          content.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div class="loading-text">æš‚æ— å˜æ›´è®°å½•</div></div>';
        } else {
          const html = changes.map(change => `
            <div class="change-log-item">
              <div class="change-time">${change.change_time}</div>
              <div class="change-user">æ“ä½œäºº: ${change.user_name} (${change.ip_address || 'æœªçŸ¥IP'})</div>
              <div class="change-detail">
                <strong>${change.field_name}:</strong> 
                ${change.old_value || 'ç©º'} â†’ ${change.new_value || 'ç©º'}
              </div>
            </div>
          `).join('');
          content.innerHTML = html;
        }
      } else {
        content.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div class="loading-text">åŠ è½½å¤±è´¥</div></div>';
      }
    })
    .catch(error => {
      console.error('è·å–å˜æ›´è®°å½•å¤±è´¥:', error);
      content.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div class="loading-text">åŠ è½½å¤±è´¥</div></div>';
    });
}

function hideChangeLog() {
  document.getElementById('changeLogModal').style.display = 'none';
}

function confirmDelete() {
  document.getElementById('deleteModal').style.display = 'flex';
}

function hideDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
}

async function deleteBattleRecord() {
  const deleteModal = document.getElementById('deleteModal');
  try {
    const response = await fetch(deleteUrl, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include'  // ç¡®ä¿æµè§ˆå™¨å‘é€åŒ…å«JWT tokençš„cookie
    });
    const result = await response.json();
    if (!result.success) {
      throw new Error(result.error?.message || 'åˆ é™¤å¼€æ’­è®°å½•å¤±è´¥');
    }
    const meta = result.meta || {};
    showMessage(meta.message || 'å¼€æ’­è®°å½•åˆ é™¤æˆåŠŸ', 'success');
    deleteModal.style.display = 'none';
    setTimeout(() => {
      window.location.href = listUrl;
    }, 600);
  } catch (error) {
    console.error('åˆ é™¤å¼€æ’­è®°å½•å¤±è´¥:', error);
    showMessage(error.message || 'åˆ é™¤å¼€æ’­è®°å½•å¤±è´¥', 'error');
  }
}

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.style.display = 'none';
  }
});


async function loadSettlementInfo() {
  const recordId = '{{ battle_record.id }}';
  const battleStartTime = '{{ battle_record.start_time.isoformat() if battle_record.start_time else "" }}';
  
  if (!battleStartTime) {
    console.warn('æ— æ³•è·å–å¼€æ’­è®°å½•å¼€å§‹æ—¶é—´');
    return;
  }
  
  try {
    // ä½¿ç”¨å…±äº«çš„ç»“ç®—æ–¹å¼è®¡ç®—å·¥å…·
    const settlement = await getEffectiveSettlement('{{ battle_record.pilot.id }}', battleStartTime);
    
    // æ¸²æŸ“ç»“ç®—æ–¹å¼ä¿¡æ¯
    renderSettlementInfo(settlement, {
      settlementTypeDisplay: document.getElementById('settlement-type-display'),
      effectiveDateDisplay: document.getElementById('settlement-effective-date-display')
    });
    
    // æ§åˆ¶ç”³è¯·æŒ‰é’®æ˜¾ç¤º
    toggleApplyButton(settlement, document.getElementById('apply-base-salary-btn'));
    
  } catch (error) {
    console.error('åŠ è½½ç»“ç®—æ–¹å¼å¤±è´¥:', error);
    document.getElementById('settlement-type-display').textContent = 'åŠ è½½å¤±è´¥';
  }
}


document.addEventListener('DOMContentLoaded', function() {
  const confirmBtn = document.getElementById('confirmDeleteBtn');
  if (confirmBtn) {
    confirmBtn.addEventListener('click', deleteBattleRecord);
  }
  loadSettlementInfo();
});
</script>
</div>
{% endblock %}
