{% extends 'base.html' %}
{% block title %}æœºå¸ˆè¯¦æƒ… - {{ pilot.nickname }} - Lacus-Log{% endblock %}
{% block content %}
<section class="pilot-detail">
  <div class="back-nav">
    <a class="btn btn-secondary" href="{{ url_for('pilot.list_pilots') }}">
      <span>â†</span>
      è¿”å›æœºå¸ˆåˆ—è¡¨
    </a>
  </div>

  <div class="pilot-info-card">
    <div class="card-header">
      <div class="pilot-avatar">
        <span class="avatar-icon">
          {% if pilot.gender.value == 0 %}â™‚{% elif pilot.gender.value == 1 %}â™€{% else %}?{% endif %}
        </span>
      </div>
      <div class="pilot-main-info">
        <div class="pilot-name">{{ pilot.nickname }}</div>
        <div class="pilot-real-name">{{ pilot.real_name or 'æœªå¡«å†™å§“å' }}</div>
        <div class="pilot-badges">
          <span class="rank-badge rank-{{ pilot.rank.value.replace(' ', '') }}">{{ pilot.rank.value }}</span>
          <span class="status-badge status-{{ pilot.status.value.replace(' ', '') }}">{{ pilot.status.value }}</span>
        </div>
      </div>
    </div>

    <!-- åŸºç¡€ä¿¡æ¯ -->
    <div class="info-section">
      <h3 class="section-title">åŸºç¡€ä¿¡æ¯</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">æ˜µç§°</div>
          <div class="info-value">{{ pilot.nickname }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å§“å</div>
          <div class="info-value">{{ pilot.real_name or 'æœªå¡«å†™' }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">æ€§åˆ«</div>
          <div class="info-value">{{ pilot.gender_display }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å¹´é¾„</div>
          <div class="info-value">
            {% if pilot.age %}{{ pilot.age }}å²{% else %}æœªçŸ¥{% endif %}
            {% if pilot.birth_year %}({{ pilot.birth_year }}å¹´){% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸šåŠ¡ä¿¡æ¯ -->
    <div class="info-section">
      <h3 class="section-title">ä¸šåŠ¡ä¿¡æ¯</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">æ‰€å±</div>
          <div class="info-value">{{ pilot.owner.nickname or pilot.owner.username if pilot.owner else 'æ— ' }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">æˆ˜åŒº</div>
          <div class="info-value">{{ pilot.platform.value }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">å‚æˆ˜å½¢å¼</div>
          <div class="info-value">{{ pilot.work_mode.value }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">é˜¶çº§</div>
          <div class="info-value rank-{{ pilot.rank.value.replace(' ', '') }}">{{ pilot.rank.value }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">çŠ¶æ€</div>
          <div class="info-value status-{{ pilot.status.value.replace(' ', '') }}">{{ pilot.status.value }}</div>
        </div>
      </div>
    </div>

    <!-- ç³»ç»Ÿä¿¡æ¯ -->
    <div class="info-section">
      <h3 class="section-title">ç³»ç»Ÿä¿¡æ¯</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">åˆ›å»ºæ—¶é—´</div>
          <div class="info-value">{{ pilot.created_at | local_datetime('%Y-%m-%d %H:%M:%S') }}</div>
        </div>
        <div class="info-item">
          <div class="info-label">æœ€åä¿®æ”¹</div>
          <div class="info-value">{{ pilot.updated_at | local_datetime('%Y-%m-%d %H:%M:%S') }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ“ä½œæŒ‰é’® -->
  <div class="action-section">
    <h3 class="section-title">æ“ä½œ</h3>
    <div class="action-buttons">
      <a class="btn btn-primary" href="{{ url_for('pilot.edit_pilot', pilot_id=(pilot.id|string)) }}">
        <span class="btn-icon">âœï¸</span>
        ç¼–è¾‘
      </a>
      <button class="btn btn-secondary" onclick="showChanges()">
        <span class="btn-icon">ğŸ“œ</span>
        å˜æ›´è®°å½•
      </button>
    </div>
  </div>
</section>

<!-- å˜æ›´è®°å½•æ¨¡æ€æ¡† -->
<div id="changesModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>å˜æ›´è®°å½•</h3>
      <button class="modal-close" onclick="hideChanges()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="changesLoading" class="loading">åŠ è½½ä¸­...</div>
      <div id="changesList" style="display: none;"></div>
    </div>
  </div>
</div>

<style>
/* æœºå¸ˆè¯¦æƒ…é¡µé¢æ ·å¼ */
.pilot-detail {
  max-width: 800px;
  margin: 0 auto;
}

.pilot-info-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
}

.pilot-info-card .card-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--table-header);
}

.pilot-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--table-header);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: bold;
}

.pilot-main-info {
  flex: 1;
}

.pilot-main-info .pilot-name {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
  color: var(--text);
}

.pilot-main-info .pilot-real-name {
  color: var(--muted);
  margin-bottom: 8px;
  font-size: 14px;
}

.pilot-badges {
  display: flex;
  gap: 8px;
}

.rank-badge, .status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}

/* é˜¶çº§å¾½ç« æ ·å¼ */
.rank-å€™è¡¥æœºå¸ˆ { background: var(--table-header); color: var(--muted); }
.rank-è®­ç»ƒæœºå¸ˆ { background: #FFF3CD; color: #856404; }
.rank-å®ä¹ æœºå¸ˆ { background: #D4EDDA; color: #155724; }
.rank-æ­£å¼æœºå¸ˆ { background: var(--brand); color: #fff; }

/* çŠ¶æ€å¾½ç« æ ·å¼ */
.status-æœªå¾å¬ { background: var(--table-header); color: var(--muted); }
.status-ä¸å¾å¬ { background: #F8D7DA; color: #721C24; }
.status-å·²å¾å¬ { background: #FFF3CD; color: #856404; }
.status-å·²ç­¾çº¦ { background: #D1ECF1; color: #0C5460; }
.status-å·²é˜µäº¡ { background: #F8D7DA; color: #721C24; }

.info-section {
  margin-bottom: 24px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--brand);
  border-bottom: 1px solid var(--table-header);
  padding-bottom: 8px;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.info-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.info-value {
  font-size: 14px;
  color: var(--text);
}

.action-section {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
}

.action-buttons {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: #fff;
  border-radius: 8px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--table-header);
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}

.modal-close:hover {
  color: var(--text);
}

.modal-body {
  padding: 20px;
  max-height: 60vh;
  overflow-y: auto;
}

.loading {
  text-align: center;
  color: var(--muted);
  padding: 20px;
}

.change-item {
  background: var(--table-header);
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 8px;
}

.change-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 12px;
  color: var(--muted);
}

.change-content {
  font-size: 14px;
}

.change-field {
  font-weight: 600;
  color: var(--brand);
}

.change-values {
  margin-top: 4px;
}

.old-value, .new-value {
  font-family: monospace;
  background: #fff;
  padding: 2px 4px;
  border-radius: 3px;
  margin: 0 2px;
}

.old-value {
  text-decoration: line-through;
  color: var(--error);
}

.new-value {
  color: var(--hud-green);
}

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 768px) {
  .pilot-info-card .card-header {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .pilot-badges {
    justify-content: center;
  }

  .info-grid {
    grid-template-columns: 1fr;
  }

  .action-buttons {
    flex-direction: column;
  }

  .action-buttons .btn {
    width: 100%;
  }

  .modal-content {
    width: 95%;
    margin: 0 10px;
  }
}
</style>

<script>
async function showChanges() {
  const modal = document.getElementById('changesModal');
  const loading = document.getElementById('changesLoading');
  const changesList = document.getElementById('changesList');
  
  modal.style.display = 'flex';
  loading.style.display = 'block';
  changesList.style.display = 'none';
  changesList.innerHTML = '';
  
  try {
    const response = await fetch('{{ url_for("pilot.pilot_changes", pilot_id=(pilot.id|string)) }}');
    const data = await response.json();
    
    if (data.success) {
      if (data.changes.length === 0) {
        changesList.innerHTML = '<div class="empty-state"><div class="empty-title">æš‚æ— å˜æ›´è®°å½•</div></div>';
      } else {
        const changesHtml = data.changes.map(change => `
          <div class="change-item">
            <div class="change-header">
              <span>æ“ä½œäººï¼š${change.user_name}</span>
              <span>${change.change_time}</span>
            </div>
            <div class="change-content">
              <span class="change-field">${change.field_name}</span>
              <div class="change-values">
                <span class="old-value">${change.old_value || 'ç©º'}</span>
                â†’
                <span class="new-value">${change.new_value || 'ç©º'}</span>
              </div>
            </div>
          </div>
        `).join('');
        changesList.innerHTML = changesHtml;
      }
    } else {
      changesList.innerHTML = '<div class="empty-state"><div class="empty-title">åŠ è½½å¤±è´¥</div></div>';
    }
  } catch (error) {
    changesList.innerHTML = '<div class="empty-state"><div class="empty-title">åŠ è½½å¤±è´¥</div></div>';
  }
  
  loading.style.display = 'none';
  changesList.style.display = 'block';
}

function hideChanges() {
  const modal = document.getElementById('changesModal');
  modal.style.display = 'none';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.getElementById('changesModal').addEventListener('click', function(e) {
  if (e.target === this) {
    hideChanges();
  }
});
</script>
{% endblock %}
