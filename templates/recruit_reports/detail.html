{% extends "base.html" %}

{% block title %}æ‹›å‹Ÿæ—¥æŠ¥è¯¦æƒ…{% endblock %}

{% block content %}
<div id="recruitDailyDetailApp"
     data-report-date="{{ report_date }}"
     data-range="{{ range_param }}"
     data-metric="{{ metric }}"
     data-recruiter="{{ recruiter_id }}"
     data-return-url="{{ return_url }}">
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <a href="{{ return_url }}" class="btn btn-secondary btn-sm">â† è¿”å›æ—¥æŠ¥</a>
      </div>
      <div class="header-center">
        <h1 class="page-title" id="detailTitle">{{ page_title }}</h1>
      </div>
      <div class="header-right"></div>
    </div>
  </div>

  <div class="recruits-section" id="detailContent">
    <div class="recruit-group" id="recordsContainer"></div>
    <div class="empty-state" id="detailEmptyState" style="display: none;">
      <div class="empty-icon">ğŸ“Š</div>
      <div class="empty-title">æš‚æ— æ•°æ®</div>
      <div class="empty-description">è¯¥æ—¶é—´èŒƒå›´å†…æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ‹›å‹Ÿè®°å½•</div>
      <a href="{{ return_url }}" class="btn btn-primary">è¿”å›æ—¥æŠ¥</a>
    </div>
  </div>
</div>

<style>
.page-header {
  margin-bottom: 24px;
}

.header-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-left {
  flex: 0 0 auto;
}

.header-center {
  flex: 1;
  text-align: center;
}

.header-right {
  flex: 0 0 auto;
}

.page-title {
  font-size: 24px;
  font-weight: 600;
  margin: 0;
  color: var(--text);
}

.recruits-section {
  margin-top: 24px;
}

.recruit-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.record-card {
  display: block;
  background: #fff;
  border-radius: 8px;
  padding: 12px 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
  text-decoration: none;
  color: inherit;
  transition: all 0.2s ease;
  cursor: pointer;
}

.record-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transform: translateY(-2px);
  border-color: var(--brand);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.record-time {
  flex: 0 0 auto;
}

.record-time .start-time {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
}

.record-time .time-label {
  font-size: 12px;
  color: var(--muted);
  margin-top: 2px;
}

.record-info {
  flex: 1;
  text-align: right;
}

.pilot-name {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
}

.meta-line {
  font-size: 12px;
  color: var(--muted);
  margin-top: 2px;
}

.status-line {
  margin-top: 6px;
  display: inline-flex;
  gap: 6px;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.status-badge {
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 11px;
  background: var(--table-header);
  color: var(--text);
}

.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: var(--muted);
}

.card-arrow {
  font-size: 16px;
}

.empty-state {
  margin-top: 40px;
  text-align: center;
  color: var(--muted);
}

.empty-icon {
  font-size: 36px;
  margin-bottom: 12px;
}

.empty-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text);
}

.empty-description {
  margin-bottom: 16px;
}

@media (max-width: 768px) {
  .page-title {
    font-size: 20px;
  }

  .card-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .record-info {
    text-align: left;
  }

  .status-line {
    justify-content: flex-start;
  }
}
</style>

<script>
(function() {
  const app = document.getElementById('recruitDailyDetailApp');
  if (!app) {
    return;
  }

  const detailTitle = document.getElementById('detailTitle');
  const recordsContainer = document.getElementById('recordsContainer');
  const emptyState = document.getElementById('detailEmptyState');

  const dailyApi = '{{ url_for('recruit_reports_api.get_recruit_daily_report') }}';
  const recruitDetailTemplate = '{{ url_for('recruit.detail_recruit', recruit_id="PLACEHOLDER") }}';

  const reportDate = app.dataset.reportDate;
  const rangeParam = app.dataset.range;
  const metricParam = app.dataset.metric;
  const recruiterId = app.dataset.recruiter || 'all';

  detailTitle.textContent = 'æ‹›å‹Ÿæ—¥æŠ¥è¯¦æƒ…åŠ è½½ä¸­â€¦';

  function buildDetailParams() {
    const params = new URLSearchParams();
    params.set('view', 'detail');
    if (reportDate) {
      params.set('date', reportDate);
    }
    params.set('range', rangeParam);
    params.set('metric', metricParam);
    if (recruiterId && recruiterId !== 'all') {
      params.set('recruiter', recruiterId);
    }
    return params;
  }

  function buildRecordCard(record) {
    const card = document.createElement('a');
    card.className = 'record-card';
    card.href = '#';
    card.dataset.recruitId = record.id;

    const pilotDisplay = record.pilot && record.pilot.nickname ? record.pilot.nickname : 'æœªçŸ¥ä¸»æ’­';
    const recruiterDisplay = record.recruiter && (record.recruiter.nickname || record.recruiter.username);
    const recruiterText = recruiterDisplay || 'æœªçŸ¥è¿è¥';
    const channel = record.channel || 'æœªçŸ¥æ¸ é“';
    const status = record.effective_status || 'æœªçŸ¥çŠ¶æ€';
    const highlightLabel = record.highlight && record.highlight.label ? record.highlight.label : 'ç›¸å…³æ—¶é—´';
    const highlightTime = record.highlight && record.highlight.display ? record.highlight.display : 'æœªçŸ¥';

    card.innerHTML = `
      <div class="card-header">
        <div class="record-time">
          <div class="start-time">${highlightTime}</div>
          <div class="time-label">${highlightLabel}</div>
        </div>
        <div class="record-info">
          <div class="pilot-name">${pilotDisplay}</div>
          <div class="meta-line">[${recruiterText}][${channel}]</div>
          <div class="status-line">
            <span class="status-badge">${status}</span>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <div>${record.remarks ? record.remarks : ''}</div>
        <div class="card-arrow">â†’</div>
      </div>
    `;

    card.addEventListener('click', event => {
      event.preventDefault();
      if (!record.id) {
        return;
      }
      const baseUrl = recruitDetailTemplate.replace('PLACEHOLDER', record.id);
      const url = new URL(baseUrl, window.location.origin);
      url.searchParams.set('from', 'recruit_report_detail');
      if (reportDate) {
        url.searchParams.set('report_date', reportDate);
      }
      url.searchParams.set('report_range', rangeParam);
      url.searchParams.set('report_metric', metricParam);
      url.searchParams.set('report_recruiter', recruiterId || 'all');
      window.location.href = url.toString();
    });

    return card;
  }

  function renderRecords(records) {
    recordsContainer.innerHTML = '';
    if (!records || records.length === 0) {
      emptyState.style.display = 'block';
      return;
    }
    emptyState.style.display = 'none';
    const fragment = document.createDocumentFragment();
    records.forEach(record => {
      fragment.appendChild(buildRecordCard(record));
    });
    recordsContainer.appendChild(fragment);
  }

  async function loadDetail() {
    try {
      const response = await fetch(`${dailyApi}?${buildDetailParams().toString()}`);
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error ? payload.error.message : 'åŠ è½½å¤±è´¥');
      }
      const data = payload.data || {};
      detailTitle.textContent = `${data.date || reportDate} ${data.range_label || ''} ${data.metric_label || ''}ï¼š${data.count || 0}`;
      renderRecords(data.recruits || []);
    } catch (error) {
      console.error('åŠ è½½æ‹›å‹Ÿæ—¥æŠ¥è¯¦æƒ…å¤±è´¥ï¼š', error);
      detailTitle.textContent = 'æ‹›å‹Ÿæ—¥æŠ¥è¯¦æƒ…åŠ è½½å¤±è´¥';
      recordsContainer.innerHTML = '';
      emptyState.style.display = 'block';
      emptyState.querySelector('.empty-description').textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·è¿”å›é‡è¯•ã€‚';
    }
  }

  loadDetail();
})();
</script>
{% endblock %}
