{% extends 'base.html' %}
{% block title %}招募详情 - Lacus-Log{% endblock %}

{% block content %}
<section class="recruit-detail" data-recruit-id="{{ recruit_id }}">
  <div class="back-nav">
    <a class="btn btn-secondary" href="{{ url_for('recruit.list_recruits') }}">
      <span>←</span>
      返回招募列表
    </a>
  </div>

  <!-- Skeleton for Pilot Info -->
  <div id="pilot-info-card-container"></div>

  <!-- Skeleton for Recruit Info -->
  <div id="recruit-info-card-container"></div>

</section>

<div class="footbar" id="footbar-container">
  <!-- Action buttons will be loaded here -->
</div>

<!-- Modal for Changes -->
<div id="changesModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>招募变更记录</h3>
      <button class="modal-close" onclick="hideChangesModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="changesContent">加载中...</div>
      <div id="changes-pagination"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="hideChangesModal()">关闭</button>
    </div>
  </div>
</div>

<style>
/* Styles are identical to the previous version */
.recruit-detail { padding: 20px; }
.back-nav { margin-bottom: 20px; }
.pilot-info-card, .recruit-info-card { background: white; border: 1px solid var(--gray); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
.card-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--table-header); }
.pilot-name { font-size: 20px; font-weight: 600; }
.pilot-name a { color: var(--brand); text-decoration: none; }
.pilot-real-name { font-size: 14px; color: var(--muted); }
.pilot-badges { display: flex; gap: 8px; margin-top: 8px; }
.rank-badge, .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
.info-section { margin-bottom: 20px; }
.section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; }
.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.info-item { display: flex; flex-direction: column; gap: 4px; }
.info-item.full-width { grid-column: 1 / -1; }
.info-label { font-size: 12px; color: var(--muted); }
.info-value { font-size: 14px; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
.modal-content { background: white; border-radius: 8px; max-width: 90%; width: 600px; }
.modal-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
.modal-body { padding: 20px; max-height: 400px; overflow-y: auto; }
.modal-footer { padding: 20px; text-align: right; }
.changes-table { width: 100%; font-size: 14px; border-collapse: collapse; }
.changes-table th, .changes-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--table-header); }
</style>

<script>
const recruitId = document.querySelector('.recruit-detail').dataset.recruitId;

function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
}

function renderPilotInfo(pilot) {
    if (!pilot) return '';
    return `
    <div class="pilot-info-card">
        <div class="card-header">
            <div class="pilot-main-info">
                <div class="pilot-name"><a href="/pilots/${pilot.id}">${pilot.nickname}</a></div>
                <div class="pilot-real-name">${pilot.real_name || '未填写姓名'}</div>
                <div class="pilot-badges">
                    <span class="rank-badge">${pilot.rank || '-'}</span>
                    <span class="status-badge">${pilot.status || '-'}</span>
                </div>
            </div>
        </div>
    </div>`;
}

function renderInfoGrid(items) {
    let html = '<div class="info-grid">';
    for (const item of items) {
        if (item.value) {
            html += `
            <div class="info-item ${item.fullWidth ? 'full-width' : ''}">
                <div class="info-label">${item.label}</div>
                <div class="info-value">${item.value}</div>
            </div>`;
        }
    }
    html += '</div>';
    return html;
}

function renderRecruitInfo(recruit) {
    const container = document.getElementById('recruit-info-card-container');
    let content = '<div class="recruit-info-card">';

    content += '<div class="info-section"><h3 class="section-title">基本信息</h3>' + renderInfoGrid([
        { label: '招募负责人', value: recruit.recruiter?.nickname },
        { label: '预约时间', value: formatDateTime(recruit.appointment_time) },
        { label: '招募渠道', value: recruit.channel },
        { label: '介绍费', value: `￥${recruit.introduction_fee}` },
        { label: '招募状态', value: `<span class="status-${recruit.effective_status}">${recruit.effective_status}</span>` },
        { label: '备注', value: recruit.remarks, fullWidth: true },
    ]) + '</div>';

    if (recruit.effective_interview_decision) {
        content += '<div class="info-section"><h3 class="section-title">面试阶段</h3>' + renderInfoGrid([
            { label: '面试决策', value: recruit.effective_interview_decision },
            { label: '面试决策人', value: recruit.effective_interview_decision_maker?.nickname },
            { label: '面试决策时间', value: formatDateTime(recruit.effective_interview_decision_time) },
        ]) + '</div>';
    }
    
    // ... Add other decision blocks similarly ...

    content += '<div class="info-section"><h3 class="section-title">系统信息</h3>' + renderInfoGrid([
        { label: '创建时间', value: formatDateTime(recruit.created_at) },
        { label: '最后修改', value: formatDateTime(recruit.updated_at) },
    ]) + '</div>';

    content += '</div>';
    container.innerHTML = content;
}

function renderActionButtons(recruit) {
    const container = document.getElementById('footbar-container');
    let buttons = `<a class="btn btn-secondary" href="/recruits/${recruit.id}/edit">编辑</a>`;
    const status = recruit.effective_status;

    const actionMap = {
        '待面试': { path: 'interview', text: '面试决策' },
        '待预约试播': { path: 'schedule-training', text: '预约试播' },
        '待试播': { path: 'training-decision', text: '试播决策' },
        '待预约开播': { path: 'schedule-broadcast', text: '预约开播' },
        '待开播': { path: 'broadcast-decision', text: '开播决策' },
    };

    if (actionMap[status]) {
        const url = `/recruits/${recruit.id}/${actionMap[status].path}`;
        buttons += `<a class="btn btn-primary" href="${url}">${actionMap[status].text}</a>`;
    }

    buttons += `<button class="btn btn-secondary" onclick="showChangesModal()">变更记录</button>`;
    container.innerHTML = buttons;
}

async function showChangesModal(page = 1) {
  document.getElementById('changesModal').style.display = 'flex';
  const content = document.getElementById('changesContent');
  content.innerHTML = '加载中...';

  try {
    const payload = await RecruitAPI.getRecruitChanges(recruitId, page);
    const changes = payload.data;
    let html = '<table class="changes-table"><thead><tr><th>时间</th><th>操作人</th><th>字段</th><th>前值</th><th>后值</th></tr></thead><tbody>';
    if (changes.length === 0) {
        html += '<tr><td colspan="5" style="text-align:center;">暂无变更记录</td></tr>';
    } else {
        changes.forEach(change => {
            html += `<tr>
                <td>${formatDateTime(change.created_at)}</td>
                <td>${change.user?.nickname || '-'}</td>
                <td>${change.field_display_name}</td>
                <td>${change.old_value || '-'}</td>
                <td>${change.new_value || '-'}</td>
            </tr>`;
        });
    }
    html += '</tbody></table>';
    content.innerHTML = html;
    // Add pagination controls if necessary
  } catch (error) {
    content.innerHTML = '<p style="text-align:center; color:var(--error);">加载失败</p>';
  }
}

function hideChangesModal() {
  document.getElementById('changesModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const payload = await RecruitAPI.getRecruitDetail(recruitId);
        const recruit = payload.data;
        document.getElementById('pilot-info-card-container').innerHTML = renderPilotInfo(recruit.pilot);
        renderRecruitInfo(recruit);
        renderActionButtons(recruit);
    } catch (error) {
        console.error('Failed to load recruit details:', error);
        document.querySelector('.recruit-detail').innerHTML = '<p>加载招募详情失败。</p>';
    }
});
</script>
{% endblock %}