{% extends "base.html" %}

{% block title %}编辑通告{% endblock %}

{% block content %}
<section class="announcement-form">
  <div class="back-nav">
    {% if request.args.get('from') == 'calendar' and request.args.get('date') %}
    <a class="btn btn-secondary" href="{{ url_for('announcement.announcement_detail', announcement_id=announcement.id) }}?from=calendar&date={{ request.args.get('date') }}">
      <span>←</span>
      返回通告详情
    </a>
    {% else %}
    <a class="btn btn-secondary" href="{{ url_for('announcement.announcement_detail', announcement_id=announcement.id) }}">
      <span>←</span>
      返回通告详情
    </a>
    {% endif %}
  </div>

  <div class="form-container">
    <div class="form-header">
      <h1 class="form-title">编辑通告</h1>
    </div>

    <form method="POST" id="announcementForm" class="announcement-form-content" data-announcement-id="{{ announcement.id }}" data-edit-scope="{{ edit_scope }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <input type="hidden" name="edit_scope" value="{{ request.args.get('edit_scope', 'this_only') }}"/>

      <div class="form-section">
        <h3 class="section-title">基础信息</h3>
        
        <div class="form-grid single-column">
          <div class="form-group">
            <label class="form-label">主播</label>
            <div class="readonly-field" id="pilot_info">加载中...</div>
            <input type="hidden" name="pilot" id="pilot_id" value="">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="x_coord" class="form-label">基地 <span class="required">*</span></label>
            <select name="x_coord" id="x_coord" class="form-select" required>
              <option value="">请选择基地</option>
            </select>
          </div>

          <div class="form-group">
            <label for="y_coord" class="form-label">场地 <span class="required">*</span></label>
            <select name="y_coord" id="y_coord" class="form-select" required disabled>
              <option value="">请先选择基地</option>
            </select>
          </div>

          <div class="form-group">
            <label for="z_coord" class="form-label">坐席 <span class="required">*</span></label>
            <select name="z_coord" id="z_coord" class="form-select" required disabled>
              <option value="">请先选择场地</option>
            </select>
            <input type="hidden" name="battle_area" id="battle_area" value="">
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">时间信息</h3>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="start_time" class="form-label">开始时间 <span class="required">*</span></label>
            {% set edit_scope = request.args.get('edit_scope', 'this_only') %}
            {% if edit_scope == 'future_all' %}
            <div class="time-input-group">
              <input type="date" name="start_date" id="start_date" readonly class="form-input"
                     value=""
                     style="background-color: #f8f9fa; color: #6c757d;">
              <div class="time-selectors">
                <select name="start_hour" id="start_hour" class="form-select" required>
                  <option value="">时</option>
                  {% for hour in range(0, 24) %}
                  <option value="{{ '%02d'|format(hour) }}">{{ '%02d'|format(hour) }}</option>
                  {% endfor %}
                </select>
                <span class="time-separator">:</span>
                <select name="start_minute" id="start_minute" class="form-select" required>
                  <option value="">分</option>
                  {% for minute in range(0, 60, 15) %}
                  <option value="{{ '%02d'|format(minute) }}">{{ '%02d'|format(minute) }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="form-help">编辑未来所有循环时，日期不可修改，只能修改时间</div>
            {% else %}
            <input type="datetime-local" name="start_time" id="start_time" class="form-input" required value="">
            {% endif %}
          </div>

          <div class="form-group">
            <label for="duration_hours" class="form-label">时长（小时） <span class="required">*</span></label>
            <select name="duration_hours" id="duration_hours" class="form-select" required>
              <option value="">请选择时长</option>
              {% for hours in [1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0, 5.5, 6.0, 6.5, 7.0, 7.5, 8.0, 8.5, 9.0, 9.5, 10.0, 10.5, 11.0, 11.5, 12.0, 12.5, 13.0, 13.5, 14.0, 14.5, 15.0, 15.5, 16.0] %}
              <option value="{{ hours }}">
                {% if hours == hours|int %}{{ hours|int }}{% else %}{{ hours }}{% endif %}小时
              </option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div class="form-section" id="recurrence_notice" style="display: none;">
        <div class="repeat-notice">
          <h4>⚠️ 循环事件编辑说明</h4>
          <p id="recurrence_scope"></p>
          <p id="recurrence_description"></p>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" id="check_btn" class="btn btn-secondary">检查冲突</button>
        
        <div id="conflict_results" class="conflict-section" style="display: none;">
          <div id="conflict_content"></div>
        </div>
        
        <div class="action-buttons">
          <button type="submit" id="submit_btn" class="btn btn-primary" disabled>保存修改</button>
          <a href="{{ url_for('announcement.announcement_detail', announcement_id=announcement.id) }}" class="btn btn-outline">取消</a>
        </div>
      </div>
    </form>
  </div>
</section>

<style>
.announcement-form {
  max-width: 840px;
  margin: 0 auto 60px;
}

.back-nav {
  margin-bottom: 16px;
}

.back-nav .btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: 8px;
}

.back-nav .btn span {
  font-size: 18px;
}

.form-container {
  background: #fff;
  border: 1px solid var(--table-header);
  border-radius: 12px;
  padding: 28px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.form-header {
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--table-header);
}

.form-title {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
  color: var(--text);
}

.announcement-form-content {
  display: flex;
  flex-direction: column;
  gap: 32px;
}

.form-section {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--brand);
  border-bottom: 1px solid var(--table-header);
  padding-bottom: 8px;
  margin: 0;
}

.form-grid {
  display: grid;
  gap: 20px;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}

.form-grid.single-column {
  grid-template-columns: 1fr;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-label {
  font-weight: 500;
  color: var(--text);
}

.required {
  color: var(--error);
  margin-left: 4px;
}

.form-input,
.form-select,
.form-textarea {
  padding: 12px 14px;
  border: 1px solid var(--table-header);
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
  background: #fff;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(91, 133, 255, 0.2);
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23666' d='M6 8 0 0h12z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 12px 8px;
  padding-right: 36px;
}

.form-input:disabled,
.form-select:disabled {
  background-color: #f8f9fa;
  color: #6c757d;
  cursor: not-allowed;
}

.form-textarea {
  resize: vertical;
  min-height: 160px;
}

.form-help {
  font-size: 12px;
  color: var(--muted);
  line-height: 1.6;
}

.readonly-field {
  padding: 12px 14px;
  background-color: #f8fafc;
  border: 1px solid var(--table-header);
  border-radius: 8px;
  color: var(--muted);
  font-size: 14px;
  min-height: 20px;
  display: flex;
  align-items: center;
}

.time-input-group {
  display: flex;
  gap: 10px;
  align-items: center;
}

.time-input-group input[type="date"] {
  flex: 1;
}

.time-selectors {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
}

.time-selectors select {
  flex: 1;
}

.time-separator {
  font-weight: 600;
  color: var(--text);
  font-size: 16px;
}

.repeat-notice {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 8px;
  padding: 20px;
}

.repeat-notice h4 {
  margin: 0 0 12px 0;
  color: #856404;
  font-size: 16px;
}

.repeat-notice p {
  margin: 0 0 10px 0;
  color: #856404;
  line-height: 1.6;
}

.repeat-notice p:last-child {
  margin-bottom: 0;
}

.conflict-section {
  background: #f8fafc;
  border: 1px solid var(--table-header);
  border-radius: 12px;
  padding: 20px;
}

.conflict-item {
  background: #fff;
  border: 1px solid var(--table-header);
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 12px;
}

.conflict-type {
  font-weight: 600;
  color: var(--error);
  margin-bottom: 4px;
}

.conflict-details {
  font-size: 14px;
  line-height: 1.8;
  color: var(--text);
}

.no-conflicts {
  color: var(--success);
  font-weight: 600;
  text-align: center;
  padding: 16px;
  font-size: 16px;
}

.plan-content {
  background: #fff;
  border: 1px dashed var(--brand);
  border-radius: 10px;
  padding: 12px 14px;
}

.plan-summary {
  font-weight: 600;
  color: var(--brand);
  margin-bottom: 8px;
}

.plan-instance {
  background: #f0f6ff;
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 8px;
}

.form-actions {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.action-buttons {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  flex-wrap: wrap;
}

.action-buttons .btn {
  min-width: 140px;
}

.btn {
  display: inline-block;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--brand);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: var(--brand-dark);
}

.btn-secondary {
  background: var(--muted);
  color: white;
}

.btn-secondary:hover {
  background: #545b62;
}

.btn-outline {
  background: transparent;
  color: var(--muted);
  border: 1px solid var(--muted);
}

.btn-outline:hover {
  background: var(--muted);
  color: white;
}

@media (max-width: 768px) {
  .announcement-form {
    margin: 0 16px 60px;
  }

  .form-container {
    padding: 20px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .action-buttons {
    flex-direction: column;
    align-items: stretch;
  }
}
</style>

<script>
const announcementForm = document.getElementById('announcementForm');
const announcementId = announcementForm?.dataset.announcementId || '';
const editScope = announcementForm?.dataset.editScope || 'this_only';
const csrfToken = document.querySelector('input[name="csrf_token"]').value;
const submitBtn = document.getElementById('submit_btn');
const conflictResults = document.getElementById('conflict_results');
const conflictContent = document.getElementById('conflict_content');
const xSelect = document.getElementById('x_coord');
const ySelect = document.getElementById('y_coord');
const zSelect = document.getElementById('z_coord');
const hiddenBattleArea = document.getElementById('battle_area');
const durationSelect = document.getElementById('duration_hours');
const pilotInfoEl = document.getElementById('pilot_info');
const pilotHiddenInput = document.getElementById('pilot_id');
const startTimeInput = document.getElementById('start_time');
const startDateInput = document.getElementById('start_date');
const startHourSelect = document.getElementById('start_hour');
const startMinuteSelect = document.getElementById('start_minute');
const recurrenceNotice = document.getElementById('recurrence_notice');
const recurrenceScopeText = document.getElementById('recurrence_scope');
const recurrenceDescriptionText = document.getElementById('recurrence_description');

let announcementDetail = null;
let pilotId = '';
let originalDate = '';
let preselectCoords = { x: '', y: '', battleAreaId: '' };

function showLoading(isLoading) {
  const overlay = document.getElementById('loading-overlay');
  if (!overlay) return;
  overlay.style.display = isLoading ? 'flex' : 'none';
}

async function fetchJson(url, options = {}) {
  const response = await fetch(url, options);
  const result = await response.json();
  if (!result.success) {
    const error = new Error(result.error?.message || '请求失败');
    error.response = result;
    error.status = response.status;
    throw error;
  }
  return result;
}

function resetSubmitButton() {
  if (submitBtn) submitBtn.disabled = true;
}

function clearConflicts() {
  if (conflictResults) conflictResults.style.display = 'none';
  if (conflictContent) conflictContent.innerHTML = '';
  resetSubmitButton();
}

function renderConflicts(conflicts) {
  if (!conflictResults || !conflictContent) return;
  conflictResults.style.display = 'block';
  if (!Array.isArray(conflicts) || conflicts.length === 0) {
    conflictContent.innerHTML = '';
    return;
  }
  let html = '<h3>冲突检查结果</h3>';
  conflicts.forEach(conflict => {
    html += `<div class="conflict-item ${conflict.type === '开播地点冲突' ? 'area-conflict' : 'pilot-conflict'}">`;
    html += `<div class="conflict-type">${conflict.type}</div>`;
    html += '<div class="conflict-details">';
    html += `${conflict.pilot_name || ''}<br>`;
    html += `${conflict.start_time || ''} 起 ${conflict.duration || ''}<br>`;
    html += `${conflict.coords || ''}`;
    html += '</div></div>';
  });
  conflictContent.innerHTML = html;
}

function renderPlannedInstances(plannedInstances) {
  if (!conflictResults || !conflictContent) return;
  conflictResults.style.display = 'block';
  let html = '<div class="no-conflicts">✓ 检查通过，无冲突</div>';
  html += '<h3>计划详情</h3>';
  if (Array.isArray(plannedInstances) && plannedInstances.length > 0) {
    if (plannedInstances.length === 1) {
      const instance = plannedInstances[0];
      html += `<div class="plan-content">${instance.pilot_name || ''}<br>${instance.start_time || ''} 起 ${instance.duration || ''}<br>${instance.coords || ''}</div>`;
    } else {
      html += `<div class="plan-content"><div class="plan-summary">共 ${plannedInstances.length} 个事件：</div>`;
      plannedInstances.forEach((instance, index) => {
        html += `<div class="plan-instance">${index + 1}. ${instance.pilot_name || ''}<br>${instance.start_time || ''} 起 ${instance.duration || ''}<br>${instance.coords || ''}</div>`;
      });
      html += '</div>';
    }
  }
  conflictContent.innerHTML = html;
  if (submitBtn) submitBtn.disabled = false;
}

async function loadAreaOptions({ preselectX = '', preselectY = '', preselectBattleArea = '' } = {}) {
  try {
    const { data } = await fetchJson('/announcements/api/areas/options');
    const xCoords = data?.x_coords || [];
    xSelect.innerHTML = '<option value="">请选择基地</option>';
    xCoords.forEach(x => {
      const option = document.createElement('option');
      option.value = x;
      option.textContent = x;
      xSelect.appendChild(option);
    });
    if (preselectX && xCoords.includes(preselectX)) {
      xSelect.value = preselectX;
      await loadYOptions(preselectX, { preselectY, preselectBattleArea });
    }
  } catch (error) {
    console.error('加载基地选项失败:', error);
    showMessage(error.message || '加载基地选项失败', 'error');
  }
}

async function loadYOptions(xCoord, { preselectY = '', preselectBattleArea = '' } = {}) {
  ySelect.innerHTML = '<option value="">请选择场地</option>';
  zSelect.innerHTML = '<option value="">请先选择场地</option>';
  ySelect.disabled = !xCoord;
  zSelect.disabled = true;
  hiddenBattleArea.value = '';
  if (!xCoord) return;
  try {
    const { data } = await fetchJson(`/announcements/api/areas/${xCoord}`);
    const yCoords = data?.y_coords || [];
    yCoords.forEach(y => {
      const option = document.createElement('option');
      option.value = y;
      option.textContent = y;
      ySelect.appendChild(option);
    });
    if (preselectY && yCoords.includes(preselectY)) {
      ySelect.value = preselectY;
      await loadZOptions(xCoord, preselectY, { preselectBattleArea });
    }
  } catch (error) {
    console.error('加载场地失败:', error);
    showMessage(error.message || '加载场地选项失败', 'error');
  }
}

async function loadZOptions(xCoord, yCoord, { preselectBattleArea = '' } = {}) {
  zSelect.innerHTML = '<option value="">请选择坐席</option>';
  zSelect.disabled = !(xCoord && yCoord);
  if (!xCoord || !yCoord) {
    hiddenBattleArea.value = '';
    return;
  }
  try {
    const { data } = await fetchJson(`/announcements/api/areas/${xCoord}/${yCoord}`);
    const areas = data?.areas || [];
    areas.forEach(area => {
      const option = document.createElement('option');
      option.value = area.id;
      option.textContent = area.z_coord;
      zSelect.appendChild(option);
    });
    if (preselectBattleArea) {
      const match = areas.find(area => area.id === preselectBattleArea);
      if (match) {
        zSelect.value = preselectBattleArea;
        hiddenBattleArea.value = preselectBattleArea;
      }
    }
  } catch (error) {
    console.error('加载坐席失败:', error);
    showMessage(error.message || '加载坐席选项失败', 'error');
  }
}

function collectFormPayload() {
  const formData = new FormData(announcementForm);
  const payload = {
    battle_area_id: formData.get('battle_area'),
    duration_hours: parseFloat(formData.get('duration_hours')),
    edit_scope: editScope,
  };
  if (editScope === 'future_all') {
    payload.start_date = formData.get('start_date');
    payload.start_hour = formData.get('start_hour');
    payload.start_minute = formData.get('start_minute');
    payload.start_time = `${payload.start_date}T${payload.start_hour}:${payload.start_minute}`;
  } else {
    payload.start_time = formData.get('start_time');
  }
  return payload;
}

function validatePayload(payload) {
  if (!payload.battle_area_id || !payload.start_time || !payload.duration_hours) {
    showMessage('请填写所有必填字段', 'error');
    return false;
  }
  if (editScope === 'future_all') {
    if (!payload.start_date || !payload.start_hour || !payload.start_minute) {
      showMessage('请填写完整的时间信息', 'error');
      return false;
    }
    if (originalDate && payload.start_date !== originalDate) {
      showMessage('编辑未来所有循环时，日期不可修改', 'warning');
      return false;
    }
  }
  return true;
}

async function handleConflictCheck() {
  const payload = collectFormPayload();
  if (pilotId) payload.pilot_id = pilotId;
  payload.exclude_id = announcementId;
  if (!validatePayload(payload)) return;
  try {
    showLoading(true);
    const result = await fetchJson('/announcements/api/check-conflicts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify(payload),
    });
    const data = result.data || {};
    if (data.has_conflicts) {
      renderConflicts(data.conflicts || []);
      resetSubmitButton();
    } else {
      renderPlannedInstances(data.planned_instances || []);
    }
  } catch (error) {
    console.error('冲突检查失败:', error);
    showMessage(error.message || '冲突检查失败', 'error');
  } finally {
    showLoading(false);
  }
}

async function handleFormSubmit(event) {
  event.preventDefault();
  if (submitBtn.disabled) {
    showMessage('请先通过冲突检查', 'warning');
    return;
  }
  const payload = collectFormPayload();
  if (!validatePayload(payload)) return;
  try {
    showLoading(true);
    submitBtn.disabled = true;
    submitBtn.textContent = '保存中...';
    const result = await fetchJson(`/announcements/api/announcements/${announcementId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify(payload),
    });
    const meta = result.meta || {};
    showMessage(meta.message || '更新通告成功', 'success');
    window.location.href = meta.redirect_url || `/announcements/${announcementId}`;
  } catch (error) {
    console.error('更新通告失败:', error);
    const conflicts = error.response?.meta?.conflicts;
    if (conflicts) renderConflicts(conflicts);
    showMessage(error.message || '更新通告失败', 'error');
    submitBtn.disabled = false;
    submitBtn.textContent = '保存修改';
  } finally {
    showLoading(false);
  }
}

function bindFieldChangeReset() {
  ['battle_area', 'start_time', 'duration_hours', 'start_date', 'start_hour', 'start_minute'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('change', clearConflicts);
      el.addEventListener('input', clearConflicts);
    }
  });
}

xSelect.addEventListener('change', async () => {
  await loadYOptions(xSelect.value);
  clearConflicts();
});

ySelect.addEventListener('change', async () => {
  await loadZOptions(xSelect.value, ySelect.value);
  clearConflicts();
});

zSelect.addEventListener('change', () => {
  hiddenBattleArea.value = zSelect.value;
  clearConflicts();
});

document.getElementById('check_btn').addEventListener('click', handleConflictCheck);
announcementForm.addEventListener('submit', handleFormSubmit);

document.addEventListener('DOMContentLoaded', async () => {
  resetSubmitButton();
  try {
    await loadAnnouncementDetail();
    await loadAreaOptions({
      preselectX: preselectCoords.x,
      preselectY: preselectCoords.y,
      preselectBattleArea: preselectCoords.battleAreaId,
    });
    bindFieldChangeReset();
  } catch (error) {
    console.error('初始化通告编辑页面失败:', error);
    if (submitBtn) submitBtn.disabled = true;
  }
});

async function loadAnnouncementDetail() {
  if (!announcementId) {
    showMessage('缺少通告ID，无法加载详情', 'error');
    throw new Error('missing announcement id');
  }
  try {
    showLoading(true);
    const { data } = await fetchJson(`/announcements/api/announcements/${announcementId}`);
    announcementDetail = data || {};
    pilotId = data?.pilot?.id || '';
    if (pilotInfoEl) {
      const pilotName = data?.pilot?.nickname || '未知主播';
      const realName = data?.pilot?.real_name ? ` [${data.pilot.real_name}]` : '';
      const ownerName = data?.pilot?.owner?.display_name ? ` - ${data.pilot.owner.display_name}` : ' - 无所属';
      pilotInfoEl.textContent = `${pilotName}${realName}${ownerName}`;
    }
    if (pilotHiddenInput && pilotId) {
      pilotHiddenInput.value = pilotId;
    }

    const timeInfo = data?.time || {};
    const startIso = timeInfo.start_iso || (timeInfo.start ? timeInfo.start.replace(' ', 'T') : '');
    if (editScope === 'future_all') {
      if (startIso && startDateInput && startHourSelect && startMinuteSelect) {
        const [datePart, timePart] = startIso.split('T');
        if (datePart) {
          originalDate = datePart;
          startDateInput.value = datePart;
        }
        if (timePart) {
          const [hourStr = '', minuteStr = ''] = timePart.split(':');
          if (hourStr) startHourSelect.value = hourStr;
          if (minuteStr) startMinuteSelect.value = minuteStr;
        }
      }
    } else if (startTimeInput) {
      startTimeInput.value = startIso || '';
    }

    const durationHours = timeInfo.duration_hours;
    if (durationHours !== undefined && durationHours !== null && durationSelect) {
      if (typeof durationHours === 'number' && Number.isFinite(durationHours)) {
        const durationValue = Number.isInteger(durationHours) ? durationHours.toFixed(1) : String(durationHours);
        durationSelect.value = durationValue;
      } else {
        durationSelect.value = String(durationHours);
      }
    }

    const coordinates = data?.coordinates || {};
    preselectCoords = {
      x: coordinates.x || '',
      y: coordinates.y || '',
      battleAreaId: coordinates.battle_area_id || '',
    };
    if (hiddenBattleArea) {
      hiddenBattleArea.value = preselectCoords.battleAreaId || '';
    }

    const recurrence = data?.recurrence || {};
    if (recurrence.is_in_group && recurrenceNotice && recurrenceScopeText && recurrenceDescriptionText) {
      recurrenceNotice.style.display = 'block';
      if (editScope === 'future_all') {
        recurrenceScopeText.innerHTML = '编辑范围：<strong>未来所有循环</strong>';
        recurrenceDescriptionText.textContent = '此次修改将影响从当前通告开始的所有未来循环事件。';
      } else {
        recurrenceScopeText.innerHTML = '编辑范围：<strong>仅这一次</strong>';
        recurrenceDescriptionText.textContent = '此次修改只会影响当前这个通告，不会影响其他循环事件。';
      }
    }
  } catch (error) {
    showMessage(error.message || '加载通告详情失败', 'error');
    throw error;
  } finally {
    showLoading(false);
  }
}
</script>
{% endblock %}
