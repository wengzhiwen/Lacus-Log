# 最新的更新内容
> 以下所有日期为更新发生时的系统GMT+8时间

## 2025-10-26 新增：
- 开播新日报明细表格增加前端排序机制：支持所有列的点击排序功能，包含主播、流水、分成、毛利等关键字段，数字类型默认降序，字符类型支持中文排序。

## 2025-10-26 修复：
- 新建主播页面提交按钮增加防重复提交机制：提交时禁用按钮并显示"创建中..."状态，防止用户多次点击导致的重复提交。
- 开播记录登记页参考底薪改为依据登记当日主播结算方式判定，仅当结算方式为日结或月结底薪时默认150元，无底薪模式下即使有关联通告也默认0元。
- 开播记录登记页新增结算方式参考板块，实时展示当前主播于所填日期的结算类型与生效日期，便于现场确认。

## 2025-10-26 新增：
- 内部BBS实现“仅看未读”提醒：帖子作者或已回复者在收到新回复时会进入待阅列表，API返回`is_unread`标记并可用`unread=1`过滤，进入帖子详情后自动清除未读。

## 2025-10-26 优化：
- 开播记录登记页及新建通告页的主播下拉框新增活跃主播置顶逻辑：依据最近48小时内的通告或开播记录生成活跃列表，结果缓存60分钟，保持原有搜索与选项数量不变。

# 历史的更新内容

## 2025-10-25 新增：
- 底薪申请第5/6笔确认发放新增“新主播生存警告”邮件：复用詹姆斯关注通道，自动汇总近7日业绩与明细，向运营/管理员推送`拉科斯警告 这是一个活到了第n天的新主播`
- 开播新月报（加速版）API返回daily_series日级累计数据，可直接驱动折线/柱形图等可视化
- 月报页面摘要卡片支持点击后弹出Chart.js折线+柱状混合图，沿用当前筛选条件的日累积与当日数据
- 主播业绩API新增月度daily_series，前端本月摘要卡片支持Chart.js弹窗（流水/底薪/公司分成/开播时数展示当日柱+累计折线，运营利润展示允许负值的累计折线，并可在弹层内切换指标）
- 快速月报明细表支持点击表头进行纯前端排序，可在不刷新页面的情况下按任意字段重排数据
- 招募日报新增14日趋势折线图，API返回累计daily_series并在招募统计与指标说明之间直接渲染四条折线（约面/到面/试播/新开播）

## 2025-10-24 修改：
- 完全重构REST API的集成测试pytest
- 向所有的agent指定，如果要进行REST API的新增或修改必须采用test-driven的方式来进行
- 未下播提醒邮件模板去掉"开播方式"列，保留其他必要信息字段
- 线上主播未开播提醒邮件模板移除"开播地点"和"开播方式"两列，简化邮件内容

## 2025-10-23 其他：
- 仪表盘“蔷薇花下”卡片新增最后回复信息，展示运营昵称及GMT+8更新时间
- 首页仪表盘移除翻牌动画，提升移动端加载与显示性能
- 开播记录详情页新增“吐槽”按钮，可快速触发关联BBS主贴并自动留言
- 新增“开播新月报（加速版）”页面与API，单独复用优化算法评估新实现效果
- 开播新日报去除返点计算，调整当日毛利为公司分成减底薪并精简明细字段

## 2025-10-23 修复：
- 内部BBS回复提交按钮增加提交中状态，阻止重复点击导致重复回复
- 内部BBS列表与详情在关联开播记录缺失时提醒用户并继续展示，避免接口异常
- 仪表盘各卡片恢复默认点击跳转逻辑，即使动态链接尚未加载也能正常响应
- 线下底薪流水转化率仪表改为跳转开播新月报（加速版）并默认筛选线下开播方式

## 2025-10-22 新增：
- 内部BBS新增邮件提醒：支持主贴作者在收到新回复时提醒、楼层作者在收到楼中楼回复时提醒、以及直属运营在关联主播触发自动主贴时提醒，邮件内容包含板块、事件摘要与快速入口

## 2025-10-21 修复：
- 主播结算管理页面修复“变更记录”按钮点击无响应的问题
- 主播结算方式编辑页下拉框默认值同步当前记录，避免误改
- 状态开关样式优化，切换时文案与排版保持整齐
- 底薪申请日/月结明细排序调整为按主播昵称字典序优先、更新时间逆序，文档同步更新
- 底薪申请列表移除页面可见性监听刷新，避免切换标签页时重复发起请求

## 2025-10-20 新增：
- 内部BBS模块：实现板块管理、帖子列表、通用弹出层详情页与回复链路，支持帖子置顶、隐藏、编辑、关联主播等操作，并在开播记录创建有备注时自动生成对应主贴
- 主播业绩页展示最近相关BBS主贴
- 仪表盘新增“内部BBS最新”卡片

## 2025-10-19 修改：
- 邮件日报与月报改为复用开播新日报/新月报统计结果，统一数据来源并保持邮件字段为前端报表的子集
- 仪表盘线下底薪流水转化率卡片改为复用开播新报表底薪口径，点击跳转新月报页面
- 底薪展示降级移除：开播记录列表、主播业绩与詹姆斯告警不再回退到开播记录底薪字段，统一显示底薪申请金额/状态，无申请显示“未申请”

## 2025-10-19 新增：
- 未下播提醒邮件报表：每日 GMT+8 12:00 自动检查持续超过 8 小时仍标记为开播中的记录并发送提醒邮件，同时在邮件报告页面新增手动触发入口与文档说明。

## 2025-10-18 新增：
- 月结底薪的底薪申请流程
- 开播新日报/新周报/新月报：新增完全独立的新报表套件，前后端与旧版报表隔离，并改为按照底薪申请确认金额统计底薪相关指标
- 底薪申请记录导入脚本：新增`scripts/import_base_salary_applications.py`脚本，支持从CSV文件批量导入底薪申请记录。脚本具备完整的数据验证、重复检查、预览确认等功能，支持日结和月结底薪申请记录导入

## 2025-10-18 修复：
- 底薪申请详情页操作人字段显示错误修复：修复底薪申请详情页"最近操作人"字段显示"未操作"的问题。现在会正确显示最后一次状态变更操作人的昵称。修改了序列化工具`serialize_base_salary_application`函数，添加查询最新变更记录的逻辑，并更新前端模板正确显示操作人信息
- 开播月报返点计算逻辑修复：修复开播月报中返点计算与开播记录筛选时间范围不一致的问题。之前返点计算使用月份最后一天，而开播记录筛选在当前月时使用昨天作为结束时间，导致数据不一致。现已统一使用相同的时间范围逻辑，确保当前月时返点计算也使用昨天作为结束时间，避免包含今天及今天之后的数据影响统计准确性

## 2025-10-18 修改：
- 主播结算方式新增页面允许自由设定生效日期，移除前端日期限制提示并同步更新结算管理文档
- 主播业绩与开播记录底薪展示逻辑改为读取底薪申请结果，后端统一按已发放申请聚合底薪，并在列表、详情页显示申请状态与链接
- 詹姆斯关注告警改为在底薪申请确认发放时触发，邮件报表直接复用主播业绩统计结果，底薪数据与业绩页保持一致

## 2025-10-17 修改：
- 底薪申请列表卡片字段优化：新增申请人昵称和结算方式（快照）字段，调整卡片字段显示顺序为直属运营、申请人、开播时间、结算方式、流水金额、申请底薪；CSV导出表头同步调整

## 2025-10-17 修复：
- 底薪申请详情页窄屏按钮布局：修复窄屏时footbar按钮布局不对的问题，调整为与主播详情页一致的响应式设计，使按钮在窄屏时水平并排显示而非竖排堆叠

## 2025-10-16 修复：
- 底薪申请页结算方式显示错误：修复底薪申请页面的结算方式显示算法错误，确保与开播记录详情页使用相同的计算逻辑
- pilots API和前端undefined参数处理：修复/api/pilots/undefined等无效参数导致的500错误和前端链接问题
- 申请底薪页面404问题：修复开播记录详情页申请底薪按钮点击后出现404错误的问题
- 底薪申请详情页面路由缺失：修复底薪申请列表点击记录后无法跳转到详情页面的问题
- 底薪申请CSV导出功能修复：解决导出时出现500错误的问题
- 底薪申请详情页面优化：修复操作时间显示问题并移除多余弹窗
- 底薪申请页面导航优化：确保从详情页返回列表页时数据能够刷新
- 底薪申请详情页面时间格式修复：解决变更记录中操作时间显示问题

## 2025-10-16 修改：
- 底薪申请页面功能优化：修改底薪申请页面，从开播记录读取底薪金额并自动填入输入框，将底薪金额输入控件改为普通textbox，添加底薪金额数值合法性检查，新增底薪不为150元时的警告提示和备注必填规则
- 底薪申请详情页面超链接功能：增强页面间的导航体验
- 底薪申请详情页面样式和交互优化：统一与开播记录详情页面的风格
- 底薪申请列表统计数据卡片：在筛选器和数据明细之间添加当日统计信息展示

## 2025-10-16 新增：
- 主播结算管理功能：基本完成联调中

## 2025-10-16 修改：
- 开播记录时间筛选优化：将时间筛选下拉选框替换为日期选择控件，默认显示当天日期(GMT+8)

## 2025-10-16 新增：
- 开播记录状态字段功能：为开播记录系统新增状态字段，支持"开播中"和"已下播"两种状态

## 2025-10-16 修改：
- 开播日报明细显示优化：在开播日报明细表中"播时"列后新增"状态"列，显示该条开播记录的状态。状态为空或未设置时显示为"已下播"，状态为"开播中"时用红色字体显示

## 2025-10-16 修改：
- 主播业绩页开播记录状态指示器：在主播业绩页面底部的最近开播记录中，为状态为"开播中"的记录添加红色脉动的"开播中"标识，显示在日期时间右侧，与开播记录列表页保持一致的视觉体验

## 2025-10-15 新增：
- 线上主播未开播提醒邮件报表功能：新增每天GMT+8 17:00自动发送的线上主播未开播提醒邮件

## 2025-10-14 修改：
- 试播决策页面主播信息字段优化：在试播决策页面新增主播昵称和真实姓名文本框，预先填入主播信息中已有的数据，提交时检查字段不许为空，并在提交试播决策时同步更新主播管理中的主播信息

## 2025-10-14 修复：
- 招募列表分组排序bug修复：修复招募列表中各分组显示顺序混乱的问题
  - 后端修复：修复/api/recruits接口排序逻辑bug，之前虽然提取了sort_field但从未使用，导致所有排序都按created_at执行
  - 后端新增：在序列化函数中添加sort_order字段，根据不同状态计算正确的排序值（待面试按预约时间升序、待预约试播按面试决策时间逆序、待试播按预约试播时间升序、待预约开播按试播决策时间逆序、待开播按预约开播时间升序、鸽分组按状态顺序+最后更新时间逆序、已结束按最后更新时间逆序）
  - 前端优化：在groupAndRender、fetchAndRenderRecruits、performClientSideSearch三处添加按sort_order字段排序的逻辑，确保所有分组内记录按正确顺序显示
  - 设计原则：将复杂排序规则统一在后端计算，前端只需按sort_order数值升序排序即可，降低前端复杂度并保证排序逻辑一致性

## 2025-10-14 修改：
- 开播月报筛选范围优化：当报告月是当前月时，筛选范围调整为"当月1日到昨天为止"，不包含今天及今天之后的开播记录，避免包含未完成的开播数据影响统计准确性
- 开播月报运营利润估算计算错误：修复阅读汇总中运营利润估算数据计算错误的问题。该数据应该是所有主播的月累计毛利计算结果的合计，但之前total_rebate字段被错误地设置为0，导致运营利润估算（公司分成+返点-底薪）计算结果不准确。现已在_calculate_month_summary和_calculate_monthly_summary两个函数中正确计算所有主播的返点总额，确保运营利润估算数据的准确性
- 招募列表筛选器折叠按钮摘要显示：为招募列表添加筛选器摘要更新功能（updateFilterSummary），使折叠按钮能够正确显示当前选择的筛选组合（如"鸽 + 小明"），而不是始终显示"全部显示"
- 招募日报详情页主播显示格式优化：将主播显示从仅显示昵称改为"昵称(真实姓名)"格式，当真实姓名存在时同时显示昵称和真实姓名，提升信息完整性和识别度

## 2025-10-13 修复：
- 招募列表页面loading状态优化：修复页面初始化时会出现两次全局waiting icon的问题。将fetchAndRenderRecruits()和populateFilters()中的RecruitAPI调用改为原生fetch()，避免触发全局loading overlay。页面使用局部loading状态（参考主播列表实现），在列表区域显示loading spinner，下方operations面板加载不会阻塞或影响主列表加载

## 2025-10-13 新增：
- 招募列表时间筛选功能：参考通告列表实现，为招募列表新增时间筛选功能
  - 新增时间筛选选项：全部（默认）、这两天
  - 全部：显示所有招募记录，与当前实现完全一致
  - 这两天：仅显示最后更新时间在从当前日期(GMT+8)-2 到当前日期间的招募记录，筛选在其他条件筛选后执行
  - 后端支持：新增 `/api/recruits/filter-options` 接口提供筛选选项，修改 `/api/recruits` 接口支持时间参数
  - 前端支持：更新招募列表页面UI，添加时间筛选下拉框，与通告列表保持一致的交互体验
  - 数据库优化：利用现有的 `updated_at` 字段索引，无需额外添加索引
  - 筛选持久化：使用 `persist_and_restore_filters` 保持筛选状态

## 2025-10-13 修复：
- 招募列表筛选逻辑历史数据兼容性问题（完整修复）：修复"进行中"筛选时未正确排除历史数据超时记录的bug。问题根源有两方面：(1) MongoDB查询只使用了新字段，未包含废弃字段（training_decision_time_old、training_time等）的降级读取；(2) 更重要的是，查询只匹配新状态枚举值，未匹配历史状态值（如"已启动"→"待面试"、"待训练"/"试播招募中"/"训练征召中"→"待试播"、"待预约训练"→"待预约试播"）。现已在RecruitStatus枚举中添加所有历史状态值（PENDING_TRAINING_SCHEDULE_OLD、PENDING_TRAINING_OLD），并在查询中同时匹配新旧状态和新旧字段，确保所有历史数据都能被正确判定为超时状态。超时记录数从36条增加到50条，覆盖所有应该归入"鸽"分组的历史数据

## 2025-10-13 新增：
- 数据库恢复脚本密码重置功能：在restore_mongodb.py脚本中新增--resetpassword参数，支持在数据恢复后自动将所有用户密码重置为123456（使用当前环境的加密配置）。解决生产环境数据恢复到测试环境后密码失效的问题，提供独立密码重置模式，增强防呆确认机制

## 2025-10-13 修复：
- 数据库恢复脚本跨数据库恢复问题：修复mongorestore命令在备份库与目标库名称不同时无法正确恢复的问题。改进脚本逻辑，自动检测备份目录中的数据库名称并正确指定源路径，支持生产环境备份（lacus库）恢复到本地测试环境（test_lacus_*库）的跨数据库恢复场景

## 2025-10-13 新增：
- 测试环境标识功能：当LOG_LEVEL=DEBUG时，页面顶部标题栏显示两个logo以提示测试环境，正常环境显示一个logo，帮助用户区分当前运行环境

## 2025-10-12 修复：
- 招募操作记录时间显示问题：修复招募变更记录中显示的时间不是GMT+8的问题，统一调整时间序列化逻辑，确保所有操作记录时间和变更字段中的日期时间值都正确显示为GMT+8格式，符合文档约定

## 2025-10-12 新增：
- 招募记录检测功能：新增 `/api/recruits/check-pilot/<pilot_id>` 接口，用于检测指定主播是否已有招募记录，返回最近创建的招募记录详情（创建时间GMT+8、运营昵称、当前状态等）
- 启动招募页面警告提示：在启动招募页面主播信息下方新增醒目的警告卡片，当主播已有招募记录时自动显示该主播的招募历史信息，包括创建时间、创建运营和当前招募状态
- 招募操作记录实时监控系统：实现完整的招募操作历史追踪和实时通知功能
- 招募决策防呆功能：不招募不是那么容易的
- 开播预约界面添加提醒：预约的开播日期与试播决策日期相同时，发出警告

## 2025-10-11 新增：
- 开播日报支持隐藏手势刷新缓存，触发API清空缓存后页面自动加载最新数据

## 2025-01-27 修复：
- **招募详情页面阶段信息丢失问题**：修复REST化过程中招募详情页面丢失其他阶段详细信息的问题，恢复试播预约阶段、试播阶段、开播预约阶段、开播阶段和历史数据的完整显示，确保各阶段决策人、决策时间等关键信息正确展示

## 2025-10-09 修复：
- **招募月报统计口径修正并增强日志输出**：修正招募月报中新开播数、满7天数、试播数的统计口径，并增加详细的INFO级别日志输出
  - **新开播数**：从按开播决策时间筛选改为按招募创建时间筛选（创建时间在窗口内且开播决策为正式/实习主播）
  - **满7天数**：从按开播决策时间筛选改为按招募创建时间筛选（创建时间在窗口内且主播有7条以上6小时以上开播记录）
  - **试播数**：从按试播决策时间筛选改为按招募创建时间筛选（创建时间在窗口内且有过试播决策）
  - **历史字段兼容性修复**：修复新开播数统计中遗漏历史枚举值(`正式机师`、`实习机师`)的问题，确保历史数据正确计入统计

## 2025-10-09 新增：
- **主播招募月报功能模块开发**：完成主播招募月报功能的全套开发

## 2025-10-09 修复：
- **修复用户创建API默认角色问题**：修复REST化后用户创建时要求必须提供角色字段的问题：
- **实现前端自动Token刷新与请求重试机制**：修复生产环境中Token过期后需要重新登录的问题：
- **主播业绩页开播明细跳转404问题**：修复主播业绩页面底部开播记录点击跳转到开播明细详情时的404错误。将链接从`/battle_records/{id}`修正为`/battle-records/{id}`，确保与Flask路由配置一致
- **主播管理页面loading样式统一**：统一主播管理相关页面（列表、详情、业绩、编辑）的loading图标样式，全部使用CSS旋转动画圆圈，替代原有的emoji图标，提升用户体验的一致性
- **Waiting icon样式公共化**：将统一的loading图标样式抽取到公共CSS文件（static/css/style.css），并应用到运营（用户）管理相关页面，实现全系统loading状态的视觉一致性

## 2025-10-09 重构：
- **完全移除CSRF残留代码，实现纯JWT认证架构**：彻底清理系统中所有CSRF相关的残留代码，完成向纯JWT认证的完整转向

## 2025-10-09 文档：
- **新增《主播-招募月报》功能设计文档**：定义滚动30日招募月报的指标口径、页面结构、REST接口及组件复用策略

## 2025-10-08 修复：
- **后端CSRF验证完全移除：API层完成JWT纯化**：从所有REST API中移除CSRF token验证逻辑：
  - **移除validate_csrf_header调用**：清理所有API路由中的CSRF验证代码块
  - **移除csrf_helper导入**：从所有API文件中移除`from utils.csrf_helper import CSRFError, validate_csrf_header`
  - **清理范围**：announcements_api.py（4处）、users_api.py（5处）、commissions_api.py（4处）、recruits_api.py、battle_areas_api.py、report_mail.py（4处）、auth_api.py
  - **统一JWT认证**：所有API现在完全依赖`@jwt_roles_accepted`和`@jwt_roles_required`装饰器进行认证和授权
  - **代码格式化**：使用yapf对所有修改的API文件进行格式化
- **前端CSRF代码清理：完成JWT纯化**：系统已完全移除CSRF token保护机制，进行前端代码全面清理：
  - **移除CSRF token函数调用**：清理所有模板文件中的`getCSRFToken()`函数调用和`csrfToken`变量定义
  - **移除CSRF请求头**：清理所有fetch请求中的`'X-CSRFToken': csrfToken`请求头
  - **统一JWT认证方式**：所有API请求统一使用`credentials: 'include'`自动携带JWT cookie
  - **清理范围**：涵盖通告模块（detail.html、edit.html、new.html、cleanup.html）、用户模块（list.html、detail.html、edit.html、new.html）、主播模块（new.html、edit.html、commission相关页面）、地点模块（generate.html、edit.html、new.html）、邮件报告（mail_reports.html）、基础模板（base.html）和静态JS（recruit-api.js）
  - **去除自定义CSRF函数定义**：移除各页面中自定义的`getCSRFToken()`函数（如users/edit.html、pilots/commission模块等）
- **认证架构彻底简化：完全移除CSRF体系**：为彻底解决JWT认证与CSRF验证的冲突，进行了完整的架构清理：
  - **移除Flask-WTF依赖**：从app.py中完全移除CSRFProtect的导入和初始化，禁用全局CSRF保护
  - **清理模板引用**：从base.html和所有相关模板中移除csrf_token()函数调用，解决'csrf_token' is undefined错误
  - **简化API代码**：从battle_records_api.py中移除所有CSRF验证逻辑（validate_csrf_header调用和CSRFError导入）
  - **清理前端代码**：移除所有模板中的CSRF token hidden字段和JavaScript中的csrfToken变量引用
  - **统一JWT认证**：所有API请求使用credentials: 'include'发送JWT cookie，依赖Flask-JWT-Extended的内置CSRF保护
- **JWT token传递优化**：修复开播记录新建页面API调用中的JWT token传递问题：
  - **新增getJWTToken函数**：从cookie中提取access_token_cookie
  - **创建apiFetch辅助函数**：统一处理所有API请求，自动添加Authorization: Bearer <token>头部
  - **更新所有fetch调用**：将页面中的所有fetch调用替换为apiFetch，确保JWT token正确传递
  - **禁用JWT CSRF保护**：设置JWT_COOKIE_CSRF_PROTECT=False，解决JWT认证与CSRF机制的冲突
  - **优化调试能力**：添加详细的控制台日志和认证状态检查，帮助诊断JWT token传递问题
  - **确认HTTP兼容性**：验证JWT_COOKIE_SECURE配置在开发环境中正确设置，支持HTTP协议
现在系统完全基于JWT认证，前后端代码全面清理完成，架构统一简洁，不再有任何CSRF相关的代码和错误

## 2025-10-07 修复：
- 枚举值0判断错误的全面修复：修复系统中所有使用`if not value`判断枚举值/数值的逻辑错误，统一改为`if value is None or value == ''`精确判断空值。修复范围包括：try_enum函数（pilots_api.py和recruits_api.py）、_has_enum_value函数（pilots_api.py和recruits_api.py）、birth_year_str验证（recruits_api.py）。这个bug会导致值为0的枚举（如性别=男）被错误地视为空值而使用默认值
- 主播详情页返回按钮404问题：修复从开播记录详情页点击主播昵称跳转到主播详情页后，返回按钮URL错误导致404的问题。将返回URL从`/battle_record/{id}`修正为`/battle-records/{id}`，确保能正确返回到开播记录详情页
- 主播性别默认值错误：修正主播模型中性别字段默认值从"女"改为"不明确"，同步更新新建/编辑主播页面的性别下拉框顺序（不明确/男/女），确保与业务需求文档一致
- 菜单滚动问题：修复移动端打开菜单时，鼠标滚轮滚动的是背后页面而非菜单的问题。通过在菜单打开时禁用body滚动（添加menu-open类），并为菜单容器添加overflow-y: auto使其自身可滚动来解决

## 2025-10-07 新增：
- CSRF校验统一化：创建 utils/csrf_helper.py 统一CSRF校验模块，提供 validate_csrf_header() 函数和 CSRFError 异常类，实现 Double-submit Cookie + Custom Header 校验机制
- JWT认证体系：在app.py中配置Flask-JWT-Extended，创建routes/auth_api.py提供REST认证API（登录、登出、token刷新、获取当前用户等），支持Access Token + Refresh Token机制，与Flask-Security-Too完全兼容
- Session安全配置：添加SESSION_COOKIE_SECURE、SESSION_COOKIE_HTTPONLY、SESSION_COOKIE_SAMESITE配置，增强Session Cookie的安全性，防止XSS和CSRF攻击
- API集成测试框架：搭建完整的pytest+httpx集成测试基础设施，包括ApiClient测试客户端、测试数据工厂（Faker）、admin_client和kancho_client fixtures。实现用户管理API的17个集成测试用例，覆盖列表查询、创建、详情、更新、激活/停用、密码重置、运营列表、邮箱列表等全部功能

## 2025-10-07 重构：
- 通告详情页：改为完全使用REST API加载数据，通过JavaScript调用 /announcements/api/announcements/<id> 接口获取所有信息并动态渲染，同时完整保持原有的用户体验（包括编辑/删除的模态框交互）
- 所有REST API模块：重构为使用统一的CSRF校验，删除各模块中重复的校验函数
- 清理遗留的表单POST端点：删除announcement.py的delete端点、admin.py的toggle/reset端点（已被REST API替代），移除pilot.py的new/edit路由中多余的POST方法声明

## 2025-10-06 新增：
- 仪表盘昨日主播排名卡片：新增"昨日主播排名"卡片，位于线下底薪流水转化率卡片下方，展示昨日流水排名前三的主播（冠军、亚军、季军）。显示格式为"昵称（真实姓名）[直属运营昵称]"（优先显示运营昵称，无昵称时降级显示用户名），统计所有开播方式的记录，按流水金额总和降序排列

## 2025-10-06 新增：
- 仪表盘线下底薪流水转化率卡片：新增"线下底薪流水转化率"卡片，位于招募统计卡片下方，展示本月转化率（主数据）、昨日转化率和上周转化率（副数据）。仅统计线下开播记录，转化率=流水金额总和/底薪金额总和×100%，数据计算截至昨日，与日报/周报/月报的算法保持一致。点击卡片跳转到开播月报页面

## 2025-10-06 新增：
- 招募日报趋势指示器：报表日数据右侧显示与7日均的对比趋势，7日均数据右侧显示与14日均的对比趋势，上升显示红色↑，下降或持平显示绿色↓（带绿色泛光呼吸动画效果），帮助用户快速识别招募工作趋势

## 2025-10-06 修改：
- 招募日报数据展示优化：将百分比改为日均数据，7日和14日统计行分别显示7日均和14日均，便于用户直接对比不同时期的日均表现

## 2025-10-06 修改：
- 开播日报明细排序优化：改为按当日毛利升序排列（亏钱多的排在前面），便于优先关注亏损记录

## 2025-10-06 修复：
- 开播时数显示格式统一为小数点后1位：修复主播业绩页面、开播记录列表、开播记录详情页中的开播时数显示，统一使用1位小数格式（如"6.5小时"），与开播日报/月报/周报保持一致

## 2025-10-06 修复：
- 所有表单页面的选择器宽度异常问题：为所有表单的 input、select、textarea 元素添加 width: 100% 样式，确保初始加载时宽度正常，解决了主播选择器等下拉框在初始时宽度异常的问题

## 2025-10-06 优化：
- 通告导出页面主播选择器：统一为与新建通告页面一致的搜索+下拉框形式，支持通过昵称或真实姓名快速筛选主播，并在显示名称中包含直属运营信息

## 2025-10-06 修改：
- 未开播提醒邮件报表筛选逻辑：改为查找通告所在日（GMT+8）该主播是否有任何开播记录，超时判定时间从4小时延长至6小时
- 开播日报和开播月报邮件发送时间调整：从每天 GMT+8 12:00/12:02 推迟到 15:00/15:02（推迟3小时）

## 2025-10-06 新增：
- 通告列表时间筛选器新增两个选项："月底为止"（今天到当月最后一天）和"次月"（次月全月）
- 开播记录列表时间筛选器新增两个选项："月初以来"（当月第1天到今天）和"前月"（上月全月）

## 2025-10-06 修复：
- 通告删除后引用完整性问题：修复删除循环通告时孤立引用导致列表页报错的问题，在序列化时优雅处理已删除的父通告引用，在删除时清理所有指向该通告的子通告引用
- 招募日报详情页排版问题：修复REST化过程中丢失的样式属性，恢复卡片左右对齐布局，降低卡片高度
- 招募详情页返回逻辑：修复从招募日报详情页进入招募详情时，返回按钮路径错误导致404的问题，并实现URL参数在招募详情页、编辑页之间的正确传递

## 2025-10-06 重构：
- 通告编辑页与开播记录新建/编辑页改为运行时调用 REST 接口初始化表单，移除模板级预填并保持原有校验/冲突检查体验
- `utils/announcement_serializers.py` 新增坐席 ID、时长及 ISO 开始时间字段，支撑前端 REST 初始化逻辑

## 2025-10-06 优化：
- 统一通告编辑页面与通告新增页面的样式风格，包括返回按钮、布局、配色、圆角设计等，提升前端用户体验一致性
- 通告详情页底部功能按钮布局：设置合理的最小/最大宽度（桌面端 100px-240px，移动端 70px 起），按钮宽度可根据页面宽度自适应并平均分布，为页面内容底部添加留白防止被遮挡
- 主播详情页底部操作按钮优化：采用固定底部栏（footbar）设计与通告详情页保持一致，去除按钮上的图标，优化按钮配色（编辑/业绩查看使用 primary 蓝色，启动招募使用 hud 绿色，分成管理/变更记录使用 outline 灰色），按钮宽度自适应（桌面端 80px-200px，移动端 60px 起）并平均分布

## 2025-10-05 修复：
- 主播管理列表分页问题：将单次数据量上限从20条提升至500条
- 通告管理列表分页问题：将数据量上限从100条提升至500条
- 开播记录列表分页问题：将每页数据量从100条提升至500条
- 主播招募列表页搜索功能修复，改回纯前端的搜索
- 开播记录列表卡片布局恢复左右对齐混排，修复REST化后高度异常

## 2025-10-05 重构：
- 主播招募日报 REST 化：新增 `/api/recruit-reports/daily` 汇总/详情接口，招募日报与详情页面改为前端 fetch 数据，保持原有统计口径与权限校验
- 首页仪表盘 REST 化：将计算逻辑迁入 `routes/report.py`，拆分 `/api/dashboard/recruit|announcements|battle-records|pilots|candidates|feature` 接口，并调整首页模板动态加载
- 主播业绩页 REST 化：新增 `GET /api/pilots/<id>/performance` 接口并改造 `templates/pilots/performance.html` 纯前端加载数据，保留既有统计口径与返回导航体验

## 2025-10-04 重构：
- 主播开播日报/周报/月报 REST 化：新增 `/reports/api/daily|weekly|monthly` 接口并改造对应模板为前端 fetch 数据，沿用既有计算逻辑与筛选体验，CSV 导出保持原路径

## 2025-10-03 重构：
- 主播管理模块前端REST化：完成主播管理模块的RESTful API改造，实现统一的JSON响应格式和前端API调用
- 分成管理模块REST化：完整实现前后端改造
- 主播招募模块REST化：完成主播招募模块的RESTful API改造，实现统一的JSON响应格式和前端API调用
- 开播地点管理模块REST化：全套 REST 接口，列表、详情、新建、编辑、删除均切换为 JSON 流程，前端以 fetch 提交但保留原有用户体验
- 通告管理模块REST化：同时完成了通告清理与导出功能的 RESTful API 改造。
- 通告日历 REST 化：接口至独立蓝图，前端改用新端点，保持原有页面样式与交互。
- 开播记录 REST 化：核心 CRUD 与辅助接口，列表/新建/编辑/详情全面改为 AJAX 流程。

## 2025-10-02 新增：
- 用户管理模块REST化：完成用户管理模块的RESTful API改造，实现统一的JSON响应格式和前端API调用

## 2025-10-02 重构：
- 测试系统清理：移除项目中所有pytest测试文件、测试运行脚本和测试相关配置，为后续重新构建测试体系做准备。

## 2025-10-02 新增：
- 主播招募模块：新增纯前端主播昵称/真实姓名筛选器，参考通告管理实现，支持实时搜索筛选。
- 主播招募模块：列表显示优化，同时显示主播昵称和真实姓名，提升信息展示完整性。


## 2025-10-02 文档：
- 用户管理模块：整理《基础-用户管理REST化指南》，记录现有 `/api/users` 接口与维护要点。
- 主播管理模块：整理《主播-主播管理REST化指南》，对齐已实现接口及待办事项。
- 招募模块：修订《主播-主播招募REST化指南》，说明尚未REST化、仍是表单流程。
- 分成管理：修订《主播-分成管理REST化指南》，标记改造缺口。
- 通告模块：修订《主播-通告REST化指南》，保留现有下拉 JSON 并说明缺失端点。
- 通告导出：修订《主播-通告导出REST化指南》，澄清目前仅有表单导出。
- 通告日历：更新《主播-通告日历REST化指南》，列出 `/calendar/api/*-data` 接口。
- 开播记录：修订《主播-开播记录REST化指南》，总结辅助 JSON 与缺口。
- 开播日报 / 周报 / 月报：修订三份指南，说明仍为模板渲染。
- 主播业绩 / 招募日报 / 首页仪表板 / 开播地点管理 / 邮件发送功能 / 邮件报告：修订各自指南，明确尚无 REST API。
- REST化经验谈：重写文档，整理统一响应、CSRF 策略、测试流程与常见坑，作为后续改造工具册。
- REST化方案：新增《REST化-CSRF与集成测试方案》，面向完全REST化后的统一CSRF策略与API集成测试流程。

## 2025-10-01 变更/新增：
- 开播邮件日报：定时由每日00:02调整为每日12:00发送前一自然日数据（APScheduler触发由UTC16:02改为UTC04:00）。
- 开播邮件月报：新增每日12:02发送"前一自然日所在月"的邮件月报（APScheduler触发UTC04:02），内容参考开播月报并优化为适合邮件阅读的精简格式。
- 开播周报：新增《主播-开播周报》设计文档，定义周二-周一统计规则与接口，周报放弃返点，盈利按"不计返点"口径计算。

## 2025-10-01 犁地：
- 精简Python文件注释（仅注释变更，不涉及代码逻辑），统一为简洁中文说明。
## 2025-10-01 修复/清理：
- 招募：移除历史"结束招募"页面与入口，统一采用六步制流程；
## 2025-10-01 优化：
- 开播月报支持直属运营与开播方式筛选（页面与导出均支持）。
- 直属运营筛选口径调整：以筛选范围内主播的"最后一次开播记录"的运营为准，避免同一主播同时计入多位运营。
- 开播日报移除月度部分：页面与邮件日报均回归纯"日报"口径；月度统计请前往开播月报。
- 开播方式筛选口径调整：以筛选范围内主播"最后一次开播记录"的开播方式为准，日报与月报一致，避免同一主播同时计入不同开播方式。

## 2025-10-01 优化：
- 开播日报：为月度与日报汇总的上半部数据卡片新增"前方飞入"戏剧化入场动画（桌面端3D透视与级联延时，移动端轻度位移以避免眩晕），不影响既有交互与导出功能。
 - 开播日报：当"运营利润估算"为负数时，卡片外框高亮为红色，快速提示亏损。
 - 开播日报：日报汇总新增"今日盈亏（不计返点）= 公司分成 - 底薪支出"，支持负数红框提示。
 - 开播月报：为上半部数据卡片新增"炸裂"入场动画（旋转+模糊+景深+级联），与日报样式区分；移动端适度减弱以避免眩晕。

## 2025-09-30 修复：
- 主播招募日报统计兼容性：修复"新开播"统计与详情查询未兼容旧用语（正式机师/实习机师）的问题，现已同时匹配旧枚举值，确保历史数据正确计入。

## 2025-09-30 变更：
- 主播招募日报"试播"口径调整：由"开播决策数量"改为"试播决策数量"。
  - 新字段：使用 `training_decision_time`（历史兼容 `training_decision_time_old`）
  - 详情页：按试播决策时间筛选与排序
  - 文案：同步更新模板与文档说明

## 2025-09-30 优化：
- 页头毛玻璃效果：为页面顶部通用页头（拉科斯日志和菜单汉堡按钮这行）添加毛玻璃效果，包括背景模糊、半透明和阴影，提升视觉层次感；透明度由0.8调整为0.6，更加通透
- 首页仪表盘入场动画：翻转方向改为沿Y轴从左向右翻开；初始为盖着状态，自上而下依次翻开；放慢整体节奏（更长动画与更大逐卡延时）；每次页面加载完成后自动播放一次；不影响卡片悬浮交互。

## 2025-09-30 新增：
- 首页仪表盘置顶国庆仪表盘
  - 限时显示：仅在 GMT+8 2025-10-01 00:00 至 2025-10-05 23:59 期间显示，其他时间自动隐藏。

## 2025-09-29 新增：
- 通告清理功能：在通告管理列表页新增"通告清理"入口与页面，支持按主播一键清理其"明天开始（GMT+8）"的所有通告；展示"流失（已阵亡）"主播及其剩余未来通告数，并提供不可恢复的批量删除操作。
- 开播记录备注必填验证功能：新增备注字段的智能验证机制，当满足特定条件时要求必须填写备注
  - 验证条件：开播时长小于6.0小时、开播时长大于等于9.0小时、底薪不等于0也不等于150、流水不等于0且小于100、流水大于等于5000、开播时间与关联通告时间相差超过6个小时
- 开播记录编辑/登记页：新增"播时（小时）"便捷输入（纯前端）
 
## 2025-09-29 重构：
- 通告管理列表筛选器精简为3项：直属运营、基地（X）、时间；时间选项改为"这两天（默认）/近7天/今天"，移除"阶级/场地（Y）/现在开始/全部"。
- 开播记录列表筛选器同样精简为3项：直属运营、基地（X）、时间；时间选项统一为"这两天（默认）/近7天/今天"，移除"主播分类/主播"。

## 2025-09-29 优化：
- 通告导出：
  - 导出页UI对齐主播详情风格：使用返回按钮取代面包屑；配色统一。
  - 主播选择优化：移除"所属/阶级"筛选，新增"昵称/真实姓名"本地搜索，纯前端过滤，不改变后端接口。

## 2025-09-28 新增：
- 开播月报缓存功能：为开播月报的运算结果添加15分钟缓存机制，使用cachetools库的TTLCache实现，相同条件下15分钟内不会重新计算，提升页面响应速度，服务重启时缓存自动清空
- 开播日报缓存功能：为开播日报的运算结果添加15分钟缓存机制，包括月度数据、日报汇总和日报明细计算，与开播月报使用相同的缓存策略，显著提升日报页面响应速度
- 主播业绩缓存功能：为主播业绩页的计算结果添加5分钟缓存机制，包括返点计算和业绩统计计算，相同主播5分钟内不会重新计算，提升业绩页面响应速度
- 底薪流水转换率：在开播日报和开播月报的汇总板块中，当既有底薪又有流水时，计算底薪流水转换率（流水/底薪），以百分比形式显示在底薪卡片的副数据位置，不保留小数

## 2025-09-28 优化：
- 主播业绩页：为底薪数值、运营利润估算和盈亏数据添加日均计算显示，算法为数值本身除以开播记录数量
- 数据库索引优化：为BattleRecord模型新增多个复合索引，显著提升开播日报查询性能，包括时间范围查询、主播相关查询、直属运营筛选等核心查询场景
- 索引管理机制：建立统一的索引管理机制，确保所有模型索引在应用启动时自动创建，符合项目研发约定
- 开播日报排序优化：开播日报明细数据改为按月累计毛利升序排序（亏损主播排在最前面），便于快速识别需要关注的主播
- 开播日报负数显示：明细表格中所有负数（当日毛利、月累计毛利）以红色字体显示，提升数据可读性
- 主播业绩页面：新增返回按钮功能，支持从开播日报、开播月报、主播详情、开播记录详情等不同来源正确返回，按钮统一显示"返回"文字
- 招募详情页面：将主播昵称改为超链接，点击可跳转到主播详情页面，提升用户体验和操作便利性
- 通告详情页面：将主播昵称改为超链接，与招募详情页面保持一致的用户体验
- 开播记录详情页面：将主播昵称改为超链接，与其他详情页面保持一致的用户体验
- 主播业绩页面：将主播昵称改为超链接，与其他页面保持一致的用户体验
- 主播详情页面：简化返回按钮标签为"返回"，并准确处理各种来源的正确返回路径

## 2025-09-28 新增：
- 詹姆斯的关注警告邮件功能：新增低业绩不努力主播自动告警机制，当开播记录保存时自动检查主播业绩情况，满足特定条件时发送警告邮件给全体运营和管理员，邮件包含主播基本信息和完整业绩数据，运算过程完全异步不阻塞用户操作
- 主播业绩页和詹姆斯关注告警邮件：新增主播状态显示，在主播基本信息中显示当前主播状态，便于快速了解主播当前状态
- 开播日报筛选功能：新增按直属运营筛选功能，支持全部或特定直属运营筛选，筛选逻辑优先使用开播记录中的直属运营快照，无快照时使用主播当前直属运营

## 2025-09-27 新增：
- 开播月报功能：基于开播日报功能实现的平级月度统计报告

## 2025-09-27 优化：
- 开播记录模块：从通告新建开播记录时底薪默认值设置为150元，用户仍可修改

2025-09-27  修复
- 主播管理筛选器：修复新旧用语混合显示问题，筛选器选项只显示新用语（候选人、试播主播、实习主播、正式主播），同时确保选择新选项时能正确筛选出包含旧用语的数据
- 作战记录筛选器：同步修复主播分类筛选的兼容性问题，确保新旧数据都能正确筛选
- 通告管理筛选器：同步修复主播分类筛选的兼容性问题，确保新旧数据都能正确筛选
- 主播显示层用语转换：新增Jinja2过滤器normalize_rank和normalize_status，实现在所有模板中将旧用语自动转换为新用语显示，确保UI界面统一使用新用语
- 开播日报和主播业绩页：应用用语转换过滤器，确保报表页面也统一显示新用语
- 招募流程所有页面：全面应用用语转换过滤器，确保招募相关页面统一显示新用语

2025-09-27  界面优化
- 通告详情页：整体布局和样式向招募详情页面看齐，采用统一的卡片式设计
- 招募详情页：去掉左上角的性别icon，简化页面布局
- 招募详情页：去掉重复的主播分类和当前状态信息，避免信息冗余
- 招募详情页：调整性别/年龄和直属运营的布局样式，与其他信息项保持左对齐
- 通告日历：优化从日历日视图点击通告进入详情页的返回逻辑，现在可以正确返回到之前的日历页面而非通告列表
- 通告编辑页：将主播字段改为只读显示，移除所属和阶级筛选器，简化编辑界面

2025-09-27  新增
- 主播管理：新增主播数据导出功能，支持导出所有主播数据为CSV文件

2025-09-27  新增
- 主播管理：为主播增加籍贯字段，支持0-20字符的文本输入，非必填字段

2025-09-27  新增
- 主播招募日报筛选功能：新增按招募负责人筛选功能，支持全部、管理员或特定运营筛选

2025-09-27  新增
- 主播招募日报详情页面功能：新增日报详情页面，支持点击统计表格中的任意数据单元格查看对应的具体招募记录

2025-09-27  重构
- 创建统一的招募统计工具模块 utils/recruit_stats.py
- 消除routes/report.py、routes/report_mail.py、routes/main.py中的代码重复
- 抽取共同逻辑，提高代码复用性和维护性

2025-09-27  文档重命名
- 按照统一用语规范重命名docs文件夹下的所有文档文件

2025-09-27  全面更新
- 应用统一用语规范
- 完成主播模块 招募模块的初步验证
- 完成所有模块的验证

2025-09-25  变更
- 作战记录新建页：移除"所属/阶级"筛选器，新增"昵称/真实姓名"本地搜索输入，纯前端过滤下方机师下拉，不影响提交内容；后端机师列表API补充返回real_name以支持搜索。
 - 作战计划新建页：同样接入"昵称/真实姓名"本地搜索，移除所属/阶级筛选；机师下拉显示文本优化为"昵称(年龄)真实姓名[阶级]性别icon"，不影响表单提交。

2025-09-25  新增
- 征召编辑页：按状态机逐步开放可编辑字段（预约训练/预约开播时间）；已结束状态仅查看
- 后端支持保存上述字段并记录变更日志，保持UTC入库/GMT+8显示

2025-09-25  变更
- 全站表单交互：禁用回车键触发表单提交，必须点击提交按钮；允许 textarea 与可编辑区域正常换行。

## 2025-09-23 修复
- 作战记录编辑页"所属"显示用户名问题，改为优先显示昵称。
- 统一详情页与编辑页"所属"来源，编辑页不再用接口覆盖快照。

2025-09-23 增强
- 作战计划管理列表：新增与机师管理一致的"机师昵称/姓名"前端搜索
- 纯前端实现，不影响后端筛选器；实时模糊匹配昵称与真实姓名
- UI与交互保持与机师管理一致（输入、回车、退格、按钮触发）

2025-09-23 修复
- 作战记录详情页在关联通告被删除时崩溃（DoesNotExist），改为显示"关联作战计划已被删除"。
- 作战记录编辑页在关联通告被删除时500，统一与详情页的安全处理；保存时若检测到关联通告已不存在则自动清空字段。
2025-09-23 异常处理
- 增加全局异常处理，所有500错误记录ERROR级堆栈与请求信息到日志文件。

2025-09-22 增强
- 日志：将 Flask/Werkzeug 的 ERROR 输出重定向到独立日志文件，按自然日切分（`log/flask_error_YYYYMMDD.log`、`log/werkzeug_error_YYYYMMDD.log`）；保持原有应用日志不变。
2025-09-22 修复
- 征召列表"鸽"筛选报错：修复排序时比较RecruitStatus枚举导致的TypeError；统一将排序键中的枚举转为其value，并完善二级时间降序逻辑；增加DEBUG日志输出鸽分组状态分布。

2025-09-22 重构
- 定时任务重构，结合mongoDB保证定时任务的可靠性

2025-09-21 新增
- 征召日报邮件报表功能：新增征召日报的邮件发送功能
  - 定时发送：每天0:05（GMT+8）自动发送前一天的征召日报邮件给所有舰长和议长
  - 手动触发：在议长邮件报告页面新增征召日报手动发送按钮，支持指定日期发送

2025-09-21 匹配
- 仪表板征召统计更新：修改征召统计卡片的数据显示，与征召日报保持一致
  - 副数据1更新：从"新增正式机师"改为"今日到面"，统计今日发生的面试决策数量
  - 副数据2更新：从"新增实习机师"改为"今日新开播"，统计今日在开播决策中决定征召的数量
  - 数据计算优化：使用MongoDB的Q对象实现复杂查询，支持新六步制字段和历史兼容字段
  - 历史数据兼容：确保新旧征召流程的数据都能正确统计和显示

2025-09-20 匹配
- 机师征召日报适配新六步制流程：完成征召日报功能对新六步制征召流程的适配
  - 数据统计更新
  - 查询优化

2025-09-19 重构
- 机师征召列表界面重构：优化征召列表的用户体验和操作效率
  - 筛选器简化：只保留状态筛选（进行中/鸽/已结束），移除负责人和渠道筛选
  - 分组显示：按征召状态和时间条件动态分组，包括待面试、待预约训练、待训练、待预约开播、待开播、鸽、已结束
  - 快速跳转：新增分组快速跳转按钮，根据数据动态显示，提供平滑滚动体验
  - 排序优化：每个分组独立排序，优先显示紧急和重要的征召记录
  - 浮动按钮：页面滚动时显示回到顶部按钮，提升长列表操作体验
  - 超时检测：自动识别超时征召记录，单独分组显示，便于及时处理
  - 响应式设计：优化移动端显示效果，快速跳转按钮和浮动按钮适配小屏幕

2025-09-20 重构
- 机师征召流程六步制实现：完成征召流程从三步制到六步制的全面重构
  - 数据模型扩展：新增InterviewDecision、TrainingDecision、BroadcastDecision枚举，扩展Recruit模型字段
  - 状态流转：待面试 -> 待预约训练 -> 待训练 -> 待预约开播 -> 待开播 -> 已结束
  - 历史数据兼容：实现完整的状态映射和字段降级读取机制，确保历史数据正确显示

2025-09-20 新增
- 机师管理列表搜索功能：在机师列表头部新增文本搜索框，支持按机师昵称或真实姓名进行前端模糊匹配搜索
  - 搜索触发：支持输入框实时搜索、退格键、删除键、回车键和搜索按钮触发
  - 搜索范围：同时匹配机师昵称和真实姓名，不区分大小写
  - 前端实现：纯前端JavaScript实现，不影响后端筛选器功能

2025-09-19 变更
- 作战计划列表默认筛选：移除"所属=自己"的默认条件，保留"时间=现在开始"。
- 更新时间筛选：将作战计划的 "现在开始（默认）"调整为"这两天（默认）"，并保留"现在开始/全部"可选
  - 作战记录：时间筛选新增"这两天（昨天+今天+明天）"，设为默认；原"今天"仍可选

2025-09-19 增强
- 列表筛选持久化：为机师列表、作战计划、作战记录、战斗区域、机师征召四个列表页接入筛选条件会话持久化，返回列表页时自动回填上次筛选。

2025-09-18 修复
- 机师-作战记录（后端）：作战记录列表路由默认所属筛选改为"全部"，不再默认按当前用户过滤；默认时间筛选仍为近7天。
- 作战记录：在"作战记录详情"页面顶部新增面包屑导航按钮，便于从详情快速回到列表。
- 机师征召：当征召状态为"训练征召中"时，列表卡片不再显示"预约"时间，仅显示"训练：YYYY年MM月DD日"。
  - 同步调整：训练征召时间与预约时间的"先后检查"已移除，允许自由填写，修复"先填晚后改早时报错"的问题。
  - 编辑页：当状态为"训练征召中"时支持在编辑页修改/清空"训练时间"。

2025-09-15 新增
- 自动化任务模块：新增 `utils/scheduler.py` 应用内置定时调度（APScheduler）
  - 集成：在 `app.py` 初始化完成后启动后台调度器
  - 每日任务：每日 GMT+8 20:00 自动执行未开播提醒报表（等效 UTC 12:00）

2025-09-15 变更
- 报告-邮件报告模块：未开播提醒收件人改为从用户模块动态获取（激活用户邮箱）
  - 规则：统计近48小时内，计划"接受时间"已过且超过4小时仍无关联"作战记录"的作战计划
  - 行为：有数据则以列表（Markdown表格）发送邮件；无数据仅记录INFO日志
  - 交互：按钮点击后立即返回"报表已开始运算"，不做同步等待

2025-09-15 新增
- 用户系统：为舰长/议长增加可选邮箱字段；提供按角色取邮箱列表（支持不传角色名获取全部邮箱）
- 路由/模板：新增用户编辑（昵称/邮箱），新增页支持填写邮箱，详情页展示邮箱
- 报告-邮件报告模块：新增议长页面入口与未开播提醒报表（近48小时）
  - 仅议长可见入口，点击触发计算并邮件发送（无数据仅记日志）
  - 邮件使用Markdown表格并自动内联样式，复用`utils.mail_utils.send_email_md`

2025-09-15 新增
- 邮件发送功能支持Markdown：新增 `utils/mail_utils.py:send_email_md()`
  - Markdown渲染：使用`markdown`将md渲染为HTML
  - 纯文本生成：优先用`html2text`从HTML提取纯文本，缺失时降级为简单去标签
  - 复用发送：调用既有`send_email()`完成实际发送
  - 依赖更新：`requirements.txt` 增加 `html2text`
  - 新增测试方法：`__send_test_email_by_md(recipient)` 发送Markdown测试邮件
  - 测试内容增强：在Markdown测试邮件中加入表格验证渲染效果

2025-09-15 新增
- 邮件发送工具模块：在utils中创建mail_utils.py统一邮件发送功能
  - 影响：为系统其他模块提供统一的邮件发送能力，简化邮件功能集成

2025-09-15 功能新增
- 作战日报分成计算功能：集成机师分成管理模块，实现完整的分成计算和毛利分析
  - 新增字段：当前分成比例、机师分成、公司分成、返点比例、产生返点、底薪、当日毛利
  - 月累计字段：月累计机师分成、月累计公司分成、月累计毛利
  - 汇总数据：月度数据新增累计机师分成、累计公司分成、运营利润估算
  - 日报数据：新增累计机师分成、累计公司分成
  - 技术实现：创建commission_helper工具模块，提供分成比例查询和计算功能
  - 接口调用：通过机师分成管理模块获取特定日期的生效分成比例
  - 计算逻辑：机师分成 = 流水金额 × 机师分成比例，公司分成 = 流水金额 × 公司分成比例
  - 毛利计算：当日毛利 = 公司分成 + 产生返点 - 底薪
  - 运营利润：累计公司分成 + 累计返点 - 累计底薪支出
  - 日志记录：详细记录分成计算过程，便于调试和验证
  - 模板更新：更新日报模板显示所有新增字段，调整表格布局
  - CSV导出：更新CSV导出功能，包含所有新增字段
  - 影响：提供完整的收入分配分析，支持运营决策和利润分析

2025-09-15 修复
- 机师作战日报返点计算代码：修正返点条件实现逻辑
  - 问题：代码中仍使用区间限制逻辑，如[1000,5000)的区间检查
  - 修正：将返点阶段条件改为"达到"条件，移除max_revenue字段和区间检查
  - 日志优化：更新调试日志格式，移除区间显示，改为"达到"条件显示
  - 影响：确保返点计算代码与修正后的业务规则保持一致

2025-09-15 功能改进
- 分成管理编辑功能优化：支持分成比例修改和状态切换
  - 新增功能：实时预览分成计算，状态切换时动态更新提示文字
  - 后端支持：编辑路由支持分成比例和状态的同时修改
  - 用户体验：统一编辑界面，减少操作步骤，提升操作便利性

2025-09-15 修复
- 分成管理变更记录URL和错误页面路由：修复URL生成和路由引用错误
  - 问题1：分成管理变更记录URL生成错误，导致双斜杠`/commission//changes`
  - 修复1：使用占位符替换方式生成正确的URL，避免字符串拼接问题
  - 问题2：错误页面中`url_for('main.index')`找不到对应路由
  - 修复2：将错误页面的首页链接改为`url_for('calendar.index')`
  - 影响：确保分成管理变更记录功能正常，错误页面能正确跳转

2025-09-15 修复
- 机师分成比例计算逻辑：修复根据当前日期判断生效分成记录
  - 问题：当前分成比例直接读取最后一条记录，不考虑调整日期是否已生效
  - 业务需求：分成比例应该根据当前日期判断，只使用调整日小于等于当前日期的记录
  - 修复：实现基于时间的生效记录查找逻辑
  - 逻辑：从最新记录开始查找，找到调整日≤当前日期的第一条记录作为生效记录
  - 边界处理：如果所有记录的调整日都是未来日期，返回默认20%分成比例
  - 影响：确保分成比例计算符合业务规则，支持未来日期的分成调整安排

2025-09-15 修复
- 机师分成管理QuerySet索引问题：彻底修复MongoEngine QuerySet索引错误
  - 问题：MongoEngine QuerySet不支持负索引，导致`commissions[-1]`报错
  - 原因：QuerySet对象即使为空也不是空列表，`commissions.count()`检查可能不够可靠
  - 修复：将QuerySet转换为列表`list(commissions)`，然后使用列表索引
  - 优势：更安全、更可靠，避免了MongoEngine QuerySet的特殊行为
  - 影响：确保分成管理功能在任何情况下都能正常工作

2025-09-15 修复
- 机师分成管理空记录IndexError：修复无分成记录时的页面错误
  - 问题：当机师没有任何分成调整记录时，访问分成管理页面出现IndexError
  - 原因：MongoEngine QuerySet为空时仍为QuerySet对象，使用`commissions[-1]`会报错
  - 修复：将`if not commissions:`改为`if not commissions.count():`正确检查空记录
  - 影响：确保新机师或未设置分成的机师能正常访问分成管理页面
  - 测试：验证空记录情况下返回默认20%分成比例

2025-09-15 修复
- 机师分成管理CSRF token缺失：修复所有表单的CSRF保护
  - 问题：分成管理相关表单缺少CSRF token，可能导致CSRF攻击风险
  - 修复：为所有POST表单添加CSRF token隐藏字段
  - 影响范围：新增调整记录表单、编辑调整记录表单、删除确认表单、恢复确认表单
  - 安全提升：确保所有表单提交都经过CSRF验证，符合Flask-Security-Too的安全要求

2025-09-15 修复
- 机师分成管理时间处理和日期限制优化
  - 明确时间处理规则：UI上所有日期显示和输入都是GMT+8时间，数据库存储UTC时间
  - 移除未来日期限制：调整日支持选择未来日期，用于提前安排分成调整
  - 更新表单提示：明确说明支持未来日期选择
  - 移除前端验证：删除JavaScript中的未来日期检查逻辑
  - 移除后端验证：删除模型中的未来日期验证规则
  - 文档更新：同步更新业务需求文档和技术设计文档中的相关规则
  - 影响：提升用户体验，支持更灵活的分成调整安排

2025-09-15 修复
- 机师分成管理计算公式错误：修复公司收入计算逻辑
  - 问题：公司收入计算使用了错误的公式"50% - 机师收入"，导致计算结果不正确
  - 修复：将公司收入计算公式改为"42% - 机师收入"，符合业务需求文档规范
  - 影响范围：后端计算逻辑、前端实时预览、编辑页面显示、相关文档
  - 示例：20%分成时，机师收入16.8%，公司收入从33.2%修正为25.2%
  - 文档更新：同步更新业务需求文档和技术设计文档中的计算公式

2025-09-15 新增
- 机师分成管理功能：完整实现机师分成调整记录管理模块
  - 数据模型：新增PilotCommission和PilotCommissionChangeLog模型，支持分成调整记录和变更追踪
  - 路由实现：在routes/pilot.py中新增分成管理相关路由，包括CRUD操作和API接口
  - 模板设计：创建分成管理页面、新增/编辑页面模板，支持实时分成计算预览
  - 机师详情页集成：在机师详情页操作区域添加"分成管理"入口按钮
  - 业务逻辑：实现默认20%分成、历史调整记录、按调整日生效的分成计算规则
  - 权限控制：议长和舰长均可管理所有机师的分成调整记录
  - 变更记录：完整记录所有字段修改的操作日志，支持软删除和恢复
  - 数据验证：前端和后端双重验证，确保分成比例范围0-50%、调整日唯一性等业务规则
  - 影响：为机师收入分配管理提供完整的技术方案，确保分成调整的可追溯性和准确性

2025-09-15 增强
- 作战日报金额显示：为所有人民币单位数字添加千分位分隔符
  - 前端模板：月度数据卡片、日报汇总卡片、明细表格中的所有金额字段
  - CSV导出：所有人民币金额字段都使用千分位分隔符格式
  - 格式：使用Python的"{:,.2f}"格式，例如1234.56显示为1,234.56
  - 影响：提升金额数据的可读性，便于快速识别大数值

2025-09-15 修复
- Flask全局错误处理器：添加500/404/403错误处理器，确保所有错误都被记录到日志
  - 问题：500错误等服务器错误没有被记录到日志文件，生产环境无法调试
  - 修复：添加全局错误处理器，记录详细的错误堆栈、请求信息、用户信息
  - 功能：创建了错误页面模板（500.html、404.html、403.html），提供友好的错误提示
  - 日志：错误信息会记录到app.log文件中，包含完整的堆栈跟踪和请求上下文
  - 影响：大幅提升生产环境的错误调试能力，确保所有错误都有迹可循

2025-09-15 文档
- 机师-分成管理：新增机师分成管理子模块设计文档
  - 业务需求文档：定义分成调整记录的数据结构和业务规则
  - 技术设计文档：详细规划分成管理功能的技术实现方案
  - 功能特性：分成调整记录CRUD、软删除、变更记录、权限控制
  - 计算规则：默认20%分成，支持历史调整记录，按调整日生效
  - 界面设计：机师详情页集成、分成管理页面、调整记录列表
  - 影响：为机师收入分配管理提供完整的技术方案

2025-09-15 文档
- 机师-作战日报：增加返点任务统计功能设计
  - 月度数据增加：累计返点统计，汇总所有有资格获得返点的主播返点总和
  - 日报明细增加：月累计返点字段，显示该主播当月获得的返点金额
  - 返点计算规则：基于5个阶段的任务条件（直播有效天数、时长、流水），取最高档返点比例
  - 直播有效天数定义：有作战记录且单次播时≥60分钟的自然日去重数
  - 接口设计：month_summary增加rebate_sum字段，details增加月累计返点字段
  - CSV导出：增加月累计返点列，保留两位小数格式
- 计算逻辑看起来还有问题，正在确认中，因为没有bug所以先提交

2025-09-15 修复
- 征召统计仪表板数据计算：修复时间计算逻辑，与征召日报保持一致
  - 问题：仪表板使用UTC时间直接计算，征召日报使用本地时间进行日期归属后转换为UTC
  - 修复：仪表板改为使用本地时间进行日期归属，然后转换为UTC时间进行数据库查询
  - 影响：确保仪表板显示的征召统计数据与征召日报页面数据一致
  - 技术细节：使用utc_to_local和local_to_utc函数进行时间转换

2025-09-15 新增
- 征召统计仪表板：新增征召统计卡片，排在仪表板第一位
  - 后端实现：在_calculate_dashboard_data函数中添加征召统计数据计算
  - 前端实现：在仪表板模板中添加征召统计卡片，使用1个主要数据+2个副数据的布局模式
  - 文档更新：在基础仪表板文档中记录征召统计卡片的实现

2025-09-15 增强
- 作战记录统计卡片交互：添加单击跳转到作战日报功能
  - 功能实现：为作战记录统计卡片添加ID和点击事件监听器
  - 跳转目标：点击卡片跳转到作战日报页面（report.daily_report路由）
  - 用户体验：鼠标悬停显示指针样式，提供清晰的交互反馈
  - 一致性：与征召统计卡片和作战计划统计卡片的交互方式保持一致
  - 实现方式：使用JavaScript事件监听器，跳转到作战日报的默认日期页面

2025-09-15 修复
  - 问题：之前使用UTC时间直接计算日期范围，与征召日报的GMT+8本地时间处理不一致
  - 修复：统一使用GMT+8本地时间进行日期归属，然后转换为UTC时间进行数据库查询
  - 影响：确保所有仪表板统计数据的时间基准一致，与征召日报保持同步
  - 实现：使用utc_to_local()和local_to_utc()函数进行时间转换
  - 文档更新：在基础仪表板文档中明确说明时间处理方式

2025-09-15 修改
- 作战记录统计仪表板：将统计指标从记录数量改为流水金额
  - 后端实现：修改_calculate_dashboard_data函数，使用revenue_amount字段计算流水总和
  - 前端实现：更新模板显示格式，使用千分位格式化显示金额
  - 文档更新：在基础仪表板文档中更新作战记录统计的实现说明

2025-09-15 优化
  - 筛选逻辑：创建时间、预约时间、训练时间任意一个在7天内即显示
  - 时间计算：基于GMT+8本地时间计算7天前的时间点，转换为UTC进行数据库查询
  - 用户体验：减少列表数据量，聚焦近期活跃的征召流程
  - 文档更新：在机师征召文档中明确说明7天限制规则
  - 代码实现：使用MongoEngine的Q对象实现OR条件查询

2025-09-15 增强
- 机师征召日报百分比显示：在统计表格中添加百分比显示功能
  - 功能实现：报表日行显示相对于近7日的百分比，近7日行显示相对于近14日的百分比
  - 界面优化：百分比以灰色小字显示在数据下方，提升数据可读性
  - 安全计算：实现除零保护，当分母为0时显示0%
  - 文档更新：在征召日报文档中详细说明百分比显示规则
  - 代码优化：新增_calculate_percentages函数，使用yapf和isort格式化代码

2025-09-15 新增
- 机师征召日报功能实现：完整实现征召日报的统计和展示功能
  - 路由实现：在recruit.py中新增recruit_daily_report路由，支持日期参数和分页导航
  - 数据统计：实现约面、到面、试播、新开播四个核心指标的统计计算
  - 时间维度：支持报表日、近7日、近14日三个时间范围的统计
  - 模板设计：创建recruit_reports/daily.html模板，参考作战日报的UI设计风格
  - 菜单集成：在主菜单中添加"📊机师征召日报"入口，位于"机师征召"后面
  - 权限控制：仅议长和舰长可访问，遵循现有权限体系
  - 代码优化：修复linting错误，使用yapf和isort进行代码格式化

2025-09-15 文档
- 机师征召日报功能文档：新增独立的征召日报功能设计文档
  - 功能定位：独立的日报表功能，提供征召流程的统计分析
  - 菜单入口：在主菜单中新增"机师征召日报"入口，位于"机师征召"后面
  - 报表内容：统计约面、到面、试播、新开播四个核心指标
  - 时间维度：提供报表日、近7日、近14日三个统计范围
  - UI设计：参考作战计划日历的日视图设计，保持界面一致性
  - 数据规则：基于14天数据范围，不使用缓存确保实时性
  - 权限控制：仅议长和舰长可访问，遵循现有权限体系
  - 技术实现：提供完整的接口设计和实现要点说明

2025-09-15 优化
- 机师征召列表筛选器优化：简化筛选选项，提升用户体验
  - 筛选逻辑：将三个状态选项合并为两个更符合使用场景的选项
  - 默认筛选：改为"进行中"（包含已启动+训练征召中），更符合实际工作流程
  - 选项设计：进行中/已结束，减少用户选择负担
  - 模板更新：调整空状态提示文案，保持界面一致性
  - 文档更新：明确新的筛选器设计和使用说明

2025-09-15 优化
- 机师征召结束征召阶级自动设置：简化结束征召流程，移除冗余的阶级选择
  - 逻辑优化：结束征召决策直接决定机师阶级，无需额外选择
  - 表单简化：移除阶级下拉选框，减少用户操作步骤
  - 服务层更新：final_recruit_atomic方法根据决策自动设置阶级
  - 文档更新：明确说明阶级自动设置逻辑，提升用户体验
  - 代码清理：移除未使用的Rank导入和相关验证逻辑

2025-09-15 新增
- 机师征召结束征召战区选择：在结束征召步骤中增加战区选择功能
  - 文档更新：在机师征召文档中明确结束征召时需要选择战区
  - 表单扩展：结束征召页面新增战区选择字段，支持快手/抖音/其他/未知选项
  - 验证逻辑：征召成功时战区为必填项，确保机师信息完整性
  - 服务层更新：final_recruit_atomic方法支持战区更新，确保数据一致性
  - 模板优化：JavaScript动态控制战区字段必填状态，提升用户体验

2025-09-15 重构
- 机师征召三步制流程实现：完成征召流程从两步制到三步制的全面重构
  - 数据模型扩展：新增TrainingDecision、FinalDecision枚举，扩展Recruit模型字段
  - 服务层重构：实现training_recruit_atomic、final_recruit_atomic原子性操作
  - 路由实现：新增训练征召和结束征召页面及处理逻辑
  - 模板更新：创建training.html、final.html模板，更新detail.html、list.html
  - 状态流转：已启动 -> 训练征召中 -> 已结束，严格按步骤执行
  - 业务规则：训练时间验证、机师信息收集、分配信息收集
  - 单元测试：完整的三步制流程测试，覆盖所有状态流转和验证规则
  - 兼容性：保留原有confirm_recruit_atomic、abandon_recruit_atomic方法用于兼容

2025-09-15 新增
- 机师征召训练时间字段：在训练征召步骤中增加试播时间安排
  - 元数据表格：新增训练时间字段，用于记录与机师约定的试播时间
  - 训练征召表单：当选择"征召为训练机师"时，训练时间字段为必填项
  - 列表显示：在征召列表中添加训练时间列，按GMT+8格式显示
  - 时间处理：遵循UTC存储、GMT+8显示的时间规范

2025-09-15 重构
- 机师征召流程优化：将征召流程从两步制改为三步制，提升征召决策的严谨性
  - 流程调整：启动征召 -> 训练征召 -> 结束征召，确保征召决策的层次化
  - 状态流转：已启动 -> 训练征召中 -> 已结束，增加中间状态管理
  - 训练征召决策：征召为训练机师/不征召，同时收集机师基本信息（真实姓名、出生年、参战形式）
  - 结束征召决策：正式机师/实习机师/不征召，同时收集机师分配信息（所属、阶级）
  - 筛选器增强：新增训练征召决策、结束征召决策、征召负责人、渠道等筛选条件
  - 数据收集优化：在征召模块中完成必要的数据收集和校验，避免跨模块复杂依赖
  - 原子性保证：通过机师管理模块API方法更新机师信息，确保操作的原子性

2025-09-12 修复
- 文档与代码差异修复：
  - 作战区域管理：修复列表页默认筛选条件，未提供筛选参数时默认只显示"可用"状态的区域
  - 机师征召：在确认征召功能中添加后端验证，确保机师真实姓名不为空时才允许确认征召

2025-09-12 重构
- 系统性能与可靠性优化：基于测试发现文档的建议实施全面优化
  - 时间处理统一：移除硬编码时区偏移，统一使用 `utils/timezone_helper.py` 函数
  - 作战记录时间验证：修复时间验证逻辑，结束时间必须大于（而非大于等于）开始时间
  - 所属快照机制：修复无所属机师时不再使用当前用户作为快照，允许owner_snapshot为空
  - 征召状态流转原子性：新增 `utils/recruit_service.py` 提供原子性状态更新，包含回滚机制
  - 通告性能优化：添加复合索引优化冲突检查性能，限制重复事件生成最多60个实例
  - 报表性能优化：新增 `utils/report_optimizer.py` 批量计算减少数据库查询次数
 - 日历聚合重构：新增 `utils/calendar_aggregator.py` 统一处理月/周/日视图数据聚合
  - 单元测试补充：为所有优化添加对应单元测试，确保修改质量和回归防护

2025-09-12 文档
- 同步文档以匹配现有实现：
  - 机师管理：
    - 将"变更记录"数据存储描述调整为"独立模型持久化（非嵌入JSON）"（docs/机师-机师管理.md）
    - 明确变更记录通过 GET `/pilots/<id>/changes` 获取JSON并由前端弹窗渲染（docs/机师-机师管理.md、docs/机师-机师管理（技术设计）.md）
    - 移除"用户删除前检查下属机师"的描述（当前不支持删除用户）（上述两文档）
  - 用户系统：
    - 明确不支持"删除用户"，议长对舰长的管理为"增改查"（docs/基础-用户系统.md）
  - 作战记录：
    - 新增"接口（后端）"章节，补全 `/battle-records/api/*` 系列API与返回要点；在"从入口新建"处标注流程由多API组合实现（docs/机师-作战记录.md）
  - 作战计划（技术）：
    - 移除 `AnnouncementConflict` 持久化模型设计，改为运行时动态冲突检查说明
    - 将列表排序明确为"应用层按本地通告日+昵称排序"
    - 补充辅助性API清单与导出路由 `/announcements/export`（docs/机师-作战计划（技术设计）.md）

2025-01-11 文档更新
- 测试发现文档调整：根据业务需求调整 `docs/测试发现与设计建议.md`
  - 移除重复征召检查问题：根据用户反馈，重复征召在业务上可以接受
  - 问题编号重新整理：从11个问题调整为10个问题
  - 优先级建议更新：移除重复征召检查相关的高优先级建议
  - 文档结构优化：保持文档的完整性和逻辑性

2025-01-11 新增
- 全面补充单元测试覆盖：新增6个测试模块，覆盖核心业务逻辑
  - 测试基建：新增 `tests/fixtures/factory.py` 提供测试数据工厂方法
  - 通告管理测试：重复事件生成、冲突检查算法、边界条件处理
  - 作战记录测试：时间计算、金额验证、参战形式规则、业务规则验证
  - 征召流程测试：状态流转、机师联动、权限验证、业务规则检查
  - 报表统计测试：3日平均流水计算、月度统计聚合、数据准确性验证
  - 日历API测试：月/周/日视图数据聚合、区域占用统计、时间轴计算
  - 设计建议文档：新增 `docs/测试发现与设计建议.md` 记录测试过程中发现的设计问题
  - 测试覆盖：业务逻辑单元测试覆盖率显著提升，为系统健壮性提供保障

2025-09-11 新增
  - 日报数据层次：月度数据（截至报表日）、日报汇总（仅报表日）、日报明细（逐条记录）
  - 指标计算：机师数量、有效机师数量（播时≥6小时）、累计流水、累计底薪支出
  - 明细字段：机师信息、性别年龄、所属、阶级、作战区域、播时、流水、3日平均流水、月累计统计等
  - 3日平均流水：最近3个"有作战记录的自然日"的总流水平均值，若7日内不足3天则显示为空
  - 日期导航：支持前一日/后一日翻页，可直接选择日期
  - CSV导出：UTF-8 with BOM编码，支持Excel直接打开，包含完整明细数据
  - 时间口径：严格按GMT+8本地日期归属，基于作战记录开始时间换算
  - 权限控制：仅议长和舰长可访问
  - 主菜单集成：新增"📊作战日报"导航入口，位于作战记录下方
  - 响应式设计：移动端优化，表格支持横向滚动，固定首列便于查看


2025-09-11 新增
- 机师征召管理模块：完整实现机师征召流程管理功能
  - 征召数据模型：Recruit和RecruitChangeLog，支持征召状态跟踪和变更记录
  - 征召渠道：BOSS、51、介绍、其他四种渠道选择
  - 完整征召流程：启动征召→编辑征召→确认征召/放弃征召
  - 状态流转：已启动→已结束，同步更新机师状态（已征召/不征召）和阶级（训练机师）
  - 权限控制：仅议长和舰长可操作，舰长只能操作自己所属的机师征召
  - 机师详情页集成：未征召状态机师显示"启动征召"按钮
  - 主菜单集成：新增"机师征召"导航入口，默认显示已启动状态的征召
  - 移动端优化：卡片式列表设计，footbar操作按钮，响应式布局
  - 时间处理：严格遵循UTC存储，GMT+8显示的时间规范
  - 变更追踪：详细记录所有字段修改的操作日志（时间、操作者、前后值、IP）
  - 确认征召交互限制：当机师真实姓名为空时，确认征召按钮禁用，并提示前往机师管理补全资料
- 首页仪表板新增三张卡片：作战记录统计、机师统计、候补机师统计；完成后端数据统计与模板渲染。
- 战斗区域管理模块（模型、路由、模板、批量生成）并补充单元测试

2025-09-11 修复
- 通告详情 footbar 按钮顺序与样式统一为：编辑、登录作战记录、删除、变更记录，颜色遵循基础-UI风格。
- 作战记录登记（从通告进入）时：主播/所属改为只读展示，并以编辑页格式展示关联通告；修复脚本在无筛选器场景下的空元素访问。
 - 通告详情按钮细化：删除按钮文本居中；"登录作战记录"改为HUD绿背景白字且移除图标；"变更记录"恢复灰色描边样式。

2025-09-11 优化
- 全站统一 favicon：将 `static/zaft.svg` 重命名为 `static/favicon.svg` 并在 `templates/base.html` 全局引用；在页头品牌标题左侧显示图标。
- 机师征召列表 UI 统一：对齐作战记录列表的风格（折叠筛选器、卡片布局、配色与间距）。

2025-09-11 新增
- 实装机师-作战记录功能：完整的作战记录管理模块
- 作战记录元数据：主播、关联通告、开始结束时间、流水金额、底薪金额、X/Y/Z坐标快照、参战形式、所属快照、登记人、备注等字段
- 支持两种登记模式：从模块入口新建和从通告详情页预填
- 列表筛选功能：按所属、阶级、主播、时间筛选，默认显示自己的近7天记录
- 排序规则：开始时间逆序、流水金额次序，每次加载100条记录支持滚动加载
- 三联选择器：支持主播筛选（所属、阶级、昵称）和作战区域选择（X/Y/Z坐标）
- 时间默认值：开始时间为当前时间向前6小时取整点半点，结束时间为当前时间取整点半点
- 变更记录追踪：记录所有字段修改的详细日志（时间、操作者、字段、前后值、IP）
- 权限控制：仅议长和舰长可访问，完整的CRUD操作和变更记录查看
- 响应式设计：移动端优化的界面布局和footbar操作按钮

2025-09-11 修复/变更
- 作战记录参战形式与作战区域的业务规则：当参战形式为"线上"时，X/Y/Z不填写且不可编辑；当参战形式为"线下"时，X/Y/Z为必填项。
- 更新`BattleRecord`模型与路由校验逻辑；调整新建/编辑页面将"参战形式"移动至"作战区域"分组首位并联动禁用作战区域选择。
 - 从通告预填时：默认将参战形式设为"线下"，按通告时间预填开始/结束时间与X/Y/Z快照；API返回的通告详情也固定提供"线下"作为预填参战形式。
 - 编辑页UI精简：主播改为只读显示，移除用于筛选主播的"所属/阶级"筛选器，保持与创建页一致的"参战形式在作战区域首位"的布局。
 - 修复：编辑作战记录时，如前端未提交"关联通告"字段，后端不再将其置空；只有该字段被显式提交时才更新（空字符串表示清空）。
- 统一作战计划页面机师展示格式：
  - 新建/编辑页机师下拉项改为"昵称(年龄)[状态]性别符号"，与作战记录一致
  - 通告详情页机师信息展示对齐作战记录格式
  - /announcements/api/pilots-filtered 返回字段新增 name，用于上述统一展示

2025-01-11 新增
- 实装机师-作战计划日历功能：提供月视图、周视图、日视图三种日历界面
- 月视图：仿照手机月历APP设计，显示每日作战计划数量，点击日期跳转日视图
- 周视图：显示一周作战计划和可用区域统计，支持周次切换
- 日视图：类似会议室预订系统，按战斗区域和时间轴展示详细安排
- 实现完整的权限控制：仅舰长和议长可访问日历功能
- 添加导航菜单入口和首页仪表板快捷访问
- 支持响应式设计和移动端优化

2025-01-10 新增
- 实装首页仪表板功能：显示今日作战计划数量、环比变化和7日平均数据
- 实现响应式卡片布局：移动端单列显示，桌面端支持2-3列并排
- 添加数据可视化元素：使用图标和颜色区分正负变化
- 优化用户体验：卡片悬停效果和现代化设计风格

2025-01-10 修复
- 修复编辑通告界面中时间显示问题：编辑"未来所有"循环时，时间选择器（小时和分钟）现在正确显示GMT+8时间而非UTC时间
- 新增Jinja2过滤器`utc_to_local`用于模板中的时间转换
- 确保编辑界面与冲突检查结果中的时间显示统一为GMT+8格式
- 修复编辑"未来所有"循环时的冲突检查逻辑：现在会排除所有可能被修改的通告实例，避免未来通告之间的相互冲突检查
- 优化`check_conflicts`方法支持排除多个通告ID，提升编辑循环事件的用户体验
- 修复编辑未来所有循环时第一个通告时间未正确更新的问题：现在第一个通告也会使用新的完整时间，而不是保持原时间

2025-01-10 改进
- 编辑通告时，若修改未来所有循环，开始时间中的日期不能修改，只能修改时间
- 添加时间格式化函数：get_local_date_for_input、get_local_time_for_input
- 更新编辑模板，当编辑范围为"未来所有循环"时，日期输入框设为只读，时间改为下拉选择器（小时和分钟）
- 更新后端逻辑，确保编辑未来所有循环时只更新时间部分，保持日期不变
- 添加前端JavaScript验证，防止用户修改日期部分
- 优化时间选择体验：小时选择器（00-23），分钟选择器（00-45，15分钟间隔）

2025-09-10 修复
- 修复编辑通告时"请填写所有必填项"错误：添加隐藏的battle_area字段，修复前端JavaScript与后端验证字段不匹配的问题
- 添加debug日志帮助定位表单数据问题

2025-09-10 改进
- 改进通告编辑和删除功能，支持"编辑/删除这一次"和"编辑/删除未来所有"选项
- 对循环组内的通告提供两个编辑按钮选项，不再要求必须修改父通告
- 实现循环组分割功能，当用户选择"编辑/删除未来所有"时，自动创建新的循环组
- 隐藏父通告概念，优化用户界面体验
- 新增通告模型方法：split_recurrence_group_from_current、get_future_announcements_in_group、is_in_recurrence_group

2025-09-10 修复
- 通告编辑页补齐机师三联动筛选与初始化逻辑，修复机师下拉无选项问题，并与新建页保持一致的填充顺序。

2025-09-10 修复
- 通告编辑页"检查冲突"结果展示对齐新建页：当无冲突时显示 planned_instances 计划详情（含单事件与多事件汇总），提升一致性与可读性。

# 变更日志

2025-09-10 文档
- 将作战计划相关界面与文档中的"重复组"统一更名为"循环组"。

2025-09-10 修复
- 修正通告列表"默认筛选器：所属=自己"未生效的问题，缺省时默认按当前用户过滤。

2025-09-10 修复
- 通告列表排序从"开始时间倒序"改为"按本地通告日升序、同日按机师昵称"。

## 2025-09-10 新增：
- 通告列表新增"时间"筛选：支持"现在开始"（默认）与"全部"
- 默认仅显示开始时间大于等于当前时间（按GMT+8转换后比较）的通告

## 2025-09-10 界面优化：
- 通告详情页面界面改进：将操作按钮（编辑、删除、变更记录）移动到页面底部，采用footbar吸附式设计
- 优化移动端用户体验，按钮在底部更便于触控操作
- 保持与现有设计风格的一致性，支持安全区域适配
- 调整冲突检查结果显示位置：在新建和编辑通告页面中，冲突检查结果现在显示在"检查冲突"按钮和"创建通告/保存修改"按钮之间，提升用户体验

## 2025-09-10 修复和优化：
- 时间戳处理规则的完整实现和修复
- 新增 `utils/timezone_helper.py` 时间转换工具模块
- 修复所有模型中的UTC时间戳默认值设定
- 修复路由中用户输入时间的GMT+8到UTC转换
- 修复模板中时间显示的UTC到GMT+8转换
- 新增时间处理相关的Jinja2过滤器（local_datetime、local_date、local_time、local_datetime_for_input）
- 优化新建通告页面时间输入体验：
  - 开始时间默认为当天13:00（便于用户输入）
  - 循环结束时间改为只选择日期，时间自动设为23:59
  - 循环结束日期默认为当前月最后一天
- 移除开始时间不能早于当前时间的验证限制，允许创建历史记录和补录数据
- 确保系统严格遵循"数据库存储UTC时间，UI显示和输入GMT+8时间"的设计规则
- 通过验证脚本确认所有时间转换函数工作正常

2025-09-10 修复
- 冲突检查API返回的计划详情与冲突项时间统一转换为GMT+8显示，修复新建与编辑页检查结果时间显示为UTC的问题。

## 2025-09-10 新增：
- 作战计划管理模块，包括通告的创建、编辑、删除、查看功能
- 支持重复事件管理（每日、每周、自定义重复）
- 时间冲突检查和资源占用验证
- 通告变更记录追踪
- 类似日历应用的用户体验设计

## 2025-09-11 文档
- 新增《机师-作战记录》设计文档：
  - 定义作战记录元数据（主播、时间、金额、X/Y/Z快照、参战形式、所属快照、登记人等）
  - 提供两种登记模式（从模块入口、从通告详情），支持从通告预填
  - 列表筛选（所属、阶级、主播、时间：今天/近7天），默认所属=自己、时间=近7天
  - 排序规则（开始时间逆序、流水金额次序）与UI/权限/日志规范

## 2025-09-09 新增：
2025-09-11 变更
- 机师管理权限调整：舰长与议长权限一致，不再限制舰长仅查看/编辑自己所属机师；相应更新 `routes/pilot.py`、技术/业务文档与变更日志。
 - 征召模块权限调整：舰长与议长权限一致，移除"仅能操作所属机师"的限制；更新 `routes/recruit.py` 与征召文档。
- 完整实现机师管理功能模块，包括数据模型、路由控制、前端界面
