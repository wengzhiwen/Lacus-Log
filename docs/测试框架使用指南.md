# API 集成测试框架使用指南

## 概述

本项目采用 `pytest + httpx` 构建了完整的 REST API 集成测试框架，遵循以下原则：

1. **不直接操作数据库**：所有数据访问通过 REST API
2. **使用随机数据**：通过 Faker 生成测试数据，确保测试可重复执行
3. **真实场景模拟**：使用 Flask test_client 模拟真实HTTP请求

## 目录结构

```
tests/
├── __init__.py
├── conftest.py                    # 全局 pytest 配置和 fixtures
├── fixtures/
│   ├── __init__.py
│   ├── api_client.py              # API 测试客户端
│   └── factories.py               # 测试数据工厂
└── integration/
    ├── __init__.py
    ├── conftest.py                # 集成测试专用 fixtures
    └── test_users_api.py          # 用户管理 API 测试用例
```

## 核心组件

### 1. ApiClient (tests/fixtures/api_client.py)

统一的 API 测试客户端，提供：
- 自动管理认证（Session + JWT）
- 自动添加 CSRF Token
- 支持 GET/POST/PUT/DELETE/PATCH 方法
- 统一的响应格式处理

```python
# 使用示例
response = admin_client.get('/api/users')
response = admin_client.post('/api/users', json={'username': 'test', ...})
response = admin_client.put(f'/api/users/{user_id}', json={'nickname': 'new'})
response = admin_client.delete(f'/api/users/{user_id}')
response = admin_client.patch(f'/api/users/{user_id}/activation', json={'active': False})
```

### 2. 测试数据工厂 (tests/fixtures/factories.py)

使用 Faker 生成随机测试数据：

```python
from tests.fixtures.factories import user_factory, pilot_factory, announcement_factory

# 生成用户数据
user_data = user_factory.create_user_data(role='kancho')
# 返回：{'username': 'test_abcd_123456', 'password': '...', 'nickname': '张三', ...}

# 生成主播数据
pilot_data = pilot_factory.create_pilot_data(owner_id='xxx')

# 生成通告数据
announcement_data = announcement_factory.create_announcement_data(pilot_id='xxx')
```

### 3. Fixtures (tests/integration/conftest.py)

#### `admin_client`
管理员身份的 API 客户端，自动登录为系统管理员（默认：zala）

```python
def test_admin_function(admin_client):
    response = admin_client.get('/api/users')
    assert response['success'] is True
```

#### `kancho_client`
运营身份的 API 客户端，自动创建并登录一个临时运营账号

```python
def test_kancho_function(kancho_client):
    response = kancho_client.get('/api/users/operators')
    assert response['success'] is True
```

#### `api_client`
未登录的 API 客户端，用于测试未授权访问

```python
def test_unauthorized(api_client):
    response = api_client.get('/api/users')
    assert response['success'] is not True
```

## 编写测试用例

### 基本结构

```python
import pytest
from tests.fixtures.factories import user_factory


@pytest.mark.integration
@pytest.mark.users
class TestUserCreate:
    """测试创建用户API"""
    
    def test_create_user_success(self, admin_client):
        """测试创建用户 - 成功"""
        # 1. 准备测试数据
        user_data = user_factory.create_user_data(role='kancho')
        
        # 2. 调用 API
        response = admin_client.post('/api/users', json=user_data)
        
        # 3. 验证响应
        assert response['success'] is True
        assert 'data' in response
        created_user = response['data']
        assert created_user['username'] == user_data['username']
        
        # 4. 清理数据
        admin_client.delete(f"/api/users/{created_user['id']}")
```

### 测试标记

使用 pytest 标记组织测试：

```python
@pytest.mark.integration  # 集成测试
@pytest.mark.users        # 用户管理相关
@pytest.mark.slow         # 慢速测试
```

### 跳过测试

对于已知问题或待实现功能：

```python
@pytest.mark.skip(reason="API缺少输入验证逻辑 - 待修复")
def test_invalid_input(self, admin_client):
    pass
```

## 运行测试

### 运行所有测试
```bash
./venv/bin/pytest tests/
```

### 运行特定模块
```bash
./venv/bin/pytest tests/integration/test_users_api.py
```

### 运行特定测试类
```bash
./venv/bin/pytest tests/integration/test_users_api.py::TestUserCreate
```

### 运行特定测试用例
```bash
./venv/bin/pytest tests/integration/test_users_api.py::TestUserCreate::test_create_user_success
```

### 使用标记过滤
```bash
# 只运行用户相关测试
./venv/bin/pytest -m users

# 排除慢速测试
./venv/bin/pytest -m "not slow"
```

### 查看详细输出
```bash
./venv/bin/pytest -v            # 详细模式
./venv/bin/pytest -v -s         # 显示 print 输出
./venv/bin/pytest --tb=short    # 简短的错误信息
```

## 配置

### pytest.ini
```ini
[pytest]
testpaths = tests
markers =
    integration: 集成测试
    users: 用户管理相关测试
    pilots: 主播管理相关测试
```

### 测试环境配置

在 `tests/conftest.py` 中配置：
- 使用独立的测试数据库（自动添加 `_test` 后缀）
- 禁用 CSRF（集成测试中通过 API 验证）
- 禁用 HTTPS 要求（测试环境）

可通过环境变量覆盖：
```bash
export TEST_ADMIN_USERNAME=zala
export TEST_ADMIN_PASSWORD=plant4ever
export MONGODB_URI_TEST=mongodb://localhost:27017/test_db
```

## 最佳实践

### 1. 测试数据隔离
每个测试用例创建自己的测试数据，测试结束后清理：

```python
def test_example(admin_client):
    # 创建
    response = admin_client.post('/api/users', json=user_data)
    user_id = response['data']['id']
    
    try:
        # 测试逻辑
        ...
    finally:
        # 清理
        admin_client.delete(f'/api/users/{user_id}')
```

### 2. 使用随机数据
避免硬编码测试数据，使用工厂生成：

```python
# 好的做法
user_data = user_factory.create_user_data()

# 避免
user_data = {'username': 'test_user', ...}  # 可能导致重复
```

### 3. 测试正常流程和异常情况
```python
def test_create_user_success(self, admin_client):
    """测试创建用户 - 成功"""
    pass

def test_create_user_duplicate(self, admin_client):
    """测试创建重复用户 - 应失败"""
    pass

def test_create_user_invalid_data(self, admin_client):
    """测试无效数据 - 应失败"""
    pass
```

### 4. 清晰的断言
```python
# 好的做法
assert response['success'] is True
assert 'data' in response
assert response['data']['username'] == expected_username

# 避免
assert response  # 不清楚在验证什么
```

### 5. 测试命名规范
- 测试类：`Test<Feature><Action>`
- 测试方法：`test_<action>_<scenario>`

```python
class TestUserCreate:
    def test_create_user_success(self):
        pass
    
    def test_create_user_duplicate_username(self):
        pass
```

## 当前状态

### 已实现
- ✅ 测试基础设施（pytest + httpx + Faker）
- ✅ ApiClient 测试客户端
- ✅ 用户管理 API 完整测试（17个用例）
- ✅ admin_client 和 kancho_client fixtures

### 待实现
- ⏳ 主播管理 API 测试
- ⏳ 通告管理 API 测试
- ⏳ 开播记录 API 测试
- ⏳ 招募记录 API 测试
- ⏳ 跨模块集成测试

### 已知问题
1. 用户创建 API 缺少输入验证（缺少必需字段时应返回错误）
2. 用户创建 API 缺少角色验证（无效角色时应返回错误）
3. 停用后的登录测试存在 session 缓存问题

## 故障排除

### 测试数据库连接失败
检查 MongoDB 是否运行，确认测试数据库配置正确。

### CSRF 验证错误
确保 `tests/conftest.py` 中禁用了 WTF_CSRF_ENABLED。

### 认证失败
检查默认管理员账号（zala/plant4ever）是否存在。

### 测试数据残留
测试数据库中可能残留数据，可以手动清理：
```bash
mongo test_lacus_report_xxx --eval "db.dropDatabase()"
```

## 参考资料

- [pytest 文档](https://docs.pytest.org/)
- [httpx 文档](https://www.python-httpx.org/)
- [Faker 文档](https://faker.readthedocs.io/)
- [Flask 测试文档](https://flask.palletsprojects.com/en/latest/testing/)

