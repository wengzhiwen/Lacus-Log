{% extends 'base.html' %}
{% block title %}新建开播地点 - Lacus-Log{% endblock %}
{% block content %}
<section class="area-form">
  <div class="page-header"><h1 class="page-title">新建开播地点</h1></div>
  <form id="area-create-form" class="form-card">
    <div class="form-group">
      <label for="input-x">基地</label>
      <input type="text" id="input-x" required>
    </div>
    <div class="form-group">
      <label for="input-y">场地</label>
      <input type="text" id="input-y" required>
    </div>
    <div class="form-group">
      <label for="input-z">坐席</label>
      <input type="text" id="input-z" required>
    </div>
    <div class="form-group">
      <label for="input-availability">可用性</label>
      <select id="input-availability">
        <option value="可用" selected>可用</option>
        <option value="禁用">禁用</option>
      </select>
    </div>
    <div id="form-error" class="form-error" style="display: none;"></div>
  </form>
</section>

<div class="footbar">
  <div class="inner">
    <button class="btn btn-primary" type="submit" form="area-create-form">创建</button>
    <a class="btn" href="{{ url_for('battle_area.list_areas') }}">返回列表</a>
  </div>
</div>

<style>
.form-card { background: #fff; border: 1px solid var(--table-header); border-radius: 8px; padding: 14px; }
.form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.form-group label { font-size: 12px; color: var(--muted); }
.form-group input, .form-group select { padding: 10px; border: 1px solid var(--table-header); border-radius: 6px; }
.form-error { margin-top: 4px; color: var(--error); font-size: 12px; }
.footbar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid var(--table-header); box-shadow: 0 -2px 8px rgba(0,0,0,0.06); padding: 10px 12px calc(env(safe-area-inset-bottom, 0) + 10px) 12px; z-index: 100; }
.footbar .inner { display: flex; gap: 12px; justify-content: center; }
.container { padding-bottom: 88px; }
</style>
<script>
function showFormError(message) {
  const errorBox = document.getElementById('form-error');
  errorBox.textContent = message;
  errorBox.style.display = message ? 'block' : 'none';
}

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('area-create-form');

  form.addEventListener('submit', async event => {
    event.preventDefault();
    showFormError('');

    const payload = {
      x_coord: document.getElementById('input-x').value.trim(),
      y_coord: document.getElementById('input-y').value.trim(),
      z_coord: document.getElementById('input-z').value.trim(),
      availability: document.getElementById('input-availability').value,
    };

    if (!payload.x_coord || !payload.y_coord || !payload.z_coord) {
      showFormError('基地、场地、坐席均为必填项');
      return;
    }

    try {
      const response = await fetch('/api/battle-areas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (!result.success) {
        const message = result.error?.message || '创建开播地点失败';
        showFormError(message);
        showMessage(message, 'error');
        return;
      }

      showMessage('创建开播地点成功', 'success');
      setTimeout(() => {
        window.location.href = `/areas/${result.data.id}`;
      }, 800);
    } catch (error) {
      console.error('创建开播地点失败:', error);
      showFormError('网络错误，请稍后再试');
      showMessage('创建开播地点失败', 'error');
    }
  });
});
</script>
{% endblock %}
