{% extends 'base.html' %}
{% block title %}ä»ªè¡¨ç›˜ - Lacus-Log{% endblock %}
{% block content %}
<section class="dashboard" id="dashboardApp">
  <h1 class="title">ä»ªè¡¨ç›˜</h1>
  <div class="dashboard-error" id="dashboardError" style="display:none;">ä»ªè¡¨ç›˜åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</div>
  <div class="cards">
    <div class="card card-bbs" data-card-id="bbs-latest" data-default-link="{{ url_for('bbs.bbs_index') }}">
      <div class="card-header">
        <div class="card-title">è”·è–‡èŠ±ä¸‹</div>
        <div class="card-icon">ğŸ—‚ï¸</div>
      </div>
      <div class="card-body">
        <ul class="bbs-latest-list">
          <li>
            <span class="bbs-latest-title" data-field="bbs_latest_0_title">åŠ è½½ä¸­...</span>
            <span class="bbs-latest-meta" data-field="bbs_latest_0_meta">åŠ è½½ä¸­...</span>
          </li>
          <li>
            <span class="bbs-latest-title" data-field="bbs_latest_1_title">åŠ è½½ä¸­...</span>
            <span class="bbs-latest-meta" data-field="bbs_latest_1_meta">åŠ è½½ä¸­...</span>
          </li>
          <li>
            <span class="bbs-latest-title" data-field="bbs_latest_2_title">åŠ è½½ä¸­...</span>
            <span class="bbs-latest-meta" data-field="bbs_latest_2_meta">åŠ è½½ä¸­...</span>
          </li>
          <li>
            <span class="bbs-latest-title" data-field="bbs_latest_3_title">åŠ è½½ä¸­...</span>
            <span class="bbs-latest-meta" data-field="bbs_latest_3_meta">åŠ è½½ä¸­...</span>
          </li>
          <li>
            <span class="bbs-latest-title" data-field="bbs_latest_4_title">åŠ è½½ä¸­...</span>
            <span class="bbs-latest-meta" data-field="bbs_latest_4_meta">åŠ è½½ä¸­...</span>
          </li>
        </ul>
      </div>
    </div>

    <div class="card" id="featuredImageCard" style="display:none;">
      <div class="card-header">
        <div class="card-title" id="featuredTitle"></div>
        <div class="card-icon" id="featuredIcon">ğŸŒ•</div>
      </div>
      <div class="card-body">
        <div class="image-gauge">
          <img id="featuredImage" src="" alt="featured" class="image-gauge-img" />
        </div>
      </div>
    </div>

    <div class="card" data-card-id="recruit" data-default-link="{{ url_for('report.recruit_daily_report') }}">
      <div class="card-header">
        <div class="card-title">æ‹›å‹Ÿç»Ÿè®¡</div>
        <div class="card-icon">ğŸ“‹</div>
      </div>
      <div class="card-body">
        <div class="main-data">
          <div class="main-value" data-field="recruit_today_appointments">--</div>
          <div class="main-label">ä»Šæ—¥çº¦é¢</div>
        </div>
        <div class="sub-data">
          <div class="sub-item">
            <div class="sub-value" data-field="recruit_today_interviews">--</div>
            <div class="sub-label">ä»Šæ—¥åˆ°é¢</div>
          </div>
          <div class="sub-item">
            <div class="sub-value" data-field="recruit_today_new_recruits">--</div>
            <div class="sub-label">ä»Šæ—¥æ–°å¼€æ’­</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" data-card-id="conversion-rate" data-default-link="{{ url_for('new_report.monthly_report') }}">
      <div class="card-header">
        <div class="card-title">çº¿ä¸‹åº•è–ªæµæ°´è½¬åŒ–ç‡</div>
        <div class="card-icon">ğŸ’°</div>
      </div>
      <div class="card-body">
        <div class="main-data">
          <div class="main-value" data-field="month_conversion_rate">--</div>
          <div class="main-label">æœ¬æœˆè½¬åŒ–ç‡</div>
        </div>
        <div class="sub-data">
          <div class="sub-item">
            <div class="sub-value" data-field="yesterday_conversion_rate">--</div>
            <div class="sub-label">æ˜¨æ—¥è½¬åŒ–ç‡</div>
          </div>
          <div class="sub-item">
            <div class="sub-value" data-field="last_week_conversion_rate">--</div>
            <div class="sub-label">ä¸Šå‘¨è½¬åŒ–ç‡</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" data-card-id="pilot-ranking">
      <div class="card-header">
        <div class="card-title">æ˜¨æ—¥ä¸»æ’­æ’å</div>
        <div class="card-icon">ğŸ†</div>
      </div>
      <div class="card-body">
        <div class="main-data">
          <div class="main-value" data-field="champion" style="font-size: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">--</div>
          <div class="main-label">å† å†›</div>
        </div>
        <div class="sub-data">
          <div class="sub-item">
            <div class="sub-value" data-field="second_place" style="font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">--</div>
            <div class="sub-label">äºšå†›</div>
          </div>
          <div class="sub-item">
            <div class="sub-value" data-field="third_place" style="font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">--</div>
            <div class="sub-label">å­£å†›</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" data-card-id="announcement" data-default-link="{{ url_for('calendar.day_view') }}">
      <div class="card-header">
        <div class="card-title">é€šå‘Šè®¡åˆ’ç»Ÿè®¡</div>
        <div class="card-icon">ğŸ“Š</div>
      </div>
      <div class="card-body">
        <div class="main-data">
          <div class="main-value" data-field="today_count">--</div>
          <div class="main-label">ä»Šæ—¥é€šå‘Šè®¡åˆ’</div>
        </div>
        <div class="sub-data">
          <div class="sub-item">
            <div class="sub-value" id="changeRateValue" data-field="change_rate">--</div>
            <div class="sub-label">ç¯æ¯”</div>
          </div>
          <div class="sub-item">
            <div class="sub-value" data-field="week_avg">--</div>
            <div class="sub-label">7æ—¥å¹³å‡</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" data-card-id="battle" data-default-link="{{ url_for('report.daily_report') }}">
      <div class="card-header">
        <div class="card-title">å¼€æ’­è®°å½•ç»Ÿè®¡</div>
        <div class="card-icon">ğŸ“ˆ</div>
      </div>
      <div class="card-body">
        <div class="main-data">
          <div class="main-value" data-field="battle_today_revenue">--</div>
          <div class="main-label">ä»Šæ—¥æµæ°´ï¼ˆå…ƒï¼‰</div>
        </div>
        <div class="sub-data">
          <div class="sub-item">
            <div class="sub-value" data-field="battle_yesterday_revenue">--</div>
            <div class="sub-label">æ˜¨æ—¥æµæ°´</div>
          </div>
          <div class="sub-item">
            <div class="sub-value" data-field="battle_week_avg_revenue">--</div>
            <div class="sub-label">7æ—¥å¹³å‡æµæ°´</div>
          </div>
        </div>
      </div>
    </div>

  </div>
  <div class="dashboard-meta" id="dashboardMeta" style="display:none;"></div>
</section>

<script>
(function() {
  const app = document.getElementById('dashboardApp');
  if (!app) {
    return;
  }

  const metaEl = document.getElementById('dashboardMeta');
  const errorEl = document.getElementById('dashboardError');
  const featureCard = document.getElementById('featuredImageCard');
  const featureTitle = document.getElementById('featuredTitle');
  const featureIcon = document.getElementById('featuredIcon');
  const featureImage = document.getElementById('featuredImage');
  const changeRateEl = document.getElementById('changeRateValue');

  const fieldMap = {};
  document.querySelectorAll('[data-field]').forEach(el => {
    fieldMap[el.dataset.field] = el;
  });

  const numberFormatter = new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 0 });
  const floatFormatter = new Intl.NumberFormat('zh-CN', { minimumFractionDigits: 1, maximumFractionDigits: 1 });

  const endpoints = [
    { url: "{{ url_for('main.dashboard_bbs_latest_data') }}", handler: applyBbsLatest },
    { url: "{{ url_for('main.dashboard_recruit_data') }}", handler: applyRecruit },
    { url: "{{ url_for('main.dashboard_conversion_rate_data') }}", handler: applyConversionRate },
    { url: "{{ url_for('main.dashboard_pilot_ranking_data') }}", handler: applyPilotRanking },
    { url: "{{ url_for('main.dashboard_announcement_data') }}", handler: applyAnnouncement },
    { url: "{{ url_for('main.dashboard_battle_data') }}", handler: applyBattle },
    { url: "{{ url_for('main.dashboard_feature_data') }}", handler: applyFeature },
  ];

  let latestTimestamp = '';
  let announcementLinkBase = '';

  function formatInteger(value) {
    if (value === null || value === undefined || Number.isNaN(value)) {
      return '--';
    }
    return String(value);
  }

  function formatCurrency(value) {
    if (value === null || value === undefined || Number.isNaN(value)) {
      return '--';
    }
    return numberFormatter.format(value);
  }

  function formatAverage(value) {
    if (value === null || value === undefined || Number.isNaN(value)) {
      return '--';
    }
    return floatFormatter.format(value);
  }

  function updateMeta(timestamp) {
    if (!timestamp || !metaEl) {
      return;
    }
    if (!latestTimestamp || timestamp > latestTimestamp) {
      latestTimestamp = timestamp;
      metaEl.textContent = `æœ€åæ›´æ–°ï¼š${timestamp}`;
      metaEl.style.display = 'block';
    }
  }

  function setCardLink(cardId, url) {
    const card = app.querySelector(`.card[data-card-id="${cardId}"]`);
    if (!card) {
      return;
    }
    if (url) {
      card.dataset.link = url;
    }
  }

  function applyBbsLatest(data, meta) {
    updateMeta(data.generated_at);
    if (meta && meta.link) {
      setCardLink('bbs-latest', meta.link);
    }
    const items = (data.items || []).slice(0, 5);
    for (let i = 0; i < 5; i += 1) {
      const titleEl = fieldMap[`bbs_latest_${i}_title`];
      const metaEl = fieldMap[`bbs_latest_${i}_meta`];
      if (!titleEl || !metaEl) {
        continue;
      }
      const item = items[i];
      if (item) {
        const board = item.board ? `[${item.board}] ` : '';
        const title = item.title || '--';
        const text = `${board}${title}`;
        titleEl.textContent = text;
        titleEl.title = text;

        const lastActivity = item.last_activity || {};
        const lastDisplay = lastActivity.display || '--';
        metaEl.textContent = lastDisplay;
        metaEl.title = lastDisplay;
      } else {
        titleEl.textContent = i === 0 ? 'æš‚æ— ä¸»è´´' : '--';
        titleEl.title = '';
        metaEl.textContent = '--';
        metaEl.title = '';
      }
    }
  }

  function applyRecruit(data, meta) {
    updateMeta(data.generated_at);
    if (fieldMap.recruit_today_appointments) {
      fieldMap.recruit_today_appointments.textContent = formatInteger(data.recruit_today_appointments);
    }
    if (fieldMap.recruit_today_interviews) {
      fieldMap.recruit_today_interviews.textContent = formatInteger(data.recruit_today_interviews);
    }
    if (fieldMap.recruit_today_new_recruits) {
      fieldMap.recruit_today_new_recruits.textContent = formatInteger(data.recruit_today_new_recruits);
    }
    if (meta && meta.link) {
      setCardLink('recruit', meta.link);
    }
  }

  function applyConversionRate(data, meta) {
    updateMeta(data.generated_at);
    if (fieldMap.month_conversion_rate) {
      const monthRate = data.month_conversion_rate;
      fieldMap.month_conversion_rate.textContent = monthRate !== null && monthRate !== undefined ? monthRate + '%' : '--';
    }
    if (fieldMap.yesterday_conversion_rate) {
      const yesterdayRate = data.yesterday_conversion_rate;
      fieldMap.yesterday_conversion_rate.textContent = yesterdayRate !== null && yesterdayRate !== undefined ? yesterdayRate + '%' : '--';
    }
    if (fieldMap.last_week_conversion_rate) {
      const weekRate = data.last_week_conversion_rate;
      fieldMap.last_week_conversion_rate.textContent = weekRate !== null && weekRate !== undefined ? weekRate + '%' : '--';
    }
    if (meta && meta.link) {
      setCardLink('conversion-rate', meta.link);
    }
  }

  function applyPilotRanking(data, meta) {
    updateMeta(data.generated_at);
    if (fieldMap.champion) {
      fieldMap.champion.textContent = data.champion || '--';
      fieldMap.champion.title = data.champion || '';
    }
    if (fieldMap.second_place) {
      fieldMap.second_place.textContent = data.second_place || '--';
      fieldMap.second_place.title = data.second_place || '';
    }
    if (fieldMap.third_place) {
      fieldMap.third_place.textContent = data.third_place || '--';
      fieldMap.third_place.title = data.third_place || '';
    }
  }

  function applyAnnouncement(data, meta) {
    updateMeta(data.generated_at);
    if (fieldMap.today_count) {
      fieldMap.today_count.textContent = formatInteger(data.today_count);
    }
    if (fieldMap.week_avg) {
      fieldMap.week_avg.textContent = formatAverage(data.week_avg);
    }
    if (changeRateEl) {
      const changeRate = Number(data.change_rate || 0);
      const displayChange = `${changeRate > 0 ? '+' : ''}${changeRate.toFixed(1)}%`;
      changeRateEl.textContent = displayChange;
      changeRateEl.classList.remove('positive', 'negative');
      if (changeRate > 0) {
        changeRateEl.classList.add('positive');
      } else if (changeRate < 0) {
        changeRateEl.classList.add('negative');
      }
    }
    if (meta && meta.link) {
      announcementLinkBase = meta.link;
      setCardLink('announcement', meta.link);
    }
  }

  function applyBattle(data, meta) {
    updateMeta(data.generated_at);
    if (fieldMap.battle_today_revenue) {
      fieldMap.battle_today_revenue.textContent = formatCurrency(data.battle_today_revenue);
    }
    if (fieldMap.battle_yesterday_revenue) {
      fieldMap.battle_yesterday_revenue.textContent = formatCurrency(data.battle_yesterday_revenue);
    }
    if (fieldMap.battle_week_avg_revenue) {
      fieldMap.battle_week_avg_revenue.textContent = formatCurrency(data.battle_week_avg_revenue);
    }
    if (meta && meta.link) {
      setCardLink('battle', meta.link);
    }
  }

  function applyFeature(data) {
    updateMeta(data.generated_at);
    if (!featureCard) {
      return;
    }
    if (!data || !data.show) {
      featureCard.style.display = 'none';
      return;
    }
    featureCard.style.display = 'block';
    featureTitle.textContent = data.title || '';
    featureIcon.textContent = data.icon || 'ğŸŒ•';
    if (data.image) {
      featureImage.src = data.image;
      featureImage.alt = data.title || 'featured';
    }
  }

  function showError(message) {
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }
  }

  function hideError() {
    if (errorEl) {
      errorEl.style.display = 'none';
    }
  }

  function setupCardNavigation() {
    const bbsCard = app.querySelector('.card[data-card-id="bbs-latest"]');
    if (bbsCard) {
      const link = bbsCard.dataset.link || bbsCard.dataset.defaultLink;
      if (link) {
        bbsCard.classList.add('is-clickable');
        bbsCard.style.cursor = 'pointer';
        if (!bbsCard.dataset.navBound) {
          bbsCard.addEventListener('click', () => {
            window.location.href = link;
          });
          bbsCard.dataset.navBound = 'true';
        }
      }
    }

    const recruitCard = app.querySelector('.card[data-card-id="recruit"]');
    if (recruitCard) {
      const link = recruitCard.dataset.link || recruitCard.dataset.defaultLink;
      if (link) {
        recruitCard.classList.add('is-clickable');
        recruitCard.style.cursor = 'pointer';
        if (!recruitCard.dataset.navBound) {
          recruitCard.addEventListener('click', () => {
            window.location.href = link;
          });
          recruitCard.dataset.navBound = 'true';
        }
      }
    }

    const conversionRateCard = app.querySelector('.card[data-card-id="conversion-rate"]');
    if (conversionRateCard) {
      const link = conversionRateCard.dataset.link || conversionRateCard.dataset.defaultLink;
      if (link) {
        conversionRateCard.classList.add('is-clickable');
        conversionRateCard.style.cursor = 'pointer';
        if (!conversionRateCard.dataset.navBound) {
          conversionRateCard.addEventListener('click', () => {
            window.location.href = link;
          });
          conversionRateCard.dataset.navBound = 'true';
        }
      }
    }

    const announcementCard = app.querySelector('.card[data-card-id="announcement"]');
    if (announcementCard) {
      const baseLink = announcementLinkBase || announcementCard.dataset.link || announcementCard.dataset.defaultLink;
      if (baseLink) {
        announcementCard.classList.add('is-clickable');
        announcementCard.style.cursor = 'pointer';
        if (!announcementCard.dataset.navBound) {
          announcementCard.addEventListener('click', () => {
            const today = new Date().toISOString().split('T')[0];
            const separator = baseLink.includes('?') ? '&' : '?';
            window.location.href = `${baseLink}${separator}date=${today}`;
          });
          announcementCard.dataset.navBound = 'true';
        }
      }
    }

    const battleCard = app.querySelector('.card[data-card-id="battle"]');
    if (battleCard) {
      const link = battleCard.dataset.link || battleCard.dataset.defaultLink;
      if (link) {
        battleCard.classList.add('is-clickable');
        battleCard.style.cursor = 'pointer';
        if (!battleCard.dataset.navBound) {
          battleCard.addEventListener('click', () => {
            window.location.href = link;
          });
          battleCard.dataset.navBound = 'true';
        }
      }
    }
  }

  function fetchEndpoint(endpoint) {
    return fetch(endpoint.url, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      credentials: 'same-origin'
    }).then(response => {
      // æ£€æŸ¥401æœªè®¤è¯
      if (response.status === 401) {
        if (typeof window.handle401 === 'function') {
          window.handle401();
        }
        throw new Error('æœªè®¤è¯ï¼Œè¯·é‡æ–°ç™»å½•');
      }
      if (!response.ok) {
        throw new Error('æ¥å£è¿”å›å¼‚å¸¸');
      }
      return response.json();
    }).then(payload => {
      if (!payload.success) {
        throw new Error(payload.error ? payload.error.message : 'æ¥å£è¿”å›å¤±è´¥');
      }
      const data = payload.data || {};
      const meta = payload.meta || {};
      endpoint.handler(data, meta);
    });
  }

  Promise.all(endpoints.map(fetchEndpoint))
    .then(() => {
      hideError();
      setupCardNavigation();
    })
    .catch(error => {
      console.error('åŠ è½½ä»ªè¡¨ç›˜å¤±è´¥ï¼š', error);
      // å¦‚æœæ˜¯401é”™è¯¯ï¼Œä¸æ˜¾ç¤ºé€šç”¨é”™è¯¯æ¶ˆæ¯ï¼ˆå·²ç»ç”±handle401å¤„ç†ï¼‰
      if (error.message !== 'æœªè®¤è¯ï¼Œè¯·é‡æ–°ç™»å½•') {
        showError(error.message || 'ä»ªè¡¨ç›˜åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
      }
    });
})();
</script>
{% endblock %}
