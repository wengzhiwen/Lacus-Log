# 文档与代码差异分析报告

生成日期: 2025-09-12

本报告旨在通过分析现有代码，找出文档与实际实现之间可能存在的差异、过时或不完整之处，为后续的文档更新提供依据。

## 模块一：机师管理 (Pilot Management)

**相关文档**:
- `docs/机师-机师管理.md` (业务需求)
- `docs/机师-机师管理（技术设计）.md` (技术设计)

**相关代码**:
- `models/pilot.py`
- `routes/pilot.py`

**总体评价**: 代码实现与技术设计文档高度一致。与业务需求文档的差异部分，多数是技术实现上的合理优化。

---

### 差异点与待确认项

#### 1. 变更记录的实现方式 (设计优化)

- **业务文档描述**: 建议将变更记录存储为机师数据模型内的一个 `JSON` 字段。
- **代码实际实现**: 创建了一个独立的 `PilotChangeLog` 数据模型（对应独立的数据库集合/表）来存储每一次变更。
- **分析**: 代码的实现方式是更优的设计。它使得变更记录的查询、索引和管理更加高效和规范，避免了单个文档过大的问题。此项属于积极的技术优化，但与最初的业务文档描述不符。
- 处理状态：已处理（更新文档：docs/机师-机师管理.md；对“变更记录”字段改为“独立模型持久化”描述，技术文档已与实现一致）

#### 2. 新建机师的默认“所属” (细节补充)

- **业务文档描述**: 未明确规定新建机师时“所属”字段的默认值。
- **代码实际实现**: 在 `routes/pilot.py` 的 `new_pilot` 函数中，如果操作用户是“舰长”(kancho) 角色（且非“议长”），新创建的机师会自动归属于该用户。
- **分析**: 这是对业务逻辑的一个合理补充，提升了用户体验。技术设计文档中对此有说明。
- **产品确认**： 没有默认值，没有输入就应该留空，不能自作主张。代码和文档都可能需要做出调整

#### 3. 权限逻辑的简化 (设计变更)

- **业务文档描述**: 在“默认筛选器”部分，对“议长”(gicho) 和“舰长”(kancho) 的行为有不同的描述，暗示了权限差异。
- **代码实际实现**: 代码中完全统一了“议长”和“舰长”的权限。`_check_pilot_permission` 函数明确表明，这两个角色都可以查看和编辑所有机师，没有任何差异。
- **分析**: 统一权限简化了系统的权限模型和代码逻辑，此变更已在技术设计文档中明确。
- 处理状态：已处理（核对无需更改；现有 docs/机师-机师管理.md 与 docs/机师-机师管理（技术设计）.md 已与代码一致）

#### 4. 变更记录的展示方式 (实现细节)

- **业务文档描述**: 要求以“弹窗”形式展示变更记录。
- **代码实际实现**: 后端并未直接渲染一个包含弹窗的页面，而是提供了一个返回 `JSON` 数据的 API 端点 (`/pilots/<pilot_id>/changes`)。
- **分析**: 这是典型的前后端分离实践。前端脚本会调用此 API 来获取数据，并动态地生成弹窗。实现方式符合文档预期，但具体实现细节（API 端点）未在业务文档中说明。
- 处理状态：已处理（更新文档：docs/机师-机师管理.md 增补前端通过 GET `/pilots/<id>/changes` 获取JSON 的说明；docs/机师-机师管理（技术设计）.md 将“变更记录页面”调整为“变更记录API”并补充返回结构）

#### 5. 【已确认】用户删除的关联检查

- **业务文档描述**: 在“交叉关联”部分明确要求：“删除用户时检查是否有下属机师，如果有，不允许删除”。
- **代码分析**: 此项检查逻辑应位于**用户管理**功能中，而非机师管理模块。因此，在本次分析的 `routes/pilot.py` 中无法找到对应代码。
- **建议**: 需要在后续分析用户管理模块时，重点检查用户删除功能是否包含了这项关联验证。
- **产品确认**：不支持用户删除功能，修改文档
 - 处理状态：已处理（更新文档：docs/基础-用户系统.md 增补“不支持删除用户”；docs/机师-机师管理.md 与 docs/机师-机师管理（技术设计）.md 移除“用户删除前检查下属机师”的描述）

---

## 模块二：作战区域管理 (Battle Area Management)

**相关文档**:
- `docs/基础-战斗区域管理.md`

**相关代码**:
- `models/battle_area.py`
- `routes/battle_area.py`

**总体评价**: 代码实现与文档描述高度一致。权限控制、数据模型、筛选逻辑和批量生成功能均按文档实现。仅发现一个关于默认筛选的微小差异。

---

### 差异点与待确认项

#### 1. 列表页的默认筛选条件 (实现差异)

- **业务文档描述**: 在"默认筛选器"部分规定，所有角色的默认筛选条件为"可用性 = 可用"。
- **代码实际实现**: `routes/battle_area.py` 中的 `list_areas` 函数并未设置默认筛选。在不提供任何筛选参数的情况下，它会列出所有状态（包括"可用"和"禁用"）的作战区域。
- **分析**: 这是一个实现与文档的直接差异。代码当前的行为是展示全部，而文档要求默认只展示"可用"的。
- **产品确认**： 应该修改代码
- 处理状态：已处理（修改代码：在 `list_areas` 函数中添加默认筛选逻辑，当未提供 `availability_filter` 参数时，默认筛选为 `Availability.ENABLED`）

---

## 模块三：用户系统 (User System)

**相关文档**:
- `docs/基础-用户系统.md`

**相关代码**:
- `models/user.py`
- `routes/admin.py`

**总体评价**: 代码实现与文档高度吻合，包括用户模型、角色权限、密码管理和安全规则。但发现一个核心功能缺失。

---

### 差异点与待确认项

#### 1. 【重要】用户删除功能缺失

- **业务文档描述**: 《基础-用户系统》文档描述议长可以“管理舰长账户（增删改查）”，其中的“删”指代删除功能。《机师-机师管理》文档进一步要求“删除用户时检查是否有下属机师，如果有，不允许删除”。
- **代码实际实现**: `routes/admin.py` 中只实现了用户的增、改、查功能（新建、编辑状态、查看详情），**完全没有提供删除用户的路由或函数**。
- **分析**: 这是一个核心功能的缺失。由于没有删除功能，文档中关于“删除前检查关联机师”的规则也无从实现。这解决了在“机师管理”模块分析中提出的待确认项——该功能当前未被实现。
- **产品确认**：没有删除用户的功能，用户无法被删除

---

## 模块四：机师征召 (Recruit Management)

**相关文档**:
- `docs/机师-机师征召.md`

**相关代码**:
- `models/recruit.py`
- `routes/recruit.py`

**总体评价**: 代码实现与文档描述极为贴合，业务流程、状态流转和权限控制都得到了精确实现。仅发现一处后端验证缺失。

---

### 差异点与待确认项

#### 1. "确认征召"的后端验证缺失

- **业务文档描述**: 在"确认征召"的"交互限制"部分，要求"当且仅当被确认征召的机师'真实姓名'不为空时，页面底部的'确认征召'按钮才可点击"。
- **代码实际实现**: `routes/recruit.py` 中的 `confirm_recruit` 函数（处理确认操作的后端逻辑）**没有**检查关联机师的 `real_name` 是否为空。该限制似乎仅在前端模板中实现（通过禁用按钮）。
- **分析**: 这是一个潜在的健壮性问题。如果用户通过技术手段绕过前端禁用的按钮，直接向后端发送请求，系统仍然会执行"确认征召"操作，即使机师没有真实姓名。为保证数据完整性和规则的严格执行，此验证也应在后端加入。
- **产品确认**：在代码中加入相关的验证
- 处理状态：已处理（修改代码：在 `confirm_recruit` 函数中添加机师真实姓名验证，如果为空则返回错误信息并重定向到征召详情页）

---

## 模块五：作战记录 (Battle Record)

**相关文档**:
- `docs/机师-作战记录.md`

**相关代码**:
- `models/battle_record.py`
- `routes/battle_record.py`

**总体评价**: 核心数据模型、业务规则和权限与文档一致。主要差异体现在列表筛选逻辑和大量未写入文档的辅助性API。

---

### 差异点与待确认项

#### 1. 列表筛选与排序逻辑差异

- **业务文档描述**:
    - 筛选: `所属` (默认=自己), `阶级`, `主播`, `时间` (默认=近7天)。
    - 排序: 第一排序 `开始时间` 逆序, 第二排序 `流水金额` 逆序。
- **代码实际实现**:
    - 筛选: `owner_filter` (所属), `rank_filter` (阶级), `pilot_filter` (主播), `time_filter` (时间) 的功能均已实现。默认值 `owner='self'` 和 `time='recent_7_days'` 也与文档一致。
    - 排序: `query.order_by('-start_time', '-revenue_amount')` 与文档描述完全一致。
- **分析**: 经过仔细比对，列表页的筛选和排序逻辑**与文档描述基本一致**。

#### 2. 【重要】存在大量未在文档中描述的API

- **业务文档描述**: 文档主要描述了页面的功能和用户交互流程，例如三联选择组件、动态筛选等。
- **代码实际实现**: `routes/battle_record.py` 文件中包含了大量的API端点（以 `/api/` 开头），例如：
    - `api_pilot_filters`: 获取主播筛选器的选项数据。
    - `api_pilots_filtered`: 根据条件获取过滤后的主播列表。
    - `api_battle_areas`: 获取作战区域数据以支持三联选择。
    - `api_announcement_detail`: 获取单个通告的详情用于预填。
    - `api_related_announcements`: 根据机师获取其关联的通告列表。
- **分析**: 这些API是实现文档中所描述的复杂前端交互所必需的，但它们本身的存在、路径和功能并未在技术文档中被定义。这造成了技术实现与技术文档之间的脱节，对于后续维护和API使用者来说，信息是不完整的。
- 处理状态：已处理（更新文档：docs/机师-作战记录.md 新增“接口（后端）”一节，完整列出筛选/三联选择/通告预填/关联通告等API路径与返回要点）

#### 3. 新建流程的实现方式

- **业务文档描述**: “直接从本模块入口新建”时，描述为“通过三联选择主播，随后可选关联通告”。
- **代码实际实现**: 后端路由 `new_battle_record` 并不直接处理这种“选择主播->过滤通告”的逻辑。此流程是通过前端调用 `api_related_announcements` 等多个API组合实现的。
- **分析**: 这同样属于实现细节未在文档中体现。文档描述了最终的用户体验，但代码通过前后端分离和多个API调用的方式来实现，这比文档描述的流程要复杂，而这些复杂性没有被记录下来。
- 处理状态：已处理（更新文档：docs/机师-作战记录.md 在“直接从本模块入口新建”下补充说明“由前端通过多个API组合实现”）

---

## 模块六：通告 / 作战计划 (Announcement)

**相关文档**:
- `docs/机师-作战计划.md`
- `docs/机师-作战计划（技术设计）.md`
- `docs/机师-作战计划导出.md`

**相关代码**:
- `models/announcement.py`
- `routes/announcement.py`

**总体评价**: 代码实现与文档描述高度一致。这是一个功能复杂的模块，代码很好地实现了文档定义的循环事件、冲突检查、导出等核心功能。主要差异在于部分技术实现细节与文档有出入，以及存在一些未在文档中明确定义的辅助性API。

---

### 差异点与待确认项

#### 1. 冲突记录模型的简化
- **技术设计文档**: 提到了一个独立的 `AnnouncementConflict` 模型，用于存储冲突记录。
- **代码实际实现**: 并未创建 `AnnouncementConflict` 模型。冲突检查的逻辑在 `Announcement` 模型的 `check_conflicts` 方法中实现，并直接返回一个包含冲突信息的字典。
- **分析**: 这是一个实现上的简化。代码通过动态计算而非持久化存储的方式来处理冲突，简化了数据结构，但如果未来需要对冲突本身进行追溯和分析，则当前设计不支持。
- 处理状态：已处理（更新文档：docs/机师-作战计划（技术设计）.md 移除独立的 `AnnouncementConflict` 模型设计，改为“运行时动态计算”说明）

#### 2. 列表页排序的实现方式
- **业务文档描述**: “按通告日顺序、通告日相同的按主播昵称字典顺序排列”。
- **代码实际实现**: `list_announcements` 路由中，由于无法直接在数据库层面按关联对象（机师）的昵称进行排序，代码获取数据后，在应用层（Python）使用 `announcements.sort(...)` 来完成排序。
- **分析**: 功能上符合要求。但这种在应用层排序的方式，在数据量巨大时可能会有性能瓶颈，而文档并未提及这一点。
- 处理状态：已处理（更新文档：docs/机师-作战计划（技术设计）.md 将排序描述明确为“应用层排序”，与实现一致）

#### 3. 辅助性API未在文档中定义
- **技术设计文档**: 定义了核心的路由和部分API，如 `/check-conflicts`。
- **代码实际实现**: `routes/announcement.py` 中还包含了大量用于支持前端UI的API，例如 `get_y_coords`, `get_z_coords`, `get_pilots_by_owner`, `get_pilots_filtered` 等。
- **分析**: 这些API是实现文档中描述的“三联选择”等复杂交互所必需的，但API本身的存在、路径和返回格式并未在技术文档中明确定义，造成了技术文档的不完整。
- 处理状态：已处理（更新文档：docs/机师-作战计划（技术设计）.md 新增“辅助性API”小节，列出 `get_y_coords`、`get_z_coords`、`get_pilots_by_owner`、`get_pilots_filtered`、`/announcements/api/pilot-filters` 等）

#### 4. 导出功能的实现细节
- **导出文档描述**: 描述了导出功能的用户界面和最终产出。
- **代码实际实现**: `routes/announcement.py` 中的 `export_page` 路由和 `generate_export_table` 等辅助函数完整地实现了该功能。
- **分析**: 功能与文档一致，但具体的实现路由 `/export` 和处理逻辑并未在主设计文档中提及，而是单独存在于 `机师-作战计划导出.md` 中，信息较为分散。
- 处理状态：已处理（更新文档：docs/机师-作战计划（技术设计）.md 在“路由列表”中补充 `/announcements/export` 并标注与《机师-作战计划导出.md》关联）

---
