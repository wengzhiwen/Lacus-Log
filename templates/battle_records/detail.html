{% extends 'base.html' %}
{% block title %}开播记录详情 - Lacus-Log{% endblock %}
{% block content %}
<div class="container">
  <div class="back-nav">
    {% if from_param == 'base_salary_detail' and application_id %}
    <a class="btn btn-secondary" href="/reports/base-salary-applications/detail?id={{ application_id }}">
      <span>←</span>
      返回底薪申请详情
    </a>
    {% else %}
    <a class="btn btn-secondary" href="{{ url_for('battle_record.list_battle_records') }}">
      <span>←</span>
      返回开播记录
    </a>
    {% endif %}
  </div>

<section class="battle-record-detail">
  <div class="page-header">
    <h1 class="page-title">开播记录详情</h1>
  </div>

  <div class="detail-card">
    <div class="card-section">
      <h3 class="section-title">基本信息</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>主播</label>
          <div class="value">
            {% set age_str = '(' ~ battle_record.pilot.age ~ ')' if battle_record.pilot.age else '' %}
            {% set gender_icon = '♂' if battle_record.pilot.gender.value == 0 else ('♀' if battle_record.pilot.gender.value == 1 else '?') %}
            <span><a href="{{ url_for('pilot.pilot_detail', pilot_id=battle_record.pilot.id, from='battle_record_detail', record_id=battle_record.id) }}">{{ battle_record.pilot.nickname }}</a>{{ age_str }}[{{ battle_record.pilot.status.value }}]{{ gender_icon }}</span>
            <a href="{{ url_for('pilot.pilot_performance', pilot_id=battle_record.pilot.id, from='battle_record_detail', record_id=battle_record.id) }}" class="performance-link">业绩查看</a>
          </div>
        </div>
        <div class="detail-item">
          <label>直属运营</label>
          <div class="value">{{ (battle_record.owner_snapshot.nickname or battle_record.owner_snapshot.username) if battle_record.owner_snapshot else '无' }}</div>
        </div>
        
        <div class="detail-item full-width">
          <label>关联通告</label>
          <div class="value">
            {% if related_announcement_deleted %}
              关联通告已被删除
            {% elif related_announcement %}
              {% set weekday_map = {'0':'日','1':'一','2':'二','3':'三','4':'四','5':'五','6':'六'} %}
              {% set weekday_idx = related_announcement.start_time|local_datetime('%w') %}
              {% set date_str = related_announcement.start_time|local_datetime('%Y-%m-%d') %}
              {% set duration_str = related_announcement.duration_hours ~ '小时' %}
              <a href="{{ url_for('announcement.announcement_detail', announcement_id=related_announcement.id|string) }}" class="link">
                {{ date_str }} 星期{{ weekday_map[weekday_idx] }} {{ duration_str }} @{{ related_announcement.x_coord }}-{{ related_announcement.y_coord }}-{{ related_announcement.z_coord }}
              </a>
            {% else %}
              无关联通告
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="card-section">
      <h3 class="section-title">时间信息</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>开始时间</label>
          <div class="value">{{ battle_record.start_time|local_datetime('%Y年%m月%d日 %H:%M') }}</div>
        </div>
        <div class="detail-item">
          <label>结束时间</label>
          <div class="value">{{ battle_record.end_time|local_datetime('%Y年%m月%d日 %H:%M') }}</div>
        </div>
        <div class="detail-item">
          <label>状态</label>
          <div class="value {% if battle_record.current_status.value == 'live' %}live-status{% endif %}">
            {% if battle_record.current_status.value == 'live' %}开播中{% else %}已下播{% endif %}
          </div>
        </div>
        <div class="detail-item">
          <label>开播时长</label>
          <div class="value">{{ "%.1f"|format(battle_record.duration_hours) }}小时</div>
        </div>
      </div>
    </div>

    <div class="card-section">
      <h3 class="section-title">开播地点</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>开播方式</label>
          <div class="value">{{ battle_record.work_mode.value }}</div>
        </div>
        <div class="detail-item">
          <label>基地</label>
          <div class="value">{{ battle_record.x_coord }}</div>
        </div>
        <div class="detail-item">
          <label>场地</label>
          <div class="value">{{ battle_record.y_coord }}</div>
        </div>
        <div class="detail-item">
          <label>坐席</label>
          <div class="value">{{ battle_record.z_coord }}</div>
        </div>
        <div class="detail-item full-width">
          <label>完整坐标</label>
          <div class="value">{{ battle_record.battle_location }}</div>
        </div>
      </div>
    </div>

    <div class="card-section">
      <h3 class="section-title">收益信息</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>流水金额</label>
          <div class="value revenue">¥{{ battle_record.revenue_amount }}</div>
        </div>
        <div class="detail-item">
          <label>底薪金额</label>
          <div class="value">¥{{ battle_record.base_salary }}</div>
        </div>
      </div>
    </div>

    <div class="card-section">
      <h3 class="section-title">结算方式</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>当前结算方式</label>
          <div class="value" id="settlement-type-display">加载中...</div>
        </div>
        <div class="detail-item">
          <label>生效日期</label>
          <div class="value" id="settlement-effective-date-display">加载中...</div>
        </div>
      </div>
    </div>

    {% if battle_record.notes %}
    <div class="card-section">
      <h3 class="section-title">备注信息</h3>
      <div class="notes-content">{{ battle_record.notes }}</div>
    </div>
    {% endif %}

    <div class="card-section">
      <h3 class="section-title">系统信息</h3>
      <div class="detail-grid">
        <div class="detail-item">
          <label>登记人</label>
          <div class="value">{{ (battle_record.registered_by.nickname or battle_record.registered_by.username) if battle_record.registered_by else '未知' }}</div>
        </div>
        <div class="detail-item">
          <label>创建时间</label>
          <div class="value">{{ battle_record.created_at|local_datetime('%Y年%m月%d日 %H:%M') }}</div>
        </div>
        <div class="detail-item">
          <label>最后修改</label>
          <div class="value">{{ battle_record.updated_at|local_datetime('%Y年%m月%d日 %H:%M') }}</div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="footbar">
  <div class="inner">
    <a class="btn btn-secondary" href="{{ url_for('battle_record.edit_battle_record', record_id=battle_record.id|string) }}">
      <span class="btn-icon">✏️</span>
      编辑
    </a>
    <button class="btn btn-secondary" onclick="showChangeLog()">
      <span class="btn-icon">📋</span>
      变更记录
    </button>
    <a class="btn btn-primary" id="apply-base-salary-btn" href="/battle-records/{{ battle_record.id }}/base_salary_application" style="display: none;">
      <span class="btn-icon">💰</span>
      申请底薪
    </a>
    <button class="btn btn-danger" onclick="confirmDelete()">
      <span class="btn-icon">🗑️</span>
      删除
    </button>
  </div>
</div>

<div id="changeLogModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>变更记录</h3>
      <button class="modal-close" onclick="hideChangeLog()">&times;</button>
    </div>
    <div class="modal-body" id="changeLogContent">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <div class="loading-text">加载中...</div>
      </div>
    </div>
  </div>
</div>

<div id="deleteModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>确认删除</h3>
    </div>
    <div class="modal-body">
      <p>确定要删除这条开播记录吗？此操作不可恢复。</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="hideDeleteModal()">取消</button>
      <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
    </div>
  </div>
</div>

<style>

.back-nav {
  margin-bottom: 20px;
}

.back-nav .btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
}

.back-nav .btn span {
  font-size: 16px;
}

.detail-card {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
  margin-bottom: 20px;
}

.card-section {
  padding: 20px;
  border-bottom: 1px solid var(--table-header);
}

.card-section:last-child {
  border-bottom: none;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin: 0 0 16px 0;
  border-bottom: 2px solid var(--brand);
  padding-bottom: 8px;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.detail-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.detail-item.full-width {
  grid-column: 1 / -1;
}

.detail-item label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.detail-item .value {
  font-size: 14px;
  color: var(--text);
  word-break: break-all;
}

.value.revenue {
  font-size: 18px;
  font-weight: 600;
  color: var(--hud-green);
}

.value.live-status {
  font-size: 14px;
  font-weight: 600;
  color: #ff4757;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.link {
  color: var(--brand);
  text-decoration: underline;
}

.link:hover {
  color: var(--brand-dark);
}

.detail-item .value a {
  color: var(--brand);
  text-decoration: underline;
}

.detail-item .value a:hover {
  text-decoration: underline;
}

.performance-link {
  color: var(--brand);
  text-decoration: none;
  font-size: 12px;
  margin-left: 8px;
  padding: 2px 6px;
  border: 1px solid var(--brand);
  border-radius: 3px;
}

.performance-link:hover {
  color: var(--brand-dark);
  background: var(--brand);
  color: white;
}

.notes-content {
  font-size: 14px;
  color: var(--text);
  line-height: 1.5;
  white-space: pre-wrap;
  background: var(--bg-light);
  padding: 12px;
  border-radius: 4px;
  border: 1px solid var(--table-header);
}


.footbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid var(--table-header);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
  padding: 10px 12px calc(env(safe-area-inset-bottom, 0) + 10px) 12px;
  z-index: 1;
}

.footbar .inner {
  display: flex;
  justify-content: center;
  gap: 12px;
}

.container {
  padding-bottom: 88px;
}


.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-content {
  background: #fff;
  border-radius: 8px;
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid var(--table-header);
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}

.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.modal-footer {
  padding: 20px;
  border-top: 1px solid var(--table-header);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.change-log-item {
  padding: 12px 0;
  border-bottom: 1px solid var(--table-header);
}

.change-log-item:last-child {
  border-bottom: none;
}

.change-time {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
}

.change-user {
  font-size: 12px;
  color: var(--brand);
  margin-bottom: 4px;
}

.change-detail {
  font-size: 14px;
  color: var(--text);
}

.loading {
  text-align: center;
  color: var(--muted);
  padding: 20px;
}


@media (max-width: 768px) {
  .detail-grid {
    grid-template-columns: 1fr;
  }

  .back-nav {
    flex-wrap: wrap;
    gap: 8px;
  }

  .footbar .inner {
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .footbar .btn {
    flex: 1;
    min-width: 80px;
  }
}
</style>

<script src="{{ url_for('static', filename='js/settlement-utils.js') }}"></script>
<script>
const changesUrl = '{{ url_for('battle_records_api.record_changes', record_id=battle_record.id) }}';
const deleteUrl = '{{ url_for('battle_records_api.delete_record', record_id=battle_record.id) }}';
const listUrl = '{{ url_for('battle_record.list_battle_records') }}';

function showChangeLog() {
  const modal = document.getElementById('changeLogModal');
  const content = document.getElementById('changeLogContent');
  
  modal.style.display = 'flex';
  content.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div class="loading-text">加载中...</div></div>';
  
  fetch(changesUrl)
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        const changes = (result.data && result.data.items) || [];
        if (changes.length === 0) {
          content.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div class="loading-text">暂无变更记录</div></div>';
        } else {
          const html = changes.map(change => `
            <div class="change-log-item">
              <div class="change-time">${change.change_time}</div>
              <div class="change-user">操作人: ${change.user_name} (${change.ip_address || '未知IP'})</div>
              <div class="change-detail">
                <strong>${change.field_name}:</strong> 
                ${change.old_value || '空'} → ${change.new_value || '空'}
              </div>
            </div>
          `).join('');
          content.innerHTML = html;
        }
      } else {
        content.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div class="loading-text">加载失败</div></div>';
      }
    })
    .catch(error => {
      console.error('获取变更记录失败:', error);
      content.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div class="loading-text">加载失败</div></div>';
    });
}

function hideChangeLog() {
  document.getElementById('changeLogModal').style.display = 'none';
}

function confirmDelete() {
  document.getElementById('deleteModal').style.display = 'flex';
}

function hideDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
}

async function deleteBattleRecord() {
  const deleteModal = document.getElementById('deleteModal');
  try {
    const response = await fetch(deleteUrl, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include'  // 确保浏览器发送包含JWT token的cookie
    });
    const result = await response.json();
    if (!result.success) {
      throw new Error(result.error?.message || '删除开播记录失败');
    }
    const meta = result.meta || {};
    showMessage(meta.message || '开播记录删除成功', 'success');
    deleteModal.style.display = 'none';
    setTimeout(() => {
      window.location.href = listUrl;
    }, 600);
  } catch (error) {
    console.error('删除开播记录失败:', error);
    showMessage(error.message || '删除开播记录失败', 'error');
  }
}

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal')) {
    e.target.style.display = 'none';
  }
});


async function loadSettlementInfo() {
  const recordId = '{{ battle_record.id }}';
  const battleStartTime = '{{ battle_record.start_time.isoformat() if battle_record.start_time else "" }}';
  
  if (!battleStartTime) {
    console.warn('无法获取开播记录开始时间');
    return;
  }
  
  try {
    // 使用共享的结算方式计算工具
    const settlement = await getEffectiveSettlement('{{ battle_record.pilot.id }}', battleStartTime);
    
    // 渲染结算方式信息
    renderSettlementInfo(settlement, {
      settlementTypeDisplay: document.getElementById('settlement-type-display'),
      effectiveDateDisplay: document.getElementById('settlement-effective-date-display')
    });
    
    // 控制申请按钮显示
    toggleApplyButton(settlement, document.getElementById('apply-base-salary-btn'));
    
  } catch (error) {
    console.error('加载结算方式失败:', error);
    document.getElementById('settlement-type-display').textContent = '加载失败';
  }
}


document.addEventListener('DOMContentLoaded', function() {
  const confirmBtn = document.getElementById('confirmDeleteBtn');
  if (confirmBtn) {
    confirmBtn.addEventListener('click', deleteBattleRecord);
  }
  loadSettlementInfo();
});
</script>
</div>
{% endblock %}
