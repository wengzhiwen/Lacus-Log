# 告警-詹姆斯的关注

> 术语统一记录（2025-09-28）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；作战记录→开播记录；作战计划→通告；征召→招募；所属→直属运营；阶级→主播分类。

本设计文档定义"詹姆斯的关注"警告邮件功能的业务规则、触发条件、计算口径与邮件内容格式。该功能专门用于监控低业绩不努力的主播，为管理决策提供数据支持。

## 重要约定

- 所有数据库时间字段均为UTC存储，界面显示与日期分组一律按GMT+8处理。
- 触发机制：仅在开播记录保存（新建或编辑）时触发，不依赖定时任务。
- 运算过程：**绝对不能**阻塞用户对开播记录的保存操作，对前端用户完全无感。
- 日志记录：使用INFO级别记录跳过原因，使用DEBUG级别记录详细计算过程。

## 功能概览

### 定位
面向管理员的主播业绩预警机制，通过邮件及时通知需要关注的低业绩主播。

### 触发方式
- 仅在开播记录保存（新建/编辑）时触发
- 不在邮件报表页面提供手动触发入口
- 完全异步执行，不影响开播记录保存操作

### 收件人
- 从用户模块获取所有激活的运营和管理员邮箱
- 去重后发送，确保不重复通知

## 触发条件

当开播记录被保存（新建或编辑）时，首先检查以下所有条件是否同时满足：

1. **流水不为0**：`revenue_amount > 0`
2. **如果是编辑，本次编辑流水有变化**：编辑场景下需要检查流水金额是否发生变化
3. **流水小于250元**：`revenue_amount < 250`
4. **播时小于7小时**：`duration_hours < 7`
5. **底薪大于等于100元**：`base_salary >= 100`

如果任一条件不满足，则记录INFO日志说明跳过原因，不进行后续运算。

## 运算逻辑

当触发条件满足时，对该主播进行一次主播业绩的完整计算（调用现有的 `_calculate_pilot_performance_stats` 方法），检查以下条件是否全部满足：

1. **近3日平均时数小于7小时**：`three_day_stats['avg_hours'] < 7`
2. **近3日盈亏小于100元**：`three_day_stats['operating_profit'] < 100`
3. **近7日盈亏小于250元**：`week_stats['operating_profit'] < 250`
4. **本月运营利润估算小于0**：`month_stats['operating_profit'] < 0`

如果任一条件不满足，则记录INFO日志说明跳过原因，不发送告警邮件。

## 告警邮件

### 邮件配置
- **发送工具**：使用 `utils/mail_utils.py` 的 `send_email_md()` 方法
- **邮件格式**：Markdown格式，自动转换为HTML邮件
- **主题**：`拉科斯警告 詹姆斯正在关注这个主播`

### 邮件内容结构

#### H1标题
```
{主播昵称}（{真实姓名}）正在受到詹姆斯的关注
```

#### H2标题：基本信息
- **年龄（性别icon）籍贯**：`{年龄}岁{性别icon} {籍贯}`
- **主播分类**：当前主播分类
- **分成比例**：`{当前分成比例}%`（基于分成模块，使用邮件发出时刻的分成比例）
- **直属运营**：主播当前的直属运营
- **招募负责人**：与该主播关联的创建日期最新的一条招募记录中的关联负责人的昵称
- **主播状态**：主播当前的状态

#### 业绩数据板块
邮件内容与主播业绩页完全相同，分为4个部分：

1. **本月统计**：月初至今日的统计数据
2. **近7日统计**：最近7条开播记录的统计数据
3. **近3日统计**：最近3条开播记录的统计数据
4. **最近开播记录列表**：最近30条开播记录的表格

### 邮件格式化要求
- 使用Markdown表格格式展示数据
- 金额字段使用千分位分隔符
- 时间字段使用GMT+8本地时间显示
- 负数以文本方式标注（如：-123.45元）
- 适应邮件阅读环境，保持良好的可读性

## 数据来源与计算

### 基础数据
- **开播记录**：`BattleRecord` 模型
- **主播信息**：`Pilot` 模型
- **招募记录**：`Recruit` 模型
- **分成管理**：通过 `utils/commission_helper.py` 获取当前分成比例

### 计算方法
- **主播业绩计算**：调用现有的 `_calculate_pilot_performance_stats()` 方法
- **分成比例获取**：调用 `get_pilot_commission_rate_for_date()` 方法
- **招募负责人获取**：查询该主播最新的招募记录

### 时间处理
- 严格遵循UTC存储、GMT+8显示的时间规范
- 使用 `utils/timezone_helper.py` 进行时间转换
- 日期归属按开播记录的开始时间换算为GMT+8后的自然日

## 实现要点

### 触发时机
- 在 `routes/battle_record.py` 的创建和更新路由中添加异步触发逻辑
- 使用 `threading.Thread` 或类似机制确保不阻塞主流程

### 错误处理
- 捕获所有异常，记录ERROR日志，但不影响开播记录保存
- 邮件发送失败时记录ERROR日志，包含失败原因和主播信息

### 性能考虑
- 异步执行，不影响用户体验
- 合理使用数据库索引，避免大量查询影响系统性能
- 计算结果不缓存，确保数据实时性

### 日志规范
- **模块名**：`james_alert`
- **INFO级别**：触发条件不满足的跳过原因、邮件发送成功通知
- **DEBUG级别**：详细的计算过程和中间结果
- **ERROR级别**：异常错误和邮件发送失败
- **日志语言**：简体中文

## 邮件模板示例

```markdown
# 张三（李四）正在受到詹姆斯的关注

## 基本信息

- **年龄（性别icon）籍贯**：25岁♀ 北京
- **主播分类**：正式主播
- **分成比例**：20%
- **直属运营**：王五
- **招募负责人**：赵六

## 本月统计

| 指标 | 数值 |
|------|------|
| 开播记录数 | 15条 |
| 开播时数 | 45.5小时 [平均3.0小时] |
| 累计流水 | 1,234.56元 [日均44.09元] |
| 累计底薪 | 1,500.00元 [日均53.57元] |
| 累计返点 | 61.73元 |
| 累计公司分成 | 246.91元 |
| 运营利润估算 | -1,191.36元 [日均-42.55元] |

## 近7日统计

| 指标 | 数值 |
|------|------|
| 开播记录数 | 7条 |
| 开播时数 | 21.0小时 [平均3.0小时] |
| 累计流水 | 567.89元 [日均81.13元] |
| 累计底薪 | 700.00元 [日均100.00元] |
| 累计返点 | 28.39元 |
| 累计公司分成 | 113.58元 |
| 近日盈亏（不计返点） | -586.42元 [日均-83.77元] |

## 近3日统计

| 指标 | 数值 |
|------|------|
| 开播记录数 | 3条 |
| 开播时数 | 9.0小时 [平均3.0小时] |
| 累计流水 | 234.56元 [日均78.19元] |
| 累计底薪 | 300.00元 [日均100.00元] |
| 累计返点 | 11.73元 |
| 累计公司分成 | 46.91元 |
| 近日盈亏（不计返点） | -253.09元 [日均-84.36元] |

## 最近开播记录

| 开播时间 | 结束时间 | 播时 | 流水 | 底薪 | 备注 |
|----------|----------|------|------|------|------|
| 2025-09-28 14:00 | 2025-09-28 17:00 | 3.0小时 | 78.90元 | 100.00元 | - |
| 2025-09-27 14:00 | 2025-09-27 17:00 | 3.0小时 | 67.89元 | 100.00元 | - |
| 2025-09-26 14:00 | 2025-09-26 17:00 | 3.0小时 | 87.77元 | 100.00元 | - |
```

## 权限与审计

- **权限要求**：无特定权限要求，系统内部自动触发
- **审计日志**：记录所有告警邮件的发送情况和跳过原因
- **数据安全**：邮件内容包含敏感的业绩数据，确保收件人范围合理

## 非目标

- 暂不支持告警频率限制（如同一主播24小时内只告警一次）
- 暂不支持告警条件的动态配置
- 暂不支持告警邮件的模板自定义
- 暂不支持邮件退订功能
