{% extends 'base.html' %}
{% block title %}启动招募 - Lacus-Log{% endblock %}
{% block content %}
<section class="start-recruit" data-pilot-id="{{ pilot_id }}" data-current-user-id="{{ current_user.id }}">
  <div class="back-nav">
    <a class="btn btn-secondary" href="{{ url_for('pilot.pilot_detail', pilot_id=pilot_id) }}">
      <span>←</span>
      返回主播详情
    </a>
  </div>

  <h1 class="title">启动招募</h1>

  <div class="pilot-info-card">
    <div class="card-header">
      <div class="pilot-avatar">
        <span class="avatar-icon" id="pilot-gender-icon">?</span>
      </div>
      <div class="pilot-main-info">
        <div class="pilot-name" id="pilot-nickname">加载中...</div>
        <div class="pilot-real-name" id="pilot-real-name">-</div>
        <div class="pilot-badges">
          <span class="rank-badge" id="pilot-rank">-</span>
          <span class="status-badge" id="pilot-status">-</span>
        </div>
      </div>
    </div>
    <div class="pilot-basic-info">
      <div class="info-item">
        <span class="info-label">性别/年龄：</span>
        <span class="info-value" id="pilot-gender-age">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">直属运营：</span>
        <span class="info-value" id="pilot-owner">-</span>
      </div>
    </div>
  </div>

  <!-- 招募记录警告提示 -->
  <div id="recruit-history-warning" class="warning-alert" style="display: none;">
    <div class="warning-icon">⚠️</div>
    <div class="warning-content">
      <div class="warning-title">该主播存在招募记录</div>
      <div id="warning-message" class="warning-message"></div>
    </div>
    <button type="button" class="warning-close" onclick="closeRecruitWarning()">✕</button>
  </div>

  <form id="start-recruit-form" class="recruit-form">
    <input type="hidden" name="pilot_id" value="{{ pilot_id }}">
    
    <div class="form-section">
      <h3 class="section-title">招募信息</h3>
      
      <div class="form-row">
        <div class="form-group">
          <label for="recruiter_id">招募负责人 <span class="required">*</span></label>
          <select name="recruiter_id" id="recruiter_id" required>
            <option value="">加载中...</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="appointment_time">预约时间 <span class="required">*</span></label>
          <input type="datetime-local" name="appointment_time" id="appointment_time" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="channel">招募渠道 <span class="required">*</span></label>
          <select name="channel" id="channel" required>
            <option value="">加载中...</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="introduction_fee">介绍费（元）</label>
          <input type="number" name="introduction_fee" id="introduction_fee" 
                 min="0" step="0.01" value="0">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="remarks">备注</label>
          <textarea name="remarks" id="remarks" maxlength="200" placeholder="可填写补充信息（最多200字）"></textarea>
        </div>
      </div>
    </div>
  </form>
</section>

<div class="footbar">
  <a class="btn btn-secondary" href="{{ url_for('pilot.pilot_detail', pilot_id=pilot_id) }}">返回</a>
  <button type="submit" form="start-recruit-form" class="btn btn-primary">创建招募</button>
</div>

<style>
/* Styles are identical to the previous version, so they are omitted for brevity */
.start-recruit { padding: 20px; }
.back-nav { margin-bottom: 20px; }
.title { margin-bottom: 20px; font-size: 24px; }
.pilot-info-card { background: white; border: 1px solid var(--gray); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
.card-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--table-header); }
.pilot-avatar { width: 60px; height: 60px; border-radius: 50%; background: var(--table-header); display: flex; align-items: center; justify-content: center; font-size: 24px; }
.pilot-main-info { flex: 1; }
.pilot-name { font-size: 20px; font-weight: 600; }
.pilot-real-name { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
.pilot-badges { display: flex; gap: 8px; }
.rank-badge, .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
.rank-候选人, .rank-trainee { background: var(--table-header); color: var(--text); }
.rank-试播主播, .rank-实习主播, .rank-正式主播 { background: var(--brand); color: white; }
.status-未招募 { background: var(--table-header); color: var(--text); }
.status-已招募, .status-已签约 { background: var(--hud-green); color: white; }
.status-不招募, .status-流失 { background: var(--error); color: white; }
.pilot-basic-info { display: grid; gap: 8px; }
.info-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }
.info-label { color: var(--muted); }
.info-value { color: var(--text); }
.recruit-form { background: white; border: 1px solid var(--gray); border-radius: 8px; padding: 20px; margin-bottom: 80px; }
.form-section { margin-bottom: 20px; }
.section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
.form-row { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px; }
.form-group { display: flex; flex-direction: column; gap: 4px; }
label { font-weight: 500; font-size: 14px; }
.required { color: var(--error); }
input, select, textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--gray); border-radius: 6px; font-size: 14px; }
textarea { resize: vertical; min-height: 80px; }

/* 招募记录警告提示样式 */
.warning-alert {
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
  box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.warning-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.warning-content {
  flex: 1;
}

.warning-title {
  font-weight: 600;
  color: #856404;
  margin-bottom: 4px;
  font-size: 15px;
}

.warning-message {
  color: #664d03;
  font-size: 14px;
  line-height: 1.5;
}

.warning-close {
  background: none;
  border: none;
  font-size: 20px;
  color: #856404;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  flex-shrink: 0;
  transition: background-color 0.2s;
}

.warning-close:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

@media (min-width: 768px) { .form-row { grid-template-columns: 1fr 1fr; } }
</style>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  const section = document.querySelector('.start-recruit');
  const pilotId = section.dataset.pilotId;
  const currentUserId = section.dataset.currentUserId;

  const rankMapping = {
    '候补机师': '候选人',
    '训练机师': '试播主播',
    '实习机师': '实习主播',
    '正式机师': '正式主播'
  };
  const statusMapping = {
    '未征召': '未招募',
    '不征召': '不招募',
    '已征召': '已招募',
    '已阵亡': '流失'
  };
  const genderText = {
    0: '男',
    1: '女',
    2: '不明确'
  };
  const genderIcon = {
    0: '♂',
    1: '♀',
    2: '?'
  };

  const toDatetimeLocal = (date) => {
    const pad = (value) => String(value).padStart(2, '0');
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  };

  const getNext14Clock = () => {
    const now = new Date();
    const next = new Date(now);
    next.setHours(14, 0, 0, 0);
    if (now >= next) {
      next.setDate(next.getDate() + 1);
    }
    return toDatetimeLocal(next);
  };

  const renderPilotInfo = (pilot) => {
    const rank = pilot.rank ? (rankMapping[pilot.rank] || pilot.rank) : '-';
    const status = pilot.status ? (statusMapping[pilot.status] || pilot.status) : '-';
    const gender = typeof pilot.gender === 'number' ? pilot.gender : 2;
    const ageText = pilot.age ? `${pilot.age}岁` : '';

    document.getElementById('pilot-nickname').textContent = pilot.nickname || '-';
    document.getElementById('pilot-real-name').textContent = pilot.real_name || '未填写姓名';
    document.getElementById('pilot-rank').textContent = rank;
    document.getElementById('pilot-status').textContent = status;
    document.getElementById('pilot-status').className = `status-badge status-${status}`;
    document.getElementById('pilot-rank').className = `rank-badge rank-${rank}`;
    document.getElementById('pilot-gender-icon').textContent = genderIcon[gender] || '?';
    document.getElementById('pilot-gender-age').textContent = `${genderText[gender] || '不明确'}${ageText ? `/${ageText}` : ''}`;
    const ownerName = pilot.owner?.nickname || pilot.owner?.username;
    document.getElementById('pilot-owner').textContent = ownerName || '无';
    document.title = `启动招募 - ${pilot.nickname} - Lacus-Log`;
  };

  const populateRecruiterChoices = (choices) => {
    const select = document.getElementById('recruiter_id');
    select.innerHTML = '<option value="">请选择负责人</option>';
    choices.forEach((choice) => {
      const option = new Option(choice.label, choice.value);
      if (choice.value === currentUserId) {
        option.selected = true;
      }
      select.add(option);
    });
    if (!select.value && choices.length > 0) {
      select.value = choices[0].value;
    }
  };

  const populateChannelOptions = (channelEnums) => {
    const select = document.getElementById('channel');
    select.innerHTML = '<option value="">请选择</option>';
    Object.keys(channelEnums || {}).forEach((key) => {
      const option = new Option(channelEnums[key], key);
      select.add(option);
    });
  };

  // 检测招募记录
  const checkRecruitHistory = async (pilotId) => {
    try {
      const response = await fetch(`/api/recruits/check-pilot/${pilotId}`, {
        credentials: 'include'
      });
      const result = await response.json();

      if (!result.success) {
        console.error('检测招募记录失败:', result.error?.message);
        return;
      }

      if (result.data.has_recruit_history && result.data.recruit) {
        const recruit = result.data.recruit;
        const message = `${recruit.created_at_gmt8}，由${recruit.recruiter_nickname}创建，当前招募状态为${recruit.status}`;
        showRecruitWarning(message);
      }
    } catch (error) {
      console.error('检测招募记录异常:', error);
    }
  };

  // 显示招募记录警告
  const showRecruitWarning = (message) => {
    const warningAlert = document.getElementById('recruit-history-warning');
    const warningMessage = document.getElementById('warning-message');

    warningMessage.textContent = message;
    warningAlert.style.display = 'flex';

    // 滚动到警告提示位置
    warningAlert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  };

  // 关闭招募记录警告
  window.closeRecruitWarning = function() {
    const warningAlert = document.getElementById('recruit-history-warning');
    warningAlert.style.display = 'none';
  };

  try {
    const [pilotResponse, optionsPayload] = await Promise.all([
      fetch(`/api/pilots/${pilotId}`),
      RecruitAPI.getOptions()
    ]);

    const pilotPayload = await pilotResponse.json();
    if (!pilotResponse.ok || !pilotPayload.success) {
      throw new Error(pilotPayload.error?.message || '加载主播信息失败');
    }

    renderPilotInfo(pilotPayload.data);

    const optionsData = optionsPayload.data;
    populateRecruiterChoices(optionsData.recruiter_choices || []);
    populateChannelOptions(optionsData.enums?.channel || {});

    document.getElementById('appointment_time').value = getNext14Clock();

    // 检测招募记录
    await checkRecruitHistory(pilotId);

  } catch (error) {
    console.error('加载启动招募页面数据失败:', error);
    showMessage(error.message || '加载启动招募页面数据失败', 'error');
  }

  const form = document.getElementById('start-recruit-form');
  form.addEventListener('submit', async function(event) {
    event.preventDefault();

    const formData = new FormData(form);
    const payload = {
      pilot_id: formData.get('pilot_id'),
      recruiter_id: formData.get('recruiter_id'),
      appointment_time: formData.get('appointment_time'),
      channel: formData.get('channel'),
      introduction_fee: formData.get('introduction_fee'),
      remarks: formData.get('remarks')
    };

    try {
      const response = await RecruitAPI.createRecruit(payload);
      if (response.success) {
        showMessage('招募已成功启动！正在跳转到列表页...', 'success');
        setTimeout(() => {
          window.location.href = "{{ url_for('recruit.list_recruits') }}";
        }, 1500);
      }
    } catch (error) {
      console.error('Create recruit failed:', error);
    }
  });
});
</script>
{% endblock %}
