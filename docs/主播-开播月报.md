# 主播-开播月报（基于"开播日报"功能）

> 术语统一记录（2025-09-27）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；作战记录→开播记录。
> - 本文档采用统一用语；数据库/接口字段保留历史命名，仅以字段标注说明。

本设计文档定义"开播月报"的业务规则、计算口径、接口与页面交互。为开播日报功能的平级功能，提供月度统计视图。

## 重要约定

- 所有数据库时间字段均为UTC存储，界面显示与日期分组一律按GMT+8处理。
- 月度选择 = 用户选择的月份（如2025-09），对应该月的所有开播记录。
- 记录归属月份口径：按"开播记录的开始时间"换算为GMT+8后的自然月。
- 明细表排序：按"月累计毛利"升序（亏钱的主播排前面）。

## 视图与导航

- 默认进入当前月份的月度视图。支持上个月、下个月翻页。
- 日期选择变为月度选择（YYYY-MM格式）。
- 明细表支持横向滚动（横向滚动）。

## 数据层次与口径

报告由两层数据构成：

### 1）月度汇总数据（整月统计）
- 总主播数量：在选择月份期间，存在至少一条开播记录的主播去重数。
- 累计流水：选择月份内，开播记录"流水金额"的合计。
- 累计底薪支出：选择月份内，开播记录"底薪金额"的合计。
- 累计主播分成：选择月份内，所有开播记录按当日主播分成比例计算的主播分成金额合计。
- 累计公司分成：选择月份内，所有开播记录按当日公司分成比例计算的公司分成金额合计。
- 累计返点：选择月份内，所有有资格获得返点的主播获得的返点的总和。
- 运营利润估算：累计公司分成 + 累计返点 - 累计底薪支出。

范围定义：将每条开播记录的"开始时间(UTC)→本地(GMT+8)"后得到本地日期 d，若 d 归属月份为选择月份，则计入。

**特殊规则**：当报告月是当前月时，筛选范围调整为"当月1日到昨天为止"，不包含今天及今天之后的开播记录。

### 2）月度明细（按主播聚合，每个主播一行）
每行明细对应一个主播在选择月份的汇总数据，展示字段：
- 主播：`昵称（真实姓名）`
- 性别年龄：`年龄-性别icon`（性别icon：男♂/女♀/?），当前的性别年龄
- 直属运营：当前的直属运营
- 主播分类：当前的主播分类
- 月累计开播记录数：该主播在选择月份的开播记录条数
- 月均播时(小时)：月总播时/月累计开播记录数
- 月累计流水(元)：该主播选择月份内流水合计
- 月累计主播分成(元)：该主播选择月份内按每日主播分成比例计算的主播分成金额合计
- 月累计公司分成(元)：该主播选择月份内按每日公司分成比例计算的公司分成金额合计
- 月最新返点比例(%)：该主播在选择月份的累计流水所能达到的最大返点比例
- 月累计返点(元)：该主播选择月份获得的返点金额
- 月累计底薪(元)：该主播选择月份内底薪合计
- 月累计毛利(元)：月累计公司分成 + 月累计返点 - 月累计底薪

明细排序：按"月累计毛利"升序（亏钱的主播排前面）。

## 指标定义与计算细则

### 时间口径
- 自然月：以GMT+8为界，选择月份的1号00:00:00 ~ 最后一天23:59:59。
- 播时计算：`max(结束, 开始) 且 结束 ≥ 开始`；单位小时，按秒差/3600并四舍五入到1位小数。

### 分成计算规则
- 累计主播分成、累计公司分成：每个主播的每一条开播记录，按其开播日期计算当日分成比例，然后累加。
- 参考主播-分成管理模块，不重写逻辑。

### 返点计算规则
返点计算逻辑请参考独立文档：[计算逻辑-主播月度返点](计算逻辑-主播月度返点.md)

- 月最新返点比例：按选择月份的累计数据，根据返点阶梯确定该主播能达到的最高返点比例。
- 月累计返点：该主播选择月份累计流水 × 月最新返点比例。

## 数据来源与模型映射

- 基础表：`开播记录（BattleRecord）`，字段参考《主播-开播记录》设计文档
- 辅助表：`pilots`（性别、出生年、主播分类、昵称/真实姓名、直属运营等）
- 分成管理表：`主播分成调整记录`，字段参考《主播-分成管理》设计文档

## 接口设计（后端）

建议新增以下只读接口，返回JSON供模板渲染：

- GET `/reports/monthly?month=YYYY-MM&owner=<owner_id>&mode=<all|online|offline>`
  - 入参：
    - `month`（可选），月份（YYYY-MM格式）；不传则取当前月。
    - `owner`（可选），直属运营用户ID；不传或传"all"则显示全部。
    - `mode`（可选），开播方式；取值`all`（默认）、`online`、`offline`。
  - 出参：
    - `month_summary`: { `pilot_count`, `revenue_sum`, `basepay_sum`, `rebate_sum`, `pilot_share_sum`, `company_share_sum`, `operating_profit` }
    - `details`: 数组，包含上述"月度明细"字段
    - `pagination`: { `month`, `prev_month`, `next_month` }
    - `owners`: 直属运营用户列表，用于筛选器显示
    - `selected_owner`: 当前选中的直属运营ID
    - `selected_mode`: 当前选中的开播方式

- GET `/reports/monthly/export.csv?month=YYYY-MM&owner=<owner_id>&mode=<all|online|offline>`
  - 返回CSV（UTF-8带BOM，分隔符逗号，换行CRLF），字段同明细表，用于直接被Microsoft Excel打开无乱码。

## 缓存机制

开播月报的计算结果采用内存缓存机制：

- **缓存时间**：15分钟（900秒）
- **缓存范围**：月度汇总数据（`_calculate_monthly_summary`）和月度明细数据（`_calculate_monthly_details`）
- **缓存键**：基于函数名和参数生成MD5哈希值
- **缓存失效**：15分钟后自动过期，或服务重启时清空
- **实现方式**：使用`cachetools`库的`TTLCache`实现
- **性能提升**：相同条件下15分钟内不会重新计算，显著提升页面响应速度

实现要点：
- 使用 `utils/timezone_helper.py` 做UTC↔本地的统一转换。
- 查询范围一律以"开始时间换算到本地月份"的归属进行聚合与过滤。
- **当前月特殊处理**：当报告月是当前月时，筛选范围调整为"当月1日到昨天为止"，避免包含今天及今天之后的开播记录。
- 对主播信息读`pilots`，需容错（昵称或真实姓名缺失时的展示降级）。
- 分成计算需要调用主播分成管理模块的接口，根据开播记录日期获取对应的主播分成比例。
- 分成金额计算：主播分成 = 流水金额 × 主播分成比例，公司分成 = 流水金额 × 公司分成比例。
- 月累计分成需要按日期逐日计算，不能简单使用当前分成比例乘以月累计流水。
- 返点比例计算：根据返点计算规则，确定该主播在选择月份符合的返点比例。
- 月累计返点计算：该主播选择月份的累计流水 × 返点比例。
- 毛利计算：月累计毛利 = 月累计公司分成 + 月累计返点 - 月累计底薪。
- 运营利润估算：累计公司分成 + 累计返点 - 累计底薪支出。
 - 直属运营筛选：当传入owner参数时，需要按照直属运营判断规则过滤开播记录，优先使用开播记录中的直属运营快照，如无快照则使用主播当前的直属运营。
  - 特殊规则：当按直属运营筛选时，以选择月份内（统计范围）“每位主播最后一次开播记录”的运营为准；若该记录的运营等于筛选的owner，则纳入该主播在本范围内的所有记录，否则不纳入，避免同一主播同时计入多个运营。
 - 开播方式筛选：当传入mode参数时，按 `BattleRecord.work_mode` 筛选；
   - 特殊规则：以选择月份内（统计范围）“每位主播最后一次开播记录”的开播方式为准；若该记录的方式等于筛选的mode（线上/线下），则纳入该主播在本范围内的所有记录，否则不纳入，避免同一主播同时计入两种开播方式。

## 模板与交互（前端）

- 新增模板：`templates/reports/monthly.html`
  - 顶部月份选择器，左右切换按钮（上个月/下个月）。
  - 展示"月度汇总数据七项"。
  - 下方"月度明细"表格，支持横向滚动；表头固定，列顺序与字段对齐。
  - 表格右上角提供"导出CSV"按钮（链接到导出接口）。

列建议（供实现时参考）：
`主播 | 性别年龄 | 直属运营 | 主播分类 | 月累计开播记录数 | 月均播时(小时) | 月累计流水(元) | 月累计主播分成(元) | 月累计公司分成(元) | 月最新返点比例(%) | 月累计返点(元) | 月累计底薪(元) | 月累计毛利(元)`

## 页面交互功能

### 主播业绩页跳转
- 明细表中主播列可点击，跳转到对应主播的业绩页面
- 跳转时携带来源参数 `from='monthly_report'`、`month`，确保返回时能正确回到开播月报页面
- 主播业绩页面提供返回按钮，统一显示"返回"文字

## CSV导出规范

- 编码：UTF-8 with BOM。
- 分隔符：逗号`,`；文本字段使用双引号包裹，内部双引号需转义为两个双引号。
- 数值：不使用千分位，保留两位小数的金额字段：月累计流水、月累计主播分成、月累计公司分成、月累计返点、月累计底薪、月累计毛利；月均播时保留1位小数；月最新返点比例显示为百分比格式（如20%、5%）。
- 首行作为表头，列顺序与页面明细一致。

## 性能与索引建议

- 为 `BattleRecord(pilot, start_time)` 建立复合索引；
- 为 `主播分成调整记录(pilot_id, adjustment_date, is_valid)` 建立复合索引，优化分成比例查询性能；
- 常用聚合可按"归属本地月"进行分组聚合；
- 分成计算涉及多表关联，建议在应用层缓存主播分成比例，避免重复查询；
- 返点计算需要按月统计主播数据，建议建立 `BattleRecord(pilot, start_time)` 的月分区索引；

## 权限与审计

- 权限沿用既有：管理员、运营可访问。

## 菜单集成

- 在主菜单中新增"📊开播-开播月报"导航入口，位于"📒开播-开播日报"后面。

## 技术实现

### 路由实现
- 在 `routes/report.py` 中新增月度报告相关路由
- 实现月度汇总数据计算函数
- 实现月度明细数据计算函数
- 实现CSV导出功能

### 数据计算
- 按月份获取开播记录
- 按主播分组统计月度数据
- 调用分成管理模块计算分成金额
- 调用返点计算逻辑确定返点比例和金额

### 模板设计
- 响应式设计，支持移动端
- 月份导航功能
- 汇总数据卡片展示
- 明细表格支持横向滚动
- CSV导出按钮
