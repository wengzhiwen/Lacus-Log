{% extends 'base.html' %}
{% block title %}月视图 - 通告日历{% endblock %}
{% block content %}
<section class="calendar-container">
  <div class="calendar-header">
    <h1 class="page-title">通告日历</h1>
    <div class="view-controls">
      <a href="{{ url_for('calendar.month_view') }}" class="btn btn-sm btn-primary">月视图</a>
      <a href="{{ url_for('calendar.week_view') }}" class="btn btn-sm">周视图</a>
      <a href="{{ url_for('calendar.day_view') }}" class="btn btn-sm">日视图</a>
    </div>
  </div>

  <div class="month-navigation">
    <button id="prevMonth" class="btn btn-sm">‹ 上月</button>
    <h2 id="currentMonth" class="month-title"></h2>
    <button id="nextMonth" class="btn btn-sm">下月 ›</button>
  </div>

  <div class="month-calendar">
    <div class="weekdays">
      <div class="weekday">一</div>
      <div class="weekday">二</div>
      <div class="weekday">三</div>
      <div class="weekday">四</div>
      <div class="weekday">五</div>
      <div class="weekday">六</div>
      <div class="weekday">日</div>
    </div>
    <div id="calendarGrid" class="calendar-grid">
    </div>
  </div>

  <div class="loading" id="loading" style="display: none;">
    <div class="loading-spinner"></div>
    <span>加载中...</span>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let currentDate = new Date();
  let currentYear = currentDate.getFullYear();
  let currentMonth = currentDate.getMonth() + 1;

  const monthTitleEl = document.getElementById('currentMonth');
  const calendarGridEl = document.getElementById('calendarGrid');
  const loadingEl = document.getElementById('loading');
  
  const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', 
                     '七月', '八月', '九月', '十月', '十一月', '十二月'];

  function updateMonthTitle() {
    monthTitleEl.textContent = `${currentYear}年${monthNames[currentMonth - 1]}`;
  }

  function loadMonthData() {
    loadingEl.style.display = 'flex';
    
    fetch(`{{ url_for('calendar.month_data') }}?year=${currentYear}&month=${currentMonth}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }
        renderCalendar(data);
      })
      .catch(error => {
        console.error('加载月视图数据失败:', error);
        alert('加载数据失败，请重试');
      })
      .finally(() => {
        loadingEl.style.display = 'none';
      });
  }

  function renderCalendar(data) {
    const firstDay = new Date(currentYear, currentMonth - 1, 1);
    const lastDay = new Date(currentYear, currentMonth, 0);
    const daysInMonth = lastDay.getDate();
    const startWeekday = firstDay.getDay() === 0 ? 7 : firstDay.getDay();

    calendarGridEl.innerHTML = '';

    for (let i = 1; i < startWeekday; i++) {
      const emptyDay = document.createElement('div');
      emptyDay.className = 'calendar-day empty';
      calendarGridEl.appendChild(emptyDay);
    }

    const today = new Date();
    const todayStr = today.getFullYear() === currentYear && 
                    today.getMonth() + 1 === currentMonth ? 
                    today.getDate() : null;

    for (let day = 1; day <= daysInMonth; day++) {
      const dayEl = document.createElement('div');
      dayEl.className = 'calendar-day';
      
      if (day === todayStr) {
        dayEl.classList.add('today');
      }

      const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const count = data.daily_counts[dateStr] || 0;

      dayEl.innerHTML = `
        <div class="day-number">${day}</div>
        <div class="day-count">${count > 0 ? count + '通告' : ''}</div>
      `;

      dayEl.addEventListener('click', function() {
        window.location.href = `{{ url_for('calendar.day_view') }}?date=${dateStr}`;
      });

      calendarGridEl.appendChild(dayEl);
    }
  }

  document.getElementById('prevMonth').addEventListener('click', function() {
    currentMonth--;
    if (currentMonth < 1) {
      currentMonth = 12;
      currentYear--;
    }
    updateMonthTitle();
    loadMonthData();
  });

  document.getElementById('nextMonth').addEventListener('click', function() {
    currentMonth++;
    if (currentMonth > 12) {
      currentMonth = 1;
      currentYear++;
    }
    updateMonthTitle();
    loadMonthData();
  });

  updateMonthTitle();
  loadMonthData();
});
</script>
{% endblock %}
