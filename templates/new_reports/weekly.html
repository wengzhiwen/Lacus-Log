{% extends "base.html" %}

{% block title %}开播新周报 - {{ pagination.week_start }}{% endblock %}

{% block content %}
<div id="weeklyReportApp" data-week-start="{{ pagination.week_start }}" data-selected-owner="{{ selected_owner }}" data-selected-mode="{{ selected_mode }}">
  <div class="page-header">
    <h1 class="page-title">📒 开播新周报</h1>
    <div class="page-subtitle">周定义：周二至次周一（7天）</div>
  </div>

  <div class="date-navigation">
    <div class="date-controls">
      <a href="{{ url_for('new_report.weekly_report', week_start=pagination.prev_week_start, owner=selected_owner, mode=selected_mode) }}" class="btn btn-secondary btn-sm">← 上一周</a>
      <span class="date-display" id="weekly-date-display">{{ pagination.week_start }}（周二起）</span>
      <a href="{{ url_for('new_report.weekly_report', week_start=pagination.next_week_start, owner=selected_owner, mode=selected_mode) }}" class="btn btn-secondary btn-sm">下一周 →</a>
    </div>
    <div class="export-actions">
      <a href="#" id="exportCsvBtn" class="btn btn-warning btn-sm">📥 导出CSV</a>
    </div>
  </div>

  <div class="filter-section">
    <div class="filter-controls">
      <label for="ownerSelector" class="filter-label">直属运营：</label>
      <select id="ownerSelector" class="filter-select" data-selected-owner="{{ selected_owner }}">
        <option value="all">全部</option>
      </select>

      <label for="modeSelector" class="filter-label">开播方式：</label>
      <select id="modeSelector" class="filter-select">
        <option value="all" {% if selected_mode == 'all' %}selected{% endif %}>全部</option>
        <option value="online" {% if selected_mode == 'online' %}selected{% endif %}>线上</option>
        <option value="offline" {% if selected_mode == 'offline' %}selected{% endif %}>线下</option>
      </select>
    </div>
  </div>

  <div class="summary-section">
    <div id="weekly-loading-state" class="loading-state">
      <div class="loading-spinner"></div>
      <div class="loading-text">加载中...</div>
    </div>
    <div style="display: none;" id="weekly-content">
      <h2 class="section-title">周度汇总（周二-次周一）</h2>
      <div class="summary-cards" id="weekly-summary-cards"></div>
      <div class="summary-hint">注：周定义为周二至次周一；盈利口径不计返点</div>
    </div>
  </div>

  <div class="details-section">
    <h2 class="section-title">周报明细</h2>
    <div class="table-container" id="weekly-table-container" style="display: none;">
      <table class="report-table">
        <thead>
          <tr>
            <th class="fixed-col sortable-header" data-sort-key="pilot_display" data-sort-type="string" tabindex="0" aria-sort="none">主播
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="records_count" data-sort-type="number" tabindex="0" aria-sort="none">周累计开播记录数
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="prev_week_records_count" data-sort-type="number" tabindex="0" aria-sort="none">前一周开播记录数
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="avg_duration" data-sort-type="number" tabindex="0" aria-sort="none">周均播时(小时)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="prev_week_avg_duration" data-sort-type="number" tabindex="0" aria-sort="none">前一周均播时
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="total_revenue" data-sort-type="number" tabindex="0" aria-sort="none">周累计流水(元)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="prev_week_total_revenue" data-sort-type="number" tabindex="0" aria-sort="none">前一周累积流水
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="total_profit" data-sort-type="number" tabindex="0" aria-sort="none">周累计毛利(元)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="prev_week_total_profit" data-sort-type="number" tabindex="0" aria-sort="none">前一周累积毛利
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="total_base_salary" data-sort-type="number" tabindex="0" aria-sort="none">周累计底薪(元)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="owner" data-sort-type="string" tabindex="0" aria-sort="none">直属运营
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="gender_age" data-sort-type="string" tabindex="0" aria-sort="none">性别年龄
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="rank" data-sort-type="string" tabindex="0" aria-sort="none">主播分类
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="total_pilot_share" data-sort-type="number" tabindex="0" aria-sort="none">周累计主播分成(元)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
            <th class="sortable-header" data-sort-key="total_company_share" data-sort-type="number" tabindex="0" aria-sort="none">周累计公司分成(元)
              <span class="sort-indicator" aria-hidden="true"></span>
            </th>
          </tr>
        </thead>
        <tbody id="weekly-details-body"></tbody>
      </table>
    </div>
    <div class="empty-state" id="weekly-empty-state" style="display: none;">
      <p>本周暂无开播记录</p>
    </div>
  </div>
</div>

<style>

.date-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0;
  padding: 16px;
  background: var(--table-header);
  border-radius: 8px;
}

.date-controls { display: flex; align-items: center; gap: 12px; }
.date-display { font-weight: 600; }
.export-actions { display: flex; gap: 8px; }

.filter-section { margin: 16px 0; padding: 12px 16px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e9ecef; }
.filter-controls { display: flex; align-items: center; gap: 8px; }
.filter-label { font-size: 14px; font-weight: 500; color: var(--text); margin: 0; white-space: nowrap; flex-shrink: 0; }
.filter-select { padding: 6px 12px; border: 1px solid var(--gray); border-radius: 4px; font-size: 14px; background: #fff; min-width: 120px; }

.summary-section { margin: 24px 0; }
.section-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; color: var(--text); }
.summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 8px; }
.summary-card { background: #fff; border: 1px solid var(--gray); border-radius: 8px; padding: 16px; text-align: center; transition: box-shadow 0.2s ease; }
.summary-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.summary-card.danger-outline { border-color: #dc3545; }
.card-label { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
.card-value { font-size: 24px; font-weight: 700; color: var(--brand); }
.card-sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
.summary-hint { font-size: 12px; color: var(--muted); margin-top: 4px; }

.details-section { margin: 24px 0; }
.table-container { overflow-x: auto; border: 1px solid var(--gray); border-radius: 8px; background: #fff; }
.report-table { width: 100%; border-collapse: collapse; min-width: 1500px; }
.report-table th, .report-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
.report-table th { background: var(--table-header); font-weight: 600; position: sticky; top: 0; z-index: 2; }
.report-table th.fixed-col, .report-table td.fixed-col { position: sticky; left: 0; background: #fff; background-clip: padding-box; min-width: 120px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.report-table td.fixed-col { z-index: 4; box-shadow: 2px 0 0 #eee; }
.report-table th.fixed-col { z-index: 5; box-shadow: 2px 0 0 #ddd; }
.report-table tbody tr:hover { background: #f8f9fa; }
.empty-state { text-align: center; padding: 40px; color: var(--muted); }
.pilot-link { color: var(--brand); text-decoration: none; font-weight: 600; }
.pilot-link:hover { color: var(--brand-dark); text-decoration: underline; }
.pilot-link-fallen { color: #6c757d; text-decoration: none; font-weight: 600; }
.pilot-link-fallen:hover { color: #545b62; text-decoration: underline; }
.text-danger { color: #dc3545 !important; font-weight: 600; }
.sortable-header {
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
  position: relative;
}
.sortable-header:focus-visible {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}
.sort-indicator {
  display: inline-flex;
  margin-left: 4px;
  font-size: 12px;
  opacity: 0.45;
}
.sortable-header.is-sorted .sort-indicator {
  opacity: 0.9;
}
.sortable-header.is-sorted-asc .sort-indicator::before {
  content: '▲';
}
.sortable-header.is-sorted-desc .sort-indicator::before {
  content: '▼';
}
.sortable-header:not(.is-sorted) .sort-indicator::before {
  content: '↕';
}

@media (max-width: 768px) {
  .date-navigation { flex-direction: column; gap: 12px; }
  .filter-controls { flex-direction: column; align-items: flex-start; gap: 6px; }
  .filter-select { width: 100%; min-width: auto; }
  .summary-cards { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
  .summary-card { padding: 12px; }
  .card-value { font-size: 20px; }
  .report-table { font-size: 12px; }
  .report-table th, .report-table td { padding: 8px 6px; }
}
</style>

<script>
(function() {
  const app = document.getElementById('weeklyReportApp');
  if (!app) {
    return;
  }

  const ownerSelector = document.getElementById('ownerSelector');
  const modeSelector = document.getElementById('modeSelector');
  const weekDisplay = document.getElementById('weekly-date-display');
  const summaryCards = document.getElementById('weekly-summary-cards');
  const tableContainer = document.getElementById('weekly-table-container');
  const detailsBody = document.getElementById('weekly-details-body');
  const emptyState = document.getElementById('weekly-empty-state');
  const emptyStateText = emptyState.querySelector('p');
  const operatorsApi = "{{ url_for('users_api.get_operators') }}";
  const weeklyApi = "{{ url_for('new_reports_api.weekly_report_data') }}";
  const reportPageUrl = "{{ url_for('new_report.weekly_report') }}";
  const pilotPerformanceTemplate = "{{ url_for('pilot.pilot_performance', pilot_id='__PID__') }}";

  const rankMapping = {
    '候补机师': '候选人',
    '训练机师': '试播主播',
    '实习机师': '实习主播',
    '正式机师': '正式主播'
  };

  let currentWeekStart = app.dataset.weekStart;
  let currentOwner = app.dataset.selectedOwner || 'all';
  let currentMode = app.dataset.selectedMode || 'all';
  let currentDetails = [];
  let currentSort = { key: null, direction: 'desc', type: null };
  const emptyFallbackText = emptyStateText ? emptyStateText.textContent : '';
  const reportTable = document.querySelector('.report-table');
  const sortableHeaders = reportTable ? Array.from(reportTable.querySelectorAll('th[data-sort-key]')) : [];

  function formatMoney(value) {
    if (value === null || value === undefined) {
      return '¥0.00';
    }
    return '¥' + Number(value).toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function formatHours(value) {
    if (value === null || value === undefined) {
      return '0.0小时';
    }
    return Number(value).toFixed(1) + '小时';
  }

  function normalizeRank(value) {
    if (!value) {
      return '';
    }
    return rankMapping[value] || value;
  }

  function extractSortValue(value, type) {
    if (type === 'number') {
      const numeric = Number(value);
      return Number.isNaN(numeric) ? 0 : numeric;
    }
    return (value || '').toString();
  }

  function sortDetailsData(dataset) {
    if (!currentSort.key) {
      return dataset;
    }
    const { key, direction, type } = currentSort;
    const multiplier = direction === 'asc' ? 1 : -1;
    dataset.sort((a, b) => {
      const valueA = extractSortValue(a[key], type);
      const valueB = extractSortValue(b[key], type);
      if (type === 'number') {
        if (valueA === valueB) {
          return 0;
        }
        return (valueA > valueB ? 1 : -1) * multiplier;
      }
      return valueA.localeCompare(valueB, 'zh-CN', { sensitivity: 'base' }) * multiplier;
    });
    return dataset;
  }

  function updateHeaderSortStates() {
    if (!sortableHeaders.length) {
      return;
    }
    sortableHeaders.forEach(header => {
      const isActive = currentSort.key && header.dataset.sortKey === currentSort.key;
      header.classList.toggle('is-sorted', Boolean(isActive));
      header.classList.toggle('is-sorted-asc', Boolean(isActive && currentSort.direction === 'asc'));
      header.classList.toggle('is-sorted-desc', Boolean(isActive && currentSort.direction === 'desc'));
      header.setAttribute('aria-sort', isActive ? (currentSort.direction === 'asc' ? 'ascending' : 'descending') : 'none');
    });
  }

  function handleHeaderClick(event) {
    const header = event.target.closest('th[data-sort-key]');
    if (!header) {
      return;
    }
    const sortKey = header.dataset.sortKey;
    if (!sortKey) {
      return;
    }
    const sortType = header.dataset.sortType || 'string';
    let direction = 'asc';
    if (currentSort.key === sortKey) {
      direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else if (sortType === 'number') {
      direction = 'desc';
    }
    currentSort = { key: sortKey, direction, type: sortType };
    updateHeaderSortStates();
    renderSortedDetails();
  }

  function buildDetailRows(details, dateStr) {
    return details.map(detail => {
      const profitClass = detail.total_profit !== null && detail.total_profit < 0 ? 'text-danger' : '';
      const prevProfitClass = detail.prev_week_total_profit !== null && detail.prev_week_total_profit < 0 ? 'text-danger' : '';
      const pilotUrl = pilotPerformanceTemplate.replace('__PID__', detail.pilot_id) + `?from=weekly_report&week_start=${encodeURIComponent(dateStr)}`;

      // 根据主播状态设置链接样式：流失状态的主播使用灰色链接
      const isPilotFallen = detail.pilot_status === 'fallen' ||
                           detail.pilot_status === '流失' ||
                           detail.pilot_status === '已阵亡' ||
                           detail.pilot_status_display === '流失' ||
                           detail.pilot_status_display === '已阵亡' ||
                           detail.status === 'fallen' ||
                           detail.status === '流失' ||
                           detail.status === '已阵亡';
      const pilotLinkClass = isPilotFallen ? 'pilot-link-fallen' : 'pilot-link';

      return `<tr>
        <td class="fixed-col"><a href="${pilotUrl}" class="${pilotLinkClass}">${detail.pilot_display || ''}</a></td>
        <td>${detail.records_count || 0}</td>
        <td>${detail.prev_week_records_count || 0}</td>
        <td>${formatHours(detail.avg_duration)}</td>
        <td>${formatHours(detail.prev_week_avg_duration)}</td>
        <td>${formatMoney(detail.total_revenue)}</td>
        <td>${formatMoney(detail.prev_week_total_revenue)}</td>
        <td class="${profitClass}">${formatMoney(detail.total_profit)}</td>
        <td class="${prevProfitClass}">${formatMoney(detail.prev_week_total_profit)}</td>
        <td>${formatMoney(detail.total_base_salary)}</td>
        <td>${detail.owner || ''}</td>
        <td>${detail.gender_age || ''}</td>
        <td>${normalizeRank(detail.rank)}</td>
        <td>${formatMoney(detail.total_pilot_share)}</td>
        <td>${formatMoney(detail.total_company_share)}</td>
      </tr>`;
    }).join('');
  }

  function renderSortedDetails() {
    if (!currentDetails.length) {
      return;
    }
    const dataset = [...currentDetails];
    sortDetailsData(dataset);
    detailsBody.innerHTML = buildDetailRows(dataset, currentWeekStart);
  }

  function renderSummary(summary) {
    const revenueSum = summary.revenue_sum || 0;
    const basepaySum = summary.basepay_sum || 0;
    const pilotShare = summary.pilot_share_sum || 0;
    const companyShare = summary.company_share_sum || 0;
    const profit = summary.profit_7d || (companyShare - basepaySum);

    const items = [
      { label: '总主播数量', value: (summary.pilot_count || 0).toLocaleString('zh-CN') },
      { label: '累计流水', value: formatMoney(revenueSum) },
      {
        label: '累计底薪支出',
        value: formatMoney(basepaySum),
        sub: summary.conversion_rate !== null && summary.conversion_rate !== undefined ? `转换率${summary.conversion_rate}%` : ''
      },
      { label: '累计主播分成', value: formatMoney(pilotShare) },
      { label: '累计公司分成', value: formatMoney(companyShare) },
      { label: '7天盈利（不计返点）', value: formatMoney(profit), danger: profit < 0 }
    ];

    summaryCards.innerHTML = items.map(item => {
      const dangerClass = item.danger ? ' danger-outline' : '';
      const subHtml = item.sub ? `<div class="card-sub">${item.sub}</div>` : '';
      return `<div class="summary-card${dangerClass}">
        <div class="card-label">${item.label}</div>
        <div class="card-value">${item.value}</div>
        ${subHtml}
      </div>`;
    }).join('');
  }

  function renderDetails(details, dateStr) {
    currentDetails = details;
    currentWeekStart = dateStr;

    if (!details || details.length === 0) {
      detailsBody.innerHTML = '';
      tableContainer.style.display = 'none';
      if (emptyStateText) {
        emptyStateText.textContent = emptyFallbackText;
      }
      emptyState.style.display = 'block';
      return;
    }

    emptyState.style.display = 'none';
    tableContainer.style.display = 'block';
    renderSortedDetails();
  }

  function showLoading() {
    const loadingState = document.getElementById('weekly-loading-state');
    const content = document.getElementById('weekly-content');
    const tableContainer = document.getElementById('weekly-table-container');
    const emptyState = document.getElementById('weekly-empty-state');

    loadingState.style.display = 'block';
    content.style.display = 'none';
    tableContainer.style.display = 'none';
    emptyState.style.display = 'none';
  }

  function showError(message) {
    const loadingState = document.getElementById('weekly-loading-state');
    const content = document.getElementById('weekly-content');
    const tableContainer = document.getElementById('weekly-table-container');
    const emptyState = document.getElementById('weekly-empty-state');
    const emptyStateText = emptyState.querySelector('p');

    loadingState.style.display = 'none';
    content.style.display = 'block';
    summaryCards.innerHTML = '';
    detailsBody.innerHTML = '';
    tableContainer.style.display = 'none';
    if (emptyStateText) {
      emptyStateText.textContent = message;
    }
    emptyState.style.display = 'block';
  }

  async function loadOwnerOptions() {
    try {
      const response = await fetch(operatorsApi);
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error ? payload.error.message : '加载运营失败');
      }
      const operators = payload.data || [];
      operators.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.nickname || user.username || user.id;
        ownerSelector.appendChild(option);
      });
      ownerSelector.value = currentOwner;
    } catch (error) {
      console.error('加载直属运营列表失败：', error);
      ownerSelector.value = currentOwner;
    }
  }

  function buildWeeklyApiUrl() {
    const params = new URLSearchParams();
    if (currentWeekStart) {
      params.set('week_start', currentWeekStart);
    }
    if (currentOwner && currentOwner !== 'all') {
      params.set('owner', currentOwner);
    }
    if (currentMode && currentMode !== 'all') {
      params.set('mode', currentMode);
    }
    return `${weeklyApi}?${params.toString()}`;
  }

  async function loadWeeklyReport() {
    showLoading();
    try {
      const response = await fetch(buildWeeklyApiUrl());
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error ? payload.error.message : '加载失败');
      }
      const data = payload.data;
      const filters = payload.meta ? payload.meta.filters : null;
      currentWeekStart = data.week_start;
      if (filters) {
        currentOwner = filters.owner || 'all';
        currentMode = filters.mode || 'all';
      }
      if (weekDisplay) {
        weekDisplay.textContent = `${data.week_start}（周二起）`;
      }
      ownerSelector.value = currentOwner;
      modeSelector.value = currentMode;
      // 隐藏loading状态，显示内容
      const loadingState = document.getElementById('weekly-loading-state');
      const content = document.getElementById('weekly-content');
      loadingState.style.display = 'none';
      content.style.display = 'block';

      renderSummary(data.summary || {});
      renderDetails(data.details || [], data.week_start);
    } catch (error) {
      console.error('加载开播新周报失败：', error);
      showError('报表加载失败，请稍后再试');
    }
  }

  function navigate(params) {
    const url = new URL(reportPageUrl, window.location.origin);
    const targetWeek = params.week_start || currentWeekStart;
    const targetOwner = params.owner !== undefined ? params.owner : currentOwner;
    const targetMode = params.mode !== undefined ? params.mode : currentMode;
    if (targetWeek) {
      url.searchParams.set('week_start', targetWeek);
    }
    url.searchParams.set('owner', targetOwner || 'all');
    url.searchParams.set('mode', targetMode || 'all');
    window.location.href = url.toString();
  }

  ownerSelector.addEventListener('change', function() {
    navigate({ owner: this.value || 'all' });
  });

  modeSelector.addEventListener('change', function() {
    navigate({ mode: this.value || 'all' });
  });

  // CSV导出按钮事件处理器 - 添加时间戳避免CDN缓存
  const exportCsvBtn = document.getElementById('exportCsvBtn');
  if (exportCsvBtn) {
    exportCsvBtn.addEventListener('click', function(e) {
      e.preventDefault();

      // 构建基础导出URL
      const exportUrl = '{{ url_for("new_report.export_weekly_csv") }}';
      const url = new URL(exportUrl, window.location.origin);

      // 添加当前筛选参数
      url.searchParams.set('week_start', currentWeekStart);
      url.searchParams.set('owner', currentOwner || 'all');
      url.searchParams.set('mode', currentMode || 'all');

      // 添加时间戳参数避免CDN缓存
      const timestamp = Date.now();
      url.searchParams.set('_t', timestamp.toString());

      // 创建临时下载链接
      const tempLink = document.createElement('a');
      tempLink.href = url.toString();
      tempLink.style.display = 'none';
      document.body.appendChild(tempLink);
      tempLink.click();
      document.body.removeChild(tempLink);
    });
  }

  // 添加排序事件监听器
  if (reportTable) {
    reportTable.addEventListener('click', handleHeaderClick);
  }

  (async function init() {
    await loadOwnerOptions();
    await loadWeeklyReport();
  })();
})();
</script>
{% endblock %}
