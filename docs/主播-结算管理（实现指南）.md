# ä¸»æ’­-ç»“ç®—ç®¡ç† å®ç°æŒ‡å—

> æœ¬æ–‡æ¡£è®°å½•ä¸»æ’­ç»“ç®—ç®¡ç†åŠŸèƒ½çš„å®ç°è¿›åº¦å’ŒæŠ€æœ¯ç»†èŠ‚

## ğŸ“‹ å®ç°è¿›åº¦

### âœ… å·²å®Œæˆï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰

#### æ•°æ®æ¨¡å‹
- **Settlement** (`models/pilot.py`)
  - ä¸»æ’­ç»“ç®—æ–¹å¼è®°å½•
  - å­—æ®µï¼špilot_id, effective_date (UTC), settlement_type (enum), remark, is_active, created_at, updated_at
  - æ”¯æŒä¸‰ç§ç»“ç®—æ–¹å¼ï¼šdaily_base (æ—¥ç»“)ã€monthly_base (æœˆç»“)ã€none (æ— åº•è–ª)
  - åŒ…å«éªŒè¯é€»è¾‘ï¼šåŒä¸€ä¸»æ’­åŒä¸€ç”Ÿæ•ˆæ—¥æœŸä»…å…è®¸ä¸€æ¡æœ‰æ•ˆè®°å½•

- **SettlementChangeLog** (`models/pilot.py`)
  - ç»“ç®—æ–¹å¼å˜æ›´æ—¥å¿—
  - å­—æ®µï¼šsettlement_id, user_id, field_name, old_value, new_value, change_time, ip_address

- **BaseSalaryApplication** (`models/battle_record.py`)
  - åº•è–ªç”³è¯·è®°å½•
  - å­—æ®µï¼špilot_id, battle_record_id, settlement_type (å¿«ç…§), base_salary_amount, applicant_id, status, created_at, updated_at
  - æ”¯æŒä¸‰ç§çŠ¶æ€ï¼špending (æœªå¤„ç†)ã€approved (å·²å‘æ”¾)ã€rejected (æ‹’ç»å‘æ”¾)

- **BaseSalaryApplicationChangeLog** (`models/battle_record.py`)
  - åº•è–ªç”³è¯·å˜æ›´æ—¥å¿—
  - å­—æ®µï¼šapplication_id, user_id, field_name, old_value, new_value, remark, change_time, ip_address

#### REST API æ¥å£
- **settlers_api.py** (`routes/settlements_api.py`)
  ```
  GET    /api/settlements/<pilot_id>                    - è·å–ä¸»æ’­ç»“ç®—æ–¹å¼åˆ—è¡¨åŠå½“å‰ç”Ÿæ•ˆä¿¡æ¯
  POST   /api/settlements/<pilot_id>                    - åˆ›å»ºæ–°çš„ç»“ç®—æ–¹å¼è®°å½•
  PUT    /api/settlements/<record_id>                   - æ›´æ–°ç»“ç®—æ–¹å¼è®°å½•
  DELETE /api/settlements/<record_id>                   - è½¯åˆ é™¤ç»“ç®—æ–¹å¼è®°å½•
  GET    /api/settlements/<pilot_id>/effective?date=    - æŸ¥è¯¢æŒ‡å®šæ—¥æœŸçš„ç”Ÿæ•ˆç»“ç®—æ–¹å¼
  GET    /api/settlements/<record_id>/changes           - è·å–å˜æ›´æ—¥å¿—
  ```

- **base_salary_applications_api.py** (`routes/base_salary_applications_api.py`)
  ```
  GET    /api/base-salary-applications                  - è·å–åº•è–ªç”³è¯·åˆ—è¡¨ï¼ˆæ”¯æŒæ—¥æœŸç­›é€‰ï¼‰
  POST   /api/base-salary-applications                  - åˆ›å»ºæ–°çš„åº•è–ªç”³è¯·
  GET    /api/base-salary-applications/<app_id>        - è·å–å•ä¸ªç”³è¯·è¯¦æƒ…
  PATCH  /api/base-salary-applications/<app_id>/status - æ›´æ–°ç”³è¯·çŠ¶æ€
  GET    /api/base-salary-applications/<app_id>/changes - è·å–å˜æ›´æ—¥å¿—
  GET    /api/base-salary-applications/export?date=    - å¯¼å‡ºä¸ºCSV
  ```

#### åºåˆ—åŒ–å·¥å…·
- **settlement_serializers.py** - ç»“ç®—æ–¹å¼åºåˆ—åŒ–
- **base_salary_application_serializers.py** - åº•è–ªç”³è¯·åºåˆ—åŒ–
- å‡åŒ…å«ç»Ÿä¸€çš„å“åº”æ ¼å¼å‡½æ•°

#### å‰ç«¯é¡µé¢
- **pilots/settlement/index.html** - ç»“ç®—ç®¡ç†é¦–é¡µ
  - æ˜¾ç¤ºå½“å‰ç”Ÿæ•ˆç»“ç®—æ–¹å¼ä¿¡æ¯
  - åˆ—è¡¨å±•ç¤ºç»“ç®—æ–¹å¼è®°å½•ï¼ˆæ”¯æŒç¼–è¾‘ã€æŸ¥çœ‹å˜æ›´ã€åˆ é™¤/æ¢å¤ï¼‰
  - åˆ†é¡µã€æ¨¡æ€æ¡†åŠ è½½å˜æ›´è®°å½•

- **pilots/settlement/new.html** - æ–°å¢ç»“ç®—æ–¹å¼è¡¨å•
  - ç”Ÿæ•ˆæ—¥æœŸè‡ªç”±é€‰æ‹©
  - ç»“ç®—æ–¹å¼é€‰æ‹©ï¼ˆä¸‹æ‹‰ï¼‰
  - å¤‡æ³¨æ–‡æœ¬åŸŸï¼ˆ200å­—ç¬¦é™åˆ¶ï¼‰
  - å‰ç«¯éªŒè¯å’Œåç«¯é”™è¯¯å¤„ç†

#### è·¯ç”±å¤„ç†
- **routes/pilot.py** æ–°å¢è·¯ç”±
  - `GET /pilots/<pilot_id>/settlement/` - ç»“ç®—ç®¡ç†é¦–é¡µ
  - `GET /pilots/<pilot_id>/settlement/new` - æ–°å¢é¡µé¢
  - `GET /pilots/<pilot_id>/settlement/<record_id>/edit` - ç¼–è¾‘é¡µé¢

#### åº”ç”¨é›†æˆ
- åœ¨ `app.py` ä¸­å·²æ³¨å†Œä¸¤ä¸ªè“å›¾ï¼š`settlements_api_bp` å’Œ `base_salary_applications_api_bp`

---

### â³ å¾…å®Œæˆ

#### ç¬¬äºŒé˜¶æ®µ

**ç¼–è¾‘ç»“ç®—æ–¹å¼é¡µé¢** (`pilots/settlement/edit.html`)
- è¡¨å•å­—æ®µï¼šç»“ç®—æ–¹å¼ï¼ˆå¯ç¼–è¾‘ï¼‰ã€å¤‡æ³¨ï¼ˆå¯ç¼–è¾‘ï¼‰ã€çŠ¶æ€å¼€å…³ï¼ˆæœ‰æ•ˆ/æ— æ•ˆï¼‰
- å‰ç«¯é€»è¾‘ï¼šé€šè¿‡PUTè¯·æ±‚æ›´æ–°API
- éªŒè¯ï¼šåŒç”Ÿæ•ˆæ—¥æœŸä¸èƒ½é‡å¤

**å¼€æ’­è®°å½•è¯¦æƒ…é¡µé›†æˆ**
```html
<!-- åœ¨æ”¶ç›Šä¿¡æ¯å¡ç‰‡ä¸‹æ–¹æ–°å¢ç»“ç®—æ–¹å¼å¡ç‰‡ -->
<div class="settlement-info-card">
  <div class="settlement-type">{{settlement_type_display}}</div>
  <div class="effective-date">ç”Ÿæ•ˆæ—¥æœŸ: {{effective_date}}</div>
  
  <!-- å½“settlement_typeä¸ºdaily_baseæ—¶æ˜¾ç¤º -->
  {% if settlement_type == 'daily_base' %}
    <button onclick="openBaseSalaryApplication()">ç”³è¯·åº•è–ª</button>
    {% if has_pending_application %}
      <div class="warning">å·²å­˜åœ¨åº•è–ªç”³è¯·</div>
    {% endif %}
  {% endif %}
</div>
```

**åº•è–ªç”³è¯·è¡¨å•é¡µé¢** (`battle_records/base-salary-application.html`)
- å…¥å£ï¼šå¼€æ’­è®°å½•è¯¦æƒ…é¡µ"ç”³è¯·åº•è–ª"æŒ‰é’®
- æ˜¾ç¤ºä¸»æ’­ä¿¡æ¯ã€å¼€æ’­è®°å½•æ¦‚è¦ã€ç”³è¯·è¡¨å•
- å­—æ®µï¼šç»“ç®—æ–¹å¼ï¼ˆåªè¯»ï¼‰ã€æµæ°´é‡‘é¢ï¼ˆåªè¯»ï¼‰ã€åº•è–ªé‡‘é¢ï¼ˆå¯ç¼–è¾‘ï¼‰ã€å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰
- APIè°ƒç”¨ï¼šPOST /api/base-salary-applications

#### ç¬¬ä¸‰é˜¶æ®µ

**è´¢åŠ¡èœå•é›†æˆ**
- åœ¨å¯¼èˆª"è´¢åŠ¡"åˆ†ç»„ä¸‹æ·»åŠ "åº•è–ªç®¡ç†"èœå•
- è·¯ç”±ï¼š`GET /reports/base-salary-applications`ï¼ˆæˆ–åœ¨ç°æœ‰æŠ¥å‘Šèœå•ä¸‹ï¼‰

**åº•è–ªç”³è¯·åˆ—è¡¨é¡µé¢** (`reports/base_salary_applications.html`)
```html
<!-- é¡¶éƒ¨ï¼šæ—¥æœŸé€‰æ‹©å™¨ -->
<div class="date-picker">
  <input type="date" id="applicationDate" default="today" />
  <button onclick="prevDay()">â†</button>
  <button onclick="nextDay()">â†’</button>
</div>

<!-- æ“ä½œæ  -->
<button onclick="exportCSV()">å¯¼å‡ºCSV</button>

<!-- åˆ—è¡¨å¡ç‰‡ -->
<!-- å­—æ®µï¼šä¸»æ’­æ˜µç§°(çœŸå®å§“å)ã€å¼€æ’­æ—¶é—´+æ—¶é•¿ã€ç›´å±è¿è¥ã€ç”³è¯·äººã€æµæ°´/åº•è–ªé‡‘é¢ã€çŠ¶æ€ -->
<!-- æ”¯æŒç‚¹å‡»è¿›å…¥è¯¦æƒ…é¡µ -->
```

**åº•è–ªç”³è¯·è¯¦æƒ…é¡µé¢** (`reports/base_salary_application_detail.html`)
- é¡µé¢å¸ƒå±€å‚è€ƒç”³è¯·é¡µé¢
- æ–°å¢å‘æ”¾çŠ¶æ€å±•ç¤ºï¼šçŠ¶æ€ã€æ“ä½œäººã€æ“ä½œæ—¶é—´
- é¡µé¢åº•éƒ¨æŒ‰é’®ï¼š
  - ç¡®è®¤å‘æ”¾ï¼ˆæœªå¤„ç†ã€æ‹’ç»æ—¶æ˜¾ç¤ºï¼‰
  - æ‹’ç»å‘æ”¾ï¼ˆæœªå¤„ç†ã€å·²å‘æ”¾æ—¶æ˜¾ç¤ºï¼‰
  - å›åˆ°æœªå¤„ç†ï¼ˆå·²å‘æ”¾ã€æ‹’ç»æ—¶æ˜¾ç¤ºï¼‰
  - å˜æ›´è®°å½•ï¼ˆæ¨¡æ€æ¡†ï¼‰
- çŠ¶æ€å˜æ›´æ—¶éœ€è¾“å…¥å¤‡æ³¨

**CSVå¯¼å‡ºå®ç°**
- å·²åœ¨base_salary_applications_api.pyä¸­å®ç°
- å­—æ®µï¼šä¸»æ’­æ˜µç§°ã€çœŸå®å§“åã€ç›´å±è¿è¥ã€å¼€æ’­æ—¶é—´ã€æ—¶é•¿ã€æµæ°´é‡‘é¢ã€ç”³è¯·äººã€åº•è–ªé‡‘é¢ã€ç”³è¯·æ—¶é—´ã€çŠ¶æ€
- å…³è”è®°å½•ä¸¢å¤±æ—¶è¿”å›"æœªçŸ¥"ï¼Œä¸å´©æºƒ

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ—¶é—´å¤„ç†
- æ‰€æœ‰æ—¥æœŸæ—¶é—´åœ¨æ•°æ®åº“ä¸­å­˜å‚¨ä¸ºUTC
- ç”¨æˆ·è¾“å…¥å’Œæ˜¾ç¤ºå‡è½¬æ¢ä¸ºGMT+8
- ç”Ÿæ•ˆæ—¥æœŸæŒ‰è‡ªç„¶æ—¥ç•Œå®šï¼Œä¸åŒ…å«æ—¶é—´éƒ¨åˆ†

### å…³è”è®°å½•å¤„ç†
æŒ‰ç…§ç”¨æˆ·è¦æ±‚ï¼Œå¯¹å…³è”è®°å½•ä¸¢å¤±çš„æƒ…å†µè¿›è¡Œé™çº§å¤„ç†ï¼š
```python
# åºåˆ—åŒ–å‡½æ•°ä¸­çš„ç¤ºä¾‹
battle_record_data = None
if application.battle_record_id:
    try:
        br = application.battle_record_id
        battle_record_data = {
            'id': str(br.id),
            'start_time': utc_to_local(br.start_time).isoformat(),
            'revenue_amount': str(br.revenue_amount),
        }
    except Exception:  # å¤„ç†å…³è”è®°å½•ä¸¢å¤±ç­‰å¼‚å¸¸
        battle_record_data = {'id': str(application.battle_record_id.id)}
```

### æƒé™æ§åˆ¶
- æ‰€æœ‰æ¥å£ä½¿ç”¨ `@jwt_roles_accepted('gicho', 'kancho')` ä¿æŠ¤
- ä»…å…è®¸ç®¡ç†å‘˜å’Œè¿è¥è§’è‰²æ“ä½œ

### æ—¥å¿—è®°å½•
- æ‰€æœ‰å˜æ›´æ“ä½œéƒ½è®°å½•IPåœ°å€å’Œæ“ä½œäºº
- çº§åˆ«ï¼šINFOï¼ˆæ­£å¸¸æ“ä½œï¼‰ã€ERRORï¼ˆé”™è¯¯ï¼‰ã€DEBUGï¼ˆè¯¦ç»†è¿‡ç¨‹ï¼‰
- æ—¥å¿—æ–‡ä»¶ï¼š`./log/settlement.log`ã€`./log/base_salary_application.log`

---

## ğŸ“ API å“åº”ç¤ºä¾‹

### è·å–ç»“ç®—æ–¹å¼åˆ—è¡¨
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "...",
        "pilot_id": "...",
        "effective_date": "2025-10-20T00:00:00+08:00",
        "settlement_type": "daily_base",
        "settlement_type_display": "æ—¥ç»“åº•è–ª",
        "remark": "è°ƒæ•´ä¸ºæ—¥ç»“",
        "is_active": true,
        "created_at": "2025-10-16T10:00:00+08:00",
        "updated_at": "2025-10-16T10:00:00+08:00"
      }
    ],
    "current_settlement": {
      "settlement_type": "daily_base",
      "settlement_type_display": "æ—¥ç»“åº•è–ª",
      "effective_date": "2025-10-20T00:00:00+08:00",
      "remark": "è°ƒæ•´ä¸ºæ—¥ç»“"
    }
  },
  "error": null,
  "meta": {
    "page": 1,
    "page_size": 20,
    "total": 5
  }
}
```

### åˆ›å»ºåº•è–ªç”³è¯·
```json
{
  "success": true,
  "data": {
    "id": "...",
    "pilot": {
      "id": "...",
      "nickname": "ä¸»æ’­å",
      "real_name": "çœŸå®å§“å",
      "owner": {"id": "...", "nickname": "è¿è¥å"}
    },
    "battle_record": {
      "id": "...",
      "start_time": "2025-10-16T10:00:00+08:00",
      "revenue_amount": "1000.00",
      "duration_hours": 2.5
    },
    "settlement_type": "daily_base",
    "base_salary_amount": "100.00",
    "applicant": {"id": "...", "nickname": "ç”³è¯·äºº"},
    "status": "pending",
    "status_display": "æœªå¤„ç†",
    "created_at": "2025-10-16T14:30:00+08:00"
  },
  "error": null,
  "meta": {}
}
```

---

## ğŸš€ ä½¿ç”¨å»ºè®®

### ç«‹å³å¯ç”¨
1. æ‰€æœ‰APIæ¥å£å·²å‡†å¤‡å°±ç»ªï¼Œå¯é€šè¿‡curlæˆ–Postmanæµ‹è¯•
2. ç»“ç®—ç®¡ç†é¦–é¡µå’Œæ–°å¢é¡µé¢å¯ç›´æ¥è®¿é—®

### ä¸‹ä¸€æ­¥å»ºè®®
1. åˆ›å»ºç¼–è¾‘é¡µé¢æ¨¡æ¿ï¼ˆå‚è€ƒnew.htmlï¼Œä½†å­—æ®µå¯ç¼–è¾‘æ€§ä¸åŒï¼‰
2. åœ¨å¼€æ’­è®°å½•è¯¦æƒ…é¡µé›†æˆç»“ç®—æ–¹å¼æ˜¾ç¤º
3. å®ç°è´¢åŠ¡èœå•ä¸‹çš„åº•è–ªç”³è¯·åˆ—è¡¨å’Œè¯¦æƒ…é¡µ
4. ç¼–å†™å‰ç«¯å•å…ƒæµ‹è¯•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£
- åŠŸèƒ½æ–‡æ¡£ï¼š`docs/ä¸»æ’­-ç»“ç®—ç®¡ç†.md`
- APIæ–‡æ¡£ï¼šè§ä¸Šè¿°æ¥å£åˆ—è¡¨
- æ•°æ®åº“è®¾è®¡ï¼šè§æ¨¡å‹å®šä¹‰å’Œç´¢å¼•é…ç½®
