### 基础-邮件发送功能

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：议长→管理员。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。
本功能为系统提供统一的邮件发送能力，支持纯文本、HTML 与 Markdown 内容，内置日志与调试模式，便于开发与排查。

---

### 目录
- 功能概览
- 关键模块与入口
- 环境变量与配置
- 发送流程说明
- Markdown 支持
- HTML 模板与表格样式
- 调试模式（MAIL_DEBUG）
- 日志规范
- CLI 使用
- Pytest 用例

---

### 功能概览
- 支持收件人列表、主题、纯文本正文与可选 HTML 正文。
- 支持以 Markdown 文本输入，自动渲染为 HTML，并同步生成纯文本降级内容。
- HTML 模板统一包装（标题、分隔线、系统签名）。
- 对 HTML 中的表格自动添加内联样式，提升在邮件客户端的可视效果（边框、内边距、表头底色）。
- 日志按自然日切分；支持调试模式将渲染后的 HTML 直接落盘。

---

### 关键模块与入口
- 代码位置：`utils/mail_utils.py`
- 核心函数：
  - `send_email(recipients: List[str], subject: str, content: str, html_content: Optional[str] = None) -> bool`
  - `send_email_md(recipients: List[str], subject: str, md_content: str) -> bool`
- 重要私有方法：
  - `_create_text_template(content: str) -> str`
  - `_create_html_template(content: str) -> str`
  - `_apply_inline_table_styles(html: str) -> str`
- CLI 调试入口：`python utils/mail_utils.py`

---

### 环境变量与配置
- `SES_SMTP_SERVER`：SMTP 服务器地址，默认 `smtp.gmail.com`
- `SES_SMTP_PORT`：SMTP 端口，默认 `587`
- `SES_SMTP_USER`：SMTP 用户名（必填）
- `SES_SMTP_PASSWORD`：SMTP 密码（必填）
- `SENDER_EMAIL`：发件人地址（必填）
- `MAIL_DEBUG`：调试模式，`true`/`false`，默认 `false`

依赖（见 `requirements.txt`）：
- `markdown`：Markdown 渲染为 HTML
- `html2text`：HTML 提取纯文本降级内容
- `beautifulsoup4`：为表格节点安全地内联样式

---

### 发送流程说明
1. 参数校验与 MIME 组装：始终包含纯文本部件；若传入 `html_content` 则附加 HTML 部件，否则由纯文本生成 HTML。
2. 调试分支（见下文 MAIL_DEBUG）：可在不接入 SMTP 的情况下预览邮件 HTML。
3. 真正发送：使用 `smtplib.SMTP` + `starttls()` 登录并发送。

---

### Markdown 支持
- 入口：`send_email_md(recipients, subject, md_content)`
- 渲染：`markdown.markdown(md_content, extensions=["extra","sane_lists","smarty"])`
- 纯文本：由 `html2text.html2text(rendered_html)` 提取，保证客户端退化可读。

---

### HTML 模板与表格样式
- 模板封装：`_create_html_template` 统一包裹系统标题、分隔线、签名与发送时间。
- 表格样式：`_apply_inline_table_styles` 使用 BeautifulSoup 为 `<table>/<th>/<td>` 添加内联样式：
  - `<table>`：`border-collapse: collapse; width: 100%; margin: 10px 0;`
  - `<th>/<td>`：`border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top;`
  - `<th>` 额外：`background: #f7f7f7`

说明：多数邮件客户端忽略 `<style>`，因此采用“内联样式”确保兼容性。

---

### 调试模式（MAIL_DEBUG）
- 当 `MAIL_DEBUG=true` 时，不走 SMTP；渲染后的最终 HTML 会落盘到 `log/mail/<主题安全化>_<时间戳>.html`。
- 日志会记录“未发送，仅落盘”的提示，便于开发预览。
- 主题安全化：仅保留字母数字，其余替换为下划线，最大保留 60 字符。

---

### 日志规范
- 使用 `utils/logging_setup.get_logger('mail')` 获取 logger，日志按自然日切分：`log/mail_YYYYMMDD.log`。
- 级别：默认 `INFO`，可通过 `LOG_LEVEL` 环境变量调整。
- 第三方库日志的控制见 `utils/logging_setup.py`。

---

### CLI 使用
命令：
```
python utils/mail_utils.py
```
步骤：
1）按提示输入收件人邮箱；
2）选择测试方式：普通模板或 Markdown；
3）在 `MAIL_DEBUG=true` 下仅在 `log/mail/` 生成 HTML 文件，不实际发送。

---

### 测试用例
- 测试方法：`__send_test_email` 和 `__send_test_email_by_md`
- 功能：
  - 校验 Markdown 渲染、表格样式与 HTML 落盘
  - 校验普通 HTML 渲染与落盘
- 均在 `MAIL_DEBUG=true` 环境下运行，不依赖真实 SMTP

---

### 常见问题
- 看不到 `mail.log`？系统日志按日切分，文件名为 `mail_YYYYMMDD.log`，而非固定名。
- 表格无边框？请确保使用 `send_email_md` 或传入的 `html_content` 不自行覆盖内联样式。


