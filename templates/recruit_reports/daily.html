{% extends "base.html" %}

{% block title %}ä¸»æ’­æ‹›å‹Ÿæ—¥æŠ¥ - {{ pagination.date }}{% endblock %}

{% block content %}
<div id="recruitDailyApp" data-report-date="{{ pagination.date }}" data-selected-recruiter="{{ selected_recruiter }}">
  <div class="page-header">
    <h1 class="page-title">ğŸ“Š ä¸»æ’­æ‹›å‹Ÿæ—¥æŠ¥</h1>
    <p class="text-muted" id="dailyDateLabel">{{ pagination.date }}</p>
  </div>

  <div class="date-navigation">
    <div class="date-controls">
      <a id="prevDateLink" href="{{ url_for('report.recruit_daily_report', date=pagination.prev_date, recruiter=selected_recruiter) }}" class="btn btn-secondary btn-sm">â† å‰ä¸€æ—¥</a>
      <input type="date" id="dateSelector" value="{{ pagination.date }}" class="date-input">
      <a id="nextDateLink" href="{{ url_for('report.recruit_daily_report', date=pagination.next_date, recruiter=selected_recruiter) }}" class="btn btn-secondary btn-sm">åä¸€æ—¥ â†’</a>
    </div>

    <div class="recruiter-filter">
      <label for="recruiterSelector" class="filter-label">æ‹›å‹Ÿè´Ÿè´£äººï¼š</label>
      <select id="recruiterSelector" class="recruiter-select">
        <option value="all">å…¨éƒ¨</option>
      </select>
    </div>
  </div>

  <div class="statistics-section">
    <h2 class="section-title" id="summaryTitle">æ‹›å‹Ÿç»Ÿè®¡åŠ è½½ä¸­â€¦</h2>
    <div class="table-container">
      <table class="statistics-table" id="recruitSummaryTable">
        <thead>
          <tr>
            <th>ç»Ÿè®¡èŒƒå›´</th>
            <th>çº¦é¢</th>
            <th>åˆ°é¢</th>
            <th>è¯•æ’­</th>
            <th>æ–°å¼€æ’­</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="range-label">æŠ¥è¡¨æ—¥</td>
            <td class="stat-value clickable" data-range="report_day" data-metric="appointments">
              <span class="stat-count">--</span>
              <span class="trend-indicator report-day-trend"></span>
            </td>
            <td class="stat-value clickable" data-range="report_day" data-metric="interviews">
              <span class="stat-count">--</span>
              <span class="trend-indicator report-day-trend"></span>
            </td>
            <td class="stat-value clickable" data-range="report_day" data-metric="trials">
              <span class="stat-count">--</span>
              <span class="trend-indicator report-day-trend"></span>
            </td>
            <td class="stat-value clickable" data-range="report_day" data-metric="new_recruits">
              <span class="stat-count">--</span>
              <span class="trend-indicator report-day-trend"></span>
            </td>
          </tr>
          <tr>
            <td class="range-label">è¿‘7æ—¥</td>
            <td class="stat-value clickable" data-range="last_7_days" data-metric="appointments">
              <span class="stat-count">--</span>
              <div class="average">7æ—¥å‡: -- <span class="trend-indicator"></span></div>
            </td>
            <td class="stat-value clickable" data-range="last_7_days" data-metric="interviews">
              <span class="stat-count">--</span>
              <div class="average">7æ—¥å‡: -- <span class="trend-indicator"></span></div>
            </td>
            <td class="stat-value clickable" data-range="last_7_days" data-metric="trials">
              <span class="stat-count">--</span>
              <div class="average">7æ—¥å‡: -- <span class="trend-indicator"></span></div>
            </td>
            <td class="stat-value clickable" data-range="last_7_days" data-metric="new_recruits">
              <span class="stat-count">--</span>
              <div class="average">7æ—¥å‡: -- <span class="trend-indicator"></span></div>
            </td>
          </tr>
          <tr>
            <td class="range-label">è¿‘14æ—¥</td>
            <td class="stat-value clickable" data-range="last_14_days" data-metric="appointments">
              <span class="stat-count">--</span>
              <div class="average">14æ—¥å‡: --</div>
            </td>
            <td class="stat-value clickable" data-range="last_14_days" data-metric="interviews">
              <span class="stat-count">--</span>
              <div class="average">14æ—¥å‡: --</div>
            </td>
            <td class="stat-value clickable" data-range="last_14_days" data-metric="trials">
              <span class="stat-count">--</span>
              <div class="average">14æ—¥å‡: --</div>
            </td>
            <td class="stat-value clickable" data-range="last_14_days" data-metric="new_recruits">
              <span class="stat-count">--</span>
              <div class="average">14æ—¥å‡: --</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="empty-state" id="summaryError" style="display: none;">
      <p>æŠ¥è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</p>
    </div>
  </div>

  <div class="trend-chart-section" id="trendChartSection" style="display: none;">
    <h2 class="section-title">14æ—¥ç´¯è®¡è¶‹åŠ¿</h2>
    <div class="trend-chart-card">
      <canvas id="recruitTrendChart" aria-label="æ‹›å‹Ÿ14æ—¥è¶‹åŠ¿"></canvas>
    </div>
  </div>

  <div class="explanation-section">
    <h2 class="section-title">æŒ‡æ ‡è¯´æ˜</h2>
    <div class="explanation-cards">
      <div class="explanation-card">
        <div class="card-icon">ğŸ“…</div>
        <div class="card-content">
          <h3>çº¦é¢</h3>
          <p>å½“å¤©åˆ›å»ºçš„æ‹›å‹Ÿæ•°é‡</p>
        </div>
      </div>
      <div class="explanation-card">
        <div class="card-icon">ğŸ‘¥</div>
        <div class="card-content">
          <h3>åˆ°é¢</h3>
          <p>å½“å¤©å®Œæˆçš„é¢è¯•å†³ç­–æ•°é‡ï¼ˆæ— è®ºç»“æœï¼‰</p>
        </div>
      </div>
      <div class="explanation-card">
        <div class="card-icon">ğŸ¯</div>
        <div class="card-content">
          <h3>è¯•æ’­</h3>
          <p>å½“å¤©å®Œæˆçš„è¯•æ’­å†³ç­–æ•°é‡ï¼ˆæ— è®ºç»“æœï¼‰</p>
        </div>
      </div>
      <div class="explanation-card">
        <div class="card-icon">ğŸš€</div>
        <div class="card-content">
          <h3>æ–°å¼€æ’­</h3>
          <p>å½“å¤©å†³å®šæ‹›å‹Ÿä¸ºæ­£å¼/å®ä¹ ä¸»æ’­çš„æ•°é‡</p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.date-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0;
  padding: 16px;
  background: var(--table-header);
  border-radius: 8px;
}

.date-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.date-input {
  padding: 8px 12px;
  border: 1px solid var(--gray);
  border-radius: 6px;
  font-size: 14px;
}

.recruiter-filter {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}

.recruiter-select {
  padding: 8px 12px;
  border: 1px solid var(--gray);
  border-radius: 6px;
  font-size: 14px;
  background: #fff;
  min-width: 150px;
}

.statistics-section {
  margin: 24px 0;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

.table-container {
  overflow-x: auto;
  border: 1px solid var(--gray);
  border-radius: 8px;
  background: #fff;
}

.statistics-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 600px;
}

.statistics-table th,
.statistics-table td {
  padding: 12px 8px;
  text-align: center;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

.statistics-table th {
  background: var(--table-header);
  font-weight: 600;
}

.trend-chart-section {
  margin: 32px 0;
}

.trend-chart-card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 12px;
  padding: 20px;
  min-height: 160px;
}

.trend-chart-card canvas {
  width: 100%;
  height: 320px;
  max-height: 320px;
}

.range-label {
  font-weight: 600;
  text-align: left;
}

.stat-value {
  position: relative;
  font-size: 20px;
  font-weight: 600;
  color: var(--text);
}

.stat-value .stat-count {
  display: inline-block;
  min-width: 32px;
  margin-right: 4px;
}

.stat-value .report-day-trend {
  display: inline-block;
  vertical-align: middle;
}

.average {
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

.trend-indicator {
  display: inline-block;
  font-size: 14px;
  font-weight: bold;
  margin-left: 2px;
}

.trend-indicator.up {
  color: #dc3545;
}

.trend-indicator.down {
  color: #28a745;
  animation: glow-pulse 1.5s ease-in-out infinite;
}

@keyframes glow-pulse {
  0%, 100% {
    text-shadow: 0 0 8px rgba(40, 167, 69, 0.8),
                 0 0 16px rgba(40, 167, 69, 0.6),
                 0 0 24px rgba(40, 167, 69, 0.4),
                 0 0 32px rgba(40, 167, 69, 0.3);
    filter: brightness(1);
  }
  50% {
    text-shadow: 0 0 12px rgba(40, 167, 69, 1),
                 0 0 24px rgba(40, 167, 69, 0.9),
                 0 0 36px rgba(40, 167, 69, 0.7),
                 0 0 48px rgba(40, 167, 69, 0.5),
                 0 0 60px rgba(40, 167, 69, 0.3);
    filter: brightness(1.3);
  }
}

.stat-value.clickable {
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.stat-value.clickable:hover {
  background-color: var(--hover-bg);
}

.stat-value.clickable:active {
  background-color: var(--active-bg);
}

.empty-state {
  margin-top: 12px;
  text-align: center;
  color: var(--muted);
}

.explanation-section {
  margin: 24px 0;
}

.explanation-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.explanation-card {
  background: #fff;
  border: 1px solid var(--gray);
  border-radius: 8px;
  padding: 16px;
  display: flex;
  gap: 12px;
  align-items: center;
}

.card-icon {
  font-size: 24px;
}

.card-content h3 {
  margin: 0 0 6px;
  font-size: 16px;
  font-weight: 600;
}

.card-content p {
  margin: 0;
  color: var(--muted);
  font-size: 14px;
}

@media (max-width: 768px) {
  .date-navigation {
    flex-direction: column;
    gap: 12px;
  }

  .recruiter-filter {
    width: 100%;
    justify-content: flex-start;
  }

  .recruiter-select {
    width: 100%;
  }

  .statistics-table {
    font-size: 12px;
  }

  .statistics-table th,
  .statistics-table td {
    padding: 10px 6px;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
(function() {
  const app = document.getElementById('recruitDailyApp');
  if (!app) {
    return;
  }

  const dateSelector = document.getElementById('dateSelector');
  const recruiterSelector = document.getElementById('recruiterSelector');
  const summaryTitle = document.getElementById('summaryTitle');
  const summaryTable = document.getElementById('recruitSummaryTable');
  const summaryCells = summaryTable.querySelectorAll('[data-range][data-metric]');
  const summaryError = document.getElementById('summaryError');
  const dateLabel = document.getElementById('dailyDateLabel');
  const prevDateLink = document.getElementById('prevDateLink');
  const nextDateLink = document.getElementById('nextDateLink');

  const operatorsApi = '{{ url_for('users_api.get_operators') }}';
  const dailyApi = '{{ url_for('recruit_reports_api.get_recruit_daily_report') }}';
  const detailPageUrl = '{{ url_for('report.recruit_report_detail') }}';
  const reportPageUrl = '{{ url_for('report.recruit_daily_report') }}';
  const trendChartSection = document.getElementById('trendChartSection');
  const trendChartCanvas = document.getElementById('recruitTrendChart');

  let currentDate = app.dataset.reportDate;
  let currentRecruiter = app.dataset.selectedRecruiter || 'all';
  let trendChartInstance = null;

  const trendMetricConfigs = {
    appointments: { label: 'çº¦é¢ï¼ˆç´¯è®¡ï¼‰', color: '#2563eb' },
    interviews: { label: 'åˆ°é¢ï¼ˆç´¯è®¡ï¼‰', color: '#0ea5e9' },
    trials: { label: 'è¯•æ’­ï¼ˆç´¯è®¡ï¼‰', color: '#f97316' },
    new_recruits: { label: 'æ–°å¼€æ’­ï¼ˆç´¯è®¡ï¼‰', color: '#16a34a' },
  };

  function resetSummaryPlaceholders() {
    summaryCells.forEach(cell => {
      const countEl = cell.querySelector('.stat-count');
      if (countEl) {
        countEl.textContent = '--';
      }
      const range = cell.dataset.range;
      if (range === 'report_day') {
        const trendEl = cell.querySelector('.report-day-trend');
        if (trendEl) {
          trendEl.className = 'trend-indicator report-day-trend';
          trendEl.textContent = '';
        }
      }
      const averageEl = cell.querySelector('.average');
      if (averageEl) {
        if (range === 'last_7_days') {
          averageEl.innerHTML = '7æ—¥å‡: -- <span class="trend-indicator"></span>';
        } else if (range === 'last_14_days') {
          averageEl.textContent = '14æ—¥å‡: --';
        }
      }
    });
  }

  function showLoading() {
    summaryTitle.textContent = 'æ‹›å‹Ÿç»Ÿè®¡åŠ è½½ä¸­â€¦';
    summaryError.style.display = 'none';
    resetSummaryPlaceholders();
    destroyTrendChart();
    if (trendChartSection) {
      trendChartSection.style.display = 'none';
    }
  }

  function showError(message) {
    summaryTitle.textContent = 'æ‹›å‹Ÿç»Ÿè®¡åŠ è½½å¤±è´¥';
    summaryError.style.display = 'block';
    summaryError.querySelector('p').textContent = message;
    destroyTrendChart();
    if (trendChartSection) {
      trendChartSection.style.display = 'none';
    }
  }

  function updatePaginationLinks(pagination) {
    if (!pagination) {
      return;
    }
    const baseUrl = new URL(reportPageUrl, window.location.origin);
    if (currentRecruiter && currentRecruiter !== 'all') {
      baseUrl.searchParams.set('recruiter', currentRecruiter);
    } else {
      baseUrl.searchParams.set('recruiter', 'all');
    }

    if (pagination.prev_date && prevDateLink) {
      const prevUrl = new URL(baseUrl.toString());
      prevUrl.searchParams.set('date', pagination.prev_date);
      prevDateLink.href = prevUrl.toString();
    }

    if (pagination.next_date && nextDateLink) {
      const nextUrl = new URL(baseUrl.toString());
      nextUrl.searchParams.set('date', pagination.next_date);
      nextDateLink.href = nextUrl.toString();
    }
  }

  function formatAverage(value) {
    if (value === undefined || value === null) {
      return '--';
    }
    const num = Number(value);
    if (Number.isNaN(num)) {
      return '--';
    }
    return num.toString();
  }

  function formatTrendDateLabel(dateStr) {
    if (!dateStr) {
      return '';
    }
    const parts = dateStr.split('-');
    if (parts.length !== 3) {
      return dateStr;
    }
    return `${parts[1]}-${parts[2]}`;
  }

  function destroyTrendChart() {
    if (trendChartInstance) {
      trendChartInstance.destroy();
      trendChartInstance = null;
    }
  }

  function updateTrendChart(series) {
    if (!trendChartCanvas || typeof Chart === 'undefined') {
      return;
    }
    if (!Array.isArray(series) || !series.length) {
      destroyTrendChart();
      if (trendChartSection) {
        trendChartSection.style.display = 'none';
      }
      return;
    }
    const labels = series.map(item => formatTrendDateLabel(item.date));
    const datasets = Object.entries(trendMetricConfigs).map(([key, config]) => ({
      label: config.label,
      data: series.map(item => Number(item[key] || 0)),
      borderColor: config.color,
      backgroundColor: config.color,
      borderWidth: 2,
      pointRadius: 3,
      tension: 0.25,
      fill: false,
    }));
    destroyTrendChart();
    if (trendChartSection) {
      trendChartSection.style.display = 'block';
    }
    const ctx = trendChartCanvas.getContext('2d');
    trendChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label(context) {
                const value = context.parsed.y ?? context.parsed;
                const dsLabel = context.dataset && context.dataset.label ? context.dataset.label : '';
                return `${dsLabel}: ${value}`;
              }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
          },
          y: {
            beginAtZero: true,
            ticks: { precision: 0 },
            grid: { color: 'rgba(0,0,0,0.08)' },
          },
        },
      }
    });
  }

  function updateSummary(summary, averages) {
    summaryTitle.textContent = `${currentDate} æ‹›å‹Ÿç»Ÿè®¡`;
    summaryError.style.display = 'none';
    summaryCells.forEach(cell => {
      const range = cell.dataset.range;
      const metric = cell.dataset.metric;
      const countEl = cell.querySelector('.stat-count');
      const averageEl = cell.querySelector('.average');
      const rangeData = summary && summary[range] ? summary[range] : null;
      const averageData = averages && averages[range] ? averages[range] : null;
      const countValue = rangeData && rangeData[metric] !== undefined ? rangeData[metric] : 0;
      if (countEl) {
        countEl.textContent = countValue;
      }
      
      if (range === 'report_day') {
        const trendEl = cell.querySelector('.report-day-trend');
        if (trendEl) {
          const reportDayValue = summary && summary.report_day && summary.report_day[metric] !== undefined ? summary.report_day[metric] : null;
          const avg7 = averages && averages.last_7_days && averages.last_7_days[metric] !== undefined ? averages.last_7_days[metric] : null;
          updateReportDayTrend(trendEl, reportDayValue, avg7);
        }
      }
      
      if (averageEl) {
        const averageValue = averageData && averageData[metric] !== undefined ? averageData[metric] : null;
        if (range === 'last_7_days') {
          const avg7 = averages && averages.last_7_days && averages.last_7_days[metric] !== undefined ? averages.last_7_days[metric] : null;
          const avg14 = averages && averages.last_14_days && averages.last_14_days[metric] !== undefined ? averages.last_14_days[metric] : null;
          const trendIndicator = getTrendIndicator(avg7, avg14);
          averageEl.innerHTML = `7æ—¥å‡: ${formatAverage(averageValue)} ${trendIndicator}`;
        } else if (range === 'last_14_days') {
          averageEl.textContent = `14æ—¥å‡: ${formatAverage(averageValue)}`;
        }
      }
    });
  }

  function updateReportDayTrend(trendEl, reportDayValue, avg7) {
    if (reportDayValue === null || avg7 === null || reportDayValue === undefined || avg7 === undefined) {
      trendEl.className = 'trend-indicator report-day-trend';
      trendEl.textContent = '';
      return;
    }
    const valDay = Number(reportDayValue);
    const val7 = Number(avg7);
    if (Number.isNaN(valDay) || Number.isNaN(val7)) {
      trendEl.className = 'trend-indicator report-day-trend';
      trendEl.textContent = '';
      return;
    }
    if (valDay > val7) {
      trendEl.className = 'trend-indicator report-day-trend up';
      trendEl.textContent = 'â†‘';
    } else {
      trendEl.className = 'trend-indicator report-day-trend down';
      trendEl.textContent = 'â†“';
    }
  }

  function getTrendIndicator(avg7, avg14) {
    if (avg7 === null || avg14 === null || avg7 === undefined || avg14 === undefined) {
      return '<span class="trend-indicator"></span>';
    }
    const val7 = Number(avg7);
    const val14 = Number(avg14);
    if (Number.isNaN(val7) || Number.isNaN(val14)) {
      return '<span class="trend-indicator"></span>';
    }
    if (val7 > val14) {
      return '<span class="trend-indicator up">â†‘</span>';
    } else {
      return '<span class="trend-indicator down">â†“</span>';
    }
  }

  function buildSummaryParams() {
    const params = new URLSearchParams();
    params.set('view', 'summary');
    if (currentDate) {
      params.set('date', currentDate);
    }
    if (currentRecruiter && currentRecruiter !== 'all') {
      params.set('recruiter', currentRecruiter);
    }
    return params;
  }

  async function loadDailySummary() {
    showLoading();
    try {
      const response = await fetch(`${dailyApi}?${buildSummaryParams().toString()}`);
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error ? payload.error.message : 'åŠ è½½å¤±è´¥');
      }
      const data = payload.data || {};

      currentDate = data.date || currentDate;
      dateSelector.value = currentDate;
      dateLabel.textContent = currentDate;
      recruiterSelector.value = currentRecruiter;
      updatePaginationLinks(data.pagination);
      updateSummary(data.summary, data.averages);
      updateTrendChart(data.daily_series || []);
    } catch (error) {
      console.error('åŠ è½½æ‹›å‹Ÿæ—¥æŠ¥æ±‡æ€»å¤±è´¥ï¼š', error);
      showError('æŠ¥è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
  }

  async function loadRecruiterOptions() {
    try {
      const response = await fetch(operatorsApi);
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error ? payload.error.message : 'åŠ è½½å¤±è´¥');
      }
      const options = payload.data || [];
      recruiterSelector.innerHTML = '';
      const allOption = document.createElement('option');
      allOption.value = 'all';
      allOption.textContent = 'å…¨éƒ¨';
      recruiterSelector.appendChild(allOption);
      options.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.nickname || user.username || user.id;
        recruiterSelector.appendChild(option);
      });
      recruiterSelector.value = currentRecruiter;
    } catch (error) {
      console.error('åŠ è½½æ‹›å‹Ÿè´Ÿè´£äººåˆ—è¡¨å¤±è´¥ï¼š', error);
      recruiterSelector.value = currentRecruiter;
    }
  }

  function navigate(params) {
    const url = new URL(reportPageUrl, window.location.origin);
    const targetDate = params.date || currentDate;
    const targetRecruiter = params.recruiter !== undefined ? params.recruiter : currentRecruiter;
    if (targetDate) {
      url.searchParams.set('date', targetDate);
    }
    url.searchParams.set('recruiter', targetRecruiter || 'all');
    window.location.href = url.toString();
  }

  function goToDetail(range, metric) {
    const url = new URL(detailPageUrl, window.location.origin);
    if (currentDate) {
      url.searchParams.set('date', currentDate);
    }
    url.searchParams.set('range', range);
    url.searchParams.set('metric', metric);
    url.searchParams.set('recruiter', currentRecruiter || 'all');
    window.location.href = url.toString();
  }

  dateSelector.addEventListener('change', function() {
    if (this.value) {
      navigate({ date: this.value });
    }
  });

  recruiterSelector.addEventListener('change', function() {
    navigate({ recruiter: this.value || 'all' });
  });

  summaryCells.forEach(cell => {
    cell.addEventListener('click', function() {
      const range = this.dataset.range;
      const metric = this.dataset.metric;
      if (!range || !metric) {
        return;
      }
      goToDetail(range, metric);
    });
  });

  (async function init() {
    await loadRecruiterOptions();
    await loadDailySummary();
  })();
})();
</script>
{% endblock %}
