# 主播-开播日报（新日报）

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；参战形式→开播方式；战斗区域→开播地点；阶级→主播分类；所属→直属运营；Z坐标→坐席；作战计划→通告；作战记录→开播记录；作战日报→开播日报。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。

本设计文档定义"开播新日报"的业务规则、计算口径、接口与页面交互。新日报是重构后的日报系统，采用快速计算架构，提供高性能的数据分析能力。

## 重要约定

- 所有数据库时间字段均为UTC存储，界面显示与日期分组一律按GMT+8处理。
- 日视图的“报表日”= 用户选择的本地日期（GMT+8）；未选择时取当前本地日期。
- 记录归属日期口径：按“开播记录的开始时间”换算为GMT+8后的自然日。
- 明细表排序：按“流水金额”逆序；金额相同时按“开始时间”逆序。

## 视图与导航

- 默认进入"日视图"。支持前一日、后一日翻页。
- 预留"月视图"入口（显示为不可用或"即将推出"）。
- 参考《主播-通告日历》的移动端交互，明细表支持左右滑动（横向滚动）。

## 筛选功能

### 直属运营筛选器
- 位置：日期选择器下方，增加直属运营选择器
- 默认值：全部（显示所有直属运营的数据）
- 选项：全部 + 所有有效的直属运营用户列表
- 筛选逻辑：
  - "全部"：与当前报表计算结果完全相同，不做任何筛选
  - 选择具体运营：在现有日期筛选的前提下，进一步筛选所有直属运营为被选择运营的开播记录
  - 直属运营判断规则：开播记录中如果带有直属运营快照的以快照为准，如果没有快照的以开播记录对应的主播的当前直属运营为准

### 开播方式筛选器（新增）
- 位置：与直属运营筛选器同一行，位于其右侧
- 默认值：全部（显示线上+线下的所有数据）
- 选项：全部、线上、线下
- 筛选逻辑：
  - "全部"：与当前报表计算结果完全相同，不做任何筛选；
  - 选择"线上"或"线下"：在日期与直属运营筛选条件基础上，进一步仅纳入开播记录中 `work_mode` 为对应方式的记录；
  - 计算口径完全不变，仅改变参与计算的开播记录集合。

## 数据层次与口径

新日报由两层数据构成：

### 1）日报汇总（仅报表日）
- 总主播数量：报表日内存在至少一条开播记录的主播去重数。
- 总有效主播数量：报表日内累计"播时总和 ≥ 6小时"的主播去重数。
- 累计流水：报表日内开播记录"流水金额"的合计。
- 累计底薪支出：报表日内开播记录"底薪金额"的合计。
- 累计主播分成：报表日内所有开播记录按当日主播分成比例计算的主播分成金额合计。
- 累计公司分成：报表日内所有开播记录按当日公司分成比例计算的公司分成金额合计。

日期判断同"重要约定"的记录归属日期口径。

### 2）日报明细（不聚合，逐条记录）
每条明细对应一条开播记录，展示字段（按新日报字段顺序）：
- 主播：`昵称（真实姓名）`
- 状态：该条开播记录的状态
- 播时：按结束-开始计算，单位小时，保留1位小数
- 流水：记录中的流水金额
- 当日毛利：公司分成 - 底薪
- 3日平均流水：该主播最近3个"有开播记录的自然日"的总流水/3；若最近7日内开播不足3天则为空
- 底薪：开播记录中记录的底薪金额
- 主播分类：主播的分类等级
- 当前分成比例：从分成管理中按报表日取得的主播分成比例（显示百分比，如20%）
- 性别年龄：`年龄-性别icon`（性别icon：男♂/女♀/?）
- 直属运营：（若有快照显示快照，没有快照降级显示计时当前直属运营）
- 开播地点：`开播方式@X-Y-Z`，不论开播方式为线上/线下，X/Y/Z都按开播记录中实际存储的快照显示
- 主播分成：该开播记录的流水金额 × 当日的主播分成比例
- 公司分成：该开播记录的流水金额 × 当日的公司分成比例

**重要说明**：新日报不再包含返点计算，毛利计算简化为：当日毛利 = 公司分成 - 底薪

明细排序：支持前端排序功能，可按任意字段排序，默认按"当日毛利"升序（亏钱多的排在前面）。

## 指标定义与计算细则

### 时间口径
- 自然日：以GMT+8为界的 00:00:00 ~ 23:59:59。
- 播时计算：`max(结束, 开始) 且 结束 ≥ 开始`；单位小时，建议按秒差/3600并四舍五入到1位小数。
- 月范围：报表日所在自然月的1号00:00:00 至 报表日23:59:59（均按GMT+8）。

### 3日平均流水
步骤：
1. 以报表日为基准，向前滚动自然日；
2. 找到该主播最近的3个“至少有一条开播记录”的自然日 D1、D2、D3（均按开始时间换算到本地日归属）；
3. 若在滚动7个自然日内未能凑齐3天，则结果为空；
4. 否则，`(sum(流水 at D1) + sum(流水 at D2) + sum(流水 at D3)) / 3`。

### 有效主播
- 当日有效主播：报表日内该主播的"播时总和 ≥ 6小时"。
- 月度有效主播：月范围内该主播"播时总和 ≥ 6小时"。

### 分成计算规则
分成计算基于主播分成管理模块的调整记录，按以下规则执行：

- 从 主播-分成管理模块 获取，不要重写逻辑
- 参考 docs/主播-分成管理.md 文档

**重要说明**：新日报不再包含返点计算，返点功能仅用于月报计算。

## 数据来源与模型映射

- 基础表：`开播记录（BattleRecord）`，字段参考《主播-开播记录》设计文档：
  - 主播（主播ID）
  - 开始时间、结束时间（UTC时间戳）
  - 流水金额、底薪金额
  - 开播方式、X/Y/坐席快照、直属运营快照

- 辅助表：`pilots`（性别、出生年、主播分类、昵称/真实姓名、直属运营等）

- 分成管理表：`主播分成调整记录`，字段参考《主播-分成管理》设计文档：
  - 主播ID
  - 调整日（UTC时间戳）
  - 调整值（0-50，表示0%-50%）
  - 是否有效（软删除标记）

## 缓存机制

开播日报的计算结果采用内存缓存机制：

- **缓存时间**：15分钟（900秒）
- **缓存范围**：月度数据（`_calculate_month_summary`）、日报汇总（`_calculate_day_summary`）和日报明细（`_calculate_daily_details`）
- **缓存键**：基于函数名和参数生成MD5哈希值
- **缓存失效**：15分钟后自动过期，或服务重启时清空
- **实现方式**：使用`cachetools`库的`TTLCache`实现
- **性能提升**：相同条件下15分钟内不会重新计算，显著提升页面响应速度

### 手动刷新策略
- 页面标题`📒 开播日报`支持隐藏手势：连续点击9次会将标题文案临时替换为`📒 开播日`，提示进入刷新准备态
- 再次连续点击9次触发缓存刷新请求，标题恢复为原文案
- 刷新成功后前端自动重新加载当前页面，保证用户立即获得重新计算后的数据

### 缓存刷新接口
- `POST /api/reports/daily/cache/refresh`
  - 认证：JWT（`@jwt_required()`）+ 角色权限`gicho`/`kancho`
  - CSRF：当前REST API采用纯JWT方案，无需额外CSRF头校验
  - 请求体：无
  - 响应：统一成功/失败响应格式；成功时`data.message`提示缓存已清空
  - 行为：强制清空所有开播日报缓存条目（含日报汇总、日报明细、月度汇总），并写入INFO日志

## 接口设计（后端）

建议新增以下只读接口，返回JSON供模板渲染：

- GET `/api/reports/daily?date=YYYY-MM-DD&owner=<owner_id>&mode=<all|online|offline>`
  - 入参：
    - `date`（可选），本地日期（GMT+8）；不传则取今日
    - `owner`（可选），直属运营用户ID；不传或传"all"则显示全部
    - `mode`（可选），开播方式；取值`all`（默认）、`online`、`offline`
  - 出参：
    - `date`: 查询日期
    - `summary`: { `pilot_count`, `effective_pilot_count`, `revenue_sum`, `basepay_sum`, `pilot_share_sum`, `company_share_sum`, `conversion_rate` }
    - `details`: 数组，包含上述"日报明细"字段
    - `pagination`: { `date`, `prev_date`, `next_date` }
    - `meta.filters`: { `owner`, `mode` } 筛选参数

- GET `/api/reports/daily/export.csv?date=YYYY-MM-DD&owner=<owner_id>&mode=<all|online|offline>`
  - 入参：同上，支持直属运营筛选
  - 返回CSV（UTF-8带BOM，分隔符逗号，换行CRLF），字段同明细表，用于直接被Microsoft Excel打开无乱码。

### 缓存刷新接口
- `POST /api/reports/daily/cache/refresh`
  - 认证：JWT（`@jwt_required()`）+ 角色权限`gicho`/`kancho`
  - 请求体：无
  - 响应：统一成功/失败响应格式；成功时`data.message`提示缓存已清空
  - 行为：强制清空所有开播日报缓存条目（含日报汇总、日报明细），并写入INFO日志

实现要点：
- 使用 `utils/timezone_helper.py` 做UTC↔本地的统一转换。
- 查询范围一律以"开始时间换算到本地日"的归属进行聚合与过滤，避免跨日记录被错误计入。
- 对主播信息读`pilots`，需容错（昵称或真实姓名缺失时的展示降级）。
- 分成计算需要调用主播分成管理模块的接口，根据开播记录日期获取对应的主播分成比例。
- 分成金额计算：主播分成 = 流水金额 × 主播分成比例，公司分成 = 流水金额 × 公司分成比例。
- 月累计分成需要按日期逐日计算，不能简单使用当前分成比例乘以月累计流水。
- **重要：新日报不再包含返点计算**，毛利计算简化为：当日毛利 = 公司分成 - 底薪。
- 运营利润估算：累计公司分成 - 累计底薪支出。
- 直属运营筛选：当传入owner参数时，需要按照直属运营判断规则过滤开播记录，优先使用开播记录中的直属运营快照，如无快照则使用主播当前的直属运营。
  - 特殊规则：当按直属运营筛选时，以筛选日期范围内"每位主播最后一次开播记录"的运营为准；若该记录的运营等于筛选的owner，则纳入该主播在本范围内的所有记录，否则不纳入，避免同一主播同时计入多个运营。
- 开播方式筛选：当传入mode参数时，按 `BattleRecord.work_mode` 进行过滤；`all` 表示不过滤，`online` 表示仅线上，`offline` 表示仅线下。
  - 特殊规则：当按开播方式筛选时，以筛选日期范围内"每位主播最后一次开播记录"的开播方式为准；若该记录的方式等于筛选的mode（线上/线下），则纳入该主播在本范围内的所有记录，否则不纳入，确保同一主播不会同时计入两种开播方式。

## 模板与交互（前端）

- 新模板：`templates/new_reports/daily.html`
  - 顶部日期选择器，左右切换按钮（前一日/后一日）。
  - 日期选择器下方增加直属运营选择器与开播方式选择器，均默认为"全部"。
  - 展示"日报汇总"数据卡片。
  - 下方"日报明细"表格，支持横向滚动；表头固定，列顺序与字段对齐。
  - 表格右上角提供"导出CSV"按钮（链接到导出接口）。

### 新日报字段顺序（14个字段）
按用户需求优化后的字段顺序：
`主播 | 状态 | 播时 | 流水 | 当日毛利 | 3日平均流水 | 底薪 | 主播分类 | 当前分成比例 | 性别年龄 | 直属运营 | 开播地点 | 主播分成 | 公司分成`

### 前端排序功能
- 所有14个字段都支持前端排序
- 点击表头可在升序/降序之间切换
- 排序指示器显示当前排序状态
- 数字字段默认降序，文本字段默认升序

## 页面交互功能

### 主播业绩页跳转
- 明细表中主播列可点击，跳转到对应主播的业绩页面
- 跳转时携带来源参数 `from='daily_report'`、`date`、`owner`，确保返回时能正确回到开播日报页面并保持筛选条件
- 主播业绩页面提供返回按钮，统一显示"返回"文字

### 状态列显示规则
- 显示该条开播记录的状态
- 状态为空或未设置时显示为"已下播"（兼容老数据）
- 状态为"开播中"时使用红色字体显示

## CSV导出规范

- 编码：UTF-8 with BOM。
- 分隔符：逗号`,`；文本字段使用双引号包裹，内部双引号需转义为两个双引号。
- 数值：不使用千分位，保留两位小数的金额字段：流水、主播分成、公司分成、底薪、当日毛利；播时保留1位小数；当前分成比例显示为百分比格式（如20%）。
- 日期时间字段若输出，统一为本地时间`YYYY-MM-DD HH:MM`。
- 首行作为表头，列顺序与页面明细一致。

## 缓存机制

开播新日报的计算结果采用内存缓存机制：

- **缓存时间**：15分钟（900秒）
- **缓存范围**：日报汇总（`calculate_daily_summary`）和日报明细（`calculate_daily_details`）
- **缓存键**：基于函数名和参数生成MD5哈希值
- **缓存失效**：15分钟后自动过期，或服务重启时清空
- **实现方式**：使用`cachetools`库的`TTLCache`实现
- **性能提升**：相同条件下15分钟内不会重新计算，显著提升页面响应速度

### 手动刷新策略
- 页面标题`📒 开播新日报`支持隐藏手势：连续点击9次会将标题文案临时替换为`📒 开播日`，提示进入刷新准备态
- 再次连续点击9次触发缓存刷新请求，标题恢复为原文案
- 刷新成功后前端自动重新加载当前页面，保证用户立即获得重新计算后的数据

## 性能与索引建议

- 为 `BattleRecord(pilot, start_time)` 建立复合索引，如有必要还可以建立更多索引；
- 为 `主播分成调整记录(pilot_id, adjustment_date, is_valid)` 建立复合索引，优化分成比例查询性能；
- 常用聚合可按"归属本地日"进行分组聚合；
- 分成计算涉及多表关联，建议在应用层缓存主播分成比例，避免重复查询；
- 毛利计算涉及多个字段的实时计算，建议在应用层缓存计算结果，避免重复计算；

## 权限与审计

- 权限沿用既有：管理员、运营可访问。

## 技术架构说明

新日报采用全新的技术架构：

### 计算架构
- **RESTful API设计**：前后端分离，提供JSON格式数据接口
- **高性能计算**：单次数据库查询 + 批量处理，显著提升计算效率
- **缓存机制**：15分钟TTL缓存，避免重复计算

### 文件结构
- **模板文件**：`templates/new_reports/daily.html`
- **API接口**：`routes/new_reports_api.py`
- **计算逻辑**：`utils/new_report_calculations.py`
- **序列化工具**：`utils/new_report_serializers.py`

### 关键改进
- **简化计算**：移除返点计算，毛利计算简化为公司分成 - 底薪
- **前端排序**：支持所有字段的前端排序功能
- **字段优化**：按用户需求重新排列字段顺序
- **性能提升**：采用批量查询和预取机制

## 更新记录

- 2025-10-28: 文档更新，移除返点计算逻辑，更新为新日报架构和字段顺序
- 2025-09-26: 术语统一，完成逐段术语检查
