{% extends 'base.html' %}
{% block title %}编辑用户 - Lacus-Log{% endblock %}
{% block content %}
<section>
  <h1 class="title">编辑用户</h1>
  <div id="editUserContent">
    <div class="loading-state" id="loadingState">
      <div class="loading-spinner">⏳</div>
      <div class="loading-text">加载中...</div>
    </div>
  </div>
</section>

<script>
// 显示消息 - 使用全局消息提示系统
function showMessage(message, type = 'info', duration = 5000) {
  if (window.showMessage) {
    window.showMessage(message, type, duration);
  } else {
    // 降级到console输出
    console.log(`[${type.toUpperCase()}] ${message}`);
  }
}

// 加载用户信息
async function loadUserInfo() {
  // 从URL中提取用户ID: /admin/users/{userId}/edit
  const pathParts = window.location.pathname.split('/');
  const userId = pathParts[pathParts.length - 2]; // 倒数第二个部分
  console.log('Edit page - URL:', window.location.pathname, 'UserID:', userId);
  const loadingState = document.getElementById('loadingState');
  const content = document.getElementById('editUserContent');
  
  try {
    if (loadingState) {
      loadingState.style.display = 'block';
    }
    
    const response = await fetch(`/api/users/${userId}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });
    
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || '加载用户信息失败');
    }
    
    renderEditForm(result.data);
    
  } catch (error) {
    console.error('加载用户信息失败:', error);
    content.innerHTML = `
      <div class="error-state">
        <div class="error-icon">❌</div>
        <div class="error-title">加载失败</div>
        <div class="error-description">${error.message}</div>
        <button class="btn btn-primary" onclick="loadUserInfo()">重试</button>
      </div>
    `;
  } finally {
    if (loadingState) {
      loadingState.style.display = 'none';
    }
  }
}

// 渲染编辑表单
function renderEditForm(user) {
  const content = document.getElementById('editUserContent');
  
  if (!content) {
    console.error('找不到editUserContent元素');
    return;
  }
  
  content.innerHTML = `
    <form class="form" id="editUserForm">
      <input type="hidden" id="userId" value="${user.id}" />

      <label>用户名</label>
      <input class="input" type="text" value="${user.username}" disabled />

      <label>昵称</label>
      <input class="input" type="text" name="nickname" id="nickname" value="${user.nickname || ''}" />

      <label>邮箱（可选）</label>
      <input class="input" type="email" name="email" id="email" value="${user.email || ''}" placeholder="name@example.com" />

      <div class="form-actions">
        <button class="btn btn-primary" type="submit" id="submitBtn">保存</button>
        <a class="btn btn-secondary" href="/admin/users/${user.id}">取消</a>
      </div>
    </form>
  `;
  
  // 绑定表单提交事件
  bindFormSubmit(user.id);
}

// 绑定表单提交事件
function bindFormSubmit(userId) {
  const form = document.getElementById('editUserForm');
  const submitBtn = document.getElementById('submitBtn');
  
  if (!form || !submitBtn) {
    console.error('找不到表单元素');
    return;
  }
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // 禁用提交按钮
    submitBtn.disabled = true;
    submitBtn.textContent = '保存中...';
    
    try {
      // 收集表单数据
      const nicknameEl = document.getElementById('nickname');
      const emailEl = document.getElementById('email');
      
      if (!nicknameEl || !emailEl) {
        throw new Error('找不到表单字段');
      }
      
      const formData = {
        nickname: nicknameEl.value.trim(),
        email: emailEl.value.trim()
      };
      
      // 更新用户信息
      await updateUser(userId, formData);
      
    } catch (error) {
      showMessage(error.message, 'error');
    } finally {
      // 恢复提交按钮
      submitBtn.disabled = false;
      submitBtn.textContent = '保存';
    }
  });
}

// 更新用户信息
async function updateUser(userId, formData) {
  try {
    const response = await fetch(`/api/users/${userId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify(formData)
    });
    
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || '更新用户信息失败');
    }
    
    // 跳转到用户详情页，并传递成功消息
    window.location.href = `/admin/users/${userId}?success=updated`;
    
  } catch (error) {
    console.error('更新用户信息失败:', error);
    showMessage(error.message, 'error');
  }
}

// 初始化页面
document.addEventListener('DOMContentLoaded', function() {
  // 加载用户信息
  loadUserInfo();
});
</script>
{% endblock %}


