{% extends 'base.html' %}
{% block title %}ç”¨æˆ·ç®¡ç† - Lacus-Log{% endblock %}
{% block content %}
<section class="user-management">
  <div class="page-header">
    <h1 class="page-title">ç”¨æˆ·ç®¡ç†</h1>
  </div>

  <div class="filter-bar">
    <form class="filter-form" id="filterForm">
      <div class="filter-group">
        <label class="filter-label">è§’è‰²ç­›é€‰</label>
        <select class="filter-select" name="role" id="roleFilter">
          <option value="">å…¨éƒ¨ç”¨æˆ·</option>
          <option value="gicho">ç®¡ç†å‘˜</option>
          <option value="kancho">è¿è¥</option>
          <option value="gunsou">åŠ©ç†è¿è¥</option>
        </select>
      </div>
    </form>
  </div>

  <div class="user-list" id="userList">
    <div class="loading-state" id="loadingState">
      <div class="loading-spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­...</div>
    </div>
  </div>
</section>

<script>
// å…¨å±€å˜é‡
let currentPage = 1;
let currentRole = '';
let isLoading = false;

// è·å–ç”¨æˆ·åˆ—è¡¨
async function loadUsers(page = 1, role = '') {
  if (isLoading) return;
  
  isLoading = true;
  const loadingState = document.getElementById('loadingState');
  const userList = document.getElementById('userList');
  
  try {
    if (loadingState) {
      loadingState.style.display = 'block';
    }
    
    const params = new URLSearchParams({
      page: page.toString(),
      per_page: '20'
    });
    
    if (role) {
      params.append('role', role);
    }
    
    const response = await fetch(`/api/users?${params}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });
    
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || 'åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
    }
    
    renderUserList(result.data, result.meta);
    currentPage = page;
    currentRole = role;
    
  } catch (error) {
    console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
    logFrontendError('api', `åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${error.message}`, error.stack, window.location.href, navigator.userAgent);
    userList.innerHTML = `
      <div class="error-state">
        <div class="error-icon">âŒ</div>
        <div class="error-title">åŠ è½½å¤±è´¥</div>
        <div class="error-description">${error.message}</div>
        <button class="btn btn-primary" onclick="loadUsers()">é‡è¯•</button>
      </div>
    `;
  } finally {
    if (loadingState) {
      loadingState.style.display = 'none';
    }
    isLoading = false;
  }
}

// æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
function renderUserList(users, meta) {
  const userList = document.getElementById('userList');
  
  if (!userList) {
    console.error('æ‰¾ä¸åˆ°userListå…ƒç´ ');
    logFrontendError('dom', 'æ‰¾ä¸åˆ°userListå…ƒç´ ', '', window.location.href, navigator.userAgent);
    return;
  }
  
  if (!users || users.length === 0) {
    userList.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ‘¥</div>
        <div class="empty-title">æš‚æ— ç”¨æˆ·</div>
        <div class="empty-description">ç‚¹å‡»ä¸Šæ–¹"æ–°å¢è¿è¥"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªç”¨æˆ·</div>
      </div>
    `;
    return;
  }
  
  const userCards = users.map(user => `
    <a href="/admin/users/${user.id}" class="user-card">
      <div class="card-header">
        <div class="user-info">
          <div class="user-name">${user.username}</div>
          <div class="user-nickname">${user.nickname || 'æœªè®¾ç½®æ˜µç§°'}</div>
        </div>
        <div class="user-badges">
          <span class="role-badge role-${user.roles[0] || 'unknown'}">
            ${getRoleDisplayName(user.roles[0] || 'unknown')}
          </span>
          <span class="status-badge status-${user.active ? 'active' : 'inactive'}">
            ${user.active ? 'å¯ç”¨' : 'åœç”¨'}
          </span>
        </div>
      </div>
      <div class="card-footer">
        <div class="card-arrow">â†’</div>
      </div>
    </a>
  `).join('');
  
  userList.innerHTML = `
    <div class="user-cards">
      ${userCards}
    </div>
  `;
}

// è·å–è§’è‰²æ˜¾ç¤ºåç§°
function getRoleDisplayName(roleName) {
  const roleMapping = {
    'gicho': 'ç®¡ç†å‘˜',
    'kancho': 'è¿è¥',
    'gunsou': 'åŠ©ç†è¿è¥'
  };
  return roleMapping[roleName] || roleName;
}

// åˆ‡æ¢ç”¨æˆ·æ¿€æ´»çŠ¶æ€
async function toggleUserActivation(userId, currentActive) {
  try {
    const response = await fetch(`/api/users/${userId}/activation`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body: JSON.stringify({ active: !currentActive })
    });
    
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || 'æ“ä½œå¤±è´¥');
    }
    
    // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
    loadUsers(currentPage, currentRole);
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    showMessage(result.data.active ? 'ç”¨æˆ·å·²å¯ç”¨' : 'ç”¨æˆ·å·²åœç”¨', 'success');
    
  } catch (error) {
    console.error('åˆ‡æ¢ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
    logFrontendError('api', `åˆ‡æ¢ç”¨æˆ·çŠ¶æ€å¤±è´¥: ${error.message}`, error.stack, window.location.href, navigator.userAgent);
    showMessage(error.message, 'error');
  }
}

// é‡ç½®ç”¨æˆ·å¯†ç 
async function resetUserPassword(userId) {
  if (!confirm('ç¡®å®šé‡ç½®å¯†ç ä¸º 123456ï¼Ÿ')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/users/${userId}/reset-password`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });
    
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || 'æ“ä½œå¤±è´¥');
    }
    
    showMessage(result.data.message, 'success');
    
  } catch (error) {
    console.error('é‡ç½®å¯†ç å¤±è´¥:', error);
    logFrontendError('api', `é‡ç½®å¯†ç å¤±è´¥: ${error.message}`, error.stack, window.location.href, navigator.userAgent);
    showMessage(error.message, 'error');
  }
}

// æ˜¾ç¤ºæ¶ˆæ¯ - ä½¿ç”¨å…¨å±€æ¶ˆæ¯æç¤ºç³»ç»Ÿ
function showMessage(message, type = 'info', duration = 5000) {
  if (window.showMessage) {
    window.showMessage(message, type, duration);
  } else {
    // é™çº§åˆ°consoleè¾“å‡º
    console.log(`[${type.toUpperCase()}] ${message}`);
  }
}

// åˆå§‹åŒ–é¡µé¢
document.addEventListener('DOMContentLoaded', function() {
  // æ£€æŸ¥URLå‚æ•°ä¸­çš„æˆåŠŸæ¶ˆæ¯
  const urlParams = new URLSearchParams(window.location.search);
  const success = urlParams.get('success');
  if (success === 'created') {
    showMessage('åˆ›å»ºè¿è¥æˆåŠŸ', 'success');
    // æ¸…ç†URLå‚æ•°
    window.history.replaceState({}, document.title, window.location.pathname);
  }
  
  // ç»‘å®šç­›é€‰å™¨äº‹ä»¶
  const roleFilter = document.getElementById('roleFilter');
  if (roleFilter) {
    roleFilter.addEventListener('change', function() {
      loadUsers(1, this.value);
    });
  }
  
  // åŠ è½½åˆå§‹æ•°æ®
  loadUsers();
});
</script>

<div class="footbar">
  <div class="inner">
    <a class="btn btn-primary" href="{{ url_for('admin.users_new') }}">
      <span class="btn-icon">+</span>
      æ–°å¢è¿è¥
    </a>
  </div>
</div>

<style>
.footbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid var(--table-header);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
  padding: 10px 12px calc(env(safe-area-inset-bottom, 0) + 10px) 12px;
  z-index: 1;
}

.footbar .inner {
  display: flex;
  justify-content: center;
  gap: 12px;
}
</style>
{% endblock %}
