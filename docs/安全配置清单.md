# 安全配置清单

> 本文档记录系统所有安全相关配置，确保生产环境部署安全合规

## 当前安全状态

### ✅ 已实施的安全措施

#### 1. 认证安全
- ✅ **密码哈希**：使用 `pbkdf2_sha512` 强哈希算法（Flask-Security-Too）
- ✅ **Session超时**：默认10小时（36000秒），可通过环境变量 `PERMANENT_SESSION_LIFETIME` 调整
- ✅ **双重认证支持**：
  - **Flask-Security-Too Session认证**：用于传统Web页面浏览
  - **JWT Token认证**：用于REST API调用（`routes/auth_api.py`）
- ✅ **登录追踪**：自动记录登录时间、IP地址、登录次数（last_login_at、current_login_at、login_count）
- ✅ **禁止自注册**：`SECURITY_REGISTERABLE=False`，只能由管理员创建用户
- ✅ **禁用邮件找回**：`SECURITY_RECOVERABLE=False`，防止邮件找回密码漏洞
- ✅ **允许修改密码**：`SECURITY_CHANGEABLE=True`，用户登录后可自行修改密码

#### 2. CSRF保护
- ✅ **WTF-CSRF**：全局启用 Flask-WTF CSRF保护
- ✅ **统一CSRF校验**：所有REST API使用 `utils/csrf_helper.py` 统一校验
- ✅ **Double-submit Cookie + Custom Header**：REST API使用 `X-CSRFToken` 请求头

#### 3. Cookie安全
**Session Cookie 配置**：
- ✅ **SESSION_COOKIE_HTTPONLY**：`True`，防止JavaScript访问Session Cookie（防XSS）
- ✅ **SESSION_COOKIE_SAMESITE**：`Lax`，防止CSRF攻击
- ✅ **SESSION_COOKIE_SECURE**：根据环境自动切换
  - 生产环境（`FLASK_ENV=production`）：`True`，强制HTTPS
  - 开发环境：`False`，便于本地测试

**JWT Cookie 配置**：
- ✅ **JWT_ACCESS_COOKIE_NAME**：`access_token_cookie`
- ✅ **JWT_REFRESH_COOKIE_NAME**：`refresh_token_cookie`
- ✅ **JWT_COOKIE_CSRF_PROTECT**：`True`，启用JWT Cookie的CSRF保护
- ✅ **JWT_COOKIE_SAMESITE**：`Lax`，防止CSRF攻击
- ✅ **JWT_COOKIE_SECURE**：根据环境自动切换（`FLASK_ENV != 'development'`时启用）

#### 4. 权限控制
- ✅ **角色系统**：使用 Flask-Security-Too 的角色功能
  - `gicho`：管理员
  - `kancho`：运营
- ✅ **路由保护**：使用 `@roles_required` 和 `@roles_accepted` 装饰器
- ✅ **禁止自注册**：`SECURITY_REGISTERABLE=False`

#### 5. JWT安全
- ✅ **Token过期时间**：
  - **Access Token**：2小时（`JWT_ACCESS_TOKEN_EXPIRES = timedelta(hours=2)`）
  - **Refresh Token**：30天（`JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=30)`）
- ✅ **独立密钥**：
  - 支持独立的 `JWT_SECRET_KEY` 环境变量
  - 未设置时回退使用 `SECRET_KEY`
  - 建议生产环境使用独立密钥
- ✅ **Token位置**：`JWT_TOKEN_LOCATION = ['headers', 'cookies']`
  - 支持 `Authorization: Bearer <token>` 请求头
  - 支持存储在 Cookie 中（自动附带）
- ✅ **与Flask-Security-Too集成**：
  - 使用 `fs_uniquifier` 作为JWT identity
  - 自动加载用户对象（`@jwt.user_lookup_loader`）
  - 完全兼容现有权限系统

#### 6. 其他安全措施
- ✅ **MongoDB连接**：支持认证（通过 `MONGODB_URI` 环境变量）
- ✅ **错误处理**：统一的错误处理，不泄露敏感信息
- ✅ **日志记录**：记录登录失败、CSRF失败等安全事件

---

## ⚠️ 需要在生产环境注意的事项

### 1. 必须设置的环境变量

```bash
# ==================== 核心安全配置 ====================
# 应用密钥（必须设置为强随机字符串！至少32字符）
SECRET_KEY=<your-strong-random-secret-key>

# JWT密钥（推荐单独设置，不设置则使用 SECRET_KEY）
JWT_SECRET_KEY=<your-jwt-secret-key>

# Flask-Security盐值（用于密码哈希和Remember-Me功能）
SECURITY_PASSWORD_SALT=<your-password-salt>
SECURITY_REMEMBER_SALT=<your-remember-salt>

# ==================== 环境配置 ====================
# 环境标识（生产环境必须设置为 production）
FLASK_ENV=production

# ==================== 数据库配置 ====================
# MongoDB连接（生产环境应包含认证信息）
MONGODB_URI=mongodb://username:password@host:port/database

# 测试数据库（可选，用于集成测试）
MONGODB_URI_TEST=mongodb://username:password@host:port/test_database

# ==================== 会话配置 ====================
# Session超时时间（秒，默认36000=10小时）
PERMANENT_SESSION_LIFETIME=36000

# Remember Me功能（默认启用）
SECURITY_DEFAULT_REMEMBER_ME=True

# ==================== 应用配置 ====================
# Flask应用端口
FLASK_APP_PORT=5080

# 基础URL（用于邮件等场景）
BASE_URL=https://your-domain.com

# 允许的域名和端口（CORS配置）
ALLOWED_DOMAINS=your-domain.com
ALLOWED_PORTS=443,5080
```

### 2. 生产环境部署检查清单

#### 必须项（Critical）
- [ ] **HTTPS强制**：在反向代理（Nginx/Apache）层面强制HTTPS重定向
- [ ] **强密钥生成**：
  - [ ] `SECRET_KEY` 至少32字符的随机字符串
  - [ ] `JWT_SECRET_KEY` 独立设置，与 SECRET_KEY 不同
  - [ ] `SECURITY_PASSWORD_SALT` 强随机盐值
  - [ ] `SECURITY_REMEMBER_SALT` 强随机盐值
- [ ] **环境变量设置**：`FLASK_ENV=production`
- [ ] **MongoDB认证**：启用MongoDB用户名/密码认证
- [ ] **防火墙规则**：限制MongoDB端口（27017）仅内网访问

#### 推荐项（Recommended）
- [ ] **日志监控**：
  - [ ] 监控登录失败次数（防暴力破解）
  - [ ] 监控CSRF校验失败
  - [ ] 监控异常IP访问
- [ ] **Session存储**：使用Redis等外部存储（见下文）
- [ ] **登录限流**：使用Flask-Limiter限制登录尝试次数
- [ ] **备份策略**：定期自动备份MongoDB数据库
- [ ] **SSL证书**：使用Let's Encrypt等免费证书，设置自动续期

#### 可选项（Optional）
- [ ] **两步验证**：为管理员账号启用2FA
- [ ] **IP白名单**：限制管理后台访问IP
- [ ] **审计日志**：记录所有管理操作（创建/修改/删除）

### 3. 可选的增强措施

#### 使用Redis存储Session（推荐生产环境）

```python
# requirements.txt 添加：
# Flask-Session
# redis

# app.py 配置：
from flask_session import Session

flask_app.config.update(
    SESSION_TYPE='redis',
    SESSION_REDIS=redis.from_url(os.getenv('REDIS_URL', 'redis://localhost:6379'))
)
Session(flask_app)
```

#### 限制登录尝试次数

可以使用 Flask-Limiter 限制登录端点：

```python
# requirements.txt 添加：
# Flask-Limiter

from flask_limiter import Limiter
limiter = Limiter(flask_app, key_func=lambda: request.remote_addr)

# 在 auth_api.py 的 login 函数上添加：
@limiter.limit("5 per minute")
```

---

## 生成强密钥的方法

```python
# 在Python中生成强随机密钥
import secrets
print(secrets.token_urlsafe(32))
```

或使用命令行：
```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

---

## 安全配置对比表

| 配置项 | 开发环境 | 测试环境 | 生产环境 |
|--------|---------|---------|---------|
| **FLASK_ENV** | development | testing | production |
| **SECRET_KEY** | 默认值（不安全） | 测试密钥 | **强随机密钥（必须）** |
| **JWT_SECRET_KEY** | 可选 | 可选 | **独立密钥（推荐）** |
| **SESSION_COOKIE_SECURE** | False | False | True |
| **JWT_COOKIE_SECURE** | False | False | True |
| **HTTPS** | 非必需 | 非必需 | **必须启用** |
| **MongoDB认证** | 可选 | 独立测试库 | **必须启用** |
| **日志级别** | DEBUG | INFO | INFO/WARNING |
| **WTF_CSRF_ENABLED** | True | False（测试用） | True |
| **Session超时** | 10小时 | 10小时 | 可调整（建议更短） |

---

## 总结

### ✅ 传统Session认证是否安全？

**现在是安全的！** 经过配置：

1. ✅ HttpOnly Cookie - 防止XSS窃取Session
2. ✅ SameSite=Lax - 防止CSRF攻击
3. ✅ Secure Cookie（生产环境）- 防止中间人攻击
4. ✅ CSRF Token验证 - 额外的CSRF防护层
5. ✅ Session超时 - 限制Session有效期

### 🎯 建议

- **开发环境**：当前配置已足够安全
- **生产环境**：
  1. 必须设置强 `SECRET_KEY`
  2. 必须启用HTTPS
  3. 考虑使用Redis存储Session
  4. 考虑添加登录限流

**Session认证与JWT认证各有优势，两者并存是当前的最佳方案！**

