{% extends 'base.html' %}
{% block title %}主播详情 - Lacus-Log{% endblock %}
{% block content %}
<section class="pilot-detail" id="pilotDetail" style="display: none;">
  <div class="back-nav" id="backNav"></div>

  <div class="pilot-info-card" id="pilotInfoCard"></div>
</section>

<div id="footbarContainer"></div>

<div id="loadingState" class="loading-state">
  <div class="loading-spinner"></div>
  <div class="loading-text">加载中...</div>
</div>

<div id="changesModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>变更记录</h3>
      <button class="modal-close" onclick="hideChanges()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="changesLoading" class="loading">加载中...</div>
      <div id="changesList" style="display: none;"></div>
    </div>
  </div>
</div>

<style>

.commission-card {
  background: #fff;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid #A9A9A9;
}

.commission-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.commission-rate {
  text-align: center;
}

.rate-value {
  display: block;
  font-size: 24px;
  font-weight: 700;
  color: #8B0000;
  margin-bottom: 4px;
}

.rate-label {
  font-size: 12px;
  color: #666666;
}

.commission-calculation {
  display: flex;
  gap: 16px;
}

.calc-item {
  text-align: center;
}

.calc-value {
  display: block;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 2px;
}

.calc-item:first-child .calc-value {
  color: #00B37A;
}

.calc-item:last-child .calc-value {
  color: #3A5F3D;
}

.calc-label {
  font-size: 11px;
  color: #666666;
}

.commission-footer {
  border-top: 1px solid #A9A9A9;
  padding-top: 12px;
}

.commission-formula {
  font-size: 12px;
  color: #666666;
  margin-bottom: 4px;
  font-family: monospace;
}

.commission-date {
  font-size: 12px;
  color: #666666;
  margin-bottom: 4px;
}

.commission-remark {
  font-size: 12px;
  color: #666666;
}


@media (max-width: 768px) {
  .commission-header {
    flex-direction: column;
    gap: 12px;
  }
  
  .commission-calculation {
    justify-content: center;
  }
}


.pilot-detail {
  max-width: 800px;
  margin: 0 auto;
  padding-bottom: 100px;
}

.pilot-info-card {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  border: 1px solid var(--table-header);
}

.pilot-info-card .card-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--table-header);
}

.pilot-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--table-header);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: bold;
}

.pilot-main-info {
  flex: 1;
}

.pilot-main-info .pilot-name {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
  color: var(--text);
}

.pilot-main-info .pilot-real-name {
  color: var(--muted);
  margin-bottom: 8px;
  font-size: 14px;
}

.pilot-badges {
  display: flex;
  gap: 8px;
}

.rank-badge, .status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}


.rank-候选人 { background: var(--table-header); color: var(--muted); }
.rank-试播主播 { background: #FFF3CD; color: #856404; }
.rank-实习主播 { background: #D4EDDA; color: #155724; }
.rank-正式主播 { background: var(--brand); color: #fff; }


.status-未招募 { background: var(--table-header); color: var(--muted); }
.status-不招募 { background: #F8D7DA; color: #721C24; }
.status-已招募 { background: #FFF3CD; color: #856404; }
.status-已签约 { background: #D1ECF1; color: #0C5460; }
.status-流失 { background: #F8D7DA; color: #721C24; }

.info-section {
  margin-bottom: 24px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--brand);
  border-bottom: 1px solid var(--table-header);
  padding-bottom: 8px;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.info-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.info-value {
  font-size: 14px;
  color: var(--text);
}

.footbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid var(--table-header, #ddd);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
  padding: 10px 12px calc(env(safe-area-inset-bottom, 0) + 10px) 12px;
  z-index: 100;
}

.footbar .inner {
  display: flex;
  gap: 12px;
  justify-content: center;
  max-width: 1200px;
  margin: 0 auto;
}

.footbar .btn {
  display: flex !important;
  justify-content: center;
  align-items: center;
  text-align: center;
  line-height: 1.2;
  min-height: 56px;
  flex: 1 1 auto;
  min-width: 80px;
  max-width: 200px;
  box-sizing: border-box;
}

.btn-hud {
  background: var(--hud-green);
  color: #fff;
}
.btn-hud:hover { 
  background: #00a16e; 
}

.btn-outline {
  background: #fff;
  color: var(--text);
  border: 1px solid var(--gray);
}
.btn-outline:hover {
  background: var(--table-header);
}


.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: #fff;
  border-radius: 8px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--table-header);
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
}

.modal-close:hover {
  color: var(--text);
}

.modal-body {
  padding: 20px;
  max-height: 60vh;
  overflow-y: auto;
}

.loading {
  text-align: center;
  color: var(--muted);
  padding: 20px;
}

.change-item {
  background: var(--table-header);
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 8px;
}

.change-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 12px;
  color: var(--muted);
}

.change-content {
  font-size: 14px;
}

.change-field {
  font-weight: 600;
  color: var(--brand);
}

.change-values {
  margin-top: 4px;
}

.old-value, .new-value {
  font-family: monospace;
  background: #fff;
  padding: 2px 4px;
  border-radius: 3px;
  margin: 0 2px;
}

.old-value {
  text-decoration: line-through;
  color: var(--error);
}

.new-value {
  color: var(--hud-green);
}


@media (max-width: 768px) {
  .pilot-detail {
    padding-bottom: 100px;
  }

  .pilot-info-card .card-header {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .pilot-badges {
    justify-content: center;
  }

  .info-grid {
    grid-template-columns: 1fr;
  }

  .footbar .inner {
    flex-direction: row;
    gap: 8px;
  }
  
  .footbar .btn {
    flex: 1 1 auto;
    min-width: 60px;
    max-width: none;
    font-size: 14px;
    padding: 12px 8px;
  }

  .modal-content {
    width: 95%;
    margin: 0 10px;
  }
}
</style>

<script>
let currentPilot = null;

// 获取URL中的pilot_id
function getPilotIdFromUrl() {
  const pathParts = window.location.pathname.split('/');
  return pathParts[pathParts.length - 1];
}

// 获取URL参数
function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    from: params.get('from'),
    recruit_id: params.get('recruit_id'),
    announcement_id: params.get('announcement_id'),
    record_id: params.get('record_id')
  };
}

// 规范化枚举值
function normalizeRank(value) {
  const mapping = {
    '候补机师': '候选人',
    '训练机师': '试播主播',
    '实习机师': '实习主播',
    '正式机师': '正式主播'
  };
  return mapping[value] || value;
}

function normalizeStatus(value) {
  const mapping = {
    '未征召': '未招募',
    '不征召': '不招募',
    '已征召': '已招募',
    '已阵亡': '流失'
  };
  return mapping[value] || value;
}

// 获取性别显示
function getGenderDisplay(gender) {
  if (gender === 0) return '男';
  if (gender === 1) return '女';
  return '不明确';
}

// 获取性别图标
function getGenderIcon(gender) {
  if (gender === 0) return '♂';
  if (gender === 1) return '♀';
  return '?';
}

// 格式化日期时间
function formatDateTime(isoString) {
  if (!isoString) return '';
  const date = new Date(isoString);
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  }).replace(/\//g, '-');
}

// 格式化日期
function formatDate(isoString) {
  if (!isoString) return '';
  const date = new Date(isoString);
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).replace(/\//g, '-');
}

// 渲染返回按钮
function renderBackNav(params) {
  const backNav = document.getElementById('backNav');
  let backUrl = '/pilots';
  let backText = '返回';
  
  if (params.from === 'recruit_detail' && params.recruit_id) {
    backUrl = `/recruit/${params.recruit_id}`;
  } else if (params.from === 'announcement_detail' && params.announcement_id) {
    backUrl = `/announcement/${params.announcement_id}`;
  } else if (params.from === 'battle_record_detail' && params.record_id) {
    backUrl = `/battle-records/${params.record_id}`;
  } else if (params.from === 'performance') {
    backUrl = `/pilots/${currentPilot.id}/performance`;
  }
  
  backNav.innerHTML = `
    <a class="btn btn-secondary" href="${backUrl}">
      <span>←</span>
      ${backText}
    </a>
  `;
}

// 渲染主播信息卡片
function renderPilotInfo(pilot, commission = null) {
  const infoCard = document.getElementById('pilotInfoCard');
  const normalizedRank = normalizeRank(pilot.rank || '');
  const normalizedStatus = normalizeStatus(pilot.status || '');
  
  // 分成信息渲染部分
  let commissionHtml = '';
  if (commission) {
    commissionHtml = `
    <div class="info-section">
      <h3 class="section-title">分成信息</h3>
      <div class="commission-card">
        <div class="commission-header">
          <div class="commission-rate">
            <span class="rate-value">${commission.current_rate}%</span>
            <span class="rate-label">当前分成比例</span>
          </div>
          <div class="commission-calculation">
            <div class="calc-item">
              <span class="calc-value">${commission.calculation_info.pilot_income.toFixed(1)}%</span>
              <span class="calc-label">主播收入</span>
            </div>
            <div class="calc-item">
              <span class="calc-value">${commission.calculation_info.company_income.toFixed(1)}%</span>
              <span class="calc-label">公司收入</span>
            </div>
          </div>
        </div>
        <div class="commission-footer">
          <div class="commission-formula">${commission.calculation_info.calculation_formula}</div>
          <div class="commission-date">
            ${commission.effective_date ? '生效时间：' + formatDate(commission.effective_date) : '默认分成比例'}
          </div>
          ${commission.remark ? '<div class="commission-remark">备注：' + commission.remark + '</div>' : ''}
        </div>
      </div>
    </div>`;
  } else {
    commissionHtml = `
    <div class="info-section">
      <h3 class="section-title">分成信息</h3>
      <div class="commission-card">
        <div class="commission-header">
          <div class="commission-rate">
            <span class="rate-value">加载中...</span>
            <span class="rate-label">当前分成比例</span>
          </div>
          <div class="commission-calculation">
            <div class="calc-item">
              <span class="calc-value">加载中...</span>
              <span class="calc-label">主播收入</span>
            </div>
            <div class="calc-item">
              <span class="calc-value">加载中...</span>
              <span class="calc-label">公司收入</span>
            </div>
          </div>
        </div>
        <div class="commission-footer">
          <div class="commission-card" style="text-align: center; color: #666;">
            分成信息加载中...
          </div>
        </div>
      </div>
    </div>`;
  }
  
  infoCard.innerHTML = `
    <div class="card-header">
      <div class="pilot-main-info">
        <div class="pilot-name">${pilot.nickname || ''}</div>
        <div class="pilot-real-name">${pilot.real_name || '未填写姓名'}</div>
        <div class="pilot-badges">
          <span class="rank-badge rank-${normalizedRank.replace(/ /g, '')}">${normalizedRank}</span>
          <span class="status-badge status-${normalizedStatus.replace(/ /g, '')}">${normalizedStatus}</span>
        </div>
      </div>
    </div>

    <div class="info-section">
      <h3 class="section-title">基础信息</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">性别</div>
          <div class="info-value">${getGenderDisplay(pilot.gender)}</div>
        </div>
        <div class="info-item">
          <div class="info-label">籍贯</div>
          <div class="info-value">${pilot.hometown || '未填写'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">年龄</div>
          <div class="info-value">
            ${pilot.age ? pilot.age + '岁' : '未知'}
            ${pilot.birth_year ? '(' + pilot.birth_year + '年)' : ''}
          </div>
        </div>
      </div>
    </div>

    <div class="info-section">
      <h3 class="section-title">业务信息</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">直属运营</div>
          <div class="info-value">${pilot.owner ? (pilot.owner.nickname || '无') : '无'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">开播平台</div>
          <div class="info-value">${pilot.platform || ''}</div>
        </div>
        <div class="info-item">
          <div class="info-label">开播方式</div>
          <div class="info-value">${pilot.work_mode || ''}</div>
        </div>
        <div class="info-item">
          <div class="info-label">主播分类</div>
          <div class="info-value rank-${normalizedRank.replace(/ /g, '')}">${normalizedRank}</div>
        </div>
        <div class="info-item">
          <div class="info-label">状态</div>
          <div class="info-value status-${normalizedStatus.replace(/ /g, '')}">${normalizedStatus}</div>
        </div>
      </div>
    </div>

    ${commissionHtml}

    <div class="info-section">
      <h3 class="section-title">系统信息</h3>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">创建时间</div>
          <div class="info-value">${formatDateTime(pilot.created_at)}</div>
        </div>
        <div class="info-item">
          <div class="info-label">最后修改</div>
          <div class="info-value">${formatDateTime(pilot.updated_at)}</div>
        </div>
      </div>
    </div>
  `;
}

// 渲染操作按钮
function renderActionButtons(pilot) {
  const footbarContainer = document.getElementById('footbarContainer');
  const normalizedStatus = normalizeStatus(pilot.status || '');
  
  footbarContainer.innerHTML = `
    <div class="footbar">
      <div class="inner">
        <a class="btn btn-primary" href="/pilots/${pilot.id}/edit">编辑</a>
        ${normalizedStatus === '未招募' ? `
        <a class="btn btn-hud" href="/recruits/start/${pilot.id}">启动招募</a>
        ` : ''}
        <a class="btn btn-outline" href="/pilots/${pilot.id}/commission/">分成管理</a>
        <a class="btn btn-primary" href="/pilots/${pilot.id}/performance?from=pilot_detail">业绩查看</a>
        <button class="btn btn-outline" onclick="showChanges()">变更记录</button>
      </div>
    </div>
  `;
}

// 加载主播分成信息
async function loadPilotCommission(pilotId) {
  try {
    const response = await fetch(`/api/pilots/${pilotId}/commission/current`);
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || '加载分成分信息失败');
    }
    
    return result.data;
  } catch (error) {
    console.error('加载分成分信息失败:', error);
    return null;
  }
}

// 加载主播详情
async function loadPilotDetail() {
  const loadingState = document.getElementById('loadingState');
  const pilotDetail = document.getElementById('pilotDetail');
  
  loadingState.style.display = 'block';
  pilotDetail.style.display = 'none';
  
  try {
    const pilotId = getPilotIdFromUrl();
    
    // 并行加载主播基本信息和分成信息
    const [pilotResponse, commission] = await Promise.all([
      fetch(`/api/pilots/${pilotId}`),
      loadPilotCommission(pilotId)
    ]);
    
    const pilotResult = await pilotResponse.json();
    
    if (!pilotResult.success) {
      throw new Error(pilotResult.error?.message || '加载主播详情失败');
    }
    
    currentPilot = pilotResult.data;
    document.title = `主播详情 - ${currentPilot.nickname} - Lacus-Log`;
    
    const params = getUrlParams();
    renderBackNav(params);
    renderPilotInfo(currentPilot, commission);
    renderActionButtons(currentPilot);
    
    loadingState.style.display = 'none';
    pilotDetail.style.display = 'block';
  } catch (error) {
    console.error('加载主播详情失败:', error);
    showMessage('加载主播详情失败', 'error');
    loadingState.style.display = 'none';
  }
}

// 显示变更记录
async function showChanges() {
  const modal = document.getElementById('changesModal');
  const loading = document.getElementById('changesLoading');
  const changesList = document.getElementById('changesList');
  
  modal.style.display = 'flex';
  loading.style.display = 'block';
  changesList.style.display = 'none';
  changesList.innerHTML = '';
  
  try {
    const pilotId = getPilotIdFromUrl();
    const response = await fetch(`/api/pilots/${pilotId}/changes`);
    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error?.message || '加载变更记录失败');
    }
    
    const changes = result.data || [];
    
    if (changes.length === 0) {
      changesList.innerHTML = '<div class="empty-state"><div class="empty-title">暂无变更记录</div></div>';
    } else {
      const changesHtml = changes.map(change => `
        <div class="change-item">
          <div class="change-header">
            <span>操作人：${change.user ? (change.user.nickname || change.user.username) : '未知'}</span>
            <span>${formatDateTime(change.created_at)}</span>
          </div>
          <div class="change-content">
            <span class="change-field">${change.field_name}</span>
            <div class="change-values">
              <span class="old-value">${change.old_value || '空'}</span>
              →
              <span class="new-value">${change.new_value || '空'}</span>
            </div>
          </div>
        </div>
      `).join('');
      changesList.innerHTML = changesHtml;
    }
  } catch (error) {
    console.error('加载变更记录失败:', error);
    changesList.innerHTML = '<div class="empty-state"><div class="empty-title">加载失败</div></div>';
  }
  
  loading.style.display = 'none';
  changesList.style.display = 'block';
}

function hideChanges() {
  const modal = document.getElementById('changesModal');
  modal.style.display = 'none';
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
  loadPilotDetail();
  
  const modal = document.getElementById('changesModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        hideChanges();
      }
    });
  }
});
</script>
{% endblock %}
