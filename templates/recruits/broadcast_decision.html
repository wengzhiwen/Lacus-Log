{% extends "base.html" %}

{% block title %}开播决策 - {{ recruit.pilot.nickname }} - Lacus-Log{% endblock %}

{% block content %}
<section class="broadcast-decision">
  <div class="back-nav">
    <a class="btn btn-secondary" href="{{ url_for('recruit.detail_recruit', recruit_id=recruit.id) }}">
      <span>←</span>
      返回招募详情
    </a>
  </div>

  <h1 class="title">开播决策</h1>

  <div class="pilot-info-card">
    <div class="card-header">
        <div class="pilot-main-info">
            <div class="pilot-name"><a href="{{ url_for('pilot.pilot_detail', pilot_id=recruit.pilot.id) }}">{{ recruit.pilot.nickname }}</a></div>
            <div class="pilot-real-name">{{ recruit.pilot.real_name or '未填写姓名' }}</div>
            <div class="pilot-badges">
                <span class="rank-badge">{{ recruit.pilot.rank.value }}</span>
                <span class="status-badge">{{ recruit.pilot.status.value }}</span>
            </div>
        </div>
    </div>
  </div>

  <form id="broadcast-decision-form" class="recruit-form">
    <input type="hidden" name="recruit_id" value="{{ recruit.id }}"/>
    
    <div class="form-section">
      <h3 class="section-title">决策信息</h3>
      <div class="form-row">
        <div class="form-group">
          <label>开播决策人</label>
          <input type="text" value="{{ current_user.nickname or current_user.username }}" readonly>
        </div>
        <div class="form-group">
          <label for="broadcast_decision">开播决策 <span class="required">*</span></label>
          <select name="broadcast_decision" id="broadcast_decision" required>
            <option value="">-- 请选择决策 --</option>
            {% for value, label in broadcast_decision_choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div class="form-section" id="pilot-assignment-info" style="display: none;">
      <h3 class="section-title">主播分配信息</h3>
      <div class="info-notice"><small>主播的分类和状态将自动更新</small></div>
      <div class="form-row">
        <div class="form-group">
          <label for="owner_id">直属运营 <span class="required">*</span></label>
          <select name="owner_id" id="owner_id">
            <option value="">-- 请选择 --</option>
            {% for value, label in recruiter_choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="platform">开播平台 <span class="required">*</span></label>
          <select name="platform" id="platform">
            <option value="">-- 请选择 --</option>
            {% for value, label in platform_choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">其他信息</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="introduction_fee">介绍费（元）</label>
          <input type="number" name="introduction_fee" id="introduction_fee" step="0.01" min="0" value="{{ recruit.introduction_fee }}">
        </div>
        <div class="form-group">
          <label for="remarks">备注</label>
          <textarea name="remarks" id="remarks" rows="3" maxlength="200">{{ recruit.remarks or '' }}</textarea>
        </div>
      </div>
    </div>
  </form>
</section>

<div class="footbar">
  <a class="btn btn-secondary" href="{{ url_for('recruit.detail_recruit', recruit_id=recruit.id) }}">返回</a>
  <button type="submit" form="broadcast-decision-form" class="btn btn-primary">确认决策</button>
</div>

<style>
.broadcast-decision { padding: 20px; }
.back-nav { margin-bottom: 20px; }
.title { margin-bottom: 20px; font-size: 24px; }
.pilot-info-card { background: white; border: 1px solid var(--gray); border-radius: 8px; margin-bottom: 20px; padding: 20px; }
.card-header { display: flex; align-items: center; gap: 16px; }
.pilot-main-info { flex: 1; }
.pilot-name { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
.pilot-name a { color: var(--brand); text-decoration: none; }
.pilot-name a:hover { text-decoration: underline; }
.pilot-real-name { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
.pilot-badges { display: flex; gap: 8px; }
.rank-badge, .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; background: var(--table-header); }
.recruit-form { background: white; border: 1px solid var(--gray); border-radius: 8px; padding: 20px; margin-bottom: 80px; }
.form-section { margin-bottom: 24px; }
.section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--table-header); }
.form-row { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px; }
.form-group { display: flex; flex-direction: column; }
label { font-weight: 500; margin-bottom: 4px; }
.required { color: var(--error); }
input, select, textarea { padding: 8px 12px; border: 1px solid var(--gray); border-radius: 4px; }
input[readonly] { background: var(--table-header); }
.info-notice { background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 4px; padding: 12px; margin-bottom: 16px; }
@media (min-width: 768px) { .form-row { grid-template-columns: 1fr 1fr; } }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const decisionEl = document.getElementById('broadcast_decision');
    const assignmentEl = document.getElementById('pilot-assignment-info');
    const ownerInput = document.getElementById('owner_id');
    const platformInput = document.getElementById('platform');

    decisionEl.addEventListener('change', function() {
        const isSuccess = this.value === '正式主播' || this.value === '实习主播';
        assignmentEl.style.display = isSuccess ? 'block' : 'none';
        ownerInput.required = isSuccess;
        platformInput.required = isSuccess;
    });

    const form = document.getElementById('broadcast-decision-form');
    form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const formData = new FormData(form);
        const recruitId = formData.get('recruit_id');
        const payload = {
            broadcast_decision: formData.get('broadcast_decision'),
            owner_id: formData.get('owner_id'),
            platform: formData.get('platform'),
            introduction_fee: formData.get('introduction_fee'),
            remarks: formData.get('remarks')
        };

        if (!payload.broadcast_decision) {
            showMessage('请选择开播决策', 'error');
            return;
        }

        try {
            const response = await RecruitAPI.broadcastDecision(recruitId, payload);
            if (response.success) {
                showMessage(response.meta.message || '操作成功！正在跳转...', 'success');
                setTimeout(() => {
                    window.location.href = "{{ url_for('recruit.list_recruits') }}";
                }, 1500);
            }
        } catch (error) {
            console.error('Broadcast decision failed:', error);
        }
    });
});
</script>
{% endblock %}