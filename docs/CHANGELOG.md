2025-09-11 新增
- 首页仪表板新增三张卡片：作战记录统计、机师统计、候补机师统计；完成后端数据统计与模板渲染。
- 战斗区域管理模块（模型、路由、模板、批量生成）并补充单元测试

2025-09-11 修复
- 通告详情 footbar 按钮顺序与样式统一为：编辑、登录作战记录、删除、变更记录，颜色遵循基础-UI风格。
- 作战记录登记（从通告进入）时：主播/所属改为只读展示，并以编辑页格式展示关联通告；修复脚本在无筛选器场景下的空元素访问。
 - 通告详情按钮细化：删除按钮文本居中；“登录作战记录”改为HUD绿背景白字且移除图标；“变更记录”恢复灰色描边样式。

2025-09-11 优化
- 全站统一 favicon：将 `static/zaft.svg` 重命名为 `static/favicon.svg` 并在 `templates/base.html` 全局引用；在页头品牌标题左侧显示图标。

2025-09-11 新增
- 实装机师-作战记录功能：完整的作战记录管理模块
- 作战记录元数据：主播、关联通告、开始结束时间、流水金额、底薪金额、X/Y/Z坐标快照、参战形式、所属快照、登记人、备注等字段
- 支持两种登记模式：从模块入口新建和从通告详情页预填
- 列表筛选功能：按所属、阶级、主播、时间筛选，默认显示自己的近7天记录
- 排序规则：开始时间逆序、流水金额次序，每次加载100条记录支持滚动加载
- 三联选择器：支持主播筛选（所属、阶级、昵称）和作战区域选择（X/Y/Z坐标）
- 时间默认值：开始时间为当前时间向前6小时取整点半点，结束时间为当前时间取整点半点
- 变更记录追踪：记录所有字段修改的详细日志（时间、操作者、字段、前后值、IP）
- 权限控制：仅议长和舰长可访问，完整的CRUD操作和变更记录查看
- 响应式设计：移动端优化的界面布局和footbar操作按钮

2025-09-11 修复/变更
- 作战记录参战形式与作战区域的业务规则：当参战形式为“线上”时，X/Y/Z不填写且不可编辑；当参战形式为“线下”时，X/Y/Z为必填项。
- 更新`BattleRecord`模型与路由校验逻辑；调整新建/编辑页面将“参战形式”移动至“作战区域”分组首位并联动禁用作战区域选择。
 - 从通告预填时：默认将参战形式设为“线下”，按通告时间预填开始/结束时间与X/Y/Z快照；API返回的通告详情也固定提供“线下”作为预填参战形式。
 - 编辑页UI精简：主播改为只读显示，移除用于筛选主播的“所属/阶级”筛选器，保持与创建页一致的“参战形式在作战区域首位”的布局。
 - 修复：编辑作战记录时，如前端未提交“关联通告”字段，后端不再将其置空；只有该字段被显式提交时才更新（空字符串表示清空）。
- 统一作战计划页面机师展示格式：
  - 新建/编辑页机师下拉项改为“昵称(年龄)[状态]性别符号”，与作战记录一致
  - 通告详情页机师信息展示对齐作战记录格式
  - /announcements/api/pilots-filtered 返回字段新增 name，用于上述统一展示

2025-01-11 新增
- 实装机师-作战计划日历功能：提供月视图、周视图、日视图三种日历界面
- 月视图：仿照手机月历APP设计，显示每日作战计划数量，点击日期跳转日视图
- 周视图：显示一周作战计划和可用区域统计，支持周次切换
- 日视图：类似会议室预订系统，按战斗区域和时间轴展示详细安排
- 实现完整的权限控制：仅舰长和议长可访问日历功能
- 添加导航菜单入口和首页仪表板快捷访问
- 支持响应式设计和移动端优化

2025-01-10 新增
- 实装首页仪表板功能：显示今日作战计划数量、环比变化和7日平均数据
- 实现响应式卡片布局：移动端单列显示，桌面端支持2-3列并排
- 添加数据可视化元素：使用图标和颜色区分正负变化
- 优化用户体验：卡片悬停效果和现代化设计风格

2025-01-10 修复
- 修复编辑通告界面中时间显示问题：编辑"未来所有"循环时，时间选择器（小时和分钟）现在正确显示GMT+8时间而非UTC时间
- 新增Jinja2过滤器`utc_to_local`用于模板中的时间转换
- 确保编辑界面与冲突检查结果中的时间显示统一为GMT+8格式
- 修复编辑"未来所有"循环时的冲突检查逻辑：现在会排除所有可能被编辑的未来通告，避免未来通告之间的相互冲突检查
- 优化`check_conflicts`方法支持排除多个通告ID，提升编辑循环事件的用户体验

2025-09-10 优化
- 优化机师-作战计划导出打印样式：专为A4纸张一页打印设计
- 打印时隐藏网站标题（Lacus-Log），去除不必要的页面元素
- 大幅压缩头部间距和字体大小：标题14px、机师信息10px、表格9px
- 减少页边距至10mm，最大化打印内容区域
- 调整表格行高和内边距，确保31天完整月份能在一页内显示
- 优化注意事项字体至8px，减少占用空间

2025-09-10 修复
- 修复机师-作战计划导出表格布局：按需求文档调整表格结构
- 场地信息（X坐标）移至表格上方单独显示，不再在表格中显示
- 表格中添加设备列，显示Y坐标-Z坐标组合
- 调整表格列宽比例：日期25%、通告时间20%、设备20%、通告时长15%、工作内容20%
- 优化场地信息显示样式，支持多个场地用逗号分隔

2025-09-10 修复
- 修复机师-作战计划导出功能选择逻辑：完全复用创建作战计划页面的机师筛选API
- 阶级选框现在显示所有阶级枚举选项（候补机师、训练机师、实习机师、正式机师）
- 机师选框默认列出所有状态为"已征召"或"已签约"的机师，与作战计划创建页面保持一致
- 使用现有的 /api/pilot-filters 和 /api/pilots-filtered API，确保行为统一
- 删除重复的导出专用API，减少代码冗余

2025-09-10 修复
- 修复机师-作战计划导出功能UI风格问题：统一与现有模块的界面风格
- 修复CSRF token显示问题：改为hidden input字段
- 优化三联选择逻辑：所属和阶级作为筛选器，机师选择支持多级筛选
- 改进表单布局：采用与新建通告页面一致的form-section和form-row结构
- 优化JavaScript交互：支持所属和阶级的独立筛选，提升用户体验

2025-09-10 新增
- 机师-作战计划导出功能：支持生成指定机师在指定月份的通告预定表
- 实现三联选择机师功能（所属、阶级、昵称）
- 支持年月选择，默认当前年月
- 生成完整月份表格，包含日期、场地、通告时间、设备、通告时长、工作内容等字段
- 专为打印设计的PDF样式，适合A4纸张输出
- 包含开播注意事项说明
- 权限控制：议长和舰长可使用

2025-01-10 修复
- 修复编辑页面和新建页面冲突检查结果标题重复显示的问题：移除HTML模板中的固定标题，统一由JavaScript动态生成标题
- 确保冲突检查结果显示的一致性和用户体验

2025-01-10 修复
- 修复编辑通告时"修改未来所有循环"的冲突检查问题：现在会检查所有可能被修改的通告实例，而不是只检查当前这一个通告
- 更新冲突检查API，新增edit_scope参数支持区分"仅这一次"和"未来所有"的编辑范围
- 优化前端JavaScript，在编辑未来所有循环时传递正确的编辑范围参数
- 确保用户能够清楚看到所有相关通告的检查结果，提升用户体验
- 修复编辑未来所有循环时第一个通告时间未正确更新的问题：现在第一个通告也会使用新的完整时间，而不是保持原时间

2025-01-10 改进
- 编辑通告时，若修改未来所有循环，开始时间中的日期不能修改，只能修改时间
- 添加时间格式化函数：get_local_date_for_input、get_local_time_for_input
- 更新编辑模板，当编辑范围为"未来所有循环"时，日期输入框设为只读，时间改为下拉选择器（小时和分钟）
- 更新后端逻辑，确保编辑未来所有循环时只更新时间部分，保持日期不变
- 添加前端JavaScript验证，防止用户修改日期部分
- 优化时间选择体验：小时选择器（00-23），分钟选择器（00-45，15分钟间隔）

2025-09-10 修复
- 修复编辑通告时"请填写所有必填项"错误：添加隐藏的battle_area字段，修复前端JavaScript与后端验证字段不匹配的问题
- 添加debug日志帮助定位表单数据问题

2025-09-10 改进
- 改进通告编辑和删除功能，支持"编辑/删除这一次"和"编辑/删除未来所有"选项
- 对循环组内的通告提供两个编辑按钮选项，不再要求必须修改父通告
- 实现循环组分割功能，当用户选择"编辑/删除未来所有"时，自动创建新的循环组
- 隐藏父通告概念，优化用户界面体验
- 新增通告模型方法：split_recurrence_group_from_current、get_future_announcements_in_group、is_in_recurrence_group

2025-09-10 修复
- 通告编辑页补齐机师三联动筛选与初始化逻辑，修复机师下拉无选项问题，并与新建页保持一致的填充顺序。

2025-09-10 修复
- 通告编辑页“检查冲突”结果展示对齐新建页：当无冲突时显示 planned_instances 计划详情（含单事件与多事件汇总），提升一致性与可读性。

# 变更日志

2025-09-10 文档
- 将作战计划相关界面与文档中的“重复组”统一更名为“循环组”。

2025-09-10 修复
- 修正通告列表“默认筛选器：所属=自己”未生效的问题，缺省时默认按当前用户过滤。

2025-09-10 修复
- 通告列表排序从“开始时间倒序”改为“按本地通告日升序、同日按机师昵称”。

## 2025-09-10 新增：
- 通告列表新增“时间”筛选：支持“现在开始”（默认）与“全部”
- 默认仅显示开始时间大于等于当前时间（按GMT+8转换后比较）的通告

## 2025-09-10 界面优化：
- 通告详情页面界面改进：将操作按钮（编辑、删除、变更记录）移动到页面底部，采用footbar吸附式设计
- 优化移动端用户体验，按钮在底部更便于触控操作
- 保持与现有设计风格的一致性，支持安全区域适配
- 调整冲突检查结果显示位置：在新建和编辑通告页面中，冲突检查结果现在显示在"检查冲突"按钮和"创建通告/保存修改"按钮之间，提升用户体验

## 2025-09-10 修复和优化：
- 时间戳处理规则的完整实现和修复
- 新增 `utils/timezone_helper.py` 时间转换工具模块
- 修复所有模型中的UTC时间戳默认值设定
- 修复路由中用户输入时间的GMT+8到UTC转换
- 修复模板中时间显示的UTC到GMT+8转换
- 新增时间处理相关的Jinja2过滤器（local_datetime、local_date、local_time、local_datetime_for_input）
- 优化新建通告页面时间输入体验：
  - 开始时间默认为当天13:00（便于用户输入）
  - 循环结束时间改为只选择日期，时间自动设为23:59
  - 循环结束日期默认为当前月最后一天
- 移除开始时间不能早于当前时间的验证限制，允许创建历史记录和补录数据
- 确保系统严格遵循"数据库存储UTC时间，UI显示和输入GMT+8时间"的设计规则
- 通过验证脚本确认所有时间转换函数工作正常

2025-09-10 修复
- 冲突检查API返回的计划详情与冲突项时间统一转换为GMT+8显示，修复新建与编辑页检查结果时间显示为UTC的问题。

## 2025-09-10 新增：
- 作战计划管理模块，包括通告的创建、编辑、删除、查看功能
- 支持重复事件管理（每日、每周、自定义重复）
- 时间冲突检查和资源占用验证
- 通告变更记录追踪
- 类似日历应用的用户体验设计

2025-09-11 文档
- 新增《机师-作战记录》设计文档：
  - 定义作战记录元数据（主播、时间、金额、X/Y/Z快照、参战形式、所属快照、登记人等）
  - 提供两种登记模式（从模块入口、从通告详情），支持从通告预填
  - 列表筛选（所属、阶级、主播、时间：今天/近7天），默认所属=自己、时间=近7天
  - 排序规则（开始时间逆序、流水金额次序）与UI/权限/日志规范

## 2025-09-09 新增：
- 完整实现机师管理功能模块，包括数据模型、路由控制、前端界面


