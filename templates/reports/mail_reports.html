{% extends 'base.html' %}
{% block title %}é‚®ä»¶æŠ¥å‘Š - Lacus-Log{% endblock %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">ğŸ“§ é‚®ä»¶æŠ¥å‘Š</h1>
  <div class="text-muted">ä»¥ä¸‹æŠ¥è¡¨ä¸ºå¼‚æ­¥è§¦å‘å‹ï¼Œç‚¹å‡»æŒ‰é’®åå°†å¼€å§‹è®¡ç®—å¹¶å°è¯•å‘é€é‚®ä»¶ï¼Œé¡µé¢ä¸ä¼šç­‰å¾…è®¡ç®—å®Œæˆã€‚</div>
    <div id="result" class="text-muted" style="margin-top:8px;"></div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">æœªå¼€æ’­æé†’ï¼ˆè¿‘48å°æ—¶ï¼‰</h2>
    <div class="card-icon">â°</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.unstarted %}
    <div class="text-muted" style="margin-bottom:8px;">ä¸‹æ¬¡è§¦å‘ï¼ˆGMT+8ï¼‰ï¼š{{ next_times.unstarted }}</div>
    {% endif %}
    <button id="btnUnstarted" class="btn btn-primary" style="width:100%" type="button" aria-label="è§¦å‘æœªå¼€æ’­æé†’æŠ¥è¡¨">å¼€å§‹å‘é€</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">æœªä¸‹æ’­æé†’</h2>
    <div class="card-icon">ğŸ“¡</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.live_overtime %}
    <div class="text-muted" style="margin-bottom:8px;">ä¸‹æ¬¡è§¦å‘ï¼ˆGMT+8ï¼‰ï¼š{{ next_times.live_overtime }}</div>
    {% endif %}
    <div class="text-muted" style="margin-bottom:8px; font-size: 12px;">
      è¯´æ˜ï¼šæ¯æ—¥æ£€æŸ¥å¼€æ’­ä¸­ä¸”å·²æŒç»­è¶…è¿‡8å°æ—¶çš„è®°å½•ï¼Œæé†’ç¡®è®¤æ˜¯å¦å·²ä¸‹æ’­
    </div>
    <button id="btnLiveOvertime" class="btn btn-primary" style="width:100%" type="button" aria-label="è§¦å‘æœªä¸‹æ’­æé†’é‚®ä»¶å‘é€">å¼€å§‹å‘é€</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">çº¿ä¸Šä¸»æ’­æœªå¼€æ’­æé†’</h2>
    <div class="card-icon">ğŸŒ</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.online_pilot_unstarted %}
    <div class="text-muted" style="margin-bottom:8px;">ä¸‹æ¬¡è§¦å‘ï¼ˆGMT+8ï¼‰ï¼š{{ next_times.online_pilot_unstarted }}</div>
    {% endif %}
    <div class="text-muted" style="margin-bottom:8px; font-size: 12px;">
      è¯´æ˜ï¼šæ£€æŸ¥å‰4æ—¥è‡³å‰2æ—¥æœ‰çº¿ä¸Šå¼€æ’­è®°å½•çš„ä¸»æ’­ï¼Œå¦‚æœåœ¨å‰1æ—¥æ— å¼€æ’­è®°å½•åˆ™æé†’
    </div>
    <button id="btnOnlinePilotUnstarted" class="btn btn-primary" style="width:100%" type="button" aria-label="è§¦å‘çº¿ä¸Šä¸»æ’­æœªå¼€æ’­æé†’é‚®ä»¶å‘é€">å¼€å§‹å‘é€</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">åº•è–ªå‘æ”¾æé†’</h2>
    <div class="card-icon">ğŸ’°</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.base_salary_reminder %}
    <div class="text-muted" style="margin-bottom:8px;">ä¸‹æ¬¡è§¦å‘ï¼ˆGMT+8ï¼‰ï¼š{{ next_times.base_salary_reminder }}</div>
    {% endif %}
    <div class="text-muted" style="margin-bottom:8px; font-size: 12px;">
      è¯´æ˜ï¼šç­›é€‰çŠ¶æ€ä¸º"æœªå¤„ç†"ä¸”ç”³è¯·æ—¶é—´å·²è¶…è¿‡12å°æ—¶çš„åº•è–ªç”³è¯·ï¼Œæé†’ç®¡ç†å‘˜åŠæ—¶å®¡æ ¸
    </div>
    <button id="btnBaseSalaryReminder" class="btn btn-primary" style="width:100%" type="button" aria-label="è§¦å‘åº•è–ªå‘æ”¾æé†’é‚®ä»¶å‘é€">å¼€å§‹å‘é€</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">ä¸»æ’­æ‹›å‹Ÿæ—¥æŠ¥</h2>
    <div class="card-icon">ğŸ“Š</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.recruit_daily %}
    <div class="text-muted" style="margin-bottom:8px;">ä¸‹æ¬¡è§¦å‘ï¼ˆGMT+8ï¼‰ï¼š{{ next_times.recruit_daily }}</div>
    {% endif %}
    <div class="form-group">
      <label for="reportDate">æŠ¥è¡¨æ—¥æœŸï¼š</label>
      <input type="date" id="reportDate" class="form-control" style="margin-bottom: 10px;">
      <small class="text-muted">ç•™ç©ºåˆ™å‘é€æ˜¨å¤©çš„æŠ¥è¡¨</small>
    </div>
    <button id="btnRecruitDaily" class="btn btn-primary" style="width:100%" type="button" aria-label="è§¦å‘æ‹›å‹Ÿæ—¥æŠ¥é‚®ä»¶å‘é€">å¼€å§‹å‘é€</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">å¼€æ’­æ—¥æŠ¥</h2>
    <div class="card-icon">ğŸ“ˆ</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.daily_report %}
    <div class="text-muted" style="margin-bottom:8px;">ä¸‹æ¬¡è§¦å‘ï¼ˆGMT+8ï¼‰ï¼š{{ next_times.daily_report }}</div>
    {% endif %}
    <div class="form-group">
      <label for="dailyReportDate">æŠ¥è¡¨æ—¥æœŸï¼š</label>
      <input type="date" id="dailyReportDate" class="form-control" style="margin-bottom: 10px;">
      <small class="text-muted">ç•™ç©ºåˆ™å‘é€æ˜¨å¤©çš„æŠ¥è¡¨</small>
    </div>
    <button id="btnDailyReport" class="btn btn-primary" style="width:100%" type="button" aria-label="è§¦å‘å¼€æ’­æ—¥æŠ¥é‚®ä»¶å‘é€">å¼€å§‹å‘é€</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">å¼€æ’­æœˆæŠ¥ï¼ˆé‚®ä»¶ï¼‰</h2>
    <div class="card-icon">ğŸ“…</div>
  </div>
  <div class="card-body">
    {% if next_times and next_times.monthly_mail_report %}
    <div class="text-muted" style="margin-bottom:8px;">ä¸‹æ¬¡è§¦å‘ï¼ˆGMT+8ï¼‰ï¼š{{ next_times.monthly_mail_report }}</div>
    {% endif %}
    <div class="form-group">
      <label for="monthlyReportMonth">æŠ¥è¡¨æœˆä»½ï¼š</label>
      <input type="month" id="monthlyReportMonth" class="form-control" style="margin-bottom: 10px;">
      <small class="text-muted">ç•™ç©ºåˆ™å‘é€â€œå‰ä¸€è‡ªç„¶æ—¥æ‰€åœ¨æœˆâ€çš„æœˆæŠ¥</small>
    </div>
    <button id="btnMonthlyMailReport" class="btn btn-primary" style="width:100%" type="button" aria-label="è§¦å‘å¼€æ’­æœˆæŠ¥é‚®ä»¶å‘é€">å¼€å§‹å‘é€</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const btnUnstarted = document.getElementById('btnUnstarted');
  const btnLiveOvertime = document.getElementById('btnLiveOvertime');
  const btnOnlinePilotUnstarted = document.getElementById('btnOnlinePilotUnstarted');
  const btnBaseSalaryReminder = document.getElementById('btnBaseSalaryReminder');
  const btnRecruitDaily = document.getElementById('btnRecruitDaily');
  const btnDailyReport = document.getElementById('btnDailyReport');
  const btnMonthlyMailReport = document.getElementById('btnMonthlyMailReport');
  const result = document.getElementById('result');

  async function postUnstarted() {
    result.textContent = 'æœªå¼€æ’­æé†’æŠ¥è¡¨å·²å¼€å§‹è¿ç®—...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_unstarted_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `æœªå¼€æ’­æé†’å·²è§¦å‘å‘é€ï¼Œå…± ${data.count} æ¡ã€‚`;
        } else {
          result.textContent = `æœªå¼€æ’­æé†’æ— å¯å‘é€å†…å®¹ï¼ˆæˆ–æœªé…ç½®æ”¶ä»¶äººï¼‰ã€‚`;
        }
      } else {
        result.textContent = `æœªå¼€æ’­æé†’è§¦å‘å¤±è´¥ï¼š${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`;
      }
    } catch (e) {
      result.textContent = 'ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚';
    }
  }

  async function postLiveOvertime() {
    result.textContent = 'æœªä¸‹æ’­æé†’å·²å¼€å§‹è¿ç®—...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_live_overtime_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `æœªä¸‹æ’­æé†’å·²è§¦å‘å‘é€ï¼Œå…± ${data.count} æ¡ã€‚`;
        } else {
          result.textContent = `æœªä¸‹æ’­æé†’æ— å¯å‘é€å†…å®¹ï¼ˆæˆ–æœªé…ç½®æ”¶ä»¶äººï¼‰ã€‚`;
        }
      } else {
        result.textContent = `æœªä¸‹æ’­æé†’è§¦å‘å¤±è´¥ï¼š${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`;
      }
    } catch (e) {
      result.textContent = 'ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚';
    }
  }

  async function postOnlinePilotUnstarted() {
    result.textContent = 'çº¿ä¸Šä¸»æ’­æœªå¼€æ’­æé†’å·²å¼€å§‹è¿ç®—...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_online_pilot_unstarted_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `çº¿ä¸Šä¸»æ’­æœªå¼€æ’­æé†’å·²è§¦å‘å‘é€ï¼Œå…± ${data.count} ä½ä¸»æ’­ã€‚`;
        } else {
          result.textContent = `çº¿ä¸Šä¸»æ’­æœªå¼€æ’­æé†’æ— å¯å‘é€å†…å®¹ï¼ˆæˆ–æœªé…ç½®æ”¶ä»¶äººï¼‰ã€‚`;
        }
      } else {
        result.textContent = `çº¿ä¸Šä¸»æ’­æœªå¼€æ’­æé†’è§¦å‘å¤±è´¥ï¼š${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`;
      }
    } catch (e) {
      result.textContent = 'ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚';
    }
  }

  async function postBaseSalaryReminder() {
    result.textContent = 'åº•è–ªå‘æ”¾æé†’å·²å¼€å§‹è¿ç®—...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_base_salary_reminder_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `åº•è–ªå‘æ”¾æé†’å·²è§¦å‘å‘é€ï¼Œå…± ${data.count} æ¡ç”³è¯·ã€‚`;
        } else {
          result.textContent = `åº•è–ªå‘æ”¾æé†’æ— å¯å‘é€å†…å®¹ï¼ˆæˆ–æœªé…ç½®æ”¶ä»¶äººï¼‰ã€‚`;
        }
      } else {
        result.textContent = `åº•è–ªå‘æ”¾æé†’è§¦å‘å¤±è´¥ï¼š${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`;
      }
    } catch (e) {
      result.textContent = 'ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚';
    }
  }

  async function postRecruitDaily() {
    const reportDate = document.getElementById('reportDate').value;
    result.textContent = 'æ‹›å‹Ÿæ—¥æŠ¥å·²å¼€å§‹è¿ç®—...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_recruit_daily_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          report_date: reportDate || null
        })
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `æ‹›å‹Ÿæ—¥æŠ¥å·²è§¦å‘å‘é€ï¼Œæ”¶ä»¶äºº ${data.count} äººã€‚`;
        } else {
          result.textContent = `æ‹›å‹Ÿæ—¥æŠ¥å‘é€å¤±è´¥ï¼ˆæˆ–æœªé…ç½®æ”¶ä»¶äººï¼‰ã€‚`;
        }
      } else {
        result.textContent = `æ‹›å‹Ÿæ—¥æŠ¥è§¦å‘å¤±è´¥ï¼š${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`;
      }
    } catch (e) {
      result.textContent = 'ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚';
    }
  }

  async function postDailyReport() {
    const reportDate = document.getElementById('dailyReportDate').value;
    result.textContent = 'å¼€æ’­æ—¥æŠ¥å·²å¼€å§‹è¿ç®—...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_daily_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          report_date: reportDate || null
        })
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `å¼€æ’­æ—¥æŠ¥å·²è§¦å‘å‘é€ï¼Œæ”¶ä»¶äºº ${data.count} äººã€‚`;
        } else {
          result.textContent = `å¼€æ’­æ—¥æŠ¥å‘é€å¤±è´¥ï¼ˆæˆ–æœªé…ç½®æ”¶ä»¶äººï¼‰ã€‚`;
        }
      } else {
        result.textContent = `å¼€æ’­æ—¥æŠ¥è§¦å‘å¤±è´¥ï¼š${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`;
      }
    } catch (e) {
      result.textContent = 'ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚';
    }
  }

  async function postMonthlyMailReport() {
    const reportMonth = document.getElementById('monthlyReportMonth').value;
    result.textContent = 'å¼€æ’­æœˆæŠ¥ï¼ˆé‚®ä»¶ï¼‰å·²å¼€å§‹è¿ç®—...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_monthly_mail_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          report_month: reportMonth || null
        })
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `å¼€æ’­æœˆæŠ¥ï¼ˆé‚®ä»¶ï¼‰å·²è§¦å‘å‘é€ï¼Œæ”¶ä»¶äºº ${data.count} äººã€‚`;
        } else {
          result.textContent = `å¼€æ’­æœˆæŠ¥ï¼ˆé‚®ä»¶ï¼‰å‘é€å¤±è´¥ï¼ˆæˆ–æœªé…ç½®æ”¶ä»¶äººï¼‰ã€‚`;
        }
      } else {
        result.textContent = `å¼€æ’­æœˆæŠ¥ï¼ˆé‚®ä»¶ï¼‰è§¦å‘å¤±è´¥ï¼š${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`;
      }
    } catch (e) {
      result.textContent = 'ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚';
    }
  }

  if (btnUnstarted) {
    btnUnstarted.addEventListener('click', postUnstarted);
  }

  if (btnLiveOvertime) {
    btnLiveOvertime.addEventListener('click', postLiveOvertime);
  }

  if (btnOnlinePilotUnstarted) {
    btnOnlinePilotUnstarted.addEventListener('click', postOnlinePilotUnstarted);
  }

  if (btnBaseSalaryReminder) {
    btnBaseSalaryReminder.addEventListener('click', postBaseSalaryReminder);
  }

  if (btnRecruitDaily) {
    btnRecruitDaily.addEventListener('click', postRecruitDaily);
  }

  if (btnDailyReport) {
    btnDailyReport.addEventListener('click', postDailyReport);
  }

  if (btnMonthlyMailReport) {
    btnMonthlyMailReport.addEventListener('click', postMonthlyMailReport);
  }
});
</script>
{% endblock %}
