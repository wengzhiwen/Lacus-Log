{% extends "base.html" %}

{% block title %}预约开播 - Lacus-Log{% endblock %}

{% block content %}
<section class="schedule-broadcast" data-recruit-id="{{ recruit_id }}">
  <div class="back-nav">
    <a class="btn btn-secondary" href="{{ url_for('recruit.detail_recruit', recruit_id=recruit_id) }}">
      <span>←</span>
      返回招募详情
    </a>
  </div>

  <h1 class="title">预约开播</h1>

  <div class="pilot-info-card">
    <div class="card-header">
        <div class="pilot-main-info">
            <div class="pilot-name" id="pilot-name">加载中...</div>
            <div class="pilot-real-name" id="pilot-real-name">-</div>
            <div class="pilot-badges">
                <span class="rank-badge" id="pilot-rank">-</span>
                <span class="status-badge" id="pilot-status">-</span>
            </div>
        </div>
    </div>
  </div>

  <!-- Warning Message 卡片 -->
  <div id="warning-card" class="warning-card" style="display: none;">
    <div class="warning-icon">⚠️</div>
    <div class="warning-message">选择的开播日期和试播决策日期为同一天</div>
  </div>

  <form id="schedule-broadcast-form" class="recruit-form">
    <input type="hidden" name="recruit_id" value="{{ recruit_id }}"/>
    
    <div class="form-section">
      <h3 class="section-title">预约信息</h3>
      <div class="form-row">
        <div class="form-group">
          <label>预约开播决策人</label>
          <input type="text" value="{{ current_user.nickname or current_user.username }}" readonly>
        </div>
        <div class="form-group">
          <label for="scheduled_broadcast_time">预约开播时间 <span class="required">*</span></label>
          <input type="datetime-local" name="scheduled_broadcast_time" id="scheduled_broadcast_time" required>
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3 class="section-title">其他信息</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="introduction_fee">介绍费（元）</label>
          <input type="number" name="introduction_fee" id="introduction_fee" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label for="remarks">备注</label>
          <textarea name="remarks" id="remarks" rows="3" maxlength="200"></textarea>
        </div>
      </div>
    </div>
  </form>
</section>

<div class="footbar">
  <a class="btn btn-secondary" href="{{ url_for('recruit.detail_recruit', recruit_id=recruit_id) }}">返回</a>
  <button type="submit" form="schedule-broadcast-form" class="btn btn-primary">确认预约</button>
</div>

<style>
.schedule-broadcast { padding: 20px; }
.back-nav { margin-bottom: 20px; }
.title { margin-bottom: 20px; font-size: 24px; }
.pilot-info-card { background: white; border: 1px solid var(--gray); border-radius: 8px; margin-bottom: 20px; padding: 20px; }
.warning-card {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 8px;
  margin-bottom: 20px;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.warning-icon { font-size: 18px; }
.warning-message { color: #856404; font-weight: 500; }
.card-header { display: flex; align-items: center; gap: 16px; }
.pilot-main-info { flex: 1; }
.pilot-name { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
.pilot-name a { color: var(--brand); text-decoration: none; }
.pilot-name a:hover { text-decoration: underline; }
.pilot-real-name { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
.pilot-badges { display: flex; gap: 8px; }
.rank-badge, .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; background: var(--table-header); }
.recruit-form { background: white; border: 1px solid var(--gray); border-radius: 8px; padding: 20px; margin-bottom: 80px; }
.form-section { margin-bottom: 24px; }
.section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--table-header); }
.form-row { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px; }
.form-group { display: flex; flex-direction: column; }
label { font-weight: 500; margin-bottom: 4px; }
.required { color: var(--error); }
input, select, textarea { width: 100%; padding: 8px 12px; border: 1px solid var(--gray); border-radius: 4px; }
input[readonly] { background: var(--table-header); }
@media (min-width: 768px) { .form-row { grid-template-columns: 1fr 1fr; } }
</style>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    const section = document.querySelector('.schedule-broadcast');
    const recruitId = section.dataset.recruitId;
    const scheduledTimeInput = document.getElementById('scheduled_broadcast_time');
    const introductionFeeInput = document.getElementById('introduction_fee');
    const remarksInput = document.getElementById('remarks');

    const rankMapping = {
        '候补机师': '候选人',
        '训练机师': '试播主播',
        '实习机师': '实习主播',
        '正式机师': '正式主播'
    };
    const statusMapping = {
        '未征召': '未招募',
        '不征召': '不招募',
        '已征召': '已招募',
        '已阵亡': '流失'
    };

    const toDatetimeLocal = (isoString) => {
        if (!isoString) return '';
        const date = new Date(isoString);
        const pad = (value) => String(value).padStart(2, '0');
        return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    };

    const getNext14Clock = () => {
        const now = new Date();
        const next = new Date(now);
        next.setHours(14, 0, 0, 0);
        if (now >= next) {
            next.setDate(next.getDate() + 1);
        }
        const pad = (value) => String(value).padStart(2, '0');
        return `${next.getFullYear()}-${pad(next.getMonth() + 1)}-${pad(next.getDate())}T${pad(next.getHours())}:${pad(next.getMinutes())}`;
    };

    const renderPilotInfo = (pilot) => {
        const rank = pilot.rank ? (rankMapping[pilot.rank] || pilot.rank) : '-';
        const status = pilot.status ? (statusMapping[pilot.status] || pilot.status) : '-';
        const nickname = pilot.nickname || '-';
        const nameEl = document.getElementById('pilot-name');
        if (pilot.id) {
            nameEl.innerHTML = `<a href="/pilots/${pilot.id}">${nickname}</a>`;
        } else {
            nameEl.textContent = nickname;
        }
        document.getElementById('pilot-real-name').textContent = pilot.real_name || '未填写姓名';
        document.getElementById('pilot-rank').textContent = rank;
        document.getElementById('pilot-rank').className = `rank-badge rank-${rank}`;
        document.getElementById('pilot-status').textContent = status;
        document.getElementById('pilot-status').className = `status-badge status-${status}`;
        document.title = `预约开播 - ${nickname} - Lacus-Log`;
    };

    const checkSameDayWarning = (scheduledBroadcastTime, trainingDecisionTime) => {
        const warningCard = document.getElementById('warning-card');

        if (!scheduledBroadcastTime || !trainingDecisionTime) {
            warningCard.style.display = 'none';
            return;
        }

        // 解析日期时间字符串为Date对象
        const scheduledDate = new Date(scheduledBroadcastTime);
        const trainingDate = new Date(trainingDecisionTime);

        // 比较日期是否为同一天（GMT+8）
        const gmt8Offset = 8 * 60 * 60 * 1000; // GMT+8的毫秒偏移
        const scheduledGMT8 = new Date(scheduledDate.getTime() + scheduledDate.getTimezoneOffset() * 60 * 1000 + gmt8Offset);
        const trainingGMT8 = new Date(trainingDate.getTime() + trainingDate.getTimezoneOffset() * 60 * 1000 + gmt8Offset);

        const isSameDay =
            scheduledGMT8.getFullYear() === trainingGMT8.getFullYear() &&
            scheduledGMT8.getMonth() === trainingGMT8.getMonth() &&
            scheduledGMT8.getDate() === trainingGMT8.getDate();

        warningCard.style.display = isSameDay ? 'flex' : 'none';
    };

    const populateFormValues = (recruit) => {
        introductionFeeInput.value = recruit.introduction_fee || 0;
        remarksInput.value = recruit.remarks || '';
        const scheduledTime = recruit.effective_scheduled_broadcast_time || recruit.scheduled_broadcast_time;
        const value = toDatetimeLocal(scheduledTime) || getNext14Clock();
        scheduledTimeInput.value = value;

        // 检查是否需要显示警告卡片
        const trainingDecisionTime = recruit.effective_training_decision_time || recruit.training_decision_time;
        checkSameDayWarning(value, trainingDecisionTime);
    };

    try {
        const detailPayload = await RecruitAPI.getRecruitDetail(recruitId);
        if (!detailPayload.success) {
            throw new Error(detailPayload.error?.message || '加载招募详情失败');
        }

        const recruit = detailPayload.data;
        renderPilotInfo(recruit.pilot || {});
        populateFormValues(recruit);

        // 添加日期选择监听器
        scheduledTimeInput.addEventListener('change', function() {
            const trainingDecisionTime = recruit.effective_training_decision_time || recruit.training_decision_time;
            checkSameDayWarning(this.value, trainingDecisionTime);
        });

    } catch (error) {
        console.error('加载预约开播页面数据失败:', error);
        showMessage(error.message || '加载预约开播页面数据失败', 'error');
    }

    const form = document.getElementById('schedule-broadcast-form');
    form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const formData = new FormData(form);
        const payload = {
            scheduled_broadcast_time: formData.get('scheduled_broadcast_time'),
            introduction_fee: formData.get('introduction_fee'),
            remarks: formData.get('remarks')
        };

        if (!payload.scheduled_broadcast_time) {
            showMessage('请填写预约开播时间', 'error');
            return;
        }

        try {
            const response = await RecruitAPI.scheduleBroadcast(recruitId, payload);
            if (response.success) {
                showMessage(response.meta.message || '操作成功！正在跳转...', 'success');
                setTimeout(() => {
                    window.location.href = "{{ url_for('recruit.detail_recruit', recruit_id=recruit_id) }}";
                }, 1500);
            }
        } catch (error) {
            console.error('Schedule broadcast failed:', error);
        }
    });
});
</script>
{% endblock %}
