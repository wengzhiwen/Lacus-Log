# 主播-分成管理（技术设计，原文件名“机师-分成管理（技术设计）”）

> 术语统一记录（2025-09-26）
> - 历史用语→统一用语：机师→主播；舰长→运营；议长→管理员；作战记录→开播记录。
> - 本次复核（2025-09-26）：已完成逐段术语检查，正文采用统一用语；数据库/接口字段仍保留历史命名，仅以字段标注说明。
## 概述

本文档基于业务需求文档《主播-分成管理.md》，设计主播分成管理功能的技术实现方案。分成管理是主播管理模块的子模块，需要提供分成调整记录的CRUD操作、权限控制、数据验证和变更记录功能。

## 技术架构

### 技术栈
- **后端**: Flask + MongoEngine
- **前端**: Jinja2模板 + 自定义CSS
- **数据库**: MongoDB
- **权限控制**: Flask-Security-Too
- **日志系统**: Python logging模块

### 设计原则
- 遵循现有项目的代码风格和技术模式
- 保持与主播管理模块的一致性
- 确保分成计算逻辑的准确性
- 提供良好的用户体验和错误处理

## 数据模型设计

### PilotCommission（主播分成调整记录）模型

#### 字段设计
- **关联字段**：
- `pilot_id`: 关联的主播ID（关联到Pilot模型的ObjectId，使用ReferenceField）

- **业务字段**：
  - `adjustment_date`: 调整生效日期（DateField，数据库存储UTC时间，UI显示GMT+8时间）
  - `commission_rate`: 分成比例（FloatField，0-50，表示0%-50%）
  - `remark`: 备注说明（StringField，可选）

- **状态字段**：
  - `is_active`: 是否有效（BooleanField，默认True，用于软删除）

- **系统字段**：
  - `created_at`: 创建时间（DateTimeField，自动设置）
  - `updated_at`: 最后修改时间（DateTimeField，自动更新）

#### 模型验证
- `commission_rate`: 范围验证（0-50）
- `pilot_id + adjustment_date + is_active=True`: 唯一性约束

### PilotCommissionChangeLog（分成调整记录变更日志）模型

#### 字段设计
- `commission_id`: 关联的分成调整记录ID（关联到PilotCommission模型的ObjectId）
- `user_id`: 操作用户ID（关联到User模型的ObjectId）
- `field_name`: 变更的字段名
- `old_value`: 变更前的值
- `new_value`: 变更后的值
- `change_time`: 变更时间
- `ip_address`: 操作IP地址

### 数据库索引设计

#### PilotCommission集合索引
- `pilot_id + adjustment_date` 复合索引（用于查询主播的分成调整历史）
- `pilot_id + is_active` 复合索引（用于查询主播的有效调整记录）
- `adjustment_date` 索引（用于按时间范围查询）
- `is_active` 索引（用于软删除查询）

#### PilotCommissionChangeLog集合索引
- `commission_id + change_time` 复合索引（用于查询调整记录的变更历史）
- `user_id` 索引（用于查询用户操作记录）
- `change_time` 索引（用于按时间范围查询）

## 路由设计

### 路由结构
- 在现有的 `routes/pilot.py` 模块中增加分成管理相关路由
- 使用现有的 `pilot_bp` 蓝图
- 路由前缀：`/pilots/<pilot_id>/commission`

### 路由列表

#### 1. 分成管理页面 (`/pilots/<pilot_id>/commission/`)
- **功能**: 显示主播的分成管理页面，包含当前分成信息和调整记录列表
- **权限**: 管理员和运营
- **权限控制**: 管理员与运营权限一致，均可管理所有主播的分成

#### 2. 新增分成调整记录页面 (`/pilots/<pilot_id>/commission/new`)
- **功能**: 创建新的分成调整记录
- **权限**: 管理员和运营
- **表单验证**: 调整值范围、调整日唯一性、业务规则

#### 3. 编辑分成调整记录页面 (`/pilots/<pilot_id>/commission/<commission_id>/edit`)
- **功能**: 编辑分成调整记录（支持修改分成比例、备注及 `is_active` 状态）
- **权限**: 管理员和运营
- **限制**: 调整日不可修改，软删除通过 `is_active` 开关实现
- **变更记录**: 自动记录字段变更

#### 4. 软删除分成调整记录 (`/pilots/<pilot_id>/commission/<commission_id>/delete`)
- **功能**: 软删除分成调整记录
- **方法**: POST
- **权限**: 管理员和运营
- **操作**: 设置 `is_active=False`
  - **说明**: 当前前端主要通过编辑页面的开关执行同等操作，此路由保留兼容性

#### 5. 恢复分成调整记录 (`/pilots/<pilot_id>/commission/<commission_id>/restore`)
- **功能**: 恢复软删除的分成调整记录
- **方法**: POST
- **权限**: 管理员和运营
- **操作**: 设置 `is_active=True`
  - **说明**: 同上，前端默认使用编辑页开关恢复记录

#### 6. 当前分成信息API (`/pilots/<pilot_id>/commission/current`)
- **功能**: 返回主播当前有效分成信息（JSON）
- **方法**: GET
- **权限**: 管理员和运营
- **返回**: 当前分成比例、生效时间、计算说明

## 前端模板设计

### 模板结构
```
templates/pilots/commission/
├── index.html          # 分成管理主页面
├── new.html            # 新增调整记录页面
└── edit.html           # 编辑调整记录页面
```

### 分成管理页面设计
- **布局**: 与主播管理保持一致的卡片式布局
- **当前分成信息**: 独立卡片显示当前分成比例和计算说明
- **调整记录列表**: 表格形式展示，按调整日降序排列
- **操作按钮**: 新增、编辑、软删除/恢复按钮
- **空状态**: 无调整记录时的友好提示

### 新增/编辑页面设计
- **表单布局**: 简洁的表单设计
- **字段验证**: 实时验证和错误提示
- **日期选择**: 使用日期选择器，限制不能选择未来日期
- **数值输入**: 调整值输入框，范围0-50

### 当前分成信息组件设计
- **显示内容**: 当前分成比例、主播收入、公司收入
- **计算说明**: 清晰的计算公式展示
- **生效时间**: 当前分成比例的生效时间范围

## 业务逻辑设计

### 分成计算逻辑

#### 获取主播当前分成比例
```python
def get_pilot_current_commission_rate(pilot_id):
    """
    获取主播当前有效的分成比例
    返回: (commission_rate, effective_date, calculation_info)
    """
    # 1. 获取当前UTC时间
    current_time = get_current_utc_time()
    
    # 2. 查询主播的所有有效调整记录，按调整日升序排列
    commissions = PilotCommission.objects(pilot_id=pilot_id, is_active=True).order_by('adjustment_date')
    
    # 3. 如果没有记录，返回默认20%
    if not commissions.count():
        return 20.0, None, "默认分成比例"
    
    # 4. 根据当前日期找到生效的分成记录
    # 从最新记录开始查找，找到调整日≤当前日期的第一条记录
    effective_commission = None
    for commission in reversed(list(commissions)):
        if commission.adjustment_date <= current_time:
            effective_commission = commission
            break
    
    # 5. 如果没有找到生效记录（所有记录都是未来日期），返回默认值
    if effective_commission is None:
        return 20.0, None, "默认分成比例"
    
    # 6. 返回生效记录的分成比例和相关信息
    return effective_commission.commission_rate, effective_commission.adjustment_date, effective_commission.remark
```

#### 分成计算服务
```python
def calculate_commission_distribution(commission_rate):
    """
    根据分成比例计算主播和公司的收入分配
    """
    # 固定参数
    BASE_RATE = 50.0  # 50%
    COMPANY_RATE = 42.0  # 42%
    
    # 主播收入 = (分成比例/50%) * 42%
    pilot_income = (commission_rate / BASE_RATE) * COMPANY_RATE
    
    # 公司收入 = 42% - 主播收入
    company_income = COMPANY_RATE - pilot_income
    
    return {
        'pilot_income': pilot_income,
        'company_income': company_income,
        'calculation_formula': f'({commission_rate}%/50%) * 42% = {pilot_income}%'
    }
```

### 数据验证逻辑

#### 调整记录验证
```python
def validate_commission_record(pilot_id, adjustment_date, commission_rate):
    """
    验证分成调整记录的有效性
    """
    # 1. 调整值范围验证（0-50）
    # 2. 调整日不能是未来日期
    # 3. 同一主播同一调整日唯一性验证
    # 4. 业务规则验证
```

#### 唯一性约束检查
```python
def check_commission_date_uniqueness(pilot_id, adjustment_date, exclude_id=None):
    """
    检查同一主播同一调整日是否已有有效记录
    """
    # 查询条件：pilot_id + adjustment_date + is_active=True
    # 排除当前编辑的记录（如果有exclude_id）
```

## 权限控制设计

### 权限矩阵

| 功能 | 管理员 | 运营 |
|------|------|------|
| 查看主播分成信息 | ✅ | ✅ |
| 查看分成调整记录 | ✅ | ✅ |
| 新增分成调整记录 | ✅ | ✅ |
| 编辑分成调整记录 | ✅ | ✅ |
| 软删除分成调整记录 | ✅ | ✅ |
| 恢复分成调整记录 | ✅ | ✅ |

### 权限检查机制
- **角色验证**: 使用 `@roles_required` 装饰器进行路由级权限控制
- **数据级权限**: 在业务逻辑中检查用户对特定主播的操作权限
- **权限一致性**: 管理员与运营权限完全一致

## 数据验证和业务规则

### 前端验证
- **实时验证**: 表单提交前的客户端验证
- **调整值范围**: 0-50的数值范围验证
- **日期验证**: 不能选择未来日期
- **唯一性检查**: 同一调整日的重复检查

### 后端验证
- **数据完整性**: 使用MongoEngine的clean()方法进行模型级验证
- **业务规则**: 调整值范围、调整日有效性、唯一性约束
- **枚举验证**: 确保状态字段值的有效性

### 业务规则验证
- **调整值规则**: 必须在0-50范围内
- **唯一性规则**: 同一主播同一调整日只能有一条有效记录
- **软删除规则**: 软删除的记录不参与分成计算
- **未来日期规则**: 支持选择未来日期，用于提前安排分成调整

## 变更记录系统

### 变更记录机制
- **自动记录**: 编辑分成调整记录时自动记录所有字段变更
- **记录内容**: 字段名、旧值、新值、操作时间、操作用户、IP地址
- **批量保存**: 一次编辑的多个字段变更批量记录
- **查询优化**: 按记录ID和时间排序的复合索引

### 变更记录查询
- **历史查询**: 按分成调整记录查询变更历史
- **用户查询**: 按操作用户查询操作记录
- **时间范围**: 支持按时间范围查询变更记录

## 日志记录

### 日志配置
- **独立日志**: 分成管理模块使用独立的日志文件
- **日志轮转**: 按自然日切分日志文件
- **日志级别**: INFO级别记录关键操作，ERROR级别记录异常

### 关键操作日志
- **创建操作**: 记录分成调整记录创建和操作用户
- **更新操作**: 记录分成调整记录更新和操作用户
- **软删除操作**: 记录分成调整记录软删除和操作用户
- **错误记录**: 记录操作失败和错误信息
- **权限检查**: 记录权限验证失败的情况

## 性能优化

### 数据库查询优化
- **索引策略**: 为常用查询字段创建合适的索引
- **查询优化**: 避免N+1查询问题
- **缓存策略**: 对主播当前分成比例进行缓存
- **分页支持**: 为大量调整记录提供分页查询

### 前端优化
- **异步加载**: 当前分成信息使用AJAX异步加载
- **表单优化**: 前端实时验证减少服务器请求
- **响应式设计**: 确保在移动设备上的良好体验
- **资源优化**: 合理使用CSS和JavaScript资源

## 安全考虑

### 数据安全
- **输入验证**: 严格验证所有用户输入数据
- **权限控制**: 确保用户只能访问有权限的数据
- **变更审计**: 完整记录所有数据变更操作
- **SQL注入防护**: 使用ORM防止注入攻击

### 业务安全
- **业务规则**: 严格执行业务规则验证
- **数据完整性**: 确保关联数据的一致性
- **错误处理**: 优雅处理各种异常情况
- **敏感信息**: 合理处理分成信息的显示和存储

## 扩展性设计

### 接口预留
- **内部API**: 为系统内部模块提供分成数据接口
- **数据格式**: 支持JSON格式的数据交换
- **权限继承**: API接口继承现有的权限控制机制

## 集成设计

### 与主播管理模块的集成
- **入口集成**: 在主播详情页面添加分成管理入口
- **数据关联**: 通过pilot_id关联主播和分成调整记录
- **权限继承**: 继承主播管理模块的权限控制
- **UI一致性**: 保持与主播管理模块的UI风格一致

### 与其他模块的集成
- **财务模块**: 为财务模块提供分成计算接口
- **报表模块**: 为报表模块提供分成历史数据
- **用户模块**: 继承用户模块的权限和日志系统

## 测试策略

### 单元测试
- **模型测试**: 测试分成调整记录模型的创建、验证、保存
- **业务规则**: 测试各种业务规则验证
- **计算逻辑**: 测试分成计算逻辑的正确性
- **变更记录**: 测试变更记录的正确性

### 集成测试
- **路由测试**: 测试各个路由的访问权限和功能
- **权限测试**: 测试不同角色的权限控制
- **表单测试**: 测试表单提交和数据验证
- **API测试**: 测试当前分成信息API的功能

## 部署和配置

### 环境变量
- **可选配置**: 分成相关参数可通过环境变量配置
- **默认值**: 提供合理的默认配置值
- **向后兼容**: 不破坏现有配置结构

### 数据库初始化
- **索引创建**: 应用启动时自动创建必要的数据库索引
- **错误处理**: 索引创建失败时的错误处理和日志记录
- **性能优化**: 为常用查询创建复合索引

## 总结

本技术设计文档详细规划了主播分成管理功能的实现方案

该设计遵循项目现有的技术架构和代码风格，确保与现有系统的良好集成，同时为主播分成管理功能提供了完整、安全、可扩展的实现方案。
