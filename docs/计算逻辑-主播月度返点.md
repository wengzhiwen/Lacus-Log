# 主播月度返点计算逻辑

## 概述

主播月度返点是基于主播的月度表现给予的额外奖励，根据有效开播天数、总播时长和总流水三个维度进行阶梯式计算。返点功能主要应用于快速月报和主播业绩页面。

## 返点阶梯设置

```python
REBATE_STAGES = [
    {
        'stage': 1,
        'min_days': 12,          # 最少开播天数
        'min_hours': 42,          # 最少播时(小时)
        'min_revenue': 1000,      # 最少流水(元)
        'rate': 0.05              # 返点比例5%
    },
    {
        'stage': 2,
        'min_days': 18,
        'min_hours': 100,
        'min_revenue': 5000,
        'rate': 0.07              # 7%
    },
    {
        'stage': 3,
        'min_days': 18,
        'min_hours': 100,
        'min_revenue': 10000,
        'rate': 0.11              # 11%
    },
    {
        'stage': 4,
        'min_days': 22,
        'min_hours': 130,
        'min_revenue': 30000,
        'rate': 0.14              # 14%
    },
    {
        'stage': 5,
        'min_days': 22,
        'min_hours': 130,
        'min_revenue': 80000,
        'rate': 0.18              # 18%
    }
]
```

## 计算规则

### 有效开播天数计算

- **有效天定义**：单日播时 ≥ 1小时 的天数
- **统计范围**：按自然月统计（1日至月末最后一日）
- **特殊处理**：如果查询当前月，只计算到昨天的数据

### 核心计算逻辑

```python
def _evaluate_rebate(valid_days: int, total_duration: float, total_revenue: Decimal) -> Tuple[float, Decimal]:
    """根据返点阶梯计算返点比例与金额"""
    qualified = [
        stage for stage in REBATE_STAGES
        if (valid_days >= stage['min_days'] and
            total_duration >= stage['min_hours'] and
            total_revenue >= stage['min_revenue'])
    ]

    if not qualified:
        return 0.0, Decimal('0')

    best_stage = max(qualified, key=lambda item: item['stage'])
    rate = float(best_stage['rate'])
    rebate_amount = total_revenue * Decimal(str(rate))

    return rate, rebate_amount
```

### 数据统计流程

1. **获取开播记录**：查询指定月份的所有开播记录
2. **计算有效天数**：统计播时≥1小时的天数
3. **累计总指标**：
   - 总播时长：所有记录的播时总和
   - 总流水：所有记录的流水总和
4. **阶梯匹配**：按照阶梯条件匹配最高适用级别
5. **计算返点**：总流水 × 返点比例

## 应用场景

### 1. 快速月报

在快速月报中，返点作为月度利润的重要组成部分：

```python
# 计算逻辑
total_company_share_sum += commission_amounts['company_amount']
total_rebate_sum += rebate_amount

# 返点分配到每日
_distribute_rebate_to_daily_totals(daily_totals, pilot_daily_revenue, rebate_amount, month_end_date)

# 毛利计算
operating_profit = total_company_share_sum + total_rebate_sum - total_base_salary_sum
```

### 2. 主播业绩页面

主播业绩页面显示主播的返点资格和金额：

```python
def calculate_pilot_rebate(pilot: Pilot, report_date: datetime) -> Dict[str, Any]:
    """计算主播月度返点信息"""
    # 返回包含返点比例和金额的字典
    return {
        'rebate_rate': rate,
        'rebate_amount': rebate_amount
    }
```

## 返点分配机制

### 每日分配逻辑

为了在月度报表中按日显示累计趋势，返点金额会按流水比例分配到每日：

```python
def _distribute_rebate_to_daily_totals(daily_totals, revenue_by_day, rebate_amount, fallback_day):
    if rebate_amount <= 0:
        return

    total_revenue = sum(revenue_by_day.values())
    if total_revenue > 0:
        # 按流水比例分配
        for day, day_revenue in revenue_by_day.items():
            if day_revenue <= 0:
                continue
            share = (day_revenue / total_revenue) * rebate_amount
            if share <= 0:
                continue
            daily_totals[day]['rebate'] += share
    else:
        # 无流水时分配到最后一天
        daily_totals[fallback_day]['rebate'] += rebate_amount
```

## 特殊处理

### 当前月计算

对于当前月份（未结束的月份）：
- 只计算到昨天为止的数据
- 避免包含当天的不完整数据
- 确保计算的准确性

### 空数据处理

- 无开播记录时返回0
- 无有效天数时返回0
- 无流水时返点金额为0

## 注意事项

1. **计算范围**：严格按自然月计算，不是按自定义时间段
2. **有效天数**：只有播时≥1小时才计入有效天数
3. **阶梯规则**：必须同时满足天数、播时、流水三个条件
4. **返点金额**：基于总流水计算，不是基于毛利
5. **数据一致性**：确保与其他月度统计的计算逻辑一致

## 相关文件

- `utils/new_report_fast_calculations.py` - 快速月报中的返点计算
- `utils/new_report_calculations.py` - 传统月报中的返点计算
- `utils/pilot_performance.py` - 主播业绩页面的返点计算

## 更新记录

- 2025-10-28: 文档创建，基于当前返点计算逻辑整理