{% extends 'base.html' %}
{% block title %}é‚®ä»¶æŠ¥å‘Š - Lacus-Log{% endblock %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">ğŸ“§ é‚®ä»¶æŠ¥å‘Š</h1>
  <div class="text-muted">ä»¥ä¸‹æŠ¥è¡¨ä¸ºå¼‚æ­¥è§¦å‘å‹ï¼Œç‚¹å‡»æŒ‰é’®åå°†å¼€å§‹è®¡ç®—å¹¶å°è¯•å‘é€é‚®ä»¶ï¼Œé¡µé¢ä¸ä¼šç­‰å¾…è®¡ç®—å®Œæˆã€‚</div>
  <input type="hidden" id="csrfToken" value="{{ csrf_token() }}">
  <div id="result" class="text-muted" style="margin-top:8px;"></div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="card-title">æœªå¼€æ’­æé†’ï¼ˆè¿‘48å°æ—¶ï¼‰</h2>
    <div class="card-icon">â°</div>
  </div>
  <div class="card-body">
    <button id="btnUnstarted" class="btn btn-primary" style="width:100%" type="button" aria-label="è§¦å‘æœªå¼€æ’­æé†’æŠ¥è¡¨">å¼€å§‹å‘é€</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('btnUnstarted');
  const result = document.getElementById('result');
  const csrf = document.getElementById('csrfToken')?.value || '';

  async function postUnstarted() {
    result.textContent = 'æŠ¥è¡¨å·²å¼€å§‹è¿ç®—...';
    try {
      const resp = await fetch("{{ url_for('report_mail.trigger_unstarted_report') }}", {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json',
          'X-CSRFToken': csrf
        },
        credentials: 'same-origin'
      });
      const data = await resp.json();
      if (resp.ok) {
        if (data.sent) {
          result.textContent = `å·²è§¦å‘å‘é€ï¼Œå…± ${data.count} æ¡ã€‚`;
        } else {
          result.textContent = `æ— å¯å‘é€å†…å®¹ï¼ˆæˆ–æœªé…ç½®æ”¶ä»¶äººï¼‰ã€‚`;
        }
      } else {
        result.textContent = `è§¦å‘å¤±è´¥ï¼š${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`;
      }
    } catch (e) {
      result.textContent = 'ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚';
    }
  }

  if (btn) {
    btn.addEventListener('click', postUnstarted);
  }
});
</script>
{% endblock %}


